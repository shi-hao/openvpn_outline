cscope 15 $HOME/myproject/openvpn_outline/5-source/openvpn-release-2.4/src/openvpn -q 0000008846 0001755944
	@argv.c

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

32 #–ià
defšed
(
_MSC_VER
)

33 
	~"cÚfig-msvc.h
"

36 
	~"sysh—d.h
"

38 
	~"¬gv.h
"

39 
	~"š‹g”.h
"

40 
	~"İtiÚs.h
"

43 
	$¬gv_š™
(
¬gv
 *
a
)

45 
a
->
ÿ·c™y
 = 0;

46 
a
->
¬gc
 = 0;

47 
a
->
¬gv
 = 
NULL
;

48 
	}
}

50 
¬gv


51 
	$¬gv_Ãw
()

53 
¬gv
 
»t
;

54 
	`¬gv_š™
(&
»t
);

55  
»t
;

56 
	}
}

59 
	$¬gv_»£t
(
¬gv
 *
a
)

61 
size_t
 
i
;

62 
i
 = 0; i < 
a
->
¬gc
; ++i)

64 
	`ä“
(
a
->
¬gv
[
i
]);

66 
	`ä“
(
a
->
¬gv
);

67 
	`¬gv_š™
(
a
);

68 
	}
}

71 
	$¬gv_ex‹nd
(
¬gv
 *
a
, cÚ¡ 
size_t
 
Ãwÿp
)

73 ià(
Ãwÿp
 > 
a
->
ÿ·c™y
)

75 **
Ãw¬gv
;

76 
size_t
 
i
;

77 
	`ALLOC_ARRAY_CLEAR
(
Ãw¬gv
, *, 
Ãwÿp
);

78 
i
 = 0; i < 
a
->
¬gc
; ++i)

80 
Ãw¬gv
[
i
] = 
a
->
¬gv
[i];

82 
	`ä“
(
a
->
¬gv
);

83 
a
->
¬gv
 = 
Ãw¬gv
;

84 
a
->
ÿ·c™y
 = 
Ãwÿp
;

86 
	}
}

89 
	$¬gv_grow
(
¬gv
 *
a
, cÚ¡ 
size_t
 
add
)

91 cÚ¡ 
size_t
 
Ãw¬gc
 = 
a
->
¬gc
 + 
add
 + 1;

92 
	`ASSERT
(
Ãw¬gc
 > 
a
->
¬gc
);

93 
	`¬gv_ex‹nd
(
a
, 
	`adju¡_pow”_of_2
(
Ãw¬gc
));

94 
	}
}

97 
	$¬gv_­³nd
(
¬gv
 *
a
, *
¡r
)

99 
	`¬gv_grow
(
a
, 1);

100 
a
->
¬gv
[a->
¬gc
++] = 
¡r
;

101 
	}
}

103 
¬gv


104 
	$¬gv_şÚe
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
size_t
 
h—droom
)

106 
¬gv
 
r
;

107 
size_t
 
i
;

109 
	`¬gv_š™
(&
r
);

110 
i
 = 0; i < 
h—droom
; ++i)

112 
	`¬gv_­³nd
(&
r
, 
NULL
);

114 ià(
a
)

116 
i
 = 0; i < 
a
->
¬gc
; ++i)

118 
	`¬gv_­³nd
(&
r
, 
	`¡ršg_®loc
(
a
->
¬gv
[
i
], 
NULL
));

121  
r
;

122 
	}
}

124 
¬gv


125 
	$¬gv_š£¹_h—d
(cÚ¡ 
¬gv
 *
a
, cÚ¡ *
h—d
)

127 
¬gv
 
r
;

128 
r
 = 
	`¬gv_şÚe
(
a
, 1);

129 
r
.
¬gv
[0] = 
	`¡ršg_®loc
(
h—d
, 
NULL
);

130  
r
;

131 
	}
}

134 
	$¬gv_‹rm
(cÚ¡ **
f
)

136 cÚ¡ *
p
 = *
f
;

137 cÚ¡ *
‹rm
 = 
NULL
;

138 
size_t
 
‹rmËn
 = 0;

140 ià(*
p
 == '\0')

142  
NULL
;

145 
Œue
)

147 cÚ¡ 
c
 = *
p
;

148 ià(
c
 == '\0')

152 ià(
‹rm
)

154 ià(!
	`is¥aû
(
c
))

156 ++
‹rmËn
;

165 ià(!
	`is¥aû
(
c
))

167 
‹rm
 = 
p
;

168 
‹rmËn
 = 1;

171 ++
p
;

173 *
f
 = 
p
;

175 ià(
‹rm
)

177 *
»t
;

178 
	`ASSERT
(
‹rmËn
 > 0);

179 
»t
 = 
	`m®loc
(
‹rmËn
 + 1);

180 
	`check_m®loc_»tuº
(
»t
);

181 
	`memıy
(
»t
, 
‹rm
, 
‹rmËn
);

182 
»t
[
‹rmËn
] = '\0';

183  
»t
;

187  
NULL
;

189 
	}
}

192 
	$¬gv_¡r
(cÚ¡ 
¬gv
 *
a
, 
gc_¬’a
 *
gc
, cÚ¡ 
æags
)

194 ià(
a
->
¬gv
)

196  
	`´št_¬gv
((cÚ¡ **)
a
->
¬gv
, 
gc
, 
æags
);

202 
	}
}

205 
	$¬gv_msg
(cÚ¡ 
msgËv
, cÚ¡ 
¬gv
 *
a
)

207 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

208 
	`msg
(
msgËv
, "%s", 
	`¬gv_¡r
(
a
, &
gc
, 0));

209 
	`gc_ä“
(&
gc
);

210 
	}
}

213 
	$¬gv_msg_´efix
(cÚ¡ 
msgËv
, cÚ¡ 
¬gv
 *
a
, cÚ¡ *
´efix
)

215 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

216 
	`msg
(
msgËv
, "%s: %s", 
´efix
, 
	`¬gv_¡r
(
a
, &
gc
, 0));

217 
	`gc_ä“
(&
gc
);

218 
	}
}

221 
	$¬gv_´štf_¬gli¡
(
¬gv
 *
a
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬gli¡
)

223 *
‹rm
;

224 cÚ¡ *
f
 = 
fÜm©
;

226 
	`¬gv_ex‹nd
(
a
, 1);

228 (
‹rm
 = 
	`¬gv_‹rm
(&
f
)è!ğ
NULL
)

230 ià(
‹rm
[0] == '%')

232 ià(!
	`¡rcmp
(
‹rm
, "%s"))

234 *
s
 = 
	`va_¬g
(
¬gli¡
, *);

235 ià(!
s
)

237 
s
 = "";

239 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
s
, 
NULL
));

241 ià(!
	`¡rcmp
(
‹rm
, "%d"))

243 
num¡r
[64];

244 
	`İ’v²_¢´štf
(
num¡r
, Òum¡r), "%d", 
	`va_¬g
(
¬gli¡
, ));

245 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
num¡r
, 
NULL
));

247 ià(!
	`¡rcmp
(
‹rm
, "%u"))

249 
num¡r
[64];

250 
	`İ’v²_¢´štf
(
num¡r
, Òum¡r), "%u", 
	`va_¬g
(
¬gli¡
, ));

251 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
num¡r
, 
NULL
));

253 ià(!
	`¡rcmp
(
‹rm
, "%lu"))

255 
num¡r
[64];

256 
	`İ’v²_¢´štf
(
num¡r
, (numstr), "%lu",

257 
	`va_¬g
(
¬gli¡
, ));

258 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
num¡r
, 
NULL
));

260 ià(!
	`¡rcmp
(
‹rm
, "%s/%d"))

262 
num¡r
[64];

263 *
s
 = 
	`va_¬g
(
¬gli¡
, *);

265 ià(!
s
)

267 
s
 = "";

270 
	`İ’v²_¢´štf
(
num¡r
, Òum¡r), "%d", 
	`va_¬g
(
¬gli¡
, ));

273 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
(
s
è+ sŒËn(
num¡r
) + 2;

274 *
combšed
 = (*è
	`m®loc
(
Ën
);

275 
	`check_m®loc_»tuº
(
combšed
);

277 
	`¡rıy
(
combšed
, 
s
);

278 
	`¡rÿt
(
combšed
, "/");

279 
	`¡rÿt
(
combšed
, 
num¡r
);

280 
	`¬gv_­³nd
(
a
, 
combšed
);

283 ià(!
	`¡rcmp
(
‹rm
, "%s%sc"))

285 *
s1
 = 
	`va_¬g
(
¬gli¡
, *);

286 *
s2
 = 
	`va_¬g
(
¬gli¡
, *);

287 *
combšed
;

289 ià(!
s1
)

291 
s1
 = "";

293 ià(!
s2
)

295 
s2
 = "";

297 
combšed
 = (*è
	`m®loc
(
	`¡¾’
(
s1
è+ sŒËn(
s2
) + 1);

298 
	`check_m®loc_»tuº
(
combšed
);

299 
	`¡rıy
(
combšed
, 
s1
);

300 
	`¡rÿt
(
combšed
, 
s2
);

301 
	`¬gv_­³nd
(
a
, 
combšed
);

305 
	`ASSERT
(0);

307 
	`ä“
(
‹rm
);

311 
	`¬gv_­³nd
(
a
, 
‹rm
);

314 
	}
}

317 
	$¬gv_´štf
(
¬gv
 *
a
, cÚ¡ *
fÜm©
, ...)

319 
va_li¡
 
¬gli¡
;

320 
	`¬gv_»£t
(
a
);

321 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

322 
	`¬gv_´štf_¬gli¡
(
a
, 
fÜm©
, 
¬gli¡
);

323 
	`va_’d
(
¬gli¡
);

324 
	}
}

327 
	$¬gv_´štf_ÿt
(
¬gv
 *
a
, cÚ¡ *
fÜm©
, ...)

329 
va_li¡
 
¬gli¡
;

330 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

331 
	`¬gv_´štf_¬gli¡
(
a
, 
fÜm©
, 
¬gli¡
);

332 
	`va_’d
(
¬gli¡
);

333 
	}
}

336 
	$¬gv_·r£_cmd
(
¬gv
 *
a
, cÚ¡ *
s
)

338 
Å¬ms
;

339 *
·rms
[
MAX_PARMS
 + 1];

340 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

342 
	`¬gv_»£t
(
a
);

343 
	`¬gv_ex‹nd
(
a
, 1);

345 
Å¬ms
 = 
	`·r£_lše
(
s
, 
·rms
, 
MAX_PARMS
, "SCRIPT-ARGV", 0, 
D_ARGV_PARSE_CMD
, &
gc
);

346 ià(
Å¬ms
)

348 
i
;

349 
i
 = 0; i < 
Å¬ms
; ++i)

351 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
·rms
[
i
], 
NULL
));

356 
	`¬gv_­³nd
(
a
, 
	`¡ršg_®loc
(
s
, 
NULL
));

359 
	`gc_ä“
(&
gc
);

360 
	}
}

	@argv.h

30 #iâdeà
ARGV_H


31 
	#ARGV_H


	)

33 
	~"bufãr.h
"

35 
	s¬gv
 {

36 
size_t
 
	mÿ·c™y
;

37 
size_t
 
	m¬gc
;

38 **
	m¬gv
;

41 
¬gv
 
¬gv_Ãw
();

43 
¬gv_»£t
(
¬gv
 *
a
);

45 cÚ¡ *
¬gv_¡r
(cÚ¡ 
¬gv
 *
a
, 
gc_¬’a
 *
gc
, cÚ¡ 
æags
);

47 
¬gv
 
¬gv_š£¹_h—d
(cÚ¡ ¬gv *
a
, cÚ¡ *
h—d
);

49 
¬gv_msg
(cÚ¡ 
msgËv
, cÚ¡ 
¬gv
 *
a
);

51 
¬gv_msg_´efix
(cÚ¡ 
msgËv
, cÚ¡ 
¬gv
 *
a
, cÚ¡ *
´efix
);

53 
¬gv_·r£_cmd
(
¬gv
 *
a
, cÚ¡ *
s
);

55 
	$¬gv_´štf
(
¬gv
 *
a
, cÚ¡ *
fÜm©
, ...)

56 #ifdeà
__GNUC__


57 #ià
__USE_MINGW_ANSI_STDIO


58 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 2, 3)))

60 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 2, 3)))

65 
	$¬gv_´štf_ÿt
(
¬gv
 *
a
, cÚ¡ *
fÜm©
, ...)

66 #ifdeà
__GNUC__


67 #ià
__USE_MINGW_ANSI_STDIO


68 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 2, 3)))

70 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 2, 3)))

	@base64.c

34 #ifdeà
HAVE_CONFIG_H


35 
	~"cÚfig.h
"

36 #–ià
defšed
(
_MSC_VER
)

37 
	~"cÚfig-msvc.h
"

40 
	~"sysh—d.h
"

42 
	~"ba£64.h
"

44 
	~"memdbg.h
"

46 
	gba£64_ch¬s
[] =

54 
	$İ’v²_ba£64_’code
(cÚ¡ *
d©a
, 
size
, **
¡r
)

56 *
s
, *
p
;

57 
i
;

58 
c
;

59 cÚ¡ *
q
;

61 ià(
size
 < 0)

65 
p
 = 
s
 = (*è
	`m®loc
(
size
 * 4 / 3 + 4);

66 ià(
p
 =ğ
NULL
)

70 
q
 = (cÚ¡ *è
d©a
;

71 
i
 = 0;

72 
i
 = 0; i < 
size
; )

74 
c
 = 
q
[
i
++];

75 
c
 *= 256;

76 ià(
i
 < 
size
)

78 
c
 +ğ
q
[
i
];

80 
i
++;

81 
c
 *= 256;

82 ià(
i
 < 
size
)

84 
c
 +ğ
q
[
i
];

86 
i
++;

87 
p
[0] = 
ba£64_ch¬s
[(
c
 & 0x00fc0000) >> 18];

88 
p
[1] = 
ba£64_ch¬s
[(
c
 & 0x0003f000) >> 12];

89 
p
[2] = 
ba£64_ch¬s
[(
c
 & 0x00000fc0) >> 6];

90 
p
[3] = 
ba£64_ch¬s
[(
c
 & 0x0000003f) >> 0];

91 ià(
i
 > 
size
)

93 
p
[3] = '=';

95 ià(
i
 > 
size
 + 1)

97 
p
[2] = '=';

99 
p
 += 4;

101 *
p
 = 0;

102 *
¡r
 = 
s
;

103  
	`¡¾’
(
s
);

104 
	}
}

107 
	$pos
(
c
)

109 *
p
;

110 
p
 = 
ba£64_ch¬s
; *p;…++)

112 ià(*
p
 =ğ
c
)

114  
p
 - 
ba£64_ch¬s
;

118 
	}
}

120 
	#DECODE_ERROR
 0xffffffff

	)

123 
	$tok’_decode
(cÚ¡ *
tok’
)

125 
i
;

126 
v®
 = 0;

127 
m¬k”
 = 0;

128 ià(!
tok’
[0] || !token[1] || !token[2] || !token[3])

130  
DECODE_ERROR
;

132 
i
 = 0; i < 4; i++)

134 
v®
 *= 64;

135 ià(
tok’
[
i
] == '=')

137 
m¬k”
++;

139 ià(
m¬k”
 > 0)

141  
DECODE_ERROR
;

145 
v®
 +ğ
	`pos
(
tok’
[
i
]);

148 ià(
m¬k”
 > 2)

150  
DECODE_ERROR
;

152  (
m¬k”
 << 24è| 
v®
;

153 
	}
}

160 
	$İ’v²_ba£64_decode
(cÚ¡ *
¡r
, *
d©a
, 
size
)

162 cÚ¡ *
p
;

163 *
q
;

164 *
e
 = 
NULL
;

166 
q
 = 
d©a
;

167 ià(
size
 >= 0)

169 
e
 = 
q
 + 
size
;

171 
p
 = 
¡r
; *°&& (*°=ğ'=' || 
	`¡rchr
(
ba£64_ch¬s
, *p));… += 4)

173 
v®
 = 
	`tok’_decode
(
p
);

174 
m¬k”
 = (
v®
 >> 24) & 0xff;

175 ià(
v®
 =ğ
DECODE_ERROR
)

179 ià(
e
 && 
q
 >=ƒ)

183 *
q
++ = (
v®
 >> 16) & 0xff;

184 ià(
m¬k”
 < 2)

186 ià(
e
 && 
q
 >=ƒ)

190 *
q
++ = (
v®
 >> 8) & 0xff;

192 ià(
m¬k”
 < 1)

194 ià(
e
 && 
q
 >=ƒ)

198 *
q
++ = 
v®
 & 0xff;

201  
q
 - (*è
d©a
;

202 
	}
}

	@base64.h

34 #iâdeà
_BASE64_H_


35 
	#_BASE64_H_


	)

37 
İ’v²_ba£64_’code
(cÚ¡ *
d©a
, 
size
, **
¡r
);

39 
İ’v²_ba£64_decode
(cÚ¡ *
¡r
, *
d©a
, 
size
);

	@basic.h

24 #iâdeà
BASIC_H


25 
	#BASIC_H


	)

27 
	#BOOL_CAST
(
x
è((xè? (
Œue
è: (
çl£
))

	)

30 
	#SIZE
(
x
è((x)/(x[0]))

	)

33 
	#CLEAR
(
x
è
	`mem£t
(&(x), 0, (x))

	)

35 
	#IPV4_NETMASK_HOST
 0xffffffffU

	)

	@block_dns.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~"cÚfig.h
"

28 #–ià
defšed
(
_MSC_VER
)

29 
	~"cÚfig-msvc.h
"

31 #ifdeà
HAVE_CONFIG_VERSION_H


32 
	~"cÚfig-v”siÚ.h
"

35 
	~"sysh—d.h
"

37 #ifdeà
_WIN32


39 
	~<fwpmu.h
>

40 
	~<š™guid.h
>

41 
	~<fwpmty³s.h
>

42 
	~<wšsock2.h
>

43 
	~<ws2def.h
>

44 
	~<hÍ­i.h
>

45 
	~"block_dns.h
"

51 #iâdeà
FWPM_SESSION_FLAG_DYNAMIC


52 
	#FWPM_SESSION_FLAG_DYNAMIC
 0x00000001

	)

56 
DEFINE_GUID
(

57 
FWPM_LAYER_ALE_AUTH_CONNECT_V4
,

65 
DEFINE_GUID
(

66 
FWPM_LAYER_ALE_AUTH_CONNECT_V6
,

74 
DEFINE_GUID
(

75 
FWPM_CONDITION_ALE_APP_ID
,

83 
DEFINE_GUID
(

84 
FWPM_CONDITION_IP_REMOTE_PORT
,

92 
DEFINE_GUID
(

93 
FWPM_CONDITION_IP_LOCAL_INTERFACE
,

102 
DEFINE_GUID
(

103 
OPENVPN_BLOCK_OUTSIDE_DNS_SUBLAYER
,

110 
WCHAR
 *
	gFIREWALL_NAME
 = 
L
"OpenVPN";

112 
VOID
 
NETIOAPI_API_


113 
In™ŸlizeIpIÁ”çûEÁry
(
PMIB_IPINTERFACE_ROW
 
Row
);

118 
šlše
 

119 
	$deçuÉ_msg_hªdËr
(
DWORD
 
”r
, cÚ¡ *
msg
)

122 
	}
}

124 
	#CHECK_ERROR
(
”r
, 
msg
) \

125 ià(
”r
è{ 
	`msg_hªdËr
Ó¼, 
msg
); 
out
; }

	)

130 
DWORD


131 
	$add_subÏy”
(
GUID
 
uuid
)

133 
FWPM_SESSION0
 
£ssiÚ
;

134 
HANDLE
 
’gše
 = 
NULL
;

135 
DWORD
 
”r
 = 0;

136 
FWPM_SUBLAYER0
 
subÏy”
;

138 
	`mem£t
(&
£ssiÚ
, 0, (session));

139 
	`mem£t
(&
subÏy”
, 0, (sublayer));

141 
”r
 = 
	`FwpmEngšeO³n0
(
NULL
, 
RPC_C_AUTHN_WINNT
, NULL, &
£ssiÚ
, &
’gše
);

142 ià(
”r
 !ğ
ERROR_SUCCESS
)

144 
out
;

147 
subÏy”
.
subLay”Key
 = 
uuid
;

148 
subÏy”
.
di¥ÏyD©a
.
Çme
 = 
FIREWALL_NAME
;

149 
subÏy”
.
di¥ÏyD©a
.
desütiÚ
 = 
FIREWALL_NAME
;

150 
subÏy”
.
æags
 = 0;

151 
subÏy”
.
weight
 = 0x100;

154 
”r
 = 
	`FwpmSubLay”Add0
(
’gše
, &
subÏy”
, 
NULL
);

156 
out
:

157 ià(
’gše
)

159 
	`FwpmEngšeClo£0
(
’gše
);

161  
”r
;

162 
	}
}

181 
DWORD


182 
	$add_block_dns_f‹rs
(
HANDLE
 *
’gše_hªdË
,

183 
šdex
,

184 cÚ¡ 
WCHAR
 *
exe_·th
,

185 
block_dns_msg_hªdËr_t
 
msg_hªdËr


188 
FWPM_SESSION0
 
£ssiÚ
 = {0};

189 
FWPM_SUBLAYER0
 *
subÏy”_±r
 = 
NULL
;

190 
NET_LUID
 
¶uid
;

191 
UINT64
 
f‹rid
;

192 
FWP_BYTE_BLOB
 *
İ’v²blob
 = 
NULL
;

193 
FWPM_FILTER0
 
F‹r
 = {0};

194 
FWPM_FILTER_CONDITION0
 
CÚd™iÚ
[2] = {0};

195 
DWORD
 
”r
 = 0;

197 ià(!
msg_hªdËr
)

199 
msg_hªdËr
 = 
deçuÉ_msg_hªdËr
;

203 
£ssiÚ
.
æags
 = 
FWPM_SESSION_FLAG_DYNAMIC
;

205 *
’gše_hªdË
 = 
NULL
;

207 
”r
 = 
	`FwpmEngšeO³n0
(
NULL
, 
RPC_C_AUTHN_WINNT
, NULL, &
£ssiÚ
, 
’gše_hªdË
);

208 
	`CHECK_ERROR
(
”r
, "FwpEngineOpen: open fwp session failed");

209 
	`msg_hªdËr
(0, "Block_DNS: WFPƒngine opened");

212 ià(
	`FwpmSubLay”G‘ByKey0
(*
’gše_hªdË
, &
OPENVPN_BLOCK_OUTSIDE_DNS_SUBLAYER
, &
subÏy”_±r
)

213 =ğ
ERROR_SUCCESS
)

215 
	`msg_hªdËr
(0, "Block_DNS: Usingƒxisting sublayer");

216 
	`FwpmF»eMemÜy0
((**)&
subÏy”_±r
);

221 
”r
 = 
	`add_subÏy”
(
OPENVPN_BLOCK_OUTSIDE_DNS_SUBLAYER
);

223 ià(
”r
 =ğ
FWP_E_ALREADY_EXISTS
 ||ƒ¼ =ğ
ERROR_SUCCESS
)

225 
	`msg_hªdËr
(0, "Block_DNS: Added‡…ersistent sublayer with…re-defined UUID");

229 
	`CHECK_ERROR
(
”r
, "add_sublayer: failedo‡dd…ersistent sublayer");

233 
”r
 = 
	`CÚv”tIÁ”çûIndexToLuid
(
šdex
, &
¶uid
);

234 
	`CHECK_ERROR
(
”r
, "Convert interface indexo†uid failed");

236 
”r
 = 
	`FwpmG‘AµIdFromFeName0
(
exe_·th
, &
İ’v²blob
);

237 
	`CHECK_ERROR
(
”r
, "Get byte blob for openvpnƒxecutable‚ame failed");

240 
F‹r
.
subLay”Key
 = 
OPENVPN_BLOCK_OUTSIDE_DNS_SUBLAYER
;

241 
F‹r
.
di¥ÏyD©a
.
Çme
 = 
FIREWALL_NAME
;

242 
F‹r
.
weight
.
ty³
 = 
FWP_UINT8
;

243 
F‹r
.
weight
.
ušt8
 = 0xF;

244 
F‹r
.
f‹rCÚd™iÚ
 = 
CÚd™iÚ
;

245 
F‹r
.
numF‹rCÚd™iÚs
 = 2;

248 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V4
;

249 
F‹r
.
aùiÚ
.
ty³
 = 
FWP_ACTION_PERMIT
;

251 
CÚd™iÚ
[0].
f›ldKey
 = 
FWPM_CONDITION_IP_REMOTE_PORT
;

252 
CÚd™iÚ
[0].
m©chTy³
 = 
FWP_MATCH_EQUAL
;

253 
CÚd™iÚ
[0].
cÚd™iÚV®ue
.
ty³
 = 
FWP_UINT16
;

254 
CÚd™iÚ
[0].
cÚd™iÚV®ue
.
ušt16
 = 53;

256 
CÚd™iÚ
[1].
f›ldKey
 = 
FWPM_CONDITION_ALE_APP_ID
;

257 
CÚd™iÚ
[1].
m©chTy³
 = 
FWP_MATCH_EQUAL
;

258 
CÚd™iÚ
[1].
cÚd™iÚV®ue
.
ty³
 = 
FWP_BYTE_BLOB_TYPE
;

259 
CÚd™iÚ
[1].
cÚd™iÚV®ue
.
by‹Blob
 = 
İ’v²blob
;

261 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

262 
	`CHECK_ERROR
(
”r
, "Add filtero…ermit IPv4…ort 53raffic from OpenVPN failed");

265 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V6
;

267 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

268 
	`CHECK_ERROR
(
”r
, "Add filtero…ermit IPv6…ort 53raffic from OpenVPN failed");

270 
	`msg_hªdËr
(0, "Block_DNS: Added…ermit filters forƒxe_path");

273 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V4
;

274 
F‹r
.
aùiÚ
.
ty³
 = 
FWP_ACTION_BLOCK
;

275 
F‹r
.
weight
.
ty³
 = 
FWP_EMPTY
;

276 
F‹r
.
numF‹rCÚd™iÚs
 = 1;

278 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

279 
	`CHECK_ERROR
(
”r
, "Add filtero block IPv4 DNSraffic failed");

282 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V6
;

284 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

285 
	`CHECK_ERROR
(
”r
, "Add filtero block IPv6 DNSraffic failed");

287 
	`msg_hªdËr
(0, "Block_DNS: Added block filters for‡ll interfaces");

293 
F‹r
.
weight
.
ty³
 = 
FWP_UINT8
;

294 
F‹r
.
weight
.
ušt8
 = 0xE;

295 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V4
;

296 
F‹r
.
aùiÚ
.
ty³
 = 
FWP_ACTION_PERMIT
;

297 
F‹r
.
numF‹rCÚd™iÚs
 = 2;

299 
CÚd™iÚ
[1].
f›ldKey
 = 
FWPM_CONDITION_IP_LOCAL_INTERFACE
;

300 
CÚd™iÚ
[1].
m©chTy³
 = 
FWP_MATCH_EQUAL
;

301 
CÚd™iÚ
[1].
cÚd™iÚV®ue
.
ty³
 = 
FWP_UINT64
;

302 
CÚd™iÚ
[1].
cÚd™iÚV®ue
.
ušt64
 = &
¶uid
.
V®ue
;

304 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

305 
	`CHECK_ERROR
(
”r
, "Add filtero…ermit IPv4 DNSraffichrough TAP failed");

309 
F‹r
.
Ïy”Key
 = 
FWPM_LAYER_ALE_AUTH_CONNECT_V6
;

311 
”r
 = 
	`FwpmF‹rAdd0
(*
’gše_hªdË
, &
F‹r
, 
NULL
, &
f‹rid
);

312 
	`CHECK_ERROR
(
”r
, "Add filtero…ermit IPv6 DNSraffichrough TAP failed");

314 
	`msg_hªdËr
(0, "Block_DNS: Added…ermit filters for TAP interface");

316 
out
:

318 ià(
İ’v²blob
)

320 
	`FwpmF»eMemÜy0
((**)&
İ’v²blob
);

323 ià(
”r
 && *
’gše_hªdË
)

325 
	`FwpmEngšeClo£0
(*
’gše_hªdË
);

326 *
’gše_hªdË
 = 
NULL
;

329  
”r
;

330 
	}
}

332 
DWORD


333 
	$d–‘e_block_dns_f‹rs
(
HANDLE
 
’gše_hªdË
)

335 
DWORD
 
”r
 = 0;

339 ià(
’gše_hªdË
)

341 
”r
 = 
	`FwpmEngšeClo£0
(
’gše_hªdË
);

343  
”r
;

344 
	}
}

358 
	$g‘_š‹rçû_m‘ric
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
ADDRESS_FAMILY
 
çmy
, *
is_auto
)

360 
DWORD
 
”r
 = 0;

361 
MIB_IPINTERFACE_ROW
 
içû
;

362 
	`In™ŸlizeIpIÁ”çûEÁry
(&
içû
);

363 
içû
.
Famy
 = 
çmy
;

364 
içû
.
IÁ”çûIndex
 = 
šdex
;

366 ià(
is_auto
)

368 *
is_auto
 = 0;

370 
”r
 = 
	`G‘IpIÁ”çûEÁry
(&
içû
);

375 ià(
”r
 =ğ
NO_ERROR
 && 
içû
.
M‘ric
 <ğ
INT_MAX
)

377 ià(
is_auto
)

379 *
is_auto
 = 
içû
.
U£Autom©icM‘ric
;

381  ()
içû
.
M‘ric
;

384 
	}
}

396 
DWORD


397 
	$£t_š‹rçû_m‘ric
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
ADDRESS_FAMILY
 
çmy
,

398 cÚ¡ 
ULONG
 
m‘ric
)

400 
DWORD
 
”r
 = 0;

401 
MIB_IPINTERFACE_ROW
 
içû
;

402 
	`In™ŸlizeIpIÁ”çûEÁry
(&
içû
);

403 
içû
.
Famy
 = 
çmy
;

404 
içû
.
IÁ”çûIndex
 = 
šdex
;

405 
”r
 = 
	`G‘IpIÁ”çûEÁry
(&
içû
);

406 ià(
”r
 =ğ
NO_ERROR
)

408 ià(
çmy
 =ğ
AF_INET
)

411 
içû
.
S™eP»fixL’gth
 = 0;

413 
içû
.
M‘ric
 = 
m‘ric
;

414 ià(
m‘ric
 == 0)

416 
içû
.
U£Autom©icM‘ric
 = 
TRUE
;

420 
içû
.
U£Autom©icM‘ric
 = 
FALSE
;

422 
”r
 = 
	`S‘IpIÁ”çûEÁry
(&
içû
);

423 ià(
”r
 =ğ
NO_ERROR
)

428  
”r
;

429 
	}
}

	@block_dns.h

24 #ifdeà
_WIN32


26 #iâdeà
OPENVPN_BLOCK_DNS_H


27 
	#OPENVPN_BLOCK_DNS_H


	)

30 
	#BLOCK_DNS_IFACE_METRIC
 3

	)

32 (*
	tblock_dns_msg_hªdËr_t
è(
	tDWORD
 
	t”r
, cÚ¡ *
	tmsg
);

34 
DWORD


35 
	`d–‘e_block_dns_f‹rs
(
HANDLE
 
’gše
);

37 
DWORD


38 
	`add_block_dns_f‹rs
(
HANDLE
 *
’gše
, 
içû_šdex
, cÚ¡ 
WCHAR
 *
exe_·th
,

39 
block_dns_msg_hªdËr_t
 
msg_hªdËr_ÿÎback
);

52 
	`g‘_š‹rçû_m‘ric
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
ADDRESS_FAMILY
 
çmy
, *
is_auto
);

64 
DWORD


65 
	`£t_š‹rçû_m‘ric
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
ADDRESS_FAMILY
 
çmy
,

66 cÚ¡ 
ULONG
 
m‘ric
);

	@buffer.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"commÚ.h
"

33 
	~"bufãr.h
"

34 
	~"”rÜ.h
"

35 
	~"mtu.h
"

36 
	~"misc.h
"

38 
	~"memdbg.h
"

40 
size_t


41 
	$¬¿y_muÉ_§ã
(cÚ¡ 
size_t
 
m1
, cÚ¡ size_ˆ
m2
, cÚ¡ size_ˆ
exŒa
)

43 cÚ¡ 
size_t
 
lim™
 = 0xFFFFFFFF;

44 
»s
 = ()
m1
 * ()
m2
 + ()
exŒa
;

45 ià(
	`uÆik–y
(
m1
 > 
lim™
è|| uÆik–y(
m2
 >†im™è|| uÆik–y(
exŒa
 >†im™è|| uÆik–y(
»s
 > ()limit))

47 
	`msg
(
M_FATAL
, "attemped‡llocation ofƒxcessively†arge‡rray");

49  (
size_t
è
»s
;

50 
	}
}

53 
	$buf_size_”rÜ
(cÚ¡ 
size_t
 
size
)

55 
	`msg
(
M_FATAL
, "çÈbufã¸siz”rÜ, size=%lu", ()
size
);

56 
	}
}

58 
	gbufãr


59 #ifdeà
DMALLOC


60 
	$®loc_buf_debug
(
size_t
 
size
, cÚ¡ *
fe
, 
lše
)

62 
	$®loc_buf
(
size_t
 
size
)

65 
bufãr
 
buf
;

67 ià(!
	`buf_size_v®id
(
size
))

69 
	`buf_size_”rÜ
(
size
);

71 
buf
.
ÿ·c™y
 = ()
size
;

72 
buf
.
off£t
 = 0;

73 
buf
.
Ën
 = 0;

74 #ifdeà
DMALLOC


75 
buf
.
d©a
 = 
	`İ’v²_dm®loc
(
fe
, 
lše
, 
size
);

77 
buf
.
d©a
 = 
	`ÿÎoc
(1, 
size
);

79 
	`check_m®loc_»tuº
(
buf
.
d©a
);

81  
buf
;

82 
	}
}

84 
	gbufãr


85 #ifdeà
DMALLOC


86 
	$®loc_buf_gc_debug
(
size_t
 
size
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
)

88 
	$®loc_buf_gc
(
size_t
 
size
, 
gc_¬’a
 *
gc
)

91 
bufãr
 
buf
;

92 ià(!
	`buf_size_v®id
(
size
))

94 
	`buf_size_”rÜ
(
size
);

96 
buf
.
ÿ·c™y
 = ()
size
;

97 
buf
.
off£t
 = 0;

98 
buf
.
Ën
 = 0;

99 #ifdeà
DMALLOC


100 
buf
.
d©a
 = (
ušt8_t
 *è
	`gc_m®loc_debug
(
size
, 
çl£
, 
gc
, 
fe
, 
lše
);

102 
buf
.
d©a
 = (
ušt8_t
 *è
	`gc_m®loc
(
size
, 
çl£
, 
gc
);

104 ià(
size
)

106 *
buf
.
d©a
 = 0;

108  
buf
;

109 
	}
}

111 
	gbufãr


112 #ifdeà
DMALLOC


113 
	$şÚe_buf_debug
(cÚ¡ 
bufãr
 *
buf
, cÚ¡ *
fe
, 
lše
)

115 
	$şÚe_buf
(cÚ¡ 
bufãr
 *
buf
)

118 
bufãr
 
»t
;

119 
»t
.
ÿ·c™y
 = 
buf
->capacity;

120 
»t
.
off£t
 = 
buf
->offset;

121 
»t
.
Ën
 = 
buf
->len;

122 #ifdeà
DMALLOC


123 
»t
.
d©a
 = (
ušt8_t
 *è
	`İ’v²_dm®loc
(
fe
, 
lše
, 
buf
->
ÿ·c™y
);

125 
»t
.
d©a
 = (
ušt8_t
 *è
	`m®loc
(
buf
->
ÿ·c™y
);

127 
	`check_m®loc_»tuº
(
»t
.
d©a
);

128 
	`memıy
(
	`BPTR
(&
»t
), BPTR(
buf
), 
	`BLEN
(buf));

129  
»t
;

130 
	}
}

132 #ifdeà
BUF_INIT_TRACKING


134 
boŞ


135 
	$buf_š™_debug
(
bufãr
 *
buf
, 
off£t
, cÚ¡ *
fe
, 
lše
)

137 
buf
->
debug_fe
 = 
fe
;

138 
buf
->
debug_lše
 = 
lše
;

139  
	`buf_š™_dowÜk
(
buf
, 
off£t
);

140 
	}
}

142 
šlše
 

143 
	$buf_debug_lše
(cÚ¡ 
bufãr
 *
buf
)

145  
buf
->
debug_lše
;

146 
	}
}

149 
	$buf_debug_fe
(cÚ¡ 
bufãr
 *
buf
)

151  
buf
->
debug_fe
;

152 
	}
}

156 
	#buf_debug_lše
(
buf
è0

	)

157 
	#buf_debug_fe
(
buf
è"[UNDEF]"

	)

162 
	$buf_ş—r
(
bufãr
 *
buf
)

164 ià(
buf
->
ÿ·c™y
 > 0)

166 
	`£cu»_memz”o
(
buf
->
d©a
, buf->
ÿ·c™y
);

168 
buf
->
Ën
 = 0;

169 
buf
->
off£t
 = 0;

170 
	}
}

172 
boŞ


173 
	$buf_assign
(
bufãr
 *
de¡
, cÚ¡ bufã¸*
¤c
)

175 ià(!
	`buf_š™
(
de¡
, 
¤c
->
off£t
))

177  
çl£
;

179  
	`buf_wr™e
(
de¡
, 
	`BPTR
(
¤c
), 
	`BLEN
(src));

180 
	}
}

182 
bufãr


183 
	$ş—r_buf
()

185 
bufãr
 
buf
;

186 
	`CLEAR
(
buf
);

187  
buf
;

188 
	}
}

191 
	$ä“_buf
(
bufãr
 *
buf
)

193 ià(
buf
->
d©a
)

195 
	`ä“
(
buf
->
d©a
);

197 
	`CLEAR
(*
buf
);

198 
	}
}

203 
bufãr


204 
	$buf_sub
(
bufãr
 *
buf
, 
size
, 
boŞ
 
´•’d
)

206 
bufãr
 
»t
;

207 
ušt8_t
 *
d©a
;

209 
	`CLEAR
(
»t
);

210 
d©a
 = 
´•’d
 ? 
	`buf_´•’d
(
buf
, 
size
è: 
	`buf_wr™e_®loc
(buf, size);

211 ià(
d©a
)

213 
»t
.
ÿ·c™y
 = 
size
;

214 
»t
.
d©a
 = data;

216  
»t
;

217 
	}
}

222 
boŞ


223 
	$buf_´štf
(
bufãr
 *
buf
, cÚ¡ *
fÜm©
, ...)

225 
»t
 = 
çl£
;

226 ià(
	`buf_defšed
(
buf
))

228 
va_li¡
 
¬gli¡
;

229 
ušt8_t
 *
±r
 = 
	`BEND
(
buf
);

230 
ÿp
 = 
	`buf_fÜw¬d_ÿ·c™y
(
buf
);

232 ià(
ÿp
 > 0)

234 
¡©
;

235 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

236 
¡©
 = 
	`v¢´štf
((*)
±r
, 
ÿp
, 
fÜm©
, 
¬gli¡
);

237 
	`va_’d
(
¬gli¡
);

238 *(
buf
->
d©a
 + buf->
ÿ·c™y
 - 1) = 0;

239 
buf
->
Ën
 +ğ(è
	`¡¾’
((*)
±r
);

240 ià(
¡©
 >ğ0 && sˆ< 
ÿp
)

242 
»t
 = 
Œue
;

246  
»t
;

247 
	}
}

249 
boŞ


250 
	$buf_puts
(
bufãr
 *
buf
, cÚ¡ *
¡r
)

252 
»t
 = 
çl£
;

253 
ušt8_t
 *
±r
 = 
	`BEND
(
buf
);

254 
ÿp
 = 
	`buf_fÜw¬d_ÿ·c™y
(
buf
);

255 ià(
ÿp
 > 0)

257 
	`¡ºıyÁ
((*)
±r
,
¡r
, 
ÿp
);

258 *(
buf
->
d©a
 + buf->
ÿ·c™y
 - 1) = 0;

259 
buf
->
Ën
 +ğ(è
	`¡¾’
((*)
±r
);

260 
»t
 = 
Œue
;

262  
»t
;

263 
	}
}

276 
boŞ


277 
	$İ’v²_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

279 
va_li¡
 
¬gli¡
;

280 
Ën
 = -1;

281 ià(
size
 > 0)

283 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

284 
Ën
 = 
	`v¢´štf
(
¡r
, 
size
, 
fÜm©
, 
¬gli¡
);

285 
	`va_’d
(
¬gli¡
);

286 
¡r
[
size
 - 1] = 0;

288  (
Ën
 >ğ0 &&†’ < 
size
);

289 
	}
}

296 
	$buf_ÿŒunc
(
bufãr
 *
buf
, cÚ¡ *
¡r
)

298 ià(
	`buf_fÜw¬d_ÿ·c™y
(
buf
) <= 1)

300 
Ën
 = (è
	`¡¾’
(
¡r
) + 1;

301 ià(
Ën
 < 
	`buf_fÜw¬d_ÿ·c™y_tÙ®
(
buf
))

303 
	`¡ºıyÁ
((*)(
buf
->
d©a
 + buf->
ÿ·c™y
 - 
Ën
), 
¡r
,†en);

306 
	}
}

312 
	$cÚv”t_to_Úe_lše
(
bufãr
 *
buf
)

314 
ušt8_t
 *
ı
 = 
	`BPTR
(
buf
);

315 
Ën
 = 
	`BLEN
(
buf
);

316 
Ën
--)

318 ià(*
ı
 == '\n')

320 *
ı
 = '|';

322 ++
ı
;

324 
	}
}

328 
	$buf_wr™e_¡ršg_fe
(cÚ¡ 
bufãr
 *
buf
, cÚ¡ *
f’ame
, 
fd
)

330 cÚ¡ 
Ën
 = 
	`¡¾’
((*è
	`BPTR
(
buf
));

331 cÚ¡ 
size
 = 
	`wr™e
(
fd
, 
	`BPTR
(
buf
), 
Ën
);

332 ià(
size
 !ğ
Ën
)

334 
	`msg
(
M_ERR
, "Wr™”rÜ oÀf'%s'", 
f’ame
);

336 
	}
}

343 #ifdeà
DMALLOC


344 
	$gc_m®loc_debug
(
size_t
 
size
, 
boŞ
 
ş—r
, 
gc_¬’a
 *
a
, cÚ¡ *
fe
, 
lše
)

346 
	$gc_m®loc
(
size_t
 
size
, 
boŞ
 
ş—r
, 
gc_¬’a
 *
a
)

349 *
»t
;

350 ià(
a
)

352 
gc_’Œy
 *
e
;

353 #ifdeà
DMALLOC


354 
e
 = (
gc_’Œy
 *è
	`İ’v²_dm®loc
(
fe
, 
lše
, 
size
 + (gc_entry));

356 
e
 = (
gc_’Œy
 *è
	`m®loc
(
size
 + (gc_entry));

358 
	`check_m®loc_»tuº
(
e
);

359 
»t
 = (*è
e
 + (
gc_’Œy
);

360 
e
->
Ãxt
 = 
a
->
li¡
;

361 
a
->
li¡
 = 
e
;

365 #ifdeà
DMALLOC


366 
»t
 = 
	`İ’v²_dm®loc
(
fe
, 
lše
, 
size
);

368 
»t
 = 
	`m®loc
(
size
);

370 
	`check_m®loc_»tuº
(
»t
);

372 #iâdeà
ZERO_BUFFER_ON_ALLOC


373 ià(
ş—r
)

375 
	`mem£t
(
»t
, 0, 
size
);

376  
»t
;

377 
	}
}

380 
	$x_gc_ä“
(
gc_¬’a
 *
a
)

382 
gc_’Œy
 *
e
;

383 
e
 = 
a
->
li¡
;

384 
a
->
li¡
 = 
NULL
;

386 
e
 !ğ
NULL
)

388 
gc_’Œy
 *
Ãxt
 = 
e
->next;

389 
	`ä“
(
e
);

390 
e
 = 
Ãxt
;

392 
	}
}

399 
	$x_gc_ä“¥ecŸl
(
gc_¬’a
 *
a
)

401 
gc_’Œy_¥ecŸl
 *
e
;

402 
e
 = 
a
->
li¡_¥ecŸl
;

403 
a
->
li¡_¥ecŸl
 = 
NULL
;

405 
e
 !ğ
NULL
)

407 
gc_’Œy_¥ecŸl
 *
Ãxt
 = 
e
->next;

408 
e
->
	`ä“_âc
Ó->
addr
);

409 
	`ä“
(
e
);

410 
e
 = 
Ãxt
;

412 
	}
}

415 
gc_add¥ecŸl
(*
addr
, (
ä“_funùiÚ
)(*), 
gc_¬’a
 *
a
)

417 
	`ASSERT
(
a
);

418 
gc_’Œy_¥ecŸl
 *
e
;

419 #ifdeà
DMALLOC


420 
e
 = (
gc_’Œy_¥ecŸl
 *è
	`İ’v²_dm®loc
(
fe
, 
lše
, (gc_entry_special));

422 
e
 = (
gc_’Œy_¥ecŸl
 *è
	`m®loc
((gc_entry_special));

424 
	`check_m®loc_»tuº
(
e
);

425 
e
->
ä“_âc
 = 
ä“_funùiÚ
;

426 
e
->
addr
 =‡ddr;

428 
e
->
Ãxt
 = 
a
->
li¡_¥ecŸl
;

429 
a
->
li¡_¥ecŸl
 = 
e
;

430 
	}
}

437 
	$gc_Œªsãr
(
gc_¬’a
 *
de¡
, gc_¬’¨*
¤c
)

439 ià(
de¡
 && 
¤c
)

441 
gc_’Œy
 *
e
 = 
¤c
->
li¡
;

442 ià(
e
)

444 
e
->
Ãxt
 !ğ
NULL
)

446 
e
 =ƒ->
Ãxt
;

448 
e
->
Ãxt
 = 
de¡
->
li¡
;

449 
de¡
->
li¡
 = 
¤c
->list;

450 
¤c
->
li¡
 = 
NULL
;

453 
	}
}

460 
	$fÜm©_hex_ex
(cÚ¡ 
ušt8_t
 *
d©a
, 
size
, 
maxouut
,

461 
¥aû_b»ak_æags
, cÚ¡ *
£·¿tÜ
,

462 
gc_¬’a
 *
gc
)

464 cÚ¡ 
size_t
 
by‹s_³r_hexblock
 = 
¥aû_b»ak_æags
 & 
FHE_SPACE_BREAK_MASK
;

465 cÚ¡ 
size_t
 
£·¿tÜ_Ën
 = 
£·¿tÜ
 ? 
	`¡¾’
(separator) : 0;

466 
	`¡©ic_as£¹
(
INT_MAX
 <ğ
SIZE_MAX
, "Code‡ssumes INT_MAX <= SIZE_MAX");

467 cÚ¡ 
size_t
 
out_Ën
 = 
maxouut
 > 0 ? maxoutput :

468 ((
size
 * 2è+ ((siz/ 
by‹s_³r_hexblock
è* 
£·¿tÜ_Ën
) + 2);

470 
bufãr
 
out
 = 
	`®loc_buf_gc
(
out_Ën
, 
gc
);

471 
i
 = 0; i < 
size
; ++i)

473 ià(
£·¿tÜ
 && 
i
 && !(˜% 
by‹s_³r_hexblock
))

475 
	`buf_´štf
(&
out
, "%s", 
£·¿tÜ
);

477 ià(
¥aû_b»ak_æags
 & 
FHE_CAPS
)

479 
	`buf_´štf
(&
out
, "%02X", 
d©a
[
i
]);

483 
	`buf_´štf
(&
out
, "%02x", 
d©a
[
i
]);

486 
	`buf_ÿŒunc
(&
out
, "[more...]");

487  (*)
out
.
d©a
;

488 
	}
}

495 
	$buf_rm
(
bufãr
 *
buf
, 
ušt8_t
 
»move
)

497 
ušt8_t
 *
ı
 = 
	`BLAST
(
buf
);

498 ià(
ı
 && *ı =ğ
»move
)

500 *
ı
 = '\0';

501 --
buf
->
Ën
;

503 
	}
}

510 
	$buf_nuÎ_‹rmš©e
(
bufãr
 *
buf
)

512 *
Ï¡
 = (*è
	`BLAST
(
buf
);

513 ià(
Ï¡
 && *last == '\0')

518 ià(!
	`buf_§ã
(
buf
, 1))

520 
	`buf_šc_Ën
(
buf
, -1);

523 
	`buf_wr™e_u8
(
buf
, 0);

524 
	}
}

531 
	$buf_chomp
(
bufãr
 *
buf
)

533 
Œue
)

535 *
Ï¡
 = (*è
	`BLAST
(
buf
);

536 ià(!
Ï¡
)

540 ià(
	`ch¬_şass
(*
Ï¡
, 
CC_CRLF
|
CC_NULL
))

542 ià(!
	`buf_šc_Ën
(
buf
, -1))

552 
	`buf_nuÎ_‹rmš©e
(
buf
);

553 
	}
}

556 
	$sk_Ëadšg_wh™e¥aû
(cÚ¡ *
¡r
)

558 *
¡r
)

560 cÚ¡ 
c
 = *
¡r
;

561 ià(!(
c
 == ' ' || c == '\t'))

565 ++
¡r
;

567  
¡r
;

568 
	}
}

574 
	$¡ršg_nuÎ_‹rmš©e
(*
¡r
, 
Ën
, 
ÿ·c™y
)

576 
	`ASSERT
(
Ën
 >ğ0 &&†’ <ğ
ÿ·c™y
 && capacity > 0);

577 ià(
Ën
 < 
ÿ·c™y
)

579 *(
¡r
 + 
Ën
) = '\0';

581 ià(
Ën
 =ğ
ÿ·c™y
)

583 *(
¡r
 + 
Ën
 - 1) = '\0';

585 
	}
}

591 
	$chomp
(*
¡r
)

593 
	`rm_Œašg_ch¬s
(
¡r
, "\r\n");

594 
	}
}

600 
	$rm_Œašg_ch¬s
(*
¡r
, cÚ¡ *
wh©_to_d–‘e
)

602 
boŞ
 
modif›d
;

605 cÚ¡ 
Ën
 = 
	`¡¾’
(
¡r
);

606 
modif›d
 = 
çl£
;

607 ià(
Ën
 > 0)

609 *
ı
 = 
¡r
 + (
Ën
 - 1);

610 ià(
	`¡rchr
(
wh©_to_d–‘e
, *
ı
è!ğ
NULL
)

612 *
ı
 = '\0';

613 
modif›d
 = 
Œue
;

616 } 
modif›d
);

617 
	}
}

623 #ifdeà
DMALLOC


624 
	$¡ršg_®loc_debug
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
)

626 
	$¡ršg_®loc
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
)

629 ià(
¡r
)

631 cÚ¡ 
n
 = 
	`¡¾’
(
¡r
) + 1;

632 *
»t
;

634 ià(
gc
)

636 #ifdeà
DMALLOC


637 
»t
 = (*è
	`gc_m®loc_debug
(
n
, 
çl£
, 
gc
, 
fe
, 
lše
);

639 
»t
 = (*è
	`gc_m®loc
(
n
, 
çl£
, 
gc
);

648 #ifdeà
DMALLOC


649 
»t
 = 
	`İ’v²_dm®loc
(
fe
, 
lše
, 
n
);

650 
	`mem£t
(
»t
, 0, 
n
);

652 
»t
 = 
	`ÿÎoc
(1, 
n
);

654 
	`check_m®loc_»tuº
(
»t
);

656 
	`memıy
(
»t
, 
¡r
, 
n
);

657  
»t
;

661  
NULL
;

663 
	}
}

669 
	$¡ršg_ş—r
(*
¡r
)

671 ià(
¡r
)

673 
	`£cu»_memz”o
(
¡r
, 
	`¡¾’
(str));

675 
	}
}

681 
	$¡ršg_¬¿y_Ën
(cÚ¡ **
¬¿y
)

683 
i
 = 0;

684 ià(
¬¿y
)

686 
¬¿y
[
i
])

688 ++
i
;

691  
i
;

692 
	}
}

695 
	$´št_¬gv
(cÚ¡ **
p
, 
gc_¬’a
 *
gc
, cÚ¡ 
æags
)

697 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

698 
i
 = 0;

701 cÚ¡ *
ı
 = *
p
++;

702 ià(!
ı
)

706 ià(
i
)

708 
	`buf_´štf
(&
out
, " ");

710 ià(
æags
 & 
PA_BRACKET
)

712 
	`buf_´štf
(&
out
, "[%s]", 
ı
);

716 
	`buf_´štf
(&
out
, "%s", 
ı
);

718 ++
i
;

720  
	`BSTR
(&
out
);

721 
	}
}

726 
	gbufãr


727 #ifdeà
DMALLOC


728 
	$¡ršg_®loc_buf_debug
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
)

730 
	$¡ršg_®loc_buf
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
)

733 
bufãr
 
buf
;

735 
	`ASSERT
(
¡r
);

737 #ifdeà
DMALLOC


738 
	`buf_£t_»ad
(&
buf
, (
ušt8_t
 *è
	`¡ršg_®loc_debug
(
¡r
, 
gc
, 
fe
, 
lše
), 
	`¡¾’
(str) + 1);

740 
	`buf_£t_»ad
(&
buf
, (
ušt8_t
 *è
	`¡ršg_®loc
(
¡r
, 
gc
), 
	`¡¾’
(str) + 1);

743 ià(
buf
.
Ën
 > 0)

745 --
buf
.
Ën
;

748  
buf
;

749 
	}
}

755 
boŞ


756 
	$buf_¡ršg_m©ch_h—d_¡r
(cÚ¡ 
bufãr
 *
¤c
, cÚ¡ *
m©ch
)

758 cÚ¡ 
size
 = 
	`¡¾’
(
m©ch
);

759 ià(
size
 < 0 || siz> 
¤c
->
Ën
)

761  
çl£
;

763  
	`memcmp
(
	`BPTR
(
¤c
), 
m©ch
, 
size
) == 0;

764 
	}
}

766 
boŞ


767 
	$buf_¡ršg_com·»_advªû
(
bufãr
 *
¤c
, cÚ¡ *
m©ch
)

769 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(
¤c
, 
m©ch
))

771 
	`buf_advªû
(
¤c
, 
	`¡¾’
(
m©ch
));

772  
Œue
;

776  
çl£
;

778 
	}
}

781 
	$buf_sub¡ršg_Ën
(cÚ¡ 
bufãr
 *
buf
, 
d–im
)

783 
i
 = 0;

784 
bufãr
 
tmp
 = *
buf
;

785 
c
;

787 (
c
 = 
	`buf_»ad_u8
(&
tmp
)) >= 0)

789 ++
i
;

790 ià(
c
 =ğ
d–im
)

792  
i
;

796 
	}
}

802 
boŞ


803 
	$buf_·r£
(
bufãr
 *
buf
, cÚ¡ 
d–im
, *
lše
, cÚ¡ 
size
)

805 
boŞ
 
eŞ
 = 
çl£
;

806 
n
 = 0;

807 
c
;

809 
	`ASSERT
(
size
 > 0);

813 
c
 = 
	`buf_»ad_u8
(
buf
);

814 ià(
c
 < 0)

816 
eŞ
 = 
Œue
;

818 ià(
c
 <ğ0 || c =ğ
d–im
)

820 
c
 = 0;

822 ià(
n
 >ğ
size
)

826 
lše
[
n
++] = 
c
;

828 
c
);

830 
lše
[
size
-1] = '\0';

831  !(
eŞ
 && !
	`¡¾’
(
lše
));

832 
	}
}

838 
	$Å
(cÚ¡ *
¡r
)

840 ià(
¡r
)

842  
¡r
;

848 
	}
}

854 
boŞ


855 
	$ch¬_şass
(cÚ¡ 
c
, cÚ¡ 
æags
)

857 ià(!
æags
)

859  
çl£
;

861 ià(
æags
 & 
CC_ANY
)

863  
Œue
;

866 ià((
æags
 & 
CC_NULL
è&& 
c
 == '\0')

868  
Œue
;

871 ià((
æags
 & 
CC_ALNUM
è&& 
	`i§Êum
(
c
))

873  
Œue
;

875 ià((
æags
 & 
CC_ALPHA
è&& 
	`i§Íha
(
c
))

877  
Œue
;

879 ià((
æags
 & 
CC_ASCII
è&& 
	`i§scii
(
c
))

881  
Œue
;

883 ià((
æags
 & 
CC_CNTRL
è&& 
	`isúŒl
(
c
))

885  
Œue
;

887 ià((
æags
 & 
CC_DIGIT
è&& 
	`isdig™
(
c
))

889  
Œue
;

891 ià((
æags
 & 
CC_PRINT
è&& (
c
 >= 32 && c != 127))

893  
Œue
;

895 ià((
æags
 & 
CC_PUNCT
è&& 
	`i¥unù
(
c
))

897  
Œue
;

899 ià((
æags
 & 
CC_SPACE
è&& 
	`is¥aû
(
c
))

901  
Œue
;

903 ià((
æags
 & 
CC_XDIGIT
è&& 
	`isxdig™
(
c
))

905  
Œue
;

908 ià((
æags
 & 
CC_BLANK
è&& (
c
 == ' ' || c == '\t'))

910  
Œue
;

912 ià((
æags
 & 
CC_NEWLINE
è&& 
c
 == '\n')

914  
Œue
;

916 ià((
æags
 & 
CC_CR
è&& 
c
 == '\r')

918  
Œue
;

921 ià((
æags
 & 
CC_BACKSLASH
è&& 
c
 == '\\')

923  
Œue
;

925 ià((
æags
 & 
CC_UNDERBAR
è&& 
c
 == '_')

927  
Œue
;

929 ià((
æags
 & 
CC_DASH
è&& 
c
 == '-')

931  
Œue
;

933 ià((
æags
 & 
CC_DOT
è&& 
c
 == '.')

935  
Œue
;

937 ià((
æags
 & 
CC_COMMA
è&& 
c
 == ',')

939  
Œue
;

941 ià((
æags
 & 
CC_COLON
è&& 
c
 == ':')

943  
Œue
;

945 ià((
æags
 & 
CC_SLASH
è&& 
c
 == '/')

947  
Œue
;

949 ià((
æags
 & 
CC_SINGLE_QUOTE
è&& 
c
 == '\'')

951  
Œue
;

953 ià((
æags
 & 
CC_DOUBLE_QUOTE
è&& 
c
 == '\"')

955  
Œue
;

957 ià((
æags
 & 
CC_REVERSE_QUOTE
è&& 
c
 == '`')

959  
Œue
;

961 ià((
æags
 & 
CC_AT
è&& 
c
 == '@')

963  
Œue
;

965 ià((
æags
 & 
CC_EQUAL
è&& 
c
 == '=')

967  
Œue
;

969 ià((
æags
 & 
CC_LESS_THAN
è&& 
c
 == '<')

971  
Œue
;

973 ià((
æags
 & 
CC_GREATER_THAN
è&& 
c
 == '>')

975  
Œue
;

977 ià((
æags
 & 
CC_PIPE
è&& 
c
 == '|')

979  
Œue
;

981 ià((
æags
 & 
CC_QUESTION_MARK
è&& 
c
 == '?')

983  
Œue
;

985 ià((
æags
 & 
CC_ASTERISK
è&& 
c
 == '*')

987  
Œue
;

990  
çl£
;

991 
	}
}

993 
šlše
 
boŞ


994 
	$ch¬_šc_exc
(cÚ¡ 
c
, cÚ¡ 
šşusive
, cÚ¡ 
exşusive
)

996  
	`ch¬_şass
(
c
, 
šşusive
è&& !ch¬_şass(c, 
exşusive
);

997 
	}
}

999 
boŞ


1000 
	$¡ršg_şass
(cÚ¡ *
¡r
, cÚ¡ 
šşusive
, cÚ¡ 
exşusive
)

1002 
c
;

1003 
	`ASSERT
(
¡r
);

1004 (
c
 = *
¡r
++))

1006 ià(!
	`ch¬_šc_exc
(
c
, 
šşusive
, 
exşusive
))

1008  
çl£
;

1011  
Œue
;

1012 
	}
}

1018 
boŞ


1019 
	$¡ršg_mod
(*
¡r
, cÚ¡ 
šşusive
, cÚ¡ 
exşusive
, cÚ¡ 
»¶aû
)

1021 cÚ¡ *
š
 = 
¡r
;

1022 
boŞ
 
»t
 = 
Œue
;

1024 
	`ASSERT
(
¡r
);

1026 
Œue
)

1028 
c
 = *
š
++;

1029 ià(
c
)

1031 ià(!
	`ch¬_šc_exc
(
c
, 
šşusive
, 
exşusive
))

1033 
c
 = 
»¶aû
;

1034 
»t
 = 
çl£
;

1036 ià(
c
)

1038 *
¡r
++ = 
c
;

1043 *
¡r
 = '\0';

1047  
»t
;

1048 
	}
}

1051 
	$¡ršg_mod_cÚ¡
(cÚ¡ *
¡r
,

1052 cÚ¡ 
šşusive
,

1053 cÚ¡ 
exşusive
,

1054 cÚ¡ 
»¶aû
,

1055 
gc_¬’a
 *
gc
)

1057 ià(
¡r
)

1059 *
buf
 = 
	`¡ršg_®loc
(
¡r
, 
gc
);

1060 
	`¡ršg_mod
(
buf
, 
šşusive
, 
exşusive
, 
»¶aû
);

1061  
buf
;

1065  
NULL
;

1067 
	}
}

1070 
	$¡ršg_»¶aû_Ëadšg
(*
¡r
, cÚ¡ 
m©ch
, cÚ¡ 
»¶aû
)

1072 
	`ASSERT
(
m©ch
 != '\0');

1073 *
¡r
)

1075 ià(*
¡r
 =ğ
m©ch
)

1077 *
¡r
 = 
»¶aû
;

1083 ++
¡r
;

1085 
	}
}

1087 #ifdeà
CHARACTER_CLASS_DEBUG


1089 
	#CC_INCLUDE
 (
CC_PRINT
)

	)

1090 
	#CC_EXCLUDE
 (0)

	)

1091 
	#CC_REPLACE
 ('.')

	)

1094 
	$ch¬aù”_şass_debug
()

1096 
buf
[256];

1098 
	`fg‘s
(
buf
, (buf), 
¡dš
è!ğ
NULL
)

1100 
	`¡ršg_mod
(
buf
, 
CC_INCLUDE
, 
CC_EXCLUDE
, 
CC_REPLACE
);

1101 
	`´štf
("%s", 
buf
);

1103 
	}
}

1107 #ifdeà
VERIFY_ALIGNMENT


1109 
	$v®ign4
(cÚ¡ 
bufãr
 *
buf
, cÚ¡ *
fe
, cÚ¡ 
lše
)

1111 ià(
buf
 && buf->
Ën
)

1113 
msgËv–
 = 
D_ALIGN_DEBUG
;

1114 cÚ¡ 
u
 = (è
	`BPTR
(
buf
);

1116 ià(
u
 & (
PAYLOAD_ALIGN
-1))

1118 
msgËv–
 = 
D_ALIGN_ERRORS
;

1121 
	`msg
(
msgËv–
, "%sAlignm’ˆ© %s/%d…Œ=" 
±r_fÜm©
 " OLC=%d/%d/%d I=%s/%d",

1122 (
msgËv–
 =ğ
D_ALIGN_ERRORS
) ? "ERROR: " : "",

1123 
fe
,

1124 
lše
,

1125 (
±r_ty³
)
buf
->
d©a
,

1126 
buf
->
off£t
,

1127 
buf
->
Ën
,

1128 
buf
->
ÿ·c™y
,

1129 
	`buf_debug_fe
(
buf
),

1130 
	`buf_debug_lše
(
buf
));

1132 
	}
}

1138 
bufãr_li¡
 *

1139 
	$bufãr_li¡_Ãw
(cÚ¡ 
max_size
)

1141 
bufãr_li¡
 *
»t
;

1142 
	`ALLOC_OBJ_CLEAR
(
»t
, 
bufãr_li¡
);

1143 
»t
->
max_size
 = max_size;

1144 
»t
->
size
 = 0;

1145  
»t
;

1146 
	}
}

1149 
	$bufãr_li¡_ä“
(
bufãr_li¡
 *
Ş
)

1151 ià(
Ş
)

1153 
	`bufãr_li¡_»£t
(
Ş
);

1154 
	`ä“
(
Ş
);

1156 
	}
}

1158 
boŞ


1159 
	$bufãr_li¡_defšed
(cÚ¡ 
bufãr_li¡
 *
Ş
)

1161  
Ş
 && ol->
h—d
 !ğ
NULL
;

1162 
	}
}

1165 
	$bufãr_li¡_»£t
(
bufãr_li¡
 *
Ş
)

1167 
bufãr_’Œy
 *
e
 = 
Ş
->
h—d
;

1168 
e
)

1170 
bufãr_’Œy
 *
Ãxt
 = 
e
->next;

1171 
	`ä“_buf
(&
e
->
buf
);

1172 
	`ä“
(
e
);

1173 
e
 = 
Ãxt
;

1175 
Ş
->
h—d
 = ol->

 = 
NULL
;

1176 
Ş
->
size
 = 0;

1177 
	}
}

1180 
	$bufãr_li¡_push
(
bufãr_li¡
 *
Ş
, cÚ¡ *
¡r
)

1182 ià(
¡r
)

1184 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
((cÚ¡ *)
¡r
);

1185 
bufãr_’Œy
 *
e
 = 
	`bufãr_li¡_push_d©a
(
Ş
, 
¡r
, 
Ën
+1);

1186 ià(
e
)

1188 
e
->
buf
.
Ën
 =†en;

1191 
	}
}

1193 
bufãr_’Œy
 *

1194 
	$bufãr_li¡_push_d©a
(
bufãr_li¡
 *
Ş
, cÚ¡ *
d©a
, 
size_t
 
size
)

1196 
bufãr_’Œy
 *
e
 = 
NULL
;

1197 ià(
d©a
 && (!
Ş
->
max_size
 || ol->
size
 < ol->max_size))

1199 
	`ALLOC_OBJ_CLEAR
(
e
, 
bufãr_’Œy
);

1201 ++
Ş
->
size
;

1202 ià(
Ş
->

)

1204 
	`ASSERT
(
Ş
->
h—d
);

1205 
Ş
->

->
Ãxt
 = 
e
;

1209 
	`ASSERT
(!
Ş
->
h—d
);

1210 
Ş
->
h—d
 = 
e
;

1212 
e
->
buf
 = 
	`®loc_buf
(
size
);

1213 
	`memıy
(
e
->
buf
.
d©a
, d©a, 
size
);

1214 
e
->
buf
.
Ën
 = ()
size
;

1215 
Ş
->

 = 
e
;

1217  
e
;

1218 
	}
}

1220 
bufãr
 *

1221 
	$bufãr_li¡_³ek
(
bufãr_li¡
 *
Ş
)

1223 ià(
Ş
 && ol->
h—d
)

1225  &
Ş
->
h—d
->
buf
;

1229  
NULL
;

1231 
	}
}

1234 
	$bufãr_li¡_agg»g©e_£·¿tÜ
(
bufãr_li¡
 *
bl
, cÚ¡ 
size_t
 
max_Ën
,

1235 cÚ¡ *
£p
)

1237 cÚ¡ 
£p_Ën
 = 
	`¡¾’
(
£p
);

1238 
bufãr_’Œy
 *
mÜe
 = 
bl
->
h—d
;

1239 
size_t
 
size
 = 0;

1240 
couÁ
 = 0;

1241 
couÁ
 = 0; 
mÜe
; ++count)

1243 
size_t
 
exŒa_Ën
 = 
	`BLEN
(&
mÜe
->
buf
è+ 
£p_Ën
;

1244 ià(
size
 + 
exŒa_Ën
 > 
max_Ën
)

1249 
size
 +ğ
exŒa_Ën
;

1250 
mÜe
 = mÜe->
Ãxt
;

1253 ià(
couÁ
 >= 2)

1255 
bufãr_’Œy
 *
f
;

1256 
	`ALLOC_OBJ_CLEAR
(
f
, 
bufãr_’Œy
);

1257 
f
->
buf
 = 
	`®loc_buf
(
size
 + 1);

1259 
bufãr_’Œy
 *
e
 = 
bl
->
h—d
;

1260 
size_t
 
i
 = 0; 
e
 && i < 
couÁ
; ++i)

1262 
bufãr_’Œy
 *
Ãxt
 = 
e
->next;

1263 
	`buf_cİy
(&
f
->
buf
, &
e
->buf);

1264 
	`buf_wr™e
(&
f
->
buf
, 
£p
, 
£p_Ën
);

1265 
	`ä“_buf
(&
e
->
buf
);

1266 
	`ä“
(
e
);

1267 
e
 = 
Ãxt
;

1269 
bl
->
h—d
 = 
f
;

1270 
bl
->
size
 -ğ
couÁ
 - 1;

1271 
f
->
Ãxt
 = 
mÜe
;

1272 ià(!
mÜe
)

1274 
bl
->

 = 
f
;

1277 
	}
}

1280 
	$bufãr_li¡_agg»g©e
(
bufãr_li¡
 *
bl
, cÚ¡ 
size_t
 
max
)

1282 
	`bufãr_li¡_agg»g©e_£·¿tÜ
(
bl
, 
max
, "");

1283 
	}
}

1286 
	$bufãr_li¡_pİ
(
bufãr_li¡
 *
Ş
)

1288 ià(
Ş
 && ol->
h—d
)

1290 
bufãr_’Œy
 *
e
 = 
Ş
->
h—d
->
Ãxt
;

1291 
	`ä“_buf
(&
Ş
->
h—d
->
buf
);

1292 
	`ä“
(
Ş
->
h—d
);

1293 
Ş
->
h—d
 = 
e
;

1294 --
Ş
->
size
;

1295 ià(!
e
)

1297 
Ş
->

 = 
NULL
;

1300 
	}
}

1303 
	$bufãr_li¡_advªû
(
bufãr_li¡
 *
Ş
, 
n
)

1305 ià(
Ş
->
h—d
)

1307 
bufãr
 *
buf
 = &
Ş
->
h—d
->buf;

1308 
	`ASSERT
(
	`buf_advªû
(
buf
, 
n
));

1309 ià(!
	`BLEN
(
buf
))

1311 
	`bufãr_li¡_pİ
(
Ş
);

1314 
	}
}

1316 
bufãr_li¡
 *

1317 
	$bufãr_li¡_fe
(cÚ¡ *
â
, 
max_lše_Ën
)

1319 
FILE
 *
å
 = 
	`¶©fÜm_fİ’
(
â
, "r");

1320 
bufãr_li¡
 *
bl
 = 
NULL
;

1322 ià(
å
)

1324 *
lše
 = (*è
	`m®loc
(
max_lše_Ën
);

1325 ià(
lše
)

1327 
bl
 = 
	`bufãr_li¡_Ãw
(0);

1328 
	`fg‘s
(
lše
, 
max_lše_Ën
, 
å
è!ğ
NULL
)

1330 
	`bufãr_li¡_push
(
bl
, 
lše
);

1332 
	`ä“
(
lše
);

1334 
	`fşo£
(
å
);

1336  
bl
;

1337 
	}
}

	@buffer.h

24 #iâdeà
BUFFER_H


25 
	#BUFFER_H


	)

27 
	~"basic.h
"

28 
	~"”rÜ.h
"

30 
	#BUF_SIZE_MAX
 1000000

	)

41 #ifdeà
VERIFY_ALIGNMENT


42 
	#BUF_INIT_TRACKING


	)

60 
	sbufãr


62 
	mÿ·c™y
;

64 
	moff£t
;

66 
	mËn
;

68 
ušt8_t
 *
	md©a
;

70 #ifdeà
BUF_INIT_TRACKING


71 cÚ¡ *
	mdebug_fe
;

72 
	mdebug_lše
;

87 
	sgc_’Œy


89 
gc_’Œy
 *
	mÃxt
;

98 
	sgc_’Œy_¥ecŸl


100 
gc_’Œy_¥ecŸl
 *
	mÃxt
;

101 (*
	mä“_âc
)(*);

102 *
	maddr
;

116 
	sgc_¬’a


118 
gc_’Œy
 *
	mli¡
;

120 
gc_’Œy_¥ecŸl
 *
	mli¡_¥ecŸl
;

124 
	#BPTR
(
buf
è(
	`buf_b±r
(buf))

	)

125 
	#BEND
(
buf
è(
	`buf_b’d
(buf))

	)

126 
	#BLAST
(
buf
è(
	`buf_bÏ¡
(buf))

	)

127 
	#BLEN
(
buf
è(
	`buf_Ën
(buf))

	)

128 
	#BDEF
(
buf
è(
	`buf_defšed
(buf))

	)

129 
	#BSTR
(
buf
è(
	`buf_¡r
(buf))

	)

130 
	#BCAP
(
buf
è(
	`buf_fÜw¬d_ÿ·c™y
(buf))

	)

132 
buf_ş—r
(
bufãr
 *
buf
);

134 
bufãr
 
ş—r_buf
();

136 
ä“_buf
(
bufãr
 *
buf
);

138 
boŞ
 
buf_assign
(
bufãr
 *
de¡
, cÚ¡ bufã¸*
¤c
);

140 
¡ršg_ş—r
(*
¡r
);

142 
¡ršg_¬¿y_Ën
(cÚ¡ **
¬¿y
);

144 
size_t
 
¬¿y_muÉ_§ã
(cÚ¡ size_ˆ
m1
, cÚ¡ size_ˆ
m2
, cÚ¡ size_ˆ
exŒa
);

146 
	#PA_BRACKET
 (1<<0)

	)

147 *
´št_¬gv
(cÚ¡ **
p
, 
gc_¬’a
 *
gc
, cÚ¡ 
æags
);

149 
buf_size_”rÜ
(cÚ¡ 
size_t
 
size
);

153 #ifdeà
DMALLOC


155 
	#®loc_buf
(
size
è
	`®loc_buf_debug
(size, 
__FILE__
, 
__LINE__
)

	)

156 
	#®loc_buf_gc
(
size
, 
gc
è
	`®loc_buf_gc_debug
(size, gc, 
__FILE__
, 
__LINE__
);

	)

157 
	#şÚe_buf
(
buf
è
	`şÚe_buf_debug
(buf, 
__FILE__
, 
__LINE__
);

	)

158 
	#gc_m®loc
(
size
, 
ş—r
, 
¬’a
è
	`gc_m®loc_debug
(size, cË¬,‡»Ç, 
__FILE__
, 
__LINE__
)

	)

159 
	#¡ršg_®loc
(
¡r
, 
gc
è
	`¡ršg_®loc_debug
(¡r, gc, 
__FILE__
, 
__LINE__
)

	)

160 
	#¡ršg_®loc_buf
(
¡r
, 
gc
è
	`¡ršg_®loc_buf_debug
(¡r, gc, 
__FILE__
, 
__LINE__
)

	)

162 
bufãr
 
®loc_buf_debug
(
size_t
 
size
, cÚ¡ *
fe
, 
lše
);

164 
bufãr
 
®loc_buf_gc_debug
(
size_t
 
size
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
);

166 
bufãr
 
şÚe_buf_debug
(cÚ¡ bufã¸*
buf
, cÚ¡ *
fe
, 
lše
);

168 *
gc_m®loc_debug
(
size_t
 
size
, 
boŞ
 
ş—r
, 
gc_¬’a
 *
a
, cÚ¡ *
fe
, 
lše
);

170 *
¡ršg_®loc_debug
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
);

172 
bufãr
 
¡ršg_®loc_buf_debug
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
, cÚ¡ *
fe
, 
lše
);

176 
bufãr
 
®loc_buf
(
size_t
 
size
);

178 
bufãr
 
®loc_buf_gc
(
size_t
 
size
, 
gc_¬’a
 *
gc
);

180 
bufãr
 
şÚe_buf
(cÚ¡ bufã¸*
buf
);

182 *
gc_m®loc
(
size_t
 
size
, 
boŞ
 
ş—r
, 
gc_¬’a
 *
a
);

184 *
¡ršg_®loc
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
);

186 
bufãr
 
¡ršg_®loc_buf
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
);

190 
gc_add¥ecŸl
(*
addr
, (*
ä“_funùiÚ
)(*), 
gc_¬’a
 *
a
);

193 #ifdeà
BUF_INIT_TRACKING


194 
	#buf_š™
(
buf
, 
off£t
è
	`buf_š™_debug
(buf, off£t, 
__FILE__
, 
__LINE__
)

	)

195 
boŞ
 
	`buf_š™_debug
(
bufãr
 *
buf
, 
off£t
, cÚ¡ *
fe
, 
lše
);

198 
	#buf_š™
(
buf
, 
off£t
è
	`buf_š™_dowÜk
(buf, off£t)

	)

203 
šlše
 

204 
	$gc_ä“addršfo_ÿÎback
(*
addr
)

206 
	`ä“addršfo
((
addršfo
 *è
addr
);

207 
	}
}

209 
šlše
 
boŞ


210 
	$buf_defšed
(cÚ¡ 
bufãr
 *
buf
)

212  
buf
->
d©a
 !ğ
NULL
;

213 
	}
}

215 
šlše
 
boŞ


216 
	$buf_v®id
(cÚ¡ 
bufãr
 *
buf
)

218  
	`lik–y
(
buf
->
d©a
 !ğ
NULL
è&&†ik–y(buf->
Ën
 >= 0);

219 
	}
}

221 
šlše
 
ušt8_t
 *

222 
	$buf_b±r
(cÚ¡ 
bufãr
 *
buf
)

224 ià(
	`buf_v®id
(
buf
))

226  
buf
->
d©a
 + buf->
off£t
;

230  
NULL
;

232 
	}
}

235 
	$buf_Ën
(cÚ¡ 
bufãr
 *
buf
)

237 ià(
	`buf_v®id
(
buf
))

239  
buf
->
Ën
;

245 
	}
}

247 
šlše
 
ušt8_t
 *

248 
	$buf_b’d
(cÚ¡ 
bufãr
 *
buf
)

250  
	`buf_b±r
(
buf
è+ 
	`buf_Ën
(buf);

251 
	}
}

253 
šlše
 
ušt8_t
 *

254 
	$buf_bÏ¡
(cÚ¡ 
bufãr
 *
buf
)

256 ià(
	`buf_Ën
(
buf
) > 0)

258  
	`buf_b±r
(
buf
è+ 
	`buf_Ën
(buf) - 1;

262  
NULL
;

264 
	}
}

266 
šlše
 
boŞ


267 
	$buf_size_v®id
(cÚ¡ 
size_t
 
size
)

269  
	`lik–y
(
size
 < 
BUF_SIZE_MAX
);

270 
	}
}

272 
šlše
 
boŞ


273 
	$buf_size_v®id_sigÃd
(cÚ¡ 
size
)

275  
	`lik–y
(
size
 >ğ-
BUF_SIZE_MAX
) &&†ikely(size < BUF_SIZE_MAX);

276 
	}
}

278 
šlše
 *

279 
	$buf_¡r
(cÚ¡ 
bufãr
 *
buf
)

281  (*)
	`buf_b±r
(
buf
);

282 
	}
}

284 
šlše
 

285 
	$buf_»£t
(
bufãr
 *
buf
)

287 
buf
->
ÿ·c™y
 = 0;

288 
buf
->
off£t
 = 0;

289 
buf
->
Ën
 = 0;

290 
buf
->
d©a
 = 
NULL
;

291 
	}
}

293 
šlše
 

294 
	$buf_»£t_Ën
(
bufãr
 *
buf
)

296 
buf
->
Ën
 = 0;

297 
buf
->
off£t
 = 0;

298 
	}
}

300 
šlše
 
boŞ


301 
	$buf_š™_dowÜk
(
bufãr
 *
buf
, 
off£t
)

303 ià(
off£t
 < 0 || off£ˆ> 
buf
->
ÿ·c™y
 || buf->
d©a
 =ğ
NULL
)

305  
çl£
;

307 
buf
->
Ën
 = 0;

308 
buf
->
off£t
 = offset;

309  
Œue
;

310 
	}
}

312 
šlše
 

313 
	$buf_£t_wr™e
(
bufãr
 *
buf
, 
ušt8_t
 *
d©a
, 
size
)

315 ià(!
	`buf_size_v®id
(
size
))

317 
	`buf_size_”rÜ
(
size
);

319 
buf
->
Ën
 = 0;

320 
buf
->
off£t
 = 0;

321 
buf
->
ÿ·c™y
 = 
size
;

322 
buf
->
d©a
 = data;

323 ià(
size
 > 0 && 
d©a
)

325 *
d©a
 = 0;

327 
	}
}

329 
šlše
 

330 
	$buf_£t_»ad
(
bufãr
 *
buf
, cÚ¡ 
ušt8_t
 *
d©a
, 
size
)

332 ià(!
	`buf_size_v®id
(
size
))

334 
	`buf_size_”rÜ
(
size
);

336 
buf
->
Ën
 = buf->
ÿ·c™y
 = 
size
;

337 
buf
->
off£t
 = 0;

338 
buf
->
d©a
 = (
ušt8_t
 *)data;

339 
	}
}

342 
šlše
 

343 
	$¡ºıyÁ
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
maxËn
)

345 
	`¡ºıy
(
de¡
, 
¤c
, 
maxËn
);

346 ià(
maxËn
 > 0)

348 
de¡
[
maxËn
 - 1] = 0;

350 
	}
}

353 
šlše
 
boŞ


354 
	$has_dig™
(cÚ¡ *
¤c
)

356 
c
;

357 (
c
 = *
¤c
++))

359 ià(
	`isdig™
(
c
))

361  
Œue
;

364  
çl£
;

365 
	}
}

395 
šlše
 

396 
	$£cu»_memz”o
(*
d©a
, 
size_t
 
Ën
)

398 #ià
	`defšed
(
_WIN32
)

399 
	`Secu»Z”oMemÜy
(
d©a
, 
Ën
);

400 #–ià
	`defšed
(
__GNUC__
è|| defšed(
__şªg__
)

401 
	`mem£t
(
d©a
, 0, 
Ën
);

402 
__asm__
 
	`__vŞ©e__
 ("" : : "r" (
d©a
) : "memory");

404 vŞ©*
p
 = (vŞ©*è
d©a
;

405 
Ën
--)

407 *
p
++ = 0;

410 
	}
}

418 
boŞ
 
	$buf_´štf
(
bufãr
 *
buf
, cÚ¡ *
fÜm©
, ...)

419 #ifdeà
__GNUC__


420 #ià
__USE_MINGW_ANSI_STDIO


421 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 2, 3)))

423 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 2, 3)))

431 
boŞ
 
	`buf_puts
(
bufãr
 *
buf
, cÚ¡ *
¡r
);

436 
boŞ
 
	$İ’v²_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fÜm©
, ...)

437 #ifdeà
__GNUC__


438 #ià
__USE_MINGW_ANSI_STDIO


439 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 3, 4)))

441 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 3, 4)))

450 
	`buf_nuÎ_‹rmš©e
(
bufãr
 *
buf
);

452 
	`buf_chomp
(
bufãr
 *
buf
);

454 
	`buf_rm
(
bufãr
 *
buf
, 
ušt8_t
 
»move
);

459 
	`chomp
(*
¡r
);

461 
	`rm_Œašg_ch¬s
(*
¡r
, cÚ¡ *
wh©_to_d–‘e
);

463 cÚ¡ *
	`sk_Ëadšg_wh™e¥aû
(cÚ¡ *
¡r
);

465 
	`¡ršg_nuÎ_‹rmš©e
(*
¡r
, 
Ën
, 
ÿ·c™y
);

471 
	`buf_wr™e_¡ršg_fe
(cÚ¡ 
bufãr
 *
buf
, cÚ¡ *
f’ame
, 
fd
);

477 
	`buf_ÿŒunc
(
bufãr
 *
buf
, cÚ¡ *
¡r
);

482 
	`cÚv”t_to_Úe_lše
(
bufãr
 *
buf
);

487 
boŞ
 
	`buf_·r£
(
bufãr
 *
buf
, cÚ¡ 
d–im
, *
lše
, cÚ¡ 
size
);

492 
	#FHE_SPACE_BREAK_MASK
 0xFF

	)

493 
	#FHE_CAPS
 0x100

	)

495 
	`fÜm©_hex_ex
(cÚ¡ 
ušt8_t
 *
d©a
, 
size
, 
maxouut
,

496 
¥aû_b»ak_æags
, cÚ¡ *
£·¿tÜ
,

497 
gc_¬’a
 *
gc
);

499 
šlše
 *

500 
	$fÜm©_hex
(cÚ¡ 
ušt8_t
 *
d©a
, 
size
, 
maxouut
, 
gc_¬’a
 *
gc
)

502  
	`fÜm©_hex_ex
(
d©a
, 
size
, 
maxouut
, 4, " ", 
gc
);

503 
	}
}

508 
bufãr
 
buf_sub
(bufã¸*
buf
, 
size
, 
boŞ
 
´•’d
);

514 
šlše
 
boŞ


515 
	$buf_§ã
(cÚ¡ 
bufãr
 *
buf
, 
Ën
)

517  
	`buf_v®id
(
buf
è&& 
	`buf_size_v®id
(
Ën
)

518 && 
buf
->
off£t
 + buf->
Ën
 +†’ <ğbuf->
ÿ·c™y
;

519 
	}
}

521 
šlše
 
boŞ


522 
	$buf_§ã_bidœ
(cÚ¡ 
bufãr
 *
buf
, 
Ën
)

524 ià(
	`buf_v®id
(
buf
è&& 
	`buf_size_v®id_sigÃd
(
Ën
))

526 cÚ¡ 
ÃwËn
 = 
buf
->
Ën
 +†en;

527  
ÃwËn
 >ğ0 && 
buf
->
off£t
 +‚ewËÀ<ğbuf->
ÿ·c™y
;

531  
çl£
;

533 
	}
}

535 
šlše
 

536 
	$buf_fÜw¬d_ÿ·c™y
(cÚ¡ 
bufãr
 *
buf
)

538 ià(
	`buf_v®id
(
buf
))

540 
»t
 = 
buf
->
ÿ·c™y
 - (buf->
off£t
 + buf->
Ën
);

541 ià(
»t
 < 0)

543 
»t
 = 0;

545  
»t
;

551 
	}
}

553 
šlše
 

554 
	$buf_fÜw¬d_ÿ·c™y_tÙ®
(cÚ¡ 
bufãr
 *
buf
)

556 ià(
	`buf_v®id
(
buf
))

558 
»t
 = 
buf
->
ÿ·c™y
 - buf->
off£t
;

559 ià(
»t
 < 0)

561 
»t
 = 0;

563  
»t
;

569 
	}
}

571 
šlše
 

572 
	$buf_»v”£_ÿ·c™y
(cÚ¡ 
bufãr
 *
buf
)

574 ià(
	`buf_v®id
(
buf
))

576  
buf
->
off£t
;

582 
	}
}

584 
šlše
 
boŞ


585 
	$buf_šc_Ën
(
bufãr
 *
buf
, 
šc
)

587 ià(!
	`buf_§ã_bidœ
(
buf
, 
šc
))

589  
çl£
;

591 
buf
->
Ën
 +ğ
šc
;

592  
Œue
;

593 
	}
}

600 
šlše
 
ušt8_t
 *

601 
	$buf_´•’d
(
bufãr
 *
buf
, 
size
)

603 ià(!
	`buf_v®id
(
buf
è|| 
size
 < 0 || siz> buf->
off£t
)

605  
NULL
;

607 
buf
->
off£t
 -ğ
size
;

608 
buf
->
Ën
 +ğ
size
;

609  
	`BPTR
(
buf
);

610 
	}
}

612 
šlše
 
boŞ


613 
	$buf_advªû
(
bufãr
 *
buf
, 
size
)

615 ià(!
	`buf_v®id
(
buf
è|| 
size
 < 0 || buf->
Ën
 < size)

617  
çl£
;

619 
buf
->
off£t
 +ğ
size
;

620 
buf
->
Ën
 -ğ
size
;

621  
Œue
;

622 
	}
}

629 
šlše
 
ušt8_t
 *

630 
	$buf_wr™e_®loc
(
bufãr
 *
buf
, 
size
)

632 
ušt8_t
 *
»t
;

633 ià(!
	`buf_§ã
(
buf
, 
size
))

635  
NULL
;

637 
»t
 = 
	`BPTR
(
buf
è+ buf->
Ën
;

638 
buf
->
Ën
 +ğ
size
;

639  
»t
;

640 
	}
}

642 
šlše
 
ušt8_t
 *

643 
	$buf_wr™e_®loc_´•’d
(
bufãr
 *
buf
, 
size
, 
boŞ
 
´•’d
)

645  
´•’d
 ? 
	`buf_´•’d
(
buf
, 
size
è: 
	`buf_wr™e_®loc
(buf, size);

646 
	}
}

648 
šlše
 
ušt8_t
 *

649 
	$buf_»ad_®loc
(
bufãr
 *
buf
, 
size
)

651 
ušt8_t
 *
»t
;

652 ià(
size
 < 0 || 
buf
->
Ën
 < size)

654  
NULL
;

656 
»t
 = 
	`BPTR
(
buf
);

657 
buf
->
off£t
 +ğ
size
;

658 
buf
->
Ën
 -ğ
size
;

659  
»t
;

660 
	}
}

662 
šlše
 
boŞ


663 
	$buf_wr™e
(
bufãr
 *
de¡
, cÚ¡ *
¤c
, 
size
)

665 
ušt8_t
 *
ı
 = 
	`buf_wr™e_®loc
(
de¡
, 
size
);

666 ià(!
ı
)

668  
çl£
;

670 
	`memıy
(
ı
, 
¤c
, 
size
);

671  
Œue
;

672 
	}
}

674 
šlše
 
boŞ


675 
	$buf_wr™e_´•’d
(
bufãr
 *
de¡
, cÚ¡ *
¤c
, 
size
)

677 
ušt8_t
 *
ı
 = 
	`buf_´•’d
(
de¡
, 
size
);

678 ià(!
ı
)

680  
çl£
;

682 
	`memıy
(
ı
, 
¤c
, 
size
);

683  
Œue
;

684 
	}
}

686 
šlše
 
boŞ


687 
	$buf_wr™e_u8
(
bufãr
 *
de¡
, 
d©a
)

689 
ušt8_t
 
u8
 = (ušt8_tè
d©a
;

690  
	`buf_wr™e
(
de¡
, &
u8
, (
ušt8_t
));

691 
	}
}

693 
šlše
 
boŞ


694 
	$buf_wr™e_u16
(
bufãr
 *
de¡
, 
d©a
)

696 
ušt16_t
 
u16
 = 
	`htÚs
((ušt16_tè
d©a
);

697  
	`buf_wr™e
(
de¡
, &
u16
, (
ušt16_t
));

698 
	}
}

700 
šlše
 
boŞ


701 
	$buf_wr™e_u32
(
bufãr
 *
de¡
, 
d©a
)

703 
ušt32_t
 
u32
 = 
	`htÚl
((ušt32_tè
d©a
);

704  
	`buf_wr™e
(
de¡
, &
u32
, (
ušt32_t
));

705 
	}
}

707 
šlše
 
boŞ


708 
	$buf_cİy
(
bufãr
 *
de¡
, cÚ¡ bufã¸*
¤c
)

710  
	`buf_wr™e
(
de¡
, 
	`BPTR
(
¤c
), 
	`BLEN
(src));

711 
	}
}

713 
šlše
 
boŞ


714 
	$buf_cİy_n
(
bufãr
 *
de¡
, bufã¸*
¤c
, 
n
)

716 
ušt8_t
 *
ı
 = 
	`buf_»ad_®loc
(
¤c
, 
n
);

717 ià(!
ı
)

719  
çl£
;

721  
	`buf_wr™e
(
de¡
, 
ı
, 
n
);

722 
	}
}

724 
šlše
 
boŞ


725 
	$buf_cİy_¿nge
(
bufãr
 *
de¡
,

726 
de¡_šdex
,

727 cÚ¡ 
bufãr
 *
¤c
,

728 
¤c_šdex
,

729 
¤c_Ën
)

731 ià(
¤c_šdex
 < 0

732 || 
¤c_Ën
 < 0

733 || 
¤c_šdex
 + 
¤c_Ën
 > 
¤c
->
Ën


734 || 
de¡_šdex
 < 0

735 || 
de¡
->
off£t
 + 
de¡_šdex
 + 
¤c_Ën
 > de¡->
ÿ·c™y
)

737  
çl£
;

739 
	`memıy
(
de¡
->
d©a
 + de¡->
off£t
 + 
de¡_šdex
, 
¤c
->d©¨+ src->off£ˆ+ 
¤c_šdex
, 
¤c_Ën
);

740 ià(
de¡_šdex
 + 
¤c_Ën
 > 
de¡
->
Ën
)

742 
de¡
->
Ën
 = 
de¡_šdex
 + 
¤c_Ën
;

744  
Œue
;

745 
	}
}

748 
šlše
 
boŞ


749 
	$buf_cİy_exûss
(
bufãr
 *
de¡
,

750 
bufãr
 *
¤c
,

751 
Ën
)

753 ià(
Ën
 < 0)

755  
çl£
;

757 ià(
¤c
->
Ën
 >†en)

759 
bufãr
 
b
 = *
¤c
;

760 
¤c
->
Ën
 =†en;

761 ià(!
	`buf_advªû
(&
b
, 
Ën
))

763  
çl£
;

765  
	`buf_cİy
(
de¡
, &
b
);

769  
Œue
;

771 
	}
}

773 
šlše
 
boŞ


774 
	$buf_»ad
(
bufãr
 *
¤c
, *
de¡
, 
size
)

776 
ušt8_t
 *
ı
 = 
	`buf_»ad_®loc
(
¤c
, 
size
);

777 ià(!
ı
)

779  
çl£
;

781 
	`memıy
(
de¡
, 
ı
, 
size
);

782  
Œue
;

783 
	}
}

785 
šlše
 

786 
	$buf_»ad_u8
(
bufãr
 *
buf
)

788 
»t
;

789 ià(
	`BLEN
(
buf
) < 1)

793 
»t
 = *
	`BPTR
(
buf
);

794 
	`buf_advªû
(
buf
, 1);

795  
»t
;

796 
	}
}

798 
šlše
 

799 
	$buf_»ad_u16
(
bufãr
 *
buf
)

801 
ušt16_t
 
»t
;

802 ià(!
	`buf_»ad
(
buf
, &
»t
, (
ušt16_t
)))

806  
	`Áohs
(
»t
);

807 
	}
}

809 
šlše
 
ušt32_t


810 
	$buf_»ad_u32
(
bufãr
 *
buf
, 
boŞ
 *
good
)

812 
ušt32_t
 
»t
;

813 ià(!
	`buf_»ad
(
buf
, &
»t
, (
ušt32_t
)))

815 ià(
good
)

817 *
good
 = 
çl£
;

823 ià(
good
)

825 *
good
 = 
Œue
;

827  
	`Áohl
(
»t
);

829 
	}
}

835 
šlše
 
boŞ


836 
	$buf_¡ršg_m©ch
(cÚ¡ 
bufãr
 *
¤c
, cÚ¡ *
m©ch
, 
size
)

838 ià(
size
 !ğ
¤c
->
Ën
)

840  
çl£
;

842  
	`memcmp
(
	`BPTR
(
¤c
), 
m©ch
, 
size
) == 0;

843 
	}
}

849 
šlše
 
boŞ


850 
	$buf_¡ršg_m©ch_h—d
(cÚ¡ 
bufãr
 *
¤c
, cÚ¡ *
m©ch
, 
size
)

852 ià(
size
 < 0 || siz> 
¤c
->
Ën
)

854  
çl£
;

856  
	`memcmp
(
	`BPTR
(
¤c
), 
m©ch
, 
size
) == 0;

857 
	}
}

859 
boŞ
 
buf_¡ršg_m©ch_h—d_¡r
(cÚ¡ 
bufãr
 *
¤c
, cÚ¡ *
m©ch
);

861 
boŞ
 
buf_¡ršg_com·»_advªû
(
bufãr
 *
¤c
, cÚ¡ *
m©ch
);

863 
buf_sub¡ršg_Ën
(cÚ¡ 
bufãr
 *
buf
, 
d–im
);

868 cÚ¡ *
Å
(cÚ¡ *
¡r
);

874 
	#CC_ANY
 (1<<0)

	)

875 
	#CC_NULL
 (1<<1)

	)

877 
	#CC_ALNUM
 (1<<2)

	)

878 
	#CC_ALPHA
 (1<<3)

	)

879 
	#CC_ASCII
 (1<<4)

	)

880 
	#CC_CNTRL
 (1<<5)

	)

881 
	#CC_DIGIT
 (1<<6)

	)

882 
	#CC_PRINT
 (1<<7)

	)

883 
	#CC_PUNCT
 (1<<8)

	)

884 
	#CC_SPACE
 (1<<9)

	)

885 
	#CC_XDIGIT
 (1<<10)

	)

887 
	#CC_BLANK
 (1<<11)

	)

888 
	#CC_NEWLINE
 (1<<12)

	)

889 
	#CC_CR
 (1<<13)

	)

891 
	#CC_BACKSLASH
 (1<<14)

	)

892 
	#CC_UNDERBAR
 (1<<15)

	)

893 
	#CC_DASH
 (1<<16)

	)

894 
	#CC_DOT
 (1<<17)

	)

895 
	#CC_COMMA
 (1<<18)

	)

896 
	#CC_COLON
 (1<<19)

	)

897 
	#CC_SLASH
 (1<<20)

	)

898 
	#CC_SINGLE_QUOTE
 (1<<21)

	)

899 
	#CC_DOUBLE_QUOTE
 (1<<22)

	)

900 
	#CC_REVERSE_QUOTE
 (1<<23)

	)

901 
	#CC_AT
 (1<<24)

	)

902 
	#CC_EQUAL
 (1<<25)

	)

903 
	#CC_LESS_THAN
 (1<<26)

	)

904 
	#CC_GREATER_THAN
 (1<<27)

	)

905 
	#CC_PIPE
 (1<<28)

	)

906 
	#CC_QUESTION_MARK
 (1<<29)

	)

907 
	#CC_ASTERISK
 (1<<30)

	)

910 
	#CC_NAME
 (
CC_ALNUM
|
CC_UNDERBAR
)

	)

911 
	#CC_CRLF
 (
CC_CR
|
CC_NEWLINE
)

	)

913 
boŞ
 
ch¬_şass
(cÚ¡ 
c
, cÚ¡ 
æags
);

915 
boŞ
 
¡ršg_şass
(cÚ¡ *
¡r
, cÚ¡ 
šşusive
, cÚ¡ 
exşusive
);

917 
boŞ
 
¡ršg_mod
(*
¡r
, cÚ¡ 
šşusive
, cÚ¡ 
exşusive
, cÚ¡ 
»¶aû
);

919 cÚ¡ *
¡ršg_mod_cÚ¡
(cÚ¡ *
¡r
,

920 cÚ¡ 
šşusive
,

921 cÚ¡ 
exşusive
,

922 cÚ¡ 
»¶aû
,

923 
gc_¬’a
 *
gc
);

925 
¡ršg_»¶aû_Ëadšg
(*
¡r
, cÚ¡ 
m©ch
, cÚ¡ 
»¶aû
);

928 
šlše
 
boŞ


929 
	$¡½»fix
(cÚ¡ *
¡r
, cÚ¡ *
´efix
)

931  0 =ğ
	`¡ºcmp
(
¡r
, 
´efix
, 
	`¡¾’
(prefix));

932 
	}
}

935 #ifdeà
CHARACTER_CLASS_DEBUG


936 
ch¬aù”_şass_debug
();

943 #ifdeà
VERIFY_ALIGNMENT


944 
v®ign4
(cÚ¡ 
bufãr
 *
buf
, cÚ¡ *
fe
, cÚ¡ 
lše
);

946 
	#v”ify_®ign_4
(
±r
è
	`v®ign4
(
buf
, 
__FILE__
, 
__LINE__
)

	)

948 
	#v”ify_®ign_4
(
±r
)

	)

956 
gc_Œªsãr
(
gc_¬’a
 *
de¡
, gc_¬’¨*
¤c
);

958 
x_gc_ä“
(
gc_¬’a
 *
a
);

960 
x_gc_ä“¥ecŸl
(
gc_¬’a
 *
a
);

962 
šlše
 
boŞ


963 
	$gc_defšed
(
gc_¬’a
 *
a
)

965  
a
->
li¡
 !ğ
NULL
;

966 
	}
}

968 
šlše
 

969 
	$gc_š™
(
gc_¬’a
 *
a
)

971 
a
->
li¡
 = 
NULL
;

972 
a
->
li¡_¥ecŸl
 = 
NULL
;

973 
	}
}

975 
šlše
 

976 
	$gc_d‘ach
(
gc_¬’a
 *
a
)

978 
	`gc_š™
(
a
);

979 
	}
}

981 
šlše
 
gc_¬’a


982 
	$gc_Ãw
()

984 
gc_¬’a
 
»t
;

985 
	`gc_š™
(&
»t
);

986  
»t
;

987 
	}
}

989 
šlše
 

990 
	$gc_ä“
(
gc_¬’a
 *
a
)

992 ià(
a
->
li¡
)

994 
	`x_gc_ä“
(
a
);

996 ià(
a
->
li¡_¥ecŸl
)

998 
	`x_gc_ä“¥ecŸl
(
a
);

1000 
	}
}

1002 
šlše
 

1003 
	$gc_»£t
(
gc_¬’a
 *
a
)

1005 
	`gc_ä“
(
a
);

1006 
	}
}

1012 
	#ALLOC_OBJ
(
d±r
, 
ty³
) \

1014 
	`check_m®loc_»tuº
((
d±r
èğ(
ty³
 *è
	`m®loc
((type))); \

1015 }

	)

1017 
	#ALLOC_OBJ_CLEAR
(
d±r
, 
ty³
) \

1019 
	`ALLOC_OBJ
(
d±r
, 
ty³
); \

1020 
	`mem£t
((
d±r
), 0, (
ty³
)); \

1021 }

	)

1023 
	#ALLOC_ARRAY
(
d±r
, 
ty³
, 
n
) \

1025 
	`check_m®loc_»tuº
((
d±r
èğ(
ty³
 *è
	`m®loc
(
	`¬¿y_muÉ_§ã
(Ñy³), (
n
), 0))); \

1026 }

	)

1028 
	#ALLOC_ARRAY_GC
(
d±r
, 
ty³
, 
n
, 
gc
) \

1030 (
d±r
èğ(
ty³
 *è
	`gc_m®loc
(
	`¬¿y_muÉ_§ã
(Ñy³), (
n
), 0), 
çl£
, (
gc
)); \

1031 }

	)

1033 
	#ALLOC_ARRAY_CLEAR
(
d±r
, 
ty³
, 
n
) \

1035 
	`ALLOC_ARRAY
(
d±r
, 
ty³
, 
n
); \

1036 
	`mem£t
((
d±r
), 0, (
	`¬¿y_muÉ_§ã
((
ty³
), (
n
), 0))); \

1037 }

	)

1039 
	#ALLOC_ARRAY_CLEAR_GC
(
d±r
, 
ty³
, 
n
, 
gc
) \

1041 (
d±r
èğ(
ty³
 *è
	`gc_m®loc
(
	`¬¿y_muÉ_§ã
(Ñy³), (
n
), 0), 
Œue
, (
gc
)); \

1042 }

	)

1044 
	#ALLOC_VAR_ARRAY_CLEAR_GC
(
d±r
, 
ty³
, 
©y³
, 
n
, 
gc
) \

1046 (
d±r
èğ(
ty³
 *è
	`gc_m®loc
(
	`¬¿y_muÉ_§ã
((
©y³
), (
n
), Ñy³)), 
Œue
, (
gc
)); \

1047 }

	)

1049 
	#ALLOC_OBJ_GC
(
d±r
, 
ty³
, 
gc
) \

1051 (
d±r
èğ(
ty³
 *è
	`gc_m®loc
(Ñy³), 
çl£
, (
gc
)); \

1052 }

	)

1054 
	#ALLOC_OBJ_CLEAR_GC
(
d±r
, 
ty³
, 
gc
) \

1056 (
d±r
èğ(
ty³
 *è
	`gc_m®loc
(Ñy³), 
Œue
, (
gc
)); \

1057 }

	)

1059 
šlše
 

1060 
	$check_m®loc_»tuº
(cÚ¡ *
p
)

1062 ià(!
p
)

1064 
	`out_of_memÜy
();

1066 
	}
}

1071 
	sbufãr_’Œy


1073 
bufãr
 
	mbuf
;

1074 
bufãr_’Œy
 *
	mÃxt
;

1077 
	sbufãr_li¡


1079 
bufãr_’Œy
 *
	mh—d
;

1080 
bufãr_’Œy
 *
	m
;

1081 
	msize
;

1082 
	mmax_size
;

1092 
bufãr_li¡
 *
bufãr_li¡_Ãw
(cÚ¡ 
max_size
);

1099 
bufãr_li¡_ä“
(
bufãr_li¡
 *
Ş
);

1108 
boŞ
 
bufãr_li¡_defšed
(cÚ¡ 
bufãr_li¡
 *
Ş
);

1115 
bufãr_li¡_»£t
(
bufãr_li¡
 *
Ş
);

1123 
bufãr_li¡_push
(
bufãr_li¡
 *
Ş
, cÚ¡ *
¡r
);

1134 
bufãr_’Œy
 *
bufãr_li¡_push_d©a
(
bufãr_li¡
 *
Ş
, cÚ¡ *
d©a
, 
size_t
 
size
);

1143 
bufãr
 *
bufãr_li¡_³ek
(
bufãr_li¡
 *
Ş
);

1145 
bufãr_li¡_advªû
(
bufãr_li¡
 *
Ş
, 
n
);

1147 
bufãr_li¡_pİ
(
bufãr_li¡
 *
Ş
);

1158 
bufãr_li¡_agg»g©e
(
bufãr_li¡
 *
bl
, cÚ¡ 
size_t
 
max
);

1172 
bufãr_li¡_agg»g©e_£·¿tÜ
(
bufãr_li¡
 *
bl
,

1173 cÚ¡ 
size_t
 
max_Ën
, cÚ¡ *
£p
);

1175 
bufãr_li¡
 *
bufãr_li¡_fe
(cÚ¡ *
â
, 
max_lše_Ën
);

	@circ_list.h

24 #iâdeà
CIRC_LIST_H


25 
	#CIRC_LIST_H


	)

27 
	~"basic.h
"

28 
	~"š‹g”.h
"

29 
	~"”rÜ.h
"

31 
	#CIRC_LIST
(
Çme
, 
ty³
) \

32 
	sÇme
 { \

33 
x_h—d
; \

34 
x_size
; \

35 
x_ÿp
; \

36 
x_sizeof
; \

37 
ty³
 
x_li¡
[
EMPTY_ARRAY_SIZE
]; \

38 }

	)

40 
	#CIRC_LIST_PUSH
(
obj
, 
™em
) \

42 (
obj
)->
x_h—d
 = 
	`modulo_add
((obj)->x_h—d, -1, (obj)->
x_ÿp
); \

43 (
obj
)->
x_li¡
[(obj)->
x_h—d
] = (
™em
); \

44 (
obj
)->
x_size
 = 
	`mš_št
((obj)->x_siz+ 1, (obj)->
x_ÿp
); \

45 }

	)

47 
	#CIRC_LIST_SIZE
(
obj
) \

48 ((
obj
)->
x_size
)

	)

50 
	#CIRC_LIST_INDEX
(
obj
, 
šdex
) \

51 
	`modulo_add
((
obj
)->
x_h—d
, \

52 
	`šdex_v”ify
((
šdex
), (
obj
)->
x_size
, 
__FILE__
, 
__LINE__
), \

53 (
obj
)->
x_ÿp
)

	)

55 
	#CIRC_LIST_ITEM
(
obj
, 
šdex
) \

56 ((
obj
)->
x_li¡
[
	`CIRC_LIST_INDEX
((obj), (
šdex
))])

	)

58 
	#CIRC_LIST_RESET
(
obj
) \

60 (
obj
)->
x_h—d
 = 0; \

61 (
obj
)->
x_size
 = 0; \

62 }

	)

64 
	#CIRC_LIST_ALLOC
(
de¡
, 
li¡_ty³
, 
size
) \

66 cÚ¡ 
so
 = (
li¡_ty³
è+ ((
de¡
)->
x_li¡
[0]è* (
size
); \

67 (
de¡
èğ(
li¡_ty³
 *è
	`m®loc
(
so
); \

68 
	`check_m®loc_»tuº
(
de¡
); \

69 
	`mem£t
((
de¡
), 0, 
so
); \

70 (
de¡
)->
x_ÿp
 = 
size
; \

71 (
de¡
)->
x_sizeof
 = 
so
; \

72 }

	)

74 
	#CIRC_LIST_FREE
(
de¡
) \

75 
	`ä“
(
de¡
)

	)

	@clinat.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"şš©.h
"

33 
	~"´Ùo.h
"

34 
	~"sock‘.h
"

35 
	~"memdbg.h
"

37 
boŞ


38 
	$add_’Œy
(
ş›Á_Çt_İtiÚ_li¡
 *
de¡
,

39 cÚ¡ 
ş›Á_Çt_’Œy
 *
e
)

41 ià(
de¡
->
n
 >ğ
MAX_CLIENT_NAT
)

43 
	`msg
(
M_WARN
, "WARNING: cl›Á-ÇˆbË ov”æow (max %dƒÁr›s)", 
MAX_CLIENT_NAT
);

44  
çl£
;

48 
de¡
->
’Œ›s
[de¡->
n
++] = *
e
;

49  
Œue
;

51 
	}
}

54 
	$´št_ş›Á_Çt_li¡
(cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
li¡
, 
msgËv–
)

56 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

57 
i
;

59 
	`msg
(
msgËv–
, "*** CNAT†ist");

60 ià(
li¡
)

62 
i
 = 0; i < 
li¡
->
n
; ++i)

64 cÚ¡ 
ş›Á_Çt_’Œy
 *
e
 = &
li¡
->
’Œ›s
[
i
];

65 
	`msg
(
msgËv–
, " CNAT[%d]=%d %s/%s/%s",

66 
i
,

67 
e
->
ty³
,

68 
	`´št_š_addr_t
(
e
->
ÃtwÜk
, 
IA_NET_ORDER
, &
gc
),

69 
	`´št_š_addr_t
(
e
->
Ãtmask
, 
IA_NET_ORDER
, &
gc
),

70 
	`´št_š_addr_t
(
e
->
fÜeign_ÃtwÜk
, 
IA_NET_ORDER
, &
gc
));

73 
	`gc_ä“
(&
gc
);

74 
	}
}

76 
ş›Á_Çt_İtiÚ_li¡
 *

77 
	$Ãw_ş›Á_Çt_li¡
(
gc_¬’a
 *
gc
)

79 
ş›Á_Çt_İtiÚ_li¡
 *
»t
;

80 
	`ALLOC_OBJ_CLEAR_GC
(
»t
, 
ş›Á_Çt_İtiÚ_li¡
, 
gc
);

81  
»t
;

82 
	}
}

84 
ş›Á_Çt_İtiÚ_li¡
 *

85 
	$şÚe_ş›Á_Çt_İtiÚ_li¡
(cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
¤c
, 
gc_¬’a
 *
gc
)

87 
ş›Á_Çt_İtiÚ_li¡
 *
»t
;

88 
	`ALLOC_OBJ_GC
(
»t
, 
ş›Á_Çt_İtiÚ_li¡
, 
gc
);

89 *
»t
 = *
¤c
;

90  
»t
;

91 
	}
}

94 
	$cİy_ş›Á_Çt_İtiÚ_li¡
(
ş›Á_Çt_İtiÚ_li¡
 *
de¡
,

95 cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
¤c
)

97 
i
;

98 
i
 = 0; i < 
¤c
->
n
; ++i)

100 ià(!
	`add_’Œy
(
de¡
, &
¤c
->
’Œ›s
[
i
]))

105 
	}
}

108 
	$add_ş›Á_Çt_to_İtiÚ_li¡
(
ş›Á_Çt_İtiÚ_li¡
 *
de¡
,

109 cÚ¡ *
ty³
,

110 cÚ¡ *
ÃtwÜk
,

111 cÚ¡ *
Ãtmask
,

112 cÚ¡ *
fÜeign_ÃtwÜk
,

113 
msgËv–
)

115 
ş›Á_Çt_’Œy
 
e
;

116 
boŞ
 
ok
;

118 ià(!
	`¡rcmp
(
ty³
, "snat"))

120 
e
.
ty³
 = 
CN_SNAT
;

122 ià(!
	`¡rcmp
(
ty³
, "dnat"))

124 
e
.
ty³
 = 
CN_DNAT
;

128 
	`msg
(
msgËv–
, "client-nat:ype must be 'snat' or 'dnat'");

132 
e
.
ÃtwÜk
 = 
	`g‘addr
(0,‚‘wÜk, 0, &
ok
, 
NULL
);

133 ià(!
ok
)

135 
	`msg
(
msgËv–
, "ş›Á-Çt: bad‚‘wÜk: %s", 
ÃtwÜk
);

138 
e
.
Ãtmask
 = 
	`g‘addr
(0,‚‘mask, 0, &
ok
, 
NULL
);

139 ià(!
ok
)

141 
	`msg
(
msgËv–
, "ş›Á-Çt: bad‚‘mask: %s", 
Ãtmask
);

144 
e
.
fÜeign_ÃtwÜk
 = 
	`g‘addr
(0, fÜeign_ÃtwÜk, 0, &
ok
, 
NULL
);

145 ià(!
ok
)

147 
	`msg
(
msgËv–
, "ş›Á-Çt: bad fÜeigÀÃtwÜk: %s", 
fÜeign_ÃtwÜk
);

151 
	`add_’Œy
(
de¡
, &
e
);

152 
	}
}

156 
	$´št_checksum
(
İ’v²_hdr
 *
h
, cÚ¡ *
´efix
)

158 
ušt16_t
 *
¥Œ
;

159 
sum
 = 0;

160 
i
 = 0;

161 
¥Œ
 = (
ušt16_t
 *)
h
; (
ušt8_t
 *)¥Œ < (ušt8_ˆ*)h + (
İ’v²_hdr
); sptr++)

163 
i
 += 1;

164 
sum
 +ğ*
¥Œ
;

166 
	`msg
(
M_INFO
, "** CKSUM[%d] % %08x", 
i
, 
´efix
, 
sum
);

167 
	}
}

171 
	$´št_pkt
(
İ’v²_hdr
 *
h
, cÚ¡ *
´efix
, cÚ¡ 
dœeùiÚ
, cÚ¡ 
msgËv–
)

173 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

175 *
dœ¡r
 = "???";

176 ià(
dœeùiÚ
 =ğ
CN_OUTGOING
)

178 
dœ¡r
 = "OUT";

180 ià(
dœeùiÚ
 =ğ
CN_INCOMING
)

182 
dœ¡r
 = "IN";

185 
	`msg
(
msgËv–
, "** CNAT %s %s %s -> %s",

186 
dœ¡r
,

187 
´efix
,

188 
	`´št_š_addr_t
(
h
->
§ddr
, 
IA_NET_ORDER
, &
gc
),

189 
	`´št_š_addr_t
(
h
->
daddr
, 
IA_NET_ORDER
, &
gc
));

191 
	`gc_ä“
(&
gc
);

192 
	}
}

195 
	$ş›Á_Çt_ŒªsfÜm
(cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
li¡
,

196 
bufãr
 *
buf
,

197 cÚ¡ 
dœeùiÚ
)

199 
_tı_udp_hdr
 *
h
 = (_tı_udp_hd¸*è
	`BPTR
(
buf
);

200 
i
;

201 
ušt32_t
 
addr
, *
addr_±r
;

202 cÚ¡ 
ušt32_t
 *
äom
, *
to
;

203 
accumuÏ‹
 = 0;

204 
amask
;

205 
®og
 = 0;

207 ià(
	`check_debug_Ëv–
(
D_CLIENT_NAT
))

209 
	`´št_pkt
(&
h
->

, "BEFORE", 
dœeùiÚ
, 
D_CLIENT_NAT
);

212 
i
 = 0; i < 
li¡
->
n
; ++i)

214 cÚ¡ 
ş›Á_Çt_’Œy
 *
e
 = &
li¡
->
’Œ›s
[
i
];

215 ià(
e
->
ty³
 ^ 
dœeùiÚ
)

217 
addr
 = *(
addr_±r
 = &
h
->

.
daddr
);

218 
amask
 = 2;

222 
addr
 = *(
addr_±r
 = &
h
->

.
§ddr
);

223 
amask
 = 1;

225 ià(
dœeùiÚ
)

227 
äom
 = &
e
->
fÜeign_ÃtwÜk
;

228 
to
 = &
e
->
ÃtwÜk
;

232 
äom
 = &
e
->
ÃtwÜk
;

233 
to
 = &
e
->
fÜeign_ÃtwÜk
;

236 ià(((
addr
 & 
e
->
Ãtmask
è=ğ*
äom
è&& !(
amask
 & 
®og
))

239 
	`ADD_CHECKSUM_32
(
accumuÏ‹
, 
addr
);

242 
addr
 = (add¸& ~
e
->
Ãtmask
è| *
to
;

245 
	`SUB_CHECKSUM_32
(
accumuÏ‹
, 
addr
);

248 *
addr_±r
 = 
addr
;

251 
®og
 |ğ
amask
;

254 ià(
®og
)

256 ià(
	`check_debug_Ëv–
(
D_CLIENT_NAT
))

258 
	`´št_pkt
(&
h
->

, "AFTER", 
dœeùiÚ
, 
D_CLIENT_NAT
);

261 
	`ADJUST_CHECKSUM
(
accumuÏ‹
, 
h
->

.
check
);

263 ià(
h
->

.
´ÙocŞ
 =ğ
OPENVPN_IPPROTO_TCP
)

265 ià(
	`BLEN
(
buf
è>ğ(
İ’v²_hdr
è+ (
İ’v²_tıhdr
))

267 
	`ADJUST_CHECKSUM
(
accumuÏ‹
, 
h
->
u
.
tı
.
check
);

270 ià(
h
->

.
´ÙocŞ
 =ğ
OPENVPN_IPPROTO_UDP
)

272 ià(
	`BLEN
(
buf
è>ğ(
İ’v²_hdr
è+ (
İ’v²_udphdr
))

274 
	`ADJUST_CHECKSUM
(
accumuÏ‹
, 
h
->
u
.
udp
.
check
);

278 
	}
}

	@clinat.h

24 #ià!
defšed
(
CLINAT_H
)

25 
	#CLINAT_H


	)

27 
	~"bufãr.h
"

29 
	#MAX_CLIENT_NAT
 64

	)

31 
	#CN_OUTGOING
 0

	)

32 
	#CN_INCOMING
 1

	)

34 
	sş›Á_Çt_’Œy
 {

35 
	#CN_SNAT
 0

	)

36 
	#CN_DNAT
 1

	)

37 
	mty³
;

38 
š_addr_t
 
	mÃtwÜk
;

39 
š_addr_t
 
	mÃtmask
;

40 
š_addr_t
 
	mfÜeign_ÃtwÜk
;

43 
	sş›Á_Çt_İtiÚ_li¡
 {

44 
	mn
;

45 
ş›Á_Çt_’Œy
 
	m’Œ›s
[
MAX_CLIENT_NAT
];

48 
ş›Á_Çt_İtiÚ_li¡
 *
Ãw_ş›Á_Çt_li¡
(
gc_¬’a
 *
gc
);

50 
ş›Á_Çt_İtiÚ_li¡
 *
şÚe_ş›Á_Çt_İtiÚ_li¡
(cÚ¡ ş›Á_Çt_İtiÚ_li¡ *
¤c
, 
gc_¬’a
 *
gc
);

52 
cİy_ş›Á_Çt_İtiÚ_li¡
(
ş›Á_Çt_İtiÚ_li¡
 *
de¡
, cÚ¡ ş›Á_Çt_İtiÚ_li¡ *
¤c
);

54 
´št_ş›Á_Çt_li¡
(cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
li¡
, 
msgËv–
);

56 
add_ş›Á_Çt_to_İtiÚ_li¡
(
ş›Á_Çt_İtiÚ_li¡
 *
de¡
,

57 cÚ¡ *
ty³
,

58 cÚ¡ *
ÃtwÜk
,

59 cÚ¡ *
Ãtmask
,

60 cÚ¡ *
fÜeign_ÃtwÜk
,

61 
msgËv–
);

63 
ş›Á_Çt_ŒªsfÜm
(cÚ¡ 
ş›Á_Çt_İtiÚ_li¡
 *
li¡
,

64 
bufãr
 *
buf
,

65 cÚ¡ 
dœeùiÚ
);

	@common.h

24 #iâdeà
COMMON_H


25 
	#COMMON_H


	)

30 #ifdeà
USE_64_BIT_COUNTERS


31 
	tcouÁ”_ty³
;

32 #ifdeà
_WIN32


33 
	#couÁ”_fÜm©
 "%I64u"

	)

35 
	#couÁ”_fÜm©
 "%Îu"

	)

38 
	tcouÁ”_ty³
;

39 
	#couÁ”_fÜm©
 "%u"

	)

45 
	tš‹rv®_t
;

50 
	#BIG_TIMEOUT
 (60*60*24*7è

	)

55 #ifdeà
_WIN64


56 
	#±r_fÜm©
 "0x%I64x"

	)

58 
	#±r_fÜm©
 "0x%08lx"

	)

60 
	#time_fÜm©
 "%lu"

	)

61 
	#äagm’t_h—d”_fÜm©
 "0x%08x"

	)

65 
	ttime_ty³
;

66 #ifdeà
_WIN64


67 
	t±r_ty³
;

69 
	t±r_ty³
;

73 
	#CCD_DEFAULT
 "DEFAULT"

	)

80 
	#TLS_CHANNEL_BUF_SIZE
 2048

	)

86 
	#PUSH_BUNDLE_SIZE
 1024

	)

91 
	#PUSH_REQUEST_INTERVAL
 5

	)

97 
	#INLINE_FILE_TAG
 "[[INLINE]]"

	)

102 
	#SCRIPT_SECURITY_WARNING
 "WARNING: Ex‹º®…rog¿m may‚Ù bÿÎed uÆes '--süt-£cur™y 2' o¸high” i ’abËd. S“ --h–°‹xˆÜ mª…agfÜ d‘aed info."

	)

	@comp-lz4.c

25 #ifdeà
HAVE_CONFIG_H


26 
	~"cÚfig.h
"

27 #–ià
defšed
(
_MSC_VER
)

28 
	~"cÚfig-msvc.h
"

31 
	~"sysh—d.h
"

33 #ià
defšed
(
ENABLE_LZ4
)

35 #ià
defšed
(
NEED_COMPAT_LZ4
)

36 
	~"com·t-lz4.h
"

38 
	~"lz4.h
"

41 
	~"comp.h
"

42 
	~"”rÜ.h
"

44 
	~"memdbg.h
"

48 
	$lz4_com´ess_š™
(
com´ess_cÚ‹xt
 *
compùx
)

50 
	`msg
(
D_INIT_MEDIUM
, "LZ4 compression initializing");

51 
	`ASSERT
(
compùx
->
æags
 & 
COMP_F_SWAP
);

52 
	}
}

55 
	$lz4v2_com´ess_š™
(
com´ess_cÚ‹xt
 *
compùx
)

57 
	`msg
(
D_INIT_MEDIUM
, "LZ4v2 compression initializing");

58 
	}
}

61 
	$lz4_com´ess_unš™
(
com´ess_cÚ‹xt
 *
compùx
)

63 
	}
}

65 
boŞ


66 
	$do_lz4_com´ess
(
bufãr
 *
buf
,

67 
bufãr
 *
wÜk
,

68 
com´ess_cÚ‹xt
 *
compùx
,

69 cÚ¡ 
äame
 *frame)

74 ià(
buf
->
Ën
 >ğ
COMPRESS_THRESHOLD
)

76 cÚ¡ 
size_t
 
ps
 = 
	`PAYLOAD_SIZE
(
äame
);

77 
zËn_max
 = 
ps
 + 
	`COMP_EXTRA_BUFFER
(ps);

78 
zËn
;

80 
	`ASSERT
(
	`buf_š™
(
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

81 
	`ASSERT
(
	`buf_§ã
(
wÜk
, 
zËn_max
));

83 ià(
buf
->
Ën
 > 
ps
)

85 
	`dmsg
(
D_COMP_ERRORS
, "LZ4 compression buffer overflow");

86 
buf
->
Ën
 = 0;

87  
çl£
;

90 
zËn
 = 
	`LZ4_com´ess_deçuÉ
((cÚ¡ *)
	`BPTR
(
buf
), (*)BPTR(
wÜk
), 
	`BLEN
(buf), 
zËn_max
);

92 ià(
zËn
 <= 0)

94 
	`dmsg
(
D_COMP_ERRORS
, "LZ4 compressionƒrror");

95 
buf
->
Ën
 = 0;

96  
çl£
;

99 
	`ASSERT
(
	`buf_§ã
(
wÜk
, 
zËn
));

100 
wÜk
->
Ën
 = 
zËn
;

103 
	`dmsg
(
D_COMP
, "LZ4 com´es %d -> %d", 
buf
->
Ën
, 
wÜk
->len);

104 
compùx
->
´e_com´ess
 +ğ
buf
->
Ën
;

105 
compùx
->
po¡_com´ess
 +ğ
wÜk
->
Ën
;

106  
Œue
;

108  
çl£
;

109 
	}
}

113 
	$lz4_com´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

114 
com´ess_cÚ‹xt
 *
compùx
,

115 cÚ¡ 
äame
 *frame)

117 
boŞ
 
com´es£d
;

118 ià(
buf
->
Ën
 <= 0)

123 
com´es£d
 = 
	`do_lz4_com´ess
(
buf
, &
wÜk
, 
compùx
, 
äame
);

126 ià(
buf
->
Ën
 == 0)

133 
ušt8_t
 
comp_h—d_by‹
 = 
NO_COMPRESS_BYTE_SWAP
;

134 ià(
com´es£d
 && 
wÜk
.
Ën
 < 
buf
->len)

136 *
buf
 = 
wÜk
;

137 
comp_h—d_by‹
 = 
LZ4_COMPRESS_BYTE
;

141 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

142 
ušt8_t
 *

 = 
	`BEND
(
buf
);

143 
	`ASSERT
(
	`buf_§ã
(
buf
, 1));

144 ++
buf
->
Ën
;

147 *

 = *
h—d
;

148 *
h—d
 = 
comp_h—d_by‹
;

151 
	}
}

155 
	$lz4v2_com´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

156 
com´ess_cÚ‹xt
 *
compùx
,

157 cÚ¡ 
äame
 *frame)

159 
boŞ
 
com´es£d
;

160 ià(
buf
->
Ën
 <= 0)

165 
com´es£d
 = 
	`do_lz4_com´ess
(
buf
, &
wÜk
, 
compùx
, 
äame
);

168 ià(
buf
->
Ën
 == 0)

175 ià(
com´es£d
 && 
wÜk
.
Ën
 + 2 < 
buf
->len)

177 
	`ASSERT
(
	`buf_´•’d
(&
wÜk
, 2));

178 
ušt8_t
 *
h—d
 = 
	`BPTR
(&
wÜk
);

179 
h—d
[0] = 
COMP_ALGV2_INDICATOR_BYTE
;

180 
h—d
[1] = 
COMP_ALGV2_LZ4_BYTE
;

181 *
buf
 = 
wÜk
;

185 
	`compv2_esÿ³_d©a_iâ“ded
(
buf
);

187 
	}
}

190 
	$do_lz4_decom´ess
(
size_t
 
zËn_max
,

191 
bufãr
 *
wÜk
,

192 
bufãr
 *
buf
,

193 
com´ess_cÚ‹xt
 *
compùx
)

195 
uncomp_Ën
;

196 
	`ASSERT
(
	`buf_§ã
(
wÜk
, 
zËn_max
));

197 
uncomp_Ën
 = 
	`LZ4_decom´ess_§ã
((cÚ¡ *)
	`BPTR
(
buf
), (*)BPTR(
wÜk
), (
size_t
)
	`BLEN
(buf), 
zËn_max
);

198 ià(
uncomp_Ën
 <= 0)

200 
	`dmsg
(
D_COMP_ERRORS
, "LZ4 decom´essiÚƒ¼Ü: %d", 
uncomp_Ën
);

201 
buf
->
Ën
 = 0;

205 
	`ASSERT
(
	`buf_§ã
(
wÜk
, 
uncomp_Ën
));

206 
wÜk
->
Ën
 = 
uncomp_Ën
;

208 
	`dmsg
(
D_COMP
, "LZ4 decom´es %d -> %d", 
buf
->
Ën
, 
wÜk
->len);

209 
compùx
->
´e_decom´ess
 +ğ
buf
->
Ën
;

210 
compùx
->
po¡_decom´ess
 +ğ
wÜk
->
Ën
;

212 *
buf
 = *
wÜk
;

213 
	}
}

216 
	$lz4_decom´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

217 
com´ess_cÚ‹xt
 *
compùx
,

218 cÚ¡ 
äame
 *frame)

220 
size_t
 
zËn_max
 = 
	`EXPANDED_SIZE
(
äame
);

221 
ušt8_t
 
c
;

223 ià(
buf
->
Ën
 <= 0)

228 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

232 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

233 
c
 = *
h—d
;

234 --
buf
->
Ën
;

235 *
h—d
 = *
	`BEND
(
buf
);

238 ià(
c
 =ğ
LZ4_COMPRESS_BYTE
)

240 
	`do_lz4_decom´ess
(
zËn_max
, &
wÜk
, 
buf
, 
compùx
);

242 ià(
c
 =ğ
NO_COMPRESS_BYTE_SWAP
)

247 
	`dmsg
(
D_COMP_ERRORS
, "Bad LZ4 decom´essiÚ h—d” by‹: %d", 
c
);

248 
buf
->
Ën
 = 0;

250 
	}
}

253 
	$lz4v2_decom´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

254 
com´ess_cÚ‹xt
 *
compùx
,

255 cÚ¡ 
äame
 *frame)

257 
size_t
 
zËn_max
 = 
	`EXPANDED_SIZE
(
äame
);

258 
ušt8_t
 
c
;

260 ià(
buf
->
Ën
 <= 0)

265 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

268 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

269 
c
 = *
h—d
;

272 ià(
c
 !ğ
COMP_ALGV2_INDICATOR_BYTE
)

278 ià(
buf
->
Ën
 <= 1)

280 
buf
->
Ën
 = 0;

284 
c
 = 
h—d
[1];

285 ià(
c
 =ğ
COMP_ALGV2_LZ4_BYTE
)

287 
	`buf_advªû
(
buf
,2);

288 
	`do_lz4_decom´ess
(
zËn_max
, &
wÜk
, 
buf
, 
compùx
);

290 ià(
c
 =ğ
COMP_ALGV2_UNCOMPRESSED_BYTE
)

292 
	`buf_advªû
(
buf
,2);

296 
	`dmsg
(
D_COMP_ERRORS
, "Bad LZ4v2 decom´essiÚ h—d” by‹: %d", 
c
);

297 
buf
->
Ën
 = 0;

299 
	}
}

301 cÚ¡ 
com´ess_®g
 
	glz4_®g
 = {

303 
lz4_com´ess_š™
,

304 
lz4_com´ess_unš™
,

305 
lz4_com´ess
,

306 
lz4_decom´ess


309 cÚ¡ 
com´ess_®g
 
	glz4v2_®g
 = {

311 
lz4v2_com´ess_š™
,

312 
lz4_com´ess_unš™
,

313 
lz4v2_com´ess
,

314 
lz4v2_decom´ess


319 
	$dummy
()

321 
	}
}

	@comp-lz4.h

25 #iâdeà
OPENVPN_COMP_LZ4_H


26 
	#OPENVPN_COMP_LZ4_H


	)

28 #ià
defšed
(
ENABLE_LZ4
)

30 
	~"bufãr.h
"

32 cÚ¡ 
com´ess_®g
 
lz4_®g
;

33 cÚ¡ 
com´ess_®g
 
lz4v2_®g
;

35 
	slz4_wÜk¥aû


37 
	mdummy
;

	@comp.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
USE_COMP


34 
	~"comp.h
"

35 
	~"”rÜ.h
"

36 
	~"Ùime.h
"

38 
	~"memdbg.h
"

40 
com´ess_cÚ‹xt
 *

41 
	$comp_š™
(cÚ¡ 
com´ess_İtiÚs
 *
İt
)

43 
com´ess_cÚ‹xt
 *
compùx
 = 
NULL
;

44 
İt
->
®g
)

46 
COMP_ALG_STUB
:

47 
	`ALLOC_OBJ_CLEAR
(
compùx
, 
com´ess_cÚ‹xt
);

48 
compùx
->
æags
 = 
İt
->flags;

49 
compùx
->
®g
 = 
comp_¡ub_®g
;

52 
COMP_ALGV2_UNCOMPRESSED
:

53 
	`ALLOC_OBJ_CLEAR
(
compùx
, 
com´ess_cÚ‹xt
);

54 
compùx
->
æags
 = 
İt
->flags;

55 
compùx
->
®g
 = 
compv2_¡ub_®g
;

58 #ifdeà
ENABLE_LZO


59 
COMP_ALG_LZO
:

60 
	`ALLOC_OBJ_CLEAR
(
compùx
, 
com´ess_cÚ‹xt
);

61 
compùx
->
æags
 = 
İt
->flags;

62 
compùx
->
®g
 = 
lzo_®g
;

66 #ifdeà
ENABLE_LZ4


67 
COMP_ALG_LZ4
:

68 
	`ALLOC_OBJ_CLEAR
(
compùx
, 
com´ess_cÚ‹xt
);

69 
compùx
->
æags
 = 
İt
->flags;

70 
compùx
->
®g
 = 
lz4_®g
;

73 
COMP_ALGV2_LZ4
:

74 
	`ALLOC_OBJ_CLEAR
(
compùx
, 
com´ess_cÚ‹xt
);

75 
compùx
->
æags
 = 
İt
->flags;

76 
compùx
->
®g
 = 
lz4v2_®g
;

80 ià(
compùx
)

82 (*
compùx
->
®g
.
com´ess_š™
)(compctx);

85  
compùx
;

86 
	}
}

92 
	$compv2_esÿ³_d©a_iâ“ded
(
bufãr
 *
buf
)

94 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

95 ià(
h—d
[0] !ğ
COMP_ALGV2_INDICATOR_BYTE
)

101 
	`ASSERT
(
	`buf_´•’d
(
buf
, 2));

103 
h—d
 = 
	`BPTR
(
buf
);

104 
h—d
[0] = 
COMP_ALGV2_INDICATOR_BYTE
;

105 
h—d
[1] = 
COMP_ALGV2_UNCOMPRESSED
;

106 
	}
}

110 
	$comp_unš™
(
com´ess_cÚ‹xt
 *
compùx
)

112 ià(
compùx
)

114 (*
compùx
->
®g
.
com´ess_unš™
)(compctx);

115 
	`ä“
(
compùx
);

117 
	}
}

120 
	$comp_add_to_exŒa_äame
(
äame
 *frame)

123 
	`äame_add_to_exŒa_äame
(
äame
, 
COMP_PREFIX_LEN
);

124 
	}
}

127 
	$comp_add_to_exŒa_bufãr
(
äame
 *frame)

131 
	`äame_add_to_exŒa_bufãr
(
äame
, 
	`COMP_EXTRA_BUFFER
(
	`EXPANDED_SIZE
(frame)));

132 
	}
}

135 
	$comp_´št_¡©s
(cÚ¡ 
com´ess_cÚ‹xt
 *
compùx
, 
¡©us_ouut
 *
so
)

137 ià(
compùx
)

139 
	`¡©us_´štf
(
so
, "´e-com´es by‹s," 
couÁ”_fÜm©
, 
compùx
->
´e_com´ess
);

140 
	`¡©us_´štf
(
so
, "po¡-com´es by‹s," 
couÁ”_fÜm©
, 
compùx
->
po¡_com´ess
);

141 
	`¡©us_´štf
(
so
, "´e-decom´es by‹s," 
couÁ”_fÜm©
, 
compùx
->
´e_decom´ess
);

142 
	`¡©us_´štf
(
so
, "po¡-decom´es by‹s," 
couÁ”_fÜm©
, 
compùx
->
po¡_decom´ess
);

144 
	}
}

150 
	$comp_g’”©e_³”_šfo_¡ršg
(cÚ¡ 
com´ess_İtiÚs
 *
İt
, 
bufãr
 *
out
)

152 ià(
İt
)

154 
boŞ
 
lzo_ava
 = 
çl£
;

155 ià(!(
İt
->
æags
 & 
COMP_F_ADVERTISE_STUBS_ONLY
))

157 #ià
	`defšed
(
ENABLE_LZ4
)

158 
	`buf_´štf
(
out
, "IV_LZ4=1\n");

159 
	`buf_´štf
(
out
, "IV_LZ4v2=1\n");

161 #ià
	`defšed
(
ENABLE_LZO
)

162 
	`buf_´štf
(
out
, "IV_LZO=1\n");

163 
lzo_ava
 = 
Œue
;

166 ià(!
lzo_ava
)

168 
	`buf_´štf
(
out
, "IV_LZO_STUB=1\n");

170 
	`buf_´štf
(
out
, "IV_COMP_STUB=1\n");

171 
	`buf_´štf
(
out
, "IV_COMP_STUBv2=1\n");

172 
	`buf_´štf
(
out
, "IV_TCPNL=1\n");

174 
	}
}

	@comp.h

28 #iâdeà
OPENVPN_COMP_H


29 
	#OPENVPN_COMP_H


	)

31 #ifdeà
USE_COMP


33 
	~"bufãr.h
"

34 
	~"mtu.h
"

35 
	~"commÚ.h
"

36 
	~"¡©us.h
"

39 
	#COMP_ALG_UNDEF
 0

	)

40 
	#COMP_ALG_STUB
 1

	)

41 
	#COMP_ALG_LZO
 2

	)

42 
	#COMP_ALG_SNAPPY
 3

	)

43 
	#COMP_ALG_LZ4
 4

	)

47 
	#COMP_ALGV2_UNCOMPRESSED
 10

	)

48 
	#COMP_ALGV2_LZ4
 11

	)

55 
	#COMP_F_ADAPTIVE
 (1<<0è

	)

56 
	#COMP_F_ASYM
 (1<<1è

	)

57 
	#COMP_F_SWAP
 (1<<2è

	)

58 
	#COMP_F_ADVERTISE_STUBS_ONLY
 (1<<3è

	)

64 
	#COMP_PREFIX_LEN
 1

	)

72 
	#LZO_COMPRESS_BYTE
 0x66

	)

73 
	#LZ4_COMPRESS_BYTE
 0x69

	)

74 
	#NO_COMPRESS_BYTE
 0xFA

	)

75 
	#NO_COMPRESS_BYTE_SWAP
 0xFB

	)

78 
	#COMP_ALGV2_INDICATOR_BYTE
 0x50

	)

79 
	#COMP_ALGV2_UNCOMPRESSED_BYTE
 0

	)

80 
	#COMP_ALGV2_LZ4_BYTE
 1

	)

81 
	#COMP_ALGV2_LZO_BYTE
 2

	)

82 
	#COMP_ALGV2_SNAPPY_BYTE
 3

	)

91 
	#COMP_EXTRA_BUFFER
(
Ën
è(Ö’)/6 + 128 + 3 + 
COMP_PREFIX_LEN
)

	)

96 
	#COMPRESS_THRESHOLD
 100

	)

99 
	gcom´ess_cÚ‹xt
;

104 
	scom´ess_®g


106 cÚ¡ *
	mÇme
;

107 (*
	mcom´ess_š™
)(
com´ess_cÚ‹xt
 *
	mcompùx
);

108 (*
	mcom´ess_unš™
)(
com´ess_cÚ‹xt
 *
	mcompùx
);

109 (*
	mcom´ess
)(
bufãr
 *
	mbuf
, bufã¸
	mwÜk
,

110 
com´ess_cÚ‹xt
 *
	mcompùx
,

111 cÚ¡ 
äame
 *
	mäame
);

113 (*
	mdecom´ess
)(
bufãr
 *
	mbuf
, bufã¸
	mwÜk
,

114 
com´ess_cÚ‹xt
 *
	mcompùx
,

115 cÚ¡ 
äame
 *
	mäame
);

121 #ifdeà
ENABLE_LZO


122 
	~"lzo.h
"

125 #ifdeà
ENABLE_LZ4


126 
	~"comp-lz4.h
"

133 
	scom´ess_İtiÚs


135 
	m®g
;

136 
	mæags
;

142 
	ucom´ess_wÜk¥aû_uniÚ


144 #ifdeà
ENABLE_LZO


145 
lzo_com´ess_wÜk¥aû
 
	mlzo
;

147 #ifdeà
ENABLE_LZ4


148 
lz4_wÜk¥aû
 
	mlz4
;

155 
	scom´ess_cÚ‹xt


157 
	mæags
;

158 
com´ess_®g
 
	m®g
;

159 
com´ess_wÜk¥aû_uniÚ
 
	mwu
;

162 
couÁ”_ty³
 
	m´e_decom´ess
;

163 
couÁ”_ty³
 
	mpo¡_decom´ess
;

164 
couÁ”_ty³
 
	m´e_com´ess
;

165 
couÁ”_ty³
 
	mpo¡_com´ess
;

168 cÚ¡ 
com´ess_®g
 
comp_¡ub_®g
;

169 cÚ¡ 
com´ess_®g
 
compv2_¡ub_®g
;

171 
com´ess_cÚ‹xt
 *
comp_š™
(cÚ¡ 
com´ess_İtiÚs
 *
İt
);

173 
comp_unš™
(
com´ess_cÚ‹xt
 *
compùx
);

175 
comp_add_to_exŒa_äame
(
äame
 *frame);

177 
comp_add_to_exŒa_bufãr
(
äame
 *frame);

179 
comp_´št_¡©s
(cÚ¡ 
com´ess_cÚ‹xt
 *
compùx
, 
¡©us_ouut
 *
so
);

181 
comp_g’”©e_³”_šfo_¡ršg
(cÚ¡ 
com´ess_İtiÚs
 *
İt
, 
bufãr
 *
out
);

183 
compv2_esÿ³_d©a_iâ“ded
(
bufãr
 *
buf
);

185 
šlše
 
boŞ


186 
	$comp_’abËd
(cÚ¡ 
com´ess_İtiÚs
 *
šfo
)

188  
šfo
->
®g
 !ğ
COMP_ALG_UNDEF
;

189 
	}
}

191 
šlše
 
boŞ


192 
	$comp_unsw­³d_´efix
(cÚ¡ 
com´ess_İtiÚs
 *
šfo
)

194  !(
šfo
->
æags
 & 
COMP_F_SWAP
);

195 
	}
}

	@compstub.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
defšed
(
USE_COMP
)

34 
	~"comp.h
"

35 
	~"”rÜ.h
"

36 
	~"Ùime.h
"

38 
	~"memdbg.h
"

41 
	$¡ub_com´ess_š™
(
com´ess_cÚ‹xt
 *
compùx
)

43 
	}
}

46 
	$¡ub_com´ess_unš™
(
com´ess_cÚ‹xt
 *
compùx
)

48 
	}
}

51 
	$¡ub_com´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

52 
com´ess_cÚ‹xt
 *
compùx
,

53 cÚ¡ 
äame
 *frame)

55 ià(
buf
->
Ën
 <= 0)

59 ià(
compùx
->
æags
 & 
COMP_F_SWAP
)

61 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

62 
ušt8_t
 *

 = 
	`BEND
(
buf
);

63 
	`ASSERT
(
	`buf_§ã
(
buf
, 1));

64 ++
buf
->
Ën
;

67 *

 = *
h—d
;

68 *
h—d
 = 
NO_COMPRESS_BYTE_SWAP
;

72 
ušt8_t
 *
h—d”
 = 
	`buf_´•’d
(
buf
, 1);

73 *
h—d”
 = 
NO_COMPRESS_BYTE
;

75 
	}
}

78 
	$¡ub_decom´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

79 
com´ess_cÚ‹xt
 *
compùx
,

80 cÚ¡ 
äame
 *frame)

82 
ušt8_t
 
c
;

83 ià(
buf
->
Ën
 <= 0)

87 ià(
compùx
->
æags
 & 
COMP_F_SWAP
)

89 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

90 
c
 = *
h—d
;

91 --
buf
->
Ën
;

92 *
h—d
 = *
	`BEND
(
buf
);

93 ià(
c
 !ğ
NO_COMPRESS_BYTE_SWAP
)

95 
	`dmsg
(
D_COMP_ERRORS
, "Bad com´essiÚ stub (sw­èdecom´essiÚ h—d” by‹: %d", 
c
);

96 
buf
->
Ën
 = 0;

101 
c
 = *
	`BPTR
(
buf
);

102 
	`ASSERT
(
	`buf_advªû
(
buf
, 1));

103 ià(
c
 !ğ
NO_COMPRESS_BYTE
)

105 
	`dmsg
(
D_COMP_ERRORS
, "Bad com´essiÚ stub decom´essiÚ h—d” by‹: %d", 
c
);

106 
buf
->
Ën
 = 0;

109 
	}
}

113 
	$¡ubv2_com´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

114 
com´ess_cÚ‹xt
 *
compùx
,

115 cÚ¡ 
äame
 *frame)

117 ià(
buf
->
Ën
 <= 0)

122 
	`compv2_esÿ³_d©a_iâ“ded
(
buf
);

123 
	}
}

126 
	$¡ubv2_decom´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

127 
com´ess_cÚ‹xt
 *
compùx
,

128 cÚ¡ 
äame
 *frame)

130 ià(
buf
->
Ën
 <= 0)

135 
ušt8_t
 *
h—d
 = 
	`BPTR
(
buf
);

138 ià(
h—d
[0] !ğ
COMP_ALGV2_INDICATOR_BYTE
)

144 
	`buf_advªû
(
buf
, 1);

147 ià(
buf
->
Ën
 <= 0)

152 
h—d
 = 
	`BPTR
(
buf
);

153 
	`buf_advªû
(
buf
, 1);

155 ià(
h—d
[0] !ğ
COMP_ALGV2_UNCOMPRESSED_BYTE
)

157 
	`dmsg
(
D_COMP_ERRORS
, "Bad com´essiÚ stubv2 decom´essiÚ h—d” by‹: %d", *
h—d
);

158 
buf
->
Ën
 = 0;

161 
	}
}

163 cÚ¡ 
com´ess_®g
 
	gcompv2_¡ub_®g
 = {

165 
¡ub_com´ess_š™
,

166 
¡ub_com´ess_unš™
,

167 
¡ubv2_com´ess
,

168 
¡ubv2_decom´ess


171 cÚ¡ 
com´ess_®g
 
	gcomp_¡ub_®g
 = {

173 
¡ub_com´ess_š™
,

174 
¡ub_com´ess_unš™
,

175 
¡ub_com´ess
,

176 
¡ub_decom´ess


181 
	$dummy
()

183 
	}
}

	@console.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~"cÚfig.h
"

28 #–ià
defšed
(
_MSC_VER
)

29 
	~"cÚfig-msvc.h
"

32 
	~"sysh—d.h
"

33 
	~"cÚsŞe.h
"

34 
	~"”rÜ.h
"

35 
	~"bufãr.h
"

36 
	~"misc.h
"

38 #ifdeà
ENABLE_SYSTEMD


39 
	~<sy¡emd/sd-d«mÚ.h
>

43 
_qu”y_u£r
 
	gqu”y_u£r
[
QUERY_USER_NUMSLOTS
];

47 
	$qu”y_u£r_ş—r
()

49 
i
;

51 
i
 = 0; i < 
QUERY_USER_NUMSLOTS
; i++)

53 
	`CLEAR
(
qu”y_u£r
[
i
]);

55 
	}
}

59 
	$qu”y_u£r_add
(*
´om±
, 
size_t
 
´om±_Ën
,

60 *
»¥
, 
size_t
 
»¥_Ën
,

61 
boŞ
 
echo
)

63 
i
;

68 
	`ASSERT
Ğ
´om±_Ën
 > 0 && 
´om±
 !ğ
NULL
 && 
»¥_Ën
 > 0 && 
»¥
 != NULL );

71 
i
 = 0; i < 
QUERY_USER_NUMSLOTS
; i++)

73 ià(
qu”y_u£r
[
i
].
´om±
 =ğ
NULL
)

78 
	`ASSERT
Ğ
i
 < 
QUERY_USER_NUMSLOTS
 );

81 
qu”y_u£r
[
i
].
´om±
 =…rompt;

82 
qu”y_u£r
[
i
].
´om±_Ën
 =…rompt_len;

83 
qu”y_u£r
[
i
].
»¥Ú£
 = 
»¥
;

84 
qu”y_u£r
[
i
].
»¥Ú£_Ën
 = 
»¥_Ën
;

85 
qu”y_u£r
[
i
].
echo
 =ƒcho;

86 
	}
}

	@console.h

26 #iâdeà
CONSOLE_H


27 
	#CONSOLE_H


	)

29 
	~"basic.h
"

34 
	s_qu”y_u£r
 {

35 *
	m´om±
;

36 
size_t
 
	m´om±_Ën
;

37 *
	m»¥Ú£
;

38 
size_t
 
	m»¥Ú£_Ën
;

39 
boŞ
 
	mecho
;

42 
	#QUERY_USER_NUMSLOTS
 10

	)

43 
_qu”y_u£r
 
qu”y_u£r
[];

49 
qu”y_u£r_ş—r
();

62 
qu”y_u£r_add
(*
´om±
, 
size_t
 
´om±_Ën
,

63 *
»¥
, 
size_t
 
»¥_Ën
,

64 
boŞ
 
echo
);

75 
boŞ
 
qu”y_u£r_exec_butš
();

78 #ià
defšed
(
ENABLE_SYSTEMD
)

86 
boŞ
 
qu”y_u£r_exec
();

94 
boŞ


95 
	$qu”y_u£r_exec
()

97  
	`qu”y_u£r_exec_butš
();

98 
	}
}

109 
šlše
 
boŞ


110 
	$qu”y_u£r_SINGLE
(*
´om±
, 
size_t
 
´om±_Ën
,

111 *
»¥
, 
size_t
 
»¥_Ën
,

112 
boŞ
 
echo
)

114 
	`qu”y_u£r_ş—r
();

115 
	`qu”y_u£r_add
(
´om±
, 
´om±_Ën
, 
»¥
, 
»¥_Ën
, 
echo
);

116  
	`qu”y_u£r_exec
();

117 
	}
}

	@console_builtin.c

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

33 #–ià
defšed
(
_MSC_VER
)

34 
	~"cÚfig-msvc.h
"

37 
	~"sysh—d.h
"

38 
	~"cÚsŞe.h
"

39 
	~"”rÜ.h
"

40 
	~"bufãr.h
"

41 
	~"misc.h
"

43 #ifdeà
_WIN32


45 
	~"wš32.h
"

58 
boŞ


59 
	$g‘_cÚsŞe_šput_wš32
(cÚ¡ *
´om±
, cÚ¡ 
boŞ
 
echo
, *
šput
, cÚ¡ 
ÿ·c™y
)

61 
HANDLE
 
š
 = 
INVALID_HANDLE_VALUE
;

62 
HANDLE
 
”r
 = 
INVALID_HANDLE_VALUE
;

63 
DWORD
 
Ën
 = 0;

65 
	`ASSERT
(
´om±
);

66 
	`ASSERT
(
šput
);

67 
	`ASSERT
(
ÿ·c™y
 > 0);

69 
šput
[0] = '\0';

71 
š
 = 
	`G‘StdHªdË
(
STD_INPUT_HANDLE
);

72 
”r
 = 
	`g‘_Üig_¡d”r
();

74 ià(
š
 !ğ
INVALID_HANDLE_VALUE


75 && 
”r
 !ğ
INVALID_HANDLE_VALUE


76 && !
	`wš32_£rviû_š‹¼u±
(&
wš32_sigÇl
)

77 && 
	`Wr™eFe
(
”r
, 
´om±
, 
	`¡¾’
Õrom±), &
Ën
, 
NULL
))

79 
boŞ
 
is_cÚsŞe
 = (
	`G‘FeTy³
(
š
è=ğ
FILE_TYPE_CHAR
);

80 
DWORD
 
æags_§ve
 = 0;

81 
¡©us
 = 0;

82 
WCHAR
 *
wšput
;

84 ià(
is_cÚsŞe
)

86 ià(
	`G‘CÚsŞeMode
(
š
, &
æags_§ve
))

88 
DWORD
 
æags
 = 
ENABLE_LINE_INPUT
 | 
ENABLE_PROCESSED_INPUT
;

89 ià(
echo
)

91 
æags
 |ğ
ENABLE_ECHO_INPUT
;

93 
	`S‘CÚsŞeMode
(
š
, 
æags
);

97 
is_cÚsŞe
 = 0;

101 ià(
is_cÚsŞe
)

103 
wšput
 = 
	`m®loc
(
ÿ·c™y
 * (
WCHAR
));

104 ià(
wšput
 =ğ
NULL
)

106  
çl£
;

109 
¡©us
 = 
	`R—dCÚsŞeW
(
š
, 
wšput
, 
ÿ·c™y
, &
Ën
, 
NULL
);

110 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
wšput
, 
Ën
, 
šput
, 
ÿ·c™y
, 
NULL
, NULL);

111 
	`ä“
(
wšput
);

115 
¡©us
 = 
	`R—dFe
(
š
, 
šput
, 
ÿ·c™y
, &
Ën
, 
NULL
);

118 
	`¡ršg_nuÎ_‹rmš©e
(
šput
, ()
Ën
, 
ÿ·c™y
);

119 
	`chomp
(
šput
);

121 ià(!
echo
)

123 
	`Wr™eFe
(
”r
, "\r\n", 2, &
Ën
, 
NULL
);

125 ià(
is_cÚsŞe
)

127 
	`S‘CÚsŞeMode
(
š
, 
æags_§ve
);

129 ià(
¡©us
 && !
	`wš32_£rviû_š‹¼u±
(&
wš32_sigÇl
))

131  
Œue
;

135  
çl£
;

136 
	}
}

141 #ifdeà
HAVE_GETPASS


153 
FILE
 *

154 
	$İ’_‰y
(cÚ¡ 
boŞ
 
wr™e
)

156 
FILE
 *
»t
;

157 
»t
 = 
	`fİ’
("/dev/‰y", 
wr™e
 ? "w" : "r");

158 ià(!
»t
)

160 
»t
 = 
wr™e
 ? 
¡d”r
 : 
¡dš
;

162  
»t
;

163 
	}
}

172 
	$şo£_‰y
(
FILE
 *
å
)

174 ià(
å
 !ğ
¡d”r
 && f°!ğ
¡dš
)

176 
	`fşo£
(
å
);

178 
	}
}

193 
boŞ


194 
	$g‘_cÚsŞe_šput
(cÚ¡ *
´om±
, cÚ¡ 
boŞ
 
echo
, *
šput
, cÚ¡ 
ÿ·c™y
)

196 
boŞ
 
»t
 = 
çl£
;

197 
	`ASSERT
(
´om±
);

198 
	`ASSERT
(
šput
);

199 
	`ASSERT
(
ÿ·c™y
 > 0);

200 
šput
[0] = '\0';

202 #ià
	`defšed
(
_WIN32
)

203  
	`g‘_cÚsŞe_šput_wš32
(
´om±
, 
echo
, 
šput
, 
ÿ·c™y
);

204 #–ià
	`defšed
(
HAVE_GETPASS
)

210 ià(!
	`i§‰y
(0) && !isatty(2) )

212 
fd
 = 
	`İ’
Ğ"/dev/‰y", 
O_RDWR
 );

213 ià(
fd
 < 0)

215 
	`msg
(
M_FATAL
, "neither stdin‚or stderr‡re‡ty device‡nd you have‚either‡ "

218 "ÿÀnÙ u£ --auth-noÿche.", 
´om±
 );

220 
	`şo£
(
fd
);

223 ià(
echo
)

225 
FILE
 *
å
;

227 
å
 = 
	`İ’_‰y
(
Œue
);

228 
	`årštf
(
å
, "%s", 
´om±
);

229 
	`fæush
(
å
);

230 
	`şo£_‰y
(
å
);

232 
å
 = 
	`İ’_‰y
(
çl£
);

233 ià(
	`fg‘s
(
šput
, 
ÿ·c™y
, 
å
è!ğ
NULL
)

235 
	`chomp
(
šput
);

236 
»t
 = 
Œue
;

238 
	`şo£_‰y
(
å
);

242 *
gp
 = 
	`g‘·ss
(
´om±
);

243 ià(
gp
)

245 
	`¡ºıyÁ
(
šput
, 
gp
, 
ÿ·c™y
);

246 
	`£cu»_memz”o
(
gp
, 
	`¡¾’
(gp));

247 
»t
 = 
Œue
;

251 
	`msg
(
M_FATAL
, "SÜry, buˆI cª'ˆg‘ cÚsŞšpuˆÚhi OS (%s)", 
´om±
);

253  
»t
;

254 
	}
}

269 
boŞ


270 
	$qu”y_u£r_exec_butš
()

272 
boŞ
 
»t
 = 
Œue
;

273 
i
;

276 
i
 = 0; i < 
QUERY_USER_NUMSLOTS
 && 
qu”y_u£r
[i].
»¥Ú£
 !ğ
NULL
; i++)

278 ià(!
	`g‘_cÚsŞe_šput
(
qu”y_u£r
[
i
].
´om±
, qu”y_u£r[i].
echo
,

279 
qu”y_u£r
[
i
].
»¥Ú£
, qu”y_u£r[i].
»¥Ú£_Ën
) )

282 
»t
 = 
çl£
;

286  
»t
;

287 
	}
}

	@console_systemd.c

30 
	~"cÚfig.h
"

32 #ifdeà
ENABLE_SYSTEMD


33 
	~"sysh—d.h
"

34 
	~"cÚsŞe.h
"

35 
	~"misc.h
"

37 
	~<sy¡emd/sd-d«mÚ.h
>

43 
boŞ


44 
	$check_sy¡emd_ruÂšg
()

46 
¡©
 
c
;

52  (
	`sd_boÙed
() > 0)

53 && (
	`¡©
(
SYSTEMD_ASK_PASSWORD_PATH
, &
c
) == 0);

55 
	}
}

57 
boŞ


58 
	$g‘_cÚsŞe_šput_sy¡emd
(cÚ¡ *
´om±
, cÚ¡ 
boŞ
 
echo
, *
šput
, cÚ¡ 
ÿ·c™y
)

60 
¡d_out
;

61 
boŞ
 
»t
 = 
çl£
;

62 
¬gv
‡rgv = 
	`¬gv_Ãw
();

64 
	`¬gv_´štf
(&
¬gv
, 
SYSTEMD_ASK_PASSWORD_PATH
);

65 #ifdeà
SYSTEMD_NEWER_THAN_216


67 ià(
echo
)

69 
	`¬gv_´štf_ÿt
(&
¬gv
, "--echo");

72 
	`¬gv_´štf_ÿt
(&
¬gv
, "--icon‚etwork-vpn");

73 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
´om±
);

75 ià((
¡d_out
 = 
	`İ’v²_pİ’
(&
¬gv
, 
NULL
)) < 0)

77  
çl£
;

79 
	`mem£t
(
šput
, 0, 
ÿ·c™y
);

80 ià(
	`»ad
(
¡d_out
, 
šput
, 
ÿ·c™y
-1) != 0)

82 
	`chomp
(
šput
);

83 
»t
 = 
Œue
;

85 
	`şo£
(
¡d_out
);

87 
	`¬gv_»£t
(&
¬gv
);

89  
»t
;

90 
	}
}

97 
boŞ


98 
	$qu”y_u£r_exec
()

100 
boŞ
 
»t
 = 
Œue
;

101 
i
;

104 ià(!
	`check_sy¡emd_ruÂšg
())

106  
	`qu”y_u£r_exec_butš
();

110 
i
 = 0; i < 
QUERY_USER_NUMSLOTS
 && 
qu”y_u£r
[i].
»¥Ú£
 !ğ
NULL
; i++)

112 ià(!
	`g‘_cÚsŞe_šput_sy¡emd
(
qu”y_u£r
[
i
].
´om±
, qu”y_u£r[i].
echo
,

113 
qu”y_u£r
[
i
].
»¥Ú£
, qu”y_u£r[i].
»¥Ú£_Ën
) )

116 
»t
 = 
çl£
;

120  
»t
;

121 
	}
}

	@crypto.c

25 #ifdeà
HAVE_CONFIG_H


26 
	~"cÚfig.h
"

27 #–ià
defšed
(
_MSC_VER
)

28 
	~"cÚfig-msvc.h
"

31 
	~"sysh—d.h
"

33 #ifdeà
ENABLE_CRYPTO


35 
	~"üy±o.h
"

36 
	~"”rÜ.h
"

37 
	~"š‹g”.h
"

38 
	~"¶©fÜm.h
"

40 
	~"memdbg.h
"

66 
	$İ’v²_’üy±_«ad
(
bufãr
 *
buf
, bufã¸
wÜk
,

67 
üy±o_İtiÚs
 *
İt
)

69 #ifdeà
HAVE_AEAD_CIPHER_MODES


70 
gc_¬’a
 
gc
;

71 
ou’
 = 0;

72 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
’üy±
;

73 
ušt8_t
 *
mac_out
 = 
NULL
;

74 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 = 
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
);

75 cÚ¡ 
mac_Ën
 = 
	`ch”_kt_g_size
(
ch”_kt
);

78 
	`ASSERT
(
ùx
->
ch”
);

79 
	`ASSERT
(
	`ch”_kt_mode_«ad
(
ch”_kt
));

80 
	`ASSERT
(
İt
->
æags
 & 
CO_USE_IV
);

81 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
));

83 
	`gc_š™
(&
gc
);

87 
bufãr
 
iv_bufãr
;

88 
ušt8_t
 
iv
[
OPENVPN_MAX_IV_LENGTH
] = {0};

89 cÚ¡ 
iv_Ën
 = 
	`ch”_ùx_iv_Ëngth
(
ùx
->
ch”
);

91 
	`ASSERT
(
iv_Ën
 >ğ
OPENVPN_AEAD_MIN_IV_LEN
 && iv_ËÀ<ğ
OPENVPN_MAX_IV_LENGTH
);

93 
	`buf_£t_wr™e
(&
iv_bufãr
, 
iv
, 
iv_Ën
);

96 ià(!
	`·ck‘_id_wr™e
(&
İt
->
·ck‘_id
.
£nd
, &
iv_bufãr
, 
çl£
, false))

98 
	`msg
(
D_CRYPT_ERRORS
, "ENCRYPT ERROR:…acket ID„oll over");

99 
”r
;

103 
	`ASSERT
(
	`buf_wr™e
(&
iv_bufãr
, 
ùx
->
im¶ic™_iv
, ctx->
im¶ic™_iv_Ën
));

104 
	`ASSERT
(
iv_bufãr
.
Ën
 =ğ
iv_Ën
);

107 
	`ASSERT
(
	`buf_wr™e
(&
wÜk
, 
iv
, 
iv_Ën
 - 
ùx
->
im¶ic™_iv_Ën
));

108 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT IV: %s", 
	`fÜm©_hex
(
iv
, 
iv_Ën
, 0, &
gc
));

111 
	`ASSERT
(
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
iv
));

115 
mac_out
 = 
	`buf_wr™e_®loc
(&
wÜk
, 
mac_Ën
);

116 
	`ASSERT
(
mac_out
);

118 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT FROM: %s", 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 80, &
gc
));

121 ià(!
	`buf_§ã
(&
wÜk
, 
buf
->
Ën
 + 
	`ch”_ùx_block_size
(
ùx
->
ch”
)))

123 
	`msg
(
D_CRYPT_ERRORS
,

125 
buf
->
ÿ·c™y
, buf->
off£t
, buf->
Ën
, 
wÜk
.capacity, work.offset,

126 
wÜk
.
Ën
);

127 
”r
;

131 
	`ASSERT
(
	`ch”_ùx_upd©e_ad
(
ùx
->
ch”
, 
	`BPTR
(&
wÜk
), 
	`BLEN
(&wÜkè- 
mac_Ën
));

132 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT AD: %s",

133 
	`fÜm©_hex
(
	`BPTR
(&
wÜk
), 
	`BLEN
(&wÜkè- 
mac_Ën
, 0, &
gc
));

136 
	`ASSERT
(
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BEND
(&
wÜk
), &
ou’
, 
	`BPTR
(
buf
), 
	`BLEN
(buf)));

137 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

140 
	`ASSERT
(
	`ch”_ùx_fš®
(
ùx
->
ch”
, 
	`BEND
(&
wÜk
), &
ou’
));

141 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

144 
	`ASSERT
(
	`ch”_ùx_g‘_g
(
ùx
->
ch”
, 
mac_out
, 
mac_Ën
));

146 *
buf
 = 
wÜk
;

148 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT TO: %s", 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 80, &
gc
));

150 
	`gc_ä“
(&
gc
);

153 
”r
:

154 
	`üy±o_ş—r_”rÜ
();

155 
buf
->
Ën
 = 0;

156 
	`gc_ä“
(&
gc
);

159 
	`ASSERT
(0);

161 
	}
}

164 
	$İ’v²_’üy±_v1
(
bufãr
 *
buf
, bufã¸
wÜk
,

165 
üy±o_İtiÚs
 *
İt
)

167 
gc_¬’a
 
gc
;

168 
	`gc_š™
(&
gc
);

170 ià(
buf
->
Ën
 > 0 && 
İt
)

172 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
’üy±
;

173 
ušt8_t
 *
mac_out
 = 
NULL
;

174 cÚ¡ 
ušt8_t
 *
hmac_¡¬t
 = 
NULL
;

177 ià(
ùx
->
ch”
)

179 
ušt8_t
 
iv_buf
[
OPENVPN_MAX_IV_LENGTH
] = {0};

180 cÚ¡ 
iv_size
 = 
	`ch”_ùx_iv_Ëngth
(
ùx
->
ch”
);

181 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 = 
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
);

182 
ou’
;

185 ià(
ùx
->
hmac
)

187 
mac_out
 = 
	`buf_wr™e_®loc
(&
wÜk
, 
	`hmac_ùx_size
(
ùx
->
hmac
));

188 
	`ASSERT
(
mac_out
);

189 
hmac_¡¬t
 = 
	`BEND
(&
wÜk
);

192 ià(
	`ch”_kt_mode_cbc
(
ch”_kt
))

195 ià(
İt
->
æags
 & 
CO_USE_IV
)

197 
	`´ng_by‹s
(
iv_buf
, 
iv_size
);

201 ià(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
)

202 && !
	`·ck‘_id_wr™e
(&
İt
->
·ck‘_id
.
£nd
, 
buf
,

203 
İt
->
æags
 & 
CO_PACKET_ID_LONG_FORM
,

204 
Œue
))

206 
	`msg
(
D_CRYPT_ERRORS
, "ENCRYPT ERROR:…acket ID„oll over");

207 
”r
;

210 ià(
	`ch”_kt_mode_ofb_cfb
(
ch”_kt
))

212 
bufãr
 
b
;

215 
	`ASSERT
(
İt
->
æags
 & 
CO_USE_IV
);

216 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
));

218 
	`buf_£t_wr™e
(&
b
, 
iv_buf
, 
iv_size
);

219 
	`ASSERT
(
	`·ck‘_id_wr™e
(&
İt
->
·ck‘_id
.
£nd
, &
b
, 
Œue
, 
çl£
));

223 
	`ASSERT
(0);

227 ià(
İt
->
æags
 & 
CO_USE_IV
)

229 
	`ASSERT
(
	`buf_wr™e
(&
wÜk
, 
iv_buf
, 
iv_size
));

230 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT IV: %s", 
	`fÜm©_hex
(
iv_buf
, 
iv_size
, 0, &
gc
));

233 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT FROM: %s",

234 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 80, &
gc
));

237 
	`ASSERT
(
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
iv_buf
));

240 ià(!
	`buf_§ã
(&
wÜk
, 
buf
->
Ën
 + 
	`ch”_ùx_block_size
(
ùx
->
ch”
)))

242 
	`msg
(
D_CRYPT_ERRORS
, "ENCRYPT: buffer sizeƒrror, bc=%d bo=%d bl=%d wc=%d wo=%d wl=%d cbs=%d",

243 
buf
->
ÿ·c™y
,

244 
buf
->
off£t
,

245 
buf
->
Ën
,

246 
wÜk
.
ÿ·c™y
,

247 
wÜk
.
off£t
,

248 
wÜk
.
Ën
,

249 
	`ch”_ùx_block_size
(
ùx
->
ch”
));

250 
”r
;

254 
	`ASSERT
(
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BEND
(&
wÜk
), &
ou’
, 
	`BPTR
(
buf
), 
	`BLEN
(buf)));

255 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

258 
	`ASSERT
(
	`ch”_ùx_fš®
(
ùx
->
ch”
, 
	`BEND
(&
wÜk
), &
ou’
));

259 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

262 
	`ASSERT
(
	`ch”_kt_mode
(
ch”_kt
è!ğ
OPENVPN_MODE_CBC


263 || 
ou’
 =ğ
iv_size
);

267 ià(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
)

268 && !
	`·ck‘_id_wr™e
(&
İt
->
·ck‘_id
.
£nd
, 
buf
,

269 
İt
->
æags
 & 
CO_PACKET_ID_LONG_FORM
, 
Œue
))

271 
	`msg
(
D_CRYPT_ERRORS
, "ENCRYPT ERROR:…acket ID„oll over");

272 
”r
;

274 ià(
ùx
->
hmac
)

276 
hmac_¡¬t
 = 
	`BPTR
(
buf
);

277 
	`ASSERT
(
mac_out
 = 
	`buf_´•’d
(
buf
, 
	`hmac_ùx_size
(
ùx
->
hmac
)));

279 ià(
	`BLEN
(&
wÜk
))

281 
	`buf_wr™e_´•’d
(
buf
, 
	`BPTR
(&
wÜk
), 
	`BLEN
(&work));

283 
wÜk
 = *
buf
;

287 ià(
ùx
->
hmac
)

289 
	`hmac_ùx_»£t
(
ùx
->
hmac
);

290 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
hmac_¡¬t
, 
	`BEND
(&
wÜk
) - hmac_start);

291 
	`hmac_ùx_fš®
(
ùx
->
hmac
, 
mac_out
);

292 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT HMAC: %s",

293 
	`fÜm©_hex
(
mac_out
, 
	`hmac_ùx_size
(
ùx
->
hmac
), 80, &
gc
));

296 *
buf
 = 
wÜk
;

298 
	`dmsg
(
D_PACKET_CONTENT
, "ENCRYPT TO: %s",

299 
	`fÜm©_hex
(
	`BPTR
(&
wÜk
), 
	`BLEN
(&wÜk), 80, &
gc
));

302 
	`gc_ä“
(&
gc
);

305 
”r
:

306 
	`üy±o_ş—r_”rÜ
();

307 
buf
->
Ën
 = 0;

308 
	`gc_ä“
(&
gc
);

310 
	}
}

313 
	$İ’v²_’üy±
(
bufãr
 *
buf
, bufã¸
wÜk
,

314 
üy±o_İtiÚs
 *
İt
)

316 ià(
buf
->
Ën
 > 0 && 
İt
)

318 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 =

319 
	`ch”_ùx_g‘_ch”_kt
(
İt
->
key_ùx_bi
.
’üy±
.
ch”
);

321 ià(
	`ch”_kt_mode_«ad
(
ch”_kt
))

323 
	`İ’v²_’üy±_«ad
(
buf
, 
wÜk
, 
İt
);

327 
	`İ’v²_’üy±_v1
(
buf
, 
wÜk
, 
İt
);

330 
	}
}

332 
boŞ


333 
	$üy±o_check_»¶ay
(
üy±o_İtiÚs
 *
İt
,

334 cÚ¡ 
·ck‘_id_Ãt
 *
pš
, cÚ¡ *
”rÜ_´efix
,

335 
gc_¬’a
 *
gc
)

337 
boŞ
 
»t
 = 
çl£
;

338 
	`·ck‘_id_»­_‹¡
(&
İt
->
·ck‘_id
.
»c
);

339 ià(
	`·ck‘_id_‹¡
(&
İt
->
·ck‘_id
.
»c
, 
pš
))

341 
	`·ck‘_id_add
(&
İt
->
·ck‘_id
.
»c
, 
pš
);

342 ià(
İt
->
pid_³rsi¡
 && (İt->
æags
 & 
CO_PACKET_ID_LONG_FORM
))

344 
	`·ck‘_id_³rsi¡_§ve_obj
(
İt
->
pid_³rsi¡
, &İt->
·ck‘_id
);

346 
»t
 = 
Œue
;

350 ià(!(
İt
->
æags
 & 
CO_MUTE_REPLAY_WARNINGS
))

352 
	`msg
(
D_REPLAY_ERRORS
, "%s: bad…acket ID (may be‡„eplay): %s -- "

355 
”rÜ_´efix
, 
	`·ck‘_id_Ãt_´št
(
pš
, 
Œue
, 
gc
));

358  
»t
;

359 
	}
}

369 
boŞ


370 
	$İ’v²_deüy±_«ad
(
bufãr
 *
buf
, bufã¸
wÜk
,

371 
üy±o_İtiÚs
 *
İt
, cÚ¡ 
äame
 *frame,

372 cÚ¡ 
ušt8_t
 *
ad_¡¬t
)

374 #ifdeà
HAVE_AEAD_CIPHER_MODES


375 cÚ¡ 
”rÜ_´efix
[] = "AEAD Decryptƒrror";

376 
·ck‘_id_Ãt
 
pš
 = { 0 };

377 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
deüy±
;

378 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 = 
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
);

379 
ušt8_t
 *
g_±r
 = 
NULL
;

380 
g_size
 = 0;

381 
ou’
;

382 
gc_¬’a
 
gc
;

384 
	`gc_š™
(&
gc
);

386 
	`ASSERT
(
İt
);

387 
	`ASSERT
(
äame
);

388 
	`ASSERT
(
buf
->
Ën
 > 0);

389 
	`ASSERT
(
ùx
->
ch”
);

390 
	`ASSERT
(
	`ch”_kt_mode_«ad
(
ch”_kt
));

392 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT FROM: %s",

393 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 80, &
gc
));

395 
	`ASSERT
(
ad_¡¬t
 >ğ
buf
->
d©a
 &&‡d_¡¬ˆ<ğ
	`BPTR
(buf));

397 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM_ADJ
(
äame
, 
FRAME_HEADROOM_MARKER_DECRYPT
)));

400 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
));

401 
	`ASSERT
(
İt
->
æags
 & 
CO_USE_IV
);

405 
ušt8_t
 
iv
[
OPENVPN_MAX_IV_LENGTH
] = { 0 };

406 cÚ¡ 
iv_Ën
 = 
	`ch”_ùx_iv_Ëngth
(
ùx
->
ch”
);

407 cÚ¡ 
size_t
 
·ck‘_iv_Ën
 = 
iv_Ën
 - 
ùx
->
im¶ic™_iv_Ën
;

409 
	`ASSERT
(
ùx
->
im¶ic™_iv_Ën
 <ğ
iv_Ën
);

410 ià(
buf
->
Ën
 + 
ùx
->
im¶ic™_iv_Ën
 < 
iv_Ën
)

412 
	`CRYPT_ERROR
("missing IV info");

415 
	`memıy
(
iv
, 
	`BPTR
(
buf
), 
·ck‘_iv_Ën
);

416 
	`memıy
(
iv
 + 
·ck‘_iv_Ën
, 
ùx
->
im¶ic™_iv
, ctx->
im¶ic™_iv_Ën
);

418 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT IV: %s", 
	`fÜm©_hex
(
iv
, 
iv_Ën
, 0, &
gc
));

421 ià(!
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
iv
))

423 
	`CRYPT_ERROR
("cipher init failed");

428 ià(!
	`·ck‘_id_»ad
(&
pš
, 
buf
, 
çl£
))

430 
	`CRYPT_ERROR
("error„eading…acket-id");

434 
g_size
 = 
	`ch”_kt_g_size
(
ch”_kt
);

435 ià(
buf
->
Ën
 < 
g_size
)

437 
	`CRYPT_ERROR
("missingag");

439 
g_±r
 = 
	`BPTR
(
buf
);

440 
	`ASSERT
(
	`buf_advªû
(
buf
, 
g_size
));

441 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT MAC: %s", 
	`fÜm©_hex
(
g_±r
, 
g_size
, 0, &
gc
));

442 #ià
	`defšed
(
ENABLE_CRYPTO_OPENSSL
è&& 
OPENSSL_VERSION_NUMBER
 < 0x10001040L

444 ià(!
	`EVP_CIPHER_CTX_ù¾
(
ùx
->
ch”
, 
EVP_CTRL_GCM_SET_TAG
, 
g_size
, 
g_±r
))

446 
	`CRYPT_ERROR
("settingag failed");

450 ià(
buf
->
Ën
 < 1)

452 
	`CRYPT_ERROR
("missing…ayload");

455 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT FROM: %s", 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 0, &
gc
));

458 ià(!
	`buf_§ã
(&
wÜk
, 
buf
->
Ën
 + 
	`ch”_ùx_block_size
(
ùx
->
ch”
)))

460 
	`CRYPT_ERROR
("potential buffer overflow");

465 cÚ¡ 
ad_size
 = 
	`BPTR
(
buf
è- 
ad_¡¬t
 - 
g_size
;

466 
	`ASSERT
(
	`ch”_ùx_upd©e_ad
(
ùx
->
ch”
, 
ad_¡¬t
, 
ad_size
));

467 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT AD: %s",

468 
	`fÜm©_hex
(
	`BPTR
(
buf
è- 
ad_size
 - 
g_size
,‡d_size, 0, &
gc
));

472 ià(!
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BPTR
(&
wÜk
), &
ou’
, BPTR(
buf
),

473 
	`BLEN
(
buf
)))

475 
	`CRYPT_ERROR
("cipher update failed");

477 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

478 ià(!
	`ch”_ùx_fš®_check_g
(
ùx
->
ch”
, 
	`BPTR
(&
wÜk
è+ 
ou’
,

479 &
ou’
, 
g_±r
, 
g_size
))

481 
	`CRYPT_ERROR
("cipher final failed");

483 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

485 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT TO: %s",

486 
	`fÜm©_hex
(
	`BPTR
(&
wÜk
), 
	`BLEN
(&wÜk), 80, &
gc
));

488 ià(!
	`üy±o_check_»¶ay
(
İt
, &
pš
, 
”rÜ_´efix
, &
gc
))

490 
”rÜ_ex™
;

493 *
buf
 = 
wÜk
;

495 
	`gc_ä“
(&
gc
);

496  
Œue
;

498 
”rÜ_ex™
:

499 
	`üy±o_ş—r_”rÜ
();

500 
buf
->
Ën
 = 0;

501 
	`gc_ä“
(&
gc
);

502  
çl£
;

504 
	`ASSERT
(0);

505  
çl£
;

507 
	}
}

517 
boŞ


518 
	$İ’v²_deüy±_v1
(
bufãr
 *
buf
, bufã¸
wÜk
,

519 
üy±o_İtiÚs
 *
İt
, cÚ¡ 
äame
 *frame)

521 cÚ¡ 
”rÜ_´efix
[] = "Authenticate/Decrypt…acketƒrror";

522 
gc_¬’a
 
gc
;

523 
	`gc_š™
(&
gc
);

525 ià(
buf
->
Ën
 > 0 && 
İt
)

527 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
deüy±
;

528 
·ck‘_id_Ãt
 
pš
;

529 
boŞ
 
have_pš
 = 
çl£
;

531 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT FROM: %s",

532 
	`fÜm©_hex
(
	`BPTR
(
buf
), 
	`BLEN
(buf), 80, &
gc
));

535 ià(
ùx
->
hmac
)

537 
hmac_Ën
;

538 
ušt8_t
 
loÿl_hmac
[
MAX_HMAC_KEY_LENGTH
];

540 
	`hmac_ùx_»£t
(
ùx
->
hmac
);

543 
hmac_Ën
 = 
	`hmac_ùx_size
(
ùx
->
hmac
);

546 ià(
buf
->
Ën
 < 
hmac_Ën
)

548 
	`CRYPT_ERROR
("missing‡uthentication info");

551 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
	`BPTR
(
buf
è+ 
hmac_Ën
, 
	`BLEN
(buf) - hmac_len);

552 
	`hmac_ùx_fš®
(
ùx
->
hmac
, 
loÿl_hmac
);

555 ià(
	`memcmp_cÚ¡ªt_time
(
loÿl_hmac
, 
	`BPTR
(
buf
), 
hmac_Ën
))

557 
	`CRYPT_ERROR
("packet HMAC‡uthentication failed");

560 
	`ASSERT
(
	`buf_advªû
(
buf
, 
hmac_Ën
));

565 ià(
ùx
->
ch”
)

567 cÚ¡ 
iv_size
 = 
	`ch”_ùx_iv_Ëngth
(
ùx
->
ch”
);

568 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 = 
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
);

569 
ušt8_t
 
iv_buf
[
OPENVPN_MAX_IV_LENGTH
] = { 0 };

570 
ou’
;

573 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM_ADJ
(
äame
, 
FRAME_HEADROOM_MARKER_DECRYPT
)));

576 ià(
İt
->
æags
 & 
CO_USE_IV
)

578 ià(
buf
->
Ën
 < 
iv_size
)

580 
	`CRYPT_ERROR
("missing IV info");

582 
	`memıy
(
iv_buf
, 
	`BPTR
(
buf
), 
iv_size
);

583 
	`ASSERT
(
	`buf_advªû
(
buf
, 
iv_size
));

587 ià(
İt
->
æags
 & 
CO_USE_IV
)

589 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT IV: %s", 
	`fÜm©_hex
(
iv_buf
, 
iv_size
, 0, &
gc
));

592 ià(
buf
->
Ën
 < 1)

594 
	`CRYPT_ERROR
("missing…ayload");

598 ià(!
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
iv_buf
))

600 
	`CRYPT_ERROR
("cipher init failed");

604 ià(!
	`buf_§ã
(&
wÜk
, 
buf
->
Ën
 + 
	`ch”_ùx_block_size
(
ùx
->
ch”
)))

606 
	`CRYPT_ERROR
("potential buffer overflow");

610 ià(!
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BPTR
(&
wÜk
), &
ou’
, BPTR(
buf
), 
	`BLEN
(buf)))

612 
	`CRYPT_ERROR
("cipher update failed");

614 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

617 ià(!
	`ch”_ùx_fš®
(
ùx
->
ch”
, 
	`BPTR
(&
wÜk
è+ 
ou’
, &outlen))

619 
	`CRYPT_ERROR
("cipher final failed");

621 
	`ASSERT
(
	`buf_šc_Ën
(&
wÜk
, 
ou’
));

623 
	`dmsg
(
D_PACKET_CONTENT
, "DECRYPT TO: %s",

624 
	`fÜm©_hex
(
	`BPTR
(&
wÜk
), 
	`BLEN
(&wÜk), 80, &
gc
));

628 ià(
	`ch”_kt_mode_cbc
(
ch”_kt
))

630 ià(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
))

632 ià(!
	`·ck‘_id_»ad
(&
pš
, &
wÜk
, 
	`BOOL_CAST
(
İt
->
æags
 & 
CO_PACKET_ID_LONG_FORM
)))

634 
	`CRYPT_ERROR
("error„eading CBC…acket-id");

636 
have_pš
 = 
Œue
;

639 ià(
	`ch”_kt_mode_ofb_cfb
(
ch”_kt
))

641 
bufãr
 
b
;

644 
	`ASSERT
(
İt
->
æags
 & 
CO_USE_IV
);

645 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
));

647 
	`buf_£t_»ad
(&
b
, 
iv_buf
, 
iv_size
);

648 ià(!
	`·ck‘_id_»ad
(&
pš
, &
b
, 
Œue
))

650 
	`CRYPT_ERROR
("error„eading CFB/OFB…acket-id");

652 
have_pš
 = 
Œue
;

656 
	`ASSERT
(0);

662 
wÜk
 = *
buf
;

663 ià(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
))

665 ià(!
	`·ck‘_id_»ad
(&
pš
, &
wÜk
, 
	`BOOL_CAST
(
İt
->
æags
 & 
CO_PACKET_ID_LONG_FORM
)))

667 
	`CRYPT_ERROR
("error„eading…acket-id");

669 
have_pš
 = !
	`BOOL_CAST
(
İt
->
æags
 & 
CO_IGNORE_PACKET_ID
);

673 ià(
have_pš
 && !
	`üy±o_check_»¶ay
(
İt
, &
pš
, 
”rÜ_´efix
, &
gc
))

675 
”rÜ_ex™
;

677 *
buf
 = 
wÜk
;

680 
	`gc_ä“
(&
gc
);

681  
Œue
;

683 
”rÜ_ex™
:

684 
	`üy±o_ş—r_”rÜ
();

685 
buf
->
Ën
 = 0;

686 
	`gc_ä“
(&
gc
);

687  
çl£
;

688 
	}
}

691 
boŞ


692 
	$İ’v²_deüy±
(
bufãr
 *
buf
, bufã¸
wÜk
,

693 
üy±o_İtiÚs
 *
İt
, cÚ¡ 
äame
 *frame,

694 cÚ¡ 
ušt8_t
 *
ad_¡¬t
)

696 
boŞ
 
»t
 = 
çl£
;

698 ià(
buf
->
Ën
 > 0 && 
İt
)

700 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
deüy±
;

701 ià(
	`ch”_kt_mode_«ad
(
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
)))

703 
»t
 = 
	`İ’v²_deüy±_«ad
(
buf
, 
wÜk
, 
İt
, 
äame
, 
ad_¡¬t
);

707 
»t
 = 
	`İ’v²_deüy±_v1
(
buf
, 
wÜk
, 
İt
, 
äame
);

712 
»t
 = 
Œue
;

714  
»t
;

715 
	}
}

718 
	$üy±o_adju¡_äame_·¿m‘”s
(
äame
 *frame,

719 cÚ¡ 
key_ty³
 *
kt
,

720 
boŞ
 
u£_iv
,

721 
boŞ
 
·ck‘_id
,

722 
boŞ
 
·ck‘_id_lÚg_fÜm
)

724 
üy±o_ov”h—d
 = 0;

726 ià(
·ck‘_id
)

728 
üy±o_ov”h—d
 +ğ
	`·ck‘_id_size
(
·ck‘_id_lÚg_fÜm
);

731 ià(
kt
->
ch”
)

733 ià(
u£_iv
)

735 
üy±o_ov”h—d
 +ğ
	`ch”_kt_iv_size
(
kt
->
ch”
);

738 ià(
	`ch”_kt_mode_«ad
(
kt
->
ch”
))

740 
üy±o_ov”h—d
 +ğ
	`ch”_kt_g_size
(
kt
->
ch”
);

744 
üy±o_ov”h—d
 +ğ
	`ch”_kt_block_size
(
kt
->
ch”
);

747 
üy±o_ov”h—d
 +ğ
kt
->
hmac_Ëngth
;

749 
	`äame_add_to_exŒa_äame
(
äame
, 
üy±o_ov”h—d
);

751 
	`msg
(
D_MTU_DEBUG
, "%s: Adjusting frame…arameters for crypto by %u bytes",

752 
__func__
, 
üy±o_ov”h—d
);

753 
	}
}

756 
	$üy±o_max_ov”h—d
()

758  
	`·ck‘_id_size
(
Œue
è+ 
OPENVPN_MAX_IV_LENGTH


759 +
OPENVPN_MAX_CIPHER_BLOCK_SIZE


760 +
	`max_št
(
OPENVPN_MAX_HMAC_SIZE
, 
OPENVPN_AEAD_TAG_LENGTH
);

761 
	}
}

767 
	$š™_key_ty³
(
key_ty³
 *
kt
, cÚ¡ *
ch”Çme
,

768 cÚ¡ *
authÇme
, 
keysize
, 
boŞ
 
s_mode
, boŞ 
w¬n
)

770 
boŞ
 
«ad_ch”
 = 
çl£
;

772 
	`ASSERT
(
ch”Çme
);

773 
	`ASSERT
(
authÇme
);

775 
	`CLEAR
(*
kt
);

776 ià(
	`¡rcmp
(
ch”Çme
, "none") != 0)

778 
kt
->
ch”
 = 
	`ch”_kt_g‘
(
	`Œª¦©e_ch”_Çme_äom_İ’v²
(
ch”Çme
));

779 ià(!
kt
->
ch”
)

781 
	`msg
(
M_FATAL
, "Ch” % nÙ suµÜ‹d", 
ch”Çme
);

784 
kt
->
ch”_Ëngth
 = 
	`ch”_kt_key_size
(kt->
ch”
);

785 ià(
keysize
 > 0 && keysiz<ğ
MAX_CIPHER_KEY_LENGTH
)

787 
kt
->
ch”_Ëngth
 = 
keysize
;

791 
«ad_ch”
 = 
	`ch”_kt_mode_«ad
(
kt
->
ch”
);

792 ià(!(
	`ch”_kt_mode_cbc
(
kt
->
ch”
)

793 || (
s_mode
 && 
«ad_ch”
)

794 #ifdeà
ENABLE_OFB_CFB_MODE


795 || (
s_mode
 && 
	`ch”_kt_mode_ofb_cfb
(
kt
->
ch”
))

799 
	`msg
(
M_FATAL
, "Ch” '%s' modnÙ suµÜ‹d", 
ch”Çme
);

802 ià(
OPENVPN_MAX_CIPHER_BLOCK_SIZE
 < 
	`ch”_kt_block_size
(
kt
->
ch”
))

804 
	`msg
(
M_FATAL
, "Ch” '%s'‚Ù‡Îowed: block siztoØbig.", 
ch”Çme
);

809 ià(
w¬n
)

811 
	`msg
(
M_WARN
, "******* WARNING *******: '--cipher‚one' was specified. "

817 ià(
	`¡rcmp
(
authÇme
, "none") != 0)

819 ià(!
«ad_ch”
)

821 
kt
->
dige¡
 = 
	`md_kt_g‘
(
authÇme
);

822 
kt
->
hmac_Ëngth
 = 
	`md_kt_size
(kt->
dige¡
);

824 ià(
OPENVPN_MAX_HMAC_SIZE
 < 
kt
->
hmac_Ëngth
)

826 
	`msg
(
M_FATAL
, "HMAC '%s'‚Ù‡Îowed: dige¡ siztoØbig.", 
authÇme
);

830 ià(!
«ad_ch”
)

832 ià(
w¬n
)

834 
	`msg
(
M_WARN
, "******* WARNING *******: '--auth‚one' was specified. "

841 
	}
}

845 
	$š™_key_ùx
(
key_ùx
 *
ùx
, cÚ¡ 
key
 *key,

846 cÚ¡ 
key_ty³
 *
kt
, 
’c
,

847 cÚ¡ *
´efix
)

849 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

850 
	`CLEAR
(*
ùx
);

851 ià(
kt
->
ch”
 && kt->
ch”_Ëngth
 > 0)

854 
ùx
->
ch”
 = 
	`ch”_ùx_Ãw
();

855 
	`ch”_ùx_š™
(
ùx
->
ch”
, 
key
->ch”, 
kt
->
ch”_Ëngth
,

856 
kt
->
ch”
, 
’c
);

858 
	`msg
(
D_HANDSHAKE
, "%s: Cipher '%s' initialized with %d bit key",

859 
´efix
,

860 
	`Œª¦©e_ch”_Çme_to_İ’v²
(
	`ch”_kt_Çme
(
kt
->
ch”
)),

861 
kt
->
ch”_Ëngth
 *8);

863 
	`dmsg
(
D_SHOW_KEYS
, "%s: CIPHER KEY: %s", 
´efix
,

864 
	`fÜm©_hex
(
key
->
ch”
, 
kt
->
ch”_Ëngth
, 0, &
gc
));

865 
	`dmsg
(
D_CRYPTO_DEBUG
, "%s: CIPHER block_size=%d iv_size=%d",

866 
´efix
, 
	`ch”_kt_block_size
(
kt
->
ch”
),

867 
	`ch”_kt_iv_size
(
kt
->
ch”
));

868 ià(
	`ch”_kt_block_size
(
kt
->
ch”
) < 128/8)

870 
	`msg
(
M_WARN
, "WARNING: INSECURE cipher with block size†esshan 128"

873 
	`ch”_kt_block_size
(
kt
->
ch”
)*8);

876 ià(
kt
->
dige¡
 && kt->
hmac_Ëngth
 > 0)

878 
ùx
->
hmac
 = 
	`hmac_ùx_Ãw
();

879 
	`hmac_ùx_š™
(
ùx
->
hmac
, 
key
->hmac, 
kt
->
hmac_Ëngth
, kt->
dige¡
);

881 
	`msg
(
D_HANDSHAKE
,

883 
´efix
, 
	`md_kt_size
(
kt
->
dige¡
è* 8, 
	`md_kt_Çme
(kt->digest));

885 
	`dmsg
(
D_SHOW_KEYS
, "%s: HMAC KEY: %s", 
´efix
,

886 
	`fÜm©_hex
(
key
->
hmac
, 
kt
->
hmac_Ëngth
, 0, &
gc
));

888 
	`dmsg
(
D_CRYPTO_DEBUG
, "%s: HMAC size=%d block_size=%d",

889 
´efix
,

890 
	`md_kt_size
(
kt
->
dige¡
),

891 
	`hmac_ùx_size
(
ùx
->
hmac
));

894 
	`gc_ä“
(&
gc
);

895 
	}
}

898 
	$š™_key_ùx_bi
(
key_ùx_bi
 *
ùx
, cÚ¡ 
key2
 *key2,

899 
key_dœeùiÚ
, cÚ¡ 
key_ty³
 *
kt
, cÚ¡ *
Çme
)

901 
log_´efix
[128] = { 0 };

902 
key_dœeùiÚ_¡©e
 
kds
;

904 
	`key_dœeùiÚ_¡©e_š™
(&
kds
, 
key_dœeùiÚ
);

906 
	`İ’v²_¢´štf
(
log_´efix
, Öog_´efix), "Outgošg %s", 
Çme
);

907 
	`š™_key_ùx
(&
ùx
->
’üy±
, &
key2
->
keys
[
kds
.
out_key
], 
kt
,

908 
OPENVPN_OP_ENCRYPT
, 
log_´efix
);

910 
	`İ’v²_¢´štf
(
log_´efix
, Öog_´efix), "Incomšg %s", 
Çme
);

911 
	`š™_key_ùx
(&
ùx
->
deüy±
, &
key2
->
keys
[
kds
.
š_key
], 
kt
,

912 
OPENVPN_OP_DECRYPT
, 
log_´efix
);

914 
ùx
->
š™Ÿlized
 = 
Œue
;

915 
	}
}

918 
	$ä“_key_ùx
(
key_ùx
 *
ùx
)

920 ià(
ùx
->
ch”
)

922 
	`ch”_ùx_ş—nup
(
ùx
->
ch”
);

923 
	`ch”_ùx_ä“
(
ùx
->
ch”
);

924 
ùx
->
ch”
 = 
NULL
;

926 ià(
ùx
->
hmac
)

928 
	`hmac_ùx_ş—nup
(
ùx
->
hmac
);

929 
	`hmac_ùx_ä“
(
ùx
->
hmac
);

930 
ùx
->
hmac
 = 
NULL
;

932 
ùx
->
im¶ic™_iv_Ën
 = 0;

933 
	}
}

936 
	$ä“_key_ùx_bi
(
key_ùx_bi
 *
ùx
)

938 
	`ä“_key_ùx
(&
ùx
->
’üy±
);

939 
	`ä“_key_ùx
(&
ùx
->
deüy±
);

940 
	}
}

942 
boŞ


943 
	$key_is_z”o
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
)

945 
i
;

946 
i
 = 0; i < 
kt
->
ch”_Ëngth
; ++i)

947 ià(
key
->
ch”
[
i
])

949  
çl£
;

951 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: WARNING: zero key detected");

952  
Œue
;

953 
	}
}

958 
boŞ


959 
	$check_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
)

961 ià(
kt
->
ch”
)

966 ià(
	`key_is_z”o
(
key
, 
kt
))

968  
çl£
;

975 cÚ¡ 
ndc
 = 
	`key_des_num_cblocks
(
kt
->
ch”
);

976 ià(
ndc
)

978  
	`key_des_check
(
key
->
ch”
, 
kt
->
ch”_Ëngth
, 
ndc
);

982  
Œue
;

986  
Œue
;

987 
	}
}

998 
	$fixup_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
)

1000 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1001 ià(
kt
->
ch”
)

1003 #ifdeà
ENABLE_DEBUG


1004 cÚ¡ 
key
 
Üig
 = *key;

1006 cÚ¡ 
ndc
 = 
	`key_des_num_cblocks
(
kt
->
ch”
);

1008 ià(
ndc
)

1010 
	`key_des_fixup
(
key
->
ch”
, 
kt
->
ch”_Ëngth
, 
ndc
);

1013 #ifdeà
ENABLE_DEBUG


1014 ià(
	`check_debug_Ëv–
(
D_CRYPTO_DEBUG
))

1016 ià(
	`memcmp
(
Üig
.
ch”
, 
key
->ch”, 
kt
->
ch”_Ëngth
))

1018 
	`dmsg
(
D_CRYPTO_DEBUG
, "CRYPTO INFO: fixup_key: before=%s‡fter=%s",

1019 
	`fÜm©_hex
(
Üig
.
ch”
, 
kt
->
ch”_Ëngth
, 0, &
gc
),

1020 
	`fÜm©_hex
(
key
->
ch”
, 
kt
->
ch”_Ëngth
, 0, &
gc
));

1025 
	`gc_ä“
(&
gc
);

1026 
	}
}

1029 
	$check_»¶ay_iv_cÚsi¡’cy
(cÚ¡ 
key_ty³
 *
kt
, 
boŞ
 
·ck‘_id
, boŞ 
u£_iv
)

1031 
	`ASSERT
(
kt
);

1033 ià(!(
·ck‘_id
 && 
u£_iv
è&& (
	`ch”_kt_mode_ofb_cfb
(
kt
->
ch”
)

1034 || 
	`ch”_kt_mode_«ad
(
kt
->
ch”
)))

1036 
	`msg
(
M_FATAL
, "--no-replay or --no-iv cannot be used with‡ CFB, OFB or "

1039 
	}
}

1046 
	$g’”©e_key_¿ndom
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
)

1048 
ch”_Ën
 = 
MAX_CIPHER_KEY_LENGTH
;

1049 
hmac_Ën
 = 
MAX_HMAC_KEY_LENGTH
;

1051 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1055 
	`CLEAR
(*
key
);

1056 ià(
kt
)

1058 ià(
kt
->
ch”
 && kt->
ch”_Ëngth
 > 0 && kt->ch”_Ëngth <ğ
ch”_Ën
)

1060 
ch”_Ën
 = 
kt
->
ch”_Ëngth
;

1063 ià(
kt
->
dige¡
 && kt->
hmac_Ëngth
 > 0 && kt->hmac_Ëngth <ğ
hmac_Ën
)

1065 
hmac_Ën
 = 
kt
->
hmac_Ëngth
;

1068 ià(!
	`¿nd_by‹s
(
key
->
ch”
, 
ch”_Ën
)

1069 || !
	`¿nd_by‹s
(
key
->
hmac
, 
hmac_Ën
))

1071 
	`msg
(
M_FATAL
, "ERROR: Random‚umber generator cannot obtainƒntropy for key generation");

1074 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "Ch” sourûƒÁrİy: %s", 
	`fÜm©_hex
(
key
->
ch”
, 
ch”_Ën
, 0, &
gc
));

1075 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "HMAC sourûƒÁrİy: %s", 
	`fÜm©_hex
(
key
->
hmac
, 
hmac_Ën
, 0, &
gc
));

1077 ià(
kt
)

1079 
	`fixup_key
(
key
, 
kt
);

1081 } 
kt
 && !
	`check_key
(
key
, kt));

1083 
	`gc_ä“
(&
gc
);

1084 
	}
}

1090 
	$key2_´št
(cÚ¡ 
key2
 *
k
,

1091 cÚ¡ 
key_ty³
 *
kt
,

1092 cÚ¡ *
´efix0
,

1093 cÚ¡ *
´efix1
)

1095 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1096 
	`ASSERT
(
k
->
n
 == 2);

1097 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "%s (cipher): %s",

1098 
´efix0
,

1099 
	`fÜm©_hex
(
k
->
keys
[0].
ch”
, 
kt
->
ch”_Ëngth
, 0, &
gc
));

1100 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "%s (hmac): %s",

1101 
´efix0
,

1102 
	`fÜm©_hex
(
k
->
keys
[0].
hmac
, 
kt
->
hmac_Ëngth
, 0, &
gc
));

1103 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "%s (cipher): %s",

1104 
´efix1
,

1105 
	`fÜm©_hex
(
k
->
keys
[1].
ch”
, 
kt
->
ch”_Ëngth
, 0, &
gc
));

1106 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "%s (hmac): %s",

1107 
´efix1
,

1108 
	`fÜm©_hex
(
k
->
keys
[1].
hmac
, 
kt
->
hmac_Ëngth
, 0, &
gc
));

1109 
	`gc_ä“
(&
gc
);

1110 
	}
}

1113 
	$‹¡_üy±o
(
üy±o_İtiÚs
 *
co
, 
äame
 *frame)

1115 
i
, 
j
;

1116 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1117 
bufãr
 
¤c
 = 
	`®loc_buf_gc
(
	`TUN_MTU_SIZE
(
äame
), &
gc
);

1118 
bufãr
 
wÜk
 = 
	`®loc_buf_gc
(
	`BUF_SIZE
(
äame
), &
gc
);

1119 
bufãr
 
’üy±_wÜk¥aû
 = 
	`®loc_buf_gc
(
	`BUF_SIZE
(
äame
), &
gc
);

1120 
bufãr
 
deüy±_wÜk¥aû
 = 
	`®loc_buf_gc
(
	`BUF_SIZE
(
äame
), &
gc
);

1121 
bufãr
 
buf
 = 
	`ş—r_buf
();

1122 *
buf_p
;

1125 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

1127 #ifdeà
HAVE_AEAD_CIPHER_MODES


1130 cÚ¡ 
ch”_kt_t
 *
ch”
 =

1131 
	`ch”_ùx_g‘_ch”_kt
(
co
->
key_ùx_bi
.
’üy±
.
ch”
);

1133 ià(
	`ch”_kt_mode_«ad
(
ch”
))

1135 
size_t
 
im¶_iv_Ën
 = 
	`ch”_kt_iv_size
(
ch”
è- (
·ck‘_id_ty³
);

1136 
	`ASSERT
(
	`ch”_kt_iv_size
(
ch”
è<ğ
OPENVPN_MAX_IV_LENGTH
);

1137 
	`ASSERT
(
	`ch”_kt_iv_size
(
ch”
è>ğ
OPENVPN_AEAD_MIN_IV_LEN
);

1140 
	`ASSERT
(
	`¿nd_by‹s
(
co
->
key_ùx_bi
.
’üy±
.
im¶ic™_iv
,

1141 
OPENVPN_MAX_IV_LENGTH
));

1142 
co
->
key_ùx_bi
.
’üy±
.
im¶ic™_iv_Ën
 = 
im¶_iv_Ën
;

1144 
	`memıy
(
co
->
key_ùx_bi
.
deüy±
.
im¶ic™_iv
,

1145 
co
->
key_ùx_bi
.
’üy±
.
im¶ic™_iv
, 
OPENVPN_MAX_IV_LENGTH
);

1146 
co
->
key_ùx_bi
.
deüy±
.
im¶ic™_iv_Ën
 = 
im¶_iv_Ën
;

1151 
	`msg
(
M_INFO
, "EÁ”šg " 
PACKAGE_NAME
 " crypto self-test mode.");

1152 
i
 = 1; i <ğ
	`TUN_MTU_SIZE
(
äame
); ++i)

1154 
	`upd©e_time
();

1156 
	`msg
(
M_INFO
, "TESTING ENCRYPT/DECRYPT oà·ck‘†’gth=%d", 
i
);

1161 
	`ASSERT
(
	`buf_š™
(&
¤c
, 0));

1162 
	`ASSERT
(
i
 <ğ
¤c
.
ÿ·c™y
);

1163 
¤c
.
Ën
 = 
i
;

1164 
	`ASSERT
(
	`¿nd_by‹s
(
	`BPTR
(&
¤c
), 
	`BLEN
(&src)));

1167 
buf
 = 
wÜk
;

1168 
buf_p
 = 
	`buf_wr™e_®loc
(&
buf
, 
	`BLEN
(&
¤c
));

1169 
	`ASSERT
(
buf_p
);

1170 
	`memıy
(
buf_p
, 
	`BPTR
(&
¤c
), 
	`BLEN
(&src));

1173 
	`ASSERT
(
	`buf_š™
(&
’üy±_wÜk¥aû
, 
	`FRAME_HEADROOM
(
äame
)));

1176 
	`İ’v²_’üy±
(&
buf
, 
’üy±_wÜk¥aû
, 
co
);

1179 
	`İ’v²_deüy±
(&
buf
, 
deüy±_wÜk¥aû
, 
co
, 
äame
, 
	`BPTR
(&buf));

1182 ià(
buf
.
Ën
 !ğ
¤c
.len)

1184 
	`msg
(
M_FATAL
, "SELF TEST FAILED, src.Ën=%d buf.Ën=%d", 
¤c
.
Ën
, 
buf
.len);

1186 
j
 = 0; j < 
i
; ++j)

1188 cÚ¡ 
ušt8_t
 
š
 = *(
	`BPTR
(&
¤c
è+ 
j
);

1189 cÚ¡ 
ušt8_t
 
out
 = *(
	`BPTR
(&
buf
è+ 
j
);

1190 ià(
š
 !ğ
out
)

1192 
	`msg
(
M_FATAL
, "SELF TEST FAILED,…os=%d in=%d out=%d", 
j
, 
š
, 
out
);

1196 
	`msg
(
M_INFO
, 
PACKAGE_NAME
 " crypto self-test mode SUCCEEDED.");

1197 
	`gc_ä“
(&
gc
);

1198 
	}
}

1201 
	$üy±o_»ad_İ’v²_key
(cÚ¡ 
key_ty³
 *key_type,

1202 
key_ùx_bi
 *
ùx
, cÚ¡ *
key_fe
, cÚ¡ *
key_šlše
,

1203 cÚ¡ 
key_dœeùiÚ
, cÚ¡ *
key_Çme
, cÚ¡ *
İt_Çme
)

1205 
key2
 key2;

1206 
key_dœeùiÚ_¡©e
 
kds
;

1208 ià(
key_šlše
)

1210 
	`»ad_key_fe
(&
key2
, 
key_šlše
, 
RKF_MUST_SUCCEED
|
RKF_INLINE
);

1214 
	`»ad_key_fe
(&
key2
, 
key_fe
, 
RKF_MUST_SUCCEED
);

1217 ià(
key2
.
n
 != 2)

1219 
	`msg
(
M_ERR
, "File '%s' does‚ot have OpenVPN Static Key format. Using "

1220 "ä“-fÜm…as¥h¿£ fi nÙ suµÜ‹d‡nymÜe.", 
key_fe
);

1224 
	`v”ify_fix_key2
(&
key2
, 
key_ty³
, 
key_fe
);

1227 
	`key_dœeùiÚ_¡©e_š™
(&
kds
, 
key_dœeùiÚ
);

1228 
	`mu¡_have_n_keys
(
key_fe
, 
İt_Çme
, &
key2
, 
kds
.
Ãed_keys
);

1231 
	`š™_key_ùx_bi
(
ùx
, &
key2
, 
key_dœeùiÚ
, 
key_ty³
, 
key_Çme
);

1232 
	`£cu»_memz”o
(&
key2
, (key2));

1233 
	}
}

1236 cÚ¡ 
	g¡©ic_key_h—d
[] = "-----BEGIN OpenVPN Static key V1-----";

1237 cÚ¡ 
	g¡©ic_key_foÙ
[] = "-----END OpenVPN Static key V1-----";

1239 cÚ¡ 
	g´šbË_ch¬_fmt
[] =

1242 cÚ¡ 
	guÅršbË_ch¬_fmt
[] =

1248 
	$»ad_key_fe
(
key2
 *key2, cÚ¡ *
fe
, cÚ¡ 
æags
)

1250 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1251 
bufãr
 
š
;

1252 
fd
, 
size
;

1253 
ušt8_t
 
hex_by‹
[3] = {0, 0, 0};

1254 cÚ¡ *
”rÜ_f’ame
 = 
fe
;

1257 cÚ¡ *
ı
;

1258 
hb_šdex
 = 0;

1259 
lše_num
 = 1;

1260 
lše_šdex
 = 0;

1261 
m©ch
 = 0;

1264 
ušt8_t
 *
out
 = (ušt8_ˆ*è&
key2
->
keys
;

1265 cÚ¡ 
keyËn
 = (
key2
->
keys
);

1266 
couÁ
 = 0;

1269 
	#PARSE_INITIAL
 0

	)

1270 
	#PARSE_HEAD
 1

	)

1271 
	#PARSE_DATA
 2

	)

1272 
	#PARSE_DATA_COMPLETE
 3

	)

1273 
	#PARSE_FOOT
 4

	)

1274 
	#PARSE_FINISHED
 5

	)

1275 
¡©e
 = 
PARSE_INITIAL
;

1278 cÚ¡ 
hËn
 = 
	`¡¾’
(
¡©ic_key_h—d
);

1279 cÚ¡ 
æ’
 = 
	`¡¾’
(
¡©ic_key_foÙ
);

1280 cÚ¡ 
ÚekeyËn
 = (
key2
->
keys
[0]);

1282 
	`CLEAR
(*
key2
);

1288 ià(
æags
 & 
RKF_INLINE
)

1290 
size
 = 
	`¡¾’
(
fe
) + 1;

1291 
	`buf_£t_»ad
(&
š
, (cÚ¡ 
ušt8_t
 *)
fe
, 
size
);

1292 
”rÜ_f’ame
 = 
INLINE_FILE_TAG
;

1296 
š
 = 
	`®loc_buf_gc
(2048, &
gc
);

1297 
fd
 = 
	`¶©fÜm_İ’
(
fe
, 
O_RDONLY
, 0);

1298 ià(
fd
 == -1)

1300 
	`msg
(
M_ERR
, "CªnÙ o³Àkey f'%s'", 
fe
);

1302 
size
 = 
	`»ad
(
fd
, 
š
.
d©a
, in.
ÿ·c™y
);

1303 ià(
size
 < 0)

1305 
	`msg
(
M_FATAL
, "R—dƒ¼Ü oÀkey f('%s')", 
fe
);

1307 ià(
size
 =ğ
š
.
ÿ·c™y
)

1309 
	`msg
(
M_FATAL
, "Key f('%s'èÿÀb¨maximum oà%d by‹s", 
fe
, ()
š
.
ÿ·c™y
);

1311 
	`şo£
(
fd
);

1314 
ı
 = (*)
š
.
d©a
;

1315 
size
 > 0)

1317 cÚ¡ 
c
 = *
ı
;

1320 
	`msg
(
M_INFO
, "char='%c'[%d] s=%d†n=%d†i=%d m=%d c=%d",

1321 
c
, ()c, 
¡©e
, 
lše_num
, 
lše_šdex
, 
m©ch
, 
couÁ
);

1324 ià(
c
 == '\n')

1326 
lše_šdex
 = 
m©ch
 = 0;

1327 ++
lše_num
;

1332 ià(!
lše_šdex
)

1335 ià(
¡©e
 =ğ
PARSE_HEAD
)

1337 
¡©e
 = 
PARSE_DATA
;

1341 ià((
¡©e
 =ğ
PARSE_DATA
 || s‹ =ğ
PARSE_DATA_COMPLETE
è&& 
c
 == '-')

1343 
¡©e
 = 
PARSE_FOOT
;

1348 ià(
¡©e
 =ğ
PARSE_INITIAL
)

1350 ià(
lše_šdex
 < 
hËn
 && 
c
 =ğ
¡©ic_key_h—d
[line_index])

1352 ià(++
m©ch
 =ğ
hËn
)

1354 
¡©e
 = 
PARSE_HEAD
;

1360 ià(
¡©e
 =ğ
PARSE_FOOT
)

1362 ià(
lše_šdex
 < 
æ’
 && 
c
 =ğ
¡©ic_key_foÙ
[line_index])

1364 ià(++
m©ch
 =ğ
æ’
)

1366 
¡©e
 = 
PARSE_FINISHED
;

1372 ià(
¡©e
 =ğ
PARSE_DATA
)

1374 ià(
	`isxdig™
(
c
))

1376 
	`ASSERT
(
hb_šdex
 >= 0 && hb_index < 2);

1377 
hex_by‹
[
hb_šdex
++] = 
c
;

1378 ià(
hb_šdex
 == 2)

1380 
u
;

1381 
	`ASSERT
(
	`ssÿnf
((cÚ¡ *)
hex_by‹
, "%x", &
u
) == 1);

1382 *
out
++ = 
u
;

1383 
hb_šdex
 = 0;

1384 ià(++
couÁ
 =ğ
keyËn
)

1386 
¡©e
 = 
PARSE_DATA_COMPLETE
;

1390 ià(
	`is¥aû
(
c
))

1395 
	`msg
(
M_FATAL
,

1396 (
	`i¥ršt
(
c
è? 
´šbË_ch¬_fmt
 : 
uÅršbË_ch¬_fmt
),

1397 
c
, 
lše_num
, 
”rÜ_f’ame
, 
couÁ
, 
ÚekeyËn
, 
keyËn
);

1400 ++
lše_šdex
;

1402 ++
ı
;

1403 --
size
;

1409 
key2
->
n
 = 
couÁ
 / 
ÚekeyËn
;

1411 
	`ASSERT
(
key2
->
n
 >ğ0 && key2->À<ğ(è
	`SIZE
(key2->
keys
));

1413 ià(
æags
 & 
RKF_MUST_SUCCEED
)

1415 ià(!
key2
->
n
)

1417 
	`msg
(
M_FATAL
, "Insufficient key material or headerext‚ot found in file '%s' (%d/%d/%d bytes found/min/max)",

1418 
”rÜ_f’ame
, 
couÁ
, 
ÚekeyËn
, 
keyËn
);

1421 ià(
¡©e
 !ğ
PARSE_FINISHED
)

1423 
	`msg
(
M_FATAL
, "Footerext‚ot found in file '%s' (%d/%d/%d bytes found/min/max)",

1424 
”rÜ_f’ame
, 
couÁ
, 
ÚekeyËn
, 
keyËn
);

1429 ià(!(
æags
 & 
RKF_INLINE
))

1431 
	`buf_ş—r
(&
š
);

1437 
i
;

1438 
	`´štf
("KEY READ,‚=%d\n", 
key2
->
n
);

1439 
i
 = 0; i < (è
	`SIZE
(
key2
->
keys
); ++i)

1442 cÚ¡ *
fmt
 = 
	`fÜm©_hex_ex
((cÚ¡ 
ušt8_t
 *)&
key2
->
keys
[
i
],

1443 (
key2
->
keys
[
i
]),

1447 &
gc
);

1448 
	`´štf
("[%d]\n%s\n\n", 
i
, 
fmt
);

1454 
	`gc_ä“
(&
gc
);

1455 
	}
}

1462 
	$wr™e_key_fe
(cÚ¡ 
nkeys
, cÚ¡ *
f’ame
)

1464 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1466 
fd
, 
i
;

1467 
nb™s
 = 0;

1470 
bufãr
 
out
 = 
	`®loc_buf_gc
(2048, &
gc
);

1471 
bufãr
 
nb™s_h—d_‹xt
 = 
	`®loc_buf_gc
(128, &
gc
);

1474 cÚ¡ 
by‹s_³r_lše
 = 16;

1477 
fd
 = 
	`¶©fÜm_İ’
(
f’ame
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
);

1479 ià(
fd
 == -1)

1481 
	`msg
(
M_ERR
, "CªnÙ o³Àsh¬ed seü‘ f'%s' fÜ wr™e", 
f’ame
);

1484 
	`buf_´štf
(&
out
, "%s\n", 
¡©ic_key_h—d
);

1486 
i
 = 0; i < 
nkeys
; ++i)

1488 
key
 key;

1489 *
fmt
;

1492 
	`g’”©e_key_¿ndom
(&
key
, 
NULL
);

1495 
fmt
 = 
	`fÜm©_hex_ex
((cÚ¡ 
ušt8_t
 *)&
key
,

1496 (
key
),

1498 
by‹s_³r_lše
,

1500 &
gc
);

1503 
nb™s
 +ğ(
key
) * 8;

1506 
	`buf_´štf
(&
out
, "%s\n", 
fmt
);

1509 
	`£cu»_memz”o
(
fmt
, 
	`¡¾’
(fmt));

1510 
	`£cu»_memz”o
(&
key
, (key));

1513 
	`buf_´štf
(&
out
, "%s\n", 
¡©ic_key_foÙ
);

1516 
	`buf_´štf
(&
nb™s_h—d_‹xt
, "#\n# %d b™ O³nVPN stiøkey\n#\n", 
nb™s
);

1517 
	`buf_wr™e_¡ršg_fe
(&
nb™s_h—d_‹xt
, 
f’ame
, 
fd
);

1520 
	`buf_wr™e_¡ršg_fe
(&
out
, 
f’ame
, 
fd
);

1522 ià(
	`şo£
(
fd
))

1524 
	`msg
(
M_ERR
, "Clo£ƒ¼Ü oÀsh¬ed seü‘ f%s", 
f’ame
);

1528 
	`buf_ş—r
(&
out
);

1531 
	`gc_ä“
(&
gc
);

1533  
nb™s
;

1534 
	}
}

1537 
	$mu¡_have_n_keys
(cÚ¡ *
f’ame
, cÚ¡ *
İtiÚ
, cÚ¡ 
key2
 *key2, 
n
)

1539 ià(
key2
->
n
 <‚)

1541 #ifdeà
ENABLE_SMALL


1542 
	`msg
(
M_FATAL
, "Key f'%s' u£d iÀ--% cÚš šsuffic›Á key m©”ŸÈ[key found=%d„equœed=%d]", 
f’ame
, 
İtiÚ
, 
key2
->
n
,‚);

1544 
	`msg
(
M_FATAL
, "Key f'%s' u£d iÀ--% cÚš šsuffic›Á key m©”ŸÈ[key found=%d„equœed=%d] --ry g’”©šg‡‚ew key fw™h '" 
PACKAGE
 " --g’key --£ü‘ [fe]', o¸u£hexi¡šg key fš bidœeùiÚ® modby s³cifyšg --% w™houˆ¨key dœeùiÚ…¬am‘”", 
f’ame
, 
İtiÚ
, 
key2
->
n
,‚, option);

1547 
	}
}

1550 
	$ascii2keydœeùiÚ
(
msgËv–
, cÚ¡ *
¡r
)

1552 ià(!
¡r
)

1554  
KEY_DIRECTION_BIDIRECTIONAL
;

1556 ià(!
	`¡rcmp
(
¡r
, "0"))

1558  
KEY_DIRECTION_NORMAL
;

1560 ià(!
	`¡rcmp
(
¡r
, "1"))

1562  
KEY_DIRECTION_INVERSE
;

1566 
	`msg
(
msgËv–
, "UnknowÀkey dœeùiÚ '%s' -- mu¡ b'0' o¸'1'", 
¡r
);

1569  
KEY_DIRECTION_BIDIRECTIONAL
;

1570 
	}
}

1573 
	$keydœeùiÚ2ascii
(
kd
, 
boŞ
 
»mÙe
, boŞ 
humª»adabË
)

1575 ià(
kd
 =ğ
KEY_DIRECTION_BIDIRECTIONAL
)

1577 ià(
humª»adabË
)

1583  
NULL
;

1586 ià(
kd
 =ğ
KEY_DIRECTION_NORMAL
)

1588  
»mÙe
 ? "1" : "0";

1590 ià(
kd
 =ğ
KEY_DIRECTION_INVERSE
)

1592  
»mÙe
 ? "0" : "1";

1596 
	`ASSERT
(0);

1598  
NULL
;

1599 
	}
}

1602 
	$key_dœeùiÚ_¡©e_š™
(
key_dœeùiÚ_¡©e
 *
kds
, 
key_dœeùiÚ
)

1604 
	`CLEAR
(*
kds
);

1605 
key_dœeùiÚ
)

1607 
KEY_DIRECTION_NORMAL
:

1608 
kds
->
out_key
 = 0;

1609 
kds
->
š_key
 = 1;

1610 
kds
->
Ãed_keys
 = 2;

1613 
KEY_DIRECTION_INVERSE
:

1614 
kds
->
out_key
 = 1;

1615 
kds
->
š_key
 = 0;

1616 
kds
->
Ãed_keys
 = 2;

1619 
KEY_DIRECTION_BIDIRECTIONAL
:

1620 
kds
->
out_key
 = 0;

1621 
kds
->
š_key
 = 0;

1622 
kds
->
Ãed_keys
 = 1;

1626 
	`ASSERT
(0);

1628 
	}
}

1631 
	$v”ify_fix_key2
(
key2
 *key2, cÚ¡ 
key_ty³
 *
kt
, cÚ¡ *
sh¬ed_£ü‘_fe
)

1633 
i
;

1635 
i
 = 0; i < 
key2
->
n
; ++i)

1638 
	`fixup_key
(&
key2
->
keys
[
i
], 
kt
);

1641 ià(!
	`check_key
(&
key2
->
keys
[
i
], 
kt
))

1643 
	`msg
(
M_FATAL
, "Key #%d in '%s' is bad. Try making‡‚ew key with --genkey.",

1644 
i
+1, 
sh¬ed_£ü‘_fe
);

1647 
	}
}

1650 
boŞ


1651 
	$wr™e_key
(cÚ¡ 
key
 *key, cÚ¡ 
key_ty³
 *
kt
,

1652 
bufãr
 *
buf
)

1654 
	`ASSERT
(
kt
->
ch”_Ëngth
 <ğ
MAX_CIPHER_KEY_LENGTH


1655 && 
kt
->
hmac_Ëngth
 <ğ
MAX_HMAC_KEY_LENGTH
);

1657 ià(!
	`buf_wr™e
(
buf
, &
kt
->
ch”_Ëngth
, 1))

1659  
çl£
;

1661 ià(!
	`buf_wr™e
(
buf
, &
kt
->
hmac_Ëngth
, 1))

1663  
çl£
;

1665 ià(!
	`buf_wr™e
(
buf
, 
key
->
ch”
, 
kt
->
ch”_Ëngth
))

1667  
çl£
;

1669 ià(!
	`buf_wr™e
(
buf
, 
key
->
hmac
, 
kt
->
hmac_Ëngth
))

1671  
çl£
;

1674  
Œue
;

1675 
	}
}

1684 
	$»ad_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
, 
bufãr
 *
buf
)

1686 
ušt8_t
 
ch”_Ëngth
;

1687 
ušt8_t
 
hmac_Ëngth
;

1689 
	`CLEAR
(*
key
);

1690 ià(!
	`buf_»ad
(
buf
, &
ch”_Ëngth
, 1))

1692 
»ad_”r
;

1694 ià(!
	`buf_»ad
(
buf
, &
hmac_Ëngth
, 1))

1696 
»ad_”r
;

1699 ià(
ch”_Ëngth
 !ğ
kt
->ch”_Ëngth || 
hmac_Ëngth
 != kt->hmac_length)

1701 
key_Ën_”r
;

1704 ià(!
	`buf_»ad
(
buf
, 
key
->
ch”
, 
ch”_Ëngth
))

1706 
»ad_”r
;

1708 ià(!
	`buf_»ad
(
buf
, 
key
->
hmac
, 
hmac_Ëngth
))

1710 
»ad_”r
;

1715 
»ad_”r
:

1716 
	`msg
(
D_TLS_ERRORS
, "TLS Error:ƒrror„eading key from„emote");

1719 
key_Ën_”r
:

1720 
	`msg
(
D_TLS_ERRORS
,

1722 
kt
->
ch”_Ëngth
, kt->
hmac_Ëngth
, cipher_length, hmac_length);

1724 
	}
}

1733 
ušt8_t
 *
	gnÚû_d©a
 = 
NULL
;

1734 cÚ¡ 
md_kt_t
 *
	gnÚû_md
 = 
NULL
;

1735 
	gnÚû_£ü‘_Ën
 = 0;

1739 
	$´ng_»£t_nÚû
()

1741 cÚ¡ 
size
 = 
	`md_kt_size
(
nÚû_md
è+ 
nÚû_£ü‘_Ën
;

1743 ià(!
	`¿nd_by‹s
(
nÚû_d©a
, 
size
))

1745 
	`msg
(
M_FATAL
, "ERROR: Random‚umber generator cannot obtainƒntropy for PRNG");

1750 
i
;

1751 
i
 = 0; i < 
size
; ++i)

1752 
nÚû_d©a
[
i
] = (
ušt8_t
) i;

1755 
	}
}

1758 
	$´ng_š™
(cÚ¡ *
md_Çme
, cÚ¡ 
nÚû_£ü‘_Ën_·rm
)

1760 
	`´ng_unš™
();

1761 
nÚû_md
 = 
md_Çme
 ? 
	`md_kt_g‘
(md_Çmeè: 
NULL
;

1762 ià(
nÚû_md
)

1764 
	`ASSERT
(
nÚû_£ü‘_Ën_·rm
 >ğ
NONCE_SECRET_LEN_MIN
 &&‚Úû_£ü‘_Ën_·rm <ğ
NONCE_SECRET_LEN_MAX
);

1765 
nÚû_£ü‘_Ën
 = 
nÚû_£ü‘_Ën_·rm
;

1767 cÚ¡ 
size
 = 
	`md_kt_size
(
nÚû_md
è+ 
nÚû_£ü‘_Ën
;

1768 
	`dmsg
(
D_CRYPTO_DEBUG
, "PRNG in™ md=% size=%d", 
	`md_kt_Çme
(
nÚû_md
), 
size
);

1769 
nÚû_d©a
 = (
ušt8_t
 *è
	`m®loc
(
size
);

1770 
	`check_m®loc_»tuº
(
nÚû_d©a
);

1771 
	`´ng_»£t_nÚû
();

1774 
	}
}

1777 
	$´ng_unš™
()

1779 
	`ä“
(
nÚû_d©a
);

1780 
nÚû_d©a
 = 
NULL
;

1781 
nÚû_md
 = 
NULL
;

1782 
nÚû_£ü‘_Ën
 = 0;

1783 
	}
}

1786 
	$´ng_by‹s
(
ušt8_t
 *
ouut
, 
Ën
)

1788 
size_t
 
´oûs£d
 = 0;

1790 ià(
nÚû_md
)

1792 cÚ¡ 
md_size
 = 
	`md_kt_size
(
nÚû_md
);

1793 
Ën
 > 0)

1795 cÚ¡ 
bËn
 = 
	`mš_št
(
Ën
, 
md_size
);

1796 
	`md_fuÎ
(
nÚû_md
, 
nÚû_d©a
, 
md_size
 + 
nÚû_£ü‘_Ën
,‚once_data);

1797 
	`memıy
(
ouut
, 
nÚû_d©a
, 
bËn
);

1798 
ouut
 +ğ
bËn
;

1799 
Ën
 -ğ
bËn
;

1802 
´oûs£d
 +ğ
bËn
;

1803 ià(
´oûs£d
 > 
PRNG_NONCE_RESET_BYTES
)

1805 
	`´ng_»£t_nÚû
();

1806 
´oûs£d
 = 0;

1812 
	`ASSERT
(
	`¿nd_by‹s
(
ouut
, 
Ën
));

1814 
	}
}

1818 
	$g‘_¿ndom
()

1820 
l
;

1821 
	`´ng_by‹s
((*)&
l
, (l));

1822 ià(
l
 < 0)

1824 
l
 = -l;

1826  
l
;

1827 
	}
}

1829 cÚ¡ 
ch”_Çme_·œ
 *

1830 
	$g‘_ch”_Çme_·œ
(cÚ¡ *
ch”_Çme
)

1832 cÚ¡ 
ch”_Çme_·œ
 *
·œ
;

1833 
size_t
 
i
 = 0;

1836 ; 
i
 < 
ch”_Çme_Œª¦©iÚ_bË_couÁ
; i++)

1838 
·œ
 = &
ch”_Çme_Œª¦©iÚ_bË
[
i
];

1839 ià(0 =ğ
	`¡rcmp
(
ch”_Çme
, 
·œ
->
İ’v²_Çme
)

1840 || 0 =ğ
	`¡rcmp
(
ch”_Çme
, 
·œ
->
lib_Çme
))

1842  
·œ
;

1847  
NULL
;

1848 
	}
}

1851 
	$Œª¦©e_ch”_Çme_äom_İ’v²
(cÚ¡ *
ch”_Çme
)

1853 cÚ¡ 
ch”_Çme_·œ
 *
·œ
 = 
	`g‘_ch”_Çme_·œ
(
ch”_Çme
);

1855 ià(
NULL
 =ğ
·œ
)

1857  
ch”_Çme
;

1860  
·œ
->
lib_Çme
;

1861 
	}
}

1864 
	$Œª¦©e_ch”_Çme_to_İ’v²
(cÚ¡ *
ch”_Çme
)

1866 cÚ¡ 
ch”_Çme_·œ
 *
·œ
 = 
	`g‘_ch”_Çme_·œ
(
ch”_Çme
);

1868 ià(
NULL
 =ğ
·œ
)

1870  
ch”_Çme
;

1873  
·œ
->
İ’v²_Çme
;

1874 
	}
}

	@crypto.h

123 #iâdeà
CRYPTO_H


124 
	#CRYPTO_H


	)

126 #ifdeà
ENABLE_CRYPTO


128 
	~"üy±o_back’d.h
"

129 
	~"basic.h
"

130 
	~"bufãr.h
"

131 
	~"·ck‘_id.h
"

132 
	~"mtu.h
"

135 
	ssha256_dige¡
 {

136 
ušt8_t
 
	mdige¡
[
SHA256_DIGEST_LENGTH
];

142 
	skey_ty³


144 
ušt8_t
 
	mch”_Ëngth
;

145 
ušt8_t
 
	mhmac_Ëngth
;

146 cÚ¡ 
ch”_kt_t
 *
	mch”
;

147 cÚ¡ 
md_kt_t
 *
	mdige¡
;

154 
	skey


156 
ušt8_t
 
	mch”
[
MAX_CIPHER_KEY_LENGTH
];

158 
ušt8_t
 
	mhmac
[
MAX_HMAC_KEY_LENGTH
];

167 
	skey_ùx


169 
ch”_ùx_t
 *
	mch”
;

170 
hmac_ùx_t
 *
	mhmac
;

171 
ušt8_t
 
	mim¶ic™_iv
[
OPENVPN_MAX_IV_LENGTH
];

173 
size_t
 
	mim¶ic™_iv_Ën
;

176 
	#KEY_DIRECTION_BIDIRECTIONAL
 0

	)

177 
	#KEY_DIRECTION_NORMAL
 1

	)

178 
	#KEY_DIRECTION_INVERSE
 2

	)

184 
	skey2


186 
	mn
;

188 
key
 
	mkeys
[2];

201 
	skey_dœeùiÚ_¡©e


203 
	mout_key
;

205 
	mš_key
;

207 
	mÃed_keys
;

222 
	skey_ùx_bi


224 
key_ùx
 
	m’üy±
;

226 
key_ùx
 
	mdeüy±
;

228 
boŞ
 
	mš™Ÿlized
;

235 
	süy±o_İtiÚs


237 
key_ùx_bi
 
	mkey_ùx_bi
;

241 
·ck‘_id
 
	m·ck‘_id
;

243 
·ck‘_id_³rsi¡
 *
	mpid_³rsi¡
;

248 
	#CO_PACKET_ID_LONG_FORM
 (1<<0)

	)

251 
	#CO_USE_IV
 (1<<1)

	)

255 
	#CO_IGNORE_PACKET_ID
 (1<<2)

	)

261 
	#CO_MUTE_REPLAY_WARNINGS
 (1<<3)

	)

264 
	mæags
;

268 
	#CRYPT_ERROR
(
fÜm©
) \

269 dØ{ 
	`msg
(
D_CRYPT_ERRORS
, "%s: " 
fÜm©
, 
”rÜ_´efix
); 
”rÜ_ex™
; } 
çl£
)

	)

275 
	#OPENVPN_AEAD_MIN_IV_LEN
 ((
·ck‘_id_ty³
è+ 8)

	)

277 
	#RKF_MUST_SUCCEED
 (1<<0)

	)

278 
	#RKF_INLINE
 (1<<1)

	)

279 
»ad_key_fe
(
key2
 *key2, cÚ¡ *
fe
, cÚ¡ 
æags
);

281 
wr™e_key_fe
(cÚ¡ 
nkeys
, cÚ¡ *
f’ame
);

283 
»ad_·s¥h¿£_hash
(cÚ¡ *
·s¥h¿£_fe
,

284 cÚ¡ 
md_kt_t
 *
dige¡
,

285 
ušt8_t
 *
ouut
,

286 
Ën
);

288 
g’”©e_key_¿ndom
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
);

290 
check_»¶ay_iv_cÚsi¡’cy
(cÚ¡ 
key_ty³
 *
kt
, 
boŞ
 
·ck‘_id
, boŞ 
u£_iv
);

292 
boŞ
 
check_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
);

294 
fixup_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
);

296 
boŞ
 
wr™e_key
(cÚ¡ 
key
 *key, cÚ¡ 
key_ty³
 *
kt
,

297 
bufãr
 *
buf
);

299 
»ad_key
(
key
 *key, cÚ¡ 
key_ty³
 *
kt
, 
bufãr
 *
buf
);

313 
š™_key_ty³
(
key_ty³
 *
kt
, cÚ¡ *
ch”Çme
,

314 cÚ¡ *
authÇme
, 
keysize
, 
boŞ
 
s_mode
, boŞ 
w¬n
);

320 
š™_key_ùx
(
key_ùx
 *
ùx
, cÚ¡ 
key
 *key,

321 cÚ¡ 
key_ty³
 *
kt
, 
’c
,

322 cÚ¡ *
´efix
);

324 
ä“_key_ùx
(
key_ùx
 *
ùx
);

326 
š™_key_ùx_bi
(
key_ùx_bi
 *
ùx
, cÚ¡ 
key2
 *key2,

327 
key_dœeùiÚ
, cÚ¡ 
key_ty³
 *
kt
,

328 cÚ¡ *
Çme
);

330 
ä“_key_ùx_bi
(
key_ùx_bi
 *
ùx
);

363 
İ’v²_’üy±
(
bufãr
 *
buf
, bufã¸
wÜk
,

364 
üy±o_İtiÚs
 *
İt
);

400 
boŞ
 
İ’v²_deüy±
(
bufãr
 *
buf
, bufã¸
wÜk
,

401 
üy±o_İtiÚs
 *
İt
, cÚ¡ 
äame
 *frame,

402 cÚ¡ 
ušt8_t
 *
ad_¡¬t
);

416 
boŞ
 
üy±o_check_»¶ay
(
üy±o_İtiÚs
 *
İt
,

417 cÚ¡ 
·ck‘_id_Ãt
 *
pš
, cÚ¡ *
”rÜ_´efix
,

418 
gc_¬’a
 *
gc
);

422 
üy±o_adju¡_äame_·¿m‘”s
(
äame
 *frame,

423 cÚ¡ 
key_ty³
 *
kt
,

424 
boŞ
 
u£_iv
,

425 
boŞ
 
·ck‘_id
,

426 
boŞ
 
·ck‘_id_lÚg_fÜm
);

429 
üy±o_max_ov”h—d
();

432 
	#NONCE_SECRET_LEN_MIN
 16

	)

435 
	#NONCE_SECRET_LEN_MAX
 64

	)

438 
	#PRNG_NONCE_RESET_BYTES
 1024

	)

447 
´ng_š™
(cÚ¡ *
md_Çme
, cÚ¡ 
nÚû_£ü‘_Ën_·rm
);

464 
´ng_by‹s
(
ušt8_t
 *
ouut
, 
Ën
);

466 
´ng_unš™
();

468 
‹¡_üy±o
(
üy±o_İtiÚs
 *
co
, 
äame
 *
f
);

473 
key_dœeùiÚ_¡©e_š™
(
key_dœeùiÚ_¡©e
 *
kds
, 
key_dœeùiÚ
);

475 
v”ify_fix_key2
(
key2
 *key2, cÚ¡ 
key_ty³
 *
kt
, cÚ¡ *
sh¬ed_£ü‘_fe
);

477 
mu¡_have_n_keys
(cÚ¡ *
f’ame
, cÚ¡ *
İtiÚ
, cÚ¡ 
key2
 *key2, 
n
);

479 
ascii2keydœeùiÚ
(
msgËv–
, cÚ¡ *
¡r
);

481 cÚ¡ *
keydœeùiÚ2ascii
(
kd
, 
boŞ
 
»mÙe
, boŞ 
humª»adabË
);

484 
key2_´št
(cÚ¡ 
key2
 *
k
,

485 cÚ¡ 
key_ty³
 *
kt
,

486 cÚ¡ *
´efix0
,

487 cÚ¡ *
´efix1
);

489 
üy±o_»ad_İ’v²_key
(cÚ¡ 
key_ty³
 *key_type,

490 
key_ùx_bi
 *
ùx
, cÚ¡ *
key_fe
, cÚ¡ *
key_šlše
,

491 cÚ¡ 
key_dœeùiÚ
, cÚ¡ *
key_Çme
, cÚ¡ *
İt_Çme
);

501 
šlše
 

502 
	$memcmp_cÚ¡ªt_time
(cÚ¡ *
a
, cÚ¡ *
b
, 
size_t
 
size
)

504 cÚ¡ 
ušt8_t
 *
a1
 = 
a
;

505 cÚ¡ 
ušt8_t
 *
b1
 = 
b
;

506 
»t
 = 0;

507 
size_t
 
i
;

509 
i
 = 0; i < 
size
; i++) {

510 
»t
 |ğ*
a1
++ ^ *
b1
++;

513  
»t
;

514 
	}
}

516 
šlše
 
boŞ


517 
	$key_ùx_bi_defšed
(cÚ¡ 
key_ùx_bi
 *
key
)

519  
key
->
’üy±
.
ch”
 || key->’üy±.
hmac
 || key->
deüy±
.cipher || key->decrypt.hmac;

520 
	}
}

	@crypto_backend.h

29 #iâdeà
CRYPTO_BACKEND_H_


30 
	#CRYPTO_BACKEND_H_


	)

32 #ifdeà
ENABLE_CRYPTO_OPENSSL


33 
	~"üy±o_İ’s¦.h
"

35 #ifdeà
ENABLE_CRYPTO_MBEDTLS


36 
	~"üy±o_mbeds.h
"

38 
	~"basic.h
"

41 
	#OPENVPN_AEAD_TAG_LENGTH
 16

	)

44 
	#OPENVPN_MAX_CIPHER_BLOCK_SIZE
 32

	)

47 
	#OPENVPN_MAX_HMAC_SIZE
 64

	)

51 
	mMD_SHA1
,

52 
	mMD_SHA256


53 } 
	thash_®go_ty³
 ;

57 cÚ¡ *
	mİ’v²_Çme
;

58 cÚ¡ *
	mlib_Çme
;

59 } 
	tch”_Çme_·œ
;

62 cÚ¡ 
ch”_Çme_·œ
 
ch”_Çme_Œª¦©iÚ_bË
[];

63 cÚ¡ 
size_t
 
ch”_Çme_Œª¦©iÚ_bË_couÁ
;

69 
üy±o_š™_lib
();

71 
üy±o_unš™_lib
();

73 
üy±o_ş—r_”rÜ
();

78 
üy±o_š™_lib_’gše
(cÚ¡ *
’gše_Çme
);

80 #ifdeà
DMALLOC


86 
üy±o_š™_dm®loc
();

94 cÚ¡ *
Œª¦©e_ch”_Çme_äom_İ’v²
(cÚ¡ *
ch”_Çme
);

100 cÚ¡ *
Œª¦©e_ch”_Çme_äom_İ’v²
(cÚ¡ *
ch”_Çme
);

102 
show_avaabË_ch”s
();

104 
show_avaabË_dige¡s
();

106 
show_avaabË_’gšes
();

126 
¿nd_by‹s
(
ušt8_t
 *
ouut
, 
Ën
);

143 
key_des_num_cblocks
(cÚ¡ 
ch”_kt_t
 *
kt
);

154 
boŞ
 
key_des_check
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
);

163 
key_des_fixup
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
);

172 
ch”_des_’üy±_ecb
(cÚ¡ 
key
[
DES_KEY_LENGTH
],

173 
¤c
[
DES_KEY_LENGTH
],

174 
d¡
[
DES_KEY_LENGTH
]);

193 
	#MAX_CIPHER_KEY_LENGTH
 64

	)

207 cÚ¡ 
ch”_kt_t
 *
ch”_kt_g‘
(cÚ¡ *
ch”Çme
);

216 cÚ¡ *
ch”_kt_Çme
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

226 
ch”_kt_key_size
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

237 
ch”_kt_iv_size
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

246 
ch”_kt_block_size
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

256 
ch”_kt_g_size
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

266 
ch”_kt_mode
(cÚ¡ 
ch”_kt_t
 *
ch”_kt
);

275 
boŞ
 
ch”_kt_mode_cbc
(cÚ¡ 
ch”_kt_t
 *
ch”
);

284 
boŞ
 
ch”_kt_mode_ofb_cfb
(cÚ¡ 
ch”_kt_t
 *
ch”
);

293 
boŞ
 
ch”_kt_mode_«ad
(cÚ¡ 
ch”_kt_t
 *
ch”
);

307 
ch”_ùx_t
 *
ch”_ùx_Ãw
();

314 
ch”_ùx_ä“
(
ch”_ùx_t
 *
ùx
);

326 
ch”_ùx_š™
(
ch”_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ën
,

327 cÚ¡ 
ch”_kt_t
 *
kt
, 
’c
);

334 
ch”_ùx_ş—nup
(
ch”_ùx_t
 *
ùx
);

345 
ch”_ùx_iv_Ëngth
(cÚ¡ 
ch”_ùx_t
 *
ùx
);

354 
ch”_ùx_g‘_g
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
g
, 
g_Ën
);

363 
ch”_ùx_block_size
(cÚ¡ 
ch”_ùx_t
 *
ùx
);

373 
ch”_ùx_mode
(cÚ¡ 
ch”_ùx_t
 *
ùx
);

383 cÚ¡ 
ch”_kt_t
 *
ch”_ùx_g‘_ch”_kt
(cÚ¡ 
ch”_ùx_t
 *
ùx
);

394 
ch”_ùx_»£t
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
iv_buf
);

406 
ch”_ùx_upd©e_ad
(
ch”_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
);

425 
ch”_ùx_upd©e
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
,

426 
ušt8_t
 *
¤c
, 
¤c_Ën
);

438 
ch”_ùx_fš®
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
);

453 
ch”_ùx_fš®_check_g
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
,

454 
ušt8_t
 *
g
, 
size_t
 
g_Ën
);

470 
	#MAX_HMAC_KEY_LENGTH
 64

	)

483 cÚ¡ 
md_kt_t
 *
md_kt_g‘
(cÚ¡ *
dige¡
);

493 cÚ¡ *
md_kt_Çme
(cÚ¡ 
md_kt_t
 *
kt
);

502 
md_kt_size
(cÚ¡ 
md_kt_t
 *
kt
);

521 
md_fuÎ
(cÚ¡ 
md_kt_t
 *
kt
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
, ušt8_ˆ*
d¡
);

528 
md_ùx_t
 *
md_ùx_Ãw
();

535 
md_ùx_ä“
(
md_ùx_t
 *
ùx
);

543 
md_ùx_š™
(
md_ùx_t
 *
ùx
, cÚ¡ 
md_kt_t
 *
kt
);

550 
md_ùx_ş—nup
(
md_ùx_t
 *
ùx
);

559 
md_ùx_size
(cÚ¡ 
md_ùx_t
 *
ùx
);

568 
md_ùx_upd©e
(
md_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
);

576 
md_ùx_fš®
(
md_ùx_t
 *
ùx
, 
ušt8_t
 *
d¡
);

590 
hmac_ùx_t
 *
hmac_ùx_Ãw
();

597 
hmac_ùx_ä“
(
hmac_ùx_t
 *
ùx
);

609 
hmac_ùx_š™
(
hmac_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ëngth
,

610 cÚ¡ 
md_kt_t
 *
kt
);

617 
hmac_ùx_ş—nup
(
hmac_ùx_t
 *
ùx
);

626 
hmac_ùx_size
(cÚ¡ 
hmac_ùx_t
 *
ùx
);

633 
hmac_ùx_»£t
(
hmac_ùx_t
 *
ùx
);

642 
hmac_ùx_upd©e
(
hmac_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
);

650 
hmac_ùx_fš®
(
hmac_ùx_t
 *
ùx
, 
ušt8_t
 *
d¡
);

660 cÚ¡ *
Œª¦©e_ch”_Çme_äom_İ’v²
(cÚ¡ *
ch”_Çme
);

670 cÚ¡ *
Œª¦©e_ch”_Çme_to_İ’v²
(cÚ¡ *
ch”_Çme
);

	@crypto_mbedtls.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_MBEDTLS
)

39 
	~"”¾ev–.h
"

40 
	~"basic.h
"

41 
	~"bufãr.h
"

42 
	~"š‹g”.h
"

43 
	~"üy±o_back’d.h
"

44 
	~"Ùime.h
"

45 
	~"misc.h
"

47 
	~<mbeds/des.h
>

48 
	~<mbeds/”rÜ.h
>

49 
	~<mbeds/md5.h
>

50 
	~<mbeds/ch”.h
>

51 
	~<mbeds/havege.h
>

53 
	~<mbeds/’Œİy.h
>

63 
	$üy±o_š™_lib_’gše
(cÚ¡ *
’gše_Çme
)

65 
	`msg
(
M_WARN
, "Note: mbed TLS hardware cryptoƒngine functionality is‚ot "

67 
	}
}

76 
	$üy±o_š™_lib
()

78 
	}
}

81 
	$üy±o_unš™_lib
()

83 
	}
}

86 
	$üy±o_ş—r_”rÜ
()

88 
	}
}

90 
boŞ


91 
	$mbed_log_”r
(
æags
, 
”rv®
, cÚ¡ *
´efix
)

93 ià(0 !ğ
”rv®
)

95 
”r¡r
[256];

96 
	`mbeds_¡»¼Ü
(
”rv®
, 
”r¡r
, (errstr));

98 ià(
NULL
 =ğ
´efix
)

100 
´efix
 = "mbed TLSƒrror";

102 
	`msg
(
æags
, "%s: %s", 
´efix
, 
”r¡r
);

105  0 =ğ
”rv®
;

106 
	}
}

108 
boŞ


109 
	$mbed_log_func_lše
(
æags
, 
”rv®
, cÚ¡ *
func
,

110 
lše
)

112 
´efix
[256];

114 ià(!
	`İ’v²_¢´štf
(
´efix
, Õ»fix), "%s:%d", 
func
, 
lše
))

116  
	`mbed_log_”r
(
æags
, 
”rv®
, 
func
);

119  
	`mbed_log_”r
(
æags
, 
”rv®
, 
´efix
);

120 
	}
}

123 #ifdeà
DMALLOC


125 
	$üy±o_š™_dm®loc
()

127 
	`msg
(
M_ERR
, "Error: dmalloc support is‚ot‡vailable for mbed TLS.");

128 
	}
}

131 cÚ¡ 
ch”_Çme_·œ
 
	gch”_Çme_Œª¦©iÚ_bË
[] = {

138 cÚ¡ 
size_t
 
	gch”_Çme_Œª¦©iÚ_bË_couÁ
 =

139 (
ch”_Çme_Œª¦©iÚ_bË
) / (*cipher_name_translation_table);

142 
	$´št_ch”
(cÚ¡ 
ch”_kt_t
 *
šfo
)

144 ià(
šfo
 && (
	`ch”_kt_mode_cbc
(info)

145 #ifdeà
HAVE_AEAD_CIPHER_MODES


146 || 
	`ch”_kt_mode_«ad
(
šfo
)

150 cÚ¡ *
s¦_Úly
 = 
	`ch”_kt_mode_cbc
(
šfo
) ?

152 cÚ¡ *
v¬_key_size
 = 
šfo
->
æags
 & 
MBEDTLS_CIPHER_VARIABLE_KEY_LEN
 ?

155 
	`´štf
("%s (%d bit key%s, %d bit block%s)\n",

156 
	`ch”_kt_Çme
(
šfo
), 
	`ch”_kt_key_size
(šfoè* 8, 
v¬_key_size
,

157 
	`ch”_kt_block_size
(
šfo
è* 8, 
s¦_Úly
);

159 
	}
}

162 
	$show_avaabË_ch”s
()

164 cÚ¡ *
ch”s
 = 
	`mbeds_ch”_li¡
();

166 #iâdeà
ENABLE_SMALL


167 
	`´štf
("The following ciphers‡nd cipher modes‡re‡vailable for use\n"

168 "w™h " 
PACKAGE_NAME
 ". Each cipher shown below may be used‡s‡\n"

173 *
ch”s
 != 0)

175 cÚ¡ 
ch”_kt_t
 *
šfo
 = 
	`mbeds_ch”_šfo_äom_ty³
(*
ch”s
);

176 ià(
šfo
 && 
	`ch”_kt_block_size
(info) >= 128/8)

178 
	`´št_ch”
(
šfo
);

180 
ch”s
++;

183 
	`´štf
("\nThe following ciphers have‡ block size of†esshan 128 bits, \n"

185 
ch”s
 = 
	`mbeds_ch”_li¡
();

186 *
ch”s
 != 0)

188 cÚ¡ 
ch”_kt_t
 *
šfo
 = 
	`mbeds_ch”_šfo_äom_ty³
(*
ch”s
);

189 ià(
šfo
 && 
	`ch”_kt_block_size
(info) < 128/8)

191 
	`´št_ch”
(
šfo
);

193 
ch”s
++;

195 
	`´štf
("\n");

196 
	}
}

199 
	$show_avaabË_dige¡s
()

201 cÚ¡ *
dige¡s
 = 
	`mbeds_md_li¡
();

203 #iâdeà
ENABLE_SMALL


204 
	`´štf
("The following message digests‡re‡vailable for use with\n"

205 
PACKAGE_NAME
 ". A message digest is used in conjunction with\n"

211 *
dige¡s
 != 0)

213 cÚ¡ 
mbeds_md_šfo_t
 *
šfo
 = 
	`mbeds_md_šfo_äom_ty³
(*
dige¡s
);

215 ià(
šfo
)

217 
	`´štf
("% %d b™ deçuÉ key\n", 
	`mbeds_md_g‘_Çme
(
šfo
),

218 
	`mbeds_md_g‘_size
(
šfo
) * 8);

220 
dige¡s
++;

222 
	`´štf
("\n");

223 
	}
}

226 
	$show_avaabË_’gšes
()

228 
	`´štf
("Sorry, mbed TLS hardware cryptoƒngine functionality is‚ot "

230 
	}
}

245 
mbeds_ùr_drbg_cÚ‹xt
 *

246 
	$¿nd_ùx_g‘
()

248 
mbeds_’Œİy_cÚ‹xt
 
ec
 = {0};

249 
mbeds_ùr_drbg_cÚ‹xt
 
cd_ùx
 = {0};

250 
boŞ
 
¿nd_š™Ÿli£d
 = 
çl£
;

252 ià(!
¿nd_š™Ÿli£d
)

254 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

255 
bufãr
 
³rs_¡ršg
 = 
	`®loc_buf_gc
(100, &
gc
);

262 
	`buf_´štf
(&
³rs_¡ršg
, "O³nVPN %0u %°%s", 
	`¶©fÜm_g‘pid
(), &
cd_ùx
, 
	`time_¡ršg
(0, 0, 0, &
gc
));

265 
	`mbeds_’Œİy_š™
(&
ec
);

267 
	`mbeds_ùr_drbg_š™
(&
cd_ùx
);

268 ià(!
	`mbed_ok
(
	`mbeds_ùr_drbg_£ed
(&
cd_ùx
, 
mbeds_’Œİy_func
, &
ec
,

269 
	`BPTR
(&
³rs_¡ršg
), 
	`BLEN
(&pers_string))))

271 
	`msg
(
M_FATAL
, "Failedo initialize„andom generator");

274 
	`gc_ä“
(&
gc
);

275 
¿nd_š™Ÿli£d
 = 
Œue
;

278  &
cd_ùx
;

279 
	}
}

281 #ifdeà
ENABLE_PREDICTION_RESISTANCE


283 
	$¿nd_ùx_’abË_´ediùiÚ_»si¡ªû
()

285 
mbeds_ùr_drbg_cÚ‹xt
 *
cd_ùx
 = 
	`¿nd_ùx_g‘
();

287 
	`mbeds_ùr_drbg_£t_´ediùiÚ_»si¡ªû
(
cd_ùx
, 1);

288 
	}
}

292 
	$¿nd_by‹s
(
ušt8_t
 *
ouut
, 
Ën
)

294 
mbeds_ùr_drbg_cÚ‹xt
 *
ºg_ùx
 = 
	`¿nd_ùx_g‘
();

296 
Ën
 > 0)

298 cÚ¡ 
size_t
 
bËn
 = 
	`mš_št
(
Ën
, 
MBEDTLS_CTR_DRBG_MAX_REQUEST
);

299 ià(0 !ğ
	`mbeds_ùr_drbg_¿ndom
(
ºg_ùx
, 
ouut
, 
bËn
))

304 
ouut
 +ğ
bËn
;

305 
Ën
 -ğ
bËn
;

309 
	}
}

319 
	$key_des_num_cblocks
(cÚ¡ 
mbeds_ch”_šfo_t
 *
kt
)

321 
»t
 = 0;

322 ià(
kt
->
ty³
 =ğ
MBEDTLS_CIPHER_DES_CBC
)

324 
»t
 = 1;

326 ià(
kt
->
ty³
 =ğ
MBEDTLS_CIPHER_DES_EDE_CBC
)

328 
»t
 = 2;

330 ià(
kt
->
ty³
 =ğ
MBEDTLS_CIPHER_DES_EDE3_CBC
)

332 
»t
 = 3;

335 
	`dmsg
(
D_CRYPTO_DEBUG
, "CRYPTO INFO:‚_DES_cblocks=%d", 
»t
);

336  
»t
;

337 
	}
}

339 
boŞ


340 
	$key_des_check
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
)

342 
i
;

343 
bufãr
 
b
;

345 
	`buf_£t_»ad
(&
b
, 
key
, 
key_Ën
);

347 
i
 = 0; i < 
ndc
; ++i)

349 *
key
 = 
	`buf_»ad_®loc
(&
b
, 
MBEDTLS_DES_KEY_SIZE
);

350 ià(!
key
)

352 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: insufficient key material");

353 
”r
;

355 ià(0 !ğ
	`mbeds_des_key_check_w—k
(
key
))

357 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: weak key detected");

358 
”r
;

360 ià(0 !ğ
	`mbeds_des_key_check_key_·r™y
(
key
))

362 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: check_key_DES: bad…arity detected");

363 
”r
;

366  
Œue
;

368 
”r
:

369  
çl£
;

370 
	}
}

373 
	$key_des_fixup
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
)

375 
i
;

376 
bufãr
 
b
;

378 
	`buf_£t_»ad
(&
b
, 
key
, 
key_Ën
);

379 
i
 = 0; i < 
ndc
; ++i)

381 *
key
 = 
	`buf_»ad_®loc
(&
b
, 
MBEDTLS_DES_KEY_SIZE
);

382 ià(!
key
)

384 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: fixup_key_DES: insufficient key material");

387 
	`mbeds_des_key_£t_·r™y
(
key
);

389 
	}
}

398 cÚ¡ 
mbeds_ch”_šfo_t
 *

399 
	$ch”_kt_g‘
(cÚ¡ *
ch”Çme
)

401 cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”
 = 
NULL
;

403 
	`ASSERT
(
ch”Çme
);

405 
ch”
 = 
	`mbeds_ch”_šfo_äom_¡ršg
(
ch”Çme
);

407 ià(
NULL
 =ğ
ch”
)

409 
	`msg
(
D_LOW
, "Ch”‡lgÜ™hm '%s'‚Ù found", 
ch”Çme
);

410  
NULL
;

413 ià(
ch”
->
key_b™Ën
/8 > 
MAX_CIPHER_KEY_LENGTH
)

415 
	`msg
(
D_LOW
, "Cipher‡lgorithm '%s' uses‡ default key size (%d bytes) "

416 "which i Ïrg”hª " 
PACKAGE_NAME
 "'s current maximum key size "

417 "(%d by‹s)", 
ch”Çme
, 
ch”
->
key_b™Ën
/8, 
MAX_CIPHER_KEY_LENGTH
);

418  
NULL
;

421  
ch”
;

422 
	}
}

425 
	$ch”_kt_Çme
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

427 ià(
NULL
 =ğ
ch”_kt
)

432  
	`Œª¦©e_ch”_Çme_to_İ’v²
(
ch”_kt
->
Çme
);

433 
	}
}

436 
	$ch”_kt_key_size
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

438 ià(
NULL
 =ğ
ch”_kt
)

443  
ch”_kt
->
key_b™Ën
/8;

444 
	}
}

447 
	$ch”_kt_iv_size
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

449 ià(
NULL
 =ğ
ch”_kt
)

453  
ch”_kt
->
iv_size
;

454 
	}
}

457 
	$ch”_kt_block_size
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

459 ià(
NULL
 =ğ
ch”_kt
)

463  
ch”_kt
->
block_size
;

464 
	}
}

467 
	$ch”_kt_g_size
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

469 #ifdeà
HAVE_AEAD_CIPHER_MODES


470 ià(
ch”_kt
 && 
	`ch”_kt_mode_«ad
(cipher_kt))

472  
OPENVPN_AEAD_TAG_LENGTH
;

476 
	}
}

479 
	$ch”_kt_mode
(cÚ¡ 
mbeds_ch”_šfo_t
 *
ch”_kt
)

481 
	`ASSERT
(
NULL
 !ğ
ch”_kt
);

482  
ch”_kt
->
mode
;

483 
	}
}

485 
boŞ


486 
	$ch”_kt_mode_cbc
(cÚ¡ 
ch”_kt_t
 *
ch”
)

488  
ch”
 && 
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_CBC
;

489 
	}
}

491 
boŞ


492 
	$ch”_kt_mode_ofb_cfb
(cÚ¡ 
ch”_kt_t
 *
ch”
)

494  
ch”
 && (
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_OFB


495 || 
	`ch”_kt_mode
(
ch”
è=ğ
OPENVPN_MODE_CFB
);

496 
	}
}

498 
boŞ


499 
	$ch”_kt_mode_«ad
(cÚ¡ 
ch”_kt_t
 *
ch”
)

501  
ch”
 && 
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_GCM
;

502 
	}
}

511 
mbeds_ch”_cÚ‹xt_t
 *

512 
	$ch”_ùx_Ãw
()

514 
mbeds_ch”_cÚ‹xt_t
 *
ùx
;

515 
	`ALLOC_OBJ
(
ùx
, 
mbeds_ch”_cÚ‹xt_t
);

516  
ùx
;

517 
	}
}

520 
	$ch”_ùx_ä“
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
)

522 
	`ä“
(
ùx
);

523 
	}
}

526 
	$ch”_ùx_š™
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ën
,

527 cÚ¡ 
mbeds_ch”_šfo_t
 *
kt
, cÚ¡ 
mbeds_İ”©iÚ_t
 
İ”©iÚ
)

529 
	`ASSERT
(
NULL
 !ğ
kt
 && NULL !ğ
ùx
);

531 
	`CLEAR
(*
ùx
);

533 ià(!
	`mbed_ok
(
	`mbeds_ch”_£tup
(
ùx
, 
kt
)))

535 
	`msg
(
M_FATAL
, "mbed TLS cipher context init #1");

538 ià(!
	`mbed_ok
(
	`mbeds_ch”_£tkey
(
ùx
, 
key
, 
key_Ën
*8, 
İ”©iÚ
)))

540 
	`msg
(
M_FATAL
, "mbed TLS cipher set key");

544 
	`ASSERT
(
ùx
->
key_b™Ën
 <ğ
key_Ën
*8);

545 
	}
}

548 
	$ch”_ùx_ş—nup
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
)

550 
	`mbeds_ch”_ä“
(
ùx
);

551 
	}
}

554 
	$ch”_ùx_iv_Ëngth
(cÚ¡ 
mbeds_ch”_cÚ‹xt_t
 *
ùx
)

556  
	`mbeds_ch”_g‘_iv_size
(
ùx
);

557 
	}
}

560 
	$ch”_ùx_g‘_g
(
ch”_ùx_t
 *
ùx
, 
ušt8_t
 *
g
, 
g_Ën
)

562 #ifdeà
HAVE_AEAD_CIPHER_MODES


563 ià(
g_Ën
 > 
SIZE_MAX
)

568 ià(!
	`mbed_ok
(
	`mbeds_ch”_wr™e_g
(
ùx
, (*è
g
, 
g_Ën
)))

575 
	`ASSERT
(0);

577 
	}
}

580 
	$ch”_ùx_block_size
(cÚ¡ 
mbeds_ch”_cÚ‹xt_t
 *
ùx
)

582  
	`mbeds_ch”_g‘_block_size
(
ùx
);

583 
	}
}

586 
	$ch”_ùx_mode
(cÚ¡ 
mbeds_ch”_cÚ‹xt_t
 *
ùx
)

588 
	`ASSERT
(
NULL
 !ğ
ùx
);

590  
	`ch”_kt_mode
(
ùx
->
ch”_šfo
);

591 
	}
}

593 cÚ¡ 
ch”_kt_t
 *

594 
	$ch”_ùx_g‘_ch”_kt
(cÚ¡ 
ch”_ùx_t
 *
ùx
)

596  
ùx
 ? ctx->
ch”_šfo
 : 
NULL
;

597 
	}
}

600 
	$ch”_ùx_»£t
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
iv_buf
)

602 ià(!
	`mbed_ok
(
	`mbeds_ch”_»£t
(
ùx
)))

607 ià(!
	`mbed_ok
(
	`mbeds_ch”_£t_iv
(
ùx
, 
iv_buf
, ctx->
ch”_šfo
->
iv_size
)))

613 
	}
}

616 
	$ch”_ùx_upd©e_ad
(
ch”_ùx_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

618 #ifdeà
HAVE_AEAD_CIPHER_MODES


619 ià(
¤c_Ën
 > 
SIZE_MAX
)

624 ià(!
	`mbed_ok
(
	`mbeds_ch”_upd©e_ad
(
ùx
, 
¤c
, 
¤c_Ën
)))

631 
	`ASSERT
(0);

633 
	}
}

636 
	$ch”_ùx_upd©e
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
d¡
,

637 *
d¡_Ën
, 
ušt8_t
 *
¤c
, 
¤c_Ën
)

639 
size_t
 
s_d¡_Ën
 = *
d¡_Ën
;

641 ià(!
	`mbed_ok
(
	`mbeds_ch”_upd©e
(
ùx
, 
¤c
, (
size_t
è
¤c_Ën
, 
d¡
,

642 &
s_d¡_Ën
)))

647 *
d¡_Ën
 = 
s_d¡_Ën
;

650 
	}
}

653 
	$ch”_ùx_fš®
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
)

655 
size_t
 
s_d¡_Ën
 = *
d¡_Ën
;

657 ià(!
	`mbed_ok
(
	`mbeds_ch”_fšish
(
ùx
, 
d¡
, &
s_d¡_Ën
)))

662 *
d¡_Ën
 = 
s_d¡_Ën
;

665 
	}
}

668 
	$ch”_ùx_fš®_check_g
(
mbeds_ch”_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
d¡
,

669 *
d¡_Ën
, 
ušt8_t
 *
g
, 
size_t
 
g_Ën
)

671 #ifdeà
HAVE_AEAD_CIPHER_MODES


672 
size_t
 
Ş’
 = 0;

674 ià(
MBEDTLS_DECRYPT
 !ğ
ùx
->
İ”©iÚ
)

679 ià(
g_Ën
 > 
SIZE_MAX
)

684 ià(!
	`mbed_ok
(
	`mbeds_ch”_fšish
(
ùx
, 
d¡
, &
Ş’
)))

686 
	`msg
(
D_CRYPT_ERRORS
, "%s: ch”_ùx_fš®(èçed", 
__func__
);

690 ià(
Ş’
 > 
INT_MAX
)

694 *
d¡_Ën
 = 
Ş’
;

696 ià(!
	`mbed_ok
(
	`mbeds_ch”_check_g
(
ùx
, (cÚ¡ *è
g
,

697 
g_Ën
)))

704 
	`ASSERT
(0);

706 
	}
}

709 
	$ch”_des_’üy±_ecb
(cÚ¡ 
key
[
DES_KEY_LENGTH
],

710 *
¤c
,

711 *
d¡
)

713 
mbeds_des_cÚ‹xt
 
ùx
;

715 
	`ASSERT
(
	`mbed_ok
(
	`mbeds_des_£tkey_’c
(&
ùx
, 
key
)));

716 
	`ASSERT
(
	`mbed_ok
(
	`mbeds_des_üy±_ecb
(&
ùx
, 
¤c
, 
d¡
)));

717 
	}
}

728 cÚ¡ 
mbeds_md_šfo_t
 *

729 
	$md_kt_g‘
(cÚ¡ *
dige¡
)

731 cÚ¡ 
mbeds_md_šfo_t
 *
md
 = 
NULL
;

732 
	`ASSERT
(
dige¡
);

734 
md
 = 
	`mbeds_md_šfo_äom_¡ršg
(
dige¡
);

735 ià(!
md
)

737 
	`msg
(
M_FATAL
, "Mes§ghash‡lgÜ™hm '%s'‚Ù found", 
dige¡
);

739 ià(
	`mbeds_md_g‘_size
(
md
è> 
MAX_HMAC_KEY_LENGTH
)

741 
	`msg
(
M_FATAL
, "Mes§ghash‡lgÜ™hm '%s' u£ ¨deçuÉ hash siz(%d by‹sèwhich i Ïrg”hª " 
PACKAGE_NAME
 "'s current maximum hash size (%d bytes)",

742 
dige¡
,

743 
	`mbeds_md_g‘_size
(
md
),

744 
MAX_HMAC_KEY_LENGTH
);

746  
md
;

747 
	}
}

750 
	$md_kt_Çme
(cÚ¡ 
mbeds_md_šfo_t
 *
kt
)

752 ià(
NULL
 =ğ
kt
)

756  
	`mbeds_md_g‘_Çme
(
kt
);

757 
	}
}

760 
	$md_kt_size
(cÚ¡ 
mbeds_md_šfo_t
 *
kt
)

762 ià(
NULL
 =ğ
kt
)

766  
	`mbeds_md_g‘_size
(
kt
);

767 
	}
}

776 
	$md_fuÎ
(cÚ¡ 
md_kt_t
 *
kt
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
, ušt8_ˆ*
d¡
)

778  0 =ğ
	`mbeds_md
(
kt
, 
¤c
, 
¤c_Ën
, 
d¡
);

779 
	}
}

781 
mbeds_md_cÚ‹xt_t
 *

782 
	$md_ùx_Ãw
()

784 
mbeds_md_cÚ‹xt_t
 *
ùx
;

785 
	`ALLOC_OBJ_CLEAR
(
ùx
, 
mbeds_md_cÚ‹xt_t
);

786  
ùx
;

787 
	}
}

789 
	$md_ùx_ä“
(
mbeds_md_cÚ‹xt_t
 *
ùx
)

791 
	`ä“
(
ùx
);

792 
	}
}

795 
	$md_ùx_š™
(
mbeds_md_cÚ‹xt_t
 *
ùx
, cÚ¡ 
mbeds_md_šfo_t
 *
kt
)

797 
	`ASSERT
(
NULL
 !ğ
ùx
 && NULL !ğ
kt
);

799 
	`mbeds_md_š™
(
ùx
);

800 
	`ASSERT
(0 =ğ
	`mbeds_md_£tup
(
ùx
, 
kt
, 0));

801 
	`ASSERT
(0 =ğ
	`mbeds_md_¡¬ts
(
ùx
));

802 
	}
}

805 
	$md_ùx_ş—nup
(
mbeds_md_cÚ‹xt_t
 *
ùx
)

807 
	`mbeds_md_ä“
(
ùx
);

808 
	}
}

811 
	$md_ùx_size
(cÚ¡ 
mbeds_md_cÚ‹xt_t
 *
ùx
)

813 ià(
NULL
 =ğ
ùx
)

817  
	`mbeds_md_g‘_size
(
ùx
->
md_šfo
);

818 
	}
}

821 
	$md_ùx_upd©e
(
mbeds_md_cÚ‹xt_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

823 
	`ASSERT
(0 =ğ
	`mbeds_md_upd©e
(
ùx
, 
¤c
, 
¤c_Ën
));

824 
	}
}

827 
	$md_ùx_fš®
(
mbeds_md_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
d¡
)

829 
	`ASSERT
(0 =ğ
	`mbeds_md_fšish
(
ùx
, 
d¡
));

830 
	`mbeds_md_ä“
(
ùx
);

831 
	}
}

845 
mbeds_md_cÚ‹xt_t
 *

846 
	$hmac_ùx_Ãw
()

848 
mbeds_md_cÚ‹xt_t
 *
ùx
;

849 
	`ALLOC_OBJ
(
ùx
, 
mbeds_md_cÚ‹xt_t
);

850  
ùx
;

851 
	}
}

854 
	$hmac_ùx_ä“
(
mbeds_md_cÚ‹xt_t
 *
ùx
)

856 
	`ä“
(
ùx
);

857 
	}
}

860 
	$hmac_ùx_š™
(
mbeds_md_cÚ‹xt_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ën
,

861 cÚ¡ 
mbeds_md_šfo_t
 *
kt
)

863 
	`ASSERT
(
NULL
 !ğ
kt
 && NULL !ğ
ùx
);

865 
	`mbeds_md_š™
(
ùx
);

866 
	`ASSERT
(0 =ğ
	`mbeds_md_£tup
(
ùx
, 
kt
, 1));

867 
	`ASSERT
(0 =ğ
	`mbeds_md_hmac_¡¬ts
(
ùx
, 
key
, 
key_Ën
));

870 
	`ASSERT
(
	`mbeds_md_g‘_size
(
kt
è<ğ
key_Ën
);

871 
	}
}

874 
	$hmac_ùx_ş—nup
(
mbeds_md_cÚ‹xt_t
 *
ùx
)

876 
	`mbeds_md_ä“
(
ùx
);

877 
	}
}

880 
	$hmac_ùx_size
(cÚ¡ 
mbeds_md_cÚ‹xt_t
 *
ùx
)

882 ià(
NULL
 =ğ
ùx
)

886  
	`mbeds_md_g‘_size
(
ùx
->
md_šfo
);

887 
	}
}

890 
	$hmac_ùx_»£t
(
mbeds_md_cÚ‹xt_t
 *
ùx
)

892 
	`ASSERT
(0 =ğ
	`mbeds_md_hmac_»£t
(
ùx
));

893 
	}
}

896 
	$hmac_ùx_upd©e
(
mbeds_md_cÚ‹xt_t
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

898 
	`ASSERT
(0 =ğ
	`mbeds_md_hmac_upd©e
(
ùx
, 
¤c
, 
¤c_Ën
));

899 
	}
}

902 
	$hmac_ùx_fš®
(
mbeds_md_cÚ‹xt_t
 *
ùx
, 
ušt8_t
 *
d¡
)

904 
	`ASSERT
(0 =ğ
	`mbeds_md_hmac_fšish
(
ùx
, 
d¡
));

905 
	}
}

	@crypto_mbedtls.h

29 #iâdeà
CRYPTO_MBEDTLS_H_


30 
	#CRYPTO_MBEDTLS_H_


	)

32 
	~<mbeds/ch”.h
>

33 
	~<mbeds/md.h
>

34 
	~<mbeds/ùr_drbg.h
>

37 
mbeds_ch”_šfo_t
 
	tch”_kt_t
;

40 
mbeds_md_šfo_t
 
	tmd_kt_t
;

43 
mbeds_ch”_cÚ‹xt_t
 
	tch”_ùx_t
;

46 
mbeds_md_cÚ‹xt_t
 
	tmd_ùx_t
;

49 
mbeds_md_cÚ‹xt_t
 
	thmac_ùx_t
;

52 
	#OPENVPN_MAX_IV_LENGTH
 
MBEDTLS_MAX_IV_LENGTH


	)

55 
	#OPENVPN_MODE_CBC
 
MBEDTLS_MODE_CBC


	)

58 
	#OPENVPN_MODE_OFB
 
MBEDTLS_MODE_OFB


	)

61 
	#OPENVPN_MODE_CFB
 
MBEDTLS_MODE_CFB


	)

64 
	#OPENVPN_MODE_GCM
 
MBEDTLS_MODE_GCM


	)

67 
	#OPENVPN_OP_ENCRYPT
 
MBEDTLS_ENCRYPT


	)

70 
	#OPENVPN_OP_DECRYPT
 
MBEDTLS_DECRYPT


	)

72 
	#MD4_DIGEST_LENGTH
 16

	)

73 
	#MD5_DIGEST_LENGTH
 16

	)

74 
	#SHA_DIGEST_LENGTH
 20

	)

75 
	#SHA256_DIGEST_LENGTH
 32

	)

76 
	#DES_KEY_LENGTH
 8

	)

88 
mbeds_ùr_drbg_cÚ‹xt
 *
¿nd_ùx_g‘
();

90 #ifdeà
ENABLE_PREDICTION_RESISTANCE


94 
¿nd_ùx_’abË_´ediùiÚ_»si¡ªû
();

107 
boŞ
 
mbed_log_”r
(
æags
, 
”rv®
, cÚ¡ *
´efix
);

119 
boŞ
 
mbed_log_func_lše
(
æags
, 
”rv®
, cÚ¡ *
func
,

120 
lše
);

123 
šlše
 
boŞ


124 
	$mbed_log_func_lše_l™e
(
æags
, 
”rv®
,

125 cÚ¡ *
func
, 
lše
)

127 ià(
”rv®
)

129  
	`mbed_log_func_lše
(
æags
, 
”rv®
, 
func
, 
lše
);

131  
Œue
;

132 
	}
}

146 
	#mbed_ok
(
”rv®
) \

147 
	`mbed_log_func_lše_l™e
(
D_CRYPT_ERRORS
, 
”rv®
, 
__func__
, 
__LINE__
)

	)

	@crypto_openssl.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_OPENSSL
)

39 
	~"basic.h
"

40 
	~"bufãr.h
"

41 
	~"š‹g”.h
"

42 
	~"üy±o.h
"

43 
	~"üy±o_back’d.h
"

44 
	~"İ’s¦_com·t.h
"

46 
	~<İ’s¦/des.h
>

47 
	~<İ’s¦/”r.h
>

48 
	~<İ’s¦/evp.h
>

49 
	~<İ’s¦/objeùs.h
>

50 
	~<İ’s¦/¿nd.h
>

51 
	~<İ’s¦/s¦.h
>

57 #ià
MAX_CIPHER_KEY_LENGTH
 < 
EVP_MAX_KEY_LENGTH


58 #w¬nšg 
Some
 
O³nSSL
 
EVP
 
ch”s
 
now
 
suµÜt
 
key
 
Ëngths
 
g»©”
 
thª
 
MAX_CIPHER_KEY_LENGTH
 -- 
cÚsid”
 
šü—sšg
 MAX_CIPHER_KEY_LENGTH

61 #ià
MAX_HMAC_KEY_LENGTH
 < 
EVP_MAX_MD_SIZE


62 #w¬nšg 
Some
 
O³nSSL
 
HMAC
 
mes§ge
 
dige¡s
 
now
 
suµÜt
 
key
 
Ëngths
 
g»©”
 
thª
 
MAX_HMAC_KEY_LENGTH
 -- 
cÚsid”
 
šü—sšg
 MAX_HMAC_KEY_LENGTH

65 #ià
HAVE_OPENSSL_ENGINE


66 
	~<İ’s¦/’gše.h
>

68 
boŞ
 
	g’gše_š™Ÿlized
 = 
çl£
;

70 
ENGINE
 *
	g’gše_³rsi¡
 = 
NULL
;

73 
ENGINE
 *

74 
	$Œy_lßd_’gše
(cÚ¡ *
’gše
)

76 
ENGINE
 *
e
 = 
	`ENGINE_by_id
("dynamic");

77 ià(
e
)

79 ià(!
	`ENGINE_ù¾_cmd_¡ršg
(
e
, "SO_PATH", 
’gše
, 0)

80 || !
	`ENGINE_ù¾_cmd_¡ršg
(
e
, "LOAD", 
NULL
, 0))

82 
	`ENGINE_ä“
(
e
);

83 
e
 = 
NULL
;

86  
e
;

87 
	}
}

89 
ENGINE
 *

90 
	$£tup_’gše
(cÚ¡ *
’gše
)

92 
ENGINE
 *
e
 = 
NULL
;

94 
	`ENGINE_lßd_butš_’gšes
();

96 ià(
’gše
)

98 ià(
	`¡rcmp
(
’gše
, "auto") == 0)

100 
	`msg
(
M_INFO
, "Initializing OpenSSL‡utoƒngine support");

101 
	`ENGINE_»gi¡”_®l_com¶‘e
();

102  
NULL
;

104 ià((
e
 = 
	`ENGINE_by_id
(
’gše
)è=ğ
NULL


105 && (
e
 = 
	`Œy_lßd_’gše
(
’gše
)è=ğ
NULL
)

107 
	`üy±o_msg
(
M_FATAL
, "OpenSSLƒrror: cannot†oadƒngine '%s'",

108 
’gše
);

111 ià(!
	`ENGINE_£t_deçuÉ
(
e
, 
ENGINE_METHOD_ALL
))

113 
	`üy±o_msg
(
M_FATAL
,

115 
’gše
);

118 
	`msg
(
M_INFO
, "Initializing OpenSSL support forƒngine '%s'",

119 
	`ENGINE_g‘_id
(
e
));

121  
e
;

122 
	}
}

127 
	$üy±o_š™_lib_’gše
(cÚ¡ *
’gše_Çme
)

129 #ià
HAVE_OPENSSL_ENGINE


130 ià(!
’gše_š™Ÿlized
)

132 
	`ASSERT
(
’gše_Çme
);

133 
	`ASSERT
(!
’gše_³rsi¡
);

134 
’gše_³rsi¡
 = 
	`£tup_’gše
(
’gše_Çme
);

135 
’gše_š™Ÿlized
 = 
Œue
;

138 
	`msg
(
M_WARN
, "Note: OpenSSL hardware cryptoƒngine functionality is‚ot‡vailable");

140 
	}
}

149 
	$üy±o_š™_lib
()

157 #ifdeà
CRYPTO_MDEBUG


158 
	`CRYPTO_mem_ù¾
(
CRYPTO_MEM_CHECK_ON
);

160 
	}
}

163 
	$üy±o_unš™_lib
()

165 #ifdeà
CRYPTO_MDEBUG


166 
FILE
 *
å
 = 
	`fİ’
("sdlog", "w");

167 
	`ASSERT
(
å
);

168 
	`CRYPTO_mem_Ëaks_å
(
å
);

169 
	`fşo£
(
å
);

172 #ià
HAVE_OPENSSL_ENGINE


173 ià(
’gše_š™Ÿlized
)

175 
	`ENGINE_ş—nup
();

176 
’gše_³rsi¡
 = 
NULL
;

177 
’gše_š™Ÿlized
 = 
çl£
;

180 
	}
}

183 
	$üy±o_ş—r_”rÜ
()

185 
	`ERR_ş—r_”rÜ
();

186 
	}
}

189 
	$üy±o_´št_İ’s¦_”rÜs
(cÚ¡ 
æags
)

191 
size_t
 
”r
 = 0;

193 (
”r
 = 
	`ERR_g‘_”rÜ
()))

196 ià(
	`ERR_GET_REASON
(
”r
è=ğ
SSL_R_NO_SHARED_CIPHER
)

198 
	`msg
(
D_CRYPT_ERRORS
, "TLSƒrror: The server has‚o TLS ciphersuites "

202 ià(
	`ERR_GET_REASON
(
”r
è=ğ
SSL_R_UNSUPPORTED_PROTOCOL
)

204 
	`msg
(
D_CRYPT_ERRORS
, "TLSƒrror: Unsupported…rotocol. Thisypically "

212 
	`msg
(
æags
, "O³nSSL: %s", 
	`ERR_”rÜ_¡ršg
(
”r
, 
NULL
));

214 
	}
}

225 #ifdeà
DMALLOC


227 
	$üy±o_m®loc
(
size_t
 
size
, cÚ¡ *
fe
, 
lše
)

229  
	`dm®loc_m®loc
(
fe
, 
lše
, 
size
, 
DMALLOC_FUNC_MALLOC
, 0, 0);

230 
	}
}

233 
	$üy±o_»®loc
(*
±r
, 
size_t
 
size
, cÚ¡ *
fe
, 
lše
)

235  
	`dm®loc_»®loc
(
fe
, 
lše
, 
±r
, 
size
, 
DMALLOC_FUNC_REALLOC
, 0);

236 
	}
}

239 
	$üy±o_ä“
(*
±r
)

241 
	`dm®loc_ä“
(
__FILE__
, 
__LINE__
, 
±r
, 
DMALLOC_FUNC_FREE
);

242 
	}
}

245 
	$üy±o_š™_dm®loc
()

247 
	`CRYPTO_£t_mem_ex_funùiÚs
(
üy±o_m®loc
,

248 
üy±o_»®loc
,

249 
üy±o_ä“
);

250 
	}
}

253 cÚ¡ 
ch”_Çme_·œ
 
	gch”_Çme_Œª¦©iÚ_bË
[] = {

258 cÚ¡ 
size_t
 
	gch”_Çme_Œª¦©iÚ_bË_couÁ
 =

259 (
ch”_Çme_Œª¦©iÚ_bË
) / (*cipher_name_translation_table);

263 
	$ch”_Çme_cmp
(cÚ¡ *
a
, cÚ¡ *
b
)

265 cÚ¡ 
EVP_CIPHER
 *cÚ¡ *
ch”_a
 = 
a
;

266 cÚ¡ 
EVP_CIPHER
 *cÚ¡ *
ch”_b
 = 
b
;

268 cÚ¡ *
ch”_Çme_a
 =

269 
	`Œª¦©e_ch”_Çme_to_İ’v²
(
	`EVP_CIPHER_Çme
(*
ch”_a
));

270 cÚ¡ *
ch”_Çme_b
 =

271 
	`Œª¦©e_ch”_Çme_to_İ’v²
(
	`EVP_CIPHER_Çme
(*
ch”_b
));

273  
	`¡rcmp
(
ch”_Çme_a
, 
ch”_Çme_b
);

274 
	}
}

277 
	$´št_ch”
(cÚ¡ 
EVP_CIPHER
 *
ch”
)

279 cÚ¡ *
v¬_key_size
 =

280 (
	`EVP_CIPHER_æags
(
ch”
è& 
EVP_CIPH_VARIABLE_LENGTH
) ?

282 cÚ¡ *
s¦_Úly
 = 
	`ch”_kt_mode_cbc
(
ch”
) ?

285 
	`´štf
("%s (%d bit key%s, %d bit block%s)\n",

286 
	`Œª¦©e_ch”_Çme_to_İ’v²
(
	`EVP_CIPHER_Çme
(
ch”
)),

287 
	`EVP_CIPHER_key_Ëngth
(
ch”
è* 8, 
v¬_key_size
,

288 
	`ch”_kt_block_size
(
ch”
è* 8, 
s¦_Úly
);

289 
	}
}

292 
	$show_avaabË_ch”s
()

294 
nid
;

295 
size_t
 
i
;

298 cÚ¡ 
EVP_CIPHER
 *
ch”_li¡
[1000];

299 
size_t
 
num_ch”s
 = 0;

300 #iâdeà
ENABLE_SMALL


301 
	`´štf
("The following ciphers‡nd cipher modes‡re‡vailable for use\n"

302 "w™h " 
PACKAGE_NAME
 ". Each cipher shown below may be use‡s‡\n"

309 
nid
 = 0;‚id < 10000; ++nid)

311 cÚ¡ 
EVP_CIPHER
 *
ch”
 = 
	`EVP_g‘_ch”bynid
(
nid
);

312 ià(
ch”
 && (
	`ch”_kt_mode_cbc
(cipher)

313 #ifdeà
ENABLE_OFB_CFB_MODE


314 || 
	`ch”_kt_mode_ofb_cfb
(
ch”
)

316 #ifdeà
HAVE_AEAD_CIPHER_MODES


317 || 
	`ch”_kt_mode_«ad
(
ch”
)

321 
ch”_li¡
[
num_ch”s
++] = 
ch”
;

323 ià(
num_ch”s
 =ğ((
ch”_li¡
)/(*cipher_list)))

325 
	`msg
(
M_WARN
, "WARNING: Too many ciphers,‚ot showing‡ll");

330 
	`qsÜt
(
ch”_li¡
, 
num_ch”s
, (*ch”_li¡), 
ch”_Çme_cmp
);

332 
i
 = 0; i < 
num_ch”s
; i++) {

333 ià(
	`ch”_kt_block_size
(
ch”_li¡
[
i
]) >= 128/8)

335 
	`´št_ch”
(
ch”_li¡
[
i
]);

339 
	`´štf
("\nThe following ciphers have‡ block size of†esshan 128 bits, \n"

341 
i
 = 0; i < 
num_ch”s
; i++) {

342 ià(
	`ch”_kt_block_size
(
ch”_li¡
[
i
]) < 128/8)

344 
	`´št_ch”
(
ch”_li¡
[
i
]);

347 
	`´štf
("\n");

348 
	}
}

351 
	$show_avaabË_dige¡s
()

353 
nid
;

355 #iâdeà
ENABLE_SMALL


356 
	`´štf
("The following message digests‡re‡vailable for use with\n"

357 
PACKAGE_NAME
 ". A message digest is used in conjunction with\n"

363 
nid
 = 0;‚id < 10000; ++nid)

365 cÚ¡ 
EVP_MD
 *
dige¡
 = 
	`EVP_g‘_dige¡bynid
(
nid
);

366 ià(
dige¡
)

368 
	`´štf
("%s %d bit digest size\n",

369 
	`OBJ_nid2¢
(
nid
), 
	`EVP_MD_size
(
dige¡
) * 8);

372 
	`´štf
("\n");

373 
	}
}

376 
	$show_avaabË_’gšes
()

378 #ià
HAVE_OPENSSL_ENGINE


379 
ENGINE
 *
e
;

381 
	`´štf
("OpenSSL Crypto Engines\n\n");

383 
	`ENGINE_lßd_butš_’gšes
();

385 
e
 = 
	`ENGINE_g‘_fœ¡
();

386 
e
)

388 
	`´štf
("%s [%s]\n",

389 
	`ENGINE_g‘_Çme
(
e
),

390 
	`ENGINE_g‘_id
(
e
));

391 
e
 = 
	`ENGINE_g‘_Ãxt
(e);

393 
	`ENGINE_ş—nup
();

395 
	`´štf
("Sorry, OpenSSL hardware cryptoƒngine functionality is‚ot‡vailable.\n");

397 
	}
}

409 
	$¿nd_by‹s
(
ušt8_t
 *
ouut
, 
Ën
)

411 ià(
	`uÆik–y
(1 !ğ
	`RAND_by‹s
(
ouut
, 
Ën
)))

413 
	`üy±o_msg
(
D_CRYPT_ERRORS
, "RAND_bytes() failed");

417 
	}
}

427 
	$key_des_num_cblocks
(cÚ¡ 
EVP_CIPHER
 *
kt
)

429 
»t
 = 0;

430 cÚ¡ *
Çme
 = 
	`OBJ_nid2¢
(
	`EVP_CIPHER_nid
(
kt
));

431 ià(
Çme
)

433 ià(!
	`¡ºcmp
(
Çme
, "DES-", 4))

435 
»t
 = 
	`EVP_CIPHER_key_Ëngth
(
kt
è/ (
DES_cblock
);

437 ià(!
	`¡ºcmp
(
Çme
, "DESX-", 5))

439 
»t
 = 1;

442 
	`dmsg
(
D_CRYPTO_DEBUG
, "CRYPTO INFO:‚_DES_cblocks=%d", 
»t
);

443  
»t
;

444 
	}
}

446 
boŞ


447 
	$key_des_check
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
)

449 
i
;

450 
bufãr
 
b
;

452 
	`buf_£t_»ad
(&
b
, 
key
, 
key_Ën
);

454 
i
 = 0; i < 
ndc
; ++i)

456 
DES_cblock
 *
dc
 = (DES_cblock *è
	`buf_»ad_®loc
(&
b
, (DES_cblock));

457 ià(!
dc
)

459 
	`üy±o_msg
(
D_CRYPT_ERRORS
,

461 
”r
;

463 ià(
	`DES_is_w—k_key
(
dc
))

465 
	`üy±o_msg
(
D_CRYPT_ERRORS
,

467 
”r
;

469 ià(!
	`DES_check_key_·r™y
(
dc
))

471 
	`üy±o_msg
(
D_CRYPT_ERRORS
,

473 
”r
;

476  
Œue
;

478 
”r
:

479 
	`ERR_ş—r_”rÜ
();

480  
çl£
;

481 
	}
}

484 
	$key_des_fixup
(
ušt8_t
 *
key
, 
key_Ën
, 
ndc
)

486 
i
;

487 
bufãr
 
b
;

489 
	`buf_£t_»ad
(&
b
, 
key
, 
key_Ën
);

490 
i
 = 0; i < 
ndc
; ++i)

492 
DES_cblock
 *
dc
 = (DES_cblock *è
	`buf_»ad_®loc
(&
b
, (DES_cblock));

493 ià(!
dc
)

495 
	`msg
(
D_CRYPT_ERRORS
, "CRYPTO INFO: fixup_key_DES: insufficient key material");

496 
	`ERR_ş—r_”rÜ
();

499 
	`DES_£t_odd_·r™y
(
dc
);

501 
	}
}

511 cÚ¡ 
EVP_CIPHER
 *

512 
	$ch”_kt_g‘
(cÚ¡ *
ch”Çme
)

514 cÚ¡ 
EVP_CIPHER
 *
ch”
 = 
NULL
;

516 
	`ASSERT
(
ch”Çme
);

518 
ch”
 = 
	`EVP_g‘_ch”byÇme
(
ch”Çme
);

520 ià(
NULL
 =ğ
ch”
)

522 
	`üy±o_msg
(
D_LOW
, "Ch”‡lgÜ™hm '%s'‚Ù found", 
ch”Çme
);

523  
NULL
;

527 ià(
	`EVP_CIPHER_key_Ëngth
(
ch”
è> 
MAX_CIPHER_KEY_LENGTH
)

529 
	`msg
(
D_LOW
, "Cipher‡lgorithm '%s' uses‡ default key size (%d bytes) "

530 "which i Ïrg”hª " 
PACKAGE_NAME
 "'s current maximum key size "

531 "(%d by‹s)", 
ch”Çme
, 
	`EVP_CIPHER_key_Ëngth
(
ch”
),

532 
MAX_CIPHER_KEY_LENGTH
);

533  
NULL
;

536  
ch”
;

537 
	}
}

540 
	$ch”_kt_Çme
(cÚ¡ 
EVP_CIPHER
 *
ch”_kt
)

542 ià(
NULL
 =ğ
ch”_kt
)

546  
	`EVP_CIPHER_Çme
(
ch”_kt
);

547 
	}
}

550 
	$ch”_kt_key_size
(cÚ¡ 
EVP_CIPHER
 *
ch”_kt
)

552  
	`EVP_CIPHER_key_Ëngth
(
ch”_kt
);

553 
	}
}

556 
	$ch”_kt_iv_size
(cÚ¡ 
EVP_CIPHER
 *
ch”_kt
)

558  
	`EVP_CIPHER_iv_Ëngth
(
ch”_kt
);

559 
	}
}

562 
	$ch”_kt_block_size
(cÚ¡ 
EVP_CIPHER
 *
ch”
)

570 *
Çme
 = 
NULL
;

571 *
mode_¡r
 = 
NULL
;

572 cÚ¡ *
Üig_Çme
 = 
NULL
;

573 cÚ¡ 
EVP_CIPHER
 *
cbc_ch”
 = 
NULL
;

575 
block_size
 = 
	`EVP_CIPHER_block_size
(
ch”
);

577 
Üig_Çme
 = 
	`ch”_kt_Çme
(
ch”
);

578 ià(!
Üig_Çme
)

580 
ş—nup
;

583 
Çme
 = 
	`¡ršg_®loc
(
	`Œª¦©e_ch”_Çme_to_İ’v²
(
Üig_Çme
), 
NULL
);

584 
mode_¡r
 = 
	`¡¼chr
(
Çme
, '-');

585 ià(!
mode_¡r
 || 
	`¡¾’
(mode_str) < 4)

587 
ş—nup
;

590 
	`¡rıy
(
mode_¡r
, "-CBC");

592 
cbc_ch”
 = 
	`EVP_g‘_ch”byÇme
(
	`Œª¦©e_ch”_Çme_äom_İ’v²
(
Çme
));

593 ià(
cbc_ch”
)

595 
block_size
 = 
	`EVP_CIPHER_block_size
(
cbc_ch”
);

598 
ş—nup
:

599 
	`ä“
(
Çme
);

600  
block_size
;

601 
	}
}

604 
	$ch”_kt_g_size
(cÚ¡ 
EVP_CIPHER
 *
ch”_kt
)

606 ià(
	`ch”_kt_mode_«ad
(
ch”_kt
))

608  
OPENVPN_AEAD_TAG_LENGTH
;

614 
	}
}

617 
	$ch”_kt_mode
(cÚ¡ 
EVP_CIPHER
 *
ch”_kt
)

619 
	`ASSERT
(
NULL
 !ğ
ch”_kt
);

620  
	`EVP_CIPHER_mode
(
ch”_kt
);

621 
	}
}

623 
boŞ


624 
	$ch”_kt_mode_cbc
(cÚ¡ 
ch”_kt_t
 *
ch”
)

626  
ch”
 && 
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_CBC


627 #ifdeà
EVP_CIPH_FLAG_AEAD_CIPHER


629 && !(
	`EVP_CIPHER_æags
(
ch”
è& 
EVP_CIPH_FLAG_AEAD_CIPHER
)

632 
	}
}

634 
boŞ


635 
	$ch”_kt_mode_ofb_cfb
(cÚ¡ 
ch”_kt_t
 *
ch”
)

637  
ch”
 && (
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_OFB


638 || 
	`ch”_kt_mode
(
ch”
è=ğ
OPENVPN_MODE_CFB
)

639 #ifdeà
EVP_CIPH_FLAG_AEAD_CIPHER


641 && !(
	`EVP_CIPHER_æags
(
ch”
è& 
EVP_CIPH_FLAG_AEAD_CIPHER
)

644 
	}
}

646 
boŞ


647 
	$ch”_kt_mode_«ad
(cÚ¡ 
ch”_kt_t
 *
ch”
)

649 #ifdeà
HAVE_AEAD_CIPHER_MODES


650  
ch”
 && (
	`ch”_kt_mode
(ch”è=ğ
OPENVPN_MODE_GCM
);

652  
çl£
;

654 
	}
}

662 
ch”_ùx_t
 *

663 
	$ch”_ùx_Ãw
()

665 
EVP_CIPHER_CTX
 *
ùx
 = 
	`EVP_CIPHER_CTX_Ãw
();

666 
	`check_m®loc_»tuº
(
ùx
);

667  
ùx
;

668 
	}
}

671 
	$ch”_ùx_ä“
(
EVP_CIPHER_CTX
 *
ùx
)

673 
	`EVP_CIPHER_CTX_ä“
(
ùx
);

674 
	}
}

677 
	$ch”_ùx_š™
(
EVP_CIPHER_CTX
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ën
,

678 cÚ¡ 
EVP_CIPHER
 *
kt
, 
’c
)

680 
	`ASSERT
(
NULL
 !ğ
kt
 && NULL !ğ
ùx
);

682 
	`EVP_CIPHER_CTX_š™
(
ùx
);

683 ià(!
	`EVP_Ch”In™
(
ùx
, 
kt
, 
NULL
, NULL, 
’c
))

685 
	`üy±o_msg
(
M_FATAL
, "EVP cipher init #1");

687 #ifdeà
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


688 ià(!
	`EVP_CIPHER_CTX_£t_key_Ëngth
(
ùx
, 
key_Ën
))

690 
	`üy±o_msg
(
M_FATAL
, "EVP set key size");

693 ià(!
	`EVP_Ch”In™_ex
(
ùx
, 
NULL
, NULL, 
key
, NULL, 
’c
))

695 
	`üy±o_msg
(
M_FATAL
, "EVP cipher init #2");

699 
	`ASSERT
(
	`EVP_CIPHER_CTX_key_Ëngth
(
ùx
è<ğ
key_Ën
);

700 
	}
}

703 
	$ch”_ùx_ş—nup
(
EVP_CIPHER_CTX
 *
ùx
)

705 
	`EVP_CIPHER_CTX_ş—nup
(
ùx
);

706 
	}
}

709 
	$ch”_ùx_iv_Ëngth
(cÚ¡ 
EVP_CIPHER_CTX
 *
ùx
)

711  
	`EVP_CIPHER_CTX_iv_Ëngth
(
ùx
);

712 
	}
}

715 
	$ch”_ùx_g‘_g
(
EVP_CIPHER_CTX
 *
ùx
, 
ušt8_t
 *
g_buf
, 
g_size
)

717 #ifdeà
HAVE_AEAD_CIPHER_MODES


718  
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_GET_TAG
, 
g_size
, 
g_buf
);

720 
	`ASSERT
(0);

722 
	}
}

725 
	$ch”_ùx_block_size
(cÚ¡ 
EVP_CIPHER_CTX
 *
ùx
)

727  
	`EVP_CIPHER_CTX_block_size
(
ùx
);

728 
	}
}

731 
	$ch”_ùx_mode
(cÚ¡ 
EVP_CIPHER_CTX
 *
ùx
)

733  
	`EVP_CIPHER_CTX_mode
(
ùx
);

734 
	}
}

736 cÚ¡ 
ch”_kt_t
 *

737 
	$ch”_ùx_g‘_ch”_kt
(cÚ¡ 
ch”_ùx_t
 *
ùx
)

739  
ùx
 ? 
	`EVP_CIPHER_CTX_ch”
(ùxè: 
NULL
;

740 
	}
}

744 
	$ch”_ùx_»£t
(
EVP_CIPHER_CTX
 *
ùx
, 
ušt8_t
 *
iv_buf
)

746  
	`EVP_Ch”In™_ex
(
ùx
, 
NULL
, NULL, NULL, 
iv_buf
, -1);

747 
	}
}

750 
	$ch”_ùx_upd©e_ad
(
EVP_CIPHER_CTX
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

752 #ifdeà
HAVE_AEAD_CIPHER_MODES


753 
Ën
;

754 ià(!
	`EVP_Ch”Upd©e
(
ùx
, 
NULL
, &
Ën
, 
¤c
, 
¤c_Ën
))

756 
	`üy±o_msg
(
M_FATAL
, "%s: EVP_Ch”Upd©e(èçed", 
__func__
);

760 
	`ASSERT
(0);

762 
	}
}

765 
	$ch”_ùx_upd©e
(
EVP_CIPHER_CTX
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
,

766 
ušt8_t
 *
¤c
, 
¤c_Ën
)

768 ià(!
	`EVP_Ch”Upd©e
(
ùx
, 
d¡
, 
d¡_Ën
, 
¤c
, 
¤c_Ën
))

770 
	`üy±o_msg
(
M_FATAL
, "%s: EVP_Ch”Upd©e(èçed", 
__func__
);

773 
	}
}

776 
	$ch”_ùx_fš®
(
EVP_CIPHER_CTX
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
)

778  
	`EVP_Ch”Fš®
(
ùx
, 
d¡
, 
d¡_Ën
);

779 
	}
}

782 
	$ch”_ùx_fš®_check_g
(
EVP_CIPHER_CTX
 *
ùx
, 
ušt8_t
 *
d¡
, *
d¡_Ën
,

783 
ušt8_t
 *
g
, 
size_t
 
g_Ën
)

785 #ifdeà
HAVE_AEAD_CIPHER_MODES


786 
	`ASSERT
(
g_Ën
 < 
SIZE_MAX
);

787 ià(!
	`EVP_CIPHER_CTX_ù¾
(
ùx
, 
EVP_CTRL_GCM_SET_TAG
, 
g_Ën
, 
g
))

792  
	`ch”_ùx_fš®
(
ùx
, 
d¡
, 
d¡_Ën
);

794 
	`ASSERT
(0);

796 
	}
}

799 
	$ch”_des_’üy±_ecb
(cÚ¡ 
key
[
DES_KEY_LENGTH
],

800 *
¤c
,

801 *
d¡
)

803 
DES_key_scheduË
 
sched
;

805 
	`DES_£t_key_unchecked
((
DES_cblock
 *)
key
, &
sched
);

806 
	`DES_ecb_’üy±
((
DES_cblock
 *)
¤c
, (DES_cblock *)
d¡
, &
sched
, 
DES_ENCRYPT
);

807 
	}
}

816 cÚ¡ 
EVP_MD
 *

817 
	$md_kt_g‘
(cÚ¡ *
dige¡
)

819 cÚ¡ 
EVP_MD
 *
md
 = 
NULL
;

820 
	`ASSERT
(
dige¡
);

821 
md
 = 
	`EVP_g‘_dige¡byÇme
(
dige¡
);

822 ià(!
md
)

824 
	`üy±o_msg
(
M_FATAL
, "Mes§ghash‡lgÜ™hm '%s'‚Ù found", 
dige¡
);

826 ià(
	`EVP_MD_size
(
md
è> 
MAX_HMAC_KEY_LENGTH
)

828 
	`üy±o_msg
(
M_FATAL
, "Message hash‡lgorithm '%s' uses‡ default hash "

829 "siz(%d by‹sèwhich i Ïrg”hª " 
PACKAGE_NAME
 "'s current "

831 
dige¡
, 
	`EVP_MD_size
(
md
), 
MAX_HMAC_KEY_LENGTH
);

833  
md
;

834 
	}
}

837 
	$md_kt_Çme
(cÚ¡ 
EVP_MD
 *
kt
)

839 ià(
NULL
 =ğ
kt
)

843  
	`EVP_MD_Çme
(
kt
);

844 
	}
}

847 
	$md_kt_size
(cÚ¡ 
EVP_MD
 *
kt
)

849  
	`EVP_MD_size
(
kt
);

850 
	}
}

860 
	$md_fuÎ
(cÚ¡ 
EVP_MD
 *
kt
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
, ušt8_ˆ*
d¡
)

862 
š_md_Ën
 = 0;

864  
	`EVP_Dige¡
(
¤c
, 
¤c_Ën
, 
d¡
, &
š_md_Ën
, 
kt
, 
NULL
);

865 
	}
}

867 
EVP_MD_CTX
 *

868 
	$md_ùx_Ãw
()

870 
EVP_MD_CTX
 *
ùx
 = 
	`EVP_MD_CTX_Ãw
();

871 
	`check_m®loc_»tuº
(
ùx
);

872  
ùx
;

873 
	}
}

875 
	$md_ùx_ä“
(
EVP_MD_CTX
 *
ùx
)

877 
	`EVP_MD_CTX_ä“
(
ùx
);

878 
	}
}

881 
	$md_ùx_š™
(
EVP_MD_CTX
 *
ùx
, cÚ¡ 
EVP_MD
 *
kt
)

883 
	`ASSERT
(
NULL
 !ğ
ùx
 && NULL !ğ
kt
);

885 
	`EVP_MD_CTX_š™
(
ùx
);

886 
	`EVP_Dige¡In™
(
ùx
, 
kt
);

887 
	}
}

890 
	$md_ùx_ş—nup
(
EVP_MD_CTX
 *
ùx
)

892 
	`EVP_MD_CTX_»£t
(
ùx
);

893 
	}
}

896 
	$md_ùx_size
(cÚ¡ 
EVP_MD_CTX
 *
ùx
)

898  
	`EVP_MD_CTX_size
(
ùx
);

899 
	}
}

902 
	$md_ùx_upd©e
(
EVP_MD_CTX
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

904 
	`EVP_Dige¡Upd©e
(
ùx
, 
¤c
, 
¤c_Ën
);

905 
	}
}

908 
	$md_ùx_fš®
(
EVP_MD_CTX
 *
ùx
, 
ušt8_t
 *
d¡
)

910 
š_md_Ën
 = 0;

912 
	`EVP_Dige¡Fš®
(
ùx
, 
d¡
, &
š_md_Ën
);

913 
	}
}

922 
HMAC_CTX
 *

923 
	$hmac_ùx_Ãw
()

925 
HMAC_CTX
 *
ùx
 = 
	`HMAC_CTX_Ãw
();

926 
	`check_m®loc_»tuº
(
ùx
);

927  
ùx
;

928 
	}
}

931 
	$hmac_ùx_ä“
(
HMAC_CTX
 *
ùx
)

933 
	`HMAC_CTX_ä“
(
ùx
);

934 
	}
}

937 
	$hmac_ùx_š™
(
HMAC_CTX
 *
ùx
, cÚ¡ 
ušt8_t
 *
key
, 
key_Ën
,

938 cÚ¡ 
EVP_MD
 *
kt
)

940 
	`ASSERT
(
NULL
 !ğ
kt
 && NULL !ğ
ùx
);

942 
	`HMAC_CTX_»£t
(
ùx
);

943 
	`HMAC_In™_ex
(
ùx
, 
key
, 
key_Ën
, 
kt
, 
NULL
);

946 
	`ASSERT
(
	`HMAC_size
(
ùx
è<ğ
key_Ën
);

947 
	}
}

950 
	$hmac_ùx_ş—nup
(
HMAC_CTX
 *
ùx
)

952 
	`HMAC_CTX_»£t
(
ùx
);

953 
	}
}

956 
	$hmac_ùx_size
(cÚ¡ 
HMAC_CTX
 *
ùx
)

958  
	`HMAC_size
(
ùx
);

959 
	}
}

962 
	$hmac_ùx_»£t
(
HMAC_CTX
 *
ùx
)

964 
	`HMAC_In™_ex
(
ùx
, 
NULL
, 0, NULL, NULL);

965 
	}
}

968 
	$hmac_ùx_upd©e
(
HMAC_CTX
 *
ùx
, cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_Ën
)

970 
	`HMAC_Upd©e
(
ùx
, 
¤c
, 
¤c_Ën
);

971 
	}
}

974 
	$hmac_ùx_fš®
(
HMAC_CTX
 *
ùx
, 
ušt8_t
 *
d¡
)

976 
š_hmac_Ën
 = 0;

978 
	`HMAC_Fš®
(
ùx
, 
d¡
, &
š_hmac_Ën
);

979 
	}
}

	@crypto_openssl.h

29 #iâdeà
CRYPTO_OPENSSL_H_


30 
	#CRYPTO_OPENSSL_H_


	)

32 
	~<İ’s¦/evp.h
>

33 
	~<İ’s¦/hmac.h
>

34 
	~<İ’s¦/md5.h
>

35 
	~<İ’s¦/sha.h
>

38 
EVP_CIPHER
 
	tch”_kt_t
;

41 
EVP_MD
 
	tmd_kt_t
;

44 
EVP_CIPHER_CTX
 
	tch”_ùx_t
;

47 
EVP_MD_CTX
 
	tmd_ùx_t
;

50 
HMAC_CTX
 
	thmac_ùx_t
;

53 
	#OPENVPN_MAX_IV_LENGTH
 
EVP_MAX_IV_LENGTH


	)

56 
	#OPENVPN_MODE_CBC
 
EVP_CIPH_CBC_MODE


	)

59 
	#OPENVPN_MODE_OFB
 
EVP_CIPH_OFB_MODE


	)

62 
	#OPENVPN_MODE_CFB
 
EVP_CIPH_CFB_MODE


	)

64 #ifdeà
HAVE_AEAD_CIPHER_MODES


67 
	#OPENVPN_MODE_GCM
 
EVP_CIPH_GCM_MODE


	)

72 
	#OPENVPN_OP_ENCRYPT
 1

	)

75 
	#OPENVPN_OP_DECRYPT
 0

	)

77 
	#DES_KEY_LENGTH
 8

	)

78 
	#MD4_DIGEST_LENGTH
 16

	)

87 
üy±o_´št_İ’s¦_”rÜs
(cÚ¡ 
æags
);

98 
	#üy±o_msg
(
æags
, ...) \

100 
	`üy±o_´št_İ’s¦_”rÜs
(
	`nÚçl
(
æags
)); \

101 
	`msg
((
æags
), 
__VA_ARGS__
); \

102 } 
çl£
)

	)

	@cryptoapi.c

31 #ifdeà
HAVE_CONFIG_H


32 
	~"cÚfig.h
"

33 #–ià
defšed
(
_MSC_VER
)

34 
	~"cÚfig-msvc.h
"

37 
	~"sysh—d.h
"

39 #ifdeà
ENABLE_CRYPTOAPI


41 
	~<İ’s¦/s¦.h
>

42 
	~<İ’s¦/”r.h
>

43 
	~<wšdows.h
>

44 
	~<wšüy±.h
>

45 
	~<nüy±.h
>

46 
	~<¡dio.h
>

47 
	~<ùy³.h
>

48 
	~<as£¹.h
>

50 
	~"bufãr.h
"

51 
	~"İ’s¦_com·t.h
"

56 #iâdeà
CERT_SYSTEM_STORE_LOCATION_SHIFT


57 
	#CERT_SYSTEM_STORE_LOCATION_SHIFT
 16

	)

59 #iâdeà
CERT_SYSTEM_STORE_CURRENT_USER_ID


60 
	#CERT_SYSTEM_STORE_CURRENT_USER_ID
 1

	)

62 #iâdeà
CERT_SYSTEM_STORE_CURRENT_USER


63 
	#CERT_SYSTEM_STORE_CURRENT_USER
 (
CERT_SYSTEM_STORE_CURRENT_USER_ID
 << 
CERT_SYSTEM_STORE_LOCATION_SHIFT
)

	)

65 #iâdeà
CERT_STORE_READONLY_FLAG


66 
	#CERT_STORE_READONLY_FLAG
 0x00008000

	)

68 #iâdeà
CERT_STORE_OPEN_EXISTING_FLAG


69 
	#CERT_STORE_OPEN_EXISTING_FLAG
 0x00004000

	)

73 
	#SSL_SIG_LENGTH
 36

	)

76 
	#ERR_LIB_CRYPTOAPI
 (
ERR_LIB_USER
 + 69è

	)

77 
	#CRYPTOAPI”r
(
f
è
	`”r_put_ms_”rÜ
(
	`G‘La¡E¼Ü
(), (f), 
__FILE__
, 
__LINE__
)

	)

78 
	#CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
 100

	)

79 
	#CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
 101

	)

80 
	#CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
 102

	)

81 
	#CRYPTOAPI_F_CRYPT_CREATE_HASH
 103

	)

82 
	#CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
 104

	)

83 
	#CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
 105

	)

84 
	#CRYPTOAPI_F_CRYPT_SIGN_HASH
 106

	)

85 
	#CRYPTOAPI_F_LOAD_LIBRARY
 107

	)

86 
	#CRYPTOAPI_F_GET_PROC_ADDRESS
 108

	)

87 
	#CRYPTOAPI_F_NCRYPT_SIGN_HASH
 109

	)

89 
ERR_STRING_DATA
 
	gCRYPTOAPI_¡r_funùs
[] = {

90 { 
ERR_PACK
(
ERR_LIB_CRYPTOAPI
, 0, 0), "microsoft cryptoapi"},

91 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
, 0), "CertOpenSystemStore" },

92 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
, 0), "CertFindCertificateInStore" },

93 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
, 0), "CryptAcquireCertificatePrivateKey" },

94 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_CREATE_HASH
, 0), "CryptCreateHash" },

95 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
, 0), "CryptGetHashParam" },

96 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
, 0), "CryptSetHashParam" },

97 { 
ERR_PACK
(0, 
CRYPTOAPI_F_CRYPT_SIGN_HASH
, 0), "CryptSignHash" },

98 { 
ERR_PACK
(0, 
CRYPTOAPI_F_LOAD_LIBRARY
, 0), "LoadLibrary" },

99 { 
ERR_PACK
(0, 
CRYPTOAPI_F_GET_PROC_ADDRESS
, 0), "GetProcAddress" },

100 { 
ERR_PACK
(0, 
CRYPTOAPI_F_NCRYPT_SIGN_HASH
, 0), "NCryptSignHash" },

101 { 0, 
NULL
 }

104 
	s_CAPI_DATA
 {

105 cÚ¡ 
CERT_CONTEXT
 *
	mû¹_cÚ‹xt
;

106 
HCRYPTPROV_OR_NCRYPT_KEY_HANDLE
 
	müy±_´ov
;

107 
DWORD
 
	mkey_¥ec
;

108 
BOOL
 
	mä“_üy±_´ov
;

109 } 
	tCAPI_DATA
;

112 
	$ms_”rÜ_‹xt
(
DWORD
 
ms_”r
)

114 
LPVOID
 
ÍMsgBuf
 = 
NULL
;

115 *
rv
 = 
NULL
;

117 
	`FÜm©Mes§ge
(

118 
FORMAT_MESSAGE_ALLOCATE_BUFFER


119 |
FORMAT_MESSAGE_FROM_SYSTEM


120 |
FORMAT_MESSAGE_IGNORE_INSERTS
,

121 
NULL
, 
ms_”r
,

122 
	`MAKELANGID
(
LANG_NEUTRAL
, 
SUBLANG_DEFAULT
),

123 (
LPTSTR
è&
ÍMsgBuf
, 0, 
NULL
);

124 ià(
ÍMsgBuf
)

126 *
p
;

127 
rv
 = 
	`¡ršg_®loc
(
ÍMsgBuf
, 
NULL
);

128 
	`LoÿlF»e
(
ÍMsgBuf
);

130 ià(
rv
)

132 
p
 = 
rv
 + 
	`¡¾’
(rv) - 1;… >=„v;…--) {

133 ià(
	`is¥aû
(*
p
))

135 *
p
 = '\0';

144  
rv
;

145 
	}
}

148 
	$”r_put_ms_”rÜ
(
DWORD
 
ms_”r
, 
func
, cÚ¡ *
fe
, 
lše
)

150 
š™
 = 0;

151 
	#ERR_MAP_SZ
 16

	)

153 
”r
;

154 
DWORD
 
ms_”r
;

155 } 
”r_m­
[
ERR_MAP_SZ
];

156 
i
;

158 ià(
ms_”r
 == 0)

163 ià(!
š™
)

165 
	`ERR_lßd_¡ršgs
(
ERR_LIB_CRYPTOAPI
, 
CRYPTOAPI_¡r_funùs
);

166 
	`mem£t
(&
”r_m­
, 0, (err_map));

167 
š™
++;

171 
i
 = 0; i < 
ERR_MAP_SZ
; i++) {

172 ià(
”r_m­
[
i
].
ms_”r
 == ms_err)

174 
	`ERR_PUT_”rÜ
(
ERR_LIB_CRYPTOAPI
, 
func
, 
”r_m­
[
i
].
”r
, 
fe
, 
lše
);

177 ià(
”r_m­
[
i
].
ms_”r
 == 0)

180 
ERR_STRING_DATA
 *
esd
 = 
	`ÿÎoc
(2, (*esd));

181 ià(
esd
 =ğ
NULL
)

185 
”r_m­
[
i
].
ms_”r
 = ms_err;

186 
”r_m­
[
i
].
”r
 = 
esd
->
”rÜ
 = i + 100;

187 
esd
->
¡ršg
 = 
	`ms_”rÜ_‹xt
(
ms_”r
);

188 
	`check_m®loc_»tuº
(
esd
->
¡ršg
);

189 
	`ERR_lßd_¡ršgs
(
ERR_LIB_CRYPTOAPI
, 
esd
);

190 
	`ERR_PUT_”rÜ
(
ERR_LIB_CRYPTOAPI
, 
func
, 
”r_m­
[
i
].
”r
, 
fe
, 
lše
);

194 
	}
}

198 
	$r§_pub_’c
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

201 
	`as£¹
(0);

204 
	}
}

208 
	$r§_pub_dec
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

211 
	`as£¹
(0);

214 
	}
}

225 
	$´iv_’c_CNG
(cÚ¡ 
CAPI_DATA
 *
cd
, cÚ¡ 
wch¬_t
 *
hash_®go
, cÚ¡ *
äom
,

226 
æ’
, *
to
, 
’
, 
·ddšg
)

228 
NCRYPT_KEY_HANDLE
 
hkey
 = 
cd
->
üy±_´ov
;

229 
DWORD
 
Ën
 = 0;

230 
	`ASSERT
(
cd
->
key_¥ec
 =ğ
CERT_NCRYPT_KEY_SPEC
);

232 
	`msg
(
D_LOW
, "Signšg hash usšg CNG: d©¨sizğ%d", 
æ’
);

234 
BCRYPT_PKCS1_PADDING_INFO
 
·dšfo
 = {
hash_®go
};

235 
DWORD
 
¡©us
;

237 
¡©us
 = 
	`NCry±SignHash
(
hkey
, 
·ddšg
? &
·dšfo
 : 
NULL
, (
BYTE
*è
äom
, 
æ’
,

238 
to
, 
’
, &
Ën
, 
·ddšg
? 
BCRYPT_PAD_PKCS1
 : 0);

239 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

241 
	`S‘La¡E¼Ü
(
¡©us
);

242 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_NCRYPT_SIGN_HASH
);

243 
Ën
 = 0;

247  
Ën
;

248 
	}
}

252 
	$r§_´iv_’c
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

254 
CAPI_DATA
 *
cd
 = (CAPI_DATA *è
	`RSA_m‘h_g‘0_­p_d©a
(
	`RSA_g‘_m‘hod
(
r§
));

255 
HCRYPTHASH
 
hash
;

256 
DWORD
 
hash_size
, 
Ën
, 
i
;

257 *
buf
;

259 ià(
cd
 =ğ
NULL
)

261 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
ERR_R_PASSED_NULL_PARAMETER
);

264 ià(
·ddšg
 !ğ
RSA_PKCS1_PADDING
)

267 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
RSA_R_UNKNOWN_PADDING_TYPE
);

270 ià(
cd
->
key_¥ec
 =ğ
CERT_NCRYPT_KEY_SPEC
)

272  
	`´iv_’c_CNG
(
cd
, 
NULL
, 
äom
, 
æ’
, 
to
, 
	`RSA_size
(
r§
), 
·ddšg
);

280 ià(
æ’
 !ğ
SSL_SIG_LENGTH
)

282 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
RSA_R_INVALID_MESSAGE_LENGTH
);

285 ià(!
	`Cry±C»©eHash
(
cd
->
üy±_´ov
, 
CALG_SSL3_SHAMD5
, 0, 0, &
hash
))

287 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CRYPT_CREATE_HASH
);

290 
Ën
 = (
hash_size
);

291 ià(!
	`Cry±G‘HashP¬am
(
hash
, 
HP_HASHSIZE
, (
BYTE
 *è&
hash_size
, &
Ën
, 0))

293 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CRYPT_GET_HASH_PARAM
);

294 
	`Cry±De¡royHash
(
hash
);

297 ià((è
hash_size
 !ğ
æ’
)

299 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
RSA_R_INVALID_MESSAGE_LENGTH
);

300 
	`Cry±De¡royHash
(
hash
);

303 ià(!
	`Cry±S‘HashP¬am
(
hash
, 
HP_HASHVAL
, (
BYTE
 * ) 
äom
, 0))

305 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CRYPT_SET_HASH_PARAM
);

306 
	`Cry±De¡royHash
(
hash
);

310 
Ën
 = 
	`RSA_size
(
r§
);

311 
buf
 = 
	`m®loc
(
Ën
);

312 ià(
buf
 =ğ
NULL
)

314 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
ERR_R_MALLOC_FAILURE
);

315 
	`Cry±De¡royHash
(
hash
);

318 ià(!
	`Cry±SignHash
(
hash
, 
cd
->
key_¥ec
, 
NULL
, 0, 
buf
, &
Ën
))

320 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CRYPT_SIGN_HASH
);

321 
	`Cry±De¡royHash
(
hash
);

322 
	`ä“
(
buf
);

326 
i
 = 0; i < 
Ën
; i++)

328 
to
[
i
] = 
buf
[
Ën
 - i - 1];

330 
	`ä“
(
buf
);

332 
	`Cry±De¡royHash
(
hash
);

333  
Ën
;

334 
	}
}

344 
	$r§_sign_CNG
(
ty³
, cÚ¡ *
m
, 
m_Ën
,

345 *
sig
, *
sigËn
, cÚ¡ 
RSA
 *
r§
)

347 
CAPI_DATA
 *
cd
 = (CAPI_DATA *è
	`RSA_m‘h_g‘0_­p_d©a
(
	`RSA_g‘_m‘hod
(
r§
));

348 cÚ¡ 
wch¬_t
 *
®g
 = 
NULL
;

349 
·ddšg
 = 
RSA_PKCS1_PADDING
;

351 *
sigËn
 = 0;

352 ià(
cd
 =ğ
NULL
)

354 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
ERR_R_PASSED_NULL_PARAMETER
);

358 
ty³
)

360 
NID_md5
:

361 
®g
 = 
BCRYPT_MD5_ALGORITHM
;

364 
NID_sha1
:

365 
®g
 = 
BCRYPT_SHA1_ALGORITHM
;

368 
NID_sha256
:

369 
®g
 = 
BCRYPT_SHA256_ALGORITHM
;

372 
NID_sha384
:

373 
®g
 = 
BCRYPT_SHA384_ALGORITHM
;

376 
NID_sha512
:

377 
®g
 = 
BCRYPT_SHA512_ALGORITHM
;

380 
NID_md5_sha1
:

381 ià(
m_Ën
 !ğ
SSL_SIG_LENGTH
)

383 
	`RSA”r
(
RSA_F_RSA_SIGN
, 
RSA_R_INVALID_MESSAGE_LENGTH
);

387 
®g
 = 
NULL
;

390 
	`msg
(
M_WARN
, "üy±ßpiû¹: UnknowÀhashy³ NID=0x%x", 
ty³
);

391 
	`RSA”r
(
RSA_F_RSA_SIGN
, 
RSA_R_UNKNOWN_ALGORITHM_TYPE
);

395 *
sigËn
 = 
	`´iv_’c_CNG
(
cd
, 
®g
, 
m
, ()
m_Ën
, 
sig
, 
	`RSA_size
(
r§
), 
·ddšg
);

396  (
sigËn
 == 0) ? 0 : 1;

397 
	}
}

401 
	$r§_´iv_dec
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

404 
	`as£¹
(0);

407 
	}
}

411 
	$š™
(
RSA
 *
r§
)

415 
	}
}

419 
	$fšish
(
RSA
 *
r§
)

421 cÚ¡ 
RSA_METHOD
 *
r§_m‘h
 = 
	`RSA_g‘_m‘hod
(
r§
);

422 
CAPI_DATA
 *
cd
 = (CAPI_DATA *è
	`RSA_m‘h_g‘0_­p_d©a
(
r§_m‘h
);

424 ià(
cd
 =ğ
NULL
)

428 ià(
cd
->
üy±_´ov
 && cd->
ä“_üy±_´ov
)

430 ià(
cd
->
key_¥ec
 =ğ
CERT_NCRYPT_KEY_SPEC
)

432 
	`NCry±F»eObjeù
(
cd
->
üy±_´ov
);

436 
	`Cry±R–—£CÚ‹xt
(
cd
->
üy±_´ov
, 0);

439 ià(
cd
->
û¹_cÚ‹xt
)

441 
	`C”tF»eC”tifiÿ‹CÚ‹xt
(
cd
->
û¹_cÚ‹xt
);

443 
	`ä“
(
cd
);

444 
	`RSA_m‘h_ä“
((
RSA_METHOD
*è
r§_m‘h
);

446 
	}
}

448 cÚ¡ 
CERT_CONTEXT
 *

449 
	$fšd_û¹ifiÿ‹_š_¡Üe
(cÚ¡ *
û¹_´İ
, 
HCERTSTORE
 
û¹_¡Üe
)

457 cÚ¡ 
CERT_CONTEXT
 *
rv
 = 
NULL
;

459 ià(!
	`¡ºcmp
(
û¹_´İ
, "SUBJ:", 5))

462 
û¹_´İ
 += 5;

463 
rv
 = 
	`C”tFšdC”tifiÿ‹InStÜe
(
û¹_¡Üe
, 
X509_ASN_ENCODING
 | 
PKCS_7_ASN_ENCODING
,

464 0, 
CERT_FIND_SUBJECT_STR_A
, 
û¹_´İ
, 
NULL
);

467 ià(!
	`¡ºcmp
(
û¹_´İ
, "THUMB:", 6))

469 
hash
[255];

470 *
p
;

471 
i
, 
x
 = 0;

472 
CRYPT_HASH_BLOB
 
blob
;

475 
û¹_´İ
 += 6;

476 
p
 = (*è
û¹_´İ
, 
i
 = 0; *°&& i < (
hash
); i++) {

477 ià(*
p
 >= '0' && *p <= '9')

479 
x
 = (*
p
 - '0') << 4;

481 ià(*
p
 >= 'A' && *p <= 'F')

483 
x
 = (*
p
 - 'A' + 10) << 4;

485 ià(*
p
 >= 'a' && *p <= 'f')

487 
x
 = (*
p
 - 'a' + 10) << 4;

489 ià(!*++
p
)

493 ià(*
p
 >= '0' && *p <= '9')

495 
x
 +ğ*
p
 - '0';

497 ià(*
p
 >= 'A' && *p <= 'F')

499 
x
 +ğ*
p
 - 'A' + 10;

501 ià(*
p
 >= 'a' && *p <= 'f')

503 
x
 +ğ*
p
 - 'a' + 10;

505 
hash
[
i
] = 
x
;

507 
p
++; *p && *p == ' ';…++)

511 
blob
.
cbD©a
 = 
i
;

512 
blob
.
pbD©a
 = (*è&
hash
;

513 
rv
 = 
	`C”tFšdC”tifiÿ‹InStÜe
(
û¹_¡Üe
, 
X509_ASN_ENCODING
 | 
PKCS_7_ASN_ENCODING
,

514 0, 
CERT_FIND_HASH
, &
blob
, 
NULL
);

518  
rv
;

519 
	}
}

522 
	$SSL_CTX_u£_Cry±oAPI_û¹ifiÿ‹
(
SSL_CTX
 *
s¦_ùx
, cÚ¡ *
û¹_´İ
)

524 
HCERTSTORE
 
cs
;

525 
X509
 *
û¹
 = 
NULL
;

526 
RSA
 *
r§
 = 
NULL
, *
pub_r§
;

527 
CAPI_DATA
 *
cd
 = 
	`ÿÎoc
(1, (*cd));

528 
RSA_METHOD
 *
my_r§_m‘hod
 = 
NULL
;

530 ià(
cd
 =ğ
NULL
)

532 
	`SSL”r
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_MALLOC_FAILURE
);

533 
”r
;

536 
cs
 = 
	`C”tO³nStÜe
((
LPCSTR
è
CERT_STORE_PROV_SYSTEM
, 0, 0, 
CERT_SYSTEM_STORE_CURRENT_USER


537 |
CERT_STORE_OPEN_EXISTING_FLAG
 | 
CERT_STORE_READONLY_FLAG
, 
L
"MY");

538 ià(
cs
 =ğ
NULL
)

540 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
);

541 
”r
;

543 
cd
->
û¹_cÚ‹xt
 = 
	`fšd_û¹ifiÿ‹_š_¡Üe
(
û¹_´İ
, 
cs
);

544 
	`C”tClo£StÜe
(
cs
, 0);

545 ià(!
cd
->
û¹_cÚ‹xt
)

547 
cs
 = 
	`C”tO³nStÜe
((
LPCSTR
è
CERT_STORE_PROV_SYSTEM
, 0, 0, 
CERT_SYSTEM_STORE_LOCAL_MACHINE


548 |
CERT_STORE_OPEN_EXISTING_FLAG
 | 
CERT_STORE_READONLY_FLAG
, 
L
"MY");

549 ià(
cs
 =ğ
NULL
)

551 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CERT_OPEN_SYSTEM_STORE
);

552 
”r
;

554 
cd
->
û¹_cÚ‹xt
 = 
	`fšd_û¹ifiÿ‹_š_¡Üe
(
û¹_´İ
, 
cs
);

555 
	`C”tClo£StÜe
(
cs
, 0);

556 ià(
cd
->
û¹_cÚ‹xt
 =ğ
NULL
)

558 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CERT_FIND_CERTIFICATE_IN_STORE
);

559 
”r
;

564 
û¹
 = 
	`d2i_X509
(
NULL
, (cÚ¡ **è&
cd
->
û¹_cÚ‹xt
->
pbC”tEncoded
,

565 
cd
->
û¹_cÚ‹xt
->
cbC”tEncoded
);

566 ià(
û¹
 =ğ
NULL
)

568 
	`SSL”r
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_ASN1_LIB
);

569 
”r
;

574 
DWORD
 
æags
 = 
CRYPT_ACQUIRE_COMPARE_KEY_FLAG


575 | 
CRYPT_ACQUIRE_PREFER_NCRYPT_KEY_FLAG
;

576 ià(!
	`Cry±AcquœeC”tifiÿ‹Priv©eKey
(
cd
->
û¹_cÚ‹xt
, 
æags
, 
NULL
,

577 &
cd
->
üy±_´ov
, &cd->
key_¥ec
, &cd->
ä“_üy±_´ov
))

582 
	`CRYPTOAPI”r
(
CRYPTOAPI_F_CRYPT_ACQUIRE_CERTIFICATE_PRIVATE_KEY
);

583 
”r
;

589 
max_v”siÚ
 = 
	`SSL_CTX_g‘_max_´Ùo_v”siÚ
(
s¦_ùx
);

590 ià((!
max_v”siÚ
 || max_v”siÚ > 
TLS1_1_VERSION
)

591 && 
cd
->
key_¥ec
 !ğ
CERT_NCRYPT_KEY_SPEC
)

593 
	`msg
(
M_WARN
, "WARNING: cryptoapicert:…rivate key is in‡†egacy store."

595 ià(
	`SSL_CTX_g‘_mš_´Ùo_v”siÚ
(
s¦_ùx
è> 
TLS1_1_VERSION
)

597 
	`msg
(
M_NONFATAL
,

600 
”r
;

602 ià(!
	`SSL_CTX_£t_max_´Ùo_v”siÚ
(
s¦_ùx
, 
TLS1_1_VERSION
))

604 
	`msg
(
M_NONFATAL
, "ERROR: cryptoapicert: set max TLS version failed");

605 
”r
;

609 
my_r§_m‘hod
 = 
	`RSA_m‘h_Ãw
("Microsoft Cryptography API RSA Method",

610 
RSA_METHOD_FLAG_NO_CHECK
);

611 
	`check_m®loc_»tuº
(
my_r§_m‘hod
);

612 
	`RSA_m‘h_£t_pub_’c
(
my_r§_m‘hod
, 
r§_pub_’c
);

613 
	`RSA_m‘h_£t_pub_dec
(
my_r§_m‘hod
, 
r§_pub_dec
);

614 
	`RSA_m‘h_£t_´iv_’c
(
my_r§_m‘hod
, 
r§_´iv_’c
);

615 
	`RSA_m‘h_£t_´iv_dec
(
my_r§_m‘hod
, 
r§_´iv_dec
);

616 
	`RSA_m‘h_£t_š™
(
my_r§_m‘hod
, 
NULL
);

617 
	`RSA_m‘h_£t_fšish
(
my_r§_m‘hod
, 
fšish
);

618 
	`RSA_m‘h_£t0_­p_d©a
(
my_r§_m‘hod
, 
cd
);

624 ià(
cd
->
key_¥ec
 =ğ
CERT_NCRYPT_KEY_SPEC
)

626 
	`RSA_m‘h_£t_sign
(
my_r§_m‘hod
, 
r§_sign_CNG
);

629 
r§
 = 
	`RSA_Ãw
();

630 ià(
r§
 =ğ
NULL
)

632 
	`SSL”r
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_MALLOC_FAILURE
);

633 
”r
;

638 ià(!
	`SSL_CTX_u£_û¹ifiÿ‹
(
s¦_ùx
, 
û¹
))

640 
”r
;

643 
EVP_PKEY
 *
pkey
 = 
	`X509_g‘0_pubkey
(
û¹
);

647 
	`X509_ä“
(
û¹
);

648 
û¹
 = 
NULL
;

650 ià(!(
pub_r§
 = 
	`EVP_PKEY_g‘0_RSA
(
pkey
)))

652 
	`msg
(
M_WARN
, "cryptoapicert„equires‡n RSA certificate");

653 
”r
;

657 cÚ¡ 
BIGNUM
 *
n
 = 
NULL
;

658 cÚ¡ 
BIGNUM
 *
e
 = 
NULL
;

659 
	`RSA_g‘0_key
(
pub_r§
, &
n
, &
e
, 
NULL
);

660 ià(!
	`RSA_£t0_key
(
r§
, 
	`BN_dup
(
n
), BN_dup(
e
), 
NULL
))

662 
”r
;

664 
	`RSA_£t_æags
(
r§
, 
	`RSA_æags
Ô§è| 
RSA_FLAG_EXT_PKEY
);

665 ià(!
	`RSA_£t_m‘hod
(
r§
, 
my_r§_m‘hod
))

667 
”r
;

670 ià(!
	`SSL_CTX_u£_RSAPriv©eKey
(
s¦_ùx
, 
r§
))

672 
”r
;

676 
	`RSA_ä“
(
r§
);

679 
”r
:

680 ià(
û¹
)

682 
	`X509_ä“
(
û¹
);

684 ià(
r§
)

686 
	`RSA_ä“
(
r§
);

690 ià(
my_r§_m‘hod
)

692 
	`ä“
(
my_r§_m‘hod
);

694 ià(
cd
)

696 ià(
cd
->
ä“_üy±_´ov
 && cd->
üy±_´ov
)

698 ià(
cd
->
key_¥ec
 =ğ
CERT_NCRYPT_KEY_SPEC
)

700 
	`NCry±F»eObjeù
(
cd
->
üy±_´ov
);

704 
	`Cry±R–—£CÚ‹xt
(
cd
->
üy±_´ov
, 0);

707 ià(
cd
->
û¹_cÚ‹xt
)

709 
	`C”tF»eC”tifiÿ‹CÚ‹xt
(
cd
->
û¹_cÚ‹xt
);

711 
	`ä“
(
cd
);

715 
	}
}

718 #ifdeà
_MSC_VER


720 
	$dummy
()

722 
	}
}

	@cryptoapi.h

1 #iâdeà
_CRYPTOAPI_H_


2 
	#_CRYPTOAPI_H_


	)

4 
SSL_CTX_u£_Cry±oAPI_û¹ifiÿ‹
(
SSL_CTX
 *
s¦_ùx
, cÚ¡ *
û¹_´İ
);

	@dhcp.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"dhı.h
"

33 
	~"sock‘.h
"

34 
	~"”rÜ.h
"

36 
	~"memdbg.h
"

39 
	$g‘_dhı_mes§ge_ty³
(cÚ¡ 
dhı
 *dhı, cÚ¡ 
İ’
)

41 cÚ¡ 
ušt8_t
 *
p
 = (ušt8_ˆ*è(
dhı
 + 1);

42 
i
;

44 
i
 = 0; i < 
İ’
; ++i)

46 cÚ¡ 
ušt8_t
 
ty³
 = 
p
[
i
];

47 cÚ¡ 
room
 = 
İ’
 - 
i
;

48 ià(
ty³
 =ğ
DHCP_END
)

52 ià(
ty³
 =ğ
DHCP_PAD
)

55 ià(
ty³
 =ğ
DHCP_MSG_TYPE
)

57 ià(
room
 >= 3)

59 ià(
p
[
i
+1] == 1)

61  
p
[
i
+2];

68 ià(
room
 >= 2)

70 cÚ¡ 
Ën
 = 
p
[
i
+1];

71 
i
 +ğ(
Ën
 + 1);

76 
	}
}

78 
š_addr_t


79 
	$do_exŒaù
(
dhı
 *dhı, 
İ’
)

81 
ušt8_t
 *
p
 = (ušt8_ˆ*è(
dhı
 + 1);

82 
i
;

83 
š_addr_t
 
»t
 = 0;

85 
i
 = 0; i < 
İ’
; )

87 cÚ¡ 
ušt8_t
 
ty³
 = 
p
[
i
];

88 cÚ¡ 
room
 = 
İ’
 - 
i
;

89 ià(
ty³
 =ğ
DHCP_END
)

93 ià(
ty³
 =ğ
DHCP_PAD
)

95 ++
i
;

97 ià(
ty³
 =ğ
DHCP_ROUTER
)

99 ià(
room
 >= 2)

101 cÚ¡ 
Ën
 = 
p
[
i
+1];

102 ià(
Ën
 <ğ(
room
-2))

105 ià(!
»t
 && 
Ën
 >= 4 && (len & 3) == 0)

107 
	`memıy
(&
»t
, 
p
+
i
+2, 4);

108 
»t
 = 
	`Áohl
(ret);

112 
ušt8_t
 *
de¡
 = 
p
 + 
i
;

113 cÚ¡ 
owËn
 = 
Ën
 + 2;

114 
ušt8_t
 *
¤c
 = 
de¡
 + 
owËn
;

115 
ušt8_t
 *
’d
 = 
p
 + 
İ’
;

116 cÚ¡ 
movËn
 = 
’d
 - 
¤c
;

117 ià(
movËn
 > 0)

119 
	`memmove
(
de¡
, 
¤c
, 
movËn
);

121 
	`mem£t
(
’d
 - 
owËn
, 
DHCP_PAD
, owlen);

136 ià(
room
 >= 2)

138 cÚ¡ 
Ën
 = 
p
[
i
+1];

139 
i
 +ğ(
Ën
 + 2);

147  
»t
;

148 
	}
}

150 
ušt16_t


151 
	$udp_checksum
(cÚ¡ 
ušt8_t
 *
buf
,

152 cÚ¡ 
Ën_udp
,

153 cÚ¡ 
ušt8_t
 *
¤c_addr
,

154 cÚ¡ 
ušt8_t
 *
de¡_addr
)

156 
ušt16_t
 
wÜd16
;

157 
ušt32_t
 
sum
 = 0;

158 
i
;

162 
i
 = 0; i < 
Ën_udp
; i += 2)

164 
wÜd16
 = ((
buf
[
i
] << 8è& 0xFF00è+ ((˜+ 1 < 
Ën_udp
) ? (buf[i+1] & 0xFF) : 0);

165 
sum
 +ğ
wÜd16
;

169 
i
 = 0; i < 4; i += 2)

171 
wÜd16
 = ((
¤c_addr
[
i
] << 8) & 0xFF00) + (src_addr[i+1] & 0xFF);

172 
sum
 +ğ
wÜd16
;

174 
i
 = 0; i < 4; i += 2)

176 
wÜd16
 = ((
de¡_addr
[
i
] << 8) & 0xFF00) + (dest_addr[i+1] & 0xFF);

177 
sum
 +ğ
wÜd16
;

181 
sum
 +ğ(
ušt16_t
è
OPENVPN_IPPROTO_UDP
 + (ušt16_tè
Ën_udp
;

184 
sum
 >> 16)

186 
sum
 = (sum & 0xFFFF) + (sum >> 16);

190  ((
ušt16_t
è~
sum
);

191 
	}
}

193 
š_addr_t


194 
	$dhı_exŒaù_rou‹r_msg
(
bufãr
 *
buf
)

196 
dhı_fuÎ
 *
df
 = (dhı_fuÎ *è
	`BPTR
(
buf
);

197 cÚ¡ 
İ’
 = 
	`BLEN
(
buf
è- ((
İ’v²_hdr
è+ (
İ’v²_udphdr
è+ (
dhı
));

199 ià(
İ’
 >= 0

200 && 
df
->

.
´ÙocŞ
 =ğ
OPENVPN_IPPROTO_UDP


201 && 
df
->
udp
.
sourû
 =ğ
	`htÚs
(
BOOTPS_PORT
)

202 && 
df
->
udp
.
de¡
 =ğ
	`htÚs
(
BOOTPC_PORT
)

203 && 
df
->
dhı
.
İ
 =ğ
BOOTREPLY
)

205 cÚ¡ 
mes§ge_ty³
 = 
	`g‘_dhı_mes§ge_ty³
(&
df
->
dhı
, 
İ’
);

206 ià(
mes§ge_ty³
 =ğ
DHCPACK
 || mes§ge_ty³ =ğ
DHCPOFFER
)

209 cÚ¡ 
š_addr_t
 
»t
 = 
	`do_exŒaù
(&
df
->
dhı
, 
İ’
);

212 
df
->
udp
.
check
 = 0;

213 
df
->
udp
.
check
 = 
	`htÚs
(
	`udp_checksum
((
ušt8_t
 *) &df->udp,

214 (
İ’v²_udphdr
è+ (
dhı
è+ 
İ’
,

215 (
ušt8_t
 *)&
df
->

.
§ddr
,

216 (
ušt8_t
 *)&
df
->

.
daddr
));

219 ià(
mes§ge_ty³
 =ğ
DHCPACK
)

221 ià(
»t
)

223 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

224 
	`msg
(
D_ROUTE
, "ExŒaùed DHCP„ou‹¸add»ss: %s", 
	`´št_š_addr_t
(
»t
, 0, &
gc
));

225 
	`gc_ä“
(&
gc
);

228  
»t
;

233 
	}
}

	@dhcp.h

24 #iâdeà
DHCP_H


25 
	#DHCP_H


	)

27 
	~"commÚ.h
"

28 
	~"bufãr.h
"

29 
	~"´Ùo.h
"

31 #´agm¨
·ck
(1)

34 
	#DHCP_PAD
 0

	)

35 
	#DHCP_ROUTER
 3

	)

36 
	#DHCP_MSG_TYPE
 53

	)

37 
	#DHCP_END
 255

	)

40 
	#DHCPDISCOVER
 1

	)

41 
	#DHCPOFFER
 2

	)

42 
	#DHCPREQUEST
 3

	)

43 
	#DHCPDECLINE
 4

	)

44 
	#DHCPACK
 5

	)

45 
	#DHCPNAK
 6

	)

46 
	#DHCPRELEASE
 7

	)

47 
	#DHCPINFORM
 8

	)

50 
	#BOOTPS_PORT
 67

	)

51 
	#BOOTPC_PORT
 68

	)

53 
	sdhı
 {

54 
	#BOOTREQUEST
 1

	)

55 
	#BOOTREPLY
 2

	)

56 
ušt8_t
 
	mİ
;

58 
ušt8_t
 
	mhty³
;

59 
ušt8_t
 
	mhËn
;

60 
ušt8_t
 
	mhİs
;

61 
ušt32_t
 
	mxid
;

62 
ušt16_t
 
	m£cs
;

63 
ušt16_t
 
	mæags
;

64 
ušt32_t
 
	mcŸddr
;

65 
ušt32_t
 
	myŸddr
;

66 
ušt32_t
 
	msŸddr
;

67 
ušt32_t
 
	mgŸddr
;

68 
ušt8_t
 
	mchaddr
[16];

69 
ušt8_t
 
	m¢ame
[64];

70 
ušt8_t
 
	mfe
[128];

71 
ušt32_t
 
	mmagic
;

74 
	sdhı_fuÎ
 {

75 
İ’v²_hdr
 
	m
;

76 
İ’v²_udphdr
 
	mudp
;

77 
dhı
 
	mdhı
;

78 
	#DHCP_OPTIONS_BUFFER_SIZE
 256

	)

79 
ušt8_t
 
	mİtiÚs
[
DHCP_OPTIONS_BUFFER_SIZE
];

82 #´agm¨
·ck
()

84 
š_addr_t
 
dhı_exŒaù_rou‹r_msg
(
bufãr
 *
buf
);

	@errlevel.h

24 #iâdeà
ERRLEVEL_H


25 
	#ERRLEVEL_H


	)

27 
	~"”rÜ.h
"

33 
	#DEBUG_LEVEL_USEC_TIME
 4

	)

41 
	#P2P_ERROR_DELAY_MS
 0

	)

46 
	#LOG_RW


	)

53 
	#M_VERB0
 
	`LOGLEV
(0, 0, 0è

	)

55 
	#M_INFO
 
	`LOGLEV
(1, 0, 0è

	)

57 
	#D_LINK_ERRORS
 
	`LOGLEV
(1, 1, 
M_NONFATAL
è

	)

58 
	#D_CRYPT_ERRORS
 
	`LOGLEV
(1, 2, 
M_NONFATAL
è

	)

59 
	#D_TLS_ERRORS
 
	`LOGLEV
(1, 3, 
M_NONFATAL
è

	)

60 
	#D_RESOLVE_ERRORS
 
	`LOGLEV
(1, 4, 
M_NONFATAL
è

	)

61 
	#D_COMP_ERRORS
 
	`LOGLEV
(1, 5, 
M_NONFATAL
è

	)

62 
	#D_REPLAY_ERRORS
 
	`LOGLEV
(1, 6, 
M_NONFATAL
è

	)

63 
	#D_STREAM_ERRORS
 
	`LOGLEV
(1, 7, 
M_NONFATAL
è

	)

64 
	#D_IMPORT_ERRORS
 
	`LOGLEV
(1, 8, 
M_NONFATAL
è

	)

65 
	#D_MULTI_ERRORS
 
	`LOGLEV
(1, 9, 
M_NONFATAL
è

	)

66 
	#D_EVENT_ERRORS
 
	`LOGLEV
(1, 10, 
M_NONFATAL
è

	)

67 
	#D_PUSH_ERRORS
 
	`LOGLEV
(1, 11, 
M_NONFATAL
è

	)

68 
	#D_PID_PERSIST
 
	`LOGLEV
(1, 12, 
M_NONFATAL
è

	)

69 
	#D_FRAG_ERRORS
 
	`LOGLEV
(1, 13, 
M_NONFATAL
è

	)

70 
	#D_ALIGN_ERRORS
 
	`LOGLEV
(1, 14, 
M_NONFATAL
è

	)

72 
	#D_HANDSHAKE
 
	`LOGLEV
(2, 20, 0è

	)

73 
	#D_CLOSE
 
	`LOGLEV
(2, 22, 0è

	)

74 
	#D_PROXY
 
	`LOGLEV
(2, 24, 0è

	)

75 
	#D_ARGV
 
	`LOGLEV
(2, 25, 0è

	)

77 
	#D_TLS_DEBUG_LOW
 
	`LOGLEV
(3, 20, 0è

	)

78 
	#D_GREMLIN
 
	`LOGLEV
(3, 30, 0è

	)

79 
	#D_GENKEY
 
	`LOGLEV
(3, 31, 0è

	)

80 
	#D_ROUTE
 
	`LOGLEV
(3, 0, 0è

	)

81 
	#D_TUNTAP_INFO
 
	`LOGLEV
(3, 32, 0è

	)

82 
	#D_RESTART
 
	`LOGLEV
(3, 33, 0è

	)

83 
	#D_PUSH
 
	`LOGLEV
(3, 34, 0è

	)

84 
	#D_IFCONFIG_POOL
 
	`LOGLEV
(3, 35, 0è

	)

85 
	#D_AUTH
 
	`LOGLEV
(3, 37, 0è

	)

86 
	#D_MULTI_LOW
 
	`LOGLEV
(3, 38, 0è

	)

87 
	#D_PLUGIN
 
	`LOGLEV
(3, 39, 0è

	)

88 
	#D_MANAGEMENT
 
	`LOGLEV
(3, 40, 0è

	)

89 
	#D_SCHED_EXIT
 
	`LOGLEV
(3, 41, 0è

	)

90 
	#D_ROUTE_QUOTA
 
	`LOGLEV
(3, 42, 0è

	)

91 
	#D_OSBUF
 
	`LOGLEV
(3, 43, 0è

	)

92 
	#D_PS_PROXY
 
	`LOGLEV
(3, 44, 0è

	)

93 
	#D_PF_INFO
 
	`LOGLEV
(3, 45, 0è

	)

95 
	#D_SHOW_PARMS
 
	`LOGLEV
(4, 50, 0è

	)

96 
	#D_SHOW_OCC
 
	`LOGLEV
(4, 51, 0è

	)

97 
	#D_LOW
 
	`LOGLEV
(4, 52, 0è

	)

98 
	#D_DHCP_OPT
 
	`LOGLEV
(4, 53, 0è

	)

99 
	#D_MBUF
 
	`LOGLEV
(4, 54, 0è

	)

100 
	#D_PACKET_TRUNC_ERR
 
	`LOGLEV
(4, 55, 0è

	)

101 
	#D_PF_DROPPED
 
	`LOGLEV
(4, 56, 0è

	)

102 
	#D_MULTI_DROPPED
 
	`LOGLEV
(4, 57, 0è

	)

103 
	#D_MULTI_MEDIUM
 
	`LOGLEV
(4, 58, 0è

	)

104 
	#D_X509_ATTR
 
	`LOGLEV
(4, 59, 0è

	)

105 
	#D_INIT_MEDIUM
 
	`LOGLEV
(4, 60, 0è

	)

106 
	#D_MTU_INFO
 
	`LOGLEV
(4, 61, 0è

	)

107 
	#D_PID_DEBUG_LOW
 
	`LOGLEV
(4, 63, 0è

	)

108 
	#D_PID_DEBUG_MEDIUM
 
	`LOGLEV
(4, 64, 0è

	)

110 
	#D_LOG_RW
 
	`LOGLEV
(5, 0, 0è

	)

112 
	#D_LINK_RW
 
	`LOGLEV
(6, 69, 
M_DEBUG
è

	)

113 
	#D_TUN_RW
 
	`LOGLEV
(6, 69, 
M_DEBUG
è

	)

114 
	#D_TAP_WIN_DEBUG
 
	`LOGLEV
(6, 69, 
M_DEBUG
è

	)

115 
	#D_CLIENT_NAT
 
	`LOGLEV
(6, 69, 
M_DEBUG
è

	)

117 
	#D_SHOW_KEYS
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

118 
	#D_SHOW_KEY_SOURCE
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

119 
	#D_REL_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

120 
	#D_FRAG_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

121 
	#D_WIN32_IO_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

122 
	#D_MTU_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

123 
	#D_MULTI_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

124 
	#D_MSS
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

125 
	#D_COMP_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

126 
	#D_CONNECTION_LIST
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

127 
	#D_SCRIPT
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

128 
	#D_SHOW_NET
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

129 
	#D_ROUTE_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

130 
	#D_TLS_STATE_ERRORS
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

131 
	#D_SEMAPHORE_LOW
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

132 
	#D_SEMAPHORE
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

133 
	#D_TEST_FILE
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

134 
	#D_MANAGEMENT_DEBUG
 
	`LOGLEV
(3, 70, 
M_DEBUG
è

	)

135 
	#D_PLUGIN_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

136 
	#D_SOCKET_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

137 
	#D_SHOW_PKCS11
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

138 
	#D_ALIGN_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

139 
	#D_PACKET_TRUNC_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

140 
	#D_PING
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

141 
	#D_PS_PROXY_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

142 
	#D_AUTO_USERID
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

143 
	#D_TLS_KEYSELECT
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

144 
	#D_ARGV_PARSE_CMD
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

145 
	#D_CRYPTO_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

146 
	#D_PID_DEBUG
 
	`LOGLEV
(7, 70, 
M_DEBUG
è

	)

147 
	#D_PF_DROPPED_BCAST
 
	`LOGLEV
(7, 71, 
M_DEBUG
è

	)

148 
	#D_PF_DEBUG
 
	`LOGLEV
(7, 72, 
M_DEBUG
è

	)

149 
	#D_PUSH_DEBUG
 
	`LOGLEV
(7, 73, 
M_DEBUG
è

	)

151 
	#D_HANDSHAKE_VERBOSE
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

152 
	#D_TLS_DEBUG_MED
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

153 
	#D_INTERVAL
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

154 
	#D_SCHEDULER
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

155 
	#D_GREMLIN_VERBOSE
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

156 
	#D_REL_DEBUG
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

157 
	#D_EVENT_WAIT
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

158 
	#D_MULTI_TCP
 
	`LOGLEV
(8, 70, 
M_DEBUG
è

	)

160 
	#D_TLS_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

161 
	#D_COMP
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

162 
	#D_READ_WRITE
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

163 
	#D_PACKET_CONTENT
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

164 
	#D_TLS_NO_SEND_KEY
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

165 
	#D_PID_PERSIST_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

166 
	#D_LINK_RW_VERBOSE
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

167 
	#D_STREAM_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

168 
	#D_WIN32_IO
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

169 
	#D_PKCS11_DEBUG
 
	`LOGLEV
(9, 70, 
M_DEBUG
è

	)

171 
	#D_SHAPER_DEBUG
 
	`LOGLEV
(10, 70, 
M_DEBUG
è

	)

173 
	#D_REGISTRY
 
	`LOGLEV
(11, 70, 
M_DEBUG
è

	)

174 
	#D_OPENSSL_LOCK
 
	`LOGLEV
(11, 70, 
M_DEBUG
è

	)

	@error.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"”rÜ.h
"

33 
	~"bufãr.h
"

34 
	~"misc.h
"

35 
	~"wš32.h
"

36 
	~"sock‘.h
"

37 
	~"tun.h
"

38 
	~"Ùime.h
"

39 
	~"³rf.h
"

40 
	~"¡©us.h
"

41 
	~"š‹g”.h
"

42 
	~"ps.h
"

43 
	~"m¡©s.h
"

46 #ià
SYSLOG_CAPABILITY


47 #iâdeà
LOG_OPENVPN


48 
	#LOG_OPENVPN
 
LOG_DAEMON


	)

53 
	gx_debug_Ëv–
;

56 
	gmu‹_cutoff
;

57 
	gmu‹_couÁ
;

58 
	gmu‹_ÿ‹gÜy
;

72 
boŞ
 
	g¡d_»dœ
;

75 
boŞ
 
	gu£_sy¦og
;

79 
boŞ
 
	gmachše_»adabË_ouut
;

82 
boŞ
 
	gsuµ»ss_time¡amps
;

85 #ià
SYSLOG_CAPABILITY


86 *
	gpgmÇme_sy¦og
;

90 
FILE
 *
	gmsgå
;

93 
boŞ
 
	gfÜked
;

96 
FILE
 *
	gdeçuÉ_out
;

97 
FILE
 *
	gdeçuÉ_”r
;

100 
	$msg_fÜked
()

102 
fÜked
 = 
Œue
;

103 
	}
}

105 
boŞ


106 
	$£t_debug_Ëv–
(cÚ¡ 
Ëv–
, cÚ¡ 
æags
)

108 cÚ¡ 
ûšg
 = 15;

110 ià(
Ëv–
 >ğ0 &&†ev– <ğ
ûšg
)

112 
x_debug_Ëv–
 = 
Ëv–
;

113  
Œue
;

115 ià(
æags
 & 
SDL_CONSTRAIN
)

117 
x_debug_Ëv–
 = 
	`cÚ¡¿š_št
(
Ëv–
, 0, 
ûšg
);

118  
Œue
;

120  
çl£
;

121 
	}
}

123 
boŞ


124 
	$£t_mu‹_cutoff
(cÚ¡ 
cutoff
)

126 ià(
cutoff
 >= 0)

128 
mu‹_cutoff
 = 
cutoff
;

129  
Œue
;

133  
çl£
;

135 
	}
}

138 
	$g‘_debug_Ëv–
()

140  
x_debug_Ëv–
;

141 
	}
}

144 
	$g‘_mu‹_cutoff
()

146  
mu‹_cutoff
;

147 
	}
}

150 
	$£t_suµ»ss_time¡amps
(
boŞ
 
suµ»s£d
)

152 
suµ»ss_time¡amps
 = 
suµ»s£d
;

153 
	}
}

156 
	$£t_machše_»adabË_ouut
(
boŞ
 
·r§bË
)

158 
machše_»adabË_ouut
 = 
·r§bË
;

159 
	}
}

162 
	$”rÜ_»£t
()

164 
u£_sy¦og
 = 
¡d_»dœ
 = 
çl£
;

165 
suµ»ss_time¡amps
 = 
çl£
;

166 
machše_»adabË_ouut
 = 
çl£
;

167 
x_debug_Ëv–
 = 1;

168 
mu‹_cutoff
 = 0;

169 
mu‹_couÁ
 = 0;

170 
mu‹_ÿ‹gÜy
 = 0;

171 
deçuÉ_out
 = 
OPENVPN_MSG_FP
;

172 
deçuÉ_”r
 = 
OPENVPN_MSG_FP
;

174 #ifdeà
OPENVPN_DEBUG_COMMAND_LINE


175 
msgå
 = 
	`fİ’
(
OPENVPN_DEBUG_FILE
, "w");

176 ià(!
msgå
)

178 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
);

181 
msgå
 = 
NULL
;

183 
	}
}

186 
	$”rÜs_to_¡d”r
()

188 
deçuÉ_”r
 = 
OPENVPN_ERROR_FP
;

189 
	}
}

194 
FILE
 *

195 
	$msg_å
(cÚ¡ 
æags
)

197 
FILE
 *
å
 = 
msgå
;

198 ià(!
å
)

200 
å
 = (
æags
 & (
M_FATAL
|
M_USAGE_SMALL
)è? 
deçuÉ_”r
 : 
deçuÉ_out
;

202 ià(!
å
)

204 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
);

206  
å
;

207 
	}
}

209 
	#SWAP
 { 
tmp
 = 
m1
; m1 = 
m2
; m2 =mp; }

	)

211 
	gx_msg_lše_num
;

214 
	$x_msg
(cÚ¡ 
æags
, cÚ¡ *
fÜm©
, ...)

216 
va_li¡
 
¬gli¡
;

217 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

218 
	`x_msg_va
(
æags
, 
fÜm©
, 
¬gli¡
);

219 
	`va_’d
(
¬gli¡
);

220 
	}
}

223 
	$x_msg_va
(cÚ¡ 
æags
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬gli¡
)

225 
gc_¬’a
 
gc
;

226 #ià
SYSLOG_CAPABILITY


227 
Ëv–
;

229 *
m1
;

230 *
m2
;

231 *
tmp
;

232 
e
;

233 cÚ¡ *
´efix
;

234 cÚ¡ *
´efix_£p
;

236 
	`u§ge_sm®l
();

238 #iâdeà
HAVE_VARARG_MACROS


240 ià(!
	`msg_‹¡
(
æags
))

246 
e
 = 
	`İ’v²_”ºo
();

251 #iâdeà
HAVE_VARARG_MACROS


253 ià(!
	`dÚt_mu‹
(
æags
))

259 
	`gc_š™
(&
gc
);

261 
m1
 = (*è
	`gc_m®loc
(
ERR_BUF_SIZE
, 
çl£
, &
gc
);

262 
m2
 = (*è
	`gc_m®loc
(
ERR_BUF_SIZE
, 
çl£
, &
gc
);

264 
	`v¢´štf
(
m1
, 
ERR_BUF_SIZE
, 
fÜm©
, 
¬gli¡
);

265 
m1
[
ERR_BUF_SIZE
 - 1] = 0;

267 ià((
æags
 & 
M_ERRNO
è&& 
e
)

269 
	`İ’v²_¢´štf
(
m2
, 
ERR_BUF_SIZE
, "%s: %s (errno=%d)",

270 
m1
, 
	`¡»¼Ü
(
e
),ƒ);

271 
SWAP
;

274 ià(
æags
 & 
M_OPTERR
)

276 
	`İ’v²_¢´štf
(
m2
, 
ERR_BUF_SIZE
, "O±iÚ ”rÜ: %s", 
m1
);

277 
SWAP
;

280 #ià
SYSLOG_CAPABILITY


281 ià(
æags
 & (
M_FATAL
|
M_NONFATAL
|
M_USAGE_SMALL
))

283 
Ëv–
 = 
LOG_ERR
;

285 ià(
æags
 & 
M_WARN
)

287 
Ëv–
 = 
LOG_WARNING
;

291 
Ëv–
 = 
LOG_NOTICE
;

296 ià(
æags
 & 
M_NOIPREFIX
)

298 
´efix
 = 
NULL
;

302 
´efix
 = 
	`msg_g‘_´efix
();

304 
´efix_£p
 = " ";

305 ià(!
´efix
)

307 
´efix_£p
 = 
´efix
 = "";

311 ià(!
fÜked
)

313 cÚ¡ 
vœtu®_ouut
 *
vo
 = 
	`msg_g‘_vœtu®_ouut
();

314 ià(
vo
)

316 
	`İ’v²_¢´štf
(
m2
, 
ERR_BUF_SIZE
, "%s%s%s",

317 
´efix
,

318 
´efix_£p
,

319 
m1
);

320 
	`vœtu®_ouut_´št
(
vo
, 
æags
, 
m2
);

324 ià(!(
æags
 & 
M_MSG_VIRT_OUT
))

326 ià(
u£_sy¦og
 && !
¡d_»dœ
 && !
fÜked
)

328 #ià
SYSLOG_CAPABILITY


329 
	`sy¦og
(
Ëv–
, "%s%s%s",

330 
´efix
,

331 
´efix_£p
,

332 
m1
);

337 
FILE
 *
å
 = 
	`msg_å
(
æags
);

338 cÚ¡ 
boŞ
 
show_u£c
 = 
	`check_debug_Ëv–
(
DEBUG_LEVEL_USEC_TIME
);

340 ià(
machše_»adabË_ouut
)

342 
timev®
 
tv
;

343 
	`g‘timeofday
(&
tv
, 
NULL
);

345 
	`årštf
(
å
, "%"
PRIi64
".%06lu %x %s%s%s%s",

346 (
št64_t
)
tv
.
tv_£c
,

347 ()
tv
.
tv_u£c
,

348 
æags
,

349 
´efix
,

350 
´efix_£p
,

351 
m1
,

355 ià((
æags
 & 
M_NOPREFIX
è|| 
suµ»ss_time¡amps
)

357 
	`årštf
(
å
, "%s%s%s%s",

358 
´efix
,

359 
´efix_£p
,

360 
m1
,

361 (
æags
&
M_NOLF
) ? "" : "\n");

365 
	`årštf
(
å
, "%s %s%s%s%s",

366 
	`time_¡ršg
(0, 0, 
show_u£c
, &
gc
),

367 
´efix
,

368 
´efix_£p
,

369 
m1
,

370 (
æags
&
M_NOLF
) ? "" : "\n");

372 
	`fæush
(
å
);

373 ++
x_msg_lše_num
;

377 ià(
æags
 & 
M_FATAL
)

379 
	`msg
(
M_INFO
, "Exiting dueo fatalƒrror");

382 ià(
æags
 & 
M_FATAL
)

384 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_ERROR
);

387 ià(
æags
 & 
M_USAGE_SMALL
)

389 
	`u§ge_sm®l
();

392 
	`gc_ä“
(&
gc
);

393 
	}
}

398 
boŞ


399 
	$dÚt_mu‹
(
æags
)

401 
boŞ
 
»t
 = 
Œue
;

402 ià(
mu‹_cutoff
 > 0 && !(
æags
 & 
M_NOMUTE
))

404 cÚ¡ 
mu‹_Ëv–
 = 
	`DECODE_MUTE_LEVEL
(
æags
);

405 ià(
mu‹_Ëv–
 > 0 && mu‹_Ëv– =ğ
mu‹_ÿ‹gÜy
)

407 ià(
mu‹_couÁ
 =ğ
mu‹_cutoff
)

409 
	`msg
(
M_INFO
 | 
M_NOMUTE
, "NOTE: --muteriggered...");

411 ià(++
mu‹_couÁ
 > 
mu‹_cutoff
)

413 
»t
 = 
çl£
;

418 cÚ¡ 
suµ»s£d
 = 
mu‹_couÁ
 - 
mu‹_cutoff
;

419 ià(
suµ»s£d
 > 0)

421 
	`msg
(
M_INFO
 | 
M_NOMUTE
,

423 
suµ»s£d
,

424 
mu‹_cutoff
);

426 
mu‹_couÁ
 = 1;

427 
mu‹_ÿ‹gÜy
 = 
mu‹_Ëv–
;

430  
»t
;

431 
	}
}

434 
	$as£¹_çed
(cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
cÚd™iÚ
)

436 ià(
cÚd™iÚ
)

438 
	`msg
(
M_FATAL
, "As£¹iÚ faed‡ˆ%s:%d (%s)", 
f’ame
, 
lše
, 
cÚd™iÚ
);

442 
	`msg
(
M_FATAL
, "As£¹iÚ faed‡ˆ%s:%d", 
f’ame
, 
lše
);

444 
	`_ex™
(1);

445 
	}
}

452 
	$out_of_memÜy
()

454 
	`årštf
(
¡d”r
, 
PACKAGE_NAME
 ": Out of Memory\n");

455 
	`ex™
(1);

456 
	}
}

459 
	$İ’_sy¦og
(cÚ¡ *
pgmÇme
, 
boŞ
 
¡dio_to_nuÎ
)

461 #ià
SYSLOG_CAPABILITY


462 ià(!
msgå
 && !
¡d_»dœ
)

464 ià(!
u£_sy¦og
)

466 
pgmÇme_sy¦og
 = 
	`¡ršg_®loc
(
pgmÇme
 ?…gmÇm: 
PACKAGE
, 
NULL
);

467 
	`İ’log
(
pgmÇme_sy¦og
, 
LOG_PID
, 
LOG_OPENVPN
);

468 
u£_sy¦og
 = 
Œue
;

471 ià(
¡dio_to_nuÎ
)

473 
	`£t_¡d_fes_to_nuÎ
(
çl£
);

478 
	`msg
(
M_WARN
, "Warning on use of --daemon/--inetd:his operating system†acks daemon†ogging features,herefore when I become‡ daemon, I won't be‡bleo†og status orƒrror messages");

480 
	}
}

483 
	$şo£_sy¦og
()

485 #ià
SYSLOG_CAPABILITY


486 ià(
u£_sy¦og
)

488 
	`şo£log
();

489 
u£_sy¦og
 = 
çl£
;

490 ià(
pgmÇme_sy¦og
)

492 
	`ä“
(
pgmÇme_sy¦og
);

493 
pgmÇme_sy¦og
 = 
NULL
;

497 
	}
}

499 #ifdeà
_WIN32


501 
HANDLE
 
	gÜig_¡d”r
;

503 
HANDLE


504 
	$g‘_Üig_¡d”r
()

506 ià(
Üig_¡d”r
)

508  
Üig_¡d”r
;

512  
	`G‘StdHªdË
(
STD_ERROR_HANDLE
);

514 
	}
}

519 
	$»dœeù_¡dout_¡d”r
(cÚ¡ *
fe
, 
boŞ
 
­³nd
)

521 #ià
	`defšed
(
_WIN32
)

522 ià(!
¡d_»dœ
)

524 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

525 
HANDLE
 
log_hªdË
;

526 
log_fd
;

528 
SECURITY_ATTRIBUTES
 
§A‰r
;

529 
§A‰r
.
nL’gth
 = (
SECURITY_ATTRIBUTES
);

530 
§A‰r
.
bInh”™HªdË
 = 
TRUE
;

531 
§A‰r
.
ÍSecur™yDesütÜ
 = 
NULL
;

533 
log_hªdË
 = 
	`C»©eFeW
(
	`wide_¡ršg
(
fe
, &
gc
),

534 
GENERIC_WRITE
,

535 
FILE_SHARE_READ
,

536 &
§A‰r
,

537 
­³nd
 ? 
OPEN_ALWAYS
 : 
CREATE_ALWAYS
,

538 
FILE_ATTRIBUTE_NORMAL
,

539 
NULL
);

541 
	`gc_ä“
(&
gc
);

543 ià(
log_hªdË
 =ğ
INVALID_HANDLE_VALUE
)

545 
	`msg
(
M_WARN
|
M_ERRNO
, "W¬nšg: cªnÙ o³À--log fe: %s", 
fe
);

550 ià(
­³nd
)

552 ià(
	`S‘FePoš‹r
(
log_hªdË
, 0, 
NULL
, 
FILE_END
è=ğ
INVALID_SET_FILE_POINTER
)

554 
	`msg
(
M_ERR
, "E¼Ü: cªnÙ s“kØ’d oà--log fe: %s", 
fe
);

559 
Üig_¡d”r
 = 
	`G‘StdHªdË
(
STD_ERROR_HANDLE
);

563 ià(!
	`S‘StdHªdË
(
STD_OUTPUT_HANDLE
, 
log_hªdË
)

564 || !
	`S‘StdHªdË
(
STD_ERROR_HANDLE
, 
log_hªdË
))

566 
	`msg
(
M_ERR
, "E¼Ü: cªnÙ„edœeù stdout/¡d”¸tØ--log fe: %s", 
fe
);

571 
log_fd
 = 
	`_İ’_osfhªdË
((
šŒ_t
)
log_hªdË
, 
_O_TEXT
);

572 ià(
log_fd
 == -1)

574 
	`msg
(
M_ERR
, "Error: --log„edirect failed dueo _open_osfhandle failure");

578 
	`ASSERT
(
msgå
 =ğ
NULL
);

579 
msgå
 = 
	`_fdİ’
(
log_fd
, "wt");

580 ià(
msgå
 =ğ
NULL
)

582 
	`msg
(
M_ERR
, "Error: --log„edirect failed dueo _fdopen");

586 ià(
	`_dup2
(
log_fd
, 1) == -1 || _dup2(log_fd, 2) == -1)

588 
	`msg
(
M_WARN
, "Error: --log„edirect of stdout/stderr failed");

591 
¡d_»dœ
 = 
Œue
;

593 #–ià
	`defšed
(
HAVE_DUP2
)

594 ià(!
¡d_»dœ
)

596 
out
 = 
	`İ’
(
fe
,

597 
O_CREAT
 | 
O_WRONLY
 | (
­³nd
 ? 
O_APPEND
 : 
O_TRUNC
),

598 
S_IRUSR
 | 
S_IWUSR
);

600 ià(
out
 < 0)

602 
	`msg
(
M_WARN
|
M_ERRNO
, "W¬nšg: E¼Ü„edœeùšg stdout/¡d”¸tØ--log fe: %s", 
fe
);

606 ià(
	`dup2
(
out
, 1) == -1)

608 
	`msg
(
M_ERR
, "--log file„edirectionƒrror on stdout");

610 ià(
	`dup2
(
out
, 2) == -1)

612 
	`msg
(
M_ERR
, "--log file„edirectionƒrror on stderr");

615 ià(
out
 > 2)

617 
	`şo£
(
out
);

620 
¡d_»dœ
 = 
Œue
;

624 
	`msg
(
M_WARN
, "WARNING: The --log option is‚ot supported onhis OS because it†ackshe dup2 function");

626 
	}
}

633 
	gx_cs_šfo_Ëv–
;

634 
	gx_cs_v”bo£_Ëv–
;

635 
	gx_cs_”r_d–ay_ms
;

638 
	$»£t_check_¡©us
()

640 
x_cs_šfo_Ëv–
 = 0;

641 
x_cs_v”bo£_Ëv–
 = 0;

642 
	}
}

645 
	$£t_check_¡©us
(
šfo_Ëv–
, 
v”bo£_Ëv–
)

647 
x_cs_šfo_Ëv–
 = 
šfo_Ëv–
;

648 
x_cs_v”bo£_Ëv–
 = 
v”bo£_Ëv–
;

649 
	}
}

660 
	$x_check_¡©us
(
¡©us
,

661 cÚ¡ *
desütiÚ
,

662 
lšk_sock‘
 *
sock
,

663 
tuÁ­
 *
‰
)

665 cÚ¡ 
my_”ºo
 = 
	`İ’v²_”ºo
();

666 cÚ¡ *
ex‹nded_msg
 = 
NULL
;

668 
	`msg
(
x_cs_v”bo£_Ëv–
, "%s %s„eturned %d",

669 
sock
 ? 
	`´Ùo2ascii
(sock->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
) : "",

670 
desütiÚ
,

671 
¡©us
);

673 ià(
¡©us
 < 0)

675 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

676 #ià
EXTENDED_SOCKET_ERROR_CAPABILITY


678 ià(
sock
)

680 
mtu
;

681 
ex‹nded_msg
 = 
	`fÜm©_ex‹nded_sock‘_”rÜ
(
sock
->
sd
, &
mtu
, &
gc
);

682 ià(
mtu
 > 0 && 
sock
->mtu != mtu)

684 
sock
->
mtu
 = mtu;

685 
sock
->
šfo
.
mtu_chªged
 = 
Œue
;

688 #–ià
	`defšed
(
_WIN32
)

690 
ex‹nded_msg
 = 
	`p_wš_g‘šfo
(
‰
, &
gc
);

692 ià(!
	`ignÜe_sys_”rÜ
(
my_”ºo
))

694 ià(
ex‹nded_msg
)

696 
	`msg
(
x_cs_šfo_Ëv–
, "% % [%s]: % (code=%d)", 
desütiÚ
,

697 
sock
 ? 
	`´Ùo2ascii
(sock->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
) : "",

698 
ex‹nded_msg
, 
	`¡»¼Ü
(
my_”ºo
), my_errno);

702 
	`msg
(
x_cs_šfo_Ëv–
, "% %s: % (code=%d)", 
desütiÚ
,

703 
sock
 ? 
	`´Ùo2ascii
(sock->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
) : "",

704 
	`¡»¼Ü
(
my_”ºo
), my_errno);

707 ià(
x_cs_”r_d–ay_ms
)

709 
	`¶©fÜm_¦“p_mli£cÚds
(
x_cs_”r_d–ay_ms
);

712 
	`gc_ä“
(&
gc
);

714 
	}
}

720 cÚ¡ *
	gx_msg_´efix
;

726 cÚ¡ 
vœtu®_ouut
 *
	gx_msg_vœtu®_ouut
;

733 
	$İ’v²_ex™
(cÚ¡ 
¡©us
)

735 ià(!
fÜked
)

737 
	`tun_abÜt
();

739 #ifdeà
ENABLE_PLUGIN


740 
	`¶ugš_abÜt
();

744 
	`tun_abÜt
();

746 #ifdeà
_WIN32


747 
	`unš™_wš32
();

750 
	`şo£_sy¦og
();

752 #ifdeà
ENABLE_PLUGIN


753 
	`¶ugš_abÜt
();

756 #ià
PORT_SHARE


757 ià(
pÜt_sh¬e
)

759 
	`pÜt_sh¬e_abÜt
(
pÜt_sh¬e
);

763 #ifdeà
ENABLE_MEMSTATS


764 
	`m¡©s_şo£
();

767 #ifdeà
ABORT_ON_ERROR


768 ià(
¡©us
 =ğ
OPENVPN_EXIT_STATUS_ERROR
)

770 
	`abÜt
();

774 ià(
¡©us
 =ğ
OPENVPN_EXIT_STATUS_GOOD
)

776 
	`³rf_ouut_»suÉs
();

780 
	`ex™
(
¡©us
);

781 
	}
}

787 
	$msg_æags_¡ršg
(cÚ¡ 
æags
, 
gc_¬’a
 *
gc
)

789 
bufãr
 
out
 = 
	`®loc_buf_gc
(16, 
gc
);

790 ià(
æags
 =ğ
M_INFO
)

792 
	`buf_´štf
(&
out
, "I");

794 ià(
æags
 & 
M_FATAL
)

796 
	`buf_´štf
(&
out
, "F");

798 ià(
æags
 & 
M_NONFATAL
)

800 
	`buf_´štf
(&
out
, "N");

802 ià(
æags
 & 
M_WARN
)

804 
	`buf_´štf
(&
out
, "W");

806 ià(
æags
 & 
M_DEBUG
)

808 
	`buf_´štf
(&
out
, "D");

810  
	`BSTR
(&
out
);

811 
	}
}

813 #ifdeà
ENABLE_DEBUG


815 
	$üash
()

817 *
nuÎ
 = 
NULL
;

818 *
nuÎ
 = 0;

819 
	}
}

822 #ifdeà
_WIN32


825 
	$¡»¼Ü_wš32
(
DWORD
 
”ºum
, 
gc_¬’a
 *
gc
)

833 
”ºum
)

839 
ERROR_GEN_FAILURE
:

842 
ERROR_IO_PENDING
:

845 
WSA_IO_INCOMPLETE
:

848 
WSAEINTR
:

851 
WSAEBADF
:

854 
WSAEACCES
:

857 
WSAEFAULT
:

860 
WSAEINVAL
:

863 
WSAEMFILE
:

866 
WSAEWOULDBLOCK
:

869 
WSAEINPROGRESS
:

872 
WSAEALREADY
:

875 
WSAEDESTADDRREQ
:

878 
WSAEMSGSIZE
:

881 
WSAEPROTOTYPE
:

884 
WSAENOPROTOOPT
:

887 
WSAEPROTONOSUPPORT
:

890 
WSAESOCKTNOSUPPORT
:

893 
WSAEOPNOTSUPP
:

896 
WSAEPFNOSUPPORT
:

899 
WSAEAFNOSUPPORT
:

902 
WSAEADDRINUSE
:

905 
WSAENETDOWN
:

908 
WSAENETUNREACH
:

911 
WSAENETRESET
:

914 
WSAECONNABORTED
:

917 
WSAECONNRESET
:

920 
WSAENOBUFS
:

923 
WSAEISCONN
:

926 
WSAENOTCONN
:

929 
WSAETIMEDOUT
:

932 
WSAECONNREFUSED
:

935 
WSAELOOP
:

938 
WSAENAMETOOLONG
:

941 
WSAEHOSTDOWN
:

944 
WSAEHOSTUNREACH
:

947 
WSAENOTEMPTY
:

950 
WSAEPROCLIM
:

953 
WSAEUSERS
:

956 
WSAEDQUOT
:

959 
WSAESTALE
:

962 
WSASYSNOTREADY
:

965 
WSAVERNOTSUPPORTED
:

968 
WSANOTINITIALISED
:

971 
WSAEREMOTE
:

974 
WSAHOST_NOT_FOUND
:

984 
mes§ge
[256];

985 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

986 cÚ¡ 
¡©us
 = 
	`FÜm©Mes§ge
(

987 
FORMAT_MESSAGE_IGNORE_INSERTS


988 | 
FORMAT_MESSAGE_FROM_SYSTEM


989 | 
FORMAT_MESSAGE_ARGUMENT_ARRAY
,

990 
NULL
,

991 
”ºum
,

993 
mes§ge
,

994 (
mes§ge
),

995 
NULL
);

996 ià(!
¡©us
)

998 
	`buf_´štf
(&
out
, "[Unknown Win32 Error]");

1002 *
ı
;

1003 
ı
 = 
mes§ge
; *cp != '\0'; ++cp)

1005 ià(*
ı
 == '\n' || *cp == '\r')

1007 *
ı
 = ' ';

1011 
	`buf_´štf
(&
out
, "%s", 
mes§ge
);

1014  
	`BSTR
(&
out
);

1016 
	}
}

	@error.h

24 #iâdeà
ERROR_H


25 
	#ERROR_H


	)

27 
	~"basic.h
"

29 
	~<”ºo.h
>

30 
	~<¡dboŞ.h
>

32 
	~<as£¹.h
>

36 #ifdeà
ENABLE_PKCS11


37 
	#ERR_BUF_SIZE
 8192

	)

39 
	#ERR_BUF_SIZE
 1280

	)

42 
	ggc_¬’a
;

48 
	#OPENVPN_MSG_FP
 
¡dout


	)

49 
	#OPENVPN_ERROR_FP
 
¡d”r


	)

55 
	#OPENVPN_EXIT_STATUS_GOOD
 0

	)

56 
	#OPENVPN_EXIT_STATUS_ERROR
 1

	)

57 
	#OPENVPN_EXIT_STATUS_USAGE
 1

	)

58 
	#OPENVPN_EXIT_STATUS_CANNOT_OPEN_DEBUG_FILE
 1

	)

69 
	#OPENVPN_DEBUG_FILE
 
PACKAGE
 ".log"

	)

73 #ifdeà
_WIN32


74 
	#İ’v²_”ºo
(è
	`G‘La¡E¼Ü
()

	)

75 
	#İ’v²_¡»¼Ü
(
e
, 
gc
è
	`¡»¼Ü_wš32
Ó, gc)

	)

76 cÚ¡ *
¡»¼Ü_wš32
(
DWORD
 
”ºum
, 
gc_¬’a
 *
gc
);

79 
	#İ’v²_”ºo
(è
”ºo


	)

80 
	#İ’v²_¡»¼Ü
(
x
, 
gc
è
	`¡»¼Ü
(x)

	)

87 
x_debug_Ëv–
;

88 
x_msg_lše_num
;

92 
	#M_DEBUG_LEVEL
 (0x0Fè

	)

94 
	#M_FATAL
 (1<<4è

	)

95 
	#M_NONFATAL
 (1<<5è

	)

96 
	#M_WARN
 (1<<6è

	)

97 
	#M_DEBUG
 (1<<7)

	)

99 
	#M_ERRNO
 (1<<8è

	)

101 
	#M_NOMUTE
 (1<<11è

	)

102 
	#M_NOPREFIX
 (1<<12è

	)

103 
	#M_USAGE_SMALL
 (1<<13è

	)

104 
	#M_MSG_VIRT_OUT
 (1<<14è

	)

105 
	#M_OPTERR
 (1<<15è

	)

106 
	#M_NOLF
 (1<<16è

	)

107 
	#M_NOIPREFIX
 (1<<17è

	)

110 
	#M_ERR
 (
M_FATAL
 | 
M_ERRNO
)

	)

111 
	#M_USAGE
 (
M_USAGE_SMALL
 | 
M_NOPREFIX
 | 
M_OPTERR
)

	)

112 
	#M_CLIENT
 (
M_MSG_VIRT_OUT
 | 
M_NOMUTE
 | 
M_NOIPREFIX
)

	)

120 
	#MUTE_LEVEL_SHIFT
 24

	)

121 
	#MUTE_LEVEL_MASK
 0xFF

	)

123 
	#ENCODE_MUTE_LEVEL
(
mu‹_Ëv–
è(((mu‹_Ëv–è& 
MUTE_LEVEL_MASK
è<< 
MUTE_LEVEL_SHIFT
)

	)

124 
	#DECODE_MUTE_LEVEL
(
æags
è(((æagsè>> 
MUTE_LEVEL_SHIFT
è& 
MUTE_LEVEL_MASK
)

	)

136 
	#LOGLEV
(
log_Ëv–
, 
mu‹_Ëv–
, 
Ùh”
è(Öog_Ëv–è| 
	`ENCODE_MUTE_LEVEL
(mu‹_Ëv–è| oth”)

	)

144 
boŞ
 
dÚt_mu‹
(
æags
);

147 
	#EXIT_FATAL
(
æags
èdØ{ ià((æagsè& 
M_FATAL
è{
	`_ex™
(1);}} 
çl£
)

	)

149 #ià
defšed
(
HAVE_CPP_VARARG_MACRO_ISO
è&& !defšed(
__LCLINT__
)

150 
	#HAVE_VARARG_MACROS


	)

151 
	#msg
(
æags
, ...èdØ{ ià(
	`msg_‹¡
(æags)è{
	`x_msg
((æags), 
__VA_ARGS__
);} 
	`EXIT_FATAL
(æags); } 
çl£
)

	)

152 #ifdeà
ENABLE_DEBUG


153 
	#dmsg
(
æags
, ...èdØ{ ià(
	`msg_‹¡
(æags)è{
	`x_msg
((æags), 
__VA_ARGS__
);} 
	`EXIT_FATAL
(æags); } 
çl£
)

	)

155 
	#dmsg
(
æags
, ...)

	)

157 #–ià
defšed
(
HAVE_CPP_VARARG_MACRO_GCC
è&& !defšed(
__LCLINT__
)

158 
	#HAVE_VARARG_MACROS


	)

159 
	#msg
(
æags
, 
¬gs
 ...èdØ{ ià(
	`msg_‹¡
(æags)è{
	`x_msg
((æags),‡rgs);} 
	`EXIT_FATAL
(æags); } 
çl£
)

	)

160 #ifdeà
ENABLE_DEBUG


161 
	#dmsg
(
æags
, 
¬gs
 ...èdØ{ ià(
	`msg_‹¡
(æags)è{
	`x_msg
((æags),‡rgs);} 
	`EXIT_FATAL
(æags); } 
çl£
)

	)

163 
	#dmsg
(
æags
, 
¬gs
 ...)

	)

166 #ià!
PEDANTIC


167 #ifdeà
_MSC_VER


168 #´agm¨
mes§ge
("this compiler‡ppearso†ack vararg macros which will cause‡ significant degradation inƒfficiency")

170 #w¬nšg 
this
 
comp”
 
­³¬s
 
to
 
Ïck
 
v¬¬g
 
maüos
 
which
 
wl
 
ÿu£
 
a
 
signifiÿÁ
 
deg¿d©iÚ
 
š
 
effic›ncy
 (
you
 
ÿn
 
ignÜe
hi 
w¬nšg
 you 
¬e
 
usšg
 
LCLINT
)

173 
	#msg
 
x_msg


	)

174 
	#dmsg
 
x_msg


	)

177 
	$x_msg
(cÚ¡ 
æags
, cÚ¡ *
fÜm©
, ...)

178 #ifdeà
__GNUC__


179 #ià
__USE_MINGW_ANSI_STDIO


180 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 2, 3)))

182 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 2, 3)))

187 
	`x_msg_va
(cÚ¡ 
æags
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬gli¡
);

193 
	`”rÜ_»£t
();

196 
	`”rÜs_to_¡d”r
();

198 
	`£t_suµ»ss_time¡amps
(
boŞ
 
suµ»s£d
);

200 
	`£t_machše_»adabË_ouut
(
boŞ
 
·r§bË
);

203 
	#SDL_CONSTRAIN
 (1<<0)

	)

204 
boŞ
 
	`£t_debug_Ëv–
(cÚ¡ 
Ëv–
, cÚ¡ 
æags
);

206 
boŞ
 
	`£t_mu‹_cutoff
(cÚ¡ 
cutoff
);

208 
	`g‘_debug_Ëv–
();

210 
	`g‘_mu‹_cutoff
();

212 cÚ¡ *
	`msg_æags_¡ršg
(cÚ¡ 
æags
, 
gc_¬’a
 *
gc
);

217 
FILE
 *
	`msg_å
(cÚ¡ 
æags
);

220 #iâdeà
ENABLE_SMALL


221 
	#ASSERT
(
x
èdØ{ ià(!(x)è{
	`as£¹_çed
(
__FILE__
, 
__LINE__
, #x);}
	}
} 
çl£
)

	)

223 
	#ASSERT
(
x
èdØ{ ià(!(x)è{
	`as£¹_çed
(
__FILE__
, 
__LINE__
, 
NULL
);}} 
çl£
)

	)

226 
	$as£¹_çed
(cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
cÚd™iÚ
)

227 
	`__©Œibu‹__
((
__nÜ‘uº__
));

231 #iâdeà
¡©ic_as£¹


232 
	#¡©ic_as£¹
(
ex´
, 
dŸgno¡ic
) \

233 (*
	`__O³nVPN_¡©ic_as£¹_funùiÚ
()) \

234 [!!(¡ruù { 
__”rÜ_if_Ãg©ive
 : (
ex´
è? 2 : -1; })]

	)

237 #ifdeà
ENABLE_DEBUG


238 
	`üash
();

244 
šlše
 
boŞ


245 
	$check_debug_Ëv–
(
Ëv–
)

247  (
Ëv–
 & 
M_DEBUG_LEVEL
è<ğ
x_debug_Ëv–
;

248 
	}
}

251 
šlše
 
boŞ


252 
	$msg_‹¡
(
æags
)

254  
	`check_debug_Ëv–
(
æags
è&& 
	`dÚt_mu‹
(flags);

255 
	}
}

258 
msg_fÜked
();

262 
İ’_sy¦og
(cÚ¡ *
pgmÇme
, 
boŞ
 
¡dio_to_nuÎ
);

264 
şo£_sy¦og
();

267 
»dœeù_¡dout_¡d”r
(cÚ¡ *
fe
, 
boŞ
 
­³nd
);

269 #ifdeà
_WIN32


271 
HANDLE
 
g‘_Üig_¡d”r
();

276 
İ’v²_ex™
(cÚ¡ 
¡©us
);

279 
out_of_memÜy
();

285 
	glšk_sock‘
;

286 
	gtuÁ­
;

288 
x_cs_šfo_Ëv–
;

289 
x_cs_v”bo£_Ëv–
;

290 
x_cs_”r_d–ay_ms
;

292 
»£t_check_¡©us
();

294 
£t_check_¡©us
(
šfo_Ëv–
, 
v”bo£_Ëv–
);

296 
x_check_¡©us
(
¡©us
,

297 cÚ¡ *
desütiÚ
,

298 
lšk_sock‘
 *
sock
,

299 
tuÁ­
 *
‰
);

301 
šlše
 

302 
	$check_¡©us
(
¡©us
, cÚ¡ *
desütiÚ
, 
lšk_sock‘
 *
sock
, 
tuÁ­
 *
‰
)

304 ià(
¡©us
 < 0 || 
	`check_debug_Ëv–
(
x_cs_v”bo£_Ëv–
))

306 
	`x_check_¡©us
(
¡©us
, 
desütiÚ
, 
sock
, 
‰
);

308 
	}
}

310 
šlše
 

311 
	$£t_check_¡©us_”rÜ_d–ay
(
mli£cÚds
)

313 
x_cs_”r_d–ay_ms
 = 
mli£cÚds
;

314 
	}
}

323 cÚ¡ *
x_msg_´efix
;

325 
msg_th»ad_š™
();

327 
msg_th»ad_unš™
();

329 
šlše
 

330 
	$msg_£t_´efix
(cÚ¡ *
´efix
)

332 
x_msg_´efix
 = 
´efix
;

333 
	}
}

335 
šlše
 const *

336 
	$msg_g‘_´efix
()

338  
x_msg_´efix
;

339 
	}
}

345 
	gvœtu®_ouut
;

347 cÚ¡ 
vœtu®_ouut
 *
x_msg_vœtu®_ouut
;

349 
šlše
 

350 
	$msg_£t_vœtu®_ouut
(cÚ¡ 
vœtu®_ouut
 *
vo
)

352 
x_msg_vœtu®_ouut
 = 
vo
;

353 
	}
}

355 
šlše
 cÚ¡ 
vœtu®_ouut
 *

356 
	$msg_g‘_vœtu®_ouut
()

358  
x_msg_vœtu®_ouut
;

359 
	}
}

365 
šlše
 
boŞ


366 
	$ignÜe_sys_”rÜ
(cÚ¡ 
”r
)

369 #ifdeà
_WIN32


370 ià(
”r
 =ğ
WSAEWOULDBLOCK
 ||ƒ¼ =ğ
WSAEINVAL
)

372  
Œue
;

375 ià(
”r
 =ğ
EAGAIN
)

377  
Œue
;

382 #ifdeà
ENOBUFS


384 ià(
”r
 =ğ
ENOBUFS
)

386  
Œue
;

391  
çl£
;

392 
	}
}

395 
šlše
 

396 
	$nÚçl
(cÚ¡ 
”r
)

398  
”r
 & 
M_FATAL
 ? (”¸^ M_FATALè| 
M_NONFATAL
 :ƒrr;

399 
	}
}

401 
	~"”¾ev–.h
"

	@event.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"bufãr.h
"

33 
	~"”rÜ.h
"

34 
	~"š‹g”.h
"

35 
	~"ev’t.h
"

36 
	~"fdmisc.h
"

38 
	~"memdbg.h
"

44 #ià
defšed
(
TARGET_DARWIN
)

45 
	#SELECT_PREFERRED_OVER_POLL


	)

51 #ifdeà
_WIN32


52 
	#SELECT
 0

	)

54 
	#SELECT
 1

	)

61 #ifdeà
FD_SETSIZE


62 
	#SELECT_MAX_FDS
 
FD_SETSIZE


	)

64 
	#SELECT_MAX_FDS
 256

	)

67 
šlše
 

68 
	$tv_to_ms_timeout
(cÚ¡ 
timev®
 *
tv
)

70 ià(
tv
->
tv_£c
 =ğ0 &&v->
tv_u£c
 == 0)

76  
	`max_št
(
tv
->
tv_£c
 * 1000 + (tv->
tv_u£c
 + 500) / 1000, 1);

78 
	}
}

80 #ifdeà
_WIN32


82 
	swe_£t


84 
ev’t_£t_funùiÚs
 
	mfunc
;

85 
boŞ
 
	mç¡
;

86 
HANDLE
 *
	mev’ts
;

87 
ev’t_£t_»tuº
 *
	me¤
;

88 
	mn_ev’ts
;

89 
	mÿ·c™y
;

92 
šlše
 

93 
	$we_£t_ev’t
(
we_£t
 *
wes
, 
i
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

95 
	`ASSERT
(
i
 >ğ0 && i < 
wes
->
ÿ·c™y
);

97 ià(
rwæags
 =ğ
EVENT_READ
)

99 
	`ASSERT
(
ev’t
->
»ad
 !ğ
NULL
);

100 
wes
->
ev’ts
[
i
] = 
ev’t
->
»ad
;

102 ià(
rwæags
 =ğ
EVENT_WRITE
)

104 
	`ASSERT
(
ev’t
->
wr™e
 !ğ
NULL
);

105 
wes
->
ev’ts
[
i
] = 
ev’t
->
wr™e
;

109 
	`msg
(
M_FATAL
, "çÈ”rÜ iÀwe_£t_ev’ts:„wæags=%d", 
rwæags
);

112 
wes
->
e¤
[
i
].
rwæags
 =„wflags;

113 
wes
->
e¤
[
i
].
¬g
 =‡rg;

114 
	}
}

116 
šlše
 
boŞ


117 
	$we_­³nd_ev’t
(
we_£t
 *
wes
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

119 ià(
rwæags
 & 
EVENT_WRITE
)

121 ià(
wes
->
n_ev’ts
 < wes->
ÿ·c™y
)

123 
	`we_£t_ev’t
(
wes
, wes->
n_ev’ts
, 
ev’t
, 
EVENT_WRITE
, 
¬g
);

124 ++
wes
->
n_ev’ts
;

128  
çl£
;

131 ià(
rwæags
 & 
EVENT_READ
)

133 ià(
wes
->
n_ev’ts
 < wes->
ÿ·c™y
)

135 
	`we_£t_ev’t
(
wes
, wes->
n_ev’ts
, 
ev’t
, 
EVENT_READ
, 
¬g
);

136 ++
wes
->
n_ev’ts
;

140  
çl£
;

143  
Œue
;

144 
	}
}

147 
	$we_d–_ev’t
(
we_£t
 *
wes
, 
ev’t_t
 
ev’t
)

149 
i
, 
j
 = 0;

150 cÚ¡ 
Ën
 = 
wes
->
n_ev’ts
;

152 
i
 = 0; i < 
Ën
; ++i)

154 cÚ¡ 
HANDLE
 
h
 = 
wes
->
ev’ts
[
i
];

155 ià(
h
 =ğ
ev’t
->
»ad
 || h =ğev’t->
wr™e
)

157 --
wes
->
n_ev’ts
;

161 ià(
i
 !ğ
j
)

163 
wes
->
ev’ts
[
j
] = wes->ev’ts[
i
];

164 
wes
->
e¤
[
j
] = wes->e¤[
i
];

166 ++
j
;

169 
	}
}

172 
	$we_d–_šdex
(
we_£t
 *
wes
, 
šdex
)

174 
i
;

175 
	`ASSERT
(
šdex
 >ğ0 && index < 
wes
->
n_ev’ts
);

176 
i
 = 
šdex
; i < 
wes
->
n_ev’ts
 - 1; ++i)

178 
wes
->
ev’ts
[
i
] = wes->events[i+1];

179 
wes
->
e¤
[
i
] = wes->esr[i+1];

181 --
wes
->
n_ev’ts
;

182 
	}
}

185 
	$we_g‘_rw_šdiûs
(
we_£t
 *
wes
, 
ev’t_t
 
ev’t
, *
ri
, *
wi
)

187 
i
;

188 *
ri
 = *
wi
 = -1;

189 
i
 = 0; i < 
wes
->
n_ev’ts
; ++i)

191 cÚ¡ 
HANDLE
 
h
 = 
wes
->
ev’ts
[
i
];

192 ià(
h
 =ğ
ev’t
->
»ad
)

194 
	`ASSERT
(*
ri
 == -1);

195 *
ri
 = 
i
;

197 ià(
h
 =ğ
ev’t
->
wr™e
)

199 
	`ASSERT
(*
wi
 == -1);

200 *
wi
 = 
i
;

203 
	}
}

206 
	$we_ä“
(
ev’t_£t
 *
es
)

208 
we_£t
 *
wes
 = (we_£ˆ*è
es
;

209 
	`ä“
(
wes
->
ev’ts
);

210 
	`ä“
(
wes
->
e¤
);

211 
	`ä“
(
wes
);

212 
	}
}

215 
	$we_»£t
(
ev’t_£t
 *
es
)

217 
we_£t
 *
wes
 = (we_£ˆ*è
es
;

218 
	`ASSERT
(
wes
->
ç¡
);

219 
wes
->
n_ev’ts
 = 0;

220 
	}
}

223 
	$we_d–
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
)

225 
we_£t
 *
wes
 = (we_£ˆ*è
es
;

226 
	`ASSERT
(!
wes
->
ç¡
);

227 
	`we_d–_ev’t
(
wes
, 
ev’t
);

228 
	}
}

231 
	$we_ùl
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

233 
we_£t
 *
wes
 = (we_£ˆ*è
es
;

235 
	`dmsg
(
D_EVENT_WAIT
, "WE_CTL‚=%dƒv=%°rwæags=0x%04x‡rg=" 
±r_fÜm©
,

236 
wes
->
n_ev’ts
,

237 
ev’t
,

238 
rwæags
,

239 (
±r_ty³
)
¬g
);

241 ià(
wes
->
ç¡
)

243 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
rwæags
, 
¬g
))

245 
”r
;

250 
ri
, 
wi
;

251 
Úe
 = -1;

252 
n
 = 0;

254 
	`we_g‘_rw_šdiûs
(
wes
, 
ev’t
, &
ri
, &
wi
);

255 ià(
wi
 >= 0)

257 
Úe
 = 
wi
;

258 ++
n
;

260 ià(
ri
 >= 0)

262 
Úe
 = 
ri
;

263 ++
n
;

265 
rwæags
)

268 
n
)

274 
	`we_d–_šdex
(
wes
, 
Úe
);

278 
	`we_d–_ev’t
(
wes
, 
ev’t
);

282 
	`ASSERT
(0);

286 
EVENT_READ
:

287 
n
)

290 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
EVENT_READ
, 
¬g
))

292 
”r
;

297 
	`we_£t_ev’t
(
wes
, 
Úe
, 
ev’t
, 
EVENT_READ
, 
¬g
);

301 
	`we_d–_šdex
(
wes
, 
wi
);

305 
	`ASSERT
(0);

309 
EVENT_WRITE
:

310 
n
)

313 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
EVENT_WRITE
, 
¬g
))

315 
”r
;

320 
	`we_£t_ev’t
(
wes
, 
Úe
, 
ev’t
, 
EVENT_WRITE
, 
¬g
);

324 
	`we_d–_šdex
(
wes
, 
ri
);

328 
	`ASSERT
(0);

332 
EVENT_READ
|
EVENT_WRITE
:

333 
n
)

336 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
EVENT_READ
|
EVENT_WRITE
, 
¬g
))

338 
”r
;

343 ià(
ri
 == -1)

345 
	`ASSERT
(
wi
 != -1);

346 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
EVENT_READ
, 
¬g
))

348 
”r
;

351 ià(
wi
 == -1)

353 ià(!
	`we_­³nd_ev’t
(
wes
, 
ev’t
, 
EVENT_WRITE
, 
¬g
))

355 
”r
;

360 
	`ASSERT
(0);

368 
	`ASSERT
(0);

373 
	`msg
(
M_FATAL
, "çÈ”rÜ iÀwe_ùl:„wæags=%d", 
rwæags
);

378 
”r
:

379 
	`msg
(
D_EVENT_ERRORS
, "E¼Ü: Wšdow »sourû†im™ WSA_MAXIMUM_WAIT_EVENTS (%dèha b“Àexûeded", 
WSA_MAXIMUM_WAIT_EVENTS
);

380 
	}
}

383 
	$we_wa™
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

385 
we_£t
 *
wes
 = (we_£ˆ*è
es
;

386 cÚ¡ 
timeout
 = 
	`tv_to_ms_timeout
(
tv
);

387 
DWORD
 
¡©us
;

389 
	`dmsg
(
D_EVENT_WAIT
, "WE_WAITƒÁ”‚=%do=%d", 
wes
->
n_ev’ts
, 
timeout
);

391 #ifdeà
ENABLE_DEBUG


392 ià(
	`check_debug_Ëv–
(
D_EVENT_WAIT
))

394 
i
;

395 
i
 = 0; i < 
wes
->
n_ev’ts
; ++i)

397 
	`dmsg
(
D_EVENT_WAIT
, "[%d]ƒv=%°rwæags=0x%04x‡rg=" 
±r_fÜm©
,

398 
i
,

399 
wes
->
ev’ts
[
i
],

400 
wes
->
e¤
[
i
].
rwæags
,

401 (
±r_ty³
)
wes
->
e¤
[
i
].
¬g
);

409 
¡©us
 = 
	`WSAWa™FÜMuÉËEv’ts
(

410 (
DWORD
è
wes
->
n_ev’ts
,

411 
wes
->
ev’ts
,

412 
FALSE
,

413 (
DWORD
) 0,

414 
FALSE
);

420 ià(
¡©us
 >ğ
WSA_WAIT_EVENT_0
 && stu < WSA_WAIT_EVENT_0 + (
DWORD
è
wes
->
n_ev’ts
)

422 
i
;

423 
j
 = 0;

424 
i
 = 0; i < 
wes
->
n_ev’ts
; ++i)

426 ià(
j
 >ğ
ou’
)

430 ià(
	`Wa™FÜSšgËObjeù
(
wes
->
ev’ts
[
i
], 0è=ğ
WAIT_OBJECT_0
)

432 *
out
 = 
wes
->
e¤
[
i
];

433 
	`dmsg
(
D_EVENT_WAIT
, "WE_WAIT†—v[%d,%d]„wæags=0x%04x‡rg=" 
±r_fÜm©
,

434 
i
, 
j
, 
out
->
rwæags
, (
±r_ty³
)out->
¬g
);

435 ++
j
;

436 ++
out
;

439  
j
;

452 ià(
timeout
 > 0)

454 
¡©us
 = 
	`WSAWa™FÜMuÉËEv’ts
(

455 (
DWORD
è
wes
->
n_ev’ts
,

456 
wes
->
ev’ts
,

457 
FALSE
,

458 (
DWORD
è
timeout
,

459 
FALSE
);

462 ià(
ou’
 >ğ1 && 
¡©us
 >ğ
WSA_WAIT_EVENT_0
 && stu < WSA_WAIT_EVENT_0 + (
DWORD
è
wes
->
n_ev’ts
)

464 *
out
 = 
wes
->
e¤
[
¡©us
 - 
WSA_WAIT_EVENT_0
];

465 
	`dmsg
(
D_EVENT_WAIT
, "WE_WAIT†—vrwæags=0x%04x‡rg=" 
±r_fÜm©
,

466 
out
->
rwæags
, (
±r_ty³
)out->
¬g
);

469 ià(
¡©us
 =ğ
WSA_WAIT_TIMEOUT
)

478 
	}
}

480 
ev’t_£t
 *

481 
	$we_š™
(*
maxev’ts
, 
æags
)

483 
we_£t
 *
wes
;

485 
	`dmsg
(
D_EVENT_WAIT
, "WE_INIT maxev’ts=%d fÏgs=0x%08x", *
maxev’ts
, 
æags
);

487 
	`ALLOC_OBJ_CLEAR
(
wes
, 
we_£t
);

490 
wes
->
func
.
ä“
 = 
we_ä“
;

491 
wes
->
func
.
»£t
 = 
we_»£t
;

492 
wes
->
func
.
d–
 = 
we_d–
;

493 
wes
->
func
.
ùl
 = 
we_ùl
;

494 
wes
->
func
.
wa™
 = 
we_wa™
;

496 ià(
æags
 & 
EVENT_METHOD_FAST
)

498 
wes
->
ç¡
 = 
Œue
;

500 
wes
->
n_ev’ts
 = 0;

503 
	`ASSERT
(*
maxev’ts
 > 0);

504 
wes
->
ÿ·c™y
 = 
	`mš_št
(*
maxev’ts
 * 2, 
WSA_MAXIMUM_WAIT_EVENTS
);

505 *
maxev’ts
 = 
	`mš_št
(*maxev’ts, 
WSA_MAXIMUM_WAIT_EVENTS
);

508 
	`ALLOC_ARRAY_CLEAR
(
wes
->
ev’ts
, 
HANDLE
, wes->
ÿ·c™y
);

511 
	`ALLOC_ARRAY_CLEAR
(
wes
->
e¤
, 
ev’t_£t_»tuº
, wes->
ÿ·c™y
);

513 
	`dmsg
(
D_EVENT_WAIT
, "WE_INIT maxevents=%d capacity=%d",

514 *
maxev’ts
, 
wes
->
ÿ·c™y
);

516  (
ev’t_£t
 *è
wes
;

517 
	}
}

521 #ià
EPOLL


523 
	s•_£t


525 
ev’t_£t_funùiÚs
 
	mfunc
;

526 
boŞ
 
	mç¡
;

527 
	m•fd
;

528 
	mmaxev’ts
;

529 
•Şl_ev’t
 *
	mev’ts
;

533 
	$•_ä“
(
ev’t_£t
 *
es
)

535 
•_£t
 *
•s
 = (•_£ˆ*è
es
;

536 
	`şo£
(
•s
->
•fd
);

537 
	`ä“
(
•s
->
ev’ts
);

538 
	`ä“
(
•s
);

539 
	}
}

542 
	$•_»£t
(
ev’t_£t
 *
es
)

544 cÚ¡ 
•_£t
 *
•s
 = (•_£ˆ*è
es
;

545 
	`ASSERT
(
•s
->
ç¡
);

546 
	}
}

549 
	$•_d–
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
)

551 
•Şl_ev’t
 
ev
;

552 
•_£t
 *
•s
 = (•_£ˆ*è
es
;

554 
	`dmsg
(
D_EVENT_WAIT
, "EP_DELƒv=%d", ()
ev’t
);

556 
	`ASSERT
(!
•s
->
ç¡
);

557 
	`CLEAR
(
ev
);

558 
	`•Şl_ùl
(
•s
->
•fd
, 
EPOLL_CTL_DEL
, 
ev’t
, &
ev
);

559 
	}
}

562 
	$•_ùl
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

564 
•_£t
 *
•s
 = (•_£ˆ*è
es
;

565 
•Şl_ev’t
 
ev
;

567 
	`CLEAR
(
ev
);

569 
ev
.
d©a
.
±r
 = 
¬g
;

570 ià(
rwæags
 & 
EVENT_READ
)

572 
ev
.
ev’ts
 |ğ
EPOLLIN
;

574 ià(
rwæags
 & 
EVENT_WRITE
)

576 
ev
.
ev’ts
 |ğ
EPOLLOUT
;

579 
	`dmsg
(
D_EVENT_WAIT
, "EP_CTL fd=%d„wæags=0x%04xƒv=0x%08x‡rg=" 
±r_fÜm©
,

580 ()
ev’t
,

581 
rwæags
,

582 ()
ev
.
ev’ts
,

583 (
±r_ty³
)
ev
.
d©a
.
±r
);

585 ià(
	`•Şl_ùl
(
•s
->
•fd
, 
EPOLL_CTL_MOD
, 
ev’t
, &
ev
) < 0)

587 ià(
”ºo
 =ğ
ENOENT
)

589 ià(
	`•Şl_ùl
(
•s
->
•fd
, 
EPOLL_CTL_ADD
, 
ev’t
, &
ev
) < 0)

591 
	`msg
(
M_ERR
, "EVENT:ƒpŞl_ùÈEPOLL_CTL_ADD faed, sd=%d", ()
ev’t
);

596 
	`msg
(
M_ERR
, "EVENT:ƒpŞl_ùÈEPOLL_CTL_MOD faed, sd=%d", ()
ev’t
);

599 
	}
}

602 
	$•_wa™
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

604 
•_£t
 *
•s
 = (•_£ˆ*è
es
;

605 
¡©
;

607 ià(
ou’
 > 
•s
->
maxev’ts
)

609 
ou’
 = 
•s
->
maxev’ts
;

612 
¡©
 = 
	`•Şl_wa™
(
•s
->
•fd
,ƒps->
ev’ts
, 
ou’
, 
	`tv_to_ms_timeout
(
tv
));

613 
	`ASSERT
(
¡©
 <ğ
ou’
);

615 ià(
¡©
 > 0)

617 
i
;

618 cÚ¡ 
•Şl_ev’t
 *
ev
 = 
•s
->
ev’ts
;

619 
ev’t_£t_»tuº
 *
e¤
 = 
out
;

620 
i
 = 0; i < 
¡©
; ++i)

622 
e¤
->
rwæags
 = 0;

623 ià(
ev
->
ev’ts
 & (
EPOLLIN
|
EPOLLPRI
|
EPOLLERR
|
EPOLLHUP
))

625 
e¤
->
rwæags
 |ğ
EVENT_READ
;

627 ià(
ev
->
ev’ts
 & 
EPOLLOUT
)

629 
e¤
->
rwæags
 |ğ
EVENT_WRITE
;

631 
e¤
->
¬g
 = 
ev
->
d©a
.
±r
;

632 
	`dmsg
(
D_EVENT_WAIT
, "EP_WAIT[%d]„wæags=0x%04xƒv=0x%08x‡rg=" 
±r_fÜm©
,

633 
i
, 
e¤
->
rwæags
, 
ev
->
ev’ts
, (
±r_ty³
ëv->
d©a
.
±r
);

634 ++
ev
;

635 ++
e¤
;

638  
¡©
;

639 
	}
}

641 
ev’t_£t
 *

642 
	$•_š™
(*
maxev’ts
, 
æags
)

644 
•_£t
 *
•s
;

645 
fd
;

647 
	`dmsg
(
D_EVENT_WAIT
, "EP_INIT maxev’ts=%d fÏgs=0x%08x", *
maxev’ts
, 
æags
);

650 
fd
 = 
	`•Şl_ü—‹
(*
maxev’ts
);

651 ià(
fd
 < 0)

653  
NULL
;

656 
	`£t_şÛxec
(
fd
);

658 
	`ALLOC_OBJ_CLEAR
(
•s
, 
•_£t
);

661 
•s
->
func
.
ä“
 = 
•_ä“
;

662 
•s
->
func
.
»£t
 = 
•_»£t
;

663 
•s
->
func
.
d–
 = 
•_d–
;

664 
•s
->
func
.
ùl
 = 
•_ùl
;

665 
•s
->
func
.
wa™
 = 
•_wa™
;

668 ià(
æags
 & 
EVENT_METHOD_FAST
)

670 
•s
->
ç¡
 = 
Œue
;

674 
	`ASSERT
(*
maxev’ts
 > 0);

675 
•s
->
maxev’ts
 = *maxevents;

676 
	`ALLOC_ARRAY_CLEAR
(
•s
->
ev’ts
, 
•Şl_ev’t
,ƒps->
maxev’ts
);

679 
•s
->
•fd
 = 
fd
;

681  (
ev’t_£t
 *è
•s
;

682 
	}
}

685 #ià
POLL


687 
	spo_£t


689 
ev’t_£t_funùiÚs
 
	mfunc
;

690 
boŞ
 
	mç¡
;

691 
pŞlfd
 *
	mev’ts
;

692 **
	m¬gs
;

693 
	mn_ev’ts
;

694 
	mÿ·c™y
;

698 
	$po_ä“
(
ev’t_£t
 *
es
)

700 
po_£t
 *
pos
 = (po_£ˆ*è
es
;

701 
	`ä“
(
pos
->
ev’ts
);

702 
	`ä“
(
pos
->
¬gs
);

703 
	`ä“
(
pos
);

704 
	}
}

707 
	$po_»£t
(
ev’t_£t
 *
es
)

709 
po_£t
 *
pos
 = (po_£ˆ*è
es
;

710 
	`ASSERT
(
pos
->
ç¡
);

711 
pos
->
n_ev’ts
 = 0;

712 
	}
}

715 
	$po_d–
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
)

717 
po_£t
 *
pos
 = (po_£ˆ*è
es
;

718 
i
;

720 
	`dmsg
(
D_EVENT_WAIT
, "PO_DELƒv=%d", ()
ev’t
);

722 
	`ASSERT
(!
pos
->
ç¡
);

723 
i
 = 0; i < 
pos
->
n_ev’ts
; ++i)

725 ià(
pos
->
ev’ts
[
i
].
fd
 =ğ
ev’t
)

727 
j
;

728 
j
 = 
i
; j < 
pos
->
n_ev’ts
 - 1; ++j)

730 
pos
->
ev’ts
[
j
] =…os->events[j+1];

731 
pos
->
¬gs
[
j
] =…os->args[j+1];

733 --
pos
->
n_ev’ts
;

737 
	}
}

739 
šlše
 

740 
	$po_£t_pŞlfd_ev’ts
(
pŞlfd
 *
pfdp
, 
rwæags
)

742 
pfdp
->
ev’ts
 = 0;

743 ià(
rwæags
 & 
EVENT_WRITE
)

745 
pfdp
->
ev’ts
 |ğ
POLLOUT
;

747 ià(
rwæags
 & 
EVENT_READ
)

749 
pfdp
->
ev’ts
 |ğ(
POLLIN
|
POLLPRI
);

751 
	}
}

753 
šlše
 
boŞ


754 
	$po_­³nd_ev’t
(
po_£t
 *
pos
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

756 ià(
pos
->
n_ev’ts
 <…os->
ÿ·c™y
)

758 
pŞlfd
 *
pfdp
 = &
pos
->
ev’ts
[pos->
n_ev’ts
];

759 
pfdp
->
fd
 = 
ev’t
;

760 
pos
->
¬gs
[pos->
n_ev’ts
] = 
¬g
;

761 
	`po_£t_pŞlfd_ev’ts
(
pfdp
, 
rwæags
);

762 ++
pos
->
n_ev’ts
;

763  
Œue
;

767  
çl£
;

769 
	}
}

772 
	$po_ùl
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

774 
po_£t
 *
pos
 = (po_£ˆ*è
es
;

776 
	`dmsg
(
D_EVENT_WAIT
, "PO_CTL„wæags=0x%04xƒv=%d‡rg=" 
±r_fÜm©
,

777 
rwæags
, ()
ev’t
, (
±r_ty³
)
¬g
);

779 ià(
pos
->
ç¡
)

781 ià(!
	`po_­³nd_ev’t
(
pos
, 
ev’t
, 
rwæags
, 
¬g
))

783 
”r
;

788 
i
;

789 
i
 = 0; i < 
pos
->
n_ev’ts
; ++i)

791 
pŞlfd
 *
pfdp
 = &
pos
->
ev’ts
[
i
];

792 ià(
pfdp
->
fd
 =ğ
ev’t
)

794 
pos
->
¬gs
[
i
] = 
¬g
;

795 
	`po_£t_pŞlfd_ev’ts
(
pfdp
, 
rwæags
);

796 
dÚe
;

799 ià(!
	`po_­³nd_ev’t
(
pos
, 
ev’t
, 
rwæags
, 
¬g
))

801 
”r
;

805 
dÚe
:

808 
”r
:

809 
	`msg
(
D_EVENT_ERRORS
, "Error:…oll:oo many I/O waitƒvents");

810 
	}
}

813 
	$po_wa™
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

815 
po_£t
 *
pos
 = (po_£ˆ*è
es
;

816 
¡©
;

818 
¡©
 = 
	`pŞl
(
pos
->
ev’ts
,…os->
n_ev’ts
, 
	`tv_to_ms_timeout
(
tv
));

820 
	`ASSERT
(
¡©
 <ğ
pos
->
n_ev’ts
);

822 ià(
¡©
 > 0)

824 
i
, 
j
 = 0;

825 cÚ¡ 
pŞlfd
 *
pfdp
 = 
pos
->
ev’ts
;

826 
i
 = 0; i < 
pos
->
n_ev’ts
 && 
j
 < 
ou’
; ++i)

828 ià(
pfdp
->
»v’ts
 & (
POLLIN
|
POLLPRI
|
POLLERR
|
POLLHUP
|
POLLOUT
))

830 
out
->
rwæags
 = 0;

831 ià(
pfdp
->
»v’ts
 & (
POLLIN
|
POLLPRI
|
POLLERR
|
POLLHUP
))

833 
out
->
rwæags
 |ğ
EVENT_READ
;

835 ià(
pfdp
->
»v’ts
 & 
POLLOUT
)

837 
out
->
rwæags
 |ğ
EVENT_WRITE
;

839 
out
->
¬g
 = 
pos
->
¬gs
[
i
];

840 
	`dmsg
(
D_EVENT_WAIT
, "PO_WAIT[%d,%d] fd=%d„ev=0x%08x„wæags=0x%04x‡rg=" 
±r_fÜm©
 " %s",

841 
i
, 
j
, 
pfdp
->
fd
,…fdp->
»v’ts
, 
out
->
rwæags
, (
±r_ty³
)out->
¬g
, 
pos
->
ç¡
 ? "" : "[scalable]");

842 ++
out
;

843 ++
j
;

845 ià(
pfdp
->
»v’ts
)

847 
	`msg
(
D_EVENT_ERRORS
, "E¼Ü:…Şl: unknowÀ»v’ts=0x%04x", ()
pfdp
->
»v’ts
);

849 ++
pfdp
;

851  
j
;

853  
¡©
;

854 
	}
}

856 
ev’t_£t
 *

857 
	$po_š™
(*
maxev’ts
, 
æags
)

859 
po_£t
 *
pos
;

861 
	`dmsg
(
D_EVENT_WAIT
, "PO_INIT maxev’ts=%d fÏgs=0x%08x", *
maxev’ts
, 
æags
);

863 
	`ALLOC_OBJ_CLEAR
(
pos
, 
po_£t
);

866 
pos
->
func
.
ä“
 = 
po_ä“
;

867 
pos
->
func
.
»£t
 = 
po_»£t
;

868 
pos
->
func
.
d–
 = 
po_d–
;

869 
pos
->
func
.
ùl
 = 
po_ùl
;

870 
pos
->
func
.
wa™
 = 
po_wa™
;

872 ià(
æags
 & 
EVENT_METHOD_FAST
)

874 
pos
->
ç¡
 = 
Œue
;

877 
pos
->
n_ev’ts
 = 0;

880 
	`ASSERT
(*
maxev’ts
 > 0);

881 
pos
->
ÿ·c™y
 = *
maxev’ts
;

884 
	`ALLOC_ARRAY_CLEAR
(
pos
->
ev’ts
, 
pŞlfd
,…os->
ÿ·c™y
);

887 
	`ALLOC_ARRAY_CLEAR
(
pos
->
¬gs
, *,…os->
ÿ·c™y
);

889  (
ev’t_£t
 *è
pos
;

890 
	}
}

893 #ià
SELECT


895 
	s£_£t


897 
ev’t_£t_funùiÚs
 
	mfunc
;

898 
boŞ
 
	mç¡
;

899 
fd_£t
 
	m»adfds
;

900 
fd_£t
 
	mwr™efds
;

901 **
	m¬gs
;

902 
	mmaxfd
;

903 
	mÿ·c™y
;

907 
	$£_ä“
(
ev’t_£t
 *
es
)

909 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

910 
	`ä“
(
£s
->
¬gs
);

911 
	`ä“
(
£s
);

912 
	}
}

915 
	$£_»£t
(
ev’t_£t
 *
es
)

917 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

918 
i
;

919 
	`ASSERT
(
£s
->
ç¡
);

921 
	`dmsg
(
D_EVENT_WAIT
, "SE_RESET");

923 
	`FD_ZERO
(&
£s
->
»adfds
);

924 
	`FD_ZERO
(&
£s
->
wr™efds
);

925 
i
 = 0; i <ğ
£s
->
maxfd
; ++i)

927 
£s
->
¬gs
[
i
] = 
NULL
;

929 
£s
->
maxfd
 = -1;

930 
	}
}

933 
	$£_d–
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
)

935 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

936 
	`ASSERT
(!
£s
->
ç¡
);

938 
	`dmsg
(
D_EVENT_WAIT
, "SE_DELƒv=%d", ()
ev’t
);

940 ià(
ev’t
 >ğ0 &&ƒv’ˆ< 
£s
->
ÿ·c™y
)

942 
	`FD_CLR
(
ev’t
, &
£s
->
»adfds
);

943 
	`FD_CLR
(
ev’t
, &
£s
->
wr™efds
);

944 
£s
->
¬gs
[
ev’t
] = 
NULL
;

948 
	`msg
(
D_EVENT_ERRORS
, "Error: select/se_del:oo many I/O waitƒvents");

951 
	}
}

954 
	$£_ùl
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

956 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

958 
	`dmsg
(
D_EVENT_WAIT
, "SE_CTL„wæags=0x%04xƒv=%d fa¡=%d c­=%d maxfd=%d‡rg=" 
±r_fÜm©
,

959 
rwæags
, ()
ev’t
, ()
£s
->
ç¡
, ses->
ÿ·c™y
, ses->
maxfd
, (
±r_ty³
)
¬g
);

961 ià(
ev’t
 >ğ0 &&ƒv’ˆ< 
£s
->
ÿ·c™y
)

963 
£s
->
maxfd
 = 
	`max_št
(
ev’t
, ses->maxfd);

964 
£s
->
¬gs
[
ev’t
] = 
¬g
;

965 ià(
£s
->
ç¡
)

967 ià(
rwæags
 & 
EVENT_READ
)

969 
	`İ’v²_fd_£t
(
ev’t
, &
£s
->
»adfds
);

971 ià(
rwæags
 & 
EVENT_WRITE
)

973 
	`İ’v²_fd_£t
(
ev’t
, &
£s
->
wr™efds
);

978 ià(
rwæags
 & 
EVENT_READ
)

980 
	`İ’v²_fd_£t
(
ev’t
, &
£s
->
»adfds
);

984 
	`FD_CLR
(
ev’t
, &
£s
->
»adfds
);

986 ià(
rwæags
 & 
EVENT_WRITE
)

988 
	`İ’v²_fd_£t
(
ev’t
, &
£s
->
wr™efds
);

992 
	`FD_CLR
(
ev’t
, &
£s
->
wr™efds
);

998 
	`msg
(
D_EVENT_ERRORS
, "Error: select:oo many I/O waitƒvents, fd=%d cap=%d",

999 (è
ev’t
,

1000 
£s
->
ÿ·c™y
);

1002 
	}
}

1005 
	$£_wa™_»tuº
(
£_£t
 *
£s
,

1006 
fd_£t
 *
»ad
,

1007 
fd_£t
 *
wr™e
,

1008 
ev’t_£t_»tuº
 *
out
,

1009 
ou’
)

1011 
i
, 
j
 = 0;

1012 
i
 = 0; i <ğ
£s
->
maxfd
 && 
j
 < 
ou’
; ++i)

1014 cÚ¡ 
boŞ
 
r
 = 
	`FD_ISSET
(
i
, 
»ad
);

1015 cÚ¡ 
boŞ
 
w
 = 
	`FD_ISSET
(
i
, 
wr™e
);

1016 ià(
r
 || 
w
)

1018 
out
->
rwæags
 = 0;

1019 ià(
r
)

1021 
out
->
rwæags
 |ğ
EVENT_READ
;

1023 ià(
w
)

1025 
out
->
rwæags
 |ğ
EVENT_WRITE
;

1027 
out
->
¬g
 = 
£s
->
¬gs
[
i
];

1028 
	`dmsg
(
D_EVENT_WAIT
, "SE_WAIT[%d,%d]„wæags=0x%04x‡rg=" 
±r_fÜm©
,

1029 
i
, 
j
, 
out
->
rwæags
, (
±r_ty³
)out->
¬g
);

1030 ++
out
;

1031 ++
j
;

1034  
j
;

1035 
	}
}

1038 
	$£_wa™_ç¡
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

1040 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

1041 
timev®
 
tv_tmp
 = *
tv
;

1042 
¡©
;

1044 
	`dmsg
(
D_EVENT_WAIT
, "SE_WAIT_FAST maxfd=%dv=%d/%d",

1045 
£s
->
maxfd
,

1046 ()
tv_tmp
.
tv_£c
,

1047 ()
tv_tmp
.
tv_u£c
);

1049 
¡©
 = 
	`£Ëù
(
£s
->
maxfd
 + 1, &£s->
»adfds
, &£s->
wr™efds
, 
NULL
, &
tv_tmp
);

1051 ià(
¡©
 > 0)

1053 
¡©
 = 
	`£_wa™_»tuº
(
£s
, &£s->
»adfds
, &£s->
wr™efds
, 
out
, 
ou’
);

1056  
¡©
;

1057 
	}
}

1060 
	$£_wa™_sÿÏbË
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

1062 
£_£t
 *
£s
 = (£_£ˆ*è
es
;

1063 
timev®
 
tv_tmp
 = *
tv
;

1064 
fd_£t
 
»ad
 = 
£s
->
»adfds
;

1065 
fd_£t
 
wr™e
 = 
£s
->
wr™efds
;

1066 
¡©
;

1068 
	`dmsg
(
D_EVENT_WAIT
, "SE_WAIT_SCALEABLE maxfd=%dv=%d/%d",

1069 
£s
->
maxfd
, ()
tv_tmp
.
tv_£c
, (év_tmp.
tv_u£c
);

1071 
¡©
 = 
	`£Ëù
(
£s
->
maxfd
 + 1, &
»ad
, &
wr™e
, 
NULL
, &
tv_tmp
);

1073 ià(
¡©
 > 0)

1075 
¡©
 = 
	`£_wa™_»tuº
(
£s
, &
»ad
, &
wr™e
, 
out
, 
ou’
);

1078  
¡©
;

1079 
	}
}

1081 
ev’t_£t
 *

1082 
	$£_š™
(*
maxev’ts
, 
æags
)

1084 
£_£t
 *
£s
;

1086 
	`dmsg
(
D_EVENT_WAIT
, "SE_INIT maxev’ts=%d fÏgs=0x%08x", *
maxev’ts
, 
æags
);

1088 
	`ALLOC_OBJ_CLEAR
(
£s
, 
£_£t
);

1091 
£s
->
func
.
ä“
 = 
£_ä“
;

1092 
£s
->
func
.
»£t
 = 
£_»£t
;

1093 
£s
->
func
.
d–
 = 
£_d–
;

1094 
£s
->
func
.
ùl
 = 
£_ùl
;

1095 
£s
->
func
.
wa™
 = 
£_wa™_sÿÏbË
;

1097 ià(
æags
 & 
EVENT_METHOD_FAST
)

1099 
£s
->
ç¡
 = 
Œue
;

1100 
£s
->
func
.
wa™
 = 
£_wa™_ç¡
;

1104 
£s
->
maxfd
 = -1;

1107 
	`ASSERT
(*
maxev’ts
 > 0);

1108 *
maxev’ts
 = 
	`mš_št
(*maxev’ts, 
SELECT_MAX_FDS
);

1109 
£s
->
ÿ·c™y
 = 
SELECT_MAX_FDS
;

1112 
	`ALLOC_ARRAY_CLEAR
(
£s
->
¬gs
, *, ses->
ÿ·c™y
);

1114  (
ev’t_£t
 *è
£s
;

1115 
	}
}

1118 
ev’t_£t
 *

1119 
	$ev’t_£t_š™_sim¶e
(*
maxev’ts
, 
æags
)

1121 
ev’t_£t
 *
»t
 = 
NULL
;

1122 #ifdeà
_WIN32


1123 
»t
 = 
	`we_š™
(
maxev’ts
, 
æags
);

1124 #–ià
POLL
 && 
SELECT


1126 ià(
æags
 & 
EVENT_METHOD_US_TIMEOUT
)

1128 
»t
 = 
	`£_š™
(
maxev’ts
, 
æags
);

1131 #ifdeà
SELECT_PREFERRED_OVER_POLL


1132 ià(!
»t
)

1134 
»t
 = 
	`£_š™
(
maxev’ts
, 
æags
);

1136 ià(!
»t
)

1138 
»t
 = 
	`po_š™
(
maxev’ts
, 
æags
);

1141 ià(!
»t
)

1143 
»t
 = 
	`po_š™
(
maxev’ts
, 
æags
);

1145 ià(!
»t
)

1147 
»t
 = 
	`£_š™
(
maxev’ts
, 
æags
);

1150 #–ià
POLL


1151 
»t
 = 
	`po_š™
(
maxev’ts
, 
æags
);

1152 #–ià
SELECT


1153 
»t
 = 
	`£_š™
(
maxev’ts
, 
æags
);

1155 #”rÜ 
At
 
Ëa¡
 
Úe
 
of
 
pŞl
, 
£Ëù
, 
Ü
 
WSAWa™FÜMuÉËEv’ts
 
mu¡
 
be
 
suµÜ‹d
 
by
 
the
 
k”Ãl


1157 
	`ASSERT
(
»t
);

1158  
»t
;

1159 
	}
}

1161 
ev’t_£t
 *

1162 
	$ev’t_£t_š™_sÿÏbË
(*
maxev’ts
, 
æags
)

1164 
ev’t_£t
 *
»t
 = 
NULL
;

1165 #ià
EPOLL


1166 
»t
 = 
	`•_š™
(
maxev’ts
, 
æags
);

1167 ià(!
»t
)

1169 
	`msg
(
M_WARN
, "Note: sys_epoll API is unavailable, falling backo…oll/select API");

1170 
»t
 = 
	`ev’t_£t_š™_sim¶e
(
maxev’ts
, 
æags
);

1173 
»t
 = 
	`ev’t_£t_š™_sim¶e
(
maxev’ts
, 
æags
);

1175 
	`ASSERT
(
»t
);

1176  
»t
;

1177 
	}
}

1179 
ev’t_£t
 *

1180 
	$ev’t_£t_š™
(*
maxev’ts
, 
æags
)

1182 ià(
æags
 & 
EVENT_METHOD_FAST
)

1184  
	`ev’t_£t_š™_sim¶e
(
maxev’ts
, 
æags
);

1188  
	`ev’t_£t_š™_sÿÏbË
(
maxev’ts
, 
æags
);

1190 
	}
}

	@event.h

24 #iâdeà
EVENT_H


25 
	#EVENT_H


	)

27 
	~"wš32.h
"

28 
	~"sig.h
"

29 
	~"³rf.h
"

35 
	#EVENT_UNDEF
 4

	)

36 
	#EVENT_READ
 (1<<0)

	)

37 
	#EVENT_WRITE
 (1<<1)

	)

41 
	#EVENT_METHOD_US_TIMEOUT
 (1<<0)

	)

42 
	#EVENT_METHOD_FAST
 (1<<1)

	)

44 #ifdeà
_WIN32


46 cÚ¡ 
	trw_hªdË
 *
	tev’t_t
;

48 
	#UNDEFINED_EVENT
 (
NULL
)

	)

52 
	tev’t_t
;

54 
	#UNDEFINED_EVENT
 (-1)

	)

58 
	gev’t_£t
;

59 
	gev’t_£t_»tuº
;

61 
	sev’t_£t_funùiÚs


63 (*
	mä“
)(
ev’t_£t
 *
	mes
);

64 (*
	m»£t
)(
ev’t_£t
 *
	mes
);

65 (*
	md–
)(
ev’t_£t
 *
	mes
, 
ev’t_t
 
	mev’t
);

66 (*
	mùl
)(
ev’t_£t
 *
	mes
, 
ev’t_t
 
	mev’t
, 
	mrwæags
, *
	m¬g
);

74 (*
	mwa™
)(
ev’t_£t
 *
	mes
, cÚ¡ 
timev®
 *
	mtv
, 
ev’t_£t_»tuº
 *
	mout
, 
	mou’
);

77 
	sev’t_£t_»tuº


79 
	mrwæags
;

80 *
	m¬g
;

83 
	sev’t_£t


85 
ev’t_£t_funùiÚs
 
	mfunc
;

95 
ev’t_£t
 *
ev’t_£t_š™
(*
maxev’ts
, 
æags
);

97 
šlše
 

98 
	$ev’t_ä“
(
ev’t_£t
 *
es
)

100 ià(
es
)

102 (*
es
->
func
.
ä“
)(es);

104 
	}
}

106 
šlše
 

107 
	$ev’t_»£t
(
ev’t_£t
 *
es
)

109 (*
es
->
func
.
»£t
)(es);

110 
	}
}

112 
šlše
 

113 
	$ev’t_d–
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
)

115 (*
es
->
func
.
d–
)Ós, 
ev’t
);

116 
	}
}

118 
šlše
 

119 
	$ev’t_ùl
(
ev’t_£t
 *
es
, 
ev’t_t
 
ev’t
, 
rwæags
, *
¬g
)

121 (*
es
->
func
.
ùl
)Ós, 
ev’t
, 
rwæags
, 
¬g
);

122 
	}
}

124 
šlše
 

125 
	$ev’t_wa™
(
ev’t_£t
 *
es
, cÚ¡ 
timev®
 *
tv
, 
ev’t_£t_»tuº
 *
out
, 
ou’
)

127 
»t
;

128 
	`³rf_push
(
PERF_IO_WAIT
);

129 
»t
 = (*
es
->
func
.
wa™
)Ós, 
tv
, 
out
, 
ou’
);

130 
	`³rf_pİ
();

131  
»t
;

132 
	}
}

134 
šlše
 

135 
	$ev’t_£t_»tuº_š™
(
ev’t_£t_»tuº
 *
e¤
)

137 
e¤
->
rwæags
 = 0;

138 
e¤
->
¬g
 = 
NULL
;

139 
	}
}

141 #ifdeà
_WIN32


143 
šlše
 

144 
	$wa™_sigÇl
(
ev’t_£t
 *
es
, *
¬g
)

146 ià(
	`HANDLE_DEFINED
(
wš32_sigÇl
.
š
.
»ad
))

148 
	`ev’t_ùl
(
es
, &
wš32_sigÇl
.
š
, 
EVENT_READ
, 
¬g
);

150 
	}
}

154 
šlše
 

155 
	$wa™_sigÇl
(
ev’t_£t
 *
es
, *
¬g
)

157 
	}
}

	@fdmisc.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"fdmisc.h
"

33 
	~"”rÜ.h
"

35 
	~"memdbg.h
"

38 
boŞ


39 
	$£t_nÚblock_aùiÚ
(
fd
)

41 #ifdeà
_WIN32


42 
u_lÚg
 
¬g
 = 1;

43 ià(
	`ioùlsock‘
(
fd
, 
FIONBIO
, &
¬g
))

45  
çl£
;

48 ià(
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
) < 0)

50  
çl£
;

53  
Œue
;

54 
	}
}

57 
boŞ


58 
	$£t_şÛxec_aùiÚ
(
fd
)

60 #iâdeà
_WIN32


61 ià(
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
) < 0)

63  
çl£
;

66  
Œue
;

67 
	}
}

71 
	$£t_nÚblock
(
fd
)

73 ià(!
	`£t_nÚblock_aùiÚ
(
fd
))

75 
	`msg
(
M_ERR
, "Set socketo‚on-blocking mode failed");

77 
	}
}

81 
	$£t_şÛxec
(
fd
)

83 ià(!
	`£t_şÛxec_aùiÚ
(
fd
))

85 
	`msg
(
M_ERR
, "Set FD_CLOEXEC flag on file descriptor failed");

87 
	}
}

	@fdmisc.h

24 #iâdeà
FD_MISC_H


25 
	#FD_MISC_H


	)

27 
	~"basic.h
"

28 
	~"”rÜ.h
"

29 
	~"sysh—d.h
"

31 
boŞ
 
£t_nÚblock_aùiÚ
(
fd
);

33 
boŞ
 
£t_şÛxec_aùiÚ
(
fd
);

35 
£t_nÚblock
(
fd
);

37 
£t_şÛxec
(
fd
);

39 
šlše
 

40 
	$İ’v²_fd_£t
(
fd
, 
fd_£t
 *
£
)

42 #iâdeà
_WIN32


43 
	`ASSERT
(
fd
 >ğ0 && fd < 
FD_SETSIZE
);

45 
	`FD_SET
(
fd
, 
£
);

46 
	}
}

47 #undeà
FD_SET


	@forward-inline.h

24 #iâdeà
FORWARD_INLINE_H


25 
	#FORWARD_INLINE_H


	)

34 
šlše
 

35 
	$check_s
(
cÚ‹xt
 *
c
)

37 #ià
	`defšed
(
ENABLE_CRYPTO
)

38 
	`check_s_dowÜk
(
cÚ‹xt
 *
c
);

40 ià(
c
->
c2
.
s_muÉi
)

42 
	`check_s_dowÜk
(
c
);

45 
	}
}

51 
šlše
 

52 
	$check_s_”rÜs
(
cÚ‹xt
 *
c
)

54 #ià
	`defšed
(
ENABLE_CRYPTO
)

55 
	`check_s_”rÜs_co
(
cÚ‹xt
 *
c
);

57 
	`check_s_”rÜs_nco
(
cÚ‹xt
 *
c
);

59 ià(
c
->
c2
.
s_muÉi
 && c->c2.
s_ex™_sigÇl
)

61 ià(
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
c
->
c2
.
lšk_sock‘
))

63 ià(
c
->
c2
.
s_muÉi
->
n_soá_”rÜs
)

65 
	`check_s_”rÜs_co
(
c
);

70 ià(
c
->
c2
.
s_muÉi
->
n_h¬d_”rÜs
)

72 
	`check_s_”rÜs_nco
(
c
);

77 
	}
}

83 
šlše
 

84 
	$check_šcomšg_cÚŒŞ_chªÃl
(
cÚ‹xt
 *
c
)

86 #ià
P2MP


87 
	`check_šcomšg_cÚŒŞ_chªÃl_dowÜk
(
cÚ‹xt
 *
c
);

89 ià(
	`s_‹¡_·ylßd_Ën
(
c
->
c2
.
s_muÉi
) > 0)

91 
	`check_šcomšg_cÚŒŞ_chªÃl_dowÜk
(
c
);

94 
	}
}

100 
šlše
 

101 
	$check_cÚÃùiÚ_e¡ablished
(
cÚ‹xt
 *
c
)

103 
	`check_cÚÃùiÚ_e¡ablished_dowÜk
(
cÚ‹xt
 *
c
);

105 ià(
	`ev’t_timeout_defšed
(&
c
->
c2
.
wa™_fÜ_cÚÃù
))

107 
	`check_cÚÃùiÚ_e¡ablished_dowÜk
(
c
);

109 
	}
}

114 
šlše
 

115 
	$check_add_rou‹s
(
cÚ‹xt
 *
c
)

117 
	`check_add_rou‹s_dowÜk
(
cÚ‹xt
 *
c
);

119 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
rou‹_wakeup
, &c->c2.
timev®
, 
ETT_DEFAULT
))

121 
	`check_add_rou‹s_dowÜk
(
c
);

123 
	}
}

128 
šlše
 

129 
	$check_šaùiv™y_timeout
(
cÚ‹xt
 *
c
)

131 
	`check_šaùiv™y_timeout_dowÜk
(
cÚ‹xt
 *
c
);

133 ià(
c
->
İtiÚs
.
šaùiv™y_timeout


134 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
šaùiv™y_š‹rv®
, &c->c2.
timev®
, 
ETT_DEFAULT
))

136 
	`check_šaùiv™y_timeout_dowÜk
(
c
);

138 
	}
}

140 #ià
P2MP


142 
šlše
 

143 
	$check_£rv”_pŞl_timeout
(
cÚ‹xt
 *
c
)

145 
	`check_£rv”_pŞl_timeout_dowÜk
(
cÚ‹xt
 *
c
);

147 ià(
c
->
İtiÚs
.
û
.
cÚÃù_timeout


148 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
£rv”_pŞl_š‹rv®
, &c->c2.
timev®
, 
ETT_DEFAULT
))

150 
	`check_£rv”_pŞl_timeout_dowÜk
(
c
);

152 
	}
}

157 
šlše
 

158 
	$check_scheduËd_ex™
(
cÚ‹xt
 *
c
)

160 
	`check_scheduËd_ex™_dowÜk
(
cÚ‹xt
 *
c
);

162 ià(
	`ev’t_timeout_defšed
(&
c
->
c2
.
scheduËd_ex™
))

164 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
scheduËd_ex™
, &c->c2.
timev®
, 
ETT_DEFAULT
))

166 
	`check_scheduËd_ex™_dowÜk
(
c
);

169 
	}
}

175 
šlše
 

176 
	$check_¡©us_fe
(
cÚ‹xt
 *
c
)

178 
	`check_¡©us_fe_dowÜk
(
cÚ‹xt
 *
c
);

180 ià(
c
->
c1
.
¡©us_ouut
)

182 ià(
	`¡©us_Œigg”_tv
(
c
->
c1
.
¡©us_ouut
, &c->
c2
.
timev®
))

184 
	`check_¡©us_fe_dowÜk
(
c
);

187 
	}
}

189 #ifdeà
ENABLE_FRAGMENT


193 
šlše
 

194 
	$check_äagm’t
(
cÚ‹xt
 *
c
)

196 
	`check_äagm’t_dowÜk
(
cÚ‹xt
 *
c
);

198 ià(
c
->
c2
.
äagm’t
)

200 
	`check_äagm’t_dowÜk
(
c
);

202 
	}
}

205 #ià
P2MP


210 
šlše
 

211 
	$check_push_»que¡
(
cÚ‹xt
 *
c
)

213 
	`check_push_»que¡_dowÜk
(
cÚ‹xt
 *
c
);

215 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
push_»que¡_š‹rv®
, &c->c2.
timev®
, 
ETT_DEFAULT
))

217 
	`check_push_»que¡_dowÜk
(
c
);

219 
	}
}

223 #ifdeà
ENABLE_CRYPTO


227 
šlše
 

228 
	$check_·ck‘_id_³rsi¡_æush
(
cÚ‹xt
 *
c
)

230 ià(
	`·ck‘_id_³rsi¡_’abËd
(&
c
->
c1
.
pid_³rsi¡
)

231 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
·ck‘_id_³rsi¡_š‹rv®
, &c->c2.
timev®
, 
ETT_DEFAULT
))

233 
	`·ck‘_id_³rsi¡_§ve
(&
c
->
c1
.
pid_³rsi¡
);

235 
	}
}

242 
šlše
 

243 
	$cÚ‹xt_immedŸ‹_»scheduË
(
cÚ‹xt
 *
c
)

245 
c
->
c2
.
timev®
.
tv_£c
 = 0;

246 
c
->
c2
.
timev®
.
tv_u£c
 = 0;

247 
	}
}

249 
šlše
 

250 
	$cÚ‹xt_»scheduË_£c
(
cÚ‹xt
 *
c
, 
£c
)

252 ià(
£c
 < 0)

254 
£c
 = 0;

256 ià(
£c
 < 
c
->
c2
.
timev®
.
tv_£c
)

258 
c
->
c2
.
timev®
.
tv_£c
 = 
£c
;

259 
c
->
c2
.
timev®
.
tv_u£c
 = 0;

261 
	}
}

263 
šlše
 
lšk_sock‘_šfo
 *

264 
	$g‘_lšk_sock‘_šfo
(
cÚ‹xt
 *
c
)

266 ià(
c
->
c2
.
lšk_sock‘_šfo
)

268  
c
->
c2
.
lšk_sock‘_šfo
;

272  &
c
->
c2
.
lšk_sock‘
->
šfo
;

274 
	}
}

276 
šlše
 

277 
	$»gi¡”_aùiv™y
(
cÚ‹xt
 *
c
, cÚ¡ 
size
)

279 ià(
c
->
İtiÚs
.
šaùiv™y_timeout
)

281 
c
->
c2
.
šaùiv™y_by‹s
 +ğ
size
;

282 ià(
c
->
c2
.
šaùiv™y_by‹s
 >ğc->
İtiÚs
.
šaùiv™y_mšimum_by‹s
)

284 
c
->
c2
.
šaùiv™y_by‹s
 = 0;

285 
	`ev’t_timeout_»£t
(&
c
->
c2
.
šaùiv™y_š‹rv®
);

288 
	}
}

294 
šlše
 

295 
	$p2p_iow_æags
(cÚ¡ 
cÚ‹xt
 *
c
)

297 
æags
 = (
IOW_SHAPER
|
IOW_CHECK_RESIDUAL
|
IOW_FRAG
|
IOW_READ
|
IOW_WAIT_SIGNAL
);

298 ià(
c
->
c2
.
to_lšk
.
Ën
 > 0)

300 
æags
 |ğ
IOW_TO_LINK
;

302 ià(
c
->
c2
.
to_tun
.
Ën
 > 0)

304 
æags
 |ğ
IOW_TO_TUN
;

306  
æags
;

307 
	}
}

313 
šlše
 

314 
	$io_wa™
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

316 
	`io_wa™_dowÜk
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
);

318 ià(
c
->
c2
.
ç¡_io
 && (
æags
 & (
IOW_TO_TUN
|
IOW_TO_LINK
|
IOW_MBUF
)))

321 
»t
 = 0;

322 ià(
æags
 & 
IOW_TO_TUN
)

324 
»t
 |ğ
TUN_WRITE
;

326 ià(
æags
 & (
IOW_TO_LINK
|
IOW_MBUF
))

328 
»t
 |ğ
SOCKET_WRITE
;

330 
c
->
c2
.
ev’t_£t_¡©us
 = 
»t
;

335 
	`io_wa™_dowÜk
(
c
, 
æags
);

337 
	}
}

339 
	#CONNECTION_ESTABLISHED
(
c
è(
	`g‘_lšk_sock‘_šfo
(c)->
cÚÃùiÚ_e¡ablished
)

	)

	@forward.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"fÜw¬d.h
"

33 
	~"š™.h
"

34 
	~"push.h
"

35 
	~"g»mlš.h
"

36 
	~"mss.h
"

37 
	~"ev’t.h
"

38 
	~"ps.h
"

39 
	~"dhı.h
"

40 
	~"commÚ.h
"

41 
	~"s¦_v”ify.h
"

43 
	~"memdbg.h
"

45 
	~"fÜw¬d-šlše.h
"

46 
	~"occ-šlše.h
"

47 
	~"pšg-šlše.h
"

48 
	~"m¡©s.h
"

50 
couÁ”_ty³
 
	glšk_»ad_by‹s_glob®
;

51 
couÁ”_ty³
 
	glšk_wr™e_by‹s_glob®
;

55 #ifdeà
ENABLE_DEBUG


58 
	$wa™_¡©us_¡ršg
(
cÚ‹xt
 *
c
, 
gc_¬’a
 *
gc
)

60 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

61 
	`buf_´štf
(&
out
, "I/O WAIT %s|%s|%s|%s %s",

62 
	`tun_¡©
(
c
->
c1
.
tuÁ­
, 
EVENT_READ
, 
gc
),

63 
	`tun_¡©
(
c
->
c1
.
tuÁ­
, 
EVENT_WRITE
, 
gc
),

64 
	`sock‘_¡©
(
c
->
c2
.
lšk_sock‘
, 
EVENT_READ
, 
gc
),

65 
	`sock‘_¡©
(
c
->
c2
.
lšk_sock‘
, 
EVENT_WRITE
, 
gc
),

66 
	`tv_¡ršg
(&
c
->
c2
.
timev®
, 
gc
));

67  
	`BSTR
(&
out
);

68 
	}
}

71 
	$show_wa™_¡©us
(
cÚ‹xt
 *
c
)

73 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

74 
	`dmsg
(
D_EVENT_WAIT
, "%s", 
	`wa™_¡©us_¡ršg
(
c
, &
gc
));

75 
	`gc_ä“
(&
gc
);

76 
	}
}

90 #ifdeà
ENABLE_CRYPTO


92 
	$check_s_dowÜk
(
cÚ‹xt
 *
c
)

94 
š‹rv®_t
 
wakeup
 = 
BIG_TIMEOUT
;

96 ià(
	`š‹rv®_‹¡
(&
c
->
c2
.
tmp_št
))

98 cÚ¡ 
tmp_¡©us
 = 
s_muÉi_´oûss


99 (
c
->
c2
.
s_muÉi
, &c->c2.
to_lšk
, &c->c2.
to_lšk_addr
,

100 
	`g‘_lšk_sock‘_šfo
(
c
), &
wakeup
);

101 ià(
tmp_¡©us
 =ğ
TLSMP_ACTIVE
)

103 
	`upd©e_time
();

104 
	`š‹rv®_aùiÚ
(&
c
->
c2
.
tmp_št
);

106 ià(
tmp_¡©us
 =ğ
TLSMP_KILL
)

108 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "auth-control-exit");

111 
	`š‹rv®_futu»_Œigg”
(&
c
->
c2
.
tmp_št
, 
wakeup
);

114 
	`š‹rv®_scheduË_wakeup
(&
c
->
c2
.
tmp_št
, &
wakeup
);

116 ià(
wakeup
)

118 
	`cÚ‹xt_»scheduË_£c
(
c
, 
wakeup
);

120 
	}
}

123 
	$check_s_”rÜs_co
(
cÚ‹xt
 *
c
)

125 
	`msg
(
D_STREAM_ERRORS
, "Fatal TLSƒrror (check_tls_errors_co),„estarting");

126 
	`»gi¡”_sigÇl
(
c
, c->
c2
.
s_ex™_sigÇl
, "tls-error");

127 
	}
}

130 
	$check_s_”rÜs_nco
(
cÚ‹xt
 *
c
)

132 
	`»gi¡”_sigÇl
(
c
, c->
c2
.
s_ex™_sigÇl
, "tls-error");

133 
	}
}

136 #ià
P2MP


143 
	$check_šcomšg_cÚŒŞ_chªÃl_dowÜk
(
cÚ‹xt
 *
c
)

145 cÚ¡ 
Ën
 = 
	`s_‹¡_·ylßd_Ën
(
c
->
c2
.
s_muÉi
);

146 ià(
Ën
)

148 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

149 
bufãr
 
buf
 = 
	`®loc_buf_gc
(
Ën
, &
gc
);

150 ià(
	`s_»c_·ylßd
(
c
->
c2
.
s_muÉi
, &
buf
))

153 
	`buf_nuÎ_‹rmš©e
(&
buf
);

156 
	`¡ršg_mod
(
	`BSTR
(&
buf
), 
CC_PRINT
, 
CC_CRLF
, 0);

158 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(&
buf
, "AUTH_FAILED"))

160 
	`»ûive_auth_çed
(
c
, &
buf
);

162 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(&
buf
, "PUSH_"))

164 
	`šcomšg_push_mes§ge
(
c
, &
buf
);

166 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(&
buf
, "RESTART"))

168 
	`£rv”_pushed_sigÇl
(
c
, &
buf
, 
Œue
, 7);

170 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(&
buf
, "HALT"))

172 
	`£rv”_pushed_sigÇl
(
c
, &
buf
, 
çl£
, 4);

176 
	`msg
(
D_PUSH_ERRORS
, "WARNING: Reûived unknowÀcÚŒŞ mes§ge: %s", 
	`BSTR
(&
buf
));

181 
	`msg
(
D_PUSH_ERRORS
, "WARNING: Receive control message failed");

184 
	`gc_ä“
(&
gc
);

186 
	}
}

192 
	$check_push_»que¡_dowÜk
(
cÚ‹xt
 *
c
)

194 
	`£nd_push_»que¡
(
c
);

197 
	`ev’t_timeout_modify_wakeup
(&
c
->
c2
.
push_»que¡_š‹rv®
, 
PUSH_REQUEST_INTERVAL
);

198 
	}
}

206 
	$check_cÚÃùiÚ_e¡ablished_dowÜk
(
cÚ‹xt
 *
c
)

208 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
wa™_fÜ_cÚÃù
, &c->c2.
timev®
, 
ETT_DEFAULT
))

210 ià(
	`CONNECTION_ESTABLISHED
(
c
))

212 #ià
P2MP


214 ià(
c
->
c2
.
s_muÉi
 && c->
İtiÚs
.
puÎ
)

216 #ifdeà
ENABLE_MANAGEMENT


217 ià(
mªagem’t
)

219 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

220 
OPENVPN_STATE_GET_CONFIG
,

221 
NULL
,

222 
NULL
,

223 
NULL
,

224 
NULL
,

225 
NULL
);

229 
	`ev’t_timeout_š™
(&
c
->
c2
.
push_»que¡_š‹rv®
, 0, 
now
);

230 
	`»£t_cßr£_tim”s
(
c
);

235 
	`do_up
(
c
, 
çl£
, 0);

238 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
wa™_fÜ_cÚÃù
);

241 
	}
}

248 
boŞ


249 
	$£nd_cÚŒŞ_chªÃl_¡ršg
(
cÚ‹xt
 *
c
, cÚ¡ *
¡r
, 
msgËv–
)

251 #ifdeà
ENABLE_CRYPTO


252 ià(
c
->
c2
.
s_muÉi
)

254 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

255 
boŞ
 
¡©
;

258 
¡©
 = 
	`s_£nd_·ylßd
(
c
->
c2
.
s_muÉi
, (
ušt8_t
 *è
¡r
, 
	`¡¾’
(str) + 1);

266 
	`š‹rv®_aùiÚ
(&
c
->
c2
.
tmp_št
);

267 
	`cÚ‹xt_immedŸ‹_»scheduË
(
c
);

269 
	`msg
(
msgËv–
, "SENT CONTROL [%s]: '%s' (status=%d)",

270 
	`s_commÚ_Çme
(
c
->
c2
.
s_muÉi
, 
çl£
),

271 
	`§n™ize_cÚŒŞ_mes§ge
(
¡r
, &
gc
),

272 (è
¡©
);

274 
	`gc_ä“
(&
gc
);

275  
¡©
;

278  
Œue
;

279 
	}
}

286 
	$check_add_rou‹s_aùiÚ
(
cÚ‹xt
 *
c
, cÚ¡ 
boŞ
 
”rÜs
)

288 
	`do_rou‹
(&
c
->
İtiÚs
, c->
c1
.
rou‹_li¡
, c->c1.
rou‹_v6_li¡
,

289 
c
->
c1
.
tuÁ­
, c->
¶ugšs
, c->
c2
.
es
);

290 
	`upd©e_time
();

291 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
rou‹_wakeup
);

292 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
rou‹_wakeup_expœe
);

293 
	`š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
c
, 
”rÜs
 ? 
ISC_ERRORS
 : 0);

294 
	}
}

297 
	$check_add_rou‹s_dowÜk
(
cÚ‹xt
 *
c
)

299 ià(
	`‹¡_rou‹s
(
c
->
c1
.
rou‹_li¡
, c->c1.
tuÁ­
))

301 
	`check_add_rou‹s_aùiÚ
(
c
, 
çl£
);

303 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
rou‹_wakeup_expœe
, &c->c2.
timev®
, 
ETT_DEFAULT
))

305 
	`check_add_rou‹s_aùiÚ
(
c
, 
Œue
);

309 
	`msg
(
D_ROUTE
, "Route: Waiting for TUN/TAP interfaceo come up...");

310 ià(
c
->
c1
.
tuÁ­
)

312 ià(!
	`tun_¡ªdby
(
c
->
c1
.
tuÁ­
))

314 
	`»gi¡”_sigÇl
(
c
, 
SIGHUP
, "ip-fail");

315 
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 = 10;

316 #ifdeà
_WIN32


317 
	`show_rou‹s
(
M_INFO
|
M_NOPREFIX
);

318 
	`show_ad­‹rs
(
M_INFO
|
M_NOPREFIX
);

322 
	`upd©e_time
();

323 ià(
c
->
c2
.
rou‹_wakeup
.
n
 != 1)

325 
	`ev’t_timeout_š™
(&
c
->
c2
.
rou‹_wakeup
, 1, 
now
);

327 
	`ev’t_timeout_»£t
(&
c
->
c2
.
pšg_»c_š‹rv®
);

329 
	}
}

335 
	$check_šaùiv™y_timeout_dowÜk
(
cÚ‹xt
 *
c
)

337 
	`msg
(
M_INFO
, "Inactivityimeout (--inactive),ƒxiting");

338 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "inactive");

339 
	}
}

342 
	$g‘_£rv”_pŞl_»maššg_time
(
ev’t_timeout
 *
£rv”_pŞl_timeout
)

344 
	`upd©e_time
();

345 
»maššg
 = 
	`ev’t_timeout_»maššg
(
£rv”_pŞl_timeout
);

346  
	`max_št
(0, 
»maššg
);

347 
	}
}

348 #ià
P2MP


351 
	$check_£rv”_pŞl_timeout_dowÜk
(
cÚ‹xt
 *
c
)

353 
	`ev’t_timeout_»£t
(&
c
->
c2
.
£rv”_pŞl_š‹rv®
);

354 
	`ASSERT
(
c
->
c2
.
s_muÉi
);

355 ià(!
	`s_š™Ÿl_·ck‘_»ûived
(
c
->
c2
.
s_muÉi
))

357 
	`msg
(
M_INFO
, "Server…ollimeout,„estarting");

358 
	`»gi¡”_sigÇl
(
c
, 
SIGUSR1
, "server_poll");

359 
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 = -1;

361 
	}
}

367 
	$scheduË_ex™
(
cÚ‹xt
 *
c
, cÚ¡ 
n_£cÚds
, cÚ¡ 
sigÇl
)

369 
	`s_£t_sšgË_£ssiÚ
(
c
->
c2
.
s_muÉi
);

370 
	`upd©e_time
();

371 
	`»£t_cßr£_tim”s
(
c
);

372 
	`ev’t_timeout_š™
(&
c
->
c2
.
scheduËd_ex™
, 
n_£cÚds
, 
now
);

373 
c
->
c2
.
scheduËd_ex™_sigÇl
 = 
sigÇl
;

374 
	`msg
(
D_SCHED_EXIT
, "D–ayedƒx™ iÀ%d secÚds", 
n_£cÚds
);

375 
	}
}

381 
	$check_scheduËd_ex™_dowÜk
(
cÚ‹xt
 *
c
)

383 
	`»gi¡”_sigÇl
(
c
, c->
c2
.
scheduËd_ex™_sigÇl
, "delayed-exit");

384 
	}
}

392 
	$check_¡©us_fe_dowÜk
(
cÚ‹xt
 *
c
)

394 ià(
c
->
c1
.
¡©us_ouut
)

396 
	`´št_¡©us
(
c
, c->
c1
.
¡©us_ouut
);

398 
	}
}

400 #ifdeà
ENABLE_FRAGMENT


405 
	$check_äagm’t_dowÜk
(
cÚ‹xt
 *
c
)

407 
lšk_sock‘_šfo
 *
lsi
 = 
	`g‘_lšk_sock‘_šfo
(
c
);

410 ià(
lsi
->
mtu_chªged
)

412 
	`äame_adju¡_·th_mtu
(&
c
->
c2
.
äame_äagm’t
, c->c2.
lšk_sock‘
->
mtu
,

413 
c
->
İtiÚs
.
û
.
´Ùo
);

414 
lsi
->
mtu_chªged
 = 
çl£
;

417 ià(
	`äagm’t_outgošg_defšed
(
c
->
c2
.
äagm’t
))

419 ià(!
c
->
c2
.
to_lšk
.
Ën
)

422 
	`ASSERT
(
	`äagm’t_»ady_to_£nd
(
c
->
c2
.
äagm’t
, &c->c2.
buf
, &c->c2.
äame_äagm’t
));

423 
	`’üy±_sign
(
c
, 
çl£
);

427 
	`äagm’t_hou£k“pšg
(
c
->
c2
.
äagm’t
, &c->c2.
äame_äagm’t
, &c->c2.
timev®
);

428 
	}
}

434 
šlše
 

435 
	$bufãr_tuºov”
(cÚ¡ 
ušt8_t
 *
Üig_buf
, 
bufãr
 *
de¡_¡ub
, bufã¸*
¤c_¡ub
, bufã¸*
¡Üage
)

437 ià(
Üig_buf
 =ğ
¤c_¡ub
->
d©a
 && src_¡ub->d©¨!ğ
¡Üage
->data)

439 
	`buf_assign
(
¡Üage
, 
¤c_¡ub
);

440 *
de¡_¡ub
 = *
¡Üage
;

444 *
de¡_¡ub
 = *
¤c_¡ub
;

446 
	}
}

454 
	$’üy±_sign
(
cÚ‹xt
 *
c
, 
boŞ
 
comp_äag
)

456 
cÚ‹xt_bufãrs
 *
b
 = 
c
->
c2
.
bufãrs
;

457 cÚ¡ 
ušt8_t
 *
Üig_buf
 = 
c
->
c2
.
buf
.
d©a
;

458 
üy±o_İtiÚs
 *
co
 = 
NULL
;

460 #ià
P2MP_SERVER


465 ià(
c
->
c2
.
cÚ‹xt_auth
 !ğ
CAS_SUCCEEDED
)

467 
c
->
c2
.
buf
.
Ën
 = 0;

471 ià(
comp_äag
)

473 #ifdeà
USE_COMP


475 ià(
c
->
c2
.
comp_cÚ‹xt
)

477 (*
c
->
c2
.
comp_cÚ‹xt
->
®g
.
com´ess
)(&c->c2.
buf
, 
b
->
com´ess_buf
, c->c2.comp_cÚ‹xt, &c->c2.
äame
);

480 #ifdeà
ENABLE_FRAGMENT


481 ià(
c
->
c2
.
äagm’t
)

483 
	`äagm’t_outgošg
(
c
->
c2
.
äagm’t
, &c->c2.
buf
, &c->c2.
äame_äagm’t
);

488 #ifdeà
ENABLE_CRYPTO


490 
	`ASSERT
(
	`buf_š™
(&
b
->
’üy±_buf
, 
	`FRAME_HEADROOM
(&
c
->
c2
.
äame
)));

492 ià(
c
->
c2
.
s_muÉi
)

495 
	`s_´e_’üy±
(
c
->
c2
.
s_muÉi
, &c->c2.
buf
, &
co
);

499 ià(
c
->
c2
.
buf
.
Ën
 > 0 && c->c2.
s_muÉi
->
u£_³”_id
)

501 
	`s_´•’d_İcode_v2
(
c
->
c2
.
s_muÉi
, &
b
->
’üy±_buf
);

506 
co
 = &
c
->
c2
.
üy±o_İtiÚs
;

510 
	`İ’v²_’üy±
(&
c
->
c2
.
buf
, 
b
->
’üy±_buf
, 
co
);

513 ià(
c
->
c2
.
s_muÉi
)

515 ià(
c
->
c2
.
buf
.
Ën
 > 0 && !c->c2.
s_muÉi
->
u£_³”_id
)

517 
	`s_´•’d_İcode_v1
(
c
->
c2
.
s_muÉi
, &c->c2.
buf
);

519 
	`s_po¡_’üy±
(
c
->
c2
.
s_muÉi
, &c->c2.
buf
);

526 
	`lšk_sock‘_g‘_outgošg_addr
(&
c
->
c2
.
buf
, 
	`g‘_lšk_sock‘_šfo
(c),

527 &
c
->
c2
.
to_lšk_addr
);

530 
	`bufãr_tuºov”
(
Üig_buf
, &
c
->
c2
.
to_lšk
, &c->c2.
buf
, &
b
->
»ad_tun_buf
);

531 
	}
}

537 
	$´oûss_cßr£_tim”s
(
cÚ‹xt
 *
c
)

539 #ifdeà
ENABLE_CRYPTO


542 
	`check_·ck‘_id_³rsi¡_æush
(
c
);

546 
	`check_¡©us_fe
(
c
);

549 
	`check_cÚÃùiÚ_e¡ablished
(
c
);

551 #ià
P2MP


553 
	`check_push_»que¡
(
c
);

556 #ifdeà
PLUGIN_PF


557 
	`pf_check_»lßd
(
c
);

561 
	`check_add_rou‹s
(
c
);

564 
	`check_šaùiv™y_timeout
(
c
);

565 ià(
c
->
sig
->
sigÇl_»ûived
)

571 
	`check_pšg_»¡¬t
(
c
);

572 ià(
c
->
sig
->
sigÇl_»ûived
)

577 #ià
P2MP


578 ià(
c
->
c2
.
s_muÉi
)

580 
	`check_£rv”_pŞl_timeout
(
c
);

581 ià(
c
->
sig
->
sigÇl_»ûived
)

586 
	`check_scheduËd_ex™
(
c
);

587 ià(
c
->
sig
->
sigÇl_»ûived
)

594 #ifdeà
ENABLE_OCC


596 
	`check_£nd_occ_»q
(
c
);

599 
	`check_£nd_occ_lßd_‹¡
(
c
);

602 ià(
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
)

604 
	`´oûss_ex¶ic™_ex™_nÙifiÿtiÚ_tim”_wakeup
(
c
);

609 
	`check_pšg_£nd
(
c
);

610 
	}
}

613 
	$check_cßr£_tim”s_dowÜk
(
cÚ‹xt
 *
c
)

615 cÚ¡ 
timev®
 
§ve
 = 
c
->
c2
.timeval;

616 
c
->
c2
.
timev®
.
tv_£c
 = 
BIG_TIMEOUT
;

617 
c
->
c2
.
timev®
.
tv_u£c
 = 0;

618 
	`´oûss_cßr£_tim”s
(
c
);

619 
c
->
c2
.
cßr£_tim”_wakeup
 = 
now
 + c->c2.
timev®
.
tv_£c
;

621 
	`dmsg
(
D_INTERVAL
, "TIMER: cßr£im” wakeu°%d secÚds", (è
c
->
c2
.
timev®
.
tv_£c
);

624 ià(
c
->
c2
.
timev®
.
tv_£c
 > 
§ve
.tv_sec)

626 
c
->
c2
.
timev®
 = 
§ve
;

628 
	}
}

630 
šlše
 

631 
	$check_cßr£_tim”s
(
cÚ‹xt
 *
c
)

633 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

634 ià(
loÿl_now
 >ğ
c
->
c2
.
cßr£_tim”_wakeup
)

636 
	`check_cßr£_tim”s_dowÜk
(
c
);

640 
	`cÚ‹xt_»scheduË_£c
(
c
, c->
c2
.
cßr£_tim”_wakeup
 - 
loÿl_now
);

642 
	}
}

645 
	$check_timeout_¿ndom_compÚ’t_dowÜk
(
cÚ‹xt
 *
c
)

647 cÚ¡ 
upd©e_š‹rv®
 = 10;

648 
c
->
c2
.
upd©e_timeout_¿ndom_compÚ’t
 = 
now
 + 
upd©e_š‹rv®
;

649 
c
->
c2
.
timeout_¿ndom_compÚ’t
.
tv_u£c
 = (
time_t
è
	`g‘_¿ndom
() & 0x0003FFFF;

650 
c
->
c2
.
timeout_¿ndom_compÚ’t
.
tv_£c
 = 0;

652 
	`dmsg
(
D_INTERVAL
, "RANDOM USEC=%d", (è
c
->
c2
.
timeout_¿ndom_compÚ’t
.
tv_u£c
);

653 
	}
}

655 
šlše
 

656 
	$check_timeout_¿ndom_compÚ’t
(
cÚ‹xt
 *
c
)

658 ià(
now
 >ğ
c
->
c2
.
upd©e_timeout_¿ndom_compÚ’t
)

660 
	`check_timeout_¿ndom_compÚ’t_dowÜk
(
c
);

662 ià(
c
->
c2
.
timev®
.
tv_£c
 >= 1)

664 
	`tv_add
(&
c
->
c2
.
timev®
, &c->c2.
timeout_¿ndom_compÚ’t
);

666 
	}
}

673 
šlše
 

674 
	$socks_po¡´oûss_šcomšg_lšk
(
cÚ‹xt
 *
c
)

676 ià(
c
->
c2
.
lšk_sock‘
->
socks_´oxy
 && c->c2.lšk_sock‘->
šfo
.
´Ùo
 =ğ
PROTO_UDP
)

678 
	`socks_´oûss_šcomšg_udp
(&
c
->
c2
.
buf
, &c->c2.
äom
);

680 
	}
}

682 
šlše
 

683 
	$socks_´•roûss_outgošg_lšk
(
cÚ‹xt
 *
c
,

684 
lšk_sock‘_aùu®
 **
to_addr
,

685 *
size_d–
)

687 ià(
c
->
c2
.
lšk_sock‘
->
socks_´oxy
 && c->c2.lšk_sock‘->
šfo
.
´Ùo
 =ğ
PROTO_UDP
)

689 *
size_d–
 +ğ
	`socks_´oûss_outgošg_udp
(&
c
->
c2
.
to_lšk
, c->c2.
to_lšk_addr
);

690 *
to_addr
 = &
c
->
c2
.
lšk_sock‘
->
socks_»Ïy
;

692 
	}
}

695 
šlše
 

696 
	$lšk_sock‘_wr™e_po¡_size_adju¡
(*
size
,

697 
size_d–
,

698 
bufãr
 *
buf
)

700 ià(
size_d–
 > 0 && *
size
 > size_delta)

702 *
size
 -ğ
size_d–
;

703 ià(!
	`buf_advªû
(
buf
, 
size_d–
))

705 *
size
 = 0;

708 
	}
}

715 
	$»ad_šcomšg_lšk
(
cÚ‹xt
 *
c
)

721 
¡©us
;

725 
	`³rf_push
(
PERF_READ_IN_LINK
);

727 
c
->
c2
.
buf
 = c->c2.
bufãrs
->
»ad_lšk_buf
;

728 
	`ASSERT
(
	`buf_š™
(&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM_ADJ
(&c->c2.
äame
, 
FRAME_HEADROOM_MARKER_READ_LINK
)));

730 
¡©us
 = 
	`lšk_sock‘_»ad
(
c
->
c2
.
lšk_sock‘
,

731 &
c
->
c2
.
buf
,

732 &
c
->
c2
.
äom
);

734 ià(
	`sock‘_cÚÃùiÚ_»£t
(
c
->
c2
.
lšk_sock‘
, 
¡©us
))

736 #ià
PORT_SHARE


737 ià(
pÜt_sh¬e
 && 
	`sock‘_fÜeign_´ÙocŞ_d‘eùed
(
c
->
c2
.
lšk_sock‘
))

739 cÚ¡ 
bufãr
 *
fbuf
 = 
	`sock‘_fÜeign_´ÙocŞ_h—d
(
c
->
c2
.
lšk_sock‘
);

740 cÚ¡ 
sd
 = 
	`sock‘_fÜeign_´ÙocŞ_sd
(
c
->
c2
.
lšk_sock‘
);

741 
	`pÜt_sh¬e_»dœeù
(
pÜt_sh¬e
, 
fbuf
, 
sd
);

742 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "port-share-redirect");

748 ià(
c
->
İtiÚs
.
š‘d
)

750 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "connection-reset-inetd");

751 
	`msg
(
D_STREAM_ERRORS
, "CÚÃùiÚ„e£t, iÃtd/xš‘dƒx™ [%d]", 
¡©us
);

755 #ifdeà
ENABLE_OCC


756 ià(
	`ev’t_timeout_defšed
(&
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
))

758 
	`msg
(
D_STREAM_ERRORS
, "CÚÃùiÚ„e£ˆduršgƒx™‚ÙifiÿtiÚ…”iod, ignÜšg [%d]", 
¡©us
);

759 
	`mªagem’t_¦“p
(1);

764 
	`»gi¡”_sigÇl
(
c
, 
SIGUSR1
, "connection-reset");

765 
	`msg
(
D_STREAM_ERRORS
, "CÚÃùiÚ„e£t,„e¡¬tšg [%d]", 
¡©us
);

769 
	`³rf_pİ
();

774 
	`check_¡©us
(
¡©us
, "»ad", 
c
->
c2
.
lšk_sock‘
, 
NULL
);

777 
	`socks_po¡´oûss_šcomšg_lšk
(
c
);

779 
	`³rf_pİ
();

780 
	}
}

782 
boŞ


783 
	$´oûss_šcomšg_lšk_·¹1
(
cÚ‹xt
 *
c
, 
lšk_sock‘_šfo
 *
lsi
, 
boŞ
 
æß‹d
)

785 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

786 
boŞ
 
deüy±_¡©us
 = 
çl£
;

788 ià(
c
->
c2
.
buf
.
Ën
 > 0)

790 
c
->
c2
.
lšk_»ad_by‹s
 +ğc->c2.
buf
.
Ën
;

791 
lšk_»ad_by‹s_glob®
 +ğ
c
->
c2
.
buf
.
Ën
;

792 #ifdeà
ENABLE_MEMSTATS


793 ià(
mm­_¡©s
)

795 
mm­_¡©s
->
lšk_»ad_by‹s
 = 
lšk_»ad_by‹s_glob®
;

798 
c
->
c2
.
Üigš®_»cv_size
 = c->c2.
buf
.
Ën
;

799 #ifdeà
ENABLE_MANAGEMENT


800 ià(
mªagem’t
)

802 
	`mªagem’t_by‹s_š
(
mªagem’t
, 
c
->
c2
.
buf
.
Ën
);

803 #ifdeà
MANAGEMENT_DEF_AUTH


804 
	`mªagem’t_by‹s_£rv”
(
mªagem’t
, &
c
->
c2
.
lšk_»ad_by‹s
, &c->c2.
lšk_wr™e_by‹s
, &c->c2.
mda_cÚ‹xt
);

811 
c
->
c2
.
Üigš®_»cv_size
 = 0;

814 #ifdeà
ENABLE_DEBUG


816 ià(
c
->
İtiÚs
.
g»mlš
)

818 ià(!
	`ask_g»mlš
(
c
->
İtiÚs
.
g»mlš
))

820 
c
->
c2
.
buf
.
Ën
 = 0;

822 
	`cÜru±_g»mlš
(&
c
->
c2
.
buf
, c->
İtiÚs
.
g»mlš
);

827 #ifdeà
LOG_RW


828 ià(
c
->
c2
.
log_rw
 && c->c2.
buf
.
Ën
 > 0)

830 
	`årštf
(
¡d”r
, "R");

833 
	`msg
(
D_LINK_RW
, "%s READ [%d] from %s: %s",

834 
	`´Ùo2ascii
(
lsi
->
´Ùo
,†si->
af
, 
Œue
),

835 
	`BLEN
(&
c
->
c2
.
buf
),

836 
	`´št_lšk_sock‘_aùu®
(&
c
->
c2
.
äom
, &
gc
),

837 
	`PROTO_DUMP
(&
c
->
c2
.
buf
, &
gc
));

846 ià(
c
->
c2
.
buf
.
Ën
 > 0)

848 
üy±o_İtiÚs
 *
co
 = 
NULL
;

849 cÚ¡ 
ušt8_t
 *
ad_¡¬t
 = 
NULL
;

850 ià(!
	`lšk_sock‘_v”ify_šcomšg_addr
(&
c
->
c2
.
buf
, 
lsi
, &c->c2.
äom
))

852 
	`lšk_sock‘_bad_šcomšg_addr
(&
c
->
c2
.
buf
, 
lsi
, &c->c2.
äom
);

855 #ifdeà
ENABLE_CRYPTO


856 ià(
c
->
c2
.
s_muÉi
)

868 
ušt8_t
 
İcode
 = *
	`BPTR
(&
c
->
c2
.
buf
è>> 
P_OPCODE_SHIFT
;

869 ià(
	`s_´e_deüy±
(
c
->
c2
.
s_muÉi
, &c->c2.
äom
, &c->c2.
buf
, &
co
,

870 
æß‹d
, &
ad_¡¬t
))

873 ià(
	`is_h¬d_»£t
(
İcode
, 
c
->
İtiÚs
.
key_m‘hod
))

875 
c
->
c2
.
äame
 = c->c2.
äame_š™Ÿl
;

878 
	`š‹rv®_aùiÚ
(&
c
->
c2
.
tmp_št
);

881 ià(
c
->
İtiÚs
.
pšg_»c_timeout
)

883 
	`ev’t_timeout_»£t
(&
c
->
c2
.
pšg_»c_š‹rv®
);

889 
co
 = &
c
->
c2
.
üy±o_İtiÚs
;

891 #ià
P2MP_SERVER


896 ià(
c
->
c2
.
cÚ‹xt_auth
 !ğ
CAS_SUCCEEDED
)

898 
c
->
c2
.
buf
.
Ën
 = 0;

903 
deüy±_¡©us
 = 
	`İ’v²_deüy±
(&
c
->
c2
.
buf
, c->c2.
bufãrs
->
deüy±_buf
,

904 
co
, &
c
->
c2
.
äame
, 
ad_¡¬t
);

906 ià(!
deüy±_¡©us
 && 
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
c
->
c2
.
lšk_sock‘
))

909 
	`»gi¡”_sigÇl
(
c
, 
SIGUSR1
, "decryption-error");

910 
	`msg
(
D_STREAM_ERRORS
, "Fatal decryptionƒrror (process_incoming_link),„estarting");

913 
deüy±_¡©us
 = 
Œue
;

918 
	`buf_»£t
(&
c
->
c2
.
to_tun
);

920 
	`gc_ä“
(&
gc
);

922  
deüy±_¡©us
;

923 
	}
}

926 
	$´oûss_šcomšg_lšk_·¹2
(
cÚ‹xt
 *
c
, 
lšk_sock‘_šfo
 *
lsi
, cÚ¡ 
ušt8_t
 *
Üig_buf
)

928 ià(
c
->
c2
.
buf
.
Ën
 > 0)

930 #ifdeà
ENABLE_FRAGMENT


931 ià(
c
->
c2
.
äagm’t
)

933 
	`äagm’t_šcomšg
(
c
->
c2
.
äagm’t
, &c->c2.
buf
, &c->c2.
äame_äagm’t
);

937 #ifdeà
USE_COMP


939 ià(
c
->
c2
.
comp_cÚ‹xt
)

941 (*
c
->
c2
.
comp_cÚ‹xt
->
®g
.
decom´ess
)(&c->c2.
buf
, c->c2.
bufãrs
->
decom´ess_buf
, c->c2.comp_cÚ‹xt, &c->c2.
äame
);

945 #ifdeà
PACKET_TRUNCATION_CHECK


947 
	`v4_·ck‘_size_v”ify
(
	`BPTR
(&
c
->
c2
.
buf
),

948 
	`BLEN
(&
c
->
c2
.
buf
),

949 
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
),

951 &
c
->
c2
.
n_Œunc_po¡_deüy±
);

963 ià(!
	`TLS_MODE
(
c
))

965 
	`lšk_sock‘_£t_outgošg_addr
(&
c
->
c2
.
buf
, 
lsi
, &c->c2.
äom
, 
NULL
, c->c2.
es
);

969 ià(
c
->
İtiÚs
.
pšg_»c_timeout
 && c->
c2
.
buf
.
Ën
 > 0)

971 
	`ev’t_timeout_»£t
(&
c
->
c2
.
pšg_»c_š‹rv®
);

975 ià(
c
->
c2
.
buf
.
Ën
 > 0)

977 
c
->
c2
.
lšk_»ad_by‹s_auth
 +ğc->c2.
buf
.
Ën
;

978 
c
->
c2
.
max_»cv_size_loÿl
 = 
	`max_št
(c->c2.
Üigš®_»cv_size
, c->c2.max_recv_size_local);

982 ià(
	`is_pšg_msg
(&
c
->
c2
.
buf
))

984 
	`dmsg
(
D_PING
, "RECEIVED PING PACKET");

985 
c
->
c2
.
buf
.
Ën
 = 0;

988 #ifdeà
ENABLE_OCC


990 ià(
	`is_occ_msg
(&
c
->
c2
.
buf
))

992 
	`´oûss_»ûived_occ_msg
(
c
);

996 
	`bufãr_tuºov”
(
Üig_buf
, &
c
->
c2
.
to_tun
, &c->c2.
buf
, &c->c2.
bufãrs
->
»ad_lšk_buf
);

999 ià(!
	`tuÁ­_defšed
(
c
->
c1
.
tuÁ­
))

1001 
c
->
c2
.
to_tun
.
Ën
 = 0;

1006 
	`buf_»£t
(&
c
->
c2
.
to_tun
);

1008 
	}
}

1011 
	$´oûss_šcomšg_lšk
(
cÚ‹xt
 *
c
)

1013 
	`³rf_push
(
PERF_PROC_IN_LINK
);

1015 
lšk_sock‘_šfo
 *
lsi
 = 
	`g‘_lšk_sock‘_šfo
(
c
);

1016 cÚ¡ 
ušt8_t
 *
Üig_buf
 = 
c
->
c2
.
buf
.
d©a
;

1018 
	`´oûss_šcomšg_lšk_·¹1
(
c
, 
lsi
, 
çl£
);

1019 
	`´oûss_šcomšg_lšk_·¹2
(
c
, 
lsi
, 
Üig_buf
);

1021 
	`³rf_pİ
();

1022 
	}
}

1029 
	$»ad_šcomšg_tun
(
cÚ‹xt
 *
c
)

1036 
	`³rf_push
(
PERF_READ_IN_TUN
);

1038 
c
->
c2
.
buf
 = c->c2.
bufãrs
->
»ad_tun_buf
;

1039 #ifdeà
TUN_PASS_BUFFER


1040 
	`»ad_tun_bufã»d
(
c
->
c1
.
tuÁ­
, &c->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
));

1042 
	`ASSERT
(
	`buf_š™
(&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
(&c->c2.
äame
)));

1043 
	`ASSERT
(
	`buf_§ã
(&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
)));

1044 
c
->
c2
.
buf
.
Ën
 = 
	`»ad_tun
(c->
c1
.
tuÁ­
, 
	`BPTR
(&c->c2.buf), 
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
));

1047 #ifdeà
PACKET_TRUNCATION_CHECK


1048 
	`v4_·ck‘_size_v”ify
(
	`BPTR
(&
c
->
c2
.
buf
),

1049 
	`BLEN
(&
c
->
c2
.
buf
),

1050 
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
),

1052 &
c
->
c2
.
n_Œunc_tun_»ad
);

1056 ià(
	`tuÁ­_¡İ
(
c
->
c2
.
buf
.
Ën
))

1058 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "tun-stop");

1059 
	`msg
(
M_INFO
, "TUN/TAP interface has been stopped,ƒxiting");

1060 
	`³rf_pİ
();

1065 ià(
	`tuÁ­_abÜt
(
c
->
c2
.
buf
.
Ën
))

1067 
	`»gi¡”_sigÇl
(
c
, 
SIGHUP
, "tun-abort");

1068 
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 = 10;

1069 
	`msg
(
M_INFO
, "TUN/TAP I/O operation‡borted,„estarting");

1070 
	`³rf_pİ
();

1075 
	`check_¡©us
(
c
->
c2
.
buf
.
Ën
, "»ad from TUN/TAP", 
NULL
, c->
c1
.
tuÁ­
);

1077 
	`³rf_pİ
();

1078 
	}
}

1089 
	$drİ_if_»cursive_routšg
(
cÚ‹xt
 *
c
, 
bufãr
 *
buf
)

1091 
boŞ
 
drİ
 = 
çl£
;

1092 
İ’v²_sockaddr
 
tun_§
;

1093 
_hdr_off£t
 = 0;

1095 ià(
c
->
c2
.
to_lšk_addr
 =ğ
NULL
)

1100 
tun_§
 = 
c
->
c2
.
to_lšk_addr
->
de¡
;

1102 
´Ùo_v”
 = 
	`g‘_tun__v”
(
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
), &c->
c2
.
buf
, &
_hdr_off£t
);

1104 ià(
´Ùo_v”
 == 4)

1106 cÚ¡ 
İ’v²_hdr
 *
p
;

1109 ià(
	`BLEN
(
buf
è< ((è(
İ’v²_hdr
è+ 
_hdr_off£t
))

1115 ià(
tun_§
.
addr
.
§
.
§_çmy
 !ğ
AF_INET
)

1120 
p
 = (
İ’v²_hdr
 *è(
	`BPTR
(
buf
è+ 
_hdr_off£t
);

1123 ià(
tun_§
.
addr
.
š4
.
sš_addr
.
s_addr
 =ğ
p
->
daddr
)

1125 
drİ
 = 
Œue
;

1128 ià(
´Ùo_v”
 == 6)

1130 cÚ¡ 
İ’v²_v6hdr
 *
p6
;

1133 ià(
	`BLEN
(
buf
è< ((è(
İ’v²_v6hdr
è+ 
_hdr_off£t
))

1139 ià(
tun_§
.
addr
.
§
.
§_çmy
 !ğ
AF_INET6
)

1145 
p6
 = (
İ’v²_v6hdr
 *è(
	`BPTR
(
buf
è+ 
_hdr_off£t
);

1146 ià(
	`IN6_ARE_ADDR_EQUAL
(&
tun_§
.
addr
.
š6
.
sš6_addr
, &
p6
->
daddr
))

1148 
drİ
 = 
Œue
;

1152 ià(
drİ
)

1154 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1156 
c
->
c2
.
buf
.
Ën
 = 0;

1158 
	`msg
(
D_LOW
, "Recursive„outing detected, dropun…acketo %s",

1159 
	`´št_lšk_sock‘_aùu®
(
c
->
c2
.
to_lšk_addr
, &
gc
));

1160 
	`gc_ä“
(&
gc
);

1162 
	}
}

1170 
	$´oûss_šcomšg_tun
(
cÚ‹xt
 *
c
)

1172 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1174 
	`³rf_push
(
PERF_PROC_IN_TUN
);

1176 ià(
c
->
c2
.
buf
.
Ën
 > 0)

1178 
c
->
c2
.
tun_»ad_by‹s
 +ğc->c2.
buf
.
Ën
;

1181 #ifdeà
LOG_RW


1182 ià(
c
->
c2
.
log_rw
 && c->c2.
buf
.
Ën
 > 0)

1184 
	`årštf
(
¡d”r
, "r");

1189 
	`dmsg
(
D_TUN_RW
, "TUN READ [%d]", 
	`BLEN
(&
c
->
c2
.
buf
));

1191 ià(
c
->
c2
.
buf
.
Ën
 > 0)

1193 ià((
c
->
İtiÚs
.
mode
 =ğ
MODE_POINT_TO_POINT
è&& (!c->İtiÚs.
®low_»cursive_routšg
))

1195 
	`drİ_if_»cursive_routšg
(
c
, &c->
c2
.
buf
);

1201 
	`´oûss__h—d”
(
c
, 
PIPV4_PASSTOS
|
PIP_MSSFIX
|
PIPV4_CLIENT_NAT
, &c->
c2
.
buf
);

1203 #ifdeà
PACKET_TRUNCATION_CHECK


1205 
	`v4_·ck‘_size_v”ify
(
	`BPTR
(&
c
->
c2
.
buf
),

1206 
	`BLEN
(&
c
->
c2
.
buf
),

1207 
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
),

1209 &
c
->
c2
.
n_Œunc_´e_’üy±
);

1212 
	`’üy±_sign
(
c
, 
Œue
);

1216 
	`buf_»£t
(&
c
->
c2
.
to_lšk
);

1218 
	`³rf_pİ
();

1219 
	`gc_ä“
(&
gc
);

1220 
	}
}

1223 
	$´oûss__h—d”
(
cÚ‹xt
 *
c
, 
æags
, 
bufãr
 *
buf
)

1225 ià(!
c
->
İtiÚs
.
û
.
mssfix
)

1227 
æags
 &ğ~
PIP_MSSFIX
;

1229 #ià
PASSTOS_CAPABILITY


1230 ià(!
c
->
İtiÚs
.
·s¡os
)

1232 
æags
 &ğ~
PIPV4_PASSTOS
;

1235 ià(!
c
->
İtiÚs
.
ş›Á_Çt
)

1237 
æags
 &ğ~
PIPV4_CLIENT_NAT
;

1239 ià(!
c
->
İtiÚs
.
rou‹_g©eway_vŸ_dhı
)

1241 
æags
 &ğ~
PIPV4_EXTRACT_DHCP_ROUTER
;

1244 ià(
buf
->
Ën
 > 0)

1251 ià(
æags
 & (
PIP_MSSFIX


1252 #ià
PASSTOS_CAPABILITY


1253 | 
PIPV4_PASSTOS


1255 | 
PIPV4_CLIENT_NAT


1258 
bufãr
 
buf
 = *
buf
;

1259 ià(
	`is_v4
(
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
), &
buf
))

1261 #ià
PASSTOS_CAPABILITY


1263 ià(
æags
 & 
PIPV4_PASSTOS
)

1265 
	`lšk_sock‘_exŒaù_tos
(
c
->
c2
.
lšk_sock‘
, &
buf
);

1270 ià(
æags
 & 
PIP_MSSFIX
)

1272 
	`mss_fixup_v4
(&
buf
, 
	`MTU_TO_MSS
(
	`TUN_MTU_SIZE_DYNAMIC
(&
c
->
c2
.
äame
)));

1276 ià((
æags
 & 
PIPV4_CLIENT_NAT
è&& 
c
->
İtiÚs
.
ş›Á_Çt
)

1278 cÚ¡ 
dœeùiÚ
 = (
æags
 & 
PIPV4_OUTGOING
è? 
CN_INCOMING
 : 
CN_OUTGOING
;

1279 
	`ş›Á_Çt_ŒªsfÜm
(
c
->
İtiÚs
.
ş›Á_Çt
, &
buf
, 
dœeùiÚ
);

1282 ià(
æags
 & 
PIPV4_EXTRACT_DHCP_ROUTER
)

1284 cÚ¡ 
š_addr_t
 
dhı_rou‹r
 = 
	`dhı_exŒaù_rou‹r_msg
(&
buf
);

1285 ià(
dhı_rou‹r
)

1287 
	`rou‹_li¡_add_v²_g©eway
(
c
->
c1
.
rou‹_li¡
, c->
c2
.
es
, 
dhı_rou‹r
);

1291 ià(
	`is_v6
(
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
), &
buf
))

1294 ià(
æags
 & 
PIP_MSSFIX
)

1296 
	`mss_fixup_v6
(&
buf
, 
	`MTU_TO_MSS
(
	`TUN_MTU_SIZE_DYNAMIC
(&
c
->
c2
.
äame
)));

1301 
	}
}

1308 
	$´oûss_outgošg_lšk
(
cÚ‹xt
 *
c
)

1310 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1311 
”rÜ_code
 = 0;

1313 
	`³rf_push
(
PERF_PROC_OUT_LINK
);

1315 ià(
c
->
c2
.
to_lšk
.
Ën
 > 0 && c->c2.to_lšk.ËÀ<ğ
	`EXPANDED_SIZE
(&c->c2.
äame
))

1321 
size
 = 0;

1322 
	`ASSERT
(
	`lšk_sock‘_aùu®_defšed
(
c
->
c2
.
to_lšk_addr
));

1324 #ifdeà
ENABLE_DEBUG


1326 ià(!
c
->
İtiÚs
.
g»mlš
 || 
	`ask_g»mlš
(c->options.gremlin))

1333 #ifdeà
ENABLE_FEATURE_SHAPER


1334 ià(
c
->
İtiÚs
.
sh­”
)

1336 
	`sh­”_wrÙe_by‹s
(&
c
->
c2
.
sh­”
, 
	`BLEN
(&c->c2.
to_lšk
)

1337 + 
	`d©ag¿m_ov”h—d
(
c
->
İtiÚs
.
û
.
´Ùo
));

1343 ià(
c
->
İtiÚs
.
pšg_£nd_timeout
)

1345 
	`ev’t_timeout_»£t
(&
c
->
c2
.
pšg_£nd_š‹rv®
);

1348 #ià
PASSTOS_CAPABILITY


1350 
	`lšk_sock‘_£t_tos
(
c
->
c2
.
lšk_sock‘
);

1354 #ifdeà
LOG_RW


1355 ià(
c
->
c2
.
log_rw
)

1357 
	`årštf
(
¡d”r
, "W");

1360 
	`msg
(
D_LINK_RW
, "%s WRITE [%d]o %s: %s",

1361 
	`´Ùo2ascii
(
c
->
c2
.
lšk_sock‘
->
šfo
.
´Ùo
, c->c2.lšk_sock‘->šfo.
af
, 
Œue
),

1362 
	`BLEN
(&
c
->
c2
.
to_lšk
),

1363 
	`´št_lšk_sock‘_aùu®
(
c
->
c2
.
to_lšk_addr
, &
gc
),

1364 
	`PROTO_DUMP
(&
c
->
c2
.
to_lšk
, &
gc
));

1368 
lšk_sock‘_aùu®
 *
to_addr
 = 
c
->
c2
.
to_lšk_addr
;

1369 
size_d–
 = 0;

1372 
	`socks_´•roûss_outgošg_lšk
(
c
, &
to_addr
, &
size_d–
);

1375 
size
 = 
	`lšk_sock‘_wr™e
(
c
->
c2
.
lšk_sock‘
,

1376 &
c
->
c2
.
to_lšk
,

1377 
to_addr
);

1380 
	`lšk_sock‘_wr™e_po¡_size_adju¡
(&
size
, 
size_d–
, &
c
->
c2
.
to_lšk
);

1383 ià(
size
 > 0)

1385 
c
->
c2
.
max_£nd_size_loÿl
 = 
	`max_št
(
size
, c->c2.max_send_size_local);

1386 
c
->
c2
.
lšk_wr™e_by‹s
 +ğ
size
;

1387 
lšk_wr™e_by‹s_glob®
 +ğ
size
;

1388 #ifdeà
ENABLE_MEMSTATS


1389 ià(
mm­_¡©s
)

1391 
mm­_¡©s
->
lšk_wr™e_by‹s
 = 
lšk_wr™e_by‹s_glob®
;

1394 #ifdeà
ENABLE_MANAGEMENT


1395 ià(
mªagem’t
)

1397 
	`mªagem’t_by‹s_out
(
mªagem’t
, 
size
);

1398 #ifdeà
MANAGEMENT_DEF_AUTH


1399 
	`mªagem’t_by‹s_£rv”
(
mªagem’t
, &
c
->
c2
.
lšk_»ad_by‹s
, &c->c2.
lšk_wr™e_by‹s
, &c->c2.
mda_cÚ‹xt
);

1407 
”rÜ_code
 = 
	`İ’v²_”ºo
();

1408 
	`check_¡©us
(
size
, "wr™e", 
c
->
c2
.
lšk_sock‘
, 
NULL
);

1410 ià(
size
 > 0)

1413 ià(
size
 !ğ
	`BLEN
(&
c
->
c2
.
to_lšk
))

1415 
	`msg
(
D_LINK_ERRORS
,

1417 
	`´št_lšk_sock‘_aùu®
(
c
->
c2
.
to_lšk_addr
, &
gc
),

1418 
	`BLEN
(&
c
->
c2
.
to_lšk
),

1419 
size
);

1424 ià(
c
->
c2
.
buf
.
Ën
 > 0)

1426 
	`»gi¡”_aùiv™y
(
c
, 
size
);

1430 #ifdeà
ENABLE_CRYPTO


1432 ià(
size
 < 0 && 
ENETUNREACH
 =ğ
”rÜ_code
 && 
c
->
c2
.
s_muÉi


1433 && !
	`s_š™Ÿl_·ck‘_»ûived
(
c
->
c2
.
s_muÉi
è&& c->
İtiÚs
.
mode
 =ğ
MODE_POINT_TO_POINT
)

1435 
	`msg
(
M_INFO
, "Network unreachable,„estarting");

1436 
	`»gi¡”_sigÇl
(
c
, 
SIGUSR1
, "network-unreachable");

1442 ià(
c
->
c2
.
to_lšk
.
Ën
 > 0)

1444 
	`msg
(
D_LINK_ERRORS
, "TCP/UDP…acketoo†arge on writeo %s (tried=%d,max=%d)",

1445 
	`´št_lšk_sock‘_aùu®
(
c
->
c2
.
to_lšk_addr
, &
gc
),

1446 
c
->
c2
.
to_lšk
.
Ën
,

1447 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
));

1451 
	`buf_»£t
(&
c
->
c2
.
to_lšk
);

1453 
	`³rf_pİ
();

1454 
	`gc_ä“
(&
gc
);

1455 
	}
}

1462 
	$´oûss_outgošg_tun
(
cÚ‹xt
 *
c
)

1464 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1470 ià(
c
->
c2
.
to_tun
.
Ën
 <= 0)

1475 
	`³rf_push
(
PERF_PROC_OUT_TUN
);

1481 
	`´oûss__h—d”
(
c
, 
PIP_MSSFIX
|
PIPV4_EXTRACT_DHCP_ROUTER
|
PIPV4_CLIENT_NAT
|
PIPV4_OUTGOING
, &c->
c2
.
to_tun
);

1483 ià(
c
->
c2
.
to_tun
.
Ën
 <ğ
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
))

1488 
size
;

1490 #ifdeà
LOG_RW


1491 ià(
c
->
c2
.
log_rw
)

1493 
	`årštf
(
¡d”r
, "w");

1496 
	`dmsg
(
D_TUN_RW
, "TUN WRITE [%d]", 
	`BLEN
(&
c
->
c2
.
to_tun
));

1498 #ifdeà
PACKET_TRUNCATION_CHECK


1499 
	`v4_·ck‘_size_v”ify
(
	`BPTR
(&
c
->
c2
.
to_tun
),

1500 
	`BLEN
(&
c
->
c2
.
to_tun
),

1501 
	`TUNNEL_TYPE
(
c
->
c1
.
tuÁ­
),

1503 &
c
->
c2
.
n_Œunc_tun_wr™e
);

1506 #ifdeà
TUN_PASS_BUFFER


1507 
size
 = 
	`wr™e_tun_bufã»d
(
c
->
c1
.
tuÁ­
, &c->
c2
.
to_tun
);

1509 
size
 = 
	`wr™e_tun
(
c
->
c1
.
tuÁ­
, 
	`BPTR
(&c->
c2
.
to_tun
), 
	`BLEN
(&c->c2.to_tun));

1512 ià(
size
 > 0)

1514 
c
->
c2
.
tun_wr™e_by‹s
 +ğ
size
;

1516 
	`check_¡©us
(
size
, "wr™tØTUN/TAP", 
NULL
, 
c
->
c1
.
tuÁ­
);

1519 ià(
size
 > 0)

1522 ià(
size
 !ğ
	`BLEN
(&
c
->
c2
.
to_tun
))

1524 
	`msg
(
D_LINK_ERRORS
,

1526 
c
->
c1
.
tuÁ­
->
aùu®_Çme
,

1527 
	`BLEN
(&
c
->
c2
.
to_tun
),

1528 
size
);

1532 
	`»gi¡”_aùiv™y
(
c
, 
size
);

1541 
	`msg
(
D_LINK_ERRORS
, "tun…acketoo†arge on write (tried=%d,max=%d)",

1542 
c
->
c2
.
to_tun
.
Ën
,

1543 
	`MAX_RW_SIZE_TUN
(&
c
->
c2
.
äame
));

1546 
	`buf_»£t
(&
c
->
c2
.
to_tun
);

1548 
	`³rf_pİ
();

1549 
	`gc_ä“
(&
gc
);

1550 
	}
}

1553 
	$´e_£Ëù
(
cÚ‹xt
 *
c
)

1562 
c
->
c2
.
timev®
.
tv_£c
 = 
BIG_TIMEOUT
;

1563 
c
->
c2
.
timev®
.
tv_u£c
 = 0;

1565 #ià
	`defšed
(
_WIN32
)

1566 ià(
	`check_debug_Ëv–
(
D_TAP_WIN_DEBUG
))

1568 
c
->
c2
.
timev®
.
tv_£c
 = 1;

1569 ià(
	`tuÁ­_defšed
(
c
->
c1
.
tuÁ­
))

1571 
	`tun_show_debug
(
c
->
c1
.
tuÁ­
);

1577 
	`check_cßr£_tim”s
(
c
);

1578 ià(
c
->
sig
->
sigÇl_»ûived
)

1584 
	`check_s
(
c
);

1587 
	`check_s_”rÜs
(
c
);

1588 ià(
c
->
sig
->
sigÇl_»ûived
)

1594 
	`check_šcomšg_cÚŒŞ_chªÃl
(
c
);

1596 #ifdeà
ENABLE_OCC


1598 
	`check_£nd_occ_msg
(
c
);

1601 #ifdeà
ENABLE_FRAGMENT


1603 
	`check_äagm’t
(
c
);

1607 
	`check_timeout_¿ndom_compÚ’t
(
c
);

1608 
	}
}

1617 
	$io_wa™_dowÜk
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

1619 
sock‘
 = 0;

1620 
tuÁ­
 = 0;

1621 
ev’t_£t_»tuº
 
e¤
[4];

1624 
sock‘_shiá
 = 0;

1625 
tun_shiá
 = 2;

1626 
”r_shiá
 = 4;

1627 #ifdeà
ENABLE_MANAGEMENT


1628 
mªagem’t_shiá
 = 6;

1630 #ifdeà
ENABLE_ASYNC_PUSH


1631 
fe_shiá
 = 8;

1637 
	`ev’t_»£t
(
c
->
c2
.
ev’t_£t
);

1643 ià(
æags
 & 
IOW_WAIT_SIGNAL
)

1645 
	`wa™_sigÇl
(
c
->
c2
.
ev’t_£t
, (*)&
”r_shiá
);

1653 ià(
æags
 & 
IOW_TO_LINK
)

1655 ià(
æags
 & 
IOW_SHAPER
)

1662 #ifdeà
ENABLE_FEATURE_SHAPER


1663 
d–ay
 = 0;

1666 ià(
c
->
İtiÚs
.
sh­”
)

1668 
d–ay
 = 
	`max_št
(d–ay, 
	`sh­”_d–ay
(&
c
->
c2
.
sh­”
));

1671 ià(
d–ay
 < 1000)

1673 
sock‘
 |ğ
EVENT_WRITE
;

1677 
	`sh­”_soÚe¡_ev’t
(&
c
->
c2
.
timev®
, 
d–ay
);

1680 
sock‘
 |ğ
EVENT_WRITE
;

1685 
sock‘
 |ğ
EVENT_WRITE
;

1688 ià(!((
æags
 & 
IOW_FRAG
è&& 
	`TO_LINK_FRAG
(
c
)))

1690 ià(
æags
 & 
IOW_READ_TUN
)

1692 
tuÁ­
 |ğ
EVENT_READ
;

1700 ià(
æags
 & 
IOW_TO_TUN
)

1702 
tuÁ­
 |ğ
EVENT_WRITE
;

1706 ià(
æags
 & 
IOW_READ_LINK
)

1708 
sock‘
 |ğ
EVENT_READ
;

1715 ià(
æags
 & 
IOW_MBUF
)

1717 
sock‘
 |ğ
EVENT_WRITE
;

1723 ià(
æags
 & 
IOW_READ_TUN_FORCE
)

1725 
tuÁ­
 |ğ
EVENT_READ
;

1731 
	`sock‘_£t
(
c
->
c2
.
lšk_sock‘
, c->c2.
ev’t_£t
, 
sock‘
, (*)&
sock‘_shiá
, 
NULL
);

1732 
	`tun_£t
(
c
->
c1
.
tuÁ­
, c->
c2
.
ev’t_£t
,uÁ­, (*)&
tun_shiá
, 
NULL
);

1734 #ifdeà
ENABLE_MANAGEMENT


1735 ià(
mªagem’t
)

1737 
	`mªagem’t_sock‘_£t
(
mªagem’t
, 
c
->
c2
.
ev’t_£t
, (*)&
mªagem’t_shiá
, 
NULL
);

1741 #ifdeà
ENABLE_ASYNC_PUSH


1743 ià(
c
->
İtiÚs
.
mode
 =ğ
MODE_SERVER
)

1745 
	`ev’t_ùl
(
c
->
c2
.
ev’t_£t
, c->c2.
šÙify_fd
, 
EVENT_READ
, (*)&
fe_shiá
);

1759 
c
->
c2
.
ev’t_£t_¡©us
 = 
ES_ERROR
;

1761 ià(!
c
->
sig
->
sigÇl_»ûived
)

1763 ià(!(
æags
 & 
IOW_CHECK_RESIDUAL
è|| !
	`sock‘_»ad_»sidu®
(
c
->
c2
.
lšk_sock‘
))

1765 
¡©us
;

1767 #ifdeà
ENABLE_DEBUG


1768 ià(
	`check_debug_Ëv–
(
D_EVENT_WAIT
))

1770 
	`show_wa™_¡©us
(
c
);

1777 
¡©us
 = 
	`ev’t_wa™
(
c
->
c2
.
ev’t_£t
, &c->c2.
timev®
, 
e¤
, 
	`SIZE
(esr));

1779 
	`check_¡©us
(
¡©us
, "ev’t_wa™", 
NULL
, NULL);

1781 ià(
¡©us
 > 0)

1783 
i
;

1784 
c
->
c2
.
ev’t_£t_¡©us
 = 0;

1785 
i
 = 0; i < 
¡©us
; ++i)

1787 cÚ¡ 
ev’t_£t_»tuº
 *
e
 = &
e¤
[
i
];

1788 
c
->
c2
.
ev’t_£t_¡©us
 |ğ((
e
->
rwæags
 & 3è<< *((*ë->
¬g
));

1791 ià(
¡©us
 == 0)

1793 
c
->
c2
.
ev’t_£t_¡©us
 = 
ES_TIMEOUT
;

1798 
c
->
c2
.
ev’t_£t_¡©us
 = 
SOCKET_READ
;

1803 
	`upd©e_time
();

1806 ià(
c
->
c2
.
ev’t_£t_¡©us
 & 
ES_ERROR
)

1808 
	`g‘_sigÇl
(&
c
->
sig
->
sigÇl_»ûived
);

1811 
	`dmsg
(
D_EVENT_WAIT
, "I/O WAIT stus=0x%04x", 
c
->
c2
.
ev’t_£t_¡©us
);

1812 
	}
}

1815 
	$´oûss_io
(
cÚ‹xt
 *
c
)

1817 cÚ¡ 
¡©us
 = 
c
->
c2
.
ev’t_£t_¡©us
;

1819 #ifdeà
ENABLE_MANAGEMENT


1820 ià(
¡©us
 & (
MANAGEMENT_READ
|
MANAGEMENT_WRITE
))

1822 
	`ASSERT
(
mªagem’t
);

1823 
	`mªagem’t_io
(
mªagem’t
);

1828 ià(
¡©us
 & 
SOCKET_WRITE
)

1830 
	`´oûss_outgošg_lšk
(
c
);

1833 ià(
¡©us
 & 
TUN_WRITE
)

1835 
	`´oûss_outgošg_tun
(
c
);

1838 ià(
¡©us
 & 
SOCKET_READ
)

1840 
	`»ad_šcomšg_lšk
(
c
);

1841 ià(!
	`IS_SIG
(
c
))

1843 
	`´oûss_šcomšg_lšk
(
c
);

1847 ià(
¡©us
 & 
TUN_READ
)

1849 
	`»ad_šcomšg_tun
(
c
);

1850 ià(!
	`IS_SIG
(
c
))

1852 
	`´oûss_šcomšg_tun
(
c
);

1855 
	}
}

	@forward.h

31 #iâdeà
FORWARD_H


32 
	#FORWARD_H


	)

34 
	~"İ’v².h
"

35 
	~"occ.h
"

36 
	~"pšg.h
"

38 
	#TUN_OUT
(
c
è(
	`BLEN
(&(c)->
c2
.
to_tun
è> 0)

	)

39 
	#LINK_OUT
(
c
è(
	`BLEN
(&(c)->
c2
.
to_lšk
è> 0)

	)

40 
	#ANY_OUT
(
c
è(
	`TUN_OUT
(cè|| 
	`LINK_OUT
(c))

	)

42 #ifdeà
ENABLE_FRAGMENT


43 
	#TO_LINK_FRAG
(
c
è((c)->
c2
.
äagm’t
 && 
	`äagm’t_outgošg_defšed
((c)->c2.äagm’t))

	)

45 
	#TO_LINK_FRAG
(
c
è(
çl£
)

	)

48 
	#TO_LINK_DEF
(
c
è(
	`LINK_OUT
(cè|| 
	`TO_LINK_FRAG
(c))

	)

50 
	#IOW_TO_TUN
 (1<<0)

	)

51 
	#IOW_TO_LINK
 (1<<1)

	)

52 
	#IOW_READ_TUN
 (1<<2)

	)

53 
	#IOW_READ_LINK
 (1<<3)

	)

54 
	#IOW_SHAPER
 (1<<4)

	)

55 
	#IOW_CHECK_RESIDUAL
 (1<<5)

	)

56 
	#IOW_FRAG
 (1<<6)

	)

57 
	#IOW_MBUF
 (1<<7)

	)

58 
	#IOW_READ_TUN_FORCE
 (1<<8)

	)

59 
	#IOW_WAIT_SIGNAL
 (1<<9)

	)

61 
	#IOW_READ
 (
IOW_READ_TUN
|
IOW_READ_LINK
)

	)

64 
´e_£Ëù
(
cÚ‹xt
 *
c
);

66 
´oûss_io
(
cÚ‹xt
 *
c
);

68 cÚ¡ *
wa™_¡©us_¡ršg
(
cÚ‹xt
 *
c
, 
gc_¬’a
 *
gc
);

70 
show_wa™_¡©us
(
cÚ‹xt
 *
c
);

106 
’üy±_sign
(
cÚ‹xt
 *
c
, 
boŞ
 
comp_äag
);

108 
g‘_£rv”_pŞl_»maššg_time
(
ev’t_timeout
 *
£rv”_pŞl_timeout
);

130 
»ad_šcomšg_lšk
(
cÚ‹xt
 *
c
);

158 
boŞ
 
´oûss_šcomšg_lšk_·¹1
(
cÚ‹xt
 *
c
, 
lšk_sock‘_šfo
 *
lsi
, boŞ 
æß‹d
);

185 
´oûss_šcomšg_lšk_·¹2
(
cÚ‹xt
 *
c
, 
lšk_sock‘_šfo
 *
lsi
, cÚ¡ 
ušt8_t
 *
Üig_buf
);

199 
´oûss_outgošg_lšk
(
cÚ‹xt
 *
c
);

215 
»ad_šcomšg_tun
(
cÚ‹xt
 *
c
);

230 
´oûss_šcomšg_tun
(
cÚ‹xt
 *
c
);

245 
´oûss_outgošg_tun
(
cÚ‹xt
 *
c
);

250 
boŞ
 
£nd_cÚŒŞ_chªÃl_¡ršg
(
cÚ‹xt
 *
c
, cÚ¡ *
¡r
, 
msgËv–
);

252 
	#PIPV4_PASSTOS
 (1<<0)

	)

253 
	#PIP_MSSFIX
 (1<<1è

	)

254 
	#PIPV4_OUTGOING
 (1<<2)

	)

255 
	#PIPV4_EXTRACT_DHCP_ROUTER
 (1<<3)

	)

256 
	#PIPV4_CLIENT_NAT
 (1<<4)

	)

258 
´oûss__h—d”
(
cÚ‹xt
 *
c
, 
æags
, 
bufãr
 *
buf
);

260 #ià
P2MP


261 
scheduË_ex™
(
cÚ‹xt
 *
c
, cÚ¡ 
n_£cÚds
, cÚ¡ 
sigÇl
);

	@fragment.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
ENABLE_FRAGMENT


34 
	~"misc.h
"

35 
	~"äagm’t.h
"

36 
	~"š‹g”.h
"

37 
	~"memdbg.h
"

39 
	#FRAG_ERR
(
s
è{ 
”rmsg
 = s; 
”rÜ
; }

	)

42 
	$äagm’t_li¡_buf_š™
(
äagm’t_li¡
 *
li¡
, cÚ¡ 
äame
 *frame)

44 
i
;

45 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

47 
li¡
->
äagm’ts
[
i
].
buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

49 
	}
}

52 
	$äagm’t_li¡_buf_ä“
(
äagm’t_li¡
 *
li¡
)

54 
i
;

55 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

57 
	`ä“_buf
(&
li¡
->
äagm’ts
[
i
].
buf
);

59 
	}
}

65 
äagm’t
 *

66 
	$äagm’t_li¡_g‘_buf
(
äagm’t_li¡
 *
li¡
, 
£q_id
)

68 
diff
;

69 ià(
	`abs
(
diff
 = 
	`modulo_subŒaù
(
£q_id
, 
li¡
->£q_id, 
N_SEQ_ID
)è>ğ
N_FRAG_BUF
)

71 
i
;

72 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

74 
li¡
->
äagm’ts
[
i
].
defšed
 = 
çl£
;

76 
li¡
->
šdex
 = 0;

77 
li¡
->
£q_id
 = seq_id;

78 
diff
 = 0;

80 
diff
 > 0)

82 
li¡
->
äagm’ts
[li¡->
šdex
 = 
	`modulo_add
Öi¡->šdex, 1, 
N_FRAG_BUF
)].
defšed
 = 
çl£
;

83 
li¡
->
£q_id
 = 
	`modulo_add
Öi¡->£q_id, 1, 
N_SEQ_ID
);

84 --
diff
;

86  &
li¡
->
äagm’ts
[
	`modulo_add
Öi¡->
šdex
, 
diff
, 
N_FRAG_BUF
)];

87 
	}
}

89 
äagm’t_ma¡”
 *

90 
	$äagm’t_š™
(
äame
 *frame)

92 
äagm’t_ma¡”
 *
»t
;

96 
	`ALLOC_OBJ_CLEAR
(
»t
, 
äagm’t_ma¡”
);

99 
	`äame_add_to_exŒa_äame
(
äame
, (
äagm’t_h—d”_ty³
));

109 
»t
->
outgošg_£q_id
 = ()
	`g‘_¿ndom
(è& (
N_SEQ_ID
 - 1);

111 
	`ev’t_timeout_š™
(&
»t
->
wakeup
, 
FRAG_WAKEUP_INTERVAL
, 
now
);

113  
»t
;

114 
	}
}

117 
	$äagm’t_ä“
(
äagm’t_ma¡”
 *
f
)

119 
	`äagm’t_li¡_buf_ä“
(&
f
->
šcomšg
);

120 
	`ä“_buf
(&
f
->
outgošg
);

121 
	`ä“_buf
(&
f
->
outgošg_»tuº
);

122 
	`ä“
(
f
);

123 
	}
}

126 
	$äagm’t_äame_š™
(
äagm’t_ma¡”
 *
f
, cÚ¡ 
äame
 *frame)

128 
	`äagm’t_li¡_buf_š™
(&
f
->
šcomšg
, 
äame
);

129 
f
->
outgošg
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

130 
f
->
outgošg_»tuº
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

131 
	}
}

140 
	$äagm’t_šcomšg
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

141 cÚ¡ 
äame
 *frame)

143 cÚ¡ *
”rmsg
 = 
NULL
;

144 
äagm’t_h—d”_ty³
 
æags
 = 0;

145 
äag_ty³
 = 0;

147 ià(
buf
->
Ën
 > 0)

150 ià(!
	`buf_»ad
(
buf
, &
æags
, (flags)))

152 
	`FRAG_ERR
("flags‚ot found in…acket");

154 
æags
 = 
	`Áoh_äagm’t_h—d”_ty³
(flags);

157 
äag_ty³
 = ((
æags
 >> 
FRAG_TYPE_SHIFT
è& 
FRAG_TYPE_MASK
);

164 ià(
äag_ty³
 =ğ
FRAG_WHOLE
 || f¿g_ty³ =ğ
FRAG_YES_NOTLAST
)

170 ià(
äag_ty³
 =ğ
FRAG_WHOLE
)

172 
	`dmsg
(
D_FRAG_DEBUG
,

174 
äagm’t_h—d”_fÜm©
,

175 
buf
->
Ën
,

176 
æags
);

178 ià(
æags
 & (
FRAG_SEQ_ID_MASK
 | 
FRAG_ID_MASK
))

180 
	`FRAG_ERR
("spurrious FRAG_WHOLE flags");

183 ià(
äag_ty³
 =ğ
FRAG_YES_NOTLAST
 || f¿g_ty³ =ğ
FRAG_YES_LAST
)

185 cÚ¡ 
£q_id
 = ((
æags
 >> 
FRAG_SEQ_ID_SHIFT
è& 
FRAG_SEQ_ID_MASK
);

186 cÚ¡ 
n
 = ((
æags
 >> 
FRAG_ID_SHIFT
è& 
FRAG_ID_MASK
);

187 cÚ¡ 
size
 = ((
äag_ty³
 =ğ
FRAG_YES_LAST
)

188 ? ()(((
æags
 >> 
FRAG_SIZE_SHIFT
è& 
FRAG_SIZE_MASK
è<< 
FRAG_SIZE_ROUND_SHIFT
)

189 : 
buf
->
Ën
);

192 
äagm’t
 *
äag
 = 
	`äagm’t_li¡_g‘_buf
(&
f
->
šcomšg
, 
£q_id
);

194 
	`dmsg
(
D_FRAG_DEBUG
,

196 
äagm’t_h—d”_fÜm©
,

197 
buf
->
Ën
,

198 
äag_ty³
,

199 
£q_id
,

200 
n
,

201 
size
,

202 
æags
);

205 ià(
size
 & 
FRAG_SIZE_ROUND_MASK
)

207 
	`FRAG_ERR
("bad fragment size");

211 ià(!
äag
->
defšed
 || f¿g->
max_äag_size
 !ğ
size
)

213 
äag
->
defšed
 = 
Œue
;

214 
äag
->
max_äag_size
 = 
size
;

215 
äag
->
m­
 = 0;

216 
	`ASSERT
(
	`buf_š™
(&
äag
->
buf
, 
	`FRAME_HEADROOM_ADJ
(
äame
, 
FRAME_HEADROOM_MARKER_FRAGMENT
)));

220 ià(!
	`buf_cİy_¿nge
(&
äag
->
buf
, 
n
 * 
size
, buf, 0, buf->
Ën
))

222 
	`FRAG_ERR
("fragment buffer overflow");

226 
äag
->
m­
 |ğ(((
äag_ty³
 =ğ
FRAG_YES_LAST
è? 
FRAG_MAP_MASK
 : 1è<< 
n
);

229 
äag
->
time¡amp
 = 
now
;

232 ià((
äag
->
m­
 & 
FRAG_MAP_MASK
) == FRAG_MAP_MASK)

234 
äag
->
defšed
 = 
çl£
;

235 *
buf
 = 
äag
->buf;

239 
buf
->
Ën
 = 0;

242 ià(
äag_ty³
 =ğ
FRAG_TEST
)

244 
	`FRAG_ERR
("FRAG_TEST‚ot implemented");

248 
	`FRAG_ERR
("unknown fragmentype");

254 
”rÜ
:

255 ià(
”rmsg
)

257 
	`msg
(
D_FRAG_ERRORS
, "FRAG_INƒ¼Ü fÏgs=" 
äagm’t_h—d”_fÜm©
 ": %s", 
æags
, 
”rmsg
);

259 
buf
->
Ën
 = 0;

261 
	}
}

265 
	$äagm’t_´•’d_æags
(
bufãr
 *
buf
,

266 
ty³
,

267 
£q_id
,

268 
äag_id
,

269 
äag_size
)

271 
äagm’t_h—d”_ty³
 
æags
 = ((
ty³
 & 
FRAG_TYPE_MASK
è<< 
FRAG_TYPE_SHIFT
)

272 | ((
£q_id
 & 
FRAG_SEQ_ID_MASK
è<< 
FRAG_SEQ_ID_SHIFT
)

273 | ((
äag_id
 & 
FRAG_ID_MASK
è<< 
FRAG_ID_SHIFT
);

275 ià(
ty³
 =ğ
FRAG_WHOLE
 ||y³ =ğ
FRAG_YES_NOTLAST
)

281 
	`dmsg
(
D_FRAG_DEBUG
,

283 
äagm’t_h—d”_fÜm©
,

284 
buf
->
Ën
, 
ty³
, 
£q_id
, 
äag_id
, 
äag_size
, 
æags
);

288 
æags
 |ğ(((
äag_size
 >> 
FRAG_SIZE_ROUND_SHIFT
è& 
FRAG_SIZE_MASK
è<< 
FRAG_SIZE_SHIFT
);

290 
	`dmsg
(
D_FRAG_DEBUG
,

292 
äagm’t_h—d”_fÜm©
,

293 
buf
->
Ën
, 
ty³
, 
£q_id
, 
äag_id
, 
äag_size
, 
æags
);

296 
æags
 = 
	`htÚ_äagm’t_h—d”_ty³
(flags);

297 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
æags
, (flags)));

298 
	}
}

305 
šlše
 

306 
	$İtim®_äagm’t_size
(
Ën
, 
max_äag_size
)

308 cÚ¡ 
mfs_®igÃd
 = (
max_äag_size
 & ~
FRAG_SIZE_ROUND_MASK
);

309 cÚ¡ 
div
 = 
Ën
 / 
mfs_®igÃd
;

310 cÚ¡ 
mod
 = 
Ën
 % 
mfs_®igÃd
;

312 ià(
div
 > 0 && 
mod
 > 0 && mod < 
mfs_®igÃd
 * 3 / 4)

314  
	`mš_št
(
mfs_®igÃd
, (
max_äag_size
 - ((max_äag_siz- 
mod
è/ (
div
 + 1))

315 + 
FRAG_SIZE_ROUND_MASK
) & ~FRAG_SIZE_ROUND_MASK);

319  
mfs_®igÃd
;

321 
	}
}

325 
	$äagm’t_outgošg
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

326 cÚ¡ 
äame
 *frame)

328 cÚ¡ *
”rmsg
 = 
NULL
;

329 ià(
buf
->
Ën
 > 0)

332 ià(
f
->
outgošg
.
Ën
)

334 
	`msg
(
D_FRAG_ERRORS
, "FRAG: outgoing buffer is‚otƒmpty,†en=[%d,%d]",

335 
buf
->
Ën
, 
f
->
outgošg
.len);

337 ià(
buf
->
Ën
 > 
	`PAYLOAD_SIZE_DYNAMIC
(
äame
))

342 
f
->
outgošg_äag_size
 = 
	`İtim®_äagm’t_size
(
buf
->
Ën
, 
	`PAYLOAD_SIZE_DYNAMIC
(
äame
));

343 ià(
buf
->
Ën
 > 
f
->
outgošg_äag_size
 * 
MAX_FRAGS
)

345 
	`FRAG_ERR
("too many fragments would be„equiredo send datagram");

347 
	`ASSERT
(
	`buf_š™
(&
f
->
outgošg
, 
	`FRAME_HEADROOM
(
äame
)));

348 
	`ASSERT
(
	`buf_cİy
(&
f
->
outgošg
, 
buf
));

349 
f
->
outgošg_£q_id
 = 
	`modulo_add
(f->outgošg_£q_id, 1, 
N_SEQ_ID
);

350 
f
->
outgošg_äag_id
 = 0;

351 
buf
->
Ën
 = 0;

352 
	`ASSERT
(
	`äagm’t_»ady_to_£nd
(
f
, 
buf
, 
äame
));

359 
	`äagm’t_´•’d_æags
(
buf
,

360 
FRAG_WHOLE
,

368 
”rÜ
:

369 ià(
”rmsg
)

371 
	`msg
(
D_FRAG_ERRORS
, "FRAG_OUTƒrror,†en=%d frag_size=%d MAX_FRAGS=%d: %s",

372 
buf
->
Ën
, 
f
->
outgošg_äag_size
, 
MAX_FRAGS
, 
”rmsg
);

374 
buf
->
Ën
 = 0;

376 
	}
}

379 
boŞ


380 
	$äagm’t_»ady_to_£nd
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

381 cÚ¡ 
äame
 *frame)

383 ià(
	`äagm’t_outgošg_defšed
(
f
))

386 
size
 = 
f
->
outgošg_äag_size
;

387 
Ï¡
 = 
çl£
;

388 ià(
f
->
outgošg
.
Ën
 <ğ
size
)

390 
size
 = 
f
->
outgošg
.
Ën
;

391 
Ï¡
 = 
Œue
;

395 *
buf
 = 
f
->
outgošg_»tuº
;

396 
	`ASSERT
(
	`buf_š™
(
buf
, 
	`FRAME_HEADROOM
(
äame
)));

397 
	`ASSERT
(
	`buf_cİy_n
(
buf
, &
f
->
outgošg
, 
size
));

400 
	`äagm’t_´•’d_æags
(
buf
,

401 
Ï¡
 ? 
FRAG_YES_LAST
 : 
FRAG_YES_NOTLAST
,

402 
f
->
outgošg_£q_id
,

403 
f
->
outgošg_äag_id
++,

404 
f
->
outgošg_äag_size
);

406 
	`ASSERT
(!
Ï¡
 || !
f
->
outgošg
.
Ën
);

408  
Œue
;

412  
çl£
;

414 
	}
}

417 
	$äagm’t_‰l_»­
(
äagm’t_ma¡”
 *
f
)

419 
i
;

420 
i
 = 0; i < 
N_FRAG_BUF
; ++i)

422 
äagm’t
 *
äag
 = &
f
->
šcomšg
.
äagm’ts
[
i
];

423 ià(
äag
->
defšed
 && f¿g->
time¡amp
 + 
FRAG_TTL_SEC
 <ğ
now
)

425 
	`msg
(
D_FRAG_ERRORS
, "FRAG TTLƒxpœed i=%d", 
i
);

426 
äag
->
defšed
 = 
çl£
;

429 
	}
}

433 
	$äagm’t_wakeup
(
äagm’t_ma¡”
 *
f
, 
äame
 *frame)

436 
	`äagm’t_‰l_»­
(
f
);

437 
	}
}

441 
	$dummy
()

443 
	}
}

	@fragment.h

24 #iâdeà
FRAGMENT_H


25 
	#FRAGMENT_H


	)

33 #ifdeà
ENABLE_FRAGMENT


41 
	~"commÚ.h
"

42 
	~"bufãr.h
"

43 
	~"š‹rv®.h
"

44 
	~"mtu.h
"

45 
	~"sh­”.h
"

46 
	~"”rÜ.h
"

49 
	#N_FRAG_BUF
 25

	)

54 
	#FRAG_TTL_SEC
 10

	)

57 
	#FRAG_WAKEUP_INTERVAL
 5

	)

65 
	säagm’t
 {

66 
boŞ
 
	mdefšed
;

69 
	mmax_äag_size
;

71 
	#FRAG_MAP_MASK
 0xFFFFFFFF

	)

73 
	#MAX_FRAGS
 32

	)

74 
	mm­
;

84 
time_t
 
	mtime¡amp
;

86 
bufãr
 
	mbuf
;

95 
	säagm’t_li¡
 {

96 
	m£q_id
;

99 
	mšdex
;

114 
äagm’t
 
	mäagm’ts
[
N_FRAG_BUF
];

136 
	säagm’t_ma¡”
 {

137 
ev’t_timeout
 
	mwakeup
;

140 
boŞ
 
	m»ûived_os_mtu_hšt
;

142 
	#N_SEQ_ID
 256

	)

146 
	moutgošg_£q_id
;

154 
	#MAX_FRAG_PKT_SIZE
 65536

	)

157 
	moutgošg_äag_size
;

169 
	moutgošg_äag_id
;

172 
bufãr
 
	moutgošg
;

174 
bufãr
 
	moutgošg_»tuº
;

179 
äagm’t_li¡
 
	mšcomšg
;

190 
ušt32_t
 
	täagm’t_h—d”_ty³
;

194 
	#htÚ_äagm’t_h—d”_ty³
(
x
è
	`htÚl
(x)

	)

198 
	#Áoh_äagm’t_h—d”_ty³
(
x
è
	`Áohl
(x)

	)

202 
	#FRAG_TYPE_MASK
 0x00000003

	)

204 
	#FRAG_TYPE_SHIFT
 0

	)

206 
	#FRAG_WHOLE
 0

	)

208 
	#FRAG_YES_NOTLAST
 1

	)

211 
	#FRAG_YES_LAST
 2

	)

214 
	#FRAG_TEST
 3

	)

219 
	#FRAG_SEQ_ID_MASK
 0x000000ff

	)

221 
	#FRAG_SEQ_ID_SHIFT
 2

	)

223 
	#FRAG_ID_MASK
 0x0000001f

	)

225 
	#FRAG_ID_SHIFT
 10

	)

237 
	#FRAG_SIZE_MASK
 0x00003fff

	)

239 
	#FRAG_SIZE_SHIFT
 15

	)

241 
	#FRAG_SIZE_ROUND_SHIFT
 2

	)

242 
	#FRAG_SIZE_ROUND_MASK
 ((1 << 
FRAG_SIZE_ROUND_SHIFT
è- 1)

	)

250 
	#FRAG_EXTRA_MASK
 0x0000ffff

	)

252 
	#FRAG_EXTRA_SHIFT
 15

	)

273 
äagm’t_ma¡”
 *
äagm’t_š™
(
äame
 *frame);

285 
äagm’t_äame_š™
(
äagm’t_ma¡”
 *
f
, cÚ¡ 
äame
 *frame);

293 
äagm’t_ä“
(
äagm’t_ma¡”
 *
f
);

342 
äagm’t_šcomšg
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

343 cÚ¡ 
äame
 *frame);

393 
äagm’t_outgošg
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

394 cÚ¡ 
äame
 *frame);

423 
boŞ
 
äagm’t_»ady_to_£nd
(
äagm’t_ma¡”
 *
f
, 
bufãr
 *
buf
,

424 cÚ¡ 
äame
 *frame);

437 
šlše
 
boŞ


438 
	$äagm’t_outgošg_defšed
(
äagm’t_ma¡”
 *
f
)

440  
f
->
outgošg
.
Ën
 > 0;

441 
	}
}

446 
äagm’t_wakeup
(
äagm’t_ma¡”
 *
f
, 
äame
 *frame);

464 
šlše
 

465 
	$äagm’t_hou£k“pšg
(
äagm’t_ma¡”
 *
f
, 
äame
 *äame, 
timev®
 *
tv
)

467 ià(
	`ev’t_timeout_Œigg”
(&
f
->
wakeup
, 
tv
, 
ETT_DEFAULT
))

469 
	`äagm’t_wakeup
(
f
, 
äame
);

471 
	}
}

	@gremlin.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ifdeà
ENABLE_DEBUG


39 
	~"”rÜ.h
"

40 
	~"commÚ.h
"

41 
	~"misc.h
"

42 
	~"Ùime.h
"

43 
	~"g»mlš.h
"

45 
	~"memdbg.h
"

58 cÚ¡ 
	gdrİ_äeq
[] = { 500, 100, 50 };

63 cÚ¡ 
	gcÜru±_äeq
[] = { 500, 100, 50 };

69 cÚ¡ 
	gup_low
[] = { 60, 10, 5 };

70 cÚ¡ 
	gup_high
[] = { 600, 60, 10 };

76 cÚ¡ 
	gdown_low
[] = { 5, 10, 10 };

77 cÚ¡ 
	gdown_high
[] = { 10, 60, 120 };

83 cÚ¡ 
·ck‘_æood_·rms
 
	g·ck‘_æood_d©a
[] =

86 
·ck‘_æood_·rms


87 
	$g‘_·ck‘_æood_·rms
(
Ëv–
)

89 
	`ASSERT
(
Ëv–
 > 0 &&†evel < 4);

90  
·ck‘_æood_d©a
 [
Ëv–
 - 1];

91 
	}
}

96 
boŞ


97 
	$æ
(
n
)

99  (
	`g‘_¿ndom
(è% 
n
) == 0;

100 
	}
}

107 
	$rŞl
(
low
, 
high
)

109 
»t
;

110 
	`ASSERT
(
low
 <ğ
high
);

111 
»t
 = 
low
 + (
	`g‘_¿ndom
(è% (
high
 -†ow + 1));

112 
	`ASSERT
(
»t
 >ğ
low
 &&„‘ <ğ
high
);

113  
»t
;

114 
	}
}

116 
boŞ
 
	gš™Ÿlized
;

117 
boŞ
 
	gup
;

118 
time_t
 
	gÃxt
;

123 
boŞ


124 
	$ask_g»mlš
(
æags
)

126 cÚ¡ 
up_down_Ëv–
 = 
	`GREMLIN_UP_DOWN_LEVEL
(
æags
);

127 cÚ¡ 
drİ_Ëv–
 = 
	`GREMLIN_DROP_LEVEL
(
æags
);

129 ià(!
š™Ÿlized
)

131 
š™Ÿlized
 = 
Œue
;

133 ià(
up_down_Ëv–
)

135 
up
 = 
çl£
;

139 
up
 = 
Œue
;

142 
Ãxt
 = 
now
;

145 ià(
up_down_Ëv–
)

147 ià(
now
 >ğ
Ãxt
)

149 
d–
;

150 ià(
up
)

152 
d–
 = 
	`rŞl
(
down_low
[
up_down_Ëv–
-1], 
down_high
[up_down_level-1]);

153 
up
 = 
çl£
;

157 
d–
 = 
	`rŞl
(
up_low
[
up_down_Ëv–
-1], 
up_high
[up_down_level-1]);

158 
up
 = 
Œue
;

161 
	`msg
(
D_GREMLIN
,

163 (
up
 ? "UP" : "DOWN"),

164 
d–
);

165 
Ãxt
 = 
now
 + 
d–
;

169 ià(
drİ_Ëv–
)

171 ià(
up
 && 
	`æ
(
drİ_äeq
[
drİ_Ëv–
-1]))

173 
	`dmsg
(
D_GREMLIN_VERBOSE
, "GREMLIN: Random…acket drop");

174  
çl£
;

178  
up
;

179 
	}
}

185 
	$cÜru±_g»mlš
(
bufãr
 *
buf
, 
æags
)

187 cÚ¡ 
cÜru±_Ëv–
 = 
	`GREMLIN_CORRUPT_LEVEL
(
æags
);

188 ià(
cÜru±_Ëv–
)

190 ià(
	`æ
(
cÜru±_äeq
[
cÜru±_Ëv–
-1]))

194 ià(
buf
->
Ën
 > 0)

196 
ušt8_t
 
r
 = 
	`rŞl
(0, 255);

197 
m‘hod
 = 
	`rŞl
(0, 5);

199 
m‘hod
)

202 *
	`BPTR
(
buf
èğ
r
;

206 *(
	`BPTR
(
buf
è+ buf->
Ën
 - 1èğ
r
;

210 *(
	`BPTR
(
buf
è+ 
	`rŞl
(0, buf->
Ën
 - 1)èğ
r
;

214 
	`buf_wr™e
(
buf
, &
r
, 1);

218 --
buf
->
Ën
;

222 
buf
->
Ën
 -ğ
	`rŞl
(0, buf->len - 1);

225 
	`dmsg
(
D_GREMLIN_VERBOSE
, "GREMLIN: Pack‘ CÜru±iÚ, m‘hod=%d", 
m‘hod
);

231 } 
	`æ
(2));

234 
	}
}

238 
	$dummy
()

240 
	}
}

	@gremlin.h

24 #iâdeà
GREMLIN_H


25 
	#GREMLIN_H


	)

27 #ifdeà
ENABLE_DEBUG


33 
	#GREMLIN_CONNECTION_FLOOD_SHIFT
 (0)

	)

34 
	#GREMLIN_CONNECTION_FLOOD_MASK
 (0x07)

	)

36 
	#GREMLIN_PACKET_FLOOD_SHIFT
 (3)

	)

37 
	#GREMLIN_PACKET_FLOOD_MASK
 (0x03)

	)

39 
	#GREMLIN_CORRUPT_SHIFT
 (5)

	)

40 
	#GREMLIN_CORRUPT_MASK
 (0x03)

	)

42 
	#GREMLIN_UP_DOWN_SHIFT
 (7)

	)

43 
	#GREMLIN_UP_DOWN_MASK
 (0x03)

	)

47 
	#GREMLIN_DROP_SHIFT
 (9)

	)

48 
	#GREMLIN_DROP_MASK
 (0x03)

	)

52 
	#GREMLIN_CONNECTION_FLOOD_LEVEL
(
x
è(((x)>>
GREMLIN_CONNECTION_FLOOD_SHIFT
è& 
GREMLIN_CONNECTION_FLOOD_MASK
)

	)

53 
	#GREMLIN_PACKET_FLOOD_LEVEL
(
x
è(((x)>>
GREMLIN_PACKET_FLOOD_SHIFT
è& 
GREMLIN_PACKET_FLOOD_MASK
)

	)

54 
	#GREMLIN_CORRUPT_LEVEL
(
x
è(((x)>>
GREMLIN_CORRUPT_SHIFT
è& 
GREMLIN_CORRUPT_MASK
)

	)

55 
	#GREMLIN_UP_DOWN_LEVEL
(
x
è(((x)>>
GREMLIN_UP_DOWN_SHIFT
è& 
GREMLIN_UP_DOWN_MASK
)

	)

56 
	#GREMLIN_DROP_LEVEL
(
x
è(((x)>>
GREMLIN_DROP_SHIFT
è& 
GREMLIN_DROP_MASK
)

	)

58 
	~"bufãr.h
"

60 
	s·ck‘_æood_·rms


62 
	mn_·ck‘s
;

63 
	m·ck‘_size
;

66 
boŞ
 
ask_g»mlš
(
æags
);

68 
cÜru±_g»mlš
(
bufãr
 *
buf
, 
æags
);

70 
·ck‘_æood_·rms
 
g‘_·ck‘_æood_·rms
(
Ëv–
);

	@helper.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"fÜw¬d.h
"

33 
	~"h–³r.h
"

34 
	~"poŞ.h
"

35 
	~"push.h
"

37 
	~"memdbg.h
"

39 #ià
P2MP_SERVER


42 
	$´št_Ãtmask
(
Ãtb™s
, 
gc_¬’a
 *
gc
)

44 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

45 cÚ¡ 
š_addr_t
 
Ãtmask
 = 
	`Ãtb™s_to_Ãtmask
(
Ãtb™s
);

47 
	`buf_´štf
(&
out
, "% (/%d)", 
	`´št_š_addr_t
(
Ãtmask
, 0, 
gc
), 
Ãtb™s
);

49  
	`BSTR
(&
out
);

50 
	}
}

53 
	$´št_İt_rou‹_g©eway
(cÚ¡ 
š_addr_t
 
rou‹_g©eway
, 
gc_¬’a
 *
gc
)

55 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

56 
	`ASSERT
(
rou‹_g©eway
);

57 
	`buf_´štf
(&
out
, "rou‹-g©eway %s", 
	`´št_š_addr_t
(
rou‹_g©eway
, 0, 
gc
));

58  
	`BSTR
(&
out
);

59 
	}
}

62 
	$´št_İt_rou‹_g©eway_dhı
(
gc_¬’a
 *
gc
)

64 
bufãr
 
out
 = 
	`®loc_buf_gc
(32, 
gc
);

65 
	`buf_´štf
(&
out
, "route-gateway dhcp");

66  
	`BSTR
(&
out
);

67 
	}
}

70 
	$´št_İt_rou‹
(cÚ¡ 
š_addr_t
 
ÃtwÜk
, cÚ¡ in_addr_ˆ
Ãtmask
, 
gc_¬’a
 *
gc
)

72 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

73 
	`ASSERT
(
ÃtwÜk
);

75 ià(
Ãtmask
)

77 
	`buf_´štf
(&
out
, "route %s %s",

78 
	`´št_š_addr_t
(
ÃtwÜk
, 0, 
gc
),

79 
	`´št_š_addr_t
(
Ãtmask
, 0, 
gc
));

83 
	`buf_´štf
(&
out
, "route %s",

84 
	`´št_š_addr_t
(
ÃtwÜk
, 0, 
gc
));

87  
	`BSTR
(&
out
);

88 
	}
}

91 
	$´št_İt_tİŞogy
(cÚ¡ 
tİŞogy
, 
gc_¬’a
 *
gc
)

93 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

95 
	`buf_´štf
(&
out
, "tİŞogy %s", 
	`´št_tİŞogy
(
tİŞogy
));

97  
	`BSTR
(&
out
);

98 
	}
}

101 
	$´št_¡r_št
(cÚ¡ *
¡r
, cÚ¡ 
i
, 
gc_¬’a
 *
gc
)

103 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

104 
	`buf_´štf
(&
out
, "% %d", 
¡r
, 
i
);

105  
	`BSTR
(&
out
);

106 
	}
}

109 
	$´št_¡r
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
)

111 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

112 
	`buf_´štf
(&
out
, "%s", 
¡r
);

113  
	`BSTR
(&
out
);

114 
	}
}

117 
	$h–³r_add_rou‹
(cÚ¡ 
š_addr_t
 
ÃtwÜk
, cÚ¡ in_addr_ˆ
Ãtmask
, 
İtiÚs
 *
o
)

119 
	`rŞ_check_®loc
(
o
);

120 
	`add_rou‹_to_İtiÚ_li¡
(
o
->
rou‹s
,

121 
	`´št_š_addr_t
(
ÃtwÜk
, 0, &
o
->
gc
),

122 
	`´št_š_addr_t
(
Ãtmask
, 0, &
o
->
gc
),

123 
NULL
,

124 
NULL
);

125 
	}
}

128 
	$v”ify_commÚ_subÃt
(cÚ¡ *
İt
, cÚ¡ 
š_addr_t
 
a
, cÚ¡ in_addr_ˆ
b
, cÚ¡ in_addr_ˆ
subÃt
)

130 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

131 ià((
a
 & 
subÃt
è!ğ(
b
 & subnet))

133 
	`msg
(
M_USAGE
, "%s IP‡ddresses %s‡nd %s‡re‚ot inhe same %s subnet",

134 
İt
,

135 
	`´št_š_addr_t
(
a
, 0, &
gc
),

136 
	`´št_š_addr_t
(
b
, 0, &
gc
),

137 
	`´št_š_addr_t
(
subÃt
, 0, &
gc
));

139 
	`gc_ä“
(&
gc
);

140 
	}
}

150 
	$h–³r_ş›Á_£rv”
(
İtiÚs
 *
o
)

152 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

154 #ià
P2MP


155 #ià
P2MP_SERVER


160 cÚ¡ 
dev
 = 
	`dev_ty³_’um
(
o
->dev, o->
dev_ty³
);

161 cÚ¡ 
tİŞogy
 = 
o
->topology;

178 ià(
o
->
£rv”_v6_defšed
)

180 ià(!
o
->
£rv”_defšed
)

182 
	`msg
(
M_USAGE
, "--server-ipv6 must be usedogether with --server");

184 ià(
o
->
£rv”_æags
 & 
SF_NOPOOL
)

186 
	`msg
Ğ
M_USAGE
, "--server-ipv6 is incompatible with 'nopool' option" );

188 ià(
o
->
ifcÚfig_v6_poŞ_defšed
)

190 
	`msg
Ğ
M_USAGE
, "--server-ipv6‡lready defines‡n ifconfig-ipv6-pool, so you can't‡lso specify --ifconfig-poolƒxplicitly");

194 
o
->
ifcÚfig_v6_loÿl
 =

195 
	`´št_š6_addr
Ğ
	`add_š6_addr
Ğ
o
->
£rv”_ÃtwÜk_v6
, 1), 0, &o->
gc
 );

196 
o
->
ifcÚfig_v6_»mÙe
 =

197 
	`´št_š6_addr
Ğ
	`add_š6_addr
Ğ
o
->
£rv”_ÃtwÜk_v6
, 2), 0, &o->
gc
 );

198 
o
->
ifcÚfig_v6_Ãtb™s
 = o->
£rv”_Ãtb™s_v6
;

201 
	`ASSERT
Ğ
o
->
£rv”_Ãtb™s_v6
 <= 112 );

203 
o
->
ifcÚfig_v6_poŞ_defšed
 = 
Œue
;

204 
o
->
ifcÚfig_v6_poŞ_ba£
 =

205 
	`add_š6_addr
Ğ
o
->
£rv”_ÃtwÜk_v6
, 0x1000 );

206 
o
->
ifcÚfig_v6_poŞ_Ãtb™s
 = o->
£rv”_Ãtb™s_v6
;

208 
	`push_İtiÚ
Ğ
o
, "tun-v6", 
M_USAGE
 );

242 ià(
o
->
£rv”_defšed
)

244 
Ãtb™s
 = -2;

245 
boŞ
 
¡©us
 = 
çl£
;

247 ià(
o
->
ş›Á
)

249 
	`msg
(
M_USAGE
, "--server‡nd --client cannot be usedogether");

252 ià(
o
->
£rv”_bridge_defšed
 || o->
£rv”_bridge_´oxy_dhı
)

254 
	`msg
(
M_USAGE
, "--server‡nd --server-bridge cannot be usedogether");

257 ià(
o
->
sh¬ed_£ü‘_fe
)

259 
	`msg
(
M_USAGE
, "--server‡nd --secret cannot be usedogether (you must use SSL/TLS keys)");

262 ià(!(
o
->
£rv”_æags
 & 
SF_NOPOOL
è&& o->
ifcÚfig_poŞ_defšed
)

264 
	`msg
(
M_USAGE
, "--server‡lready defines‡n ifconfig-pool, so you can't‡lso specify --ifconfig-poolƒxplicitly");

267 ià(!(
dev
 =ğ
DEV_TYPE_TAP
 || dev =ğ
DEV_TYPE_TUN
))

269 
	`msg
(
M_USAGE
, "--server directive only makes sense with --devun or --devap");

272 
¡©us
 = 
	`Ãtmask_to_Ãtb™s
(
o
->
£rv”_ÃtwÜk
, o->
£rv”_Ãtmask
, &
Ãtb™s
);

273 ià(!
¡©us
)

275 
	`msg
(
M_USAGE
, "--server directive‚etwork/netmask combination is invalid");

278 ià(
Ãtb™s
 < 0)

280 
	`msg
(
M_USAGE
, "--server directive‚etmask is invalid");

283 ià(
Ãtb™s
 < 
IFCONFIG_POOL_MIN_NETBITS
)

285 
	`msg
(
M_USAGE
, "--server directive‚etmask‡llows foroo many host‡ddresses (subnet must be %s or higher)",

286 
	`´št_Ãtmask
(
IFCONFIG_POOL_MIN_NETBITS
, &
gc
));

289 ià(
dev
 =ğ
DEV_TYPE_TUN
)

291 
poŞ_’d_»£rve
 = 4;

293 ià(
Ãtb™s
 > 29)

295 
	`msg
(
M_USAGE
, "--server directive when used with --devun must define‡ subnet of %s or†ower",

296 
	`´št_Ãtmask
(29, &
gc
));

299 ià(
Ãtb™s
 == 29)

301 
poŞ_’d_»£rve
 = 0;

304 
o
->
mode
 = 
MODE_SERVER
;

305 
o
->
s_£rv”
 = 
Œue
;

307 ià(
tİŞogy
 =ğ
TOP_NET30
 ||İŞogy =ğ
TOP_P2P
)

309 
o
->
ifcÚfig_loÿl
 = 
	`´št_š_addr_t
(o->
£rv”_ÃtwÜk
 + 1, 0, &o->
gc
);

310 
o
->
ifcÚfig_»mÙe_Ãtmask
 = 
	`´št_š_addr_t
(o->
£rv”_ÃtwÜk
 + 2, 0, &o->
gc
);

312 ià(!(
o
->
£rv”_æags
 & 
SF_NOPOOL
))

314 
o
->
ifcÚfig_poŞ_defšed
 = 
Œue
;

315 
o
->
ifcÚfig_poŞ_¡¬t
 = o->
£rv”_ÃtwÜk
 + 4;

316 
o
->
ifcÚfig_poŞ_’d
 = (o->
£rv”_ÃtwÜk
 | ~o->
£rv”_Ãtmask
è- 
poŞ_’d_»£rve
;

317 
	`ifcÚfig_poŞ_v”ify_¿nge
(
M_USAGE
, 
o
->
ifcÚfig_poŞ_¡¬t
, o->
ifcÚfig_poŞ_’d
);

320 
	`h–³r_add_rou‹
(
o
->
£rv”_ÃtwÜk
, o->
£rv”_Ãtmask
, o);

321 ià(
o
->
’abË_c2c
)

323 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹
(o->
£rv”_ÃtwÜk
, o->
£rv”_Ãtmask
, &o->
gc
), 
M_USAGE
);

325 ià(
tİŞogy
 =ğ
TOP_NET30
)

327 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹
(o->
£rv”_ÃtwÜk
 + 1, 0, &o->
gc
), 
M_USAGE
);

330 ià(
tİŞogy
 =ğ
TOP_SUBNET
)

332 
o
->
ifcÚfig_loÿl
 = 
	`´št_š_addr_t
(o->
£rv”_ÃtwÜk
 + 1, 0, &o->
gc
);

333 
o
->
ifcÚfig_»mÙe_Ãtmask
 = 
	`´št_š_addr_t
(o->
£rv”_Ãtmask
, 0, &o->
gc
);

335 ià(!(
o
->
£rv”_æags
 & 
SF_NOPOOL
))

337 
o
->
ifcÚfig_poŞ_defšed
 = 
Œue
;

338 
o
->
ifcÚfig_poŞ_¡¬t
 = o->
£rv”_ÃtwÜk
 + 2;

339 
o
->
ifcÚfig_poŞ_’d
 = (o->
£rv”_ÃtwÜk
 | ~o->
£rv”_Ãtmask
) - 2;

340 
	`ifcÚfig_poŞ_v”ify_¿nge
(
M_USAGE
, 
o
->
ifcÚfig_poŞ_¡¬t
, o->
ifcÚfig_poŞ_’d
);

342 
o
->
ifcÚfig_poŞ_Ãtmask
 = o->
£rv”_Ãtmask
;

344 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹_g©eway
(o->
£rv”_ÃtwÜk
 + 1, &o->
gc
), 
M_USAGE
);

345 ià(!
o
->
rou‹_deçuÉ_g©eway
)

347 
o
->
rou‹_deçuÉ_g©eway
 = 
	`´št_š_addr_t
(o->
£rv”_ÃtwÜk
 + 2, 0, &o->
gc
);

352 
	`ASSERT
(0);

355 
	`push_İtiÚ
(
o
, 
	`´št_İt_tİŞogy
(
tİŞogy
, &o->
gc
), 
M_USAGE
);

357 ià(
dev
 =ğ
DEV_TYPE_TAP
)

359 ià(
Ãtb™s
 > 30)

361 
	`msg
(
M_USAGE
, "--server directive when used with --devap must define‡ subnet of %s or†ower",

362 
	`´št_Ãtmask
(30, &
gc
));

365 
o
->
mode
 = 
MODE_SERVER
;

366 
o
->
s_£rv”
 = 
Œue
;

367 
o
->
ifcÚfig_loÿl
 = 
	`´št_š_addr_t
(o->
£rv”_ÃtwÜk
 + 1, 0, &o->
gc
);

368 
o
->
ifcÚfig_»mÙe_Ãtmask
 = 
	`´št_š_addr_t
(o->
£rv”_Ãtmask
, 0, &o->
gc
);

370 ià(!(
o
->
£rv”_æags
 & 
SF_NOPOOL
))

372 
o
->
ifcÚfig_poŞ_defšed
 = 
Œue
;

373 
o
->
ifcÚfig_poŞ_¡¬t
 = o->
£rv”_ÃtwÜk
 + 2;

374 
o
->
ifcÚfig_poŞ_’d
 = (o->
£rv”_ÃtwÜk
 | ~o->
£rv”_Ãtmask
) - 1;

375 
	`ifcÚfig_poŞ_v”ify_¿nge
(
M_USAGE
, 
o
->
ifcÚfig_poŞ_¡¬t
, o->
ifcÚfig_poŞ_’d
);

377 
o
->
ifcÚfig_poŞ_Ãtmask
 = o->
£rv”_Ãtmask
;

379 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹_g©eway
(o->
£rv”_ÃtwÜk
 + 1, &o->
gc
), 
M_USAGE
);

383 
	`ASSERT
(0);

387 ià((
dev
 =ğ
DEV_TYPE_TAP
 || 
tİŞogy
 =ğ
TOP_SUBNET
))

389 
o
->
push_ifcÚfig_cÚ¡¿št_defšed
 = 
Œue
;

390 
o
->
push_ifcÚfig_cÚ¡¿št_ÃtwÜk
 = o->
£rv”_ÃtwÜk
;

391 
o
->
push_ifcÚfig_cÚ¡¿št_Ãtmask
 = o->
£rv”_Ãtmask
;

420 ià(
o
->
£rv”_bridge_defšed
 | o->
£rv”_bridge_´oxy_dhı
)

422 ià(
o
->
ş›Á
)

424 
	`msg
(
M_USAGE
, "--server-bridge‡nd --client cannot be usedogether");

427 ià(!(
o
->
£rv”_æags
 & 
SF_NOPOOL
è&& o->
ifcÚfig_poŞ_defšed
)

429 
	`msg
(
M_USAGE
, "--server-bridge‡lready defines‡n ifconfig-pool, so you can't‡lso specify --ifconfig-poolƒxplicitly");

432 ià(
o
->
sh¬ed_£ü‘_fe
)

434 
	`msg
(
M_USAGE
, "--server-bridge‡nd --secret cannot be usedogether (you must use SSL/TLS keys)");

437 ià(
dev
 !ğ
DEV_TYPE_TAP
)

439 
	`msg
(
M_USAGE
, "--server-bridge directive only makes sense with --devap");

442 ià(
o
->
£rv”_bridge_defšed
)

444 
	`v”ify_commÚ_subÃt
("--£rv”-bridge", 
o
->
£rv”_bridge_
, o->
£rv”_bridge_poŞ_¡¬t
, o->
£rv”_bridge_Ãtmask
);

445 
	`v”ify_commÚ_subÃt
("--£rv”-bridge", 
o
->
£rv”_bridge_poŞ_¡¬t
, o->
£rv”_bridge_poŞ_’d
, o->
£rv”_bridge_Ãtmask
);

446 
	`v”ify_commÚ_subÃt
("--£rv”-bridge", 
o
->
£rv”_bridge_
, o->
£rv”_bridge_poŞ_’d
, o->
£rv”_bridge_Ãtmask
);

449 
o
->
mode
 = 
MODE_SERVER
;

450 
o
->
s_£rv”
 = 
Œue
;

452 ià(
o
->
£rv”_bridge_defšed
)

454 
o
->
ifcÚfig_poŞ_defšed
 = 
Œue
;

455 
o
->
ifcÚfig_poŞ_¡¬t
 = o->
£rv”_bridge_poŞ_¡¬t
;

456 
o
->
ifcÚfig_poŞ_’d
 = o->
£rv”_bridge_poŞ_’d
;

457 
	`ifcÚfig_poŞ_v”ify_¿nge
(
M_USAGE
, 
o
->
ifcÚfig_poŞ_¡¬t
, o->
ifcÚfig_poŞ_’d
);

458 
o
->
ifcÚfig_poŞ_Ãtmask
 = o->
£rv”_bridge_Ãtmask
;

459 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹_g©eway
(o->
£rv”_bridge_
, &o->
gc
), 
M_USAGE
);

461 ià(
o
->
£rv”_bridge_´oxy_dhı
 && !(o->
£rv”_æags
 & 
SF_NO_PUSH_ROUTE_GATEWAY
))

463 
	`push_İtiÚ
(
o
, 
	`´št_İt_rou‹_g©eway_dhı
(&o->
gc
), 
M_USAGE
);

479 ià(
o
->
ş›Á
)

481 ià(
o
->
key_m‘hod
 != 2)

483 
	`msg
(
M_USAGE
, "--client„equires --key-method 2");

486 
o
->
puÎ
 = 
Œue
;

487 
o
->
s_ş›Á
 = 
Œue
;

492 
	`gc_ä“
(&
gc
);

493 
	}
}

513 
	$h–³r_k“·live
(
İtiÚs
 *
o
)

515 ià(
o
->
k“·live_pšg
 || o->
k“·live_timeout
)

520 ià(
o
->
k“·live_pšg
 <ğ0 || o->
k“·live_timeout
 <= 0)

522 
	`msg
(
M_USAGE
, "--keepalive…arameters must be > 0");

524 ià(
o
->
k“·live_pšg
 * 2 > o->
k“·live_timeout
)

526 
	`msg
(
M_USAGE
, "the second…arametero --keepalive (restartimeout=%d) must be‡t†eastwicehe value ofhe first…arameter (ping interval=%d). A„atio of 1:5 or 1:6 would beƒven better. Recommended setting is --keepalive 10 60.",

527 
o
->
k“·live_timeout
,

528 
o
->
k“·live_pšg
);

530 ià(
o
->
pšg_£nd_timeout
 || o->
pšg_»c_timeout
)

532 
	`msg
(
M_USAGE
, "--keepalive conflicts with --ping, --ping-exit, or --ping-restart. If you use --keepalive, you don't‚eed‡ny ofhe other --ping directives.");

538 ià(
o
->
mode
 =ğ
MODE_POINT_TO_POINT
)

540 
o
->
pšg_»c_timeout_aùiÚ
 = 
PING_RESTART
;

541 
o
->
pšg_£nd_timeout
 = o->
k“·live_pšg
;

542 
o
->
pšg_»c_timeout
 = o->
k“·live_timeout
;

544 #ià
P2MP_SERVER


545 ià(
o
->
mode
 =ğ
MODE_SERVER
)

547 
o
->
pšg_»c_timeout_aùiÚ
 = 
PING_RESTART
;

548 
o
->
pšg_£nd_timeout
 = o->
k“·live_pšg
;

549 
o
->
pšg_»c_timeout
 = o->
k“·live_timeout
 * 2;

550 
	`push_İtiÚ
(
o
, 
	`´št_¡r_št
("pšg", o->
k“·live_pšg
, &o->
gc
), 
M_USAGE
);

551 
	`push_İtiÚ
(
o
, 
	`´št_¡r_št
("pšg-»¡¬t", o->
k“·live_timeout
, &o->
gc
), 
M_USAGE
);

556 
	`ASSERT
(0);

559 
	}
}

574 
	$h–³r_tı_nod–ay
(
İtiÚs
 *
o
)

576 #ià
P2MP_SERVER


577 ià(
o
->
£rv”_æags
 & 
SF_TCP_NODELAY_HELPER
)

579 ià(
o
->
mode
 =ğ
MODE_SERVER
)

581 
o
->
sockæags
 |ğ
SF_TCP_NODELAY
;

582 
	`push_İtiÚ
(
o
, 
	`´št_¡r
("sock‘-æag TCP_NODELAY", &o->
gc
), 
M_USAGE
);

586 
o
->
sockæags
 |ğ
SF_TCP_NODELAY
;

590 
	}
}

	@helper.h

28 #iâdeà
HELPER_H


29 
	#HELPER_H


	)

31 
	~"İtiÚs.h
"

33 
h–³r_k“·live
(
İtiÚs
 *
o
);

35 
h–³r_ş›Á_£rv”
(
İtiÚs
 *
o
);

37 
h–³r_tı_nod–ay
(
İtiÚs
 *
o
);

	@httpdigest.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
PROXY_DIGEST_AUTH


34 
	~"üy±o.h
"

35 
	~"h‰pdige¡.h
"

38 
	$CvtHex
(

39 
IN
 
HASH
 
Bš
,

40 
OUT
 
HASHHEX
 
Hex


43 
i
;

44 
j
;

46 
i
 = 0; i < 
HASHLEN
; i++)

48 
j
 = (
Bš
[
i
] >> 4) & 0xf;

49 ià(
j
 <= 9)

51 
Hex
[
i
*2] = (
j
 + '0');

55 
Hex
[
i
*2] = (
j
 + 'a' - 10);

57 
j
 = 
Bš
[
i
] & 0xf;

58 ià(
j
 <= 9)

60 
Hex
[
i
*2+1] = (
j
 + '0');

64 
Hex
[
i
*2+1] = (
j
 + 'a' - 10);

67 
Hex
[
HASHHEXLEN
] = '\0';

68 
	}
}

72 
	$Dige¡C®cHA1
(

73 
IN
 *
pszAlg
,

74 
IN
 *
pszU£rName
,

75 
IN
 *
pszR—lm
,

76 
IN
 *
pszPasswÜd
,

77 
IN
 *
pszNÚû
,

78 
IN
 *
pszCNÚû
,

79 
OUT
 
HASHHEX
 
SessiÚKey


82 
HASH
 
HA1
;

83 
md_ùx_t
 *
md5_ùx
 = 
	`md_ùx_Ãw
();

84 cÚ¡ 
md_kt_t
 *
md5_kt
 = 
	`md_kt_g‘
("MD5");

86 
	`md_ùx_š™
(
md5_ùx
, 
md5_kt
);

87 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszU£rName
, 
	`¡¾’
(pszUserName));

88 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

89 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszR—lm
, 
	`¡¾’
(pszRealm));

90 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

91 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszPasswÜd
, 
	`¡¾’
(pszPassword));

92 
	`md_ùx_fš®
(
md5_ùx
, 
HA1
);

93 ià(
pszAlg
 && 
	`¡rÿ£cmp
(pszAlg, "md5-sess") == 0)

95 
	`md_ùx_š™
(
md5_ùx
, 
md5_kt
);

96 
	`md_ùx_upd©e
(
md5_ùx
, 
HA1
, 
HASHLEN
);

97 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

98 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszNÚû
, 
	`¡¾’
(pszNonce));

99 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

100 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszCNÚû
, 
	`¡¾’
(pszCNonce));

101 
	`md_ùx_fš®
(
md5_ùx
, 
HA1
);

103 
	`md_ùx_ş—nup
(
md5_ùx
);

104 
	`md_ùx_ä“
(
md5_ùx
);

105 
	`CvtHex
(
HA1
, 
SessiÚKey
);

106 
	}
}

110 
	$Dige¡C®cRe¥Ú£
(

111 
IN
 
HASHHEX
 
HA1
,

112 
IN
 *
pszNÚû
,

113 
IN
 *
pszNÚûCouÁ
,

114 
IN
 *
pszCNÚû
,

115 
IN
 *
pszQİ
,

116 
IN
 *
pszM‘hod
,

117 
IN
 *
pszDige¡Uri
,

118 
IN
 
HASHHEX
 
HEÁ™y
,

119 
OUT
 
HASHHEX
 
Re¥Ú£


122 
HASH
 
HA2
;

123 
HASH
 
Re¥Hash
;

124 
HASHHEX
 
HA2Hex
;

126 
md_ùx_t
 *
md5_ùx
 = 
	`md_ùx_Ãw
();

127 cÚ¡ 
md_kt_t
 *
md5_kt
 = 
	`md_kt_g‘
("MD5");

130 
	`md_ùx_š™
(
md5_ùx
, 
md5_kt
);

131 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszM‘hod
, 
	`¡¾’
(pszMethod));

132 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

133 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszDige¡Uri
, 
	`¡¾’
(pszDigestUri));

134 ià(
	`¡rÿ£cmp
(
pszQİ
, "auth-int") == 0)

136 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

137 
	`md_ùx_upd©e
(
md5_ùx
, 
HEÁ™y
, 
HASHHEXLEN
);

139 
	`md_ùx_fš®
(
md5_ùx
, 
HA2
);

140 
	`CvtHex
(
HA2
, 
HA2Hex
);

143 
	`md_ùx_š™
(
md5_ùx
, 
md5_kt
);

144 
	`md_ùx_upd©e
(
md5_ùx
, 
HA1
, 
HASHHEXLEN
);

145 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

146 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszNÚû
, 
	`¡¾’
(pszNonce));

147 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

148 ià(*
pszQİ
)

150 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszNÚûCouÁ
, 
	`¡¾’
(pszNonceCount));

151 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

152 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszCNÚû
, 
	`¡¾’
(pszCNonce));

153 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

154 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *è
pszQİ
, 
	`¡¾’
(pszQop));

155 
	`md_ùx_upd©e
(
md5_ùx
, (cÚ¡ 
ušt8_t
 *) ":", 1);

157 
	`md_ùx_upd©e
(
md5_ùx
, 
HA2Hex
, 
HASHHEXLEN
);

158 
	`md_ùx_fš®
(
md5_ùx
, 
Re¥Hash
);

159 
	`md_ùx_ş—nup
(
md5_ùx
);

160 
	`md_ùx_ä“
(
md5_ùx
);

161 
	`CvtHex
(
Re¥Hash
, 
Re¥Ú£
);

162 
	}
}

	@httpdigest.h

24 #ià
PROXY_DIGEST_AUTH


26 
	#HASHLEN
 16

	)

27 
	tHASH
[
HASHLEN
];

28 
	#HASHHEXLEN
 32

	)

29 
	tHASHHEX
[
HASHHEXLEN
+1];

30 #undeà
IN


31 #undeà
OUT


32 
	#IN
 cÚ¡

	)

33 
	#OUT


	)

36 
Dige¡C®cHA1
(

37 
IN
 *
pszAlg
,

38 
IN
 *
pszU£rName
,

39 
IN
 *
pszR—lm
,

40 
IN
 *
pszPasswÜd
,

41 
IN
 *
pszNÚû
,

42 
IN
 *
pszCNÚû
,

43 
OUT
 
HASHHEX
 
SessiÚKey


47 
Dige¡C®cRe¥Ú£
(

48 
IN
 
HASHHEX
 
HA1
,

49 
IN
 *
pszNÚû
,

50 
IN
 *
pszNÚûCouÁ
,

51 
IN
 *
pszCNÚû
,

52 
IN
 *
pszQİ
,

53 
IN
 *
pszM‘hod
,

54 
IN
 *
pszDige¡Uri
,

55 
IN
 
HASHHEX
 
HEÁ™y
,

56 
OUT
 
HASHHEX
 
Re¥Ú£


	@init.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
ENABLE_SYSTEMD


33 
	~<sy¡emd/sd-d«mÚ.h
>

36 
	~"wš32.h
"

37 
	~"š™.h
"

38 
	~"sig.h
"

39 
	~"occ.h
"

40 
	~"li¡.h
"

41 
	~"Ùime.h
"

42 
	~"poŞ.h
"

43 
	~"g»mlš.h
"

44 
	~"pkcs11.h
"

45 
	~"ps.h
"

46 
	~"Îaddr.h
"

47 
	~"pšg.h
"

48 
	~"m¡©s.h
"

49 
	~"s¦_v”ify.h
"

50 
	~"s_üy±.h
"

51 
	~"fÜw¬d-šlše.h
"

53 
	~"memdbg.h
"

55 
	~"occ-šlše.h
"

57 
cÚ‹xt
 *
	g¡©ic_cÚ‹xt
;

62 
	#CF_LOAD_PERSISTED_PACKET_ID
 (1<<0)

	)

63 
	#CF_INIT_TLS_MULTI
 (1<<1)

	)

64 
	#CF_INIT_TLS_AUTH_STANDALONE
 (1<<2)

	)

66 
do_š™_fœ¡_time
(
cÚ‹xt
 *
c
);

69 
	$cÚ‹xt_ş—r
(
cÚ‹xt
 *
c
)

71 
	`CLEAR
(*
c
);

72 
	}
}

75 
	$cÚ‹xt_ş—r_1
(
cÚ‹xt
 *
c
)

77 
	`CLEAR
(
c
->
c1
);

78 
	}
}

81 
	$cÚ‹xt_ş—r_2
(
cÚ‹xt
 *
c
)

83 
	`CLEAR
(
c
->
c2
);

84 
	}
}

87 
	$cÚ‹xt_ş—r_®l_exû±_fœ¡_time
(
cÚ‹xt
 *
c
)

89 cÚ¡ 
boŞ
 
fœ¡_time_§ve
 = 
c
->
fœ¡_time
;

90 cÚ¡ 
cÚ‹xt_³rsi¡
 
ı§ve
 = 
c
->
³rsi¡
;

91 
	`cÚ‹xt_ş—r
(
c
);

92 
c
->
fœ¡_time
 = 
fœ¡_time_§ve
;

93 
c
->
³rsi¡
 = 
ı§ve
;

94 
	}
}

101 
run_up_down
(cÚ¡ *
commªd
,

102 cÚ¡ 
¶ugš_li¡
 *
¶ugšs
,

103 
¶ugš_ty³
,

104 cÚ¡ *
¬g
,

105 #ifdeà
_WIN32


106 
DWORD
 
ad­‹r_šdex
,

108 cÚ¡ *
dev_ty³
,

109 
tun_mtu
,

110 
lšk_mtu
,

111 cÚ¡ *
ifcÚfig_loÿl
,

112 cÚ¡ *
ifcÚfig_»mÙe
,

113 cÚ¡ *
cÚ‹xt
,

114 cÚ¡ *
sigÇl_‹xt
,

115 cÚ¡ *
süt_ty³
,

116 
’v_£t
 *
es
)

118 
gc_¬’a
 
	ggc
 = 
gc_Ãw
();

120 ià(
	gsigÇl_‹xt
)

122 
£‹nv_¡r
(
es
, "sigÇl", 
sigÇl_‹xt
);

124 
£‹nv_¡r
(
es
, "süt_cÚ‹xt", 
cÚ‹xt
);

125 
£‹nv_št
(
es
, "tun_mtu", 
tun_mtu
);

126 
£‹nv_št
(
es
, "lšk_mtu", 
lšk_mtu
);

127 
£‹nv_¡r
(
es
, "dev", 
¬g
);

128 ià(
	gdev_ty³
)

130 
£‹nv_¡r
(
es
, "dev_ty³", 
dev_ty³
);

132 #ifdeà
_WIN32


133 
£‹nv_št
(
es
, "dev_idx", 
ad­‹r_šdex
);

136 ià(!
	gifcÚfig_loÿl
)

138 
	gifcÚfig_loÿl
 = "";

140 ià(!
	gifcÚfig_»mÙe
)

142 
	gifcÚfig_»mÙe
 = "";

144 ià(!
	gcÚ‹xt
)

146 
	gcÚ‹xt
 = "";

149 ià(
¶ugš_defšed
(
¶ugšs
, 
¶ugš_ty³
))

151 
¬gv
 
	g¬gv
 = 
¬gv_Ãw
();

152 
ASSERT
(
¬g
);

153 
¬gv_´štf
(&
¬gv
,

155 
¬g
,

156 
tun_mtu
, 
lšk_mtu
,

157 
ifcÚfig_loÿl
, 
ifcÚfig_»mÙe
,

158 
cÚ‹xt
);

160 ià(
¶ugš_ÿÎ
(
¶ugšs
, 
¶ugš_ty³
, &
¬gv
, 
NULL
, 
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

162 
msg
(
M_FATAL
, "ERROR: up/down…lugin call failed");

165 
¬gv_»£t
(&
¬gv
);

168 ià(
	gcommªd
)

170 
¬gv
 
	g¬gv
 = 
¬gv_Ãw
();

171 
ASSERT
(
¬g
);

172 
£‹nv_¡r
(
es
, "süt_ty³", 
süt_ty³
);

173 
¬gv_·r£_cmd
(&
¬gv
, 
commªd
);

174 
¬gv_´štf_ÿt
(&
¬gv
, "% %d %d % % %s", 
¬g
, 
tun_mtu
, 
lšk_mtu
,

175 
ifcÚfig_loÿl
, 
ifcÚfig_»mÙe
, 
cÚ‹xt
);

176 
¬gv_msg
(
M_INFO
, &
¬gv
);

177 
İ’v²_run_süt
(&
¬gv
, 
es
, 
S_FATAL
, "--up/--down");

178 
¬gv_»£t
(&
¬gv
);

181 
gc_ä“
(&
gc
);

189 
	$upd©e_İtiÚs_û_po¡
(
İtiÚs
 *options)

191 #ià
P2MP


198 ià(
İtiÚs
->
puÎ


199 && 
İtiÚs
->
pšg_»c_timeout_aùiÚ
 =ğ
PING_UNDEF


200 && 
	`´Ùo_is_dg¿m
(
İtiÚs
->
û
.
´Ùo
))

202 
İtiÚs
->
pšg_»c_timeout
 = 
PRE_PULL_INITIAL_PING_RESTART
;

203 
İtiÚs
->
pšg_»c_timeout_aùiÚ
 = 
PING_RESTART
;

206 
	}
}

208 #ifdeà
ENABLE_MANAGEMENT


209 
boŞ


210 
	$mªagem’t_ÿÎback_´oxy_cmd
(*
¬g
, cÚ¡ **
p
)

212 
cÚ‹xt
 *
c
 = 
¬g
;

213 
cÚÃùiÚ_’Œy
 *
û
 = &
c
->
İtiÚs
.ce;

214 
gc_¬’a
 *
gc
 = &
c
->
c2
.gc;

215 
boŞ
 
»t
 = 
çl£
;

217 
	`upd©e_time
();

218 ià(
	`¡»q
(
p
[1], "NONE"))

220 
»t
 = 
Œue
;

222 ià(
p
[2] &&…[3])

224 ià(
	`¡»q
(
p
[1], "HTTP"))

226 
h‰p_´oxy_İtiÚs
 *
ho
;

227 ià(
û
->
´Ùo
 !ğ
PROTO_TCP
 && ce->´ÙØ!ğ
PROTO_TCP_CLIENT
)

229 
	`msg
(
M_WARN
, "HTTP…roxy support only works for TCP based connections");

230  
çl£
;

232 
ho
 = 
	`š™_h‰p_´oxy_İtiÚs_Úû
(&
û
->
h‰p_´oxy_İtiÚs
, 
gc
);

233 
ho
->
£rv”
 = 
	`¡ršg_®loc
(
p
[2], 
gc
);

234 
ho
->
pÜt
 = 
	`¡ršg_®loc
(
p
[3], 
gc
);

235 
ho
->
auth_»Œy
 = (
p
[4] && 
	`¡»q
Õ[4], "nù"è? 
PAR_NCT
 : 
PAR_ALL
);

236 
»t
 = 
Œue
;

238 ià(
	`¡»q
(
p
[1], "SOCKS"))

240 
û
->
socks_´oxy_£rv”
 = 
	`¡ršg_®loc
(
p
[2], 
gc
);

241 
û
->
socks_´oxy_pÜt
 = 
	`¡ršg_®loc
(
p
[3], 
gc
);

242 
»t
 = 
Œue
;

247 
	`msg
(
M_WARN
, "Bad…roxy command");

250 
û
->
æags
 &ğ~
CE_MAN_QUERY_PROXY
;

252  
»t
;

253 
	}
}

255 
boŞ


256 
	$û_mªagem’t_qu”y_´oxy
(
cÚ‹xt
 *
c
)

258 cÚ¡ 
cÚÃùiÚ_li¡
 *
l
 = 
c
->
İtiÚs
.connection_list;

259 
cÚÃùiÚ_’Œy
 *
û
 = &
c
->
İtiÚs
.ce;

260 
gc_¬’a
 
gc
;

261 
boŞ
 
»t
 = 
Œue
;

263 
	`upd©e_time
();

264 ià(
mªagem’t
)

266 
gc
 = 
	`gc_Ãw
();

268 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

269 
	`buf_´štf
(&
out
, ">PROXY:%u,%s,%s", (
l
 ?†->
cu¼’t
 : 0) + 1,

270 (
	`´Ùo_is_udp
(
û
->
´Ùo
è? "UDP" : "TCP"), 
	`Å
(û->
»mÙe
));

271 
	`mªagem’t_nÙify_g’”ic
(
mªagem’t
, 
	`BSTR
(&
out
));

273 
û
->
æags
 |ğ
CE_MAN_QUERY_PROXY
;

274 
û
->
æags
 & 
CE_MAN_QUERY_PROXY
)

276 
	`mªagem’t_ev’t_loİ_n_£cÚds
(
mªagem’t
, 1);

277 ià(
	`IS_SIG
(
c
))

279 
»t
 = 
çl£
;

283 
	`gc_ä“
(&
gc
);

286  
»t
;

287 
	}
}

290 
boŞ


291 
	$mªagem’t_ÿÎback_»mÙe_cmd
(*
¬g
, cÚ¡ **
p
)

293 
cÚ‹xt
 *
c
 = (cÚ‹xˆ*è
¬g
;

294 
cÚÃùiÚ_’Œy
 *
û
 = &
c
->
İtiÚs
.ce;

295 
»t
 = 
çl£
;

296 ià(
p
[1] && ((
û
->
æags
>>
CE_MAN_QUERY_REMOTE_SHIFT
)&
CE_MAN_QUERY_REMOTE_MASK
è=ğ
CE_MAN_QUERY_REMOTE_QUERY
)

298 
æags
 = 0;

299 ià(!
	`¡rcmp
(
p
[1], "ACCEPT"))

301 
æags
 = 
CE_MAN_QUERY_REMOTE_ACCEPT
;

302 
»t
 = 
Œue
;

304 ià(!
	`¡rcmp
(
p
[1], "SKIP"))

306 
æags
 = 
CE_MAN_QUERY_REMOTE_SKIP
;

307 
»t
 = 
Œue
;

309 ià(!
	`¡rcmp
(
p
[1], "MOD") &&…[2] &&…[3])

311 ià(
	`¡¾’
(
p
[2]è< 
RH_HOST_LEN
 && sŒËnÕ[3]è< 
RH_PORT_LEN
)

313 
»mÙe_ho¡_¡Üe
 *
rhs
 = 
c
->
İtiÚs
.
rh_¡Üe
;

314 ià(!
rhs
)

316 
	`ALLOC_OBJ_CLEAR_GC
(
rhs
, 
»mÙe_ho¡_¡Üe
, &
c
->
İtiÚs
.
gc
);

317 
c
->
İtiÚs
.
rh_¡Üe
 = 
rhs
;

319 
	`¡ºıyÁ
(
rhs
->
ho¡
, 
p
[2], 
RH_HOST_LEN
);

320 
	`¡ºıyÁ
(
rhs
->
pÜt
, 
p
[3], 
RH_PORT_LEN
);

322 
û
->
»mÙe
 = 
rhs
->
ho¡
;

323 
û
->
»mÙe_pÜt
 = 
rhs
->
pÜt
;

324 
æags
 = 
CE_MAN_QUERY_REMOTE_MOD
;

325 
»t
 = 
Œue
;

328 ià(
»t
)

330 
û
->
æags
 &ğ~(
CE_MAN_QUERY_REMOTE_MASK
<<
CE_MAN_QUERY_REMOTE_SHIFT
);

331 
û
->
æags
 |ğ((æags&
CE_MAN_QUERY_REMOTE_MASK
)<<
CE_MAN_QUERY_REMOTE_SHIFT
);

334  
»t
;

335 
	}
}

337 
boŞ


338 
	$û_mªagem’t_qu”y_»mÙe
(
cÚ‹xt
 *
c
)

340 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

341 vŞ©
cÚÃùiÚ_’Œy
 *
û
 = &
c
->
İtiÚs
.ce;

342 
û_chªged
 = 
Œue
;

344 
	`upd©e_time
();

345 ià(
mªagem’t
)

347 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

349 
	`buf_´štf
(&
out
, ">REMOTE:%s,%s,%s", 
	`Å
(
û
->
»mÙe
), ce->
»mÙe_pÜt
,

350 
	`´Ùo2ascii
(
û
->
´Ùo
, ce->
af
, 
çl£
));

351 
	`mªagem’t_nÙify_g’”ic
(
mªagem’t
, 
	`BSTR
(&
out
));

353 
û
->
æags
 &ğ~(
CE_MAN_QUERY_REMOTE_MASK
 << 
CE_MAN_QUERY_REMOTE_SHIFT
);

354 
û
->
æags
 |ğ(
CE_MAN_QUERY_REMOTE_QUERY
 << 
CE_MAN_QUERY_REMOTE_SHIFT
);

355 ((
û
->
æags
 >> 
CE_MAN_QUERY_REMOTE_SHIFT
)

356 & 
CE_MAN_QUERY_REMOTE_MASK
è=ğ
CE_MAN_QUERY_REMOTE_QUERY
)

358 
	`mªagem’t_ev’t_loİ_n_£cÚds
(
mªagem’t
, 1);

359 ià(
	`IS_SIG
(
c
))

361 
û_chªged
 = 
çl£
;

366 
	`gc_ä“
(&
gc
);

368 ià(
û_chªged
)

373 cÚ¡ 
æags
 = ((
û
->æag >> 
CE_MAN_QUERY_REMOTE_SHIFT
)

374 & 
CE_MAN_QUERY_REMOTE_MASK
);

375 
û_chªged
 = (
æags
 !ğ
CE_MAN_QUERY_REMOTE_SKIP
);

377  
û_chªged
;

378 
	}
}

385 
	$š™_cÚÃùiÚ_li¡
(
cÚ‹xt
 *
c
)

387 
cÚÃùiÚ_li¡
 *
l
 = 
c
->
İtiÚs
.connection_list;

389 
l
->
cu¼’t
 = -1;

390 ià(
c
->
İtiÚs
.
»mÙe_¿ndom
)

392 
i
;

393 
i
 = 0; i < 
l
->
Ën
; ++i)

395 cÚ¡ 
j
 = 
	`g‘_¿ndom
(è% 
l
->
Ën
;

396 ià(
i
 !ğ
j
)

398 
cÚÃùiÚ_’Œy
 *
tmp
;

399 
tmp
 = 
l
->
¬¿y
[
i
];

400 
l
->
¬¿y
[
i
] =†->¬¿y[
j
];

401 
l
->
¬¿y
[
j
] = 
tmp
;

405 
	}
}

411 
	$ş—r_»mÙe_add¾i¡
(
lšk_sock‘_addr
 *
l§
, 
boŞ
 
ä“
)

413 ià(
l§
->
»mÙe_li¡
 && 
ä“
)

415 
	`ä“addršfo
(
l§
->
»mÙe_li¡
);

417 
l§
->
»mÙe_li¡
 = 
NULL
;

418 
l§
->
cu¼’t_»mÙe
 = 
NULL
;

419 
	}
}

425 
	$Ãxt_cÚÃùiÚ_’Œy
(
cÚ‹xt
 *
c
)

427 
cÚÃùiÚ_li¡
 *
l
 = 
c
->
İtiÚs
.connection_list;

428 
boŞ
 
û_defšed
;

429 
cÚÃùiÚ_’Œy
 *
û
;

430 
n_cyşes
 = 0;

434 
û_defšed
 = 
Œue
;

435 ià(
c
->
İtiÚs
.
no_advªû
 && 
l
->
cu¼’t
 >= 0)

437 
c
->
İtiÚs
.
no_advªû
 = 
çl£
;

443 ià(
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe


444 && 
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
->
ai_Ãxt
)

446 
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
 =

447 
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
->
ai_Ãxt
;

455 ià(!
c
->
İtiÚs
.
³rsi¡_»mÙe_
)

458 
	`ASSERT
(
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
 =ğ
NULL
);

459 
	`ASSERT
(
c
->
c1
.
lšk_sock‘_addr
.
»mÙe_li¡
 =ğ
NULL
);

463 
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
 =

464 
c
->
c1
.
lšk_sock‘_addr
.
»mÙe_li¡
;

473 
c
->
İtiÚs
.
unsucûssful_©‹m±s
++;

475 ià(++
l
->
cu¼’t
 >ğl->
Ën
)

478 
l
->
cu¼’t
 = 0;

479 ià(++
n_cyşes
 >= 2)

481 
	`msg
(
M_FATAL
, "No usable connection…rofiles‡re…resent");

487 
û
 = 
l
->
¬¿y
[l->
cu¼’t
];

489 ià(
û
->
æags
 & 
CE_DISABLED
)

491 
û_defšed
 = 
çl£
;

494 
c
->
İtiÚs
.
û
 = *ce;

495 #ifdeà
ENABLE_MANAGEMENT


496 ià(
û_defšed
 && 
mªagem’t
 && 
	`mªagem’t_qu”y_»mÙe_’abËd
(management))

499 
û_defšed
 = 
	`û_mªagem’t_qu”y_»mÙe
(
c
);

500 ià(
	`IS_SIG
(
c
))

505 ià(
û_defšed
 && 
mªagem’t
 && 
	`mªagem’t_qu”y_´oxy_’abËd
(management))

507 
û_defšed
 = 
	`û_mªagem’t_qu”y_´oxy
(
c
);

508 ià(
	`IS_SIG
(
c
))

514 } !
û_defšed
);

517 ià(
c
->
İtiÚs
.
cÚÃù_»Œy_max
 > 0

518 && 
c
->
İtiÚs
.
unsucûssful_©‹m±s
 > (
l
->
Ën
 * c->İtiÚs.
cÚÃù_»Œy_max
))

520 
	`msg
(
M_FATAL
, "All connections have been connect-retry-max (%d)imes unsuccessful,ƒxiting",

521 
c
->
İtiÚs
.
cÚÃù_»Œy_max
);

523 
	`upd©e_İtiÚs_û_po¡
(&
c
->
İtiÚs
);

524 
	}
}

530 
	$š™_qu”y_·sswÜds
(cÚ¡ 
cÚ‹xt
 *
c
)

532 #ifdeà
ENABLE_CRYPTO


534 ià(
c
->
İtiÚs
.
key_·ss_fe
)

536 
	`³m_·sswÜd_£tup
(
c
->
İtiÚs
.
key_·ss_fe
);

540 #ià
P2MP


542 ià(
c
->
İtiÚs
.
auth_u£r_·ss_fe
)

544 #ifdeà
ENABLE_CLIENT_CR


545 
	`auth_u£r_·ss_£tup
(
c
->
İtiÚs
.
auth_u£r_·ss_fe
, &c->İtiÚs.
sc_šfo
);

547 
	`auth_u£r_·ss_£tup
(
c
->
İtiÚs
.
auth_u£r_·ss_fe
, 
NULL
);

551 
	}
}

558 
	$unš™_´oxy_dowÜk
(
cÚ‹xt
 *
c
)

560 ià(
c
->
c1
.
h‰p_´oxy_owÃd
 && c->c1.
h‰p_´oxy
)

562 
	`h‰p_´oxy_şo£
(
c
->
c1
.
h‰p_´oxy
);

563 
c
->
c1
.
h‰p_´oxy
 = 
NULL
;

564 
c
->
c1
.
h‰p_´oxy_owÃd
 = 
çl£
;

566 ià(
c
->
c1
.
socks_´oxy_owÃd
 && c->c1.
socks_´oxy
)

568 
	`socks_´oxy_şo£
(
c
->
c1
.
socks_´oxy
);

569 
c
->
c1
.
socks_´oxy
 = 
NULL
;

570 
c
->
c1
.
socks_´oxy_owÃd
 = 
çl£
;

572 
	}
}

575 
	$š™_´oxy_dowÜk
(
cÚ‹xt
 *
c
)

577 
boŞ
 
did_h‰p
 = 
çl£
;

579 
	`unš™_´oxy_dowÜk
(
c
);

581 ià(
c
->
İtiÚs
.
û
.
h‰p_´oxy_İtiÚs
)

584 
c
->
c1
.
h‰p_´oxy
 = 
	`h‰p_´oxy_Ãw
(c->
İtiÚs
.
û
.
h‰p_´oxy_İtiÚs
);

585 ià(
c
->
c1
.
h‰p_´oxy
)

587 
did_h‰p
 = 
Œue
;

588 
c
->
c1
.
h‰p_´oxy_owÃd
 = 
Œue
;

592 ià(!
did_h‰p
 && 
c
->
İtiÚs
.
û
.
socks_´oxy_£rv”
)

594 
c
->
c1
.
socks_´oxy
 = 
	`socks_´oxy_Ãw
(c->
İtiÚs
.
û
.
socks_´oxy_£rv”
,

595 
c
->
İtiÚs
.
û
.
socks_´oxy_pÜt
,

596 
c
->
İtiÚs
.
û
.
socks_´oxy_authfe
);

597 ià(
c
->
c1
.
socks_´oxy
)

599 
c
->
c1
.
socks_´oxy_owÃd
 = 
Œue
;

602 
	}
}

605 
	$š™_´oxy
(
cÚ‹xt
 *
c
)

607 
	`š™_´oxy_dowÜk
(
c
);

608 
	}
}

611 
	$unš™_´oxy
(
cÚ‹xt
 *
c
)

613 
	`unš™_´oxy_dowÜk
(
c
);

614 
	}
}

621 
	$§ve_nı_İtiÚs
(
cÚ‹xt
 *
c
)

623 #ifdeà
ENABLE_CRYPTO


624 
c
->
c1
.
ch”Çme
 = c->
İtiÚs
.ciphername;

625 
c
->
c1
.
authÇme
 = c->
İtiÚs
.authname;

626 
c
->
c1
.
keysize
 = c->
İtiÚs
.keysize;

628 
	}
}

632 
	$»¡Üe_nı_İtiÚs
(
cÚ‹xt
 *
c
)

634 #ifdeà
ENABLE_CRYPTO


635 
c
->
İtiÚs
.
ch”Çme
 = c->
c1
.ciphername;

636 
c
->
İtiÚs
.
authÇme
 = c->
c1
.authname;

637 
c
->
İtiÚs
.
keysize
 = c->
c1
.keysize;

639 
	}
}

642 
	$cÚ‹xt_š™_1
(
cÚ‹xt
 *
c
)

644 
	`cÚ‹xt_ş—r_1
(
c
);

646 
	`·ck‘_id_³rsi¡_š™
(&
c
->
c1
.
pid_³rsi¡
);

648 
	`š™_cÚÃùiÚ_li¡
(
c
);

650 
	`§ve_nı_İtiÚs
(
c
);

652 #ià
	`defšed
(
ENABLE_PKCS11
)

653 ià(
c
->
fœ¡_time
)

655 
i
;

656 
	`pkcs11_š™Ÿlize
(
Œue
, 
c
->
İtiÚs
.
pkcs11_pš_ÿche_³riod
);

657 
i
 = 0; i<
MAX_PARMS
 && 
c
->
İtiÚs
.
pkcs11_´ovid”s
[i] !ğ
NULL
; i++)

659 
	`pkcs11_addProvid”
(
c
->
İtiÚs
.
pkcs11_´ovid”s
[
i
], c->İtiÚs.
pkcs11_´Ùeùed_auth’tiÿtiÚ
[i],

660 
c
->
İtiÚs
.
pkcs11_´iv©e_mode
[
i
], c->İtiÚs.
pkcs11_û¹_´iv©e
[i]);

670 
u£r_·ss
 
up
;

671 
	`CLEAR
(
up
);

672 
	`¡rıy
(
up
.
u£ºame
, "Please insert your cryptographicoken");

673 
	`g‘_u£r_·ss
(&
up
, 
NULL
, "tok’-š£¹iÚ-»que¡", 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_OK
);

674 
	`msg
(
M_INFO
, "RET:%s", 
up
.
·sswÜd
);

679 #ifdeà
ENABLE_SYSTEMD


684 
	`sd_nÙifyf
(0, "READY=1\nSTATUS=Pre-connection initialization successful\nMAINPID=%lu",

685 (è
	`g‘pid
());

688 
	}
}

691 
	$cÚ‹xt_gc_ä“
(
cÚ‹xt
 *
c
)

693 
	`gc_ä“
(&
c
->
c2
.
gc
);

694 
	`gc_ä“
(&
c
->
İtiÚs
.
gc
);

695 
	`gc_ä“
(&
c
->
gc
);

696 
	}
}

698 #ià
PORT_SHARE


701 
	$şo£_pÜt_sh¬e
()

703 ià(
pÜt_sh¬e
)

705 
	`pÜt_sh¬e_şo£
(
pÜt_sh¬e
);

706 
pÜt_sh¬e
 = 
NULL
;

708 
	}
}

711 
	$š™_pÜt_sh¬e
(
cÚ‹xt
 *
c
)

713 ià(!
pÜt_sh¬e
 && (
c
->
İtiÚs
.
pÜt_sh¬e_ho¡
 && c->İtiÚs.
pÜt_sh¬e_pÜt
))

715 
pÜt_sh¬e
 = 
	`pÜt_sh¬e_İ’
(
c
->
İtiÚs
.
pÜt_sh¬e_ho¡
,

716 
c
->
İtiÚs
.
pÜt_sh¬e_pÜt
,

717 
	`MAX_RW_SIZE_LINK
(&
c
->
c2
.
äame
),

718 
c
->
İtiÚs
.
pÜt_sh¬e_jouº®_dœ
);

719 ià(
pÜt_sh¬e
 =ğ
NULL
)

721 
	`msg
(
M_FATAL
, "Fatalƒrror: Port sharing failed");

724 
	}
}

729 
boŞ


730 
	$š™_¡©ic
()

734 #ià
	`defšed
(
ENABLE_CRYPTO
è&& defšed(
DMALLOC
)

735 
	`üy±o_š™_dm®loc
();

745 
timev®
 
tv
;

746 ià(!
	`g‘timeofday
(&
tv
, 
NULL
))

748 cÚ¡ 
£ed
 = (è
tv
.
tv_£c
 ^v.
tv_u£c
;

749 
	`¤ªdom
(
£ed
);

752 
	`”rÜ_»£t
();

753 
	`»£t_check_¡©us
();

755 #ifdeà
_WIN32


756 
	`š™_wš32
();

759 #ifdeà
OPENVPN_DEBUG_COMMAND_LINE


761 
i
;

762 
i
 = 0; i < 
¬gc
; ++i)

764 
	`msg
(
M_INFO
, "¬gv[%d] = '%s'", 
i
, 
¬gv
[i]);

769 
	`upd©e_time
();

771 #ifdeà
ENABLE_CRYPTO


772 
	`š™_s¦_lib
();

777 
	`´ng_š™
(
NULL
, 0);

780 #ifdeà
PID_TEST


781 
	`·ck‘_id_š‹¿ùive_‹¡
();

782  
çl£
;

785 #ifdeà
SCHEDULE_TEST


786 
	`scheduË_‹¡
();

787  
çl£
;

790 #ifdeà
LIST_TEST


791 
	`li¡_‹¡
();

792  
çl£
;

795 #ifdeà
IFCONFIG_POOL_TEST


796 
	`ifcÚfig_poŞ_‹¡
(0x0A010004, 0x0A0100FF);

797  
çl£
;

800 #ifdeà
CHARACTER_CLASS_DEBUG


801 
	`ch¬aù”_şass_debug
();

802  
çl£
;

805 #ifdeà
EXTRACT_X509_FIELD_TEST


806 
	`exŒaù_x509_f›ld_‹¡
();

807  
çl£
;

810 #ifdeà
TIME_TEST


811 
	`time_‹¡
();

812  
çl£
;

815 #ifdeà
TEST_GET_DEFAULT_GATEWAY


817 
rou‹_g©eway_šfo
 
rgi
;

818 
rou‹_v6_g©eway_šfo
 
rgi6
;

819 
	`g‘_deçuÉ_g©eway
(&
rgi
);

820 
	`g‘_deçuÉ_g©eway_v6
(&
rgi6
, 
NULL
);

821 
	`´št_deçuÉ_g©eway
(
M_INFO
, &
rgi
, &
rgi6
);

822  
çl£
;

826 #ifdeà
GEN_PATH_TEST


828 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

829 cÚ¡ *
â
 = 
	`g’_·th
("foo",

831 &
gc
);

832 
	`´štf
("%s\n", 
â
);

833 
	`gc_ä“
(&
gc
);

835  
çl£
;

838 #ifdeà
STATUS_PRINTF_TEST


840 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

841 cÚ¡ *
tmp_fe
 = 
	`ü—‹_‹mp_fe
("/tmp", "foo", &
gc
);

842 
¡©us_ouut
 *
so
 = 
	`¡©us_İ’
(
tmp_fe
, 0, -1, 
NULL
, 
STATUS_OUTPUT_WRITE
);

843 
	`¡©us_´štf
(
so
, "%s", "foo");

844 
	`¡©us_´štf
(
so
, "%s", "bar");

845 ià(!
	`¡©us_şo£
(
so
))

847 
	`msg
(
M_WARN
, "STATUS_PRINTF_TEST: %s: wr™”rÜ", 
tmp_fe
);

849 
	`gc_ä“
(&
gc
);

851  
çl£
;

854 #ifdeà
ARGV_TEST


856 
	`¬gv_‹¡
();

858 
	`¬gv_‹¡
();

859  
çl£
;

863 #ifdeà
PRNG_TEST


865 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

866 
ušt8_t
 
ºdbuf
[8];

867 
i
;

868 
	`´ng_š™
("sha1", 16);

870 cÚ¡ 
çùÜ
 = 1;

871 
i
 = 0; i < 
çùÜ
 * 8; ++i)

874 
	`´ng_by‹s
(
ºdbuf
, (rndbuf));

876 
	`ASSERT
(
	`¿nd_by‹s
(
ºdbuf
, (rndbuf)));

878 
	`´štf
("[%d] %s\n", 
i
, 
	`fÜm©_hex
(
ºdbuf
, Ôndbuf), 0, &
gc
));

880 
	`gc_ä“
(&
gc
);

881 
	`´ng_unš™
();

882  
çl£
;

886 #ifdeà
BUFFER_LIST_AGGREGATE_TEST


889 cÚ¡ *
‹xt
[] = {

902 
™”
, 
li¡ÿp
;

903 
li¡ÿp
 = 0;†istcap < 12; ++listcap)

905 
™”
 = 0; iter < 512; ++iter)

907 
bufãr_li¡
 *
bl
 = 
	`bufãr_li¡_Ãw
(
li¡ÿp
);

909 
i
;

910 
i
 = 0; i < 
	`SIZE
(
‹xt
); ++i)

912 
	`bufãr_li¡_push
(
bl
, (*)
‹xt
[
i
]);

915 
	`´štf
("[ÿp=%d i=%d] *************************\n", 
li¡ÿp
, 
™”
);

916 ià(!(
™”
 & 8))

918 
	`bufãr_li¡_agg»g©e
(
bl
, 
™”
/2);

920 ià(!(
™”
 & 16))

922 
	`bufãr_li¡_push
(
bl
, (*)"Even moreext...");

924 
	`bufãr_li¡_agg»g©e
(
bl
, 
™”
);

925 ià(!(
™”
 & 1))

927 
	`bufãr_li¡_push
(
bl
, (*)"Moreext...");

930 
bufãr
 *
buf
;

931 (
buf
 = 
	`bufãr_li¡_³ek
(
bl
)))

933 
c
;

934 
	`´štf
("'");

935 (
c
 = 
	`buf_»ad_u8
(
buf
)) >= 0)

937 
	`putch¬
(
c
);

939 
	`´štf
("'\n");

940 
	`bufãr_li¡_advªû
(
bl
, 0);

943 
	`bufãr_li¡_ä“
(
bl
);

946  
çl£
;

950 #ifdeà
MSTATS_TEST


952 
i
;

953 
	`m¡©s_İ’
("/dev/shm/mstats.dat");

954 
i
 = 0; i < 30; ++i)

956 
mm­_¡©s
->
n_ş›Ás
 += 1;

957 
mm­_¡©s
->
lšk_wr™e_by‹s
 += 8;

958 
mm­_¡©s
->
lšk_»ad_by‹s
 += 16;

959 
	`¦“p
(1);

961 
	`m¡©s_şo£
();

962  
çl£
;

966  
Œue
;

967 
	}
}

970 
	$unš™_¡©ic
()

972 #ifdeà
ENABLE_CRYPTO


973 
	`ä“_s¦_lib
();

976 #ifdeà
ENABLE_PKCS11


977 
	`pkcs11_‹rmš©e
();

980 #ià
PORT_SHARE


981 
	`şo£_pÜt_sh¬e
();

984 #ià
	`defšed
(
MEASURE_TLS_HANDSHAKE_STATS
è&& defšed(
ENABLE_CRYPTO
)

985 
	`show_s_³rfÜmªû_¡©s
();

987 
	}
}

990 
	$š™_v”b_mu‹
(
cÚ‹xt
 *
c
, 
æags
)

992 ià(
æags
 & 
IVM_LEVEL_1
)

995 
	`£t_check_¡©us
(
D_LINK_ERRORS
, 
D_READ_WRITE
);

996 
	`£t_debug_Ëv–
(
c
->
İtiÚs
.
v”bos™y
, 
SDL_CONSTRAIN
);

997 
	`£t_mu‹_cutoff
(
c
->
İtiÚs
.
mu‹
);

1001 ià(
æags
 & 
IVM_LEVEL_2
)

1003 
c
->
c2
.
log_rw
 = (
	`check_debug_Ëv–
(
D_LOG_RW
) && !check_debug_level(D_LOG_RW + 1));

1005 
	}
}

1013 
	$š™_İtiÚs_dev
(
İtiÚs
 *options)

1015 ià(!
İtiÚs
->
dev
 && o±iÚs->
dev_node
)

1017 *
dev_node
 = 
	`¡ršg_®loc
(
İtiÚs
->dev_node, 
NULL
);

1018 
İtiÚs
->
dev
 = 
	`ba£Çme
(
dev_node
);

1020 
	}
}

1022 
boŞ


1023 
	$´št_İ’s¦_šfo
(cÚ¡ 
İtiÚs
 *options)

1028 #ifdeà
ENABLE_CRYPTO


1029 ià(
İtiÚs
->
show_ch”s
 || o±iÚs->
show_dige¡s
 || o±iÚs->
show_’gšes


1030 || 
İtiÚs
->
show_s_ch”s
 || o±iÚs->
show_curves
)

1032 ià(
İtiÚs
->
show_ch”s
)

1034 
	`show_avaabË_ch”s
();

1036 ià(
İtiÚs
->
show_dige¡s
)

1038 
	`show_avaabË_dige¡s
();

1040 ià(
İtiÚs
->
show_’gšes
)

1042 
	`show_avaabË_’gšes
();

1044 ià(
İtiÚs
->
show_s_ch”s
)

1046 
	`show_avaabË_s_ch”s
(
İtiÚs
->
ch”_li¡
,

1047 
İtiÚs
->
ch”_li¡_s13
,

1048 
İtiÚs
->
s_û¹_´ofe
);

1050 ià(
İtiÚs
->
show_curves
)

1052 
	`show_avaabË_curves
();

1054  
Œue
;

1057  
çl£
;

1058 
	}
}

1063 
boŞ


1064 
	$do_g’key
(cÚ¡ 
İtiÚs
 *options)

1066 #ifdeà
ENABLE_CRYPTO


1067 ià(
İtiÚs
->
g’key
)

1069 
nb™s_wr™‹n
;

1071 
	`nÙnuÎ
(
İtiÚs
->
sh¬ed_£ü‘_fe
,

1074 ià(
İtiÚs
->
mlock
)

1076 
	`¶©fÜm_mlock®l
(
Œue
);

1079 
nb™s_wr™‹n
 = 
	`wr™e_key_fe
(2, 
İtiÚs
->
sh¬ed_£ü‘_fe
);

1081 
	`msg
(
D_GENKEY
 | 
M_NOPREFIX
,

1082 "Rªdomly g’”©ed %d b™ key wr™‹ÀtØ%s", 
nb™s_wr™‹n
,

1083 
İtiÚs
->
sh¬ed_£ü‘_fe
);

1084  
Œue
;

1087  
çl£
;

1088 
	}
}

1093 
boŞ


1094 
	$do_³rsi¡_tuÁ­
(cÚ¡ 
İtiÚs
 *options)

1096 ià(
İtiÚs
->
³rsi¡_cÚfig
)

1099 
	`nÙnuÎ
(
İtiÚs
->
dev
, "TUN/TAP device (--dev)");

1100 ià(
İtiÚs
->
û
.
»mÙe
 || o±iÚs->
ifcÚfig_loÿl


1101 || 
İtiÚs
->
ifcÚfig_»mÙe_Ãtmask


1102 #ifdeà
ENABLE_CRYPTO


1103 || 
İtiÚs
->
sh¬ed_£ü‘_fe


1104 || 
İtiÚs
->
s_£rv”
 || o±iÚs->
s_ş›Á


1108 
	`msg
(
M_FATAL
|
M_OPTERR
,

1111 #ifdeà
ENABLE_FEATURE_TUN_PERSIST


1112 
	`tuncfg
(
İtiÚs
->
dev
, o±iÚs->
dev_ty³
, o±iÚs->
dev_node
,

1113 
İtiÚs
->
³rsi¡_mode
,

1114 
İtiÚs
->
u£ºame
, o±iÚs->
grou²ame
, &İtiÚs->
tuÁ­_İtiÚs
);

1115 ià(
İtiÚs
->
³rsi¡_mode
 && o±iÚs->
Îaddr
)

1117 
	`£t_Îaddr
(
İtiÚs
->
dev
, o±iÚs->
Îaddr
, 
NULL
);

1119  
Œue
;

1121 
	`msg
Ğ
M_FATAL
|
M_OPTERR
,

1125 "³rsi¡ªˆtuÂ– iÁ”çûs.", 
İtiÚs
->
dev
 );

1128  
çl£
;

1129 
	}
}

1135 
boŞ


1136 
	$possibly_become_d«mÚ
(cÚ¡ 
İtiÚs
 *options)

1138 
boŞ
 
»t
 = 
çl£
;

1140 #ifdeà
ENABLE_SYSTEMD


1142 ià(
	`sd_nÙify
(0, "READY=0") > 0)

1144  
»t
;

1148 ià(
İtiÚs
->
d«mÚ
)

1150 
	`ASSERT
(!
İtiÚs
->
š‘d
);

1152 ià(
	`d«mÚ
(1, 
İtiÚs
->
log
) < 0)

1154 
	`msg
(
M_ERR
, "daemon() failed or unsupported");

1156 
	`»¡Üe_sigÇl_¡©e
();

1157 ià(
İtiÚs
->
log
)

1159 
	`£t_¡d_fes_to_nuÎ
(
Œue
);

1162 
»t
 = 
Œue
;

1164  
»t
;

1165 
	}
}

1171 
	$do_uid_gid_chroÙ
(
cÚ‹xt
 *
c
, 
boŞ
 
no_d–ay
)

1173 cÚ¡ 
why_nÙ
[] = "will be delayed because of --client, --pull, or --up-delay";

1174 
cÚ‹xt_0
 *
c0
 = 
c
->c0;

1176 ià(
c0
 && !c0->
uid_gid_chroÙ_£t
)

1179 ià(
c
->
İtiÚs
.
chroÙ_dœ
)

1181 ià(
no_d–ay
)

1183 
	`¶©fÜm_chroÙ
(
c
->
İtiÚs
.
chroÙ_dœ
);

1185 ià(
c
->
fœ¡_time
)

1187 
	`msg
(
M_INFO
, "NOTE: chroÙ %s", 
why_nÙ
);

1192 ià(
c0
->
uid_gid_¥ecif›d
)

1194 ià(
no_d–ay
)

1196 
	`¶©fÜm_group_£t
(&
c0
->
¶©fÜm_¡©e_group
);

1197 
	`¶©fÜm_u£r_£t
(&
c0
->
¶©fÜm_¡©e_u£r
);

1199 ià(
c
->
fœ¡_time
)

1201 
	`msg
(
M_INFO
, "NOTE: UID/GID downg¿d%s", 
why_nÙ
);

1205 #ifdeà
ENABLE_MEMSTATS


1206 ià(
c
->
fœ¡_time
 && c->
İtiÚs
.
mem¡©s_â
)

1208 
	`m¡©s_İ’
(
c
->
İtiÚs
.
mem¡©s_â
);

1212 #ifdeà
ENABLE_SELINUX


1219 ià(
c
->
İtiÚs
.
£lšux_cÚ‹xt
)

1221 ià(
no_d–ay
)

1223 ià(-1 =ğ
	`£tcÚ
(
c
->
İtiÚs
.
£lšux_cÚ‹xt
))

1225 
	`msg
(
M_ERR
, "£tcÚØ'%s' faed; i /´oøacûssibË?", 
c
->
İtiÚs
.
£lšux_cÚ‹xt
);

1229 
	`msg
(
M_INFO
, "£tcÚØ'%s' sucûeded", 
c
->
İtiÚs
.
£lšux_cÚ‹xt
);

1232 ià(
c
->
fœ¡_time
)

1234 
	`msg
(
M_INFO
, "NOTE: s‘cÚ %s", 
why_nÙ
);

1242 ià(
no_d–ay
)

1244 
c0
->
uid_gid_chroÙ_£t
 = 
Œue
;

1247 
	}
}

1254 
	$fÜm©_commÚ_Çme
(
cÚ‹xt
 *
c
, 
gc_¬’a
 *
gc
)

1256 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

1257 #ifdeà
ENABLE_CRYPTO


1258 ià(
c
->
c2
.
s_muÉi
)

1260 
	`buf_´štf
(&
out
, "[%s] ", 
	`s_commÚ_Çme
(
c
->
c2
.
s_muÉi
, 
çl£
));

1263  
	`BSTR
(&
out
);

1264 
	}
}

1267 
	$´e_£tup
(cÚ¡ 
İtiÚs
 *options)

1269 #ifdeà
_WIN32


1270 ià(
İtiÚs
->
ex™_ev’t_Çme
)

1272 
	`wš32_sigÇl_İ’
(&
wš32_sigÇl
,

1273 
WSO_FORCE_SERVICE
,

1274 
İtiÚs
->
ex™_ev’t_Çme
,

1275 
İtiÚs
->
ex™_ev’t_š™Ÿl_¡©e
);

1279 
	`wš32_sigÇl_İ’
(&
wš32_sigÇl
,

1280 
WSO_FORCE_CONSOLE
,

1281 
NULL
,

1282 
çl£
);

1285 ià(
wš32_sigÇl
.
mode
 =ğ
WSO_MODE_CONSOLE
)

1287 
	`wšdow_t™Ë_§ve
(&
wšdow_t™Ë
);

1288 
	`wšdow_t™Ë_g’”©e
(
İtiÚs
->
cÚfig
);

1292 
	}
}

1295 
	$»£t_cßr£_tim”s
(
cÚ‹xt
 *
c
)

1297 
c
->
c2
.
cßr£_tim”_wakeup
 = 0;

1298 
	}
}

1306 
	$do_š™_£rv”_pŞl_timeout
(
cÚ‹xt
 *
c
)

1308 
	`upd©e_time
();

1309 ià(
c
->
İtiÚs
.
û
.
cÚÃù_timeout
)

1311 
	`ev’t_timeout_š™
(&
c
->
c2
.
£rv”_pŞl_š‹rv®
, c->
İtiÚs
.
û
.
cÚÃù_timeout
, 
now
);

1313 
	}
}

1319 
	$do_š™_tim”s
(
cÚ‹xt
 *
c
, 
boŞ
 
deã¼ed
)

1321 
	`upd©e_time
();

1322 
	`»£t_cßr£_tim”s
(
c
);

1325 ià(
c
->
İtiÚs
.
šaùiv™y_timeout
)

1327 
	`ev’t_timeout_š™
(&
c
->
c2
.
šaùiv™y_š‹rv®
, c->
İtiÚs
.
šaùiv™y_timeout
, 
now
);

1332 ià(
c
->
İtiÚs
.
pšg_£nd_timeout
)

1334 
	`ev’t_timeout_š™
(&
c
->
c2
.
pšg_£nd_š‹rv®
, c->
İtiÚs
.
pšg_£nd_timeout
, 0);

1337 ià(
c
->
İtiÚs
.
pšg_»c_timeout
)

1339 
	`ev’t_timeout_š™
(&
c
->
c2
.
pšg_»c_š‹rv®
, c->
İtiÚs
.
pšg_»c_timeout
, 
now
);

1342 ià(!
deã¼ed
)

1345 
	`ev’t_timeout_š™
(&
c
->
c2
.
wa™_fÜ_cÚÃù
, 1, 
now
);

1347 #ifdeà
ENABLE_OCC


1350 ià(
c
->
İtiÚs
.
occ


1351 && !
	`TLS_MODE
(
c
)

1352 && 
c
->
c2
.
İtiÚs_¡ršg_loÿl
 && c->c2.
İtiÚs_¡ršg_»mÙe
)

1354 
	`ev’t_timeout_š™
(&
c
->
c2
.
occ_š‹rv®
, 
OCC_INTERVAL_SECONDS
, 
now
);

1357 ià(
c
->
İtiÚs
.
mtu_‹¡
)

1359 
	`ev’t_timeout_š™
(&
c
->
c2
.
occ_mtu_lßd_‹¡_š‹rv®
, 
OCC_MTU_LOAD_INTERVAL_SECONDS
, 
now
);

1364 #ifdeà
ENABLE_CRYPTO


1365 ià(
c
->
İtiÚs
.
·ck‘_id_fe
)

1367 
	`ev’t_timeout_š™
(&
c
->
c2
.
·ck‘_id_³rsi¡_š‹rv®
, 60, 
now
);

1372 
	`š‹rv®_š™
(&
c
->
c2
.
tmp_št
, 
TLS_MULTI_HORIZON
, 
TLS_MULTI_REFRESH
);

1375 
	}
}

1381 
	$do_š™_Œaffic_sh­”
(
cÚ‹xt
 *
c
)

1383 #ifdeà
ENABLE_FEATURE_SHAPER


1385 ià(
c
->
İtiÚs
.
sh­”
)

1387 
	`sh­”_š™
(&
c
->
c2
.
sh­”
, c->
İtiÚs
.shaper);

1388 
	`sh­”_msg
(&
c
->
c2
.
sh­”
);

1391 
	}
}

1399 
	$do_®loc_rou‹_li¡
(
cÚ‹xt
 *
c
)

1401 ià(!
c
->
c1
.
rou‹_li¡
)

1403 
	`ALLOC_OBJ_CLEAR_GC
(
c
->
c1
.
rou‹_li¡
, rou‹_li¡, &c->
gc
);

1405 ià(
c
->
İtiÚs
.
rou‹s_v6
 && !c->
c1
.
rou‹_v6_li¡
)

1407 
	`ALLOC_OBJ_CLEAR_GC
(
c
->
c1
.
rou‹_v6_li¡
, rou‹_v6_li¡, &c->
gc
);

1409 
	}
}

1417 
	$do_š™_rou‹_li¡
(cÚ¡ 
İtiÚs
 *options,

1418 
rou‹_li¡
 *route_list,

1419 cÚ¡ 
lšk_sock‘_šfo
 *link_socket_info,

1420 
’v_£t
 *
es
)

1422 cÚ¡ *
gw
 = 
NULL
;

1423 
dev
 = 
	`dev_ty³_’um
(
İtiÚs
->dev, o±iÚs->
dev_ty³
);

1424 
m‘ric
 = 0;

1426 ià(
dev
 =ğ
DEV_TYPE_TUN
 && (
İtiÚs
->
tİŞogy
 =ğ
TOP_NET30
 || o±iÚs->tİŞogy =ğ
TOP_P2P
))

1428 
gw
 = 
İtiÚs
->
ifcÚfig_»mÙe_Ãtmask
;

1430 ià(
İtiÚs
->
rou‹_deçuÉ_g©eway
)

1432 
gw
 = 
İtiÚs
->
rou‹_deçuÉ_g©eway
;

1434 ià(
İtiÚs
->
rou‹_deçuÉ_m‘ric
)

1436 
m‘ric
 = 
İtiÚs
->
rou‹_deçuÉ_m‘ric
;

1439 ià(
	`š™_rou‹_li¡
(
rou‹_li¡
,

1440 
İtiÚs
->
rou‹s
,

1441 
gw
,

1442 
m‘ric
,

1443 
	`lšk_sock‘_cu¼’t_»mÙe
(
lšk_sock‘_šfo
),

1444 
es
))

1447 
	`£‹nv_rou‹s
(
es
, 
rou‹_li¡
);

1449 
	}
}

1452 
	$do_š™_rou‹_v6_li¡
(cÚ¡ 
İtiÚs
 *options,

1453 
rou‹_v6_li¡
 *route_ipv6_list,

1454 cÚ¡ 
lšk_sock‘_šfo
 *link_socket_info,

1455 
’v_£t
 *
es
)

1457 cÚ¡ *
gw
 = 
NULL
;

1458 
m‘ric
 = -1;

1460 
gw
 = 
İtiÚs
->
ifcÚfig_v6_»mÙe
;

1462 ià(
İtiÚs
->
rou‹_v6_deçuÉ_g©eway
)

1464 
gw
 = 
İtiÚs
->
rou‹_v6_deçuÉ_g©eway
;

1468 ià(
İtiÚs
->
rou‹_deçuÉ_m‘ric
)

1470 
m‘ric
 = 
İtiÚs
->
rou‹_deçuÉ_m‘ric
;

1475 ià(
İtiÚs
->
rou‹s_v6
->
æags
 & 
RG_REROUTE_GW
)

1477 *
İt_li¡
[] = { "::/3", "2000::/4", "3000::/4", "fc00::/7", 
NULL
 };

1478 
i
;

1480 
i
 = 0; 
İt_li¡
[i]; i++)

1482 
	`add_rou‹_v6_to_İtiÚ_li¡
Ğ
İtiÚs
->
rou‹s_v6
,

1483 
	`¡ršg_®loc
(
İt_li¡
[
i
], 
İtiÚs
->
rou‹s_v6
->
gc
),

1484 
NULL
, NULL );

1488 ià(
	`š™_rou‹_v6_li¡
(
rou‹_v6_li¡
,

1489 
İtiÚs
->
rou‹s_v6
,

1490 
gw
,

1491 
m‘ric
,

1492 
	`lšk_sock‘_cu¼’t_»mÙe_v6
(
lšk_sock‘_šfo
),

1493 
es
))

1496 
	`£‹nv_rou‹s_v6
(
es
, 
rou‹_v6_li¡
);

1498 
	}
}

1505 
	$š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

1507 cÚ¡ 
mes§ge
[] = "Initialization Sequence Completed";

1510 
c
->
İtiÚs
.
unsucûssful_©‹m±s
 = 0;

1513 
	`do_uid_gid_chroÙ
(
c
, 
Œue
);

1516 #ifdeà
ENABLE_CRYPTO


1524 ià(
c
->
İtiÚs
.
mode
 =ğ
MODE_POINT_TO_POINT
)

1526 
	`d–ayed_auth_·ss_purge
();

1531 ià(
æags
 & 
ISC_ERRORS
)

1533 #ifdeà
_WIN32


1534 
	`show_rou‹s
(
M_INFO
|
M_NOPREFIX
);

1535 
	`show_ad­‹rs
(
M_INFO
|
M_NOPREFIX
);

1536 
	`msg
(
M_INFO
, "% W™h E¼Ü Ğ£h‰p://İ’v².Ãt/çq.html#dhış›Á£rv )", 
mes§ge
);

1538 #ifdeà
ENABLE_SYSTEMD


1539 
	`sd_nÙifyf
(0, "STATUS=FaedØ¡¬ˆup: % W™h E¼Üs\nERRNO=1", 
mes§ge
);

1541 
	`msg
(
M_INFO
, "% W™h E¼Üs", 
mes§ge
);

1546 #ifdeà
ENABLE_SYSTEMD


1547 
	`sd_nÙifyf
(0, "STATUS=%s", 
mes§ge
);

1549 
	`msg
(
M_INFO
, "%s", 
mes§ge
);

1553 ià((
æags
 & (
ISC_ERRORS
|
ISC_SERVER
)) == 0)

1555 
c
->
İtiÚs
.
no_advªû
 = 
Œue
;

1558 #ifdeà
_WIN32


1559 
	`fÜk_»gi¡”_dns_aùiÚ
(
c
->
c1
.
tuÁ­
);

1562 #ifdeà
ENABLE_MANAGEMENT


1564 ià(
mªagem’t
)

1566 
š_addr_t
 *
tun_loÿl
 = 
NULL
;

1567 
š6_addr
 *
tun_loÿl6
 = 
NULL
;

1568 
İ’v²_sockaddr
 
loÿl
, 
»mÙe
;

1569 
lšk_sock‘_aùu®
 *
aùu®
;

1570 
sockËn_t
 
§_Ën
 = (
loÿl
);

1571 cÚ¡ *
d‘a
 = "SUCCESS";

1572 ià(
æags
 & 
ISC_ERRORS
)

1574 
d‘a
 = "ERROR";

1577 
	`CLEAR
(
loÿl
);

1578 
aùu®
 = &
	`g‘_lšk_sock‘_šfo
(
c
)->
l§
->actual;

1579 
»mÙe
 = 
aùu®
->
de¡
;

1580 
	`g‘sockÇme
(
c
->
c2
.
lšk_sock‘
->
sd
, &
loÿl
.
addr
.
§
, &
§_Ën
);

1581 #ià
ENABLE_IP_PKTINFO


1582 ià(!
	`addr_defšed
(&
loÿl
))

1584 
loÿl
.
addr
.
§
.
§_çmy
)

1586 
AF_INET
:

1587 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

1588 
loÿl
.
addr
.
š4
.
sš_addr
 = 
aùu®
->
pi
.š4.
i_¥ec_d¡
;

1590 
loÿl
.
addr
.
š4
.
sš_addr
 = 
aùu®
->
pi
.in4;

1594 
AF_INET6
:

1595 
loÿl
.
addr
.
š6
.
sš6_addr
 = 
aùu®
->
pi
.š6.
i6_addr
;

1601 ià(
c
->
c1
.
tuÁ­
)

1603 
tun_loÿl
 = &
c
->
c1
.
tuÁ­
->
loÿl
;

1604 
tun_loÿl6
 = &
c
->
c1
.
tuÁ­
->
loÿl_v6
;

1606 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

1607 
OPENVPN_STATE_CONNECTED
,

1608 
d‘a
,

1609 
tun_loÿl
,

1610 
tun_loÿl6
,

1611 &
loÿl
,

1612 &
»mÙe
);

1613 ià(
tun_loÿl
)

1615 
	`mªagem’t_po¡_tuÂ–_İ’
(
mªagem’t
, *
tun_loÿl
);

1619 
	}
}

1626 
	$do_rou‹
(cÚ¡ 
İtiÚs
 *options,

1627 
rou‹_li¡
 *route_list,

1628 
rou‹_v6_li¡
 *route_ipv6_list,

1629 cÚ¡ 
tuÁ­
 *
‰
,

1630 cÚ¡ 
¶ugš_li¡
 *
¶ugšs
,

1631 
’v_£t
 *
es
)

1633 ià(!
İtiÚs
->
rou‹_nÛxec
 && ( 
rou‹_li¡
 || 
rou‹_v6_li¡
 ) )

1635 
	`add_rou‹s
(
rou‹_li¡
, 
rou‹_v6_li¡
, 
‰
, 
	`ROUTE_OPTION_FLAGS
(
İtiÚs
), 
es
);

1636 
	`£‹nv_št
(
es
, "»dœeù_g©eway", 
	`rou‹_did_»dœeù_deçuÉ_g©eway
(
rou‹_li¡
));

1638 #ifdeà
ENABLE_MANAGEMENT


1639 ià(
mªagem’t
)

1641 
	`mªagem’t_up_down
(
mªagem’t
, "UP", 
es
);

1645 ià(
	`¶ugš_defšed
(
¶ugšs
, 
OPENVPN_PLUGIN_ROUTE_UP
))

1647 ià(
	`¶ugš_ÿÎ
(
¶ugšs
, 
OPENVPN_PLUGIN_ROUTE_UP
, 
NULL
, NULL, 
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1649 
	`msg
(
M_WARN
, "WARNING:„oute-up…lugin call failed");

1653 ià(
İtiÚs
->
rou‹_süt
)

1655 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1656 
	`£‹nv_¡r
(
es
, "script_type", "route-up");

1657 
	`¬gv_·r£_cmd
(&
¬gv
, 
İtiÚs
->
rou‹_süt
);

1658 
	`İ’v²_run_süt
(&
¬gv
, 
es
, 0, "--route-up");

1659 
	`¬gv_»£t
(&
¬gv
);

1662 #ifdeà
_WIN32


1663 ià(
İtiÚs
->
show_Ãt_up
)

1665 
	`show_rou‹s
(
M_INFO
|
M_NOPREFIX
);

1666 
	`show_ad­‹rs
(
M_INFO
|
M_NOPREFIX
);

1668 ià(
	`check_debug_Ëv–
(
D_SHOW_NET
))

1670 
	`show_rou‹s
(
D_SHOW_NET
|
M_NOPREFIX
);

1671 
	`show_ad­‹rs
(
D_SHOW_NET
|
M_NOPREFIX
);

1674 
	}
}

1680 
	$do_š™_tun
(
cÚ‹xt
 *
c
)

1682 
c
->
c1
.
tuÁ­
 = 
	`š™_tun
(c->
İtiÚs
.
dev
,

1683 
c
->
İtiÚs
.
dev_ty³
,

1684 
c
->
İtiÚs
.
tİŞogy
,

1685 
c
->
İtiÚs
.
ifcÚfig_loÿl
,

1686 
c
->
İtiÚs
.
ifcÚfig_»mÙe_Ãtmask
,

1687 
c
->
İtiÚs
.
ifcÚfig_v6_loÿl
,

1688 
c
->
İtiÚs
.
ifcÚfig_v6_Ãtb™s
,

1689 
c
->
İtiÚs
.
ifcÚfig_v6_»mÙe
,

1690 
c
->
c1
.
lšk_sock‘_addr
.
bšd_loÿl
,

1691 
c
->
c1
.
lšk_sock‘_addr
.
»mÙe_li¡
,

1692 !
c
->
İtiÚs
.
ifcÚfig_now¬n
,

1693 
c
->
c2
.
es
);

1695 
	`š™_tun_po¡
(
c
->
c1
.
tuÁ­
,

1696 &
c
->
c2
.
äame
,

1697 &
c
->
İtiÚs
.
tuÁ­_İtiÚs
);

1699 
c
->
c1
.
tuÁ­_owÃd
 = 
Œue
;

1700 
	}
}

1706 
boŞ


1707 
	$do_İ’_tun
(
cÚ‹xt
 *
c
)

1709 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1710 
boŞ
 
»t
 = 
çl£
;

1712 #iâdeà
TARGET_ANDROID


1713 ià(!
c
->
c1
.
tuÁ­
)

1717 #ifdeà
TARGET_ANDROID


1720 
Şdtunfd
 = -1;

1721 ià(
c
->
c1
.
tuÁ­
)

1723 
Şdtunfd
 = 
c
->
c1
.
tuÁ­
->
fd
;

1724 
	`ä“
(
c
->
c1
.
tuÁ­
);

1725 
c
->
c1
.
tuÁ­
 = 
NULL
;

1726 
c
->
c1
.
tuÁ­_owÃd
 = 
çl£
;

1731 
	`do_š™_tun
(
c
);

1733 #ifdeà
_WIN32


1735 
c
->
c1
.
tuÁ­
->
İtiÚs
.
msg_chªÃl
 = c->options.msg_channel;

1736 
	`msg
(
D_ROUTE
, "š‹¿ùiv£rviû msg_chªÃl=%u", (è
c
->
İtiÚs
.
msg_chªÃl
);

1740 
	`do_®loc_rou‹_li¡
(
c
);

1743 
	`ASSERT
(
c
->
c2
.
lšk_sock‘
);

1744 ià(
c
->
İtiÚs
.
rou‹s
 && c->
c1
.
rou‹_li¡
)

1746 
	`do_š™_rou‹_li¡
(&
c
->
İtiÚs
, c->
c1
.
rou‹_li¡
,

1747 &
c
->
c2
.
lšk_sock‘
->
šfo
, c->c2.
es
);

1749 ià(
c
->
İtiÚs
.
rou‹s_v6
 && c->
c1
.
rou‹_v6_li¡
)

1751 
	`do_š™_rou‹_v6_li¡
(&
c
->
İtiÚs
, c->
c1
.
rou‹_v6_li¡
,

1752 &
c
->
c2
.
lšk_sock‘
->
šfo
, c->c2.
es
);

1756 ià(!
c
->
İtiÚs
.
ifcÚfig_nÛxec


1757 && 
	`ifcÚfig_Üd”
(è=ğ
IFCONFIG_BEFORE_TUN_OPEN
)

1761 cÚ¡ *
guess
 = 
	`guess_tuÁ­_dev
(
c
->
İtiÚs
.
dev
,

1762 
c
->
İtiÚs
.
dev_ty³
,

1763 
c
->
İtiÚs
.
dev_node
,

1764 &
gc
);

1765 
	`do_ifcÚfig
(
c
->
c1
.
tuÁ­
, 
guess
, 
	`TUN_MTU_SIZE
(&c->
c2
.
äame
), c->c2.
es
);

1769 ià(
	`rou‹_Üd”
(è=ğ
ROUTE_BEFORE_TUN
)

1772 
	`do_rou‹
(&
c
->
İtiÚs
, c->
c1
.
rou‹_li¡
, c->c1.
rou‹_v6_li¡
,

1773 
c
->
c1
.
tuÁ­
, c->
¶ugšs
, c->
c2
.
es
);

1775 #ifdeà
TARGET_ANDROID


1777 
c
->
c1
.
tuÁ­
->
fd
 = 
Şdtunfd
;

1780 
	`İ’_tun
(
c
->
İtiÚs
.
dev
, c->İtiÚs.
dev_ty³
, c->İtiÚs.
dev_node
,

1781 
c
->
c1
.
tuÁ­
);

1784 ià(
c
->
İtiÚs
.
Îaddr
)

1786 
	`£t_Îaddr
(
c
->
c1
.
tuÁ­
->
aùu®_Çme
, c->
İtiÚs
.
Îaddr
, c->
c2
.
es
);

1790 ià(!
c
->
İtiÚs
.
ifcÚfig_nÛxec


1791 && 
	`ifcÚfig_Üd”
(è=ğ
IFCONFIG_AFTER_TUN_OPEN
)

1793 
	`do_ifcÚfig
(
c
->
c1
.
tuÁ­
, c->c1.tuÁ­->
aùu®_Çme
, 
	`TUN_MTU_SIZE
(&c->
c2
.
äame
), c->c2.
es
);

1797 
	`run_up_down
(
c
->
İtiÚs
.
up_süt
,

1798 
c
->
¶ugšs
,

1799 
OPENVPN_PLUGIN_UP
,

1800 
c
->
c1
.
tuÁ­
->
aùu®_Çme
,

1801 #ifdeà
_WIN32


1802 
c
->
c1
.
tuÁ­
->
ad­‹r_šdex
,

1804 
	`dev_ty³_¡ršg
(
c
->
İtiÚs
.
dev
, c->İtiÚs.
dev_ty³
),

1805 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
),

1806 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
),

1807 
	`´št_š_addr_t
(
c
->
c1
.
tuÁ­
->
loÿl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1808 
	`´št_š_addr_t
(
c
->
c1
.
tuÁ­
->
»mÙe_Ãtmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1810 
NULL
,

1812 
c
->
c2
.
es
);

1814 #ià
	`defšed
(
_WIN32
)

1815 ià(
c
->
İtiÚs
.
block_outside_dns
)

1817 
	`dmsg
(
D_LOW
, "Blocking outside DNS");

1818 ià(!
	`wš_wå_block_dns
(
c
->
c1
.
tuÁ­
->
ad­‹r_šdex
, c->
İtiÚs
.
msg_chªÃl
))

1820 
	`msg
(
M_FATAL
, "Blocking DNS failed!");

1826 ià((
	`rou‹_Üd”
(è=ğ
ROUTE_AFTER_TUN
è&& (!
c
->
İtiÚs
.
rou‹_d–ay_defšed
))

1828 
	`do_rou‹
(&
c
->
İtiÚs
, c->
c1
.
rou‹_li¡
, c->c1.
rou‹_v6_li¡
,

1829 
c
->
c1
.
tuÁ­
, c->
¶ugšs
, c->
c2
.
es
);

1835 ià(
c
->
c1
.
tuÁ­
->
po¡_İ’_mtu
)

1837 
	`äame_£t_mtu_dyÇmic
(&
c
->
c2
.
äame
,

1838 
c
->
c1
.
tuÁ­
->
po¡_İ’_mtu
,

1839 
SET_MTU_TUN
 | 
SET_MTU_UPPER_BOUND
);

1842 
»t
 = 
Œue
;

1843 
¡©ic_cÚ‹xt
 = 
c
;

1844 #iâdeà
TARGET_ANDROID


1848 
	`msg
(
M_INFO
, "Preserving…revious TUN/TAP instance: %s",

1849 
c
->
c1
.
tuÁ­
->
aùu®_Çme
);

1852 
	`do_ifcÚfig_£‹nv
(
c
->
c1
.
tuÁ­
, c->
c2
.
es
);

1855 ià(
c
->
İtiÚs
.
up_»¡¬t
)

1857 
	`run_up_down
(
c
->
İtiÚs
.
up_süt
,

1858 
c
->
¶ugšs
,

1859 
OPENVPN_PLUGIN_UP
,

1860 
c
->
c1
.
tuÁ­
->
aùu®_Çme
,

1861 #ifdeà
_WIN32


1862 
c
->
c1
.
tuÁ­
->
ad­‹r_šdex
,

1864 
	`dev_ty³_¡ršg
(
c
->
İtiÚs
.
dev
, c->İtiÚs.
dev_ty³
),

1865 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
),

1866 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
),

1867 
	`´št_š_addr_t
(
c
->
c1
.
tuÁ­
->
loÿl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1868 
	`´št_š_addr_t
(
c
->
c1
.
tuÁ­
->
»mÙe_Ãtmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1870 
NULL
,

1872 
c
->
c2
.
es
);

1874 #ià
	`defšed
(
_WIN32
)

1875 ià(
c
->
İtiÚs
.
block_outside_dns
)

1877 
	`dmsg
(
D_LOW
, "Blocking outside DNS");

1878 ià(!
	`wš_wå_block_dns
(
c
->
c1
.
tuÁ­
->
ad­‹r_šdex
, c->
İtiÚs
.
msg_chªÃl
))

1880 
	`msg
(
M_FATAL
, "Blocking DNS failed!");

1887 
	`gc_ä“
(&
gc
);

1888  
»t
;

1889 
	}
}

1896 
	$do_şo£_tun_sim¶e
(
cÚ‹xt
 *
c
)

1898 
	`msg
(
D_CLOSE
, "Closing TUN/TAP interface");

1899 
	`şo£_tun
(
c
->
c1
.
tuÁ­
);

1900 
c
->
c1
.
tuÁ­
 = 
NULL
;

1901 
c
->
c1
.
tuÁ­_owÃd
 = 
çl£
;

1902 #ià
P2MP


1903 
	`CLEAR
(
c
->
c1
.
puÎed_İtiÚs_dige¡_§ve
);

1905 
	}
}

1908 
	$do_şo£_tun
(
cÚ‹xt
 *
c
, 
boŞ
 
fÜû
)

1910 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1911 ià(
c
->
c1
.
tuÁ­
 && c->c1.
tuÁ­_owÃd
)

1913 cÚ¡ *
tuÁ­_aùu®
 = 
	`¡ršg_®loc
(
c
->
c1
.
tuÁ­
->
aùu®_Çme
, &
gc
);

1914 #ifdeà
_WIN32


1915 
DWORD
 
ad­‹r_šdex
 = 
c
->
c1
.
tuÁ­
->adapter_index;

1917 cÚ¡ 
š_addr_t
 
loÿl
 = 
c
->
c1
.
tuÁ­
->local;

1918 cÚ¡ 
š_addr_t
 
»mÙe_Ãtmask
 = 
c
->
c1
.
tuÁ­
->remote_netmask;

1920 ià(
fÜû
 || !(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 && c->
İtiÚs
.
³rsi¡_tun
))

1922 
¡©ic_cÚ‹xt
 = 
NULL
;

1924 #ifdeà
ENABLE_MANAGEMENT


1926 ià(
mªagem’t
)

1928 
	`mªagem’t_´e_tuÂ–_şo£
(
mªagem’t
);

1929 
	`mªagem’t_up_down
(
mªagem’t
, "DOWN", 
c
->
c2
.
es
);

1934 ià(
c
->
c1
.
rou‹_li¡
 || c->c1.
rou‹_v6_li¡
)

1936 
	`run_up_down
(
c
->
İtiÚs
.
rou‹_´edown_süt
,

1937 
c
->
¶ugšs
,

1938 
OPENVPN_PLUGIN_ROUTE_PREDOWN
,

1939 
tuÁ­_aùu®
,

1940 #ifdeà
_WIN32


1941 
ad­‹r_šdex
,

1943 
NULL
,

1944 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
),

1945 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
),

1946 
	`´št_š_addr_t
(
loÿl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1947 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1949 
	`sigÇl_desütiÚ
(
c
->
sig
->
sigÇl_»ûived
,

1950 
c
->
sig
->
sigÇl_‹xt
),

1952 
c
->
c2
.
es
);

1954 
	`d–‘e_rou‹s
(
c
->
c1
.
rou‹_li¡
, c->c1.
rou‹_v6_li¡
,

1955 
c
->
c1
.
tuÁ­
, 
	`ROUTE_OPTION_FLAGS
(&c->
İtiÚs
), c->
c2
.
es
);

1959 ià(!
c
->
İtiÚs
.
down_´e
)

1961 
	`do_şo£_tun_sim¶e
(
c
);

1966 
	`run_up_down
(
c
->
İtiÚs
.
down_süt
,

1967 
c
->
¶ugšs
,

1968 
OPENVPN_PLUGIN_DOWN
,

1969 
tuÁ­_aùu®
,

1970 #ifdeà
_WIN32


1971 
ad­‹r_šdex
,

1973 
NULL
,

1974 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
),

1975 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
),

1976 
	`´št_š_addr_t
(
loÿl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1977 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

1979 
	`sigÇl_desütiÚ
(
c
->
sig
->
sigÇl_»ûived
,

1980 
c
->
sig
->
sigÇl_‹xt
),

1982 
c
->
c2
.
es
);

1984 #ià
	`defšed
(
_WIN32
)

1985 ià(
c
->
İtiÚs
.
block_outside_dns
)

1987 ià(!
	`wš_wå_unš™
(
ad­‹r_šdex
, 
c
->
İtiÚs
.
msg_chªÃl
))

1989 
	`msg
(
M_FATAL
, "Uninitialising WFP failed!");

1995 ià(
c
->
İtiÚs
.
down_´e
)

1997 
	`do_şo£_tun_sim¶e
(
c
);

2003 ià(
c
->
İtiÚs
.
up_»¡¬t
)

2005 
	`run_up_down
(
c
->
İtiÚs
.
down_süt
,

2006 
c
->
¶ugšs
,

2007 
OPENVPN_PLUGIN_DOWN
,

2008 
tuÁ­_aùu®
,

2009 #ifdeà
_WIN32


2010 
ad­‹r_šdex
,

2012 
NULL
,

2013 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
),

2014 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
),

2015 
	`´št_š_addr_t
(
loÿl
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

2016 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

2018 
	`sigÇl_desütiÚ
(
c
->
sig
->
sigÇl_»ûived
,

2019 
c
->
sig
->
sigÇl_‹xt
),

2021 
c
->
c2
.
es
);

2024 #ià
	`defšed
(
_WIN32
)

2025 ià(
c
->
İtiÚs
.
block_outside_dns
)

2027 ià(!
	`wš_wå_unš™
(
ad­‹r_šdex
, 
c
->
İtiÚs
.
msg_chªÃl
))

2029 
	`msg
(
M_FATAL
, "Uninitialising WFP failed!");

2036 
	`gc_ä“
(&
gc
);

2037 
	}
}

2040 
	$tun_abÜt
()

2042 
cÚ‹xt
 *
c
 = 
¡©ic_cÚ‹xt
;

2043 ià(
c
)

2045 
¡©ic_cÚ‹xt
 = 
NULL
;

2046 
	`do_şo£_tun
(
c
, 
Œue
);

2048 
	}
}

2054 #ià
P2MP


2059 
boŞ


2060 
	$İtiÚs_hash_chªged_Ü_z”o
(cÚ¡ 
sha256_dige¡
 *
a
,

2061 cÚ¡ 
sha256_dige¡
 *
b
)

2063 cÚ¡ 
sha256_dige¡
 
z”o
 = {{0}};

2064  
	`memcmp
(
a
, 
b
, (
sha256_dige¡
))

2065 || !
	`memcmp
(
a
, &
z”o
, (
sha256_dige¡
));

2066 
	}
}

2069 
boŞ


2070 
	$do_up
(
cÚ‹xt
 *
c
, 
boŞ
 
puÎed_İtiÚs
, 
İtiÚ_ty³s_found
)

2072 ià(!
c
->
c2
.
do_up_¿n
)

2074 
	`»£t_cßr£_tim”s
(
c
);

2076 ià(
puÎed_İtiÚs
)

2078 ià(!
	`do_deã¼ed_İtiÚs
(
c
, 
İtiÚ_ty³s_found
))

2080 
	`msg
(
D_PUSH_ERRORS
, "ERROR: Failedo‡pply…ush options");

2081  
çl£
;

2086 ià(
c
->
İtiÚs
.
up_d–ay
 || 
	`PULL_DEFINED
(&c->options))

2088 
c
->
c2
.
did_İ’_tun
 = 
	`do_İ’_tun
(c);

2089 
	`upd©e_time
();

2091 #ià
P2MP


2096 ià(!
c
->
c2
.
did_İ’_tun


2097 && 
	`PULL_DEFINED
(&
c
->
İtiÚs
)

2098 && 
c
->
c1
.
tuÁ­


2099 && 
	`İtiÚs_hash_chªged_Ü_z”o
(&
c
->
c1
.
puÎed_İtiÚs_dige¡_§ve
,

2100 &
c
->
c2
.
puÎed_İtiÚs_dige¡
))

2103 
	`msg
(
M_INFO
, "NOTE: Pulled options changed on„estart, will‚eedo close‡nd„eopen TUN/TAP device.");

2104 
	`do_şo£_tun
(
c
, 
Œue
);

2105 
	`mªagem’t_¦“p
(1);

2106 
c
->
c2
.
did_İ’_tun
 = 
	`do_İ’_tun
(c);

2107 
	`upd©e_time
();

2112 ià(
c
->
c2
.
did_İ’_tun
)

2114 #ià
P2MP


2115 
c
->
c1
.
puÎed_İtiÚs_dige¡_§ve
 = c->
c2
.
puÎed_İtiÚs_dige¡
;

2119 ià((
	`rou‹_Üd”
(è=ğ
ROUTE_AFTER_TUN
è&& 
c
->
İtiÚs
.
rou‹_d–ay_defšed
)

2121 
	`ev’t_timeout_š™
(&
c
->
c2
.
rou‹_wakeup
, c->
İtiÚs
.
rou‹_d–ay
, 
now
);

2122 
	`ev’t_timeout_š™
(&
c
->
c2
.
rou‹_wakeup_expœe
, c->
İtiÚs
.
rou‹_d–ay
 + c->İtiÚs.
rou‹_d–ay_wšdow
, 
now
);

2123 ià(
c
->
c1
.
tuÁ­
)

2125 
	`tun_¡ªdby_š™
(
c
->
c1
.
tuÁ­
);

2130 
	`š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
c
, 0);

2133 ià(
c
->
İtiÚs
.
mode
 =ğ
MODE_POINT_TO_POINT
)

2135 
	`š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
c
, 0);

2138 
c
->
c2
.
do_up_¿n
 = 
Œue
;

2140  
Œue
;

2141 
	}
}

2147 
	$puÎ_³rmissiÚ_mask
(cÚ¡ 
cÚ‹xt
 *
c
)

2149 
æags
 =

2150 
OPT_P_UP


2151 | 
OPT_P_ROUTE_EXTRAS


2152 | 
OPT_P_SOCKBUF


2153 | 
OPT_P_SOCKFLAGS


2154 | 
OPT_P_SETENV


2155 | 
OPT_P_SHAPER


2156 | 
OPT_P_TIMER


2157 | 
OPT_P_COMP


2158 | 
OPT_P_PERSIST


2159 | 
OPT_P_MESSAGES


2160 | 
OPT_P_EXPLICIT_NOTIFY


2161 | 
OPT_P_ECHO


2162 | 
OPT_P_PULL_MODE


2163 | 
OPT_P_PEER_ID
;

2165 ià(!
c
->
İtiÚs
.
rou‹_nİuÎ
)

2167 
æags
 |ğ(
OPT_P_ROUTE
 | 
OPT_P_IPWIN32
);

2170 #ifdeà
ENABLE_CRYPTO


2171 ià(
c
->
İtiÚs
.
nı_’abËd
)

2173 
æags
 |ğ
OPT_P_NCP
;

2177  
æags
;

2178 
	}
}

2183 
boŞ


2184 
	$do_deã¼ed_İtiÚs
(
cÚ‹xt
 *
c
, cÚ¡ 
found
)

2186 ià(
found
 & 
OPT_P_MESSAGES
)

2188 
	`š™_v”b_mu‹
(
c
, 
IVM_LEVEL_1
|
IVM_LEVEL_2
);

2189 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --verb‡nd/or --mute†evel changed");

2191 ià(
found
 & 
OPT_P_TIMER
)

2193 
	`do_š™_tim”s
(
c
, 
Œue
);

2194 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:imers‡nd/orimeouts modified");

2197 #ifdeà
ENABLE_OCC


2198 ià(
found
 & 
OPT_P_EXPLICIT_NOTIFY
)

2200 ià(!
	`´Ùo_is_udp
(
c
->
İtiÚs
.
û
.
´Ùo
è&& c->İtiÚs.û.
ex¶ic™_ex™_nÙifiÿtiÚ
)

2202 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --explicit-exit-notify can only be used with --proto udp");

2203 
c
->
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
 = 0;

2207 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:ƒxplicit‚otify…arm(s) modified");

2212 #ifdeà
USE_COMP


2213 ià(
found
 & 
OPT_P_COMP
)

2215 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: compression…arms modified");

2216 
	`comp_unš™
(
c
->
c2
.
comp_cÚ‹xt
);

2217 
c
->
c2
.
comp_cÚ‹xt
 = 
	`comp_š™
(&c->
İtiÚs
.
comp
);

2221 ià(
found
 & 
OPT_P_SHAPER
)

2223 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:raffic shaperƒnabled");

2224 
	`do_š™_Œaffic_sh­”
(
c
);

2227 ià(
found
 & 
OPT_P_SOCKBUF
)

2229 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --sndbuf/--rcvbuf options modified");

2230 
	`lšk_sock‘_upd©e_bufãr_sizes
(
c
->
c2
.
lšk_sock‘
, c->
İtiÚs
.
rcvbuf
, c->İtiÚs.
¢dbuf
);

2233 ià(
found
 & 
OPT_P_SOCKFLAGS
)

2235 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --socket-flags option modified");

2236 
	`lšk_sock‘_upd©e_æags
(
c
->
c2
.
lšk_sock‘
, c->
İtiÚs
.
sockæags
);

2239 ià(
found
 & 
OPT_P_PERSIST
)

2241 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --persist options modified");

2243 ià(
found
 & 
OPT_P_UP
)

2245 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --ifconfig/up options modified");

2247 ià(
found
 & 
OPT_P_ROUTE
)

2249 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:„oute options modified");

2251 ià(
found
 & 
OPT_P_ROUTE_EXTRAS
)

2253 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:„oute-related options modified");

2255 ià(
found
 & 
OPT_P_IPWIN32
)

2257 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: --ip-win32‡nd/or --dhcp-option options modified");

2259 ià(
found
 & 
OPT_P_SETENV
)

2261 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:ƒnvironment modified");

2264 #ifdeà
ENABLE_CRYPTO


2265 ià(
found
 & 
OPT_P_PEER_ID
)

2267 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:…eer-id set");

2268 
c
->
c2
.
s_muÉi
->
u£_³”_id
 = 
Œue
;

2269 
c
->
c2
.
s_muÉi
->
³”_id
 = c->
İtiÚs
.peer_id;

2270 
	`äame_add_to_exŒa_äame
(&
c
->
c2
.
äame
, +3);

2271 ià(!
c
->
İtiÚs
.
û
.
lšk_mtu_defšed
)

2273 
	`äame_add_to_lšk_mtu
(&
c
->
c2
.
äame
, +3);

2274 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:‡djusting†ink_mtuo %d",

2275 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
));

2279 
	`msg
(
M_WARN
, "OPTIONS IMPORT: WARNING:…eer-id set, but†ink-mtu"

2281 " MTU…robËms", 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame
) );

2286 ià(
c
->
İtiÚs
.
puÎ
)

2288 
s_£ssiÚ
 *
£ssiÚ
 = &
c
->
c2
.
s_muÉi
->£ssiÚ[
TM_ACTIVE
];

2289 ià(
found
 & 
OPT_P_NCP
)

2291 
	`msg
(
D_PUSH
, "OPTIONS IMPORT: data channel crypto options modified");

2293 ià(
c
->
İtiÚs
.
nı_’abËd
)

2295 
	`s_poÜ_mªs_nı
(&
c
->
İtiÚs
, c->
c2
.
s_muÉi
->
»mÙe_ch”Çme
);

2298 ià(!
£ssiÚ
->
key
[
KS_PRIMARY
].
üy±o_İtiÚs
.
key_ùx_bi
.
š™Ÿlized


2299 && !
	`s_£ssiÚ_upd©e_üy±o_·¿ms
(
£ssiÚ
, &
c
->
İtiÚs
, &c->
c2
.
äame
))

2301 
	`msg
(
D_TLS_ERRORS
, "OPTIONS ERROR: failedo import crypto options");

2302  
çl£
;

2306  
Œue
;

2307 
	}
}

2313 
boŞ


2314 
	$do_hŞd
(
hŞdtime
)

2316 #ifdeà
ENABLE_MANAGEMENT


2317 ià(
mªagem’t
)

2320 ià(
	`mªagem’t_hŞd
(
mªagem’t
, 
hŞdtime
))

2322  
Œue
;

2326  
çl£
;

2327 
	}
}

2333 
	$sock‘_»¡¬t_·u£
(
cÚ‹xt
 *
c
)

2335 
£c
 = 2;

2336 
backoff
 = 0;

2338 
c
->
İtiÚs
.
û
.
´Ùo
)

2340 
PROTO_TCP_SERVER
:

2341 
£c
 = 1;

2344 
PROTO_UDP
:

2345 
PROTO_TCP_CLIENT
:

2346 
£c
 = 
c
->
İtiÚs
.
û
.
cÚÃù_»Œy_£cÚds
;

2350 #ifdeà
ENABLE_DEBUG


2351 ià(
	`GREMLIN_CONNECTION_FLOOD_LEVEL
(
c
->
İtiÚs
.
g»mlš
))

2353 
£c
 = 0;

2357 #ià
P2MP


2358 ià(
	`auth_»Œy_g‘
(è=ğ
AR_NOINTERACT
)

2360 
£c
 = 10;

2365 ià(
c
->
İtiÚs
.
û
.
´Ùo
 !ğ
PROTO_TCP_SERVER
)

2367 
backoff
 = (
c
->
İtiÚs
.
unsucûssful_©‹m±s
 / c->İtiÚs.
cÚÃùiÚ_li¡
->
Ën
) - 4;

2368 ià(
backoff
 > 0)

2371 
£c
 = 
	`max_št
(£c, 1è<< 
	`mš_št
(
backoff
, 15);

2374 ià(
£c
 > 
c
->
İtiÚs
.
û
.
cÚÃù_»Œy_£cÚds_max
)

2376 
£c
 = 
c
->
İtiÚs
.
û
.
cÚÃù_»Œy_£cÚds_max
;

2380 ià(
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 > 0 && c->³rsi¡.»¡¬t_¦“p_£cÚd > 
£c
)

2382 
£c
 = 
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
;

2384 ià(
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 == -1)

2386 
£c
 = 0;

2388 
c
->
³rsi¡
.
»¡¬t_¦“p_£cÚds
 = 0;

2391 ià(
	`do_hŞd
(
£c
))

2393 
£c
 = 0;

2396 ià(
£c
)

2398 
	`msg
(
D_RESTART
, "Re¡¬ˆ·u£, %d secÚd(s)", 
£c
);

2399 
	`mªagem’t_¦“p
(
£c
);

2401 
	}
}

2407 
	$do_¡¬tup_·u£
(
cÚ‹xt
 *
c
)

2409 ià(!
c
->
fœ¡_time
)

2411 
	`sock‘_»¡¬t_·u£
(
c
);

2415 
	`do_hŞd
(0);

2417 
	}
}

2423 
	$äame_fš®ize_İtiÚs
(
cÚ‹xt
 *
c
, cÚ¡ 
İtiÚs
 *
o
)

2425 ià(!
o
)

2427 
o
 = &
c
->
İtiÚs
;

2434 ià(!
	`CIPHER_ENABLED
(
c
))

2436 
	`äame_®ign_to_exŒa_äame
(&
c
->
c2
.
äame
);

2437 
	`äame_Ü_®ign_æags
(&
c
->
c2
.
äame
,

2438 
FRAME_HEADROOM_MARKER_FRAGMENT


2439 |
FRAME_HEADROOM_MARKER_READ_LINK


2440 |
FRAME_HEADROOM_MARKER_READ_STREAM
);

2443 
	`äame_add_to_exŒa_bufãr
(&
c
->
c2
.
äame
, 
PAYLOAD_ALIGN
);

2444 
	`äame_fš®ize
(&
c
->
c2
.
äame
,

2445 
o
->
û
.
lšk_mtu_defšed
,

2446 
o
->
û
.
lšk_mtu
,

2447 
o
->
û
.
tun_mtu_defšed
,

2448 
o
->
û
.
tun_mtu
);

2449 
	}
}

2455 
	$key_scheduË_ä“
(
key_scheduË
 *
ks
, 
boŞ
 
ä“_s¦_ùx
)

2457 #ifdeà
ENABLE_CRYPTO


2458 
	`ä“_key_ùx_bi
(&
ks
->
¡©ic_key
);

2459 ià(
	`s_ùx_š™Ÿli£d
(&
ks
->
s¦_ùx
è&& 
ä“_s¦_ùx
)

2461 
	`s_ùx_ä“
(&
ks
->
s¦_ùx
);

2462 
	`ä“_key_ùx_bi
(&
ks
->
s_w¿p_key
);

2465 
	`CLEAR
(*
ks
);

2466 
	}
}

2468 #ifdeà
ENABLE_CRYPTO


2471 
	$š™_üy±o_´e
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

2473 ià(
c
->
İtiÚs
.
’gše
)

2475 
	`üy±o_š™_lib_’gše
(
c
->
İtiÚs
.
’gše
);

2478 ià(
æags
 & 
CF_LOAD_PERSISTED_PACKET_ID
)

2481 ià(
c
->
İtiÚs
.
·ck‘_id_fe
)

2483 
	`·ck‘_id_³rsi¡_lßd
(&
c
->
c1
.
pid_³rsi¡
, c->
İtiÚs
.
·ck‘_id_fe
);

2487 #ifdeà
ENABLE_PREDICTION_RESISTANCE


2488 ià(
c
->
İtiÚs
.
u£_´ediùiÚ_»si¡ªû
)

2490 
	`¿nd_ùx_’abË_´ediùiÚ_»si¡ªû
();

2494 
	}
}

2500 
	$do_š™_üy±o_¡©ic
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

2502 cÚ¡ 
İtiÚs
 *İtiÚ ğ&
c
->options;

2503 
	`ASSERT
(
İtiÚs
->
sh¬ed_£ü‘_fe
);

2505 
	`š™_üy±o_´e
(
c
, 
æags
);

2508 ià(
c
->
İtiÚs
.
u£_iv
)

2510 
c
->
c2
.
üy±o_İtiÚs
.
æags
 |ğ
CO_USE_IV
;

2513 ià(
c
->
İtiÚs
.
mu‹_»¶ay_w¬nšgs
)

2515 
c
->
c2
.
üy±o_İtiÚs
.
æags
 |ğ
CO_MUTE_REPLAY_WARNINGS
;

2519 ià(
İtiÚs
->
»¶ay
)

2521 
	`·ck‘_id_š™
(&
c
->
c2
.
üy±o_İtiÚs
.
·ck‘_id
,

2522 
İtiÚs
->
»¶ay_wšdow
,

2523 
İtiÚs
->
»¶ay_time
,

2525 
c
->
c2
.
üy±o_İtiÚs
.
pid_³rsi¡
 = &c->
c1
.pid_persist;

2526 
c
->
c2
.
üy±o_İtiÚs
.
æags
 |ğ
CO_PACKET_ID_LONG_FORM
;

2527 
	`·ck‘_id_³rsi¡_lßd_obj
(&
c
->
c1
.
pid_³rsi¡
,

2528 &
c
->
c2
.
üy±o_İtiÚs
.
·ck‘_id
);

2531 ià(!
	`key_ùx_bi_defšed
(&
c
->
c1
.
ks
.
¡©ic_key
))

2534 
	`š™_key_ty³
(&
c
->
c1
.
ks
.
key_ty³
, 
İtiÚs
->
ch”Çme
, o±iÚs->
authÇme
,

2535 
İtiÚs
->
keysize
, o±iÚs->
‹¡_üy±o
, 
Œue
);

2538 
	`üy±o_»ad_İ’v²_key
(&
c
->
c1
.
ks
.
key_ty³
, &c->c1.ks.
¡©ic_key
,

2539 
İtiÚs
->
sh¬ed_£ü‘_fe
,

2540 
İtiÚs
->
sh¬ed_£ü‘_fe_šlše
,

2541 
İtiÚs
->
key_dœeùiÚ
, "Static Key Encryption",

2546 
	`msg
(
M_INFO
, "Re-using…re-shared static key");

2550 
c
->
c2
.
üy±o_İtiÚs
.
key_ùx_bi
 = c->
c1
.
ks
.
¡©ic_key
;

2553 
	`üy±o_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
,

2554 &
c
->
c1
.
ks
.
key_ty³
,

2555 
İtiÚs
->
u£_iv
, o±iÚs->
»¶ay
, 
Œue
);

2558 
	`check_»¶ay_iv_cÚsi¡’cy
(&
c
->
c1
.
ks
.
key_ty³
, 
İtiÚs
->
»¶ay
,

2559 
İtiÚs
->
u£_iv
);

2560 
	}
}

2567 
	$do_š™_üy±o_s_c1
(
cÚ‹xt
 *
c
)

2569 cÚ¡ 
İtiÚs
 *İtiÚ ğ&
c
->options;

2571 ià(!
	`s_ùx_š™Ÿli£d
(&
c
->
c1
.
ks
.
s¦_ùx
))

2577 
	`š™_s¦
(
İtiÚs
, &(
c
->
c1
.
ks
.
s¦_ùx
));

2578 ià(!
	`s_ùx_š™Ÿli£d
(&
c
->
c1
.
ks
.
s¦_ùx
))

2580 #ià
P2MP


2581 
	`auth_»Œy_g‘
())

2583 
AR_NONE
:

2584 
	`msg
(
M_FATAL
, "Error:…rivate key…assword verification failed");

2587 
AR_INTERACT
:

2588 
	`s¦_purge_auth
(
çl£
);

2590 
AR_NOINTERACT
:

2591 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

2595 
	`ASSERT
(0);

2597 
c
->
sig
->
sigÇl_‹xt
 = "private-key-password-failure";

2600 
	`msg
(
M_FATAL
, "Error:…rivate key…assword verification failed");

2605 
	`š™_key_ty³
(&
c
->
c1
.
ks
.
key_ty³
, 
İtiÚs
->
ch”Çme
, o±iÚs->
authÇme
,

2606 
İtiÚs
->
keysize
, 
Œue
,rue);

2609 
	`´ng_š™
(
İtiÚs
->
´ng_hash
, o±iÚs->
´ng_nÚû_£ü‘_Ën
);

2612 ià(
İtiÚs
->
s_auth_fe
)

2615 
	`CLEAR
(
c
->
c1
.
ks
.
s_auth_key_ty³
);

2616 ià(!
	`¡»q
(
İtiÚs
->
authÇme
, "none"))

2618 
c
->
c1
.
ks
.
s_auth_key_ty³
.
dige¡
 = 
	`md_kt_g‘
(
İtiÚs
->
authÇme
);

2619 
c
->
c1
.
ks
.
s_auth_key_ty³
.
hmac_Ëngth
 =

2620 
	`md_kt_size
(
c
->
c1
.
ks
.
s_auth_key_ty³
.
dige¡
);

2624 
	`msg
(
M_FATAL
, "ERROR:ls-authƒnabled, but‚o valid --auth "

2625 "®gÜ™hm s³cif›d ('%s')", 
İtiÚs
->
authÇme
);

2628 
	`üy±o_»ad_İ’v²_key
(&
c
->
c1
.
ks
.
s_auth_key_ty³
,

2629 &
c
->
c1
.
ks
.
s_w¿p_key
, 
İtiÚs
->
s_auth_fe
,

2630 
İtiÚs
->
s_auth_fe_šlše
, o±iÚs->
key_dœeùiÚ
,

2635 ià(
İtiÚs
->
s_üy±_fe
)

2637 
	`s_üy±_š™_key
(&
c
->
c1
.
ks
.
s_w¿p_key
, 
İtiÚs
->
s_üy±_fe
,

2638 
İtiÚs
->
s_üy±_šlše
, o±iÚs->
s_£rv”
);

2642 ià(
İtiÚs
->
´iv_key_fe_šlše
)

2644 
	`¡ršg_ş—r
(
c
->
İtiÚs
.
´iv_key_fe_šlše
);

2645 
c
->
İtiÚs
.
´iv_key_fe_šlše
 = 
NULL
;

2651 
	`msg
(
D_INIT_MEDIUM
, "Re-using SSL/TLS context");

2653 
	}
}

2656 
	$do_š™_üy±o_s
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

2658 cÚ¡ 
İtiÚs
 *İtiÚ ğ&
c
->options;

2659 
s_İtiÚs
 
to
;

2660 
boŞ
 
·ck‘_id_lÚg_fÜm
;

2662 
	`ASSERT
(
İtiÚs
->
s_£rv”
 || o±iÚs->
s_ş›Á
);

2663 
	`ASSERT
(!
İtiÚs
->
‹¡_üy±o
);

2665 
	`š™_üy±o_´e
(
c
, 
æags
);

2668 
	`ASSERT
(
İtiÚs
->
s_£rv”
 =ğ!İtiÚs->
s_ş›Á
);

2671 
	`do_š™_üy±o_s_c1
(
c
);

2672 ià(
	`IS_SIG
(
c
))

2678 
	`check_»¶ay_iv_cÚsi¡’cy
(&
c
->
c1
.
ks
.
key_ty³
, 
İtiÚs
->
»¶ay
,

2679 
İtiÚs
->
u£_iv
);

2682 
·ck‘_id_lÚg_fÜm
 = 
	`ch”_kt_mode_ofb_cfb
(
c
->
c1
.
ks
.
key_ty³
.
ch”
);

2685 ià(
c
->
İtiÚs
.
puÎ
 || c->İtiÚs.
mode
 =ğ
MODE_SERVER
)

2688 
	`äame_add_to_exŒa_äame
(&
c
->
c2
.
äame
, 
	`üy±o_max_ov”h—d
());

2692 
	`üy±o_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
, &c->
c1
.
ks
.
key_ty³
,

2693 
İtiÚs
->
u£_iv
, o±iÚs->
»¶ay
, 
·ck‘_id_lÚg_fÜm
);

2695 
	`s_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
);

2698 
	`CLEAR
(
to
);

2700 ià(
İtiÚs
->
u£_iv
)

2702 
to
.
üy±o_æags
 |ğ
CO_USE_IV
;

2705 ià(
İtiÚs
->
mu‹_»¶ay_w¬nšgs
)

2707 
to
.
üy±o_æags
 |ğ
CO_MUTE_REPLAY_WARNINGS
;

2710 
to
.
üy±o_æags
 &ğ~(
CO_PACKET_ID_LONG_FORM
);

2711 ià(
·ck‘_id_lÚg_fÜm
)

2713 
to
.
üy±o_æags
 |ğ
CO_PACKET_ID_LONG_FORM
;

2716 
to
.
s¦_ùx
 = 
c
->
c1
.
ks
.ssl_ctx;

2717 
to
.
key_ty³
 = 
c
->
c1
.
ks
.key_type;

2718 
to
.
£rv”
 = 
İtiÚs
->
s_£rv”
;

2719 
to
.
key_m‘hod
 = 
İtiÚs
->key_method;

2720 
to
.
»¶ay
 = 
İtiÚs
->replay;

2721 
to
.
»¶ay_wšdow
 = 
İtiÚs
->replay_window;

2722 
to
.
»¶ay_time
 = 
İtiÚs
->replay_time;

2723 
to
.
tı_mode
 = 
	`lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
İtiÚs
->
û
.
´Ùo
);

2724 
to
.
cÚfig_ch”Çme
 = 
c
->
c1
.
ch”Çme
;

2725 
to
.
cÚfig_authÇme
 = 
c
->
c1
.
authÇme
;

2726 
to
.
nı_’abËd
 = 
İtiÚs
->ncp_enabled;

2727 
to
.
Œªs™iÚ_wšdow
 = 
İtiÚs
->transition_window;

2728 
to
.
hªdshake_wšdow
 = 
İtiÚs
->handshake_window;

2729 
to
.
·ck‘_timeout
 = 
İtiÚs
->
s_timeout
;

2730 
to
.
»ÃgÙŸ‹_by‹s
 = 
İtiÚs
->renegotiate_bytes;

2731 
to
.
»ÃgÙŸ‹_·ck‘s
 = 
İtiÚs
->renegotiate_packets;

2732 
to
.
»ÃgÙŸ‹_£cÚds
 = 
İtiÚs
->renegotiate_seconds;

2733 
to
.
sšgË_£ssiÚ
 = 
İtiÚs
->single_session;

2734 
to
.
mode
 = 
İtiÚs
->mode;

2735 
to
.
puÎ
 = 
İtiÚs
->pull;

2736 #ifdeà
ENABLE_PUSH_PEER_INFO


2737 ià(
İtiÚs
->
push_³”_šfo
)

2739 
to
.
push_³”_šfo_d‘a
 = 2;

2741 ià(
İtiÚs
->
puÎ
)

2743 
to
.
push_³”_šfo_d‘a
 = 1;

2747 
to
.
push_³”_šfo_d‘a
 = 0;

2753 ià(
to
.
£rv”
 && 
İtiÚs
->
û
.
´Ùo
 =ğ
PROTO_TCP_SERVER
)

2755 
to
.
xm™_hŞd
 = 
Œue
;

2758 #ifdeà
ENABLE_OCC


2759 
to
.
di§bË_occ
 = !
İtiÚs
->
occ
;

2762 
to
.
v”ify_commªd
 = 
İtiÚs
->
s_v”ify
;

2763 
to
.
v”ify_expÜt_û¹
 = 
İtiÚs
->
s_expÜt_û¹
;

2764 
to
.
v”ify_x509_ty³
 = (
İtiÚs
->verify_x509_type & 0xff);

2765 
to
.
v”ify_x509_Çme
 = 
İtiÚs
->verify_x509_name;

2766 
to
.
ül_fe
 = 
İtiÚs
->crl_file;

2767 
to
.
ül_fe_šlše
 = 
İtiÚs
->crl_file_inline;

2768 
to
.
s¦_æags
 = 
İtiÚs
->ssl_flags;

2769 
to
.
ns_û¹_ty³
 = 
İtiÚs
->ns_cert_type;

2770 
	`memmove
(
to
.
»mÙe_û¹_ku
, 
İtiÚs
->remote_cert_ku, (to.remote_cert_ku));

2771 
to
.
»mÙe_û¹_eku
 = 
İtiÚs
->remote_cert_eku;

2772 
to
.
v”ify_hash
 = 
İtiÚs
->verify_hash;

2773 
to
.
v”ify_hash_®go
 = 
İtiÚs
->verify_hash_algo;

2774 #ifdeà
ENABLE_X509ALTUSERNAME


2775 
to
.
x509_u£ºame_f›ld
 = (*è
İtiÚs
->x509_username_field;

2777 
to
.
x509_u£ºame_f›ld
 = 
X509_USERNAME_FIELD_DEFAULT
;

2779 
to
.
es
 = 
c
->
c2
.es;

2781 #ifdeà
ENABLE_DEBUG


2782 
to
.
g»mlš
 = 
c
->
İtiÚs
.gremlin;

2785 
to
.
¶ugšs
 = 
c
->plugins;

2787 #ifdeà
MANAGEMENT_DEF_AUTH


2788 
to
.
mda_cÚ‹xt
 = &
c
->
c2
.mda_context;

2791 #ià
P2MP_SERVER


2792 
to
.
auth_u£r_·ss_v”ify_süt
 = 
İtiÚs
->auth_user_pass_verify_script;

2793 
to
.
auth_u£r_·ss_v”ify_süt_vŸ_fe
 = 
İtiÚs
->auth_user_pass_verify_script_via_file;

2794 
to
.
tmp_dœ
 = 
İtiÚs
->tmp_dir;

2795 ià(
İtiÚs
->
ccd_exşusive
)

2797 
to
.
ş›Á_cÚfig_dœ_exşusive
 = 
İtiÚs
->
ş›Á_cÚfig_dœ
;

2799 
to
.
auth_u£r_·ss_fe
 = 
İtiÚs
->auth_user_pass_file;

2800 
to
.
auth_tok’_g’”©e
 = 
İtiÚs
->auth_token_generate;

2801 
to
.
auth_tok’_liãtime
 = 
İtiÚs
->auth_token_lifetime;

2804 
to
.
x509_Œack
 = 
İtiÚs
->x509_track;

2806 #ià
P2MP


2807 #ifdeà
ENABLE_CLIENT_CR


2808 
to
.
sci
 = &
İtiÚs
->
sc_šfo
;

2812 #ifdeà
USE_COMP


2813 
to
.
comp_İtiÚs
 = 
İtiÚs
->
comp
;

2816 #ià
	`defšed
(
ENABLE_CRYPTO_OPENSSL
è&& 
OPENSSL_VERSION_NUMBER
 >= 0x10001000

2817 ià(
İtiÚs
->
keyšg_m©”Ÿl_expÜ‹r_Ïb–
)

2819 
to
.
ekm_size
 = 
İtiÚs
->
keyšg_m©”Ÿl_expÜ‹r_Ëngth
;

2820 ià(
to
.
ekm_size
 < 16 ||o.ekm_size > 4095)

2822 
to
.
ekm_size
 = 0;

2825 
to
.
ekm_Ïb–
 = 
İtiÚs
->
keyšg_m©”Ÿl_expÜ‹r_Ïb–
;

2826 
to
.
ekm_Ïb–_size
 = 
	`¡¾’
Ño.
ekm_Ïb–
);

2830 
to
.
ekm_size
 = 0;

2835 ià(
İtiÚs
->
s_auth_fe
)

2837 
to
.
s_w¿p
.
mode
 = 
TLS_WRAP_AUTH
;

2838 
to
.
s_w¿p
.
İt
.
key_ùx_bi
 = 
c
->
c1
.
ks
.
s_w¿p_key
;

2839 
to
.
s_w¿p
.
İt
.
pid_³rsi¡
 = &
c
->
c1
.pid_persist;

2840 
to
.
s_w¿p
.
İt
.
æags
 |ğ
CO_PACKET_ID_LONG_FORM
;

2841 
	`üy±o_adju¡_äame_·¿m‘”s
(&
to
.
äame
,

2842 &
c
->
c1
.
ks
.
s_auth_key_ty³
,

2843 
çl£
, 
Œue
,rue);

2847 ià(
İtiÚs
->
s_üy±_fe
)

2849 
to
.
s_w¿p
.
mode
 = 
TLS_WRAP_CRYPT
;

2850 
to
.
s_w¿p
.
İt
.
key_ùx_bi
 = 
c
->
c1
.
ks
.
s_w¿p_key
;

2851 
to
.
s_w¿p
.
İt
.
pid_³rsi¡
 = &
c
->
c1
.pid_persist;

2852 
to
.
s_w¿p
.
İt
.
æags
 |ğ
CO_PACKET_ID_LONG_FORM
;

2853 
	`s_üy±_adju¡_äame_·¿m‘”s
(&
to
.
äame
);

2858 
	`sock‘_adju¡_äame_·¿m‘”s
(&
to
.
äame
, 
İtiÚs
->
û
.
´Ùo
);

2863 ià(
æags
 & 
CF_INIT_TLS_MULTI
)

2865 
c
->
c2
.
s_muÉi
 = 
	`s_muÉi_š™
(&
to
);

2868 ià(
æags
 & 
CF_INIT_TLS_AUTH_STANDALONE
)

2870 
c
->
c2
.
s_auth_¡ªd®Úe
 = 
	`s_auth_¡ªd®Úe_š™
(&
to
, &c->c2.
gc
);

2872 
	}
}

2875 
	$do_š™_fš®ize_s_äame
(
cÚ‹xt
 *
c
)

2877 ià(
c
->
c2
.
s_muÉi
)

2879 
	`s_muÉi_š™_fš®ize
(
c
->
c2
.
s_muÉi
, &c->c2.
äame
);

2880 
	`ASSERT
(
	`EXPANDED_SIZE
(&
c
->
c2
.
s_muÉi
->
İt
.
äame
) <=

2881 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
));

2882 
	`äame_´št
(&
c
->
c2
.
s_muÉi
->
İt
.
äame
, 
D_MTU_INFO
,

2885 ià(
c
->
c2
.
s_auth_¡ªd®Úe
)

2887 
	`s_auth_¡ªd®Úe_fš®ize
(
c
->
c2
.
s_auth_¡ªd®Úe
, &c->c2.
äame
);

2888 
	`äame_´št
(&
c
->
c2
.
s_auth_¡ªd®Úe
->
äame
, 
D_MTU_INFO
,

2891 
	}
}

2897 
	$do_š™_üy±o_nÚe
(cÚ¡ 
cÚ‹xt
 *
c
)

2899 
	`ASSERT
(!
c
->
İtiÚs
.
‹¡_üy±o
);

2900 
	`msg
(
M_WARN
,

2905 
	}
}

2909 
	$do_š™_üy±o
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
)

2911 #ifdeà
ENABLE_CRYPTO


2912 ià(
c
->
İtiÚs
.
sh¬ed_£ü‘_fe
)

2914 
	`do_š™_üy±o_¡©ic
(
c
, 
æags
);

2916 ià(
c
->
İtiÚs
.
s_£rv”
 || c->İtiÚs.
s_ş›Á
)

2918 
	`do_š™_üy±o_s
(
c
, 
æags
);

2922 
	`do_š™_üy±o_nÚe
(
c
);

2925 
	`msg
(
M_WARN
,

2926 "******* WARNING *******: " 
PACKAGE_NAME


2929 
	}
}

2932 
	$do_š™_äame
(
cÚ‹xt
 *
c
)

2934 #ifdeà
USE_COMP


2938 ià(
	`comp_’abËd
(&
c
->
İtiÚs
.
comp
))

2940 
	`comp_add_to_exŒa_äame
(&
c
->
c2
.
äame
);

2942 #ià!
	`defšed
(
ENABLE_LZ4
)

2964 ià(
	`comp_unsw­³d_´efix
(&
c
->
İtiÚs
.
comp
è&& 
	`CIPHER_ENABLED
(c))

2966 
	`äame_add_to_®ign_adju¡
(&
c
->
c2
.
äame
, 
COMP_PREFIX_LEN
);

2967 
	`äame_Ü_®ign_æags
(&
c
->
c2
.
äame
,

2968 
FRAME_HEADROOM_MARKER_FRAGMENT


2969 |
FRAME_HEADROOM_MARKER_DECRYPT
);

2973 #ifdeà
ENABLE_FRAGMENT


2974 
	`comp_add_to_exŒa_äame
(&
c
->
c2
.
äame_äagm’t_om™
);

2982 ià(
c
->
İtiÚs
.
û
.
socks_´oxy_£rv”
)

2984 
	`socks_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
, c->
İtiÚs
.
û
.
´Ùo
);

2990 ià(
c
->
İtiÚs
.
û
.
tun_mtu_exŒa_defšed
)

2992 
	`tun_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
, c->
İtiÚs
.
û
.
tun_mtu_exŒa
);

3000 
	`sock‘_adju¡_äame_·¿m‘”s
(&
c
->
c2
.
äame
, c->
İtiÚs
.
û
.
´Ùo
);

3006 
	`äame_fš®ize_İtiÚs
(
c
, 
NULL
);

3008 #ifdeà
USE_COMP


3013 
	`comp_add_to_exŒa_bufãr
(&
c
->
c2
.
äame
);

3014 #ifdeà
ENABLE_FRAGMENT


3015 
	`comp_add_to_exŒa_bufãr
(&
c
->
c2
.
äame_äagm’t_om™
);

3028 
	`äame_add_to_exŒa_lšk
(&
c
->
c2
.
äame
, 3);

3030 #ifdeà
ENABLE_FRAGMENT


3036 
c
->
c2
.
äame_äagm’t
 = c->c2.
äame
;

3037 
	`äame_subŒaù_exŒa
(&
c
->
c2
.
äame_äagm’t
, &c->c2.
äame_äagm’t_om™
);

3040 #ià
	`defšed
(
ENABLE_FRAGMENT
è&& defšed(
ENABLE_OCC
)

3044 ià(
c
->
İtiÚs
.
û
.
äagm’t
 && c->İtiÚs.
mtu_‹¡
)

3046 
	`msg
(
M_WARN
,

3051 #ifdeà
ENABLE_FRAGMENT


3052 ià((
c
->
İtiÚs
.
û
.
mssfix
 || c->İtiÚs.û.
äagm’t
)

3053 && 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame_äagm’t
è!ğ
ETHERNET_MTU
)

3055 
	`msg
(
M_WARN
,

3057 
ETHERNET_MTU
, 
	`TUN_MTU_SIZE
(&
c
->
c2
.
äame_äagm’t
));

3060 
	}
}

3063 
	$do_İtiÚ_w¬nšgs
(
cÚ‹xt
 *
c
)

3065 cÚ¡ 
İtiÚs
 *
o
 = &
c
->options;

3067 ià(
o
->
pšg_£nd_timeout
 && !o->
pšg_»c_timeout
)

3069 
	`msg
(
M_WARN
, "WARNING: --ping should‚ormally be used with --ping-restart or --ping-exit");

3072 ià(
o
->
u£ºame
 || o->
grou²ame
 || o->
chroÙ_dœ


3073 #ifdeà
ENABLE_SELINUX


3074 || 
o
->
£lšux_cÚ‹xt


3078 ià(!
o
->
³rsi¡_tun
)

3080 
	`msg
(
M_WARN
, "WARNING: you‡re using user/group/chroot/setcon without…ersist-tun --his may cause„estartso fail");

3082 ià(!
o
->
³rsi¡_key


3083 #ifdeà
ENABLE_PKCS11


3084 && !
o
->
pkcs11_id


3088 
	`msg
(
M_WARN
, "WARNING: you‡re using user/group/chroot/setcon without…ersist-key --his may cause„estartso fail");

3092 ià(
o
->
chroÙ_dœ
 && !(o->
u£ºame
 && o->
grou²ame
))

3094 
	`msg
(
M_WARN
, "WARNING: you‡re using chroot without specifying user‡nd group --his may causehe chroot jailo be insecure");

3097 #ià
P2MP


3098 ià(
o
->
puÎ
 && o->
ifcÚfig_loÿl
 && 
c
->
fœ¡_time
)

3100 
	`msg
(
M_WARN
, "WARNING: using --pull/--client‡nd --ifconfigogether is…robably‚ot what you want");

3103 #ià
P2MP_SERVER


3104 ià(
o
->
£rv”_bridge_defšed
 | o->
£rv”_bridge_´oxy_dhı
)

3106 
	`msg
(
M_WARN
, "NOTE: when bridging your LAN‡dapter withhe TAP‡dapter,‚otehathe‚ew bridge‡dapter will oftenake on its own IP‡ddresshat is different from whathe LAN‡dapter was…reviously seto");

3109 ià(
o
->
mode
 =ğ
MODE_SERVER
)

3111 ià(
o
->
du¶iÿ‹_ú
 && o->
ş›Á_cÚfig_dœ
)

3113 
	`msg
(
M_WARN
, "WARNING: using --duplicate-cn‡nd --client-config-dirogether is…robably‚ot what you want");

3115 ià(
o
->
du¶iÿ‹_ú
 && o->
ifcÚfig_poŞ_³rsi¡_f’ame
)

3117 
	`msg
(
M_WARN
, "WARNING: --ifconfig-pool-persist will‚ot work with --duplicate-cn");

3119 ià(!
o
->
k“·live_pšg
 || !o->
k“·live_timeout
)

3121 
	`msg
(
M_WARN
, "WARNING: --keepalive option is missing from server config");

3127 #ifdeà
ENABLE_CRYPTO


3128 ià(!
o
->
»¶ay
)

3130 
	`msg
(
M_WARN
, "WARNING: You havdi§bËd R•Ïy PrÙeùiÚ (--no-»¶ayèwhich may mak" 
PACKAGE_NAME
 "†ess secure");

3132 ià(!
o
->
u£_iv
)

3134 
	`msg
(
M_WARN
, "WARNING: You havdi§bËd Cry±ØIV (--no-ivèwhich may mak" 
PACKAGE_NAME
 "†ess secure");

3137 ià(
o
->
s_£rv”
)

3139 
	`w¬n_Ú_u£_of_commÚ_subÃts
();

3141 ià(
o
->
s_ş›Á


3142 && !
o
->
s_v”ify


3143 && 
o
->
v”ify_x509_ty³
 =ğ
VERIFY_X509_NONE


3144 && !(
o
->
ns_û¹_ty³
 & 
NS_CERT_CHECK_SERVER
)

3145 && !
o
->
»mÙe_û¹_eku
)

3147 
	`msg
(
M_WARN
, "WARNING: No server certificate verification method has beenƒnabled. See http://openvpn.net/howto.html#mitm for more info.");

3149 ià(
o
->
ns_û¹_ty³
)

3151 
	`msg
(
M_WARN
, "WARNING: --ns-cert-type is DEPRECATED. Use --remote-cert-tls instead.");

3156 ià(
o
->
u£r_süt_u£d
)

3158 ià(
süt_£cur™y
 >ğ
SSEC_SCRIPTS
)

3160 
	`msg
(
M_WARN
, "NOTE:he current --script-security setting may‡llowhis configurationo call user-defined scripts");

3162 ià(
süt_£cur™y
 >ğ
SSEC_PW_ENV
)

3164 
	`msg
(
M_WARN
, "WARNING:he current --script-security setting may‡llow…asswordso be…assedo scripts viaƒnvironmental variables");

3168 
	`msg
(
M_WARN
, "NOTE: s¹šg w™h " 
PACKAGE_NAME
 " 2.1, '--script-security 2' or higher is„equiredo call user-defined scripts orƒxecutables");

3171 
	}
}

3174 
	$do_š™_äame_s
(
cÚ‹xt
 *
c
)

3176 #ifdeà
ENABLE_CRYPTO


3177 
	`do_š™_fš®ize_s_äame
(
c
);

3179 
	}
}

3181 
cÚ‹xt_bufãrs
 *

3182 
	$š™_cÚ‹xt_bufãrs
(cÚ¡ 
äame
 *frame)

3184 
cÚ‹xt_bufãrs
 *
b
;

3186 
	`ALLOC_OBJ_CLEAR
(
b
, 
cÚ‹xt_bufãrs
);

3188 
b
->
»ad_lšk_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3189 
b
->
»ad_tun_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3191 
b
->
aux_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3193 #ifdeà
ENABLE_CRYPTO


3194 
b
->
’üy±_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3195 
b
->
deüy±_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3198 #ifdeà
USE_COMP


3199 
b
->
com´ess_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3200 
b
->
decom´ess_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

3203  
b
;

3204 
	}
}

3207 
	$ä“_cÚ‹xt_bufãrs
(
cÚ‹xt_bufãrs
 *
b
)

3209 ià(
b
)

3211 
	`ä“_buf
(&
b
->
»ad_lšk_buf
);

3212 
	`ä“_buf
(&
b
->
»ad_tun_buf
);

3213 
	`ä“_buf
(&
b
->
aux_buf
);

3215 #ifdeà
USE_COMP


3216 
	`ä“_buf
(&
b
->
com´ess_buf
);

3217 
	`ä“_buf
(&
b
->
decom´ess_buf
);

3220 #ifdeà
ENABLE_CRYPTO


3221 
	`ä“_buf
(&
b
->
’üy±_buf
);

3222 
	`ä“_buf
(&
b
->
deüy±_buf
);

3225 
	`ä“
(
b
);

3227 
	}
}

3234 
	$do_š™_bufãrs
(
cÚ‹xt
 *
c
)

3236 
c
->
c2
.
bufãrs
 = 
	`š™_cÚ‹xt_bufãrs
(&c->c2.
äame
);

3237 
c
->
c2
.
bufãrs_owÃd
 = 
Œue
;

3238 
	}
}

3240 #ifdeà
ENABLE_FRAGMENT


3246 
	$do_š™_äagm’t
(
cÚ‹xt
 *
c
)

3248 
	`ASSERT
(
c
->
İtiÚs
.
û
.
äagm’t
);

3249 
	`äame_£t_mtu_dyÇmic
(&
c
->
c2
.
äame_äagm’t
,

3250 
c
->
İtiÚs
.
û
.
äagm’t
, 
SET_MTU_UPPER_BOUND
);

3251 
	`äagm’t_äame_š™
(
c
->
c2
.
äagm’t
, &c->c2.
äame_äagm’t
);

3252 
	}
}

3259 
	$do_lšk_sock‘_Ãw
(
cÚ‹xt
 *
c
)

3261 
	`ASSERT
(!
c
->
c2
.
lšk_sock‘
);

3262 
c
->
c2
.
lšk_sock‘
 = 
	`lšk_sock‘_Ãw
();

3263 
c
->
c2
.
lšk_sock‘_owÃd
 = 
Œue
;

3264 
	}
}

3270 
	$do_š™_sock‘_1
(
cÚ‹xt
 *
c
, cÚ¡ 
mode
)

3272 
sockæags
 = 
c
->
İtiÚs
.sockflags;

3274 #ià
PORT_SHARE


3275 ià(
c
->
İtiÚs
.
pÜt_sh¬e_ho¡
 && c->İtiÚs.
pÜt_sh¬e_pÜt
)

3277 
sockæags
 |ğ
SF_PORT_SHARE
;

3281 
	`lšk_sock‘_š™_pha£1
(
c
->
c2
.
lšk_sock‘
,

3282 
c
->
İtiÚs
.
û
.
loÿl
,

3283 
c
->
İtiÚs
.
û
.
loÿl_pÜt
,

3284 
c
->
İtiÚs
.
û
.
»mÙe
,

3285 
c
->
İtiÚs
.
û
.
»mÙe_pÜt
,

3286 
c
->
c1
.
dns_ÿche
,

3287 
c
->
İtiÚs
.
û
.
´Ùo
,

3288 
c
->
İtiÚs
.
û
.
af
,

3289 
c
->
İtiÚs
.
û
.
bšd_v6_Úly
,

3290 
mode
,

3291 
c
->
c2
.
acû±_äom
,

3292 
c
->
c1
.
h‰p_´oxy
,

3293 
c
->
c1
.
socks_´oxy
,

3294 #ifdeà
ENABLE_DEBUG


3295 
c
->
İtiÚs
.
g»mlš
,

3297 
c
->
İtiÚs
.
û
.
bšd_loÿl
,

3298 
c
->
İtiÚs
.
û
.
»mÙe_æßt
,

3299 
c
->
İtiÚs
.
š‘d
,

3300 &
c
->
c1
.
lšk_sock‘_addr
,

3301 
c
->
İtiÚs
.
chªge
,

3302 
c
->
¶ugšs
,

3303 
c
->
İtiÚs
.
»sŞve_»Œy_£cÚds
,

3304 
c
->
İtiÚs
.
û
.
mtu_discov”_ty³
,

3305 
c
->
İtiÚs
.
rcvbuf
,

3306 
c
->
İtiÚs
.
¢dbuf
,

3307 
c
->
İtiÚs
.
m¬k
,

3308 &
c
->
c2
.
£rv”_pŞl_š‹rv®
,

3309 
sockæags
);

3310 
	}
}

3316 
	$do_š™_sock‘_2
(
cÚ‹xt
 *
c
)

3318 
	`lšk_sock‘_š™_pha£2
(
c
->
c2
.
lšk_sock‘
, &c->c2.
äame
,

3319 
c
->
sig
);

3320 
	}
}

3326 
	$do_´št_d©a_chªÃl_mtu_·rms
(
cÚ‹xt
 *
c
)

3328 
	`äame_´št
(&
c
->
c2
.
äame
, 
D_MTU_INFO
, "Data Channel MTU…arms");

3329 #ifdeà
ENABLE_FRAGMENT


3330 ià(
c
->
c2
.
äagm’t
)

3332 
	`äame_´št
(&
c
->
c2
.
äame_äagm’t
, 
D_MTU_INFO
,

3336 
	}
}

3338 #ifdeà
ENABLE_OCC


3343 
	$do_compu‹_occ_¡ršgs
(
cÚ‹xt
 *
c
)

3345 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3347 
c
->
c2
.
İtiÚs_¡ršg_loÿl
 =

3348 
	`İtiÚs_¡ršg
(&
c
->
İtiÚs
, &c->
c2
.
äame
, c->
c1
.
tuÁ­
, 
çl£
, &
gc
);

3349 
c
->
c2
.
İtiÚs_¡ršg_»mÙe
 =

3350 
	`İtiÚs_¡ršg
(&
c
->
İtiÚs
, &c->
c2
.
äame
, c->
c1
.
tuÁ­
, 
Œue
, &
gc
);

3352 
	`msg
(
D_SHOW_OCC
, "Local Options String (VER=%s): '%s'",

3353 
	`İtiÚs_¡ršg_v”siÚ
(
c
->
c2
.
İtiÚs_¡ršg_loÿl
, &
gc
),

3354 
c
->
c2
.
İtiÚs_¡ršg_loÿl
);

3355 
	`msg
(
D_SHOW_OCC
, "Expected Remote Options String (VER=%s): '%s'",

3356 
	`İtiÚs_¡ršg_v”siÚ
(
c
->
c2
.
İtiÚs_¡ršg_»mÙe
, &
gc
),

3357 
c
->
c2
.
İtiÚs_¡ršg_»mÙe
);

3359 #ifdeà
ENABLE_CRYPTO


3360 ià(
c
->
c2
.
s_muÉi
)

3362 
	`s_muÉi_š™_£t_İtiÚs
(
c
->
c2
.
s_muÉi
,

3363 
c
->
c2
.
İtiÚs_¡ršg_loÿl
,

3364 
c
->
c2
.
İtiÚs_¡ršg_»mÙe
);

3368 
	`gc_ä“
(&
gc
);

3369 
	}
}

3378 
	$do_š™_fœ¡_time
(
cÚ‹xt
 *
c
)

3380 ià(
c
->
fœ¡_time
 && !c->
c0
)

3382 
cÚ‹xt_0
 *
c0
;

3384 
	`ALLOC_OBJ_CLEAR_GC
(
c
->
c0
, 
cÚ‹xt_0
, &c->
gc
);

3385 
c0
 = 
c
->c0;

3388 
c0
->
uid_gid_¥ecif›d
 =

3389 
	`¶©fÜm_group_g‘
(
c
->
İtiÚs
.
grou²ame
, &
c0
->
¶©fÜm_¡©e_group
)

3390 |
	`¶©fÜm_u£r_g‘
(
c
->
İtiÚs
.
u£ºame
, &
c0
->
¶©fÜm_¡©e_u£r
);

3393 ià(
c
->
did_we_d«mÚize
 && c->
İtiÚs
.
cd_dœ
 =ğ
NULL
)

3395 
	`¶©fÜm_chdœ
("/");

3399 
	`¶©fÜm_niû
(
c
->
İtiÚs
.
niû
);

3401 
	}
}

3407 
	$do_şo£_check_if_»¡¬t_³rm™‹d
(
cÚ‹xt
 *
c
)

3409 ià(
c
->
İtiÚs
.
š‘d


3410 && (
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGHUP


3411 || 
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
))

3413 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

3414 
	`msg
(
M_INFO
,

3415 
PACKAGE_NAME


3418 
	}
}

3424 
	$do_şo£_ä“_buf
(
cÚ‹xt
 *
c
)

3426 ià(
c
->
c2
.
bufãrs_owÃd
)

3428 
	`ä“_cÚ‹xt_bufãrs
(
c
->
c2
.
bufãrs
);

3429 
c
->
c2
.
bufãrs
 = 
NULL
;

3430 
c
->
c2
.
bufãrs_owÃd
 = 
çl£
;

3432 
	}
}

3438 
	$do_şo£_s
(
cÚ‹xt
 *
c
)

3440 #ifdeà
ENABLE_CRYPTO


3441 ià(
c
->
c2
.
s_muÉi
)

3443 
	`s_muÉi_ä“
(
c
->
c2
.
s_muÉi
, 
Œue
);

3444 
c
->
c2
.
s_muÉi
 = 
NULL
;

3447 #ifdeà
ENABLE_OCC


3449 ià(
c
->
c2
.
İtiÚs_¡ršg_loÿl
)

3451 
	`ä“
(
c
->
c2
.
İtiÚs_¡ršg_loÿl
);

3453 ià(
c
->
c2
.
İtiÚs_¡ršg_»mÙe
)

3455 
	`ä“
(
c
->
c2
.
İtiÚs_¡ršg_»mÙe
);

3457 
c
->
c2
.
İtiÚs_¡ršg_loÿl
 = c->c2.
İtiÚs_¡ršg_»mÙe
 = 
NULL
;

3460 ià(
c
->
c2
.
puÎed_İtiÚs_¡©e
)

3462 
	`md_ùx_ş—nup
(
c
->
c2
.
puÎed_İtiÚs_¡©e
);

3463 
	`md_ùx_ä“
(
c
->
c2
.
puÎed_İtiÚs_¡©e
);

3466 
	}
}

3472 
	$do_şo£_ä“_key_scheduË
(
cÚ‹xt
 *
c
, 
boŞ
 
ä“_s¦_ùx
)

3474 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 && c->
İtiÚs
.
³rsi¡_key
))

3476 
	`key_scheduË_ä“
(&
c
->
c1
.
ks
, 
ä“_s¦_ùx
);

3478 
	}
}

3484 
	$do_şo£_lšk_sock‘
(
cÚ‹xt
 *
c
)

3486 ià(
c
->
c2
.
lšk_sock‘
 && c->c2.
lšk_sock‘_owÃd
)

3488 
	`lšk_sock‘_şo£
(
c
->
c2
.
lšk_sock‘
);

3489 
c
->
c2
.
lšk_sock‘
 = 
NULL
;

3496 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1


3497 && ( (
c
->
İtiÚs
.
³rsi¡_»mÙe_
)

3499 Ğ
c
->
sig
->
sourû
 !ğ
SIG_SOURCE_HARD


3500 && ((
c
->
c1
.
lšk_sock‘_addr
.
cu¼’t_»mÙe
 && c->c1.lšk_sock‘_addr.cu¼’t_»mÙe->
ai_Ãxt
)

3501 || 
c
->
İtiÚs
.
no_advªû
))

3504 
	`ş—r_»mÙe_add¾i¡
(&
c
->
c1
.
lšk_sock‘_addr
, !c->
İtiÚs
.
»sŞve_š_advªû
);

3508 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 && c->
İtiÚs
.
³rsi¡_»mÙe_
))

3510 
	`CLEAR
(
c
->
c1
.
lšk_sock‘_addr
.
aùu®
);

3513 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 && c->
İtiÚs
.
³rsi¡_loÿl_
))

3515 ià(
c
->
c1
.
lšk_sock‘_addr
.
bšd_loÿl
 && !c->
İtiÚs
.
»sŞve_š_advªû
)

3517 
	`ä“addršfo
(
c
->
c1
.
lšk_sock‘_addr
.
bšd_loÿl
);

3520 
c
->
c1
.
lšk_sock‘_addr
.
bšd_loÿl
 = 
NULL
;

3522 
	}
}

3528 
	$do_şo£_·ck‘_id
(
cÚ‹xt
 *
c
)

3530 #ifdeà
ENABLE_CRYPTO


3531 
	`·ck‘_id_ä“
(&
c
->
c2
.
üy±o_İtiÚs
.
·ck‘_id
);

3532 
	`·ck‘_id_³rsi¡_§ve
(&
c
->
c1
.
pid_³rsi¡
);

3533 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
))

3535 
	`·ck‘_id_³rsi¡_şo£
(&
c
->
c1
.
pid_³rsi¡
);

3538 
	}
}

3540 #ifdeà
ENABLE_FRAGMENT


3545 
	$do_şo£_äagm’t
(
cÚ‹xt
 *
c
)

3547 ià(
c
->
c2
.
äagm’t
)

3549 
	`äagm’t_ä“
(
c
->
c2
.
äagm’t
);

3550 
c
->
c2
.
äagm’t
 = 
NULL
;

3552 
	}
}

3560 
	$do_ev’t_£t_š™
(
cÚ‹xt
 *
c
,

3561 
boŞ
 
Ãed_us_timeout
)

3563 
æags
 = 0;

3565 
c
->
c2
.
ev’t_£t_max
 = 
BASE_N_EVENTS
;

3567 
æags
 |ğ
EVENT_METHOD_FAST
;

3569 ià(
Ãed_us_timeout
)

3571 
æags
 |ğ
EVENT_METHOD_US_TIMEOUT
;

3574 
c
->
c2
.
ev’t_£t
 = 
	`ev’t_£t_š™
(&c->c2.
ev’t_£t_max
, 
æags
);

3575 
c
->
c2
.
ev’t_£t_owÃd
 = 
Œue
;

3576 
	}
}

3579 
	$do_şo£_ev’t_£t
(
cÚ‹xt
 *
c
)

3581 ià(
c
->
c2
.
ev’t_£t
 && c->c2.
ev’t_£t_owÃd
)

3583 
	`ev’t_ä“
(
c
->
c2
.
ev’t_£t
);

3584 
c
->
c2
.
ev’t_£t
 = 
NULL
;

3585 
c
->
c2
.
ev’t_£t_owÃd
 = 
çl£
;

3587 
	}
}

3594 
	$do_İ’_¡©us_ouut
(
cÚ‹xt
 *
c
)

3596 ià(!
c
->
c1
.
¡©us_ouut
)

3598 
c
->
c1
.
¡©us_ouut
 = 
	`¡©us_İ’
(c->
İtiÚs
.
¡©us_fe
,

3599 
c
->
İtiÚs
.
¡©us_fe_upd©e_äeq
,

3601 
NULL
,

3602 
STATUS_OUTPUT_WRITE
);

3603 
c
->
c1
.
¡©us_ouut_owÃd
 = 
Œue
;

3605 
	}
}

3608 
	$do_şo£_¡©us_ouut
(
cÚ‹xt
 *
c
)

3610 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
))

3612 ià(
c
->
c1
.
¡©us_ouut_owÃd
 && c->c1.
¡©us_ouut
)

3614 
	`¡©us_şo£
(
c
->
c1
.
¡©us_ouut
);

3615 
c
->
c1
.
¡©us_ouut
 = 
NULL
;

3616 
c
->
c1
.
¡©us_ouut_owÃd
 = 
çl£
;

3619 
	}
}

3625 
	$do_İ’_ifcÚfig_poŞ_³rsi¡
(
cÚ‹xt
 *
c
)

3627 #ià
P2MP_SERVER


3628 ià(!
c
->
c1
.
ifcÚfig_poŞ_³rsi¡
 && c->
İtiÚs
.
ifcÚfig_poŞ_³rsi¡_f’ame
)

3630 
c
->
c1
.
ifcÚfig_poŞ_³rsi¡
 = 
	`ifcÚfig_poŞ_³rsi¡_š™
(c->
İtiÚs
.
ifcÚfig_poŞ_³rsi¡_f’ame
,

3631 
c
->
İtiÚs
.
ifcÚfig_poŞ_³rsi¡_»äesh_äeq
);

3632 
c
->
c1
.
ifcÚfig_poŞ_³rsi¡_owÃd
 = 
Œue
;

3635 
	}
}

3638 
	$do_şo£_ifcÚfig_poŞ_³rsi¡
(
cÚ‹xt
 *
c
)

3640 #ià
P2MP_SERVER


3641 ià(!(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
))

3643 ià(
c
->
c1
.
ifcÚfig_poŞ_³rsi¡
 && c->c1.
ifcÚfig_poŞ_³rsi¡_owÃd
)

3645 
	`ifcÚfig_poŞ_³rsi¡_şo£
(
c
->
c1
.
ifcÚfig_poŞ_³rsi¡
);

3646 
c
->
c1
.
ifcÚfig_poŞ_³rsi¡
 = 
NULL
;

3647 
c
->
c1
.
ifcÚfig_poŞ_³rsi¡_owÃd
 = 
çl£
;

3651 
	}
}

3658 
	$do_šh”™_’v
(
cÚ‹xt
 *
c
, cÚ¡ 
’v_£t
 *
¤c
)

3660 
c
->
c2
.
es
 = 
	`’v_£t_ü—‹
(
NULL
);

3661 
c
->
c2
.
es_owÃd
 = 
Œue
;

3662 
	`’v_£t_šh”™
(
c
->
c2
.
es
, 
¤c
);

3663 
	}
}

3666 
	$do_’v_£t_de¡roy
(
cÚ‹xt
 *
c
)

3668 ià(
c
->
c2
.
es
 && c->c2.
es_owÃd
)

3670 
	`’v_£t_de¡roy
(
c
->
c2
.
es
);

3671 
c
->
c2
.
es
 = 
NULL
;

3672 
c
->
c2
.
es_owÃd
 = 
çl£
;

3674 
	}
}

3685 
	$do_£tup_ç¡_io
(
cÚ‹xt
 *
c
)

3687 ià(
c
->
İtiÚs
.
ç¡_io
)

3689 #ifdeà
_WIN32


3690 
	`msg
(
M_INFO
, "NOTE: --fast-io is disabled since we‡re„unning on Windows");

3692 ià(!
	`´Ùo_is_udp
(
c
->
İtiÚs
.
û
.
´Ùo
))

3694 
	`msg
(
M_INFO
, "NOTE: --fast-io is disabled since we‡re‚ot using UDP");

3698 #ifdeà
ENABLE_FEATURE_SHAPER


3699 ià(
c
->
İtiÚs
.
sh­”
)

3701 
	`msg
(
M_INFO
, "NOTE: --fast-io is disabled since we‡re using --shaper");

3706 
c
->
c2
.
ç¡_io
 = 
Œue
;

3711 
	}
}

3714 
	$do_sigÇl_Ú_s_”rÜs
(
cÚ‹xt
 *
c
)

3716 #ifdeà
ENABLE_CRYPTO


3717 ià(
c
->
İtiÚs
.
s_ex™
)

3719 
c
->
c2
.
s_ex™_sigÇl
 = 
SIGTERM
;

3723 
c
->
c2
.
s_ex™_sigÇl
 = 
SIGUSR1
;

3726 
	}
}

3728 #ifdeà
ENABLE_PLUGIN


3731 
	$š™_¶ugšs
(
cÚ‹xt
 *
c
)

3733 ià(
c
->
İtiÚs
.
¶ugš_li¡
 && !c->
¶ugšs
)

3735 
c
->
¶ugšs
 = 
	`¶ugš_li¡_š™
(c->
İtiÚs
.
¶ugš_li¡
);

3736 
c
->
¶ugšs_owÃd
 = 
Œue
;

3738 
	}
}

3741 
	$İ’_¶ugšs
(
cÚ‹xt
 *
c
, cÚ¡ 
boŞ
 
impÜt_İtiÚs
, 
š™_pošt
)

3743 ià(
c
->
¶ugšs
 && c->
¶ugšs_owÃd
)

3745 ià(
impÜt_İtiÚs
)

3747 
¶ugš_»tuº
 
´
, 
cÚfig
;

3748 
	`¶ugš_»tuº_š™
(&
´
);

3749 
	`¶ugš_li¡_İ’
(
c
->
¶ugšs
, c->
İtiÚs
.
¶ugš_li¡
, &
´
, c->
c2
.
es
, 
š™_pošt
);

3750 
	`¶ugš_»tuº_g‘_cŞumn
(&
´
, &
cÚfig
, "config");

3751 ià(
	`¶ugš_»tuº_defšed
(&
cÚfig
))

3753 
i
;

3754 
i
 = 0; i < 
cÚfig
.
n
; ++i)

3756 
İtiÚ_ty³s_found
 = 0;

3757 ià(
cÚfig
.
li¡
[
i
] && cÚfig.li¡[i]->
v®ue
)

3759 
	`İtiÚs_¡ršg_impÜt
(&
c
->
İtiÚs
,

3760 
cÚfig
.
li¡
[
i
]->
v®ue
,

3761 
D_IMPORT_ERRORS
|
M_OPTERR
,

3762 
OPT_P_DEFAULT
 & ~
OPT_P_PLUGIN
,

3763 &
İtiÚ_ty³s_found
,

3764 
c
->
es
);

3768 
	`¶ugš_»tuº_ä“
(&
´
);

3772 
	`¶ugš_li¡_İ’
(
c
->
¶ugšs
, c->
İtiÚs
.
¶ugš_li¡
, 
NULL
, c->
c2
.
es
, 
š™_pošt
);

3775 
	}
}

3778 
	$do_şo£_¶ugšs
(
cÚ‹xt
 *
c
)

3780 ià(
c
->
¶ugšs
 && c->
¶ugšs_owÃd
 && !(c->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
))

3782 
	`¶ugš_li¡_şo£
(
c
->
¶ugšs
);

3783 
c
->
¶ugšs
 = 
NULL
;

3784 
c
->
¶ugšs_owÃd
 = 
çl£
;

3786 
	}
}

3789 
	$do_šh”™_¶ugšs
(
cÚ‹xt
 *
c
, cÚ¡ cÚ‹xˆ*
¤c
)

3791 ià(!
c
->
¶ugšs
 && 
¤c
->plugins)

3793 
c
->
¶ugšs
 = 
	`¶ugš_li¡_šh”™
(
¤c
->plugins);

3794 
c
->
¶ugšs_owÃd
 = 
Œue
;

3796 
	}
}

3800 #ifdeà
ENABLE_MANAGEMENT


3803 
	$mªagem’t_ÿÎback_¡©us_p2p
(*
¬g
, cÚ¡ 
v”siÚ
, 
¡©us_ouut
 *
so
)

3805 
cÚ‹xt
 *
c
 = (cÚ‹xˆ*è
¬g
;

3806 
	`´št_¡©us
(
c
, 
so
);

3807 
	}
}

3810 
	$mªagem’t_show_Ãt_ÿÎback
(*
¬g
, cÚ¡ 
msgËv–
)

3812 #ifdeà
_WIN32


3813 
	`show_rou‹s
(
msgËv–
);

3814 
	`show_ad­‹rs
(
msgËv–
);

3815 
	`msg
(
msgËv–
, "END");

3817 
	`msg
(
msgËv–
, "ERROR: Sorry,his command is currently only implemented on Windows");

3819 
	}
}

3821 #ifdeà
TARGET_ANDROID


3823 
	$mªagem’t_ÿÎback_ÃtwÜk_chªge
(*
¬g
, 
boŞ
 
§m’‘wÜk
)

3837 
sock‘fd
 = -1;

3838 
cÚ‹xt
 *
c
 = (cÚ‹xˆ*è
¬g
;

3839 ià(!
c
->
c2
.
lšk_sock‘
)

3843 ià(
c
->
c2
.
lšk_sock‘
->
sd
 =ğ
SOCKET_UNDEFINED
)

3848 
sock‘fd
 = 
c
->
c2
.
lšk_sock‘
->
sd
;

3849 ià(!
c
->
İtiÚs
.
puÎ
 || c->
c2
.
s_muÉi
->
u£_³”_id
 || 
§m’‘wÜk
)

3851  
sock‘fd
;

3857 
	}
}

3863 
	$š™_mªagem’t_ÿÎback_p2p
(
cÚ‹xt
 *
c
)

3865 #ifdeà
ENABLE_MANAGEMENT


3866 ià(
mªagem’t
)

3868 
mªagem’t_ÿÎback
 
cb
;

3869 
	`CLEAR
(
cb
);

3870 
cb
.
¬g
 = 
c
;

3871 
cb
.
¡©us
 = 
mªagem’t_ÿÎback_¡©us_p2p
;

3872 
cb
.
show_Ãt
 = 
mªagem’t_show_Ãt_ÿÎback
;

3873 
cb
.
´oxy_cmd
 = 
mªagem’t_ÿÎback_´oxy_cmd
;

3874 
cb
.
»mÙe_cmd
 = 
mªagem’t_ÿÎback_»mÙe_cmd
;

3875 #ifdeà
TARGET_ANDROID


3876 
cb
.
ÃtwÜk_chªge
 = 
mªagem’t_ÿÎback_ÃtwÜk_chªge
;

3878 
	`mªagem’t_£t_ÿÎback
(
mªagem’t
, &
cb
);

3881 
	}
}

3883 #ifdeà
ENABLE_MANAGEMENT


3886 
	$š™_mªagem’t
(
cÚ‹xt
 *
c
)

3888 ià(!
mªagem’t
)

3890 
mªagem’t
 = 
	`mªagem’t_š™
();

3892 
	}
}

3894 
boŞ


3895 
	$İ’_mªagem’t
(
cÚ‹xt
 *
c
)

3898 ià(
mªagem’t
)

3900 ià(
c
->
İtiÚs
.
mªagem’t_addr
)

3902 
æags
 = 
c
->
İtiÚs
.
mªagem’t_æags
;

3903 ià(
c
->
İtiÚs
.
mode
 =ğ
MODE_SERVER
)

3905 
æags
 |ğ
MF_SERVER
;

3907 ià(
	`mªagem’t_İ’
(
mªagem’t
,

3908 
c
->
İtiÚs
.
mªagem’t_addr
,

3909 
c
->
İtiÚs
.
mªagem’t_pÜt
,

3910 
c
->
İtiÚs
.
mªagem’t_u£r_·ss
,

3911 
c
->
İtiÚs
.
mªagem’t_ş›Á_u£r
,

3912 
c
->
İtiÚs
.
mªagem’t_ş›Á_group
,

3913 
c
->
İtiÚs
.
mªagem’t_log_hi¡Üy_ÿche
,

3914 
c
->
İtiÚs
.
mªagem’t_echo_bufãr_size
,

3915 
c
->
İtiÚs
.
mªagem’t_¡©e_bufãr_size
,

3916 
c
->
İtiÚs
.
mªagem’t_wr™e_³”_šfo_fe
,

3917 
c
->
İtiÚs
.
»m­_sigu¤1
,

3918 
æags
))

3920 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

3921 
OPENVPN_STATE_CONNECTING
,

3922 
NULL
,

3923 
NULL
,

3924 
NULL
,

3925 
NULL
,

3926 
NULL
);

3930 
	`do_hŞd
(0);

3931 ià(
	`IS_SIG
(
c
))

3933 
	`msg
(
M_WARN
, "Signal„eceived from management interface,ƒxiting");

3934  
çl£
;

3939 
	`şo£_mªagem’t
();

3942  
Œue
;

3943 
	}
}

3946 
	$şo£_mªagem’t
()

3948 ià(
mªagem’t
)

3950 
	`mªagem’t_şo£
(
mªagem’t
);

3951 
mªagem’t
 = 
NULL
;

3953 
	}
}

3959 
	$unš™_mªagem’t_ÿÎback
()

3961 #ifdeà
ENABLE_MANAGEMENT


3962 ià(
mªagem’t
)

3964 
	`mªagem’t_ş—r_ÿÎback
(
mªagem’t
);

3967 
	}
}

3974 
	$š™_š¡ªû_hªdË_sigÇls
(
cÚ‹xt
 *
c
, cÚ¡ 
’v_£t
 *
’v
, cÚ¡ 
æags
)

3976 
	`´e_š™_sigÇl_ÿtch
();

3977 
	`š™_š¡ªû
(
c
, 
’v
, 
æags
);

3978 
	`po¡_š™_sigÇl_ÿtch
();

3985 ià(
	`IS_SIG
(
c
))

3987 
	`»m­_sigÇl
(
c
);

3988 
	`unš™_mªagem’t_ÿÎback
();

3990 
	}
}

3996 
	$š™_š¡ªû
(
cÚ‹xt
 *
c
, cÚ¡ 
’v_£t
 *
’v
, cÚ¡ 
æags
)

3998 cÚ¡ 
İtiÚs
 *İtiÚ ğ&
c
->options;

3999 cÚ¡ 
boŞ
 
chd
 = (
c
->
mode
 =ğ
CM_CHILD_TCP
 || c->mod=ğ
CM_CHILD_UDP
);

4000 
lšk_sock‘_mode
 = 
LS_MODE_DEFAULT
;

4003 
	`gc_š™
(&
c
->
c2
.
gc
);

4006 ià(
’v
)

4008 
	`do_šh”™_’v
(
c
, 
’v
);

4012 
c
->
sig
->
sigÇl_»ûived
 = 0;

4013 
c
->
sig
->
sigÇl_‹xt
 = 
NULL
;

4014 
c
->
sig
->
sourû
 = 
SIG_SOURCE_SOFT
;

4016 ià(
c
->
mode
 =ğ
CM_P2P
)

4018 
	`š™_mªagem’t_ÿÎback_p2p
(
c
);

4022 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4024 
	`do_¡¬tup_·u£
(
c
);

4025 ià(
	`IS_SIG
(
c
))

4027 
sig
;

4031 ià(
c
->
İtiÚs
.
»sŞve_š_advªû
)

4033 
	`do_´”esŞve
(
c
);

4034 ià(
	`IS_SIG
(
c
))

4036 
sig
;

4041 
	`Ãxt_cÚÃùiÚ_’Œy
(
c
);

4046 ià(
c
->
İtiÚs
.
û
.
´Ùo
 =ğ
PROTO_TCP_SERVER
)

4048 ià(
c
->
mode
 =ğ
CM_TOP
)

4050 
lšk_sock‘_mode
 = 
LS_MODE_TCP_LISTEN
;

4052 ià(
c
->
mode
 =ğ
CM_CHILD_TCP
)

4054 
lšk_sock‘_mode
 = 
LS_MODE_TCP_ACCEPT_FROM
;

4059 ià(
c
->
fœ¡_time
 && 
İtiÚs
->
mlock
)

4061 
	`¶©fÜm_mlock®l
(
Œue
);

4064 #ià
P2MP


4066 ià(
	`auth_»Œy_g‘
(è=ğ
AR_INTERACT
)

4068 
	`š™_qu”y_·sswÜds
(
c
);

4073 
	`š™_v”b_mu‹
(
c
, 
IVM_LEVEL_2
);

4076 ià(
c
->
mode
 =ğ
CM_P2P
)

4078 
	`£t_check_¡©us_”rÜ_d–ay
(
P2P_ERROR_DELAY_MS
);

4082 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4084 
	`do_İtiÚ_w¬nšgs
(
c
);

4087 #ifdeà
ENABLE_PLUGIN


4089 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4091 
	`İ’_¶ugšs
(
c
, 
çl£
, 
OPENVPN_PLUGIN_INIT_PRE_DAEMON
);

4096 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4098 
	`do_£tup_ç¡_io
(
c
);

4102 
	`do_sigÇl_Ú_s_”rÜs
(
c
);

4105 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4107 
	`do_İ’_¡©us_ouut
(
c
);

4111 ià(
c
->
mode
 =ğ
CM_TOP
)

4113 
	`do_İ’_ifcÚfig_poŞ_³rsi¡
(
c
);

4116 #ifdeà
ENABLE_OCC


4118 ià(
c
->
mode
 =ğ
CM_P2P
 || 
chd
)

4120 
c
->
c2
.
occ_İ
 = 
	`occ_»£t_İ
();

4125 ià(
c
->
mode
 =ğ
CM_P2P
)

4127 
	`do_ev’t_£t_š™
(
c
, 
	`SHAPER_DEFINED
(&c->
İtiÚs
));

4129 ià(
c
->
mode
 =ğ
CM_CHILD_TCP
)

4131 
	`do_ev’t_£t_š™
(
c
, 
çl£
);

4135 
	`š™_´oxy
(
c
);

4138 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
 || c->mod=ğ
CM_CHILD_TCP
)

4140 
	`do_lšk_sock‘_Ãw
(
c
);

4143 #ifdeà
ENABLE_FRAGMENT


4145 ià(
İtiÚs
->
û
.
äagm’t
 && (
c
->
mode
 =ğ
CM_P2P
 || 
chd
))

4147 
c
->
c2
.
äagm’t
 = 
	`äagm’t_š™
(&c->c2.
äame
);

4153 
üy±o_æags
 = 0;

4154 ià(
c
->
mode
 =ğ
CM_TOP
)

4156 
üy±o_æags
 = 
CF_INIT_TLS_AUTH_STANDALONE
;

4158 ià(
c
->
mode
 =ğ
CM_P2P
)

4160 
üy±o_æags
 = 
CF_LOAD_PERSISTED_PACKET_ID
 | 
CF_INIT_TLS_MULTI
;

4162 ià(
chd
)

4164 
üy±o_æags
 = 
CF_INIT_TLS_MULTI
;

4166 
	`do_š™_üy±o
(
c
, 
üy±o_æags
);

4167 ià(
	`IS_SIG
(
c
è&& !
chd
)

4169 
sig
;

4173 #ifdeà
USE_COMP


4175 ià(
	`comp_’abËd
(&
İtiÚs
->
comp
è&& (
c
->
mode
 =ğ
CM_P2P
 || 
chd
))

4177 
c
->
c2
.
comp_cÚ‹xt
 = 
	`comp_š™
(&
İtiÚs
->
comp
);

4182 
	`do_š™_äame
(
c
);

4185 
	`do_š™_äame_s
(
c
);

4188 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_CHILD_TCP
)

4190 
	`do_š™_bufãrs
(
c
);

4193 #ifdeà
ENABLE_FRAGMENT


4195 ià(
İtiÚs
->
û
.
äagm’t
 && (
c
->
mode
 =ğ
CM_P2P
 || 
chd
))

4197 
	`do_š™_äagm’t
(
c
);

4202 
	`äame_š™_mssfix
(&
c
->
c2
.
äame
, &c->
İtiÚs
);

4205 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
 || c->mod=ğ
CM_CHILD_TCP
)

4207 
	`do_š™_sock‘_1
(
c
, 
lšk_sock‘_mode
);

4212 ià(!(
İtiÚs
->
up_d–ay
 || 
	`PULL_DEFINED
(İtiÚs)è&& (
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
))

4214 
c
->
c2
.
did_İ’_tun
 = 
	`do_İ’_tun
(c);

4217 
c
->
c2
.
äame_š™Ÿl
 = c->c2.
äame
;

4220 
	`do_´št_d©a_chªÃl_mtu_·rms
(
c
);

4222 #ifdeà
ENABLE_OCC


4224 ià(
c
->
mode
 =ğ
CM_P2P
 || 
chd
)

4226 
	`do_compu‹_occ_¡ršgs
(
c
);

4231 ià(
c
->
mode
 =ğ
CM_P2P
)

4233 
	`do_š™_Œaffic_sh­”
(
c
);

4237 
	`do_š™_fœ¡_time
(
c
);

4239 #ifdeà
ENABLE_PLUGIN


4241 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4243 
	`İ’_¶ugšs
(
c
, 
çl£
, 
OPENVPN_PLUGIN_INIT_POST_DAEMON
);

4248 
	`do_š™_£rv”_pŞl_timeout
(
c
);

4251 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
 || c->mod=ğ
CM_CHILD_TCP
)

4253 
	`do_š™_sock‘_2
(
c
);

4260 
	`do_uid_gid_chroÙ
(
c
, c->
c2
.
did_İ’_tun
);

4263 ià(
c
->
mode
 =ğ
CM_P2P
 || 
chd
)

4265 
	`do_š™_tim”s
(
c
, 
çl£
);

4268 #ifdeà
ENABLE_PLUGIN


4270 ià(
c
->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
)

4272 
	`İ’_¶ugšs
(
c
, 
çl£
, 
OPENVPN_PLUGIN_INIT_POST_UID_CHANGE
);

4276 #ià
PORT_SHARE


4278 ià(
c
->
fœ¡_time
 && (c->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
))

4280 
	`š™_pÜt_sh¬e
(
c
);

4284 #ifdeà
ENABLE_PF


4285 ià(
chd
)

4287 
	`pf_š™_cÚ‹xt
(
c
);

4292 ià(
	`IS_SIG
(
c
))

4294 
sig
;

4299 
sig
:

4300 ià(!
c
->
sig
->
sigÇl_‹xt
)

4302 
c
->
sig
->
sigÇl_‹xt
 = "init_instance";

4304 
	`şo£_cÚ‹xt
(
c
, -1, 
æags
);

4306 
	}
}

4312 
	$şo£_š¡ªû
(
cÚ‹xt
 *
c
)

4315 
	`do_şo£_ev’t_£t
(
c
);

4317 ià(
c
->
mode
 =ğ
CM_P2P


4318 || 
c
->
mode
 =ğ
CM_CHILD_TCP


4319 || 
c
->
mode
 =ğ
CM_CHILD_UDP


4320 || 
c
->
mode
 =ğ
CM_TOP
)

4323 
	`do_şo£_check_if_»¡¬t_³rm™‹d
(
c
);

4325 #ifdeà
USE_COMP


4326 ià(
c
->
c2
.
comp_cÚ‹xt
)

4328 
	`comp_unš™
(
c
->
c2
.
comp_cÚ‹xt
);

4329 
c
->
c2
.
comp_cÚ‹xt
 = 
NULL
;

4334 
	`do_şo£_ä“_buf
(
c
);

4337 
	`do_şo£_s
(
c
);

4340 
	`do_şo£_ä“_key_scheduË
(
c
, (c->
mode
 =ğ
CM_P2P
 || c->mod=ğ
CM_TOP
));

4342 
	`»¡Üe_nı_İtiÚs
(
c
);

4345 
	`do_şo£_lšk_sock‘
(
c
);

4348 
	`do_şo£_tun
(
c
, 
çl£
);

4350 #ifdeà
MANAGEMENT_DEF_AUTH


4351 ià(
mªagem’t
)

4353 
	`mªagem’t_nÙify_ş›Á_şo£
(
mªagem’t
, &
c
->
c2
.
mda_cÚ‹xt
, 
NULL
);

4357 #ifdeà
ENABLE_PF


4358 
	`pf_de¡roy_cÚ‹xt
(&
c
->
c2
.
pf
);

4361 #ifdeà
ENABLE_PLUGIN


4363 
	`do_şo£_¶ugšs
(
c
);

4367 
	`do_şo£_·ck‘_id
(
c
);

4370 
	`do_şo£_¡©us_ouut
(
c
);

4372 #ifdeà
ENABLE_FRAGMENT


4374 
	`do_şo£_äagm’t
(
c
);

4378 
	`do_şo£_ifcÚfig_poŞ_³rsi¡
(
c
);

4381 
	`do_’v_£t_de¡roy
(
c
);

4384 
	`unš™_´oxy
(
c
);

4387 
	`gc_ä“
(&
c
->
c2
.
gc
);

4389 
	}
}

4392 
	$šh”™_cÚ‹xt_chd
(
cÚ‹xt
 *
de¡
,

4393 cÚ¡ 
cÚ‹xt
 *
¤c
)

4395 
	`CLEAR
(*
de¡
);

4398 
de¡
->
mode
 = 
	`´Ùo_is_dg¿m
(
¤c
->
İtiÚs
.
û
.
´Ùo
è? 
CM_CHILD_UDP
 : 
CM_CHILD_TCP
;

4400 
de¡
->
gc
 = 
	`gc_Ãw
();

4402 
	`ALLOC_OBJ_CLEAR_GC
(
de¡
->
sig
, 
sigÇl_šfo
, &de¡->
gc
);

4405 
	`·ck‘_id_³rsi¡_š™
(&
de¡
->
c1
.
pid_³rsi¡
);

4407 #ifdeà
ENABLE_CRYPTO


4408 
de¡
->
c1
.
ks
.
key_ty³
 = 
¤c
->c1.ks.key_type;

4410 
de¡
->
c1
.
ks
.
s¦_ùx
 = 
¤c
->c1.ks.ssl_ctx;

4411 
de¡
->
c1
.
ks
.
s_w¿p_key
 = 
¤c
->c1.ks.tls_wrap_key;

4412 
de¡
->
c1
.
ks
.
s_auth_key_ty³
 = 
¤c
->c1.ks.tls_auth_key_type;

4414 
de¡
->
c1
.
ch”Çme
 = 
¤c
->c1.ciphername;

4415 
de¡
->
c1
.
authÇme
 = 
¤c
->c1.authname;

4416 
de¡
->
c1
.
keysize
 = 
¤c
->c1.keysize;

4420 
de¡
->
İtiÚs
 = 
¤c
->options;

4421 
	`İtiÚs_d‘ach
(&
de¡
->
İtiÚs
);

4423 ià(
de¡
->
mode
 =ğ
CM_CHILD_TCP
)

4429 
de¡
->
c2
.
acû±_äom
 = 
¤c
->c2.
lšk_sock‘
;

4432 #ifdeà
ENABLE_PLUGIN


4434 
	`do_šh”™_¶ugšs
(
de¡
, 
¤c
);

4438 
	`š™_š¡ªû
(
de¡
, 
¤c
->
c2
.
es
, 
CC_NO_CLOSE
 | 
CC_USR1_TO_HUP
);

4439 ià(
	`IS_SIG
(
de¡
))

4445 
de¡
->
c1
.
tuÁ­
 = 
¤c
->c1.tuntap;

4448 ià(
de¡
->
mode
 =ğ
CM_CHILD_UDP
)

4451 
de¡
->
c2
.
bufãrs
 = 
¤c
->c2.buffers;

4454 
de¡
->
c2
.
lšk_sock‘
 = 
¤c
->c2.link_socket;

4456 
	`ALLOC_OBJ_GC
(
de¡
->
c2
.
lšk_sock‘_šfo
, lšk_sock‘_šfo, &de¡->
gc
);

4457 *
de¡
->
c2
.
lšk_sock‘_šfo
 = 
¤c
->c2.
lšk_sock‘
->
šfo
;

4460 
de¡
->
c2
.
lšk_sock‘_šfo
->
l§
 = &de¡->
c1
.
lšk_sock‘_addr
;

4461 
de¡
->
c2
.
lšk_sock‘_šfo
->
cÚÃùiÚ_e¡ablished
 = 
çl£
;

4463 
	}
}

4466 
	$šh”™_cÚ‹xt_tİ
(
cÚ‹xt
 *
de¡
,

4467 cÚ¡ 
cÚ‹xt
 *
¤c
)

4470 *
de¡
 = *
¤c
;

4479 
de¡
->
mode
 = 
CM_TOP_CLONE
;

4481 
de¡
->
fœ¡_time
 = 
çl£
;

4482 
de¡
->
c0
 = 
NULL
;

4484 
	`İtiÚs_d‘ach
(&
de¡
->
İtiÚs
);

4485 
	`gc_d‘ach
(&
de¡
->
gc
);

4486 
	`gc_d‘ach
(&
de¡
->
c2
.
gc
);

4489 
de¡
->
¶ugšs_owÃd
 = 
çl£
;

4491 #ifdeà
ENABLE_CRYPTO


4492 
de¡
->
c2
.
s_muÉi
 = 
NULL
;

4496 
de¡
->
c1
.
tuÁ­_owÃd
 = 
çl£
;

4497 
de¡
->
c1
.
¡©us_ouut_owÃd
 = 
çl£
;

4498 #ià
P2MP_SERVER


4499 
de¡
->
c1
.
ifcÚfig_poŞ_³rsi¡_owÃd
 = 
çl£
;

4503 
de¡
->
c2
.
ev’t_£t_owÃd
 = 
çl£
;

4504 
de¡
->
c2
.
lšk_sock‘_owÃd
 = 
çl£
;

4505 
de¡
->
c2
.
bufãrs_owÃd
 = 
çl£
;

4506 
de¡
->
c2
.
es_owÃd
 = 
çl£
;

4508 
de¡
->
c2
.
ev’t_£t
 = 
NULL
;

4509 ià(
	`´Ùo_is_dg¿m
(
¤c
->
İtiÚs
.
û
.
´Ùo
))

4511 
	`do_ev’t_£t_š™
(
de¡
, 
çl£
);

4514 #ifdeà
USE_COMP


4515 
de¡
->
c2
.
comp_cÚ‹xt
 = 
NULL
;

4517 
	}
}

4520 
	$şo£_cÚ‹xt
(
cÚ‹xt
 *
c
, 
sig
, 
æags
)

4522 
	`ASSERT
(
c
);

4523 
	`ASSERT
(
c
->
sig
);

4525 ià(
sig
 >= 0)

4527 
c
->
sig
->
sigÇl_»ûived
 = sig;

4530 ià(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
)

4532 ià((
æags
 & 
CC_USR1_TO_HUP
)

4533 || (
c
->
sig
->
sourû
 =ğ
SIG_SOURCE_HARD
 && (
æags
 & 
CC_HARD_USR1_TO_HUP
)))

4535 
c
->
sig
->
sigÇl_»ûived
 = 
SIGHUP
;

4536 
c
->
sig
->
sigÇl_‹xt
 = "close_context usr1o hup";

4540 ià(!(
æags
 & 
CC_NO_CLOSE
))

4542 
	`şo£_š¡ªû
(
c
);

4545 ià(
æags
 & 
CC_GC_FREE
)

4547 
	`cÚ‹xt_gc_ä“
(
c
);

4549 
	}
}

4551 #ifdeà
ENABLE_CRYPTO


4558 
	$‹¡_üy±o_th»ad
(*
¬g
)

4560 
cÚ‹xt
 *
c
 = (cÚ‹xˆ*è
¬g
;

4561 cÚ¡ 
İtiÚs
 *İtiÚ ğ&
c
->options;

4563 
	`ASSERT
(
İtiÚs
->
‹¡_üy±o
);

4564 
	`š™_v”b_mu‹
(
c
, 
IVM_LEVEL_1
);

4565 
	`cÚ‹xt_š™_1
(
c
);

4566 
	`Ãxt_cÚÃùiÚ_’Œy
(
c
);

4567 
	`do_š™_üy±o_¡©ic
(
c
, 0);

4569 
	`äame_fš®ize_İtiÚs
(
c
, 
İtiÚs
);

4571 
	`‹¡_üy±o
(&
c
->
c2
.
üy±o_İtiÚs
, &c->c2.
äame
);

4573 
	`key_scheduË_ä“
(&
c
->
c1
.
ks
, 
Œue
);

4574 
	`·ck‘_id_ä“
(&
c
->
c2
.
üy±o_İtiÚs
.
·ck‘_id
);

4576 
	`cÚ‹xt_gc_ä“
(
c
);

4577  
NULL
;

4578 
	}
}

4582 
boŞ


4583 
	$do_‹¡_üy±o
(cÚ¡ 
İtiÚs
 *
o
)

4585 #ifdeà
ENABLE_CRYPTO


4586 ià(
o
->
‹¡_üy±o
)

4588 
cÚ‹xt
 
c
;

4591 
	`msg
(
M_INFO
, "%s", 
t™Ë_¡ršg
);

4593 
	`cÚ‹xt_ş—r
(&
c
);

4594 
c
.
İtiÚs
 = *
o
;

4595 
	`İtiÚs_d‘ach
(&
c
.
İtiÚs
);

4596 
c
.
fœ¡_time
 = 
Œue
;

4597 
	`‹¡_üy±o_th»ad
((*è&
c
);

4598  
Œue
;

4601  
çl£
;

4602 
	}
}

	@init.h

24 #iâdeà
INIT_H


25 
	#INIT_H


	)

27 
	~"İ’v².h
"

33 
	#BASE_N_EVENTS
 4

	)

35 
cÚ‹xt_ş—r
(
cÚ‹xt
 *
c
);

37 
cÚ‹xt_ş—r_1
(
cÚ‹xt
 *
c
);

39 
cÚ‹xt_ş—r_2
(
cÚ‹xt
 *
c
);

41 
cÚ‹xt_š™_1
(
cÚ‹xt
 *
c
);

43 
cÚ‹xt_ş—r_®l_exû±_fœ¡_time
(
cÚ‹xt
 *
c
);

45 
boŞ
 
š™_¡©ic
();

47 
unš™_¡©ic
();

49 
	#IVM_LEVEL_1
 (1<<0)

	)

50 
	#IVM_LEVEL_2
 (1<<1)

	)

51 
š™_v”b_mu‹
(
cÚ‹xt
 *
c
, 
æags
);

53 
š™_İtiÚs_dev
(
İtiÚs
 *options);

55 
boŞ
 
´št_İ’s¦_šfo
(cÚ¡ 
İtiÚs
 *options);

57 
boŞ
 
do_g’key
(cÚ¡ 
İtiÚs
 *options);

59 
boŞ
 
do_³rsi¡_tuÁ­
(cÚ¡ 
İtiÚs
 *options);

61 
boŞ
 
possibly_become_d«mÚ
(cÚ¡ 
İtiÚs
 *options);

63 
´e_£tup
(cÚ¡ 
İtiÚs
 *options);

65 
š™_š¡ªû_hªdË_sigÇls
(
cÚ‹xt
 *
c
, cÚ¡ 
’v_£t
 *
’v
, cÚ¡ 
æags
);

67 
š™_š¡ªû
(
cÚ‹xt
 *
c
, cÚ¡ 
’v_£t
 *
’v
, cÚ¡ 
æags
);

72 
š™_qu”y_·sswÜds
(cÚ¡ 
cÚ‹xt
 *
c
);

74 
do_rou‹
(cÚ¡ 
İtiÚs
 *options,

75 
rou‹_li¡
 *route_list,

76 
rou‹_v6_li¡
 *route_ipv6_list,

77 cÚ¡ 
tuÁ­
 *
‰
,

78 cÚ¡ 
¶ugš_li¡
 *
¶ugšs
,

79 
’v_£t
 *
es
);

81 
şo£_š¡ªû
(
cÚ‹xt
 *
c
);

83 
boŞ
 
do_‹¡_üy±o
(cÚ¡ 
İtiÚs
 *
o
);

85 
cÚ‹xt_gc_ä“
(
cÚ‹xt
 *
c
);

87 
boŞ
 
do_up
(
cÚ‹xt
 *
c
,

88 
boŞ
 
puÎed_İtiÚs
,

89 
İtiÚ_ty³s_found
);

91 
puÎ_³rmissiÚ_mask
(cÚ¡ 
cÚ‹xt
 *
c
);

93 cÚ¡ *
fÜm©_commÚ_Çme
(
cÚ‹xt
 *
c
, 
gc_¬’a
 *
gc
);

95 
»£t_cßr£_tim”s
(
cÚ‹xt
 *
c
);

97 
boŞ
 
do_deã¼ed_İtiÚs
(
cÚ‹xt
 *
c
, cÚ¡ 
found
);

99 
šh”™_cÚ‹xt_chd
(
cÚ‹xt
 *
de¡
,

100 cÚ¡ 
cÚ‹xt
 *
¤c
);

102 
šh”™_cÚ‹xt_tİ
(
cÚ‹xt
 *
de¡
,

103 cÚ¡ 
cÚ‹xt
 *
¤c
);

105 
	#CC_GC_FREE
 (1<<0)

	)

106 
	#CC_USR1_TO_HUP
 (1<<1)

	)

107 
	#CC_HARD_USR1_TO_HUP
 (1<<2)

	)

108 
	#CC_NO_CLOSE
 (1<<3)

	)

110 
şo£_cÚ‹xt
(
cÚ‹xt
 *
c
, 
sig
, 
æags
);

112 
cÚ‹xt_bufãrs
 *
š™_cÚ‹xt_bufãrs
(cÚ¡ 
äame
 *frame);

114 
ä“_cÚ‹xt_bufãrs
(
cÚ‹xt_bufãrs
 *
b
);

116 
	#ISC_ERRORS
 (1<<0)

	)

117 
	#ISC_SERVER
 (1<<1)

	)

118 
š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
cÚ‹xt
 *
c
, cÚ¡ 
æags
);

120 #ifdeà
ENABLE_MANAGEMENT


122 
š™_mªagem’t
(
cÚ‹xt
 *
c
);

124 
boŞ
 
İ’_mªagem’t
(
cÚ‹xt
 *
c
);

126 
şo£_mªagem’t
();

128 
mªagem’t_show_Ãt_ÿÎback
(*
¬g
, cÚ¡ 
msgËv–
);

132 
š™_mªagem’t_ÿÎback_p2p
(
cÚ‹xt
 *
c
);

134 
unš™_mªagem’t_ÿÎback
();

136 #ifdeà
ENABLE_PLUGIN


137 
š™_¶ugšs
(
cÚ‹xt
 *
c
);

139 
İ’_¶ugšs
(
cÚ‹xt
 *
c
, cÚ¡ 
boŞ
 
impÜt_İtiÚs
, 
š™_pošt
);

	@integer.h

24 #iâdeà
INTEGER_H


25 
	#INTEGER_H


	)

27 
	~"”rÜ.h
"

33 
šlše
 

34 
	$max_št
(
x
, 
y
)

36 ià(
x
 > 
y
)

38  
x
;

42  
y
;

44 
	}
}

46 
šlše
 

47 
	$mš_št
(
x
, 
y
)

49 ià(
x
 < 
y
)

51  
x
;

55  
y
;

57 
	}
}

59 
šlše
 

60 
	$cÚ¡¿š_št
(
x
, 
mš
, 
max
)

62 ià(
mš
 > 
max
)

64  
mš
;

66 ià(
x
 < 
mš
)

68  
mš
;

70 ià(
x
 > 
max
)

72  
max
;

76  
x
;

78 
	}
}

90 
šlše
 

91 
	$modulo_subŒaù
(
x
, 
y
, 
mod
)

93 cÚ¡ 
d1
 = 
x
 - 
y
;

94 cÚ¡ 
d2
 = (
x
 > 
y
 ? -
mod
 : modè+ 
d1
;

95 
	`ASSERT
(0 <ğ
x
 && x < 
mod
 && 0 <ğ
y
 && y < mod);

96  
	`abs
(
d1
è>‡bs(
d2
) ? d2 : d1;

97 
	}
}

105 
šlše
 

106 
	$modulo_add
(
x
, 
y
, 
mod
)

108 
sum
 = 
x
 + 
y
;

109 
	`ASSERT
(0 <ğ
x
 && x < 
mod
 && -mod <ğ
y
 && y <= mod);

110 ià(
sum
 >ğ
mod
)

112 
sum
 -ğ
mod
;

114 ià(
sum
 < 0)

116 
sum
 +ğ
mod
;

118  
sum
;

119 
	}
}

125 
šlše
 
size_t


126 
	$adju¡_pow”_of_2
(
size_t
 
u
)

128 
size_t
 
»t
 = 1;

130 
»t
 < 
u
)

132 
»t
 <<= 1;

133 
	`ASSERT
(
»t
 > 0);

136  
»t
;

137 
	}
}

139 
šlše
 

140 
	$šdex_v”ify
(
šdex
, 
size
, cÚ¡ *
fe
, 
lše
)

142 ià(
šdex
 < 0 || index >ğ
size
)

144 
	`msg
(
M_FATAL
, "Assertion Failed: Array index=%d out of bounds for‡rray size=%d in %s:%d",

145 
šdex
,

146 
size
,

147 
fe
,

148 
lše
);

150  
šdex
;

151 
	}
}

	@interval.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"š‹rv®.h
"

34 
	~"memdbg.h
"

37 
	$š‹rv®_š™
(
š‹rv®
 *
tİ
, 
hÜizÚ
, 
»äesh
)

39 
	`CLEAR
(*
tİ
);

40 
tİ
->
»äesh
 =„efresh;

41 
tİ
->
hÜizÚ
 = horizon;

42 
	}
}

44 
boŞ


45 
	$ev’t_timeout_Œigg”
(
ev’t_timeout
 *
‘
,

46 
timev®
 *
tv
,

47 cÚ¡ 
‘_cÚ¡_»Œy
)

49 
boŞ
 
»t
 = 
çl£
;

50 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

52 ià(
‘
->
defšed
)

54 
time_t
 
wakeup
 = 
‘
->
Ï¡
 - 
loÿl_now
 +ƒt->
n
;

55 ià(
wakeup
 <= 0)

57 #ià
INTERVAL_DEBUG


58 
	`dmsg
(
D_INTERVAL
, "EVENTƒv’t_timeout_Œigg” (%dè‘ü=%d", 
‘
->
n
,

59 
‘_cÚ¡_»Œy
);

61 ià(
‘_cÚ¡_»Œy
 < 0)

63 
‘
->
Ï¡
 = 
loÿl_now
;

64 
wakeup
 = 
‘
->
n
;

65 
»t
 = 
Œue
;

69 
wakeup
 = 
‘_cÚ¡_»Œy
;

73 ià(
tv
 && 
wakeup
 <v->
tv_£c
)

75 #ià
INTERVAL_DEBUG


76 
	`dmsg
(
D_INTERVAL
, "EVENTƒvent_timeout_wakeup (%d/%d)ƒtcr=%d",

77 (è
wakeup
, 
‘
->
n
, 
‘_cÚ¡_»Œy
);

79 
tv
->
tv_£c
 = 
wakeup
;

80 
tv
->
tv_u£c
 = 0;

83  
»t
;

84 
	}
}

	@interval.h

30 #iâdeà
INTERVAL_H


31 
	#INTERVAL_H


	)

33 
	~"Ùime.h
"

35 
	#INTERVAL_DEBUG
 0

	)

42 
	sš‹rv®


44 
š‹rv®_t
 
	m»äesh
;

45 
š‹rv®_t
 
	mhÜizÚ
;

46 
time_t
 
	mfutu»_Œigg”
;

47 
time_t
 
	mÏ¡_aùiÚ
;

48 
time_t
 
	mÏ¡_‹¡_Œue
;

51 
š‹rv®_š™
(
š‹rv®
 *
tİ
, 
hÜizÚ
, 
»äesh
);

65 
šlše
 
boŞ


66 
	$š‹rv®_‹¡
(
š‹rv®
 *
tİ
)

68 
boŞ
 
Œigg”
 = 
çl£
;

69 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

71 ià(
tİ
->
futu»_Œigg”
 && 
loÿl_now
 >=op->future_trigger)

73 
Œigg”
 = 
Œue
;

74 
tİ
->
futu»_Œigg”
 = 0;

77 ià(
tİ
->
Ï¡_aùiÚ
 +İ->
hÜizÚ
 > 
loÿl_now


78 || 
tİ
->
Ï¡_‹¡_Œue
 +İ->
»äesh
 <ğ
loÿl_now


79 || 
Œigg”
)

81 
tİ
->
Ï¡_‹¡_Œue
 = 
loÿl_now
;

82 #ià
INTERVAL_DEBUG


83 
	`dmsg
(
D_INTERVAL
, "INTERVAL interval_testrue");

85  
Œue
;

89  
çl£
;

91 
	}
}

93 
šlše
 

94 
	$š‹rv®_scheduË_wakeup
(
š‹rv®
 *
tİ
, 
š‹rv®_t
 *
wakeup
)

96 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

97 
	`š‹rv®_—¾›¡_wakeup
(
wakeup
, 
tİ
->
Ï¡_‹¡_Œue
 +İ->
»äesh
, 
loÿl_now
);

98 
	`š‹rv®_—¾›¡_wakeup
(
wakeup
, 
tİ
->
futu»_Œigg”
, 
loÿl_now
);

99 #ià
INTERVAL_DEBUG


100 
	`dmsg
(
D_INTERVAL
, "INTERVAL iÁ”v®_scheduË wakeup=%d", ()*
wakeup
);

102 
	}
}

107 
šlše
 

108 
	$š‹rv®_futu»_Œigg”
(
š‹rv®
 *
tİ
, 
š‹rv®_t
 
wakeup
)

110 ià(
wakeup
)

112 #ià
INTERVAL_DEBUG


113 
	`dmsg
(
D_INTERVAL
, "INTERVAL iÁ”v®_futu»_Œigg” %d", ()
wakeup
);

115 
tİ
->
futu»_Œigg”
 = 
now
 + 
wakeup
;

117 
	}
}

123 
šlše
 

124 
	$š‹rv®_aùiÚ
(
š‹rv®
 *
tİ
)

126 #ià
INTERVAL_DEBUG


127 
	`dmsg
(
D_INTERVAL
, "INTERVAL‡ction");

129 
tİ
->
Ï¡_aùiÚ
 = 
now
;

130 
	}
}

136 
	sev’t_timeout


138 
boŞ
 
	mdefšed
;

139 
š‹rv®_t
 
	mn
;

140 
time_t
 
	mÏ¡
;

143 
šlše
 
boŞ


144 
	$ev’t_timeout_defšed
(cÚ¡ 
ev’t_timeout
 *
‘
)

146  
‘
->
defšed
;

147 
	}
}

149 
šlše
 

150 
	$ev’t_timeout_ş—r
(
ev’t_timeout
 *
‘
)

152 
‘
->
defšed
 = 
çl£
;

153 
‘
->
n
 = 0;

154 
‘
->
Ï¡
 = 0;

155 
	}
}

157 
šlše
 
ev’t_timeout


158 
	$ev’t_timeout_ş—r_»t
()

160 
ev’t_timeout
 
»t
;

161 
	`ev’t_timeout_ş—r
(&
»t
);

162  
»t
;

163 
	}
}

165 
šlše
 

166 
	$ev’t_timeout_š™
(
ev’t_timeout
 *
‘
, 
š‹rv®_t
 
n
, cÚ¡ 
time_t
 
loÿl_now
)

168 
‘
->
defšed
 = 
Œue
;

169 
‘
->
n
 = (n >= 0) ?‚ : 0;

170 
‘
->
Ï¡
 = 
loÿl_now
;

171 
	}
}

173 
šlše
 

174 
	$ev’t_timeout_»£t
(
ev’t_timeout
 *
‘
)

176 ià(
‘
->
defšed
)

178 
‘
->
Ï¡
 = 
now
;

180 
	}
}

182 
šlše
 

183 
	$ev’t_timeout_modify_wakeup
(
ev’t_timeout
 *
‘
, 
š‹rv®_t
 
n
)

186 ià(
‘
->
defšed
)

188 
‘
->
n
 = (n >= 0) ?‚ : 0;

190 
	}
}

196 
šlše
 
š‹rv®_t


197 
	$ev’t_timeout_»maššg
(
ev’t_timeout
 *
‘
)

199  (
š‹rv®_t
è(
‘
->
Ï¡
 - 
now
 +ƒt->
n
);

200 
	}
}

213 
	#ETT_DEFAULT
 (-1)

	)

215 
boŞ
 
ev’t_timeout_Œigg”
(
ev’t_timeout
 *
‘
,

216 
timev®
 *
tv
,

217 cÚ¡ 
‘_cÚ¡_»Œy
);

223 
	#USEC_TIMER_MAX
 60

	)

225 
	#USEC_TIMER_MAX_USEC
 (
USEC_TIMER_MAX
 * 1000000)

	)

227 
	su£c_tim”
 {

228 
timev®
 
	m¡¬t
;

229 
timev®
 
	m’d
;

232 #ifdeà
HAVE_GETTIMEOFDAY


234 
šlše
 

235 
	$u£c_tim”_¡¬t
(
u£c_tim”
 *
obj
)

237 
	`CLEAR
(*
obj
);

238 
	`İ’v²_g‘timeofday
(&
obj
->
¡¬t
, 
NULL
);

239 
	}
}

241 
šlše
 

242 
	$u£c_tim”_’d
(
u£c_tim”
 *
obj
)

244 
	`İ’v²_g‘timeofday
(&
obj
->
’d
, 
NULL
);

245 
	}
}

249 
šlše
 
boŞ


250 
	$u£c_tim”_š‹rv®_defšed
(
u£c_tim”
 *
obj
)

252  
obj
->
¡¬t
.
tv_£c
 && obj->
’d
.tv_sec;

253 
	}
}

255 
šlše
 

256 
	$u£c_tim”_š‹rv®
(
u£c_tim”
 *
obj
)

258  
	`tv_subŒaù
(&
obj
->
’d
, &obj->
¡¬t
, 
USEC_TIMER_MAX
);

259 
	}
}

	@list.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP_SERVER


34 
	~"š‹g”.h
"

35 
	~"li¡.h
"

36 
	~"misc.h
"

38 
	~"memdbg.h
"

40 
hash
 *

41 
	$hash_š™
(cÚ¡ 
n_buck‘s
,

42 cÚ¡ 
ušt32_t
 
iv
,

43 
	$ušt32_t
 (*
hash_funùiÚ
)(cÚ¡ *
key
, 
ušt32_t
 
iv
),

44 
	$boŞ
 (*
com·»_funùiÚ
)(cÚ¡ *
key1
, cÚ¡ *
key2
))

46 
hash
 *
h
;

47 
i
;

49 
	`ASSERT
(
n_buck‘s
 > 0);

50 
	`ALLOC_OBJ_CLEAR
(
h
, 
hash
);

51 
h
->
n_buck‘s
 = (è
	`adju¡_pow”_of_2
(n_buckets);

52 
h
->
mask
 = h->
n_buck‘s
 - 1;

53 
h
->
hash_funùiÚ
 = hash_function;

54 
h
->
com·»_funùiÚ
 = compare_function;

55 
h
->
iv
 = iv;

56 
	`ALLOC_ARRAY
(
h
->
buck‘s
, 
hash_buck‘
, h->
n_buck‘s
);

57 
i
 = 0; i < 
h
->
n_buck‘s
; ++i)

59 
hash_buck‘
 *
b
 = &
h
->
buck‘s
[
i
];

60 
b
->
li¡
 = 
NULL
;

62  
h
;

63 
	}
}

66 
	$hash_ä“
(
hash
 *hash)

68 
i
;

69 
i
 = 0; i < 
hash
->
n_buck‘s
; ++i)

71 
hash_buck‘
 *
b
 = &
hash
->
buck‘s
[
i
];

72 
hash_–em’t
 *
he
 = 
b
->
li¡
;

74 
he
)

76 
hash_–em’t
 *
Ãxt
 = 
he
->next;

77 
	`ä“
(
he
);

78 
he
 = 
Ãxt
;

81 
	`ä“
(
hash
->
buck‘s
);

82 
	`ä“
(
hash
);

83 
	}
}

85 
hash_–em’t
 *

86 
	$hash_lookup_ç¡
(
hash
 *hash,

87 
hash_buck‘
 *
buck‘
,

88 cÚ¡ *
key
,

89 
ušt32_t
 
hv
)

91 
hash_–em’t
 *
he
;

92 
hash_–em’t
 *
´ev
 = 
NULL
;

94 
he
 = 
buck‘
->
li¡
;

96 
he
)

98 ià(
hv
 =ğ
he
->
hash_v®ue
 && (*
hash
->
com·»_funùiÚ
)(
key
, he->key))

101 ià(
´ev
)

103 
´ev
->
Ãxt
 = 
he
->next;

104 
he
->
Ãxt
 = 
buck‘
->
li¡
;

105 
buck‘
->
li¡
 = 
he
;

107  
he
;

109 
´ev
 = 
he
;

110 
he
 = he->
Ãxt
;

113  
NULL
;

114 
	}
}

116 
boŞ


117 
	$hash_»move_ç¡
(
hash
 *hash,

118 
hash_buck‘
 *
buck‘
,

119 cÚ¡ *
key
,

120 
ušt32_t
 
hv
)

122 
hash_–em’t
 *
he
;

123 
hash_–em’t
 *
´ev
 = 
NULL
;

125 
he
 = 
buck‘
->
li¡
;

127 
he
)

129 ià(
hv
 =ğ
he
->
hash_v®ue
 && (*
hash
->
com·»_funùiÚ
)(
key
, he->key))

131 ià(
´ev
)

133 
´ev
->
Ãxt
 = 
he
->next;

137 
buck‘
->
li¡
 = 
he
->
Ãxt
;

139 
	`ä“
(
he
);

140 --
hash
->
n_–em’ts
;

141  
Œue
;

143 
´ev
 = 
he
;

144 
he
 = he->
Ãxt
;

146  
çl£
;

147 
	}
}

149 
boŞ


150 
	$hash_add
(
hash
 *hash, cÚ¡ *
key
, *
v®ue
, 
boŞ
 
»¶aû
)

152 
ušt32_t
 
hv
;

153 
hash_buck‘
 *
buck‘
;

154 
hash_–em’t
 *
he
;

155 
boŞ
 
»t
 = 
çl£
;

157 
hv
 = 
	`hash_v®ue
(
hash
, 
key
);

158 
buck‘
 = &
hash
->
buck‘s
[
hv
 & hash->
mask
];

160 ià((
he
 = 
	`hash_lookup_ç¡
(
hash
, 
buck‘
, 
key
, 
hv
)))

162 ià(
»¶aû
)

164 
he
->
v®ue
 = value;

165 
»t
 = 
Œue
;

170 
	`hash_add_ç¡
(
hash
, 
buck‘
, 
key
, 
hv
, 
v®ue
);

171 
»t
 = 
Œue
;

174  
»t
;

175 
	}
}

178 
	$hash_»move_by_v®ue
(
hash
 *hash, *
v®ue
)

180 
hash_™”©Ü
 
hi
;

181 
hash_–em’t
 *
he
;

183 
	`hash_™”©Ü_š™
(
hash
, &
hi
);

184 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

186 ià(
he
->
v®ue
 == value)

188 
	`hash_™”©Ü_d–‘e_–em’t
(&
hi
);

191 
	`hash_™”©Ü_ä“
(&
hi
);

192 
	}
}

195 
	$hash_»move_m¬ked
(
hash
 *hash, 
hash_buck‘
 *
buck‘
)

197 
hash_–em’t
 *
´ev
 = 
NULL
;

198 
hash_–em’t
 *
he
 = 
buck‘
->
li¡
;

200 
he
)

202 ià(!
he
->
key
)

204 
hash_–em’t
 *
Ãwhe
;

205 ià(
´ev
)

207 
Ãwhe
 = 
´ev
->
Ãxt
 = 
he
->next;

211 
Ãwhe
 = 
buck‘
->
li¡
 = 
he
->
Ãxt
;

213 
	`ä“
(
he
);

214 --
hash
->
n_–em’ts
;

215 
he
 = 
Ãwhe
;

219 
´ev
 = 
he
;

220 
he
 = he->
Ãxt
;

223 
	}
}

225 
ušt32_t


226 
	$void_±r_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

228  
	`hash_func
((cÚ¡ *)&
key
, (key), 
iv
);

229 
	}
}

231 
boŞ


232 
	$void_±r_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

234  
key1
 =ğ
key2
;

235 
	}
}

238 
	$hash_™”©Ü_š™_¿nge
(
hash
 *hash,

239 
hash_™”©Ü
 *
hi
,

240 
¡¬t_buck‘
,

241 
’d_buck‘
)

243 ià(
’d_buck‘
 > 
hash
->
n_buck‘s
)

245 
’d_buck‘
 = 
hash
->
n_buck‘s
;

248 
	`ASSERT
(
¡¬t_buck‘
 >ğ0 && s¹_buck‘ <ğ
’d_buck‘
);

250 
hi
->
hash
 = hash;

251 
hi
->
–em
 = 
NULL
;

252 
hi
->
buck‘
 = 
NULL
;

253 
hi
->
Ï¡
 = 
NULL
;

254 
hi
->
buck‘_m¬ked
 = 
çl£
;

255 
hi
->
buck‘_šdex_¡¬t
 = 
¡¬t_buck‘
;

256 
hi
->
buck‘_šdex_’d
 = 
’d_buck‘
;

257 
hi
->
buck‘_šdex
 = hi->
buck‘_šdex_¡¬t
 - 1;

258 
	}
}

261 
	$hash_™”©Ü_š™
(
hash
 *hash,

262 
hash_™”©Ü
 *
hi
)

264 
	`hash_™”©Ü_š™_¿nge
(
hash
, 
hi
, 0, hash->
n_buck‘s
);

265 
	}
}

267 
šlše
 

268 
	$hash_™”©Ü_lock
(
hash_™”©Ü
 *
hi
, 
hash_buck‘
 *
b
)

270 
hi
->
buck‘
 = 
b
;

271 
hi
->
Ï¡
 = 
NULL
;

272 
hi
->
buck‘_m¬ked
 = 
çl£
;

273 
	}
}

275 
šlše
 

276 
	$hash_™”©Ü_uÆock
(
hash_™”©Ü
 *
hi
)

278 ià(
hi
->
buck‘
)

280 ià(
hi
->
buck‘_m¬ked
)

282 
	`hash_»move_m¬ked
(
hi
->
hash
, hi->
buck‘
);

283 
hi
->
buck‘_m¬ked
 = 
çl£
;

285 
hi
->
buck‘
 = 
NULL
;

286 
hi
->
Ï¡
 = 
NULL
;

288 
	}
}

290 
šlše
 

291 
	$hash_™”©Ü_advªû
(
hash_™”©Ü
 *
hi
)

293 
hi
->
Ï¡
 = hi->
–em
;

294 
hi
->
–em
 = hi->–em->
Ãxt
;

295 
	}
}

298 
	$hash_™”©Ü_ä“
(
hash_™”©Ü
 *
hi
)

300 
	`hash_™”©Ü_uÆock
(
hi
);

301 
	}
}

303 
hash_–em’t
 *

304 
	$hash_™”©Ü_Ãxt
(
hash_™”©Ü
 *
hi
)

306 
hash_–em’t
 *
»t
 = 
NULL
;

307 ià(
hi
->
–em
)

309 
»t
 = 
hi
->
–em
;

310 
	`hash_™”©Ü_advªû
(
hi
);

314 ++
hi
->
buck‘_šdex
 < hi->
buck‘_šdex_’d
)

316 
hash_buck‘
 *
b
;

317 
	`hash_™”©Ü_uÆock
(
hi
);

318 
b
 = &
hi
->
hash
->
buck‘s
[hi->
buck‘_šdex
];

319 ià(
b
->
li¡
)

321 
	`hash_™”©Ü_lock
(
hi
, 
b
);

322 
hi
->
–em
 = 
b
->
li¡
;

323 ià(
hi
->
–em
)

325 
»t
 = 
hi
->
–em
;

326 
	`hash_™”©Ü_advªû
(
hi
);

332  
»t
;

333 
	}
}

336 
	$hash_™”©Ü_d–‘e_–em’t
(
hash_™”©Ü
 *
hi
)

338 
	`ASSERT
(
hi
->
Ï¡
);

339 
hi
->
Ï¡
->
key
 = 
NULL
;

340 
hi
->
buck‘_m¬ked
 = 
Œue
;

341 
	}
}

344 #ifdeà
LIST_TEST


351 
	swÜd


353 cÚ¡ *
	mwÜd
;

354 
	mn
;

357 
ušt32_t


358 
	$wÜd_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

360 cÚ¡ *
¡r
 = (cÚ¡ *è
key
;

361 cÚ¡ 
Ën
 = 
	`¡¾’
(
¡r
);

362  
	`hash_func
((cÚ¡ 
ušt8_t
 *)
¡r
, 
Ën
, 
iv
);

363 
	}
}

365 
boŞ


366 
	$wÜd_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

368  
	`¡rcmp
((cÚ¡ *)
key1
, (cÚ¡ *)
key2
) == 0;

369 
	}
}

372 
	$´št_nhash
(
hash
 *hash)

374 
hash_™”©Ü
 
hi
;

375 
hash_–em’t
 *
he
;

376 
couÁ
 = 0;

378 
	`hash_™”©Ü_š™
(
hash
, &
hi
, 
Œue
);

380 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

382 
	`´štf
("%d ", (è
he
->
v®ue
);

383 ++
couÁ
;

385 
	`´štf
("\n");

387 
	`hash_™”©Ü_ä“
(&
hi
);

388 
	`ASSERT
(
couÁ
 =ğ
	`hash_n_–em’ts
(
hash
));

389 
	}
}

392 
	$rmhash
(
hash
 *hash, cÚ¡ *
wÜd
)

394 
	`hash_»move
(
hash
, 
wÜd
);

395 
	}
}

398 
	$li¡_‹¡
()

400 
	`İ’v²_th»ad_š™
();

403 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

404 
hash
 *hash = 
	`hash_š™
(10000, 
	`g‘_¿ndom
(), 
wÜd_hash_funùiÚ
, 
wÜd_com·»_funùiÚ
);

405 
hash
 *
nhash
 = 
	`hash_š™
(256, 
	`g‘_¿ndom
(), 
wÜd_hash_funùiÚ
, 
wÜd_com·»_funùiÚ
);

407 
	`´štf
("hash_š™‚_buck‘s=%d mask=0x%08x\n", 
hash
->
n_buck‘s
, hash->
mask
);

410 
Œue
)

412 
buf
[256];

413 
wÜdbuf
[256];

414 
wbi
;

415 
bi
;

416 
c
;

418 ià(!
	`fg‘s
(
buf
, (buf), 
¡dš
))

423 
bi
 = 
wbi
 = 0;

426 
c
 = 
buf
[
bi
++];

427 ià(
	`i§Êum
(
c
) || c == '_')

429 
	`ASSERT
(
wbi
 < (è(
wÜdbuf
));

430 
wÜdbuf
[
wbi
++] = 
c
;

434 ià(
wbi
)

436 
wÜd
 *
w
;

437 
	`ASSERT
(
wbi
 < (è(
wÜdbuf
));

438 
wÜdbuf
[
wbi
++] = '\0';

443 
w
 = (
wÜd
 *è
	`hash_lookup
(
hash
, 
wÜdbuf
);

445 ià(
w
)

448 ++
w
->
n
;

453 
	`ALLOC_OBJ_GC
(
w
, 
wÜd
, &
gc
);

454 
w
->
wÜd
 = 
	`¡ršg_®loc
(
wÜdbuf
, &
gc
);

455 
w
->
n
 = 1;

456 
	`ASSERT
(
	`hash_add
(
hash
, 
w
->
wÜd
, w, 
çl£
));

457 
	`ASSERT
(
	`hash_add
(
nhash
, 
w
->
wÜd
, (*è((
	`¿ndom
(è& 0x0Fè+ 1), 
çl£
));

460 
wbi
 = 0;

462 } 
c
);

468 
	`rmhash
(
hash
, "true");

469 
	`rmhash
(
hash
, "false");

475 
ba£
;

476 
šc
 = 0;

477 
couÁ
 = 0;

479 
ba£
 = 0; ba£ < 
	`hash_n_buck‘s
(
hash
); ba£ +ğ
šc
)

481 
hash_™”©Ü
 
hi
;

482 
hash_–em’t
 *
he
;

483 
šc
 = (
	`g‘_¿ndom
() % 3) + 1;

484 
	`hash_™”©Ü_š™_¿nge
(
hash
, &
hi
, 
Œue
, 
ba£
, ba£ + 
šc
);

486 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

488 
wÜd
 *
w
 = (wÜd *è
he
->
v®ue
;

489 
	`´štf
("%6d '%s'\n", 
w
->
n
, w->
wÜd
);

490 ++
couÁ
;

493 
	`hash_™”©Ü_ä“
(&
hi
);

495 
	`ASSERT
(
couÁ
 =ğ
	`hash_n_–em’ts
(
hash
));

501 
i
;

502 
i
 = 1; i <= 16; ++i)

504 
	`´štf
("[%d] ***********************************\n", 
i
);

505 
	`´št_nhash
(
nhash
);

506 
	`hash_»move_by_v®ue
(
nhash
, (*è
i
, 
Œue
);

508 
	`´štf
("FINAL **************************\n");

509 
	`´št_nhash
(
nhash
);

513 
	`hash_ä“
(
hash
);

514 
	`hash_ä“
(
nhash
);

515 
	`gc_ä“
(&
gc
);

518 
	`İ’v²_th»ad_ş—nup
();

519 
	}
}

588 
	#mix
(
a
,
b
,
c
) \

590 
a
 -ğ
b
;‡ -ğ
c
;‡ ^= (c>>13); \

591 
b
 -ğ
c
; b -ğ
a
; b ^= (a<<8); \

592 
c
 -ğ
a
; c -ğ
b
; c ^= (b>>13); \

593 
a
 -ğ
b
;‡ -ğ
c
;‡ ^= (c>>12); \

594 
b
 -ğ
c
; b -ğ
a
; b ^= (a<<16); \

595 
c
 -ğ
a
; c -ğ
b
; c ^= (b>>5); \

596 
a
 -ğ
b
;‡ -ğ
c
;‡ ^= (c>>3); \

597 
b
 -ğ
c
; b -ğ
a
; b ^= (a<<10); \

598 
c
 -ğ
a
; c -ğ
b
; c ^= (b>>15); \

599 }

	)

601 
ušt32_t


602 
	$hash_func
(cÚ¡ 
ušt8_t
 *
k
, 
ušt32_t
 
Ëngth
, ušt32_ˆ
š™v®
)

604 
ušt32_t
 
a
, 
b
, 
c
, 
Ën
;

607 
Ën
 = 
Ëngth
;

608 
a
 = 
b
 = 0x9e3779b9;

609 
c
 = 
š™v®
;

612 
Ën
 >= 12)

614 
a
 +ğ(
k
[0] + ((
ušt32_t
) k[1] << 8)

615 + ((
ušt32_t
è
k
[2] << 16)

616 + ((
ušt32_t
è
k
[3] << 24));

617 
b
 +ğ(
k
[4] + ((
ušt32_t
) k[5] << 8)

618 + ((
ušt32_t
è
k
[6] << 16)

619 + ((
ušt32_t
è
k
[7] << 24));

620 
c
 +ğ(
k
[8] + ((
ušt32_t
) k[9] << 8)

621 + ((
ušt32_t
è
k
[10] << 16)

622 + ((
ušt32_t
è
k
[11] << 24));

623 
	`mix
(
a
, 
b
, 
c
);

624 
k
 += 12;

625 
Ën
 -= 12;

629 
c
 +ğ
Ëngth
;

630 
Ën
)

633 
c
 +ğ((
ušt32_t
è
k
[10] << 24);

636 
c
 +ğ((
ušt32_t
è
k
[9] << 16);

639 
c
 +ğ((
ušt32_t
è
k
[8] << 8);

643 
b
 +ğ((
ušt32_t
è
k
[7] << 24);

646 
b
 +ğ((
ušt32_t
è
k
[6] << 16);

649 
b
 +ğ((
ušt32_t
è
k
[5] << 8);

652 
b
 +ğ
k
[4];

655 
a
 +ğ((
ušt32_t
è
k
[3] << 24);

658 
a
 +ğ((
ušt32_t
è
k
[2] << 16);

661 
a
 +ğ((
ušt32_t
è
k
[1] << 8);

664 
a
 +ğ
k
[0];

667 
	`mix
(
a
, 
b
, 
c
);

669  
c
;

670 
	}
}

674 
	$dummy
()

676 
	}
}

	@list.h

24 #iâdeà
LIST_H


25 
	#LIST_H


	)

36 #ià
P2MP_SERVER


41 
	~"basic.h
"

42 
	~"bufãr.h
"

44 
	#hashsize
(
n
è((
ušt32_t
)1<<Ò))

	)

45 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

47 
	shash_–em’t


49 *
	mv®ue
;

50 cÚ¡ *
	mkey
;

51 
	mhash_v®ue
;

52 
hash_–em’t
 *
	mÃxt
;

55 
	shash_buck‘


57 
hash_–em’t
 *
	mli¡
;

60 
	shash


62 
	mn_buck‘s
;

63 
	mn_–em’ts
;

64 
	mmask
;

65 
ušt32_t
 
	miv
;

66 
ušt32_t
 (*
hash_funùiÚ
)(cÚ¡ *
	mkey
, ušt32_ˆ
	miv
);

67 
boŞ
 (*
com·»_funùiÚ
)(cÚ¡ *
	mkey1
, cÚ¡ *
	mkey2
);

68 
hash_buck‘
 *
	mbuck‘s
;

71 
hash
 *
hash_š™
(cÚ¡ 
n_buck‘s
,

72 cÚ¡ 
ušt32_t
 
iv
,

73 
	$ušt32_t
 (*
hash_funùiÚ
)(cÚ¡ *
key
, 
ušt32_t
 
iv
),

74 
	$boŞ
 (*
com·»_funùiÚ
)(cÚ¡ *
key1
, cÚ¡ *
key2
));

76 
	`hash_ä“
(
hash
 *hash);

78 
boŞ
 
	`hash_add
(
hash
 *hash, cÚ¡ *
key
, *
v®ue
, boŞ 
»¶aû
);

80 
hash_–em’t
 *
	`hash_lookup_ç¡
(
hash
 *hash,

81 
hash_buck‘
 *
buck‘
,

82 cÚ¡ *
key
,

83 
ušt32_t
 
hv
);

85 
boŞ
 
	`hash_»move_ç¡
(
hash
 *hash,

86 
hash_buck‘
 *
buck‘
,

87 cÚ¡ *
key
,

88 
ušt32_t
 
hv
);

90 
	`hash_»move_by_v®ue
(
hash
 *hash, *
v®ue
);

92 
	shash_™”©Ü


94 
hash
 *hash;

95 
buck‘_šdex
;

96 
hash_buck‘
 *
buck‘
;

97 
hash_–em’t
 *
–em
;

98 
hash_–em’t
 *
Ï¡
;

99 
boŞ
 
buck‘_m¬ked
;

100 
buck‘_šdex_¡¬t
;

101 
buck‘_šdex_’d
;

104 
	`hash_™”©Ü_š™_¿nge
(
hash
 *hash,

105 
hash_™”©Ü
 *
hi
,

106 
¡¬t_buck‘
,

107 
’d_buck‘
);

109 
	`hash_™”©Ü_š™
(
hash
 *hash, 
hash_™”©Ü
 *
™”
);

111 
hash_–em’t
 *
	`hash_™”©Ü_Ãxt
(
hash_™”©Ü
 *
hi
);

113 
	`hash_™”©Ü_d–‘e_–em’t
(
hash_™”©Ü
 *
hi
);

115 
	`hash_™”©Ü_ä“
(
hash_™”©Ü
 *
hi
);

117 
ušt32_t
 
	`hash_func
(cÚ¡ 
ušt8_t
 *
k
, ušt32_ˆ
Ëngth
, ušt32_ˆ
š™v®
);

119 
ušt32_t
 
	`void_±r_hash_funùiÚ
(cÚ¡ *
key
, ušt32_ˆ
iv
);

121 
boŞ
 
	`void_±r_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
);

123 #ifdeà
LIST_TEST


124 
	`li¡_‹¡
();

128 
šlše
 
ušt32_t


129 
	$hash_v®ue
(cÚ¡ 
hash
 *hash, cÚ¡ *
key
)

131  (*
hash
->
hash_funùiÚ
)(
key
, hash->
iv
);

132 
	}
}

134 
šlše
 

135 
	$hash_n_–em’ts
(cÚ¡ 
hash
 *hash)

137  
hash
->
n_–em’ts
;

138 
	}
}

140 
šlše
 

141 
	$hash_n_buck‘s
(cÚ¡ 
hash
 *hash)

143  
hash
->
n_buck‘s
;

144 
	}
}

146 
šlše
 
hash_buck‘
 *

147 
	$hash_buck‘
(
hash
 *hash, 
ušt32_t
 
hv
)

149  &
hash
->
buck‘s
[
hv
 & hash->
mask
];

150 
	}
}

152 
šlše
 *

153 
	$hash_lookup
(
hash
 *hash, cÚ¡ *
key
)

155 *
»t
 = 
NULL
;

156 
hash_–em’t
 *
he
;

157 
ušt32_t
 
hv
 = 
	`hash_v®ue
(
hash
, 
key
);

158 
hash_buck‘
 *
buck‘
 = &
hash
->
buck‘s
[
hv
 & hash->
mask
];

160 
he
 = 
	`hash_lookup_ç¡
(
hash
, 
buck‘
, 
key
, 
hv
);

161 ià(
he
)

163 
»t
 = 
he
->
v®ue
;

166  
»t
;

167 
	}
}

170 
šlše
 

171 
	$hash_add_ç¡
(
hash
 *hash,

172 
hash_buck‘
 *
buck‘
,

173 cÚ¡ *
key
,

174 
ušt32_t
 
hv
,

175 *
v®ue
)

177 
hash_–em’t
 *
he
;

179 
	`ALLOC_OBJ
(
he
, 
hash_–em’t
);

180 
he
->
v®ue
 = value;

181 
he
->
key
 = key;

182 
he
->
hash_v®ue
 = 
hv
;

183 
he
->
Ãxt
 = 
buck‘
->
li¡
;

184 
buck‘
->
li¡
 = 
he
;

185 ++
hash
->
n_–em’ts
;

186 
	}
}

188 
šlše
 
boŞ


189 
	$hash_»move
(
hash
 *hash, cÚ¡ *
key
)

191 
ušt32_t
 
hv
;

192 
hash_buck‘
 *
buck‘
;

193 
boŞ
 
»t
;

195 
hv
 = 
	`hash_v®ue
(
hash
, 
key
);

196 
buck‘
 = &
hash
->
buck‘s
[
hv
 & hash->
mask
];

197 
»t
 = 
	`hash_»move_ç¡
(
hash
, 
buck‘
, 
key
, 
hv
);

198  
»t
;

199 
	}
}

	@lladdr.c

5 #ifdeà
HAVE_CONFIG_H


6 
	~"cÚfig.h
"

7 #–ià
defšed
(
_MSC_VER
)

8 
	~"cÚfig-msvc.h
"

11 
	~"sysh—d.h
"

12 
	~"”rÜ.h
"

13 
	~"misc.h
"

16 
	$£t_Îaddr
(cÚ¡ *
iâame
, cÚ¡ *
Îaddr
,

17 cÚ¡ 
’v_£t
 *
es
)

19 
¬gv
‡rgv = 
	`¬gv_Ãw
();

20 
r
;

22 ià(!
iâame
 || !
Îaddr
)

27 #ià
	`defšed
(
TARGET_LINUX
)

28 #ifdeà
ENABLE_IPROUTE


29 
	`¬gv_´štf
(&
¬gv
,

31 
rou‹_·th
, 
Îaddr
, 
iâame
);

33 
	`¬gv_´štf
(&
¬gv
,

35 
IFCONFIG_PATH
,

36 
iâame
, 
Îaddr
);

38 #–ià
	`defšed
(
TARGET_SOLARIS
)

39 
	`¬gv_´štf
(&
¬gv
,

41 
IFCONFIG_PATH
,

42 
iâame
, 
Îaddr
);

43 #–ià
	`defšed
(
TARGET_OPENBSD
)

44 
	`¬gv_´štf
(&
¬gv
,

46 
IFCONFIG_PATH
,

47 
iâame
, 
Îaddr
);

48 #–ià
	`defšed
(
TARGET_DARWIN
)

49 
	`¬gv_´štf
(&
¬gv
,

51 
IFCONFIG_PATH
,

52 
iâame
, 
Îaddr
);

53 #–ià
	`defšed
(
TARGET_FREEBSD
)

54 
	`¬gv_´štf
(&
¬gv
,

56 
IFCONFIG_PATH
,

57 
iâame
, 
Îaddr
);

59 
	`msg
(
M_WARN
, "Sorry, but I don't know howo configure†ink†ayer‡ddresses onhis operating system.");

63 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

64 
r
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
M_WARN
, "ERROR: Unableo set†ink†ayer‡ddress.");

65 ià(
r
)

67 
	`msg
(
M_INFO
, "TUN/TAP†šk†ay”‡dd»s £ˆtØ%s", 
Îaddr
);

70 
	`¬gv_»£t
(&
¬gv
);

71  
r
;

72 
	}
}

	@lladdr.h

5 
	~"misc.h
"

7 
£t_Îaddr
(cÚ¡ *
iâame
, cÚ¡ *
Îaddr
,

8 cÚ¡ 
’v_£t
 *
es
);

	@lzo.c

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

30 #–ià
defšed
(
_MSC_VER
)

31 
	~"cÚfig-msvc.h
"

34 
	~"sysh—d.h
"

36 #ià
defšed
(
ENABLE_LZO
)

38 
	~"comp.h
"

39 
	~"”rÜ.h
"

40 
	~"Ùime.h
"

42 
	~"memdbg.h
"

51 
boŞ


52 
	$lzo_ad­tive_com´ess_‹¡
(
lzo_ad­tive_com´ess
 *
ac
)

54 cÚ¡ 
boŞ
 
§ve
 = 
ac
->
com´ess_¡©e
;

55 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

57 ià(!
ac
->
com´ess_¡©e
)

59 ià(
loÿl_now
 >ğ
ac
->
Ãxt
)

61 ià(
ac
->
n_tÙ®
 > 
AC_MIN_BYTES


62 && (
ac
->
n_tÙ®
 -‡c->
n_comp
è< (ac->n_tÙ® / (100 / 
AC_SAVE_PCT
)))

64 
ac
->
com´ess_¡©e
 = 
Œue
;

65 
ac
->
Ãxt
 = 
loÿl_now
 + 
AC_OFF_SEC
;

69 
ac
->
Ãxt
 = 
loÿl_now
 + 
AC_SAMP_SEC
;

71 
	`dmsg
(
D_COMP
, "lzo_ad­tive_com´ess_‹¡: comp=%dÙ®=%d", 
ac
->
n_comp
,‡c->
n_tÙ®
);

72 
ac
->
n_tÙ®
 =‡c->
n_comp
 = 0;

77 ià(
loÿl_now
 >ğ
ac
->
Ãxt
)

79 
ac
->
Ãxt
 = 
loÿl_now
 + 
AC_SAMP_SEC
;

80 
ac
->
n_tÙ®
 =‡c->
n_comp
 = 0;

81 
ac
->
com´ess_¡©e
 = 
çl£
;

85 ià(
ac
->
com´ess_¡©e
 !ğ
§ve
)

87 
	`dmsg
(
D_COMP_LOW
, "Ad­tivcom´essiÚ s‹ %s", (
ac
->
com´ess_¡©e
 ? "OFF" : "ON"));

90  !
ac
->
com´ess_¡©e
;

91 
	}
}

93 
šlše
 

94 
	$lzo_ad­tive_com´ess_d©a
(
lzo_ad­tive_com´ess
 *
ac
, 
n_tÙ®
, 
n_comp
)

96 
ac
->
n_tÙ®
 +=‚_total;

97 
ac
->
n_comp
 +=‚_comp;

98 
	}
}

101 
	$lzo_com´ess_š™
(
com´ess_cÚ‹xt
 *
compùx
)

103 
	`msg
(
D_INIT_MEDIUM
, "LZO compression initializing");

104 
	`ASSERT
(!(
compùx
->
æags
 & 
COMP_F_SWAP
));

105 
compùx
->
wu
.
lzo
.
wmem_size
 = 
LZO_WORKSPACE
;

106 ià(
	`lzo_š™
(è!ğ
LZO_E_OK
)

108 
	`msg
(
M_FATAL
, "Cannot initialize LZO compression†ibrary");

110 
compùx
->
wu
.
lzo
.
wmem
 = (
lzo_voidp
è
	`lzo_m®loc
(compùx->wu.lzo.
wmem_size
);

111 
	`check_m®loc_»tuº
(
compùx
->
wu
.
lzo
.
wmem
);

112 
	}
}

115 
	$lzo_com´ess_unš™
(
com´ess_cÚ‹xt
 *
compùx
)

117 
	`lzo_ä“
(
compùx
->
wu
.
lzo
.
wmem
);

118 
compùx
->
wu
.
lzo
.
wmem
 = 
NULL
;

119 
	}
}

121 
šlše
 
boŞ


122 
	$lzo_com´essiÚ_’abËd
(
com´ess_cÚ‹xt
 *
compùx
)

124 ià(
compùx
->
æags
 & 
COMP_F_ASYM
)

126  
çl£
;

130 ià(
compùx
->
æags
 & 
COMP_F_ADAPTIVE
)

132  
	`lzo_ad­tive_com´ess_‹¡
(&
compùx
->
wu
.
lzo
.
ac
);

136  
Œue
;

139 
	}
}

142 
	$lzo_com´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

143 
com´ess_cÚ‹xt
 *
compùx
,

144 cÚ¡ 
äame
 *frame)

146 
lzo_ušt
 
zËn
 = 0;

147 
”r
;

148 
boŞ
 
com´es£d
 = 
çl£
;

150 ià(
buf
->
Ën
 <= 0)

159 ià(
buf
->
Ën
 >ğ
COMPRESS_THRESHOLD
 && 
	`lzo_com´essiÚ_’abËd
(
compùx
))

161 cÚ¡ 
size_t
 
ps
 = 
	`PAYLOAD_SIZE
(
äame
);

162 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

163 
	`ASSERT
(
	`buf_§ã
(&
wÜk
, 
ps
 + 
	`COMP_EXTRA_BUFFER
(ps)));

165 ià(
buf
->
Ën
 > 
ps
)

167 
	`dmsg
(
D_COMP_ERRORS
, "LZO compression buffer overflow");

168 
buf
->
Ën
 = 0;

172 
”r
 = 
	`LZO_COMPRESS
(
	`BPTR
(
buf
), 
	`BLEN
(buf), BPTR(&
wÜk
), &
zËn
, 
compùx
->
wu
.
lzo
.
wmem
);

173 ià(
”r
 !ğ
LZO_E_OK
)

175 
	`dmsg
(
D_COMP_ERRORS
, "LZO com´essiÚƒ¼Ü: %d", 
”r
);

176 
buf
->
Ën
 = 0;

180 
	`ASSERT
(
	`buf_§ã
(&
wÜk
, 
zËn
));

181 
wÜk
.
Ën
 = 
zËn
;

182 
com´es£d
 = 
Œue
;

184 
	`dmsg
(
D_COMP
, "LZO com´es %d -> %d", 
buf
->
Ën
, 
wÜk
.len);

185 
compùx
->
´e_com´ess
 +ğ
buf
->
Ën
;

186 
compùx
->
po¡_com´ess
 +ğ
wÜk
.
Ën
;

189 ià(
compùx
->
æags
 & 
COMP_F_ADAPTIVE
)

191 
	`lzo_ad­tive_com´ess_d©a
(&
compùx
->
wu
.
lzo
.
ac
, 
buf
->
Ën
, 
wÜk
.len);

196 ià(
com´es£d
 && 
wÜk
.
Ën
 < 
buf
->len)

198 
ušt8_t
 *
h—d”
 = 
	`buf_´•’d
(&
wÜk
, 1);

199 *
h—d”
 = 
LZO_COMPRESS_BYTE
;

200 *
buf
 = 
wÜk
;

204 
ušt8_t
 *
h—d”
 = 
	`buf_´•’d
(
buf
, 1);

205 *
h—d”
 = 
NO_COMPRESS_BYTE
;

207 
	}
}

210 
	$lzo_decom´ess
(
bufãr
 *
buf
, bufã¸
wÜk
,

211 
com´ess_cÚ‹xt
 *
compùx
,

212 cÚ¡ 
äame
 *frame)

214 
lzo_ušt
 
zËn
 = 
	`EXPANDED_SIZE
(
äame
);

215 
”r
;

216 
ušt8_t
 
c
;

218 ià(
buf
->
Ën
 <= 0)

223 
	`ASSERT
(
	`buf_š™
(&
wÜk
, 
	`FRAME_HEADROOM
(
äame
)));

225 
c
 = *
	`BPTR
(
buf
);

226 
	`ASSERT
(
	`buf_advªû
(
buf
, 1));

228 ià(
c
 =ğ
LZO_COMPRESS_BYTE
)

230 
	`ASSERT
(
	`buf_§ã
(&
wÜk
, 
zËn
));

231 
”r
 = 
	`LZO_DECOMPRESS
(
	`BPTR
(
buf
), 
	`BLEN
(buf), BPTR(&
wÜk
), &
zËn
,

232 
compùx
->
wu
.
lzo
.
wmem
);

233 ià(
”r
 !ğ
LZO_E_OK
)

235 
	`dmsg
(
D_COMP_ERRORS
, "LZO decom´essiÚƒ¼Ü: %d", 
”r
);

236 
buf
->
Ën
 = 0;

240 
	`ASSERT
(
	`buf_§ã
(&
wÜk
, 
zËn
));

241 
wÜk
.
Ën
 = 
zËn
;

243 
	`dmsg
(
D_COMP
, "LZO decom´es %d -> %d", 
buf
->
Ën
, 
wÜk
.len);

244 
compùx
->
´e_decom´ess
 +ğ
buf
->
Ën
;

245 
compùx
->
po¡_decom´ess
 +ğ
wÜk
.
Ën
;

247 *
buf
 = 
wÜk
;

249 ià(
c
 =ğ
NO_COMPRESS_BYTE
)

254 
	`dmsg
(
D_COMP_ERRORS
, "Bad LZO decom´essiÚ h—d” by‹: %d", 
c
);

255 
buf
->
Ën
 = 0;

257 
	}
}

259 cÚ¡ 
com´ess_®g
 
	glzo_®g
 = {

261 
lzo_com´ess_š™
,

262 
lzo_com´ess_unš™
,

263 
lzo_com´ess
,

264 
lzo_decom´ess


269 
	$dummy
()

271 
	}
}

	@lzo.h

24 #iâdeà
OPENVPN_LZO_H


25 
	#OPENVPN_LZO_H


	)

34 #ià
defšed
(
ENABLE_LZO
)

41 #ià
defšed
(
HAVE_LZO_LZOUTIL_H
)

42 
	~"lzo/lzout.h
"

43 #–ià
defšed
(
HAVE_LZOUTIL_H
)

44 
	~"lzout.h
"

46 #ià
defšed
(
HAVE_LZO_LZO1X_H
)

47 
	~"lzo/lzo1x.h
"

48 #–ià
defšed
(
HAVE_LZO1X_H
)

49 
	~"lzo1x.h
"

52 
	~"bufãr.h
"

53 
	~"mtu.h
"

54 
	~"commÚ.h
"

55 
	~"¡©us.h
"

57 cÚ¡ 
com´ess_®g
 
lzo_®g
;

61 
	#LZO_COMPRESS
 
lzo1x_1_15_com´ess


	)

68 
	#LZO_WORKSPACE
 
LZO1X_1_15_MEM_COMPRESS


	)

72 
	#LZO_DECOMPRESS
 
lzo1x_decom´ess_§ã


	)

87 
	#AC_SAMP_SEC
 2

	)

88 
	#AC_MIN_BYTES
 1000

	)

91 
	#AC_SAVE_PCT
 5

	)

94 
	#AC_OFF_SEC
 60

	)

101 
	slzo_ad­tive_com´ess
 {

102 
boŞ
 
	mcom´ess_¡©e
;

103 
time_t
 
	mÃxt
;

104 
	mn_tÙ®
;

105 
	mn_comp
;

119 
	slzo_com´ess_wÜk¥aû


121 
lzo_voidp
 
	mwmem
;

122 
	mwmem_size
;

123 
lzo_ad­tive_com´ess
 
	mac
;

	@manage.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
ENABLE_MANAGEMENT


34 
	~"”rÜ.h
"

35 
	~"fdmisc.h
"

36 
	~"İtiÚs.h
"

37 
	~"sig.h
"

38 
	~"ev’t.h
"

39 
	~"Ùime.h
"

40 
	~"š‹g”.h
"

41 
	~"misc.h
"

42 
	~"s¦.h
"

43 
	~"commÚ.h
"

44 
	~"mªage.h
"

46 
	~"memdbg.h
"

48 #ifdeà
ENABLE_PKCS11


49 
	~"pkcs11.h
"

52 
	#MANAGEMENT_ECHO_PULL_INFO
 0

	)

54 #ià
MANAGEMENT_ECHO_PULL_INFO


55 
	#MANAGEMENT_ECHO_FLAGS
 
LOG_PRINT_INTVAL


	)

57 
	#MANAGEMENT_ECHO_FLAGS
 0

	)

61 cÚ¡ 
	gbÏnk_up
[] = "[[BLANK]]";

63 
mªagem’t
 *
	gmªagem’t
;

66 
mª_ouut_¡ªd®Úe
(
mªagem’t
 *
mª
, vŞ©*
sigÇl_»ûived
);

68 
mª_»£t_ş›Á_sock‘
(
mªagem’t
 *
mª
, cÚ¡ 
boŞ
 
ex™šg
);

71 
	$mª_h–p
()

73 
	`msg
(
M_CLIENT
, "Mªagem’ˆIÁ”çû fÜ %s", 
t™Ë_¡ršg
);

74 
	`msg
(
M_CLIENT
, "Commands:");

75 
	`msg
(
M_CLIENT
, "auth-retry : Auth failure„etry mode (none,interact,nointeract).");

76 
	`msg
(
M_CLIENT
, "bytecount‚ : Show bytes in/out, updateƒvery‚ secs (0=off).");

77 
	`msg
(
M_CLIENT
, "echo [on|off] [N|all] : Like†og, but only show messages inƒcho buffer.");

78 
	`msg
(
M_CLIENT
, "exit|quit : Close management session.");

79 
	`msg
(
M_CLIENT
, "forget-passwords : Forget…asswordsƒntered so far.");

80 
	`msg
(
M_CLIENT
, "help : Printhis message.");

81 
	`msg
(
M_CLIENT
, "hold [on|off|release] : Set/show hold flago on/off state, or");

82 
	`msg
(
M_CLIENT
, "„elease current hold‡nd startunnel.");

83 
	`msg
(
M_CLIENT
, "kill cn : Killhe client instance(s) having common‚ame cn.");

84 
	`msg
(
M_CLIENT
, "kill IP:port : Killhe client instance connecting from IP:port.");

85 
	`msg
(
M_CLIENT
, "load-stats : Show global server†oad stats.");

86 
	`msg
(
M_CLIENT
, "log [on|off] [N|all] : Turn on/off„ealtime†og display");

87 
	`msg
(
M_CLIENT
, " + show†ast N†ines or 'all' forƒntire history.");

88 
	`msg
(
M_CLIENT
, "mute [n] : Set†og mute†evelo‚, or show†evel if‚ is‡bsent.");

89 
	`msg
(
M_CLIENT
, "needokype‡ction : Enter confirmation for NEED-OK„equest of 'type',");

90 
	`msg
(
M_CLIENT
, " where‡ction = 'ok' or 'cancel'.");

91 
	`msg
(
M_CLIENT
, "needstrype‡ction : Enter confirmation for NEED-STR„equest of 'type',");

92 
	`msg
(
M_CLIENT
, " where‡ction is„eply string.");

93 
	`msg
(
M_CLIENT
, "net : (Windows only) Show‚etwork info‡nd„outingable.");

94 
	`msg
(
M_CLIENT
, "passwordype… : Enter…assword… for‡ queried OpenVPN…assword.");

95 
	`msg
(
M_CLIENT
, "remoteype [host…ort] : Override„emote directive,ype=ACCEPT|MOD|SKIP.");

96 
	`msg
(
M_CLIENT
, "proxyype [host…ort flags] : Enter dynamic…roxy server info.");

97 
	`msg
(
M_CLIENT
, "pid : Show…rocess ID ofhe current OpenVPN…rocess.");

98 #ifdeà
ENABLE_PKCS11


99 
	`msg
(
M_CLIENT
, "pkcs11-id-count : Get‚umber of‡vailable PKCS#11 identities.");

100 
	`msg
(
M_CLIENT
, "pkcs11-id-get index : Get PKCS#11 identity‡t index.");

102 #ifdeà
MANAGEMENT_DEF_AUTH


103 
	`msg
(
M_CLIENT
, "client-auth CID KID : Authenticate client-id/key-id CID/KID (MULTILINE)");

104 
	`msg
(
M_CLIENT
, "client-auth-nt CID KID : Authenticate client-id/key-id CID/KID");

105 
	`msg
(
M_CLIENT
, "client-deny CID KID R [CR] : Deny‡uth client-id/key-id CID/KID with†og„eason");

106 
	`msg
(
M_CLIENT
, "ext R‡nd optional client„easonext CR");

107 
	`msg
(
M_CLIENT
, "client-kill CID [M] : Kill client instance CID with message M (def=RESTART)");

108 
	`msg
(
M_CLIENT
, "env-filter [level] : Setƒnv-var filter†evel");

109 #ifdeà
MANAGEMENT_PF


110 
	`msg
(
M_CLIENT
, "client-pf CID : Define…acket filter for client CID (MULTILINE)");

113 #ifdeà
MANAGMENT_EXTERNAL_KEY


114 
	`msg
(
M_CLIENT
, "rsa-sig : Enter‡n RSA signature in„esponseo >RSA_SIGN challenge");

115 
	`msg
(
M_CLIENT
, " Enter signature base64 on subsequent†ines followed by END");

116 
	`msg
(
M_CLIENT
, "certificate : Enter‡ client certificate in„esponseo >NEED-CERT challenge");

117 
	`msg
(
M_CLIENT
, " Enter certificate base64 on subsequent†ines followed by END");

119 
	`msg
(
M_CLIENT
, "signal s : Send signal so daemon,");

120 
	`msg
(
M_CLIENT
, " s = SIGHUP|SIGTERM|SIGUSR1|SIGUSR2.");

121 
	`msg
(
M_CLIENT
, "state [on|off] [N|all] : Like†og, but show state history.");

122 
	`msg
(
M_CLIENT
, "status [n] : Show current daemon status info using format #n.");

123 
	`msg
(
M_CLIENT
, "test‚ : Produce‚†ines of output foresting/debugging.");

124 
	`msg
(
M_CLIENT
, "usernameype u : Enter username u for‡ queried OpenVPN username.");

125 
	`msg
(
M_CLIENT
, "verb [n] : Set†og verbosity†evelo‚, or show if‚ is‡bsent.");

126 
	`msg
(
M_CLIENT
, "version : Show current version‚umber.");

127 
	`msg
(
M_CLIENT
, "END");

128 
	}
}

131 
	$mª_¡©e_Çme
(cÚ¡ 
¡©e
)

133 
¡©e
)

135 
OPENVPN_STATE_INITIAL
:

138 
OPENVPN_STATE_CONNECTING
:

141 
OPENVPN_STATE_WAIT
:

144 
OPENVPN_STATE_AUTH
:

147 
OPENVPN_STATE_GET_CONFIG
:

150 
OPENVPN_STATE_ASSIGN_IP
:

153 
OPENVPN_STATE_ADD_ROUTES
:

156 
OPENVPN_STATE_CONNECTED
:

159 
OPENVPN_STATE_RECONNECTING
:

162 
OPENVPN_STATE_EXITING
:

165 
OPENVPN_STATE_RESOLVE
:

168 
OPENVPN_STATE_TCP_CONNECT
:

174 
	}
}

177 
	$mª_w–come
(
mªagem’t
 *
mª
)

179 
	`msg
(
M_CLIENT
, ">INFO:OpenVPN Management Interface Version %d --ype 'help' for more info",

180 
MANAGEMENT_VERSION
);

181 ià(
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
)

183 
	`msg
(
M_CLIENT
, "%s", 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
);

185 
	}
}

187 
šlše
 
boŞ


188 
	$mª_·sswÜd_Ãeded
(
mªagem’t
 *
mª
)

190  
mª
->
£‰šgs
.
up
.
defšed
 && !mª->
cÚÃùiÚ
.
·sswÜd_v”if›d
;

191 
	}
}

194 
	$mª_check_·sswÜd
(
mªagem’t
 *
mª
, cÚ¡ *
lše
)

196 ià(
	`mª_·sswÜd_Ãeded
(
mª
))

198 ià(
	`¡»q
(
lše
, 
mª
->
£‰šgs
.
up
.
·sswÜd
))

200 
mª
->
cÚÃùiÚ
.
·sswÜd_v”if›d
 = 
Œue
;

201 
	`msg
(
M_CLIENT
, "SUCCESS:…assword is correct");

202 
	`mª_w–come
(
mª
);

206 
mª
->
cÚÃùiÚ
.
·sswÜd_v”if›d
 = 
çl£
;

207 
	`msg
(
M_CLIENT
, "ERROR: bad…assword");

208 ià(++
mª
->
cÚÃùiÚ
.
·sswÜd_Œ›s
 >ğ
MANAGEMENT_N_PASSWORD_RETRIES
)

210 
	`msg
(
M_WARN
, "MAN: client connection„ejected‡fter %d failed…assword‡ttempts",

211 
MANAGEMENT_N_PASSWORD_RETRIES
);

212 
mª
->
cÚÃùiÚ
.
h®t
 = 
Œue
;

216 
	}
}

219 
	$mª_upd©e_io_¡©e
(
mªagem’t
 *
mª
)

221 ià(
	`sock‘_defšed
(
mª
->
cÚÃùiÚ
.
sd_şi
))

223 ià(
	`bufãr_li¡_defšed
(
mª
->
cÚÃùiÚ
.
out
))

225 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_CC_WAIT_WRITE
;

229 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_CC_WAIT_READ
;

232 
	}
}

235 
	$mª_ouut_li¡_push_fš®ize
(
mªagem’t
 *
mª
)

237 ià(
	`mªagem’t_cÚÃùed
(
mª
))

239 
	`mª_upd©e_io_¡©e
(
mª
);

240 ià(!
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
)

242 vŞ©
sigÇl_»ûived
 = 0;

243 
	`mª_ouut_¡ªd®Úe
(
mª
, &
sigÇl_»ûived
);

246 
	}
}

249 
	$mª_ouut_li¡_push_¡r
(
mªagem’t
 *
mª
, cÚ¡ *
¡r
)

251 ià(
	`mªagem’t_cÚÃùed
(
mª
è&& 
¡r
)

253 
	`bufãr_li¡_push
(
mª
->
cÚÃùiÚ
.
out
, 
¡r
);

255 
	}
}

258 
	$mª_ouut_li¡_push
(
mªagem’t
 *
mª
, cÚ¡ *
¡r
)

260 
	`mª_ouut_li¡_push_¡r
(
mª
, 
¡r
);

261 
	`mª_ouut_li¡_push_fš®ize
(
mª
);

262 
	}
}

265 
	$mª_´om±
(
mªagem’t
 *
mª
)

267 ià(
	`mª_·sswÜd_Ãeded
(
mª
))

269 
	`mª_ouut_li¡_push
(
mª
, "ENTER PASSWORD:");

274 
	`mª_ouut_li¡_push
(
mª
, ">");

277 
	}
}

280 
	$mª_d–‘e_unix_sock‘
(
mªagem’t
 *
mª
)

282 #ià
UNIX_SOCK_SUPPORT


283 ià((
mª
->
£‰šgs
.
æags
 & (
MF_UNIX_SOCK
|
MF_CONNECT_AS_CLIENT
)) == MF_UNIX_SOCK)

285 
	`sock‘_d–‘e_unix
(&
mª
->
£‰šgs
.
loÿl_unix
);

288 
	}
}

291 
	$mª_şo£_sock‘
(
mªagem’t
 *
mª
, cÚ¡ 
sock‘_desütÜ_t
 
sd
)

293 #iâdeà
_WIN32


298 ià(
mª
->
³rsi¡
.
ÿÎback
.
d–‘e_ev’t
)

300 (*
mª
->
³rsi¡
.
ÿÎback
.
d–‘e_ev’t
)(mª->³rsi¡.ÿÎback.
¬g
, 
sd
);

303 
	`İ’v²_şo£_sock‘
(
sd
);

304 
	}
}

307 
	$vœtu®_ouut_ÿÎback_func
(*
¬g
, cÚ¡ 
æags
, cÚ¡ *
¡r
)

309 
mªagem’t
 *
mª
 = (mªagem’ˆ*è
¬g
;

310 
»cursive_Ëv–
 = 0;

312 
	#AF_DID_PUSH
 (1<<0)

	)

313 
	#AF_DID_RESET
 (1<<1)

	)

315 ià(!
»cursive_Ëv–
)

317 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

318 
log_’Œy
 
e
;

319 cÚ¡ *
out
 = 
NULL
;

320 
aùiÚ_æags
 = 0;

322 ++
»cursive_Ëv–
;

324 
	`CLEAR
(
e
);

325 
	`upd©e_time
();

326 
e
.
time¡amp
 = 
now
;

327 
e
.
u
.
msg_æags
 = 
æags
;

328 
e
.
¡ršg
 = 
¡r
;

330 ià(
æags
 & 
M_FATAL
)

332 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

335 ià(
æags
 !ğ
M_CLIENT
)

337 
	`log_hi¡Üy_add
(
mª
->
³rsi¡
.
log
, &
e
);

340 ià(!
	`mª_·sswÜd_Ãeded
(
mª
))

342 ià(
æags
 =ğ
M_CLIENT
)

344 
out
 = 
	`log_’Œy_´št
(&
e
, 
LOG_PRINT_CRLF
, &
gc
);

346 ià(
mª
->
cÚÃùiÚ
.
log_»®time
)

348 
out
 = 
	`log_’Œy_´št
(&
e
, 
LOG_PRINT_INT_DATE


349 | 
LOG_PRINT_MSG_FLAGS


350 | 
LOG_PRINT_LOG_PREFIX


351 | 
LOG_PRINT_CRLF
, &
gc
);

353 ià(
out
)

355 
	`mª_ouut_li¡_push_¡r
(
mª
, 
out
);

356 
aùiÚ_æags
 |ğ
AF_DID_PUSH
;

358 ià(
æags
 & 
M_FATAL
)

360 
out
 = 
	`log_’Œy_´št
(&
e
, 
LOG_FATAL_NOTIFY
|
LOG_PRINT_CRLF
, &
gc
);

361 ià(
out
)

363 
	`mª_ouut_li¡_push_¡r
(
mª
, 
out
);

364 
aùiÚ_æags
 |ğ(
AF_DID_PUSH
|
AF_DID_RESET
);

369 
	`gc_ä“
(&
gc
);

371 ià(
aùiÚ_æags
 & 
AF_DID_PUSH
)

373 
	`mª_ouut_li¡_push_fš®ize
(
mª
);

375 ià(
aùiÚ_æags
 & 
AF_DID_RESET
)

377 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
Œue
);

380 --
»cursive_Ëv–
;

382 
	}
}

389 
	$mª_mod_sigÇl
(cÚ¡ 
mªagem’t
 *
mª
, cÚ¡ 
signum
)

391 cÚ¡ 
æags
 = 
mª
->
£‰šgs
.
mªsig
;

392 
s
 = 
signum
;

393 ià(
s
 =ğ
SIGUSR1
)

395 ià(
æags
 & 
MANSIG_MAP_USR1_TO_HUP
)

397 
s
 = 
SIGHUP
;

399 ià(
æags
 & 
MANSIG_MAP_USR1_TO_TERM
)

401 
s
 = 
SIGTERM
;

404 ià(
æags
 & 
MANSIG_IGNORE_USR1_HUP
)

406 ià(
s
 =ğ
SIGHUP
 || s =ğ
SIGUSR1
)

408 
s
 = -1;

411  
s
;

412 
	}
}

415 
	$mª_sigÇl
(
mªagem’t
 *
mª
, cÚ¡ *
Çme
)

417 cÚ¡ 
sig
 = 
	`·r£_sigÇl
(
Çme
);

418 ià(
sig
 >= 0)

420 cÚ¡ 
sig_mod
 = 
	`mª_mod_sigÇl
(
mª
, 
sig
);

421 ià(
sig_mod
 >= 0)

423 
	`throw_sigÇl
(
sig_mod
);

424 
	`msg
(
M_CLIENT
, "SUCCESS: sigÇÈ% thrown", 
	`sigÇl_Çme
(
sig_mod
, 
Œue
));

428 ià(
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
)

430 
	`msg
(
M_CLIENT
, "%s", 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
);

434 
	`msg
(
M_CLIENT
, "ERROR: sigÇÈ'%s' i cu¼’y ignÜed", 
Çme
);

440 
	`msg
(
M_CLIENT
, "ERROR: sigÇÈ'%s' i nÙ‡ knowÀsigÇÈty³", 
Çme
);

442 
	}
}

445 
	$mª_¡©us
(
mªagem’t
 *
mª
, cÚ¡ 
v”siÚ
, 
¡©us_ouut
 *
so
)

447 ià(
mª
->
³rsi¡
.
ÿÎback
.
¡©us
)

449 (*
mª
->
³rsi¡
.
ÿÎback
.
¡©us
)(mª->³rsi¡.ÿÎback.
¬g
, 
v”siÚ
, 
so
);

453 
	`msg
(
M_CLIENT
, "ERROR: The 'status' command is‚ot supported byhe current daemon mode");

455 
	}
}

458 
	$mª_by‹couÁ
(
mªagem’t
 *
mª
, cÚ¡ 
upd©e_£cÚds
)

460 ià(
upd©e_£cÚds
 >= 0)

462 
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
 = 
upd©e_£cÚds
;

466 
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
 = 0;

468 
	`msg
(
M_CLIENT
, "SUCCESS: bytecount interval changed");

469 
	}
}

472 
	$mª_by‹couÁ_ouut_ş›Á
(
mªagem’t
 *
mª
)

474 
š
[32];

475 
out
[32];

477 
	`İ’v²_¢´štf
(
š
, (š), 
couÁ”_fÜm©
, 
mª
->
³rsi¡
.
by‹s_š
);

478 
	`İ’v²_¢´štf
(
out
, (out), 
couÁ”_fÜm©
, 
mª
->
³rsi¡
.
by‹s_out
);

479 
	`msg
(
M_CLIENT
, ">BYTECOUNT:%s,%s", 
š
, 
out
);

480 
mª
->
cÚÃùiÚ
.
by‹couÁ_Ï¡_upd©e
 = 
now
;

481 
	}
}

483 #ifdeà
MANAGEMENT_DEF_AUTH


486 
	$mª_by‹couÁ_ouut_£rv”
(
mªagem’t
 *
mª
,

487 cÚ¡ 
couÁ”_ty³
 *
by‹s_š_tÙ®
,

488 cÚ¡ 
couÁ”_ty³
 *
by‹s_out_tÙ®
,

489 
mª_def_auth_cÚ‹xt
 *
mdac
)

491 
š
[32];

492 
out
[32];

494 
	`İ’v²_¢´štf
(
š
, (š), 
couÁ”_fÜm©
, *
by‹s_š_tÙ®
);

495 
	`İ’v²_¢´štf
(
out
, (out), 
couÁ”_fÜm©
, *
by‹s_out_tÙ®
);

496 
	`msg
(
M_CLIENT
, ">BYTECOUNT_CLI:%lu,%s,%s", 
mdac
->
cid
, 
š
, 
out
);

497 
mdac
->
by‹couÁ_Ï¡_upd©e
 = 
now
;

498 
	}
}

503 
	$mª_kl
(
mªagem’t
 *
mª
, cÚ¡ *
viùim
)

505 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

507 ià(
mª
->
³rsi¡
.
ÿÎback
.
kl_by_ú
 && mª->³rsi¡.ÿÎback.
kl_by_addr
)

509 
bufãr
 
buf
;

510 
p1
[128];

511 
p2
[128];

512 
n_kËd
;

514 
	`buf_£t_»ad
(&
buf
, (
ušt8_t
 *è
viùim
, 
	`¡¾’
(victim) + 1);

515 
	`buf_·r£
(&
buf
, ':', 
p1
, (p1));

516 
	`buf_·r£
(&
buf
, ':', 
p2
, (p2));

518 ià(
	`¡¾’
(
p1
è&& sŒËn(
p2
))

521 
boŞ
 
¡©us
;

522 cÚ¡ 
š_addr_t
 
addr
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
|
GETADDR_MSG_VIRT_OUT
, 
p1
, 0, &
¡©us
, 
NULL
);

523 ià(
¡©us
)

525 cÚ¡ 
pÜt
 = 
	`©oi
(
p2
);

526 ià(
pÜt
 > 0 &&…ort < 65536)

528 
n_kËd
 = (*
mª
->
³rsi¡
.
ÿÎback
.
kl_by_addr
)(mª->³rsi¡.ÿÎback.
¬g
, 
addr
, 
pÜt
);

529 ià(
n_kËd
 > 0)

531 
	`msg
(
M_CLIENT
, "SUCCESS: %d client(s)‡t‡ddress %s:%d killed",

532 
n_kËd
,

533 
	`´št_š_addr_t
(
addr
, 0, &
gc
),

534 
pÜt
);

538 
	`msg
(
M_CLIENT
, "ERROR: client‡t‡ddress %s:%d‚ot found",

539 
	`´št_š_addr_t
(
addr
, 0, &
gc
),

540 
pÜt
);

545 
	`msg
(
M_CLIENT
, "ERROR:…Üˆnumb” i ouˆoà¿nge: %s", 
p2
);

550 
	`msg
(
M_CLIENT
, "ERROR:ƒ¼Ü…¬sšg IP‡dd»ss: %s", 
p1
);

553 ià(
	`¡¾’
(
p1
))

556 
n_kËd
 = (*
mª
->
³rsi¡
.
ÿÎback
.
kl_by_ú
)(mª->³rsi¡.ÿÎback.
¬g
, 
p1
);

557 ià(
n_kËd
 > 0)

559 
	`msg
(
M_CLIENT
, "SUCCESS: commÚ‚am'%s' found, %d cl›Á(sèkËd", 
p1
, 
n_kËd
);

563 
	`msg
(
M_CLIENT
, "ERROR: commÚ‚am'%s'‚Ù found", 
p1
);

568 
	`msg
(
M_CLIENT
, "ERROR: kill…arse");

573 
	`msg
(
M_CLIENT
, "ERROR: The 'kill' command is‚ot supported byhe current daemon mode");

576 
	`gc_ä“
(&
gc
);

577 
	}
}

584 
	$mª_hi¡Üy
(
mªagem’t
 *
mª
,

585 cÚ¡ *
·rm
,

586 cÚ¡ *
ty³
,

587 
log_hi¡Üy
 *
log
,

588 
boŞ
 *
»®time
,

589 cÚ¡ 
Ëp_æags
)

591 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

592 
n
 = 0;

594 ià(
	`¡»q
(
·rm
, "on"))

596 *
»®time
 = 
Œue
;

597 
	`msg
(
M_CLIENT
, "SUCCESS:„—l-tim% nÙifiÿtiÚ s‘ØON", 
ty³
);

599 ià(
	`¡»q
(
·rm
, "off"))

601 *
»®time
 = 
çl£
;

602 
	`msg
(
M_CLIENT
, "SUCCESS:„—l-tim% nÙifiÿtiÚ s‘ØOFF", 
ty³
);

604 ià(
	`¡»q
(
·rm
, "®l"è|| (
n
 = 
	`©oi
(parm)) > 0)

606 cÚ¡ 
size
 = 
	`log_hi¡Üy_size
(
log
);

607 cÚ¡ 
¡¬t
 = (
n
 ?‚ : 
size
) - 1;

608 
i
;

610 
i
 = 
¡¬t
; i >= 0; --i)

612 cÚ¡ 
log_’Œy
 *
e
 = 
	`log_hi¡Üy_»f
(
log
, 
i
);

613 ià(
e
)

615 cÚ¡ *
out
 = 
	`log_’Œy_´št
(
e
, 
Ëp_æags
, &
gc
);

616 
	`vœtu®_ouut_ÿÎback_func
(
mª
, 
M_CLIENT
, 
out
);

619 
	`msg
(
M_CLIENT
, "END");

623 
	`msg
(
M_CLIENT
, "ERROR: % ·¿m‘” mu¡ b'Ú' o¸'off' o¸somnumb”‚ o¸'®l'", 
ty³
);

626 
	`gc_ä“
(&
gc
);

627 
	}
}

630 
	$mª_log
(
mªagem’t
 *
mª
, cÚ¡ *
·rm
)

632 
	`mª_hi¡Üy
(
mª
,

633 
·rm
,

635 
mª
->
³rsi¡
.
log
,

636 &
mª
->
cÚÃùiÚ
.
log_»®time
,

637 
LOG_PRINT_INT_DATE
|
LOG_PRINT_MSG_FLAGS
);

638 
	}
}

641 
	$mª_echo
(
mªagem’t
 *
mª
, cÚ¡ *
·rm
)

643 
	`mª_hi¡Üy
(
mª
,

644 
·rm
,

646 
mª
->
³rsi¡
.
echo
,

647 &
mª
->
cÚÃùiÚ
.
echo_»®time
,

648 
LOG_PRINT_INT_DATE
|
MANAGEMENT_ECHO_FLAGS
);

649 
	}
}

652 
	$mª_¡©e
(
mªagem’t
 *
mª
, cÚ¡ *
·rm
)

654 
	`mª_hi¡Üy
(
mª
,

655 
·rm
,

657 
mª
->
³rsi¡
.
¡©e
,

658 &
mª
->
cÚÃùiÚ
.
¡©e_»®time
,

659 
LOG_PRINT_INT_DATE
|
LOG_PRINT_STATE


660 |
LOG_PRINT_LOCAL_IP
|
LOG_PRINT_REMOTE_IP
);

661 
	}
}

664 
	$mª_up_fš®ize
(
mªagem’t
 *
mª
)

666 
mª
->
cÚÃùiÚ
.
up_qu”y_mode
)

668 
UP_QUERY_USER_PASS
:

669 ià(!
	`¡¾’
(
mª
->
cÚÃùiÚ
.
up_qu”y
.
u£ºame
))

675 
UP_QUERY_PASS
:

676 
UP_QUERY_NEED_OK
:

677 
UP_QUERY_NEED_STR
:

678 ià(
	`¡¾’
(
mª
->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
))

680 
mª
->
cÚÃùiÚ
.
up_qu”y
.
defšed
 = 
Œue
;

684 
UP_QUERY_DISABLED
:

685 
mª
->
cÚÃùiÚ
.
up_qu”y
.
defšed
 = 
çl£
;

689 
	`ASSERT
(0);

691 
	}
}

694 
	$mª_qu”y_u£r_·ss
(
mªagem’t
 *
mª
,

695 cÚ¡ *
ty³
,

696 cÚ¡ *
¡ršg
,

697 cÚ¡ 
boŞ
 
Ãeded
,

698 cÚ¡ *
´om±
,

699 *
de¡
,

700 
Ën
)

702 ià(
Ãeded
)

704 
	`ASSERT
(
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
);

705 ià(
	`¡»q
(
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
, 
ty³
))

707 
	`¡ºıyÁ
(
de¡
, 
¡ršg
, 
Ën
);

708 
	`mª_up_fš®ize
(
mª
);

709 
	`msg
(
M_CLIENT
, "SUCCESS: '%s' %sƒntered, but‚ot yet verified",

710 
ty³
,

711 
´om±
);

715 
	`msg
(
M_CLIENT
, "ERROR: %s ofype '%s'ƒntered, but we‚eed one ofype '%s'",

716 
´om±
,

717 
ty³
,

718 
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
);

723 
	`msg
(
M_CLIENT
, "ERROR:‚Ø% i cu¼’y‚“ded‡ˆthi time", 
´om±
);

725 
	}
}

728 
	$mª_qu”y_u£ºame
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
¡ršg
)

730 cÚ¡ 
boŞ
 
Ãeded
 = ((
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 =ğ
UP_QUERY_USER_PASS


731 è&& 
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
);

732 
	`mª_qu”y_u£r_·ss
(
mª
, 
ty³
, 
¡ršg
, 
Ãeded
, "u£ºame", mª->
cÚÃùiÚ
.
up_qu”y
.
u£ºame
, 
USER_PASS_LEN
);

733 
	}
}

736 
	$mª_qu”y_·sswÜd
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
¡ršg
)

738 cÚ¡ 
boŞ
 
Ãeded
 = ((
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 =ğ
UP_QUERY_PASS


739 || 
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 =ğ
UP_QUERY_USER_PASS


740 è&& 
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
);

741 ià(!
¡ršg
[0])

743 
¡ršg
 = 
bÏnk_up
;

745 
	`mª_qu”y_u£r_·ss
(
mª
, 
ty³
, 
¡ršg
, 
Ãeded
, "·sswÜd", mª->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
, 
USER_PASS_LEN
);

746 
	}
}

749 
	$mª_qu”y_Ãed_ok
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
aùiÚ
)

751 cÚ¡ 
boŞ
 
Ãeded
 = ((
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 =ğ
UP_QUERY_NEED_OK
è&& mª->cÚÃùiÚ.
up_qu”y_ty³
);

752 
	`mª_qu”y_u£r_·ss
(
mª
, 
ty³
, 
aùiÚ
, 
Ãeded
, "Ãedok-cÚfœm©iÚ", mª->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
, 
USER_PASS_LEN
);

753 
	}
}

756 
	$mª_qu”y_Ãed_¡r
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
aùiÚ
)

758 cÚ¡ 
boŞ
 
Ãeded
 = ((
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 =ğ
UP_QUERY_NEED_STR
è&& mª->cÚÃùiÚ.
up_qu”y_ty³
);

759 
	`mª_qu”y_u£r_·ss
(
mª
, 
ty³
, 
aùiÚ
, 
Ãeded
, "Ãed¡r-¡ršg", mª->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
, 
USER_PASS_LEN
);

760 
	}
}

763 
	$mª_fÜg‘_·sswÜds
(
mªagem’t
 *
mª
)

765 #ifdeà
ENABLE_CRYPTO


766 
	`s¦_purge_auth
(
çl£
);

767 
	`msg
(
M_CLIENT
, "SUCCESS: Passwords were forgotten");

769 
	}
}

772 
	$mª_Ãt
(
mªagem’t
 *
mª
)

774 ià(
mª
->
³rsi¡
.
ÿÎback
.
show_Ãt
)

776 (*
mª
->
³rsi¡
.
ÿÎback
.
show_Ãt
)(mª->³rsi¡.ÿÎback.
¬g
, 
M_CLIENT
);

780 
	`msg
(
M_CLIENT
, "ERROR: The 'net' command is‚ot supported byhe current daemon mode");

782 
	}
}

784 #ifdeà
ENABLE_PKCS11


787 
	$mª_pkcs11_id_couÁ
(
mªagem’t
 *
mª
)

789 
	`msg
(
M_CLIENT
, ">PKCS11ID-COUNT:%d", 
	`pkcs11_mªagem’t_id_couÁ
());

790 
	}
}

793 
	$mª_pkcs11_id_g‘
(
mªagem’t
 *
mª
, cÚ¡ 
šdex
)

795 *
id
 = 
NULL
;

796 *
ba£64
 = 
NULL
;

798 ià(
	`pkcs11_mªagem’t_id_g‘
(
šdex
, &
id
, &
ba£64
))

800 
	`msg
(
M_CLIENT
, ">PKCS11ID-ENTRY:'%d', ID:'%s', BLOB:'%s'", 
šdex
, 
id
, 
ba£64
);

804 
	`msg
(
M_CLIENT
, ">PKCS11ID-ENTRY:'%d'", 
šdex
);

807 ià(
id
 !ğ
NULL
)

809 
	`ä“
(
id
);

811 ià(
ba£64
 !ğ
NULL
)

813 
	`ä“
(
ba£64
);

815 
	}
}

820 
	$mª_hŞd
(
mªagem’t
 *
mª
, cÚ¡ *
cmd
)

822 ià(
cmd
)

824 ià(
	`¡»q
(
cmd
, "on"))

826 
mª
->
£‰šgs
.
æags
 |ğ
MF_HOLD
;

827 
	`msg
(
M_CLIENT
, "SUCCESS: hold flag seto ON");

829 ià(
	`¡»q
(
cmd
, "off"))

831 
mª
->
£‰šgs
.
æags
 &ğ~
MF_HOLD
;

832 
	`msg
(
M_CLIENT
, "SUCCESS: hold flag seto OFF");

834 ià(
	`¡»q
(
cmd
, "release"))

836 
mª
->
³rsi¡
.
hŞd_»Ëa£
 = 
Œue
;

837 
	`msg
(
M_CLIENT
, "SUCCESS: hold„elease succeeded");

841 
	`msg
(
M_CLIENT
, "ERROR: bad hold command…arameter");

846 
	`msg
(
M_CLIENT
, "SUCCESS: hŞd=%d", 
	`BOOL_CAST
(
mª
->
£‰šgs
.
æags
 & 
MF_HOLD
));

848 
	}
}

850 #ifdeà
MANAGEMENT_IN_EXTRA


852 
	#IER_RESET
 0

	)

853 
	#IER_NEW
 1

	)

856 
	$š_exŒa_»£t
(
mª_cÚÃùiÚ
 *
mc
, cÚ¡ 
mode
)

858 ià(
mc
)

860 ià(
mode
 !ğ
IER_NEW
)

862 
mc
->
š_exŒa_cmd
 = 
IEC_UNDEF
;

863 #ifdeà
MANAGEMENT_DEF_AUTH


864 
mc
->
š_exŒa_cid
 = 0;

865 
mc
->
š_exŒa_kid
 = 0;

868 ià(
mc
->
š_exŒa
)

870 
	`bufãr_li¡_ä“
(
mc
->
š_exŒa
);

871 
mc
->
š_exŒa
 = 
NULL
;

873 ià(
mode
 =ğ
IER_NEW
)

875 
mc
->
š_exŒa
 = 
	`bufãr_li¡_Ãw
(0);

878 
	}
}

881 
	$š_exŒa_di¥©ch
(
mªagem’t
 *
mª
)

883 
mª
->
cÚÃùiÚ
.
š_exŒa_cmd
)

885 #ifdeà
MANAGEMENT_DEF_AUTH


886 
IEC_CLIENT_AUTH
:

887 ià(
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_auth
)

889 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_auth
)

890 (
mª
->
³rsi¡
.
ÿÎback
.
¬g
,

891 
mª
->
cÚÃùiÚ
.
š_exŒa_cid
,

892 
mª
->
cÚÃùiÚ
.
š_exŒa_kid
,

893 
Œue
,

894 
NULL
,

895 
NULL
,

896 
mª
->
cÚÃùiÚ
.
š_exŒa
);

897 
mª
->
cÚÃùiÚ
.
š_exŒa
 = 
NULL
;

898 ià(
¡©us
)

900 
	`msg
(
M_CLIENT
, "SUCCESS: client-auth command succeeded");

904 
	`msg
(
M_CLIENT
, "ERROR: client-auth command failed");

909 
	`msg
(
M_CLIENT
, "ERROR: The client-auth command is‚ot supported byhe current daemon mode");

914 #ifdeà
MANAGEMENT_PF


915 
IEC_CLIENT_PF
:

916 ià(
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_pf
)

918 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_pf
)

919 (
mª
->
³rsi¡
.
ÿÎback
.
¬g
,

920 
mª
->
cÚÃùiÚ
.
š_exŒa_cid
,

921 
mª
->
cÚÃùiÚ
.
š_exŒa
);

922 
mª
->
cÚÃùiÚ
.
š_exŒa
 = 
NULL
;

923 ià(
¡©us
)

925 
	`msg
(
M_CLIENT
, "SUCCESS: client-pf command succeeded");

929 
	`msg
(
M_CLIENT
, "ERROR: client-pf command failed");

934 
	`msg
(
M_CLIENT
, "ERROR: The client-pf command is‚ot supported byhe current daemon mode");

939 #ifdeà
MANAGMENT_EXTERNAL_KEY


940 
IEC_RSA_SIGN
:

941 
mª
->
cÚÃùiÚ
.
ext_key_¡©e
 = 
EKS_READY
;

942 
	`bufãr_li¡_ä“
(
mª
->
cÚÃùiÚ
.
ext_key_šput
);

943 
mª
->
cÚÃùiÚ
.
ext_key_šput
 = mª->cÚÃùiÚ.
š_exŒa
;

944 
mª
->
cÚÃùiÚ
.
š_exŒa
 = 
NULL
;

947 
IEC_CERTIFICATE
:

948 
mª
->
cÚÃùiÚ
.
ext_û¹_¡©e
 = 
EKS_READY
;

949 
	`bufãr_li¡_ä“
(
mª
->
cÚÃùiÚ
.
ext_û¹_šput
);

950 
mª
->
cÚÃùiÚ
.
ext_û¹_šput
 = mª->cÚÃùiÚ.
š_exŒa
;

951 
mª
->
cÚÃùiÚ
.
š_exŒa
 = 
NULL
;

955 
	`š_exŒa_»£t
(&
mª
->
cÚÃùiÚ
, 
IER_RESET
);

956 
	}
}

960 #ifdeà
MANAGEMENT_DEF_AUTH


962 
boŞ


963 
	$·r£_cid
(cÚ¡ *
¡r
, *
cid
)

965 ià(
	`ssÿnf
(
¡r
, "%lu", 
cid
) == 1)

967  
Œue
;

971 
	`msg
(
M_CLIENT
, "ERROR: cannot…arse CID");

972  
çl£
;

974 
	}
}

976 
boŞ


977 
	$·r£_kid
(cÚ¡ *
¡r
, *
kid
)

979 ià(
	`ssÿnf
(
¡r
, "%u", 
kid
) == 1)

981  
Œue
;

985 
	`msg
(
M_CLIENT
, "ERROR: cannot…arse KID");

986  
çl£
;

988 
	}
}

991 
	$mª_ş›Á_auth
(
mªagem’t
 *
mª
, cÚ¡ *
cid_¡r
, cÚ¡ *
kid_¡r
, cÚ¡ 
boŞ
 
exŒa
)

993 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

994 
mc
->
š_exŒa_cid
 = 0;

995 
mc
->
š_exŒa_kid
 = 0;

996 ià(
	`·r£_cid
(
cid_¡r
, &
mc
->
š_exŒa_cid
)

997 && 
	`·r£_kid
(
kid_¡r
, &
mc
->
š_exŒa_kid
))

999 
mc
->
š_exŒa_cmd
 = 
IEC_CLIENT_AUTH
;

1000 
	`š_exŒa_»£t
(
mc
, 
IER_NEW
);

1001 ià(!
exŒa
)

1003 
	`š_exŒa_di¥©ch
(
mª
);

1006 
	}
}

1009 
	$mª_ş›Á_d’y
(
mªagem’t
 *
mª
, cÚ¡ *
cid_¡r
, cÚ¡ *
kid_¡r
, cÚ¡ *
»asÚ
, cÚ¡ *
ş›Á_»asÚ
)

1011 
cid
 = 0;

1012 
kid
 = 0;

1013 ià(
	`·r£_cid
(
cid_¡r
, &
cid
è&& 
	`·r£_kid
(
kid_¡r
, &
kid
))

1015 ià(
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_auth
)

1017 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
ş›Á_auth
)

1018 (
mª
->
³rsi¡
.
ÿÎback
.
¬g
,

1019 
cid
,

1020 
kid
,

1021 
çl£
,

1022 
»asÚ
,

1023 
ş›Á_»asÚ
,

1024 
NULL
);

1025 ià(
¡©us
)

1027 
	`msg
(
M_CLIENT
, "SUCCESS: client-deny command succeeded");

1031 
	`msg
(
M_CLIENT
, "ERROR: client-deny command failed");

1036 
	`msg
(
M_CLIENT
, "ERROR: The client-deny command is‚ot supported byhe current daemon mode");

1039 
	}
}

1042 
	$mª_ş›Á_kl
(
mªagem’t
 *
mª
, cÚ¡ *
cid_¡r
, cÚ¡ *
kl_msg
)

1044 
cid
 = 0;

1045 ià(
	`·r£_cid
(
cid_¡r
, &
cid
))

1047 ià(
mª
->
³rsi¡
.
ÿÎback
.
kl_by_cid
)

1049 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
kl_by_cid
)(mª->³rsi¡.ÿÎback.
¬g
, 
cid
, 
kl_msg
);

1050 ià(
¡©us
)

1052 
	`msg
(
M_CLIENT
, "SUCCESS: client-kill command succeeded");

1056 
	`msg
(
M_CLIENT
, "ERROR: client-kill command failed");

1061 
	`msg
(
M_CLIENT
, "ERROR: The client-kill command is‚ot supported byhe current daemon mode");

1064 
	}
}

1067 
	$mª_ş›Á_n_ş›Ás
(
mªagem’t
 *
mª
)

1069 ià(
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)

1071 cÚ¡ 
nş›Ás
 = (*
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)(mª->³rsi¡.ÿÎback.
¬g
);

1072 
	`msg
(
M_CLIENT
, "SUCCESS:‚ş›Ás=%d", 
nş›Ás
);

1076 
	`msg
(
M_CLIENT
, "ERROR: The‚clients command is‚ot supported byhe current daemon mode");

1078 
	}
}

1081 
	$mª_’v_f‹r
(
mªagem’t
 *
mª
, cÚ¡ 
Ëv–
)

1083 
mª
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
 = 
Ëv–
;

1084 
	`msg
(
M_CLIENT
, "SUCCESS:ƒnv_f‹r_Ëv–=%d", 
Ëv–
);

1085 
	}
}

1087 #ifdeà
MANAGEMENT_PF


1090 
	$mª_ş›Á_pf
(
mªagem’t
 *
mª
, cÚ¡ *
cid_¡r
)

1092 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

1093 
mc
->
š_exŒa_cid
 = 0;

1094 
mc
->
š_exŒa_kid
 = 0;

1095 ià(
	`·r£_cid
(
cid_¡r
, &
mc
->
š_exŒa_cid
))

1097 
mc
->
š_exŒa_cmd
 = 
IEC_CLIENT_PF
;

1098 
	`š_exŒa_»£t
(
mc
, 
IER_NEW
);

1100 
	}
}

1105 #ifdeà
MANAGMENT_EXTERNAL_KEY


1108 
	$mª_r§_sig
(
mªagem’t
 *
mª
)

1110 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

1111 ià(
mc
->
ext_key_¡©e
 =ğ
EKS_SOLICIT
)

1113 
mc
->
ext_key_¡©e
 = 
EKS_INPUT
;

1114 
mc
->
š_exŒa_cmd
 = 
IEC_RSA_SIGN
;

1115 
	`š_exŒa_»£t
(
mc
, 
IER_NEW
);

1119 
	`msg
(
M_CLIENT
, "ERROR: The„sa-sig command is‚ot currently‡vailable");

1121 
	}
}

1124 
	$mª_û¹ifiÿ‹
(
mªagem’t
 *
mª
)

1126 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

1127 ià(
mc
->
ext_û¹_¡©e
 =ğ
EKS_SOLICIT
)

1129 
mc
->
ext_û¹_¡©e
 = 
EKS_INPUT
;

1130 
mc
->
š_exŒa_cmd
 = 
IEC_CERTIFICATE
;

1131 
	`š_exŒa_»£t
(
mc
, 
IER_NEW
);

1135 
	`msg
(
M_CLIENT
, "ERROR: The certificate command is‚ot currently‡vailable");

1137 
	}
}

1142 
	$mª_lßd_¡©s
(
mªagem’t
 *
mª
)

1144 
couÁ”_ty³
 
lšk_»ad_by‹s_glob®
;

1145 
couÁ”_ty³
 
lšk_wr™e_by‹s_glob®
;

1146 
nş›Ás
 = 0;

1148 ià(
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)

1150 
nş›Ás
 = (*
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)(mª->³rsi¡.ÿÎback.
¬g
);

1152 
	`msg
(
M_CLIENT
, "SUCCESS:‚ş›Ás=%d,by‹sš=" 
couÁ”_fÜm©
 ",bytesout=" counter_format,

1153 
nş›Ás
,

1154 
lšk_»ad_by‹s_glob®
,

1155 
lšk_wr™e_by‹s_glob®
);

1156 
	}
}

1158 
	#MN_AT_LEAST
 (1<<0)

	)

1160 
boŞ


1161 
	$mª_Ãed
(
mªagem’t
 *
mª
, cÚ¡ **
p
, cÚ¡ 
n
, 
æags
)

1163 
i
;

1164 
	`ASSERT
(
p
[0]);

1165 
i
 = 1; i <ğ
n
; ++i)

1167 ià(!
p
[
i
])

1169 
	`msg
(
M_CLIENT
, "ERROR:he '%s' command„equires %s%d…arameter%s",

1170 
p
[0],

1171 (
æags
 & 
MN_AT_LEAST
) ? "at†east " : "",

1172 
n
,

1173 
n
 > 1 ? "s" : "");

1174  
çl£
;

1177  
Œue
;

1178 
	}
}

1181 
	$mª_´oxy
(
mªagem’t
 *
mª
, cÚ¡ **
p
)

1183 ià(
mª
->
³rsi¡
.
ÿÎback
.
´oxy_cmd
)

1185 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
´oxy_cmd
)(mª->³rsi¡.ÿÎback.
¬g
, 
p
);

1186 ià(
¡©us
)

1188 
	`msg
(
M_CLIENT
, "SUCCESS:…roxy command succeeded");

1192 
	`msg
(
M_CLIENT
, "ERROR:…roxy command failed");

1197 
	`msg
(
M_CLIENT
, "ERROR: The…roxy command is‚ot supported byhe current daemon mode");

1199 
	}
}

1202 
	$mª_»mÙe
(
mªagem’t
 *
mª
, cÚ¡ **
p
)

1204 ià(
mª
->
³rsi¡
.
ÿÎback
.
»mÙe_cmd
)

1206 cÚ¡ 
boŞ
 
¡©us
 = (*
mª
->
³rsi¡
.
ÿÎback
.
»mÙe_cmd
)(mª->³rsi¡.ÿÎback.
¬g
, 
p
);

1207 ià(
¡©us
)

1209 
	`msg
(
M_CLIENT
, "SUCCESS:„emote command succeeded");

1213 
	`msg
(
M_CLIENT
, "ERROR:„emote command failed");

1218 
	`msg
(
M_CLIENT
, "ERROR: The„emote command is‚ot supported byhe current daemon mode");

1220 
	}
}

1222 #ifdeà
TARGET_ANDROID


1224 
	$mª_ÃtwÜk_chªge
(
mªagem’t
 *
mª
, 
boŞ
 
§m’‘wÜk
)

1231 ià(
mª
->
³rsi¡
.
ÿÎback
.
ÃtwÜk_chªge
)

1233 
fd
 = (*
mª
->
³rsi¡
.
ÿÎback
.
ÃtwÜk_chªge
)

1234 (
mª
->
³rsi¡
.
ÿÎback
.
¬g
, 
§m’‘wÜk
);

1235 
mª
->
cÚÃùiÚ
.
fdto£nd
 = 
fd
;

1236 
	`msg
(
M_CLIENT
, "PROTECTFD: fd '%d' s’ˆtØb´Ùeùed", 
fd
);

1237 ià(
fd
 == -2)

1239 
	`mª_sigÇl
(
mª
, "SIGUSR1");

1242 
	}
}

1246 
	$mª_di¥©ch_commªd
(
mªagem’t
 *
mª
, 
¡©us_ouut
 *
so
, cÚ¡ **
p
, cÚ¡ 
Å¬ms
)

1248 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1250 
	`ASSERT
(
p
[0]);

1251 ià(
	`¡»q
(
p
[0], "exit") || streq(p[0], "quit"))

1253 
mª
->
cÚÃùiÚ
.
h®t
 = 
Œue
;

1254 
dÚe
;

1256 ià(
	`¡»q
(
p
[0], "help"))

1258 
	`mª_h–p
();

1260 ià(
	`¡»q
(
p
[0], "version"))

1262 
	`msg
(
M_CLIENT
, "O³nVPN V”siÚ: %s", 
t™Ë_¡ršg
);

1263 
	`msg
(
M_CLIENT
, "Mªagem’ˆV”siÚ: %d", 
MANAGEMENT_VERSION
);

1264 
	`msg
(
M_CLIENT
, "END");

1266 ià(
	`¡»q
(
p
[0], "pid"))

1268 
	`msg
(
M_CLIENT
, "SUCCESS:…id=%d", 
	`¶©fÜm_g‘pid
());

1270 #ifdeà
MANAGEMENT_DEF_AUTH


1271 ià(
	`¡»q
(
p
[0], "nclients"))

1273 
	`mª_ş›Á_n_ş›Ás
(
mª
);

1275 ià(
	`¡»q
(
p
[0], "env-filter"))

1277 
Ëv–
 = 0;

1278 ià(
p
[1])

1280 
Ëv–
 = 
	`©oi
(
p
[1]);

1282 
	`mª_’v_f‹r
(
mª
, 
Ëv–
);

1285 ià(
	`¡»q
(
p
[0], "signal"))

1287 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1289 
	`mª_sigÇl
(
mª
, 
p
[1]);

1292 #ifdeà
TARGET_ANDROID


1293 ià(
	`¡»q
(
p
[0], "network-change"))

1295 
boŞ
 
§m’‘wÜk
 = 
çl£
;

1296 ià(
p
[1] && 
	`¡»q
(p[1], "samenetwork"))

1298 
§m’‘wÜk
 = 
Œue
;

1301 
	`mª_ÃtwÜk_chªge
(
mª
, 
§m’‘wÜk
);

1304 ià(
	`¡»q
(
p
[0], "load-stats"))

1306 
	`mª_lßd_¡©s
(
mª
);

1308 ià(
	`¡»q
(
p
[0], "status"))

1310 
v”siÚ
 = 0;

1311 ià(
p
[1])

1313 
v”siÚ
 = 
	`©oi
(
p
[1]);

1315 
	`mª_¡©us
(
mª
, 
v”siÚ
, 
so
);

1317 ià(
	`¡»q
(
p
[0], "kill"))

1319 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1321 
	`mª_kl
(
mª
, 
p
[1]);

1324 ià(
	`¡»q
(
p
[0], "verb"))

1326 ià(
p
[1])

1328 cÚ¡ 
Ëv–
 = 
	`©oi
(
p
[1]);

1329 ià(
	`£t_debug_Ëv–
(
Ëv–
, 0))

1331 
	`msg
(
M_CLIENT
, "SUCCESS: verb†evel changed");

1335 
	`msg
(
M_CLIENT
, "ERROR: verb†evel is out of„ange");

1340 
	`msg
(
M_CLIENT
, "SUCCESS: v”b=%d", 
	`g‘_debug_Ëv–
());

1343 ià(
	`¡»q
(
p
[0], "mute"))

1345 ià(
p
[1])

1347 cÚ¡ 
Ëv–
 = 
	`©oi
(
p
[1]);

1348 ià(
	`£t_mu‹_cutoff
(
Ëv–
))

1350 
	`msg
(
M_CLIENT
, "SUCCESS: mute†evel changed");

1354 
	`msg
(
M_CLIENT
, "ERROR: mute†evel is out of„ange");

1359 
	`msg
(
M_CLIENT
, "SUCCESS: mu‹=%d", 
	`g‘_mu‹_cutoff
());

1362 ià(
	`¡»q
(
p
[0], "auth-retry"))

1364 #ià
P2MP


1365 ià(
p
[1])

1367 ià(
	`auth_»Œy_£t
(
M_CLIENT
, 
p
[1]))

1369 
	`msg
(
M_CLIENT
, "SUCCESS:‡uth-retry…arameter changed");

1373 
	`msg
(
M_CLIENT
, "ERROR: bad‡uth-retry…arameter");

1378 
	`msg
(
M_CLIENT
, "SUCCESS:‡uth-»Œy=%s", 
	`auth_»Œy_´št
());

1381 
	`msg
(
M_CLIENT
, "ERROR:‡uth-retry feature is unavailable");

1384 ià(
	`¡»q
(
p
[0], "state"))

1386 ià(!
p
[1])

1388 
	`mª_¡©e
(
mª
, "1");

1392 ià(
p
[1])

1394 
	`mª_¡©e
(
mª
, 
p
[1]);

1396 ià(
p
[2])

1398 
	`mª_¡©e
(
mª
, 
p
[2]);

1402 ià(
	`¡»q
(
p
[0], "log"))

1404 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 
MN_AT_LEAST
))

1406 ià(
p
[1])

1408 
	`mª_log
(
mª
, 
p
[1]);

1410 ià(
p
[2])

1412 
	`mª_log
(
mª
, 
p
[2]);

1416 ià(
	`¡»q
(
p
[0], "echo"))

1418 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 
MN_AT_LEAST
))

1420 ià(
p
[1])

1422 
	`mª_echo
(
mª
, 
p
[1]);

1424 ià(
p
[2])

1426 
	`mª_echo
(
mª
, 
p
[2]);

1430 ià(
	`¡»q
(
p
[0], "username"))

1432 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1434 
	`mª_qu”y_u£ºame
(
mª
, 
p
[1],…[2]);

1437 ià(
	`¡»q
(
p
[0], "password"))

1439 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1441 
	`mª_qu”y_·sswÜd
(
mª
, 
p
[1],…[2]);

1444 ià(
	`¡»q
(
p
[0], "forget-passwords"))

1446 
	`mª_fÜg‘_·sswÜds
(
mª
);

1448 ià(
	`¡»q
(
p
[0], "needok"))

1450 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1452 
	`mª_qu”y_Ãed_ok
(
mª
, 
p
[1],…[2]);

1455 ià(
	`¡»q
(
p
[0], "needstr"))

1457 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1459 
	`mª_qu”y_Ãed_¡r
(
mª
, 
p
[1],…[2]);

1462 ià(
	`¡»q
(
p
[0], "net"))

1464 
	`mª_Ãt
(
mª
);

1466 ià(
	`¡»q
(
p
[0], "hold"))

1468 
	`mª_hŞd
(
mª
, 
p
[1]);

1470 ià(
	`¡»q
(
p
[0], "bytecount"))

1472 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1474 
	`mª_by‹couÁ
(
mª
, 
	`©oi
(
p
[1]));

1477 #ifdeà
MANAGEMENT_DEF_AUTH


1478 ià(
	`¡»q
(
p
[0], "client-kill"))

1480 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 
MN_AT_LEAST
))

1482 
	`mª_ş›Á_kl
(
mª
, 
p
[1],…[2]);

1485 ià(
	`¡»q
(
p
[0], "client-deny"))

1487 ià(
	`mª_Ãed
(
mª
, 
p
, 3, 
MN_AT_LEAST
))

1489 
	`mª_ş›Á_d’y
(
mª
, 
p
[1],…[2],…[3],…[4]);

1492 ià(
	`¡»q
(
p
[0], "client-auth-nt"))

1494 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1496 
	`mª_ş›Á_auth
(
mª
, 
p
[1],…[2], 
çl£
);

1499 ià(
	`¡»q
(
p
[0], "client-auth"))

1501 ià(
	`mª_Ãed
(
mª
, 
p
, 2, 0))

1503 
	`mª_ş›Á_auth
(
mª
, 
p
[1],…[2], 
Œue
);

1506 #ifdeà
MANAGEMENT_PF


1507 ià(
	`¡»q
(
p
[0], "client-pf"))

1509 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1511 
	`mª_ş›Á_pf
(
mª
, 
p
[1]);

1516 #ifdeà
MANAGMENT_EXTERNAL_KEY


1517 ià(
	`¡»q
(
p
[0], "rsa-sig"))

1519 
	`mª_r§_sig
(
mª
);

1521 ià(
	`¡»q
(
p
[0], "certificate"))

1523 
	`mª_û¹ifiÿ‹
(
mª
);

1526 #ifdeà
ENABLE_PKCS11


1527 ià(
	`¡»q
(
p
[0], "pkcs11-id-count"))

1529 
	`mª_pkcs11_id_couÁ
(
mª
);

1531 ià(
	`¡»q
(
p
[0], "pkcs11-id-get"))

1533 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1535 
	`mª_pkcs11_id_g‘
(
mª
, 
	`©oi
(
p
[1]));

1539 ià(
	`¡»q
(
p
[0], "proxy"))

1541 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 
MN_AT_LEAST
))

1543 
	`mª_´oxy
(
mª
, 
p
);

1546 ià(
	`¡»q
(
p
[0], "remote"))

1548 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 
MN_AT_LEAST
))

1550 
	`mª_»mÙe
(
mª
, 
p
);

1554 ià(
	`¡»q
(
p
[0], "test"))

1556 ià(
	`mª_Ãed
(
mª
, 
p
, 1, 0))

1558 
i
;

1559 cÚ¡ 
n
 = 
	`©oi
(
p
[1]);

1560 
i
 = 0; i < 
n
; ++i)

1562 
	`msg
(
M_CLIENT
, "[%d] Thpu½o£ oàthi commªd i tØg’”©ÏrgamouÁ oàouut.", 
i
);

1569 
	`msg
(
M_CLIENT
, "ERROR: unknown command,ƒnter 'help' for more options");

1572 
dÚe
:

1573 
	`gc_ä“
(&
gc
);

1574 
	}
}

1576 #ifdeà
_WIN32


1579 
	$mª_¡¬t_Ã32
(
mªagem’t
 *
mª
)

1581 
mª
->
cÚÃùiÚ
.
¡©e
)

1583 
MS_LISTEN
:

1584 
	`Ãt_ev’t_wš32_¡¬t
(&
mª
->
cÚÃùiÚ
.
Ã32
, 
FD_ACCEPT
, mª->cÚÃùiÚ.
sd_tİ
);

1587 
MS_CC_WAIT_READ
:

1588 
MS_CC_WAIT_WRITE
:

1589 
	`Ãt_ev’t_wš32_¡¬t
(&
mª
->
cÚÃùiÚ
.
Ã32
, 
FD_READ
|
FD_WRITE
|
FD_CLOSE
, mª->cÚÃùiÚ.
sd_şi
);

1593 
	`ASSERT
(0);

1595 
	}
}

1598 
	$mª_¡İ_Ã32
(
mªagem’t
 *
mª
)

1600 
	`Ãt_ev’t_wš32_¡İ
(&
mª
->
cÚÃùiÚ
.
Ã32
);

1601 
	}
}

1606 
	$mª_»cÜd_³”_šfo
(
mªagem’t
 *
mª
)

1608 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1609 ià(
mª
->
£‰šgs
.
wr™e_³”_šfo_fe
)

1611 
boŞ
 
sucûss
 = 
çl£
;

1612 #ifdeà
HAVE_GETSOCKNAME


1613 ià(
	`sock‘_defšed
(
mª
->
cÚÃùiÚ
.
sd_şi
))

1615 
sockaddr_š
 
addr
;

1616 
sockËn_t
 
add¾’
 = (
addr
);

1617 
¡©us
;

1619 
	`CLEAR
(
addr
);

1620 
¡©us
 = 
	`g‘sockÇme
(
mª
->
cÚÃùiÚ
.
sd_şi
, (
sockaddr
 *)&
addr
, &
add¾’
);

1621 ià(!
¡©us
 && 
add¾’
 =ğ(
addr
))

1623 cÚ¡ 
š_addr_t
 
a
 = 
	`Áohl
(
addr
.
sš_addr
.
s_addr
);

1624 cÚ¡ 
p
 = 
	`Áohs
(
addr
.
sš_pÜt
);

1625 
FILE
 *
å
 = 
	`¶©fÜm_fİ’
(
mª
->
£‰šgs
.
wr™e_³”_šfo_fe
, "w");

1626 ià(
å
)

1628 
	`årštf
(
å
, "%s\n%d\n", 
	`´št_š_addr_t
(
a
, 0, &
gc
), 
p
);

1629 ià(!
	`fşo£
(
å
))

1631 
sucûss
 = 
Œue
;

1637 ià(!
sucûss
)

1639 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: failedo write…eer infoo file %s",

1640 
mª
->
£‰šgs
.
wr™e_³”_šfo_fe
);

1641 
	`throw_sigÇl_soá
(
SIGTERM
, "management-connect-failed");

1644 
	`gc_ä“
(&
gc
);

1645 
	}
}

1648 
	$mª_cÚÃùiÚ_£‰šgs_»£t
(
mªagem’t
 *
mª
)

1650 
mª
->
cÚÃùiÚ
.
¡©e_»®time
 = 
çl£
;

1651 
mª
->
cÚÃùiÚ
.
log_»®time
 = 
çl£
;

1652 
mª
->
cÚÃùiÚ
.
echo_»®time
 = 
çl£
;

1653 
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
 = 0;

1654 
mª
->
cÚÃùiÚ
.
·sswÜd_v”if›d
 = 
çl£
;

1655 
mª
->
cÚÃùiÚ
.
·sswÜd_Œ›s
 = 0;

1656 
mª
->
cÚÃùiÚ
.
h®t
 = 
çl£
;

1657 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_CC_WAIT_WRITE
;

1658 
	}
}

1661 
	$mª_Ãw_cÚÃùiÚ_po¡
(
mªagem’t
 *
mª
, cÚ¡ *
desütiÚ
)

1663 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1665 
	`£t_nÚblock
(
mª
->
cÚÃùiÚ
.
sd_şi
);

1667 
	`mª_cÚÃùiÚ_£‰šgs_»£t
(
mª
);

1669 #ifdeà
_WIN32


1670 
	`mª_¡¬t_Ã32
(
mª
);

1673 #ià
UNIX_SOCK_SUPPORT


1674 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1676 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: %s %s",

1677 
desütiÚ
,

1678 
	`sockaddr_unix_Çme
(&
mª
->
£‰šgs
.
loÿl_unix
, "NULL"));

1682 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: %s %s",

1683 
desütiÚ
,

1684 
	`´št_sockaddr
(
mª
->
£‰šgs
.
loÿl
->
ai_addr
, &
gc
));

1686 
	`bufãr_li¡_»£t
(
mª
->
cÚÃùiÚ
.
out
);

1688 ià(!
	`mª_·sswÜd_Ãeded
(
mª
))

1690 
	`mª_w–come
(
mª
);

1692 
	`mª_´om±
(
mª
);

1693 
	`mª_upd©e_io_¡©e
(
mª
);

1695 
	`gc_ä“
(&
gc
);

1696 
	}
}

1698 #ià
UNIX_SOCK_SUPPORT


1699 
boŞ


1700 
	$mª_v”ify_unix_³”_uid_gid
(
mªagem’t
 *
mª
, cÚ¡ 
sock‘_desütÜ_t
 
sd
)

1702 ià(
	`sock‘_defšed
(
sd
è&& (
mª
->
£‰šgs
.
ş›Á_uid
 !ğ-1 || mª->£‰šgs.
ş›Á_gid
 != -1))

1704 cÚ¡ 
”r_´efix
[] = "MANAGEMENT: unix domain socket client connection„ejected --";

1705 
uid
, 
gid
;

1706 ià(
	`unix_sock‘_g‘_³”_uid_gid
(
mª
->
cÚÃùiÚ
.
sd_şi
, &
uid
, &
gid
))

1708 ià(
mª
->
£‰šgs
.
ş›Á_uid
 !ğ-1 && mª->£‰šgs.ş›Á_uid !ğ
uid
)

1710 
	`msg
(
D_MANAGEMENT
, "%s UID of socket…eer (%d) doesn't match„equired value (%d)‡s given by --management-client-user",

1711 
”r_´efix
, 
uid
, 
mª
->
£‰šgs
.
ş›Á_uid
);

1712  
çl£
;

1714 ià(
mª
->
£‰šgs
.
ş›Á_gid
 !ğ-1 && mª->£‰šgs.ş›Á_gid !ğ
gid
)

1716 
	`msg
(
D_MANAGEMENT
, "%s GID of socket…eer (%d) doesn't match„equired value (%d)‡s given by --management-client-group",

1717 
”r_´efix
, 
gid
, 
mª
->
£‰šgs
.
ş›Á_gid
);

1718  
çl£
;

1723 
	`msg
(
D_MANAGEMENT
, "% ÿÂÙ g‘ UID/GID oàsock‘…“r", 
”r_´efix
);

1724  
çl£
;

1727  
Œue
;

1728 
	}
}

1732 
	$mª_acû±
(
mªagem’t
 *
mª
)

1734 
lšk_sock‘_aùu®
 
aù
;

1735 
	`CLEAR
(
aù
);

1740 #ià
UNIX_SOCK_SUPPORT


1741 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1743 
sockaddr_un
 
»mÙe
;

1744 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
	`sock‘_acû±_unix
(mª->cÚÃùiÚ.
sd_tİ
, &
»mÙe
);

1745 ià(!
	`mª_v”ify_unix_³”_uid_gid
(
mª
, mª->
cÚÃùiÚ
.
sd_şi
))

1747 
	`sd_şo£
(&
mª
->
cÚÃùiÚ
.
sd_şi
);

1752 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
	`sock‘_do_acû±
(mª->cÚÃùiÚ.
sd_tİ
, &
aù
, 
çl£
);

1754 ià(
	`sock‘_defšed
(
mª
->
cÚÃùiÚ
.
sd_şi
))

1756 
mª
->
cÚÃùiÚ
.
»mÙe
 = 
aù
.
de¡
;

1758 ià(
	`sock‘_defšed
(
mª
->
cÚÃùiÚ
.
sd_tİ
))

1760 #ifdeà
_WIN32


1761 
	`mª_¡İ_Ã32
(
mª
);

1765 
	`mª_Ãw_cÚÃùiÚ_po¡
(
mª
, "Client connected from");

1767 
	}
}

1770 
	$mª_li¡’
(
mªagem’t
 *
mª
)

1772 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1777 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_LISTEN
;

1778 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
SOCKET_UNDEFINED
;

1783 ià(
mª
->
cÚÃùiÚ
.
sd_tİ
 =ğ
SOCKET_UNDEFINED
)

1785 #ià
UNIX_SOCK_SUPPORT


1786 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1788 
	`mª_d–‘e_unix_sock‘
(
mª
);

1789 
mª
->
cÚÃùiÚ
.
sd_tİ
 = 
	`ü—‹_sock‘_unix
();

1790 
	`sock‘_bšd_unix
(
mª
->
cÚÃùiÚ
.
sd_tİ
, &mª->
£‰šgs
.
loÿl_unix
, "MANAGEMENT");

1795 
mª
->
cÚÃùiÚ
.
sd_tİ
 = 
	`ü—‹_sock‘_tı
(mª->
£‰šgs
.
loÿl
);

1796 
	`sock‘_bšd
(
mª
->
cÚÃùiÚ
.
sd_tİ
, mª->
£‰šgs
.
loÿl
,

1797 
mª
->
£‰šgs
.
loÿl
->
ai_çmy
, "MANAGEMENT", 
çl£
);

1803 ià(
	`li¡’
(
mª
->
cÚÃùiÚ
.
sd_tİ
, 1))

1805 
	`msg
(
M_ERR
, "MANAGEMENT:†isten() failed");

1811 
	`£t_nÚblock
(
mª
->
cÚÃùiÚ
.
sd_tİ
);

1813 #ià
UNIX_SOCK_SUPPORT


1814 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1816 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: unix domain socket†istening on %s",

1817 
	`sockaddr_unix_Çme
(&
mª
->
£‰šgs
.
loÿl_unix
, "NULL"));

1821 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: TCP Socket†istening on %s",

1822 
	`´št_sockaddr
(
mª
->
£‰šgs
.
loÿl
->
ai_addr
, &
gc
));

1825 #ifdeà
_WIN32


1826 
	`mª_¡¬t_Ã32
(
mª
);

1829 
	`gc_ä“
(&
gc
);

1830 
	}
}

1833 
	$mª_cÚÃù
(
mªagem’t
 *
mª
)

1835 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1836 
¡©us
;

1837 
sigÇl_»ûived
 = 0;

1842 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_INITIAL
;

1843 
mª
->
cÚÃùiÚ
.
sd_tİ
 = 
SOCKET_UNDEFINED
;

1845 #ià
UNIX_SOCK_SUPPORT


1846 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1848 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
	`ü—‹_sock‘_unix
();

1849 
¡©us
 = 
	`sock‘_cÚÃù_unix
(
mª
->
cÚÃùiÚ
.
sd_şi
, &mª->
£‰šgs
.
loÿl_unix
);

1850 ià(!
¡©us
 && !
	`mª_v”ify_unix_³”_uid_gid
(
mª
, mª->
cÚÃùiÚ
.
sd_şi
))

1852 #ifdeà
EPERM


1853 
¡©us
 = 
EPERM
;

1855 
¡©us
 = 1;

1857 
	`sd_şo£
(&
mª
->
cÚÃùiÚ
.
sd_şi
);

1863 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
	`ü—‹_sock‘_tı
(mª->
£‰šgs
.
loÿl
);

1864 
¡©us
 = 
	`İ’v²_cÚÃù
(
mª
->
cÚÃùiÚ
.
sd_şi
,

1865 
mª
->
£‰šgs
.
loÿl
->
ai_addr
,

1867 &
sigÇl_»ûived
);

1870 ià(
sigÇl_»ûived
)

1872 
	`throw_sigÇl
(
sigÇl_»ûived
);

1873 
dÚe
;

1876 ià(
¡©us
)

1878 #ià
UNIX_SOCK_SUPPORT


1879 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UNIX_SOCK
)

1881 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
,

1883 
	`sockaddr_unix_Çme
(&
mª
->
£‰šgs
.
loÿl_unix
, "NULL"));

1887 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
,

1889 
	`´št_sockaddr
(
mª
->
£‰šgs
.
loÿl
->
ai_addr
, &
gc
));

1890 
	`throw_sigÇl_soá
(
SIGTERM
, "management-connect-failed");

1891 
dÚe
;

1894 
	`mª_»cÜd_³”_šfo
(
mª
);

1895 
	`mª_Ãw_cÚÃùiÚ_po¡
(
mª
, "Connectedo management server‡t");

1897 
dÚe
:

1898 
	`gc_ä“
(&
gc
);

1899 
	}
}

1902 
	$mª_»£t_ş›Á_sock‘
(
mªagem’t
 *
mª
, cÚ¡ 
boŞ
 
ex™šg
)

1904 ià(
	`sock‘_defšed
(
mª
->
cÚÃùiÚ
.
sd_şi
))

1906 #ifdeà
_WIN32


1907 
	`mª_¡İ_Ã32
(
mª
);

1909 
	`mª_şo£_sock‘
(
mª
, mª->
cÚÃùiÚ
.
sd_şi
);

1910 
mª
->
cÚÃùiÚ
.
sd_şi
 = 
SOCKET_UNDEFINED
;

1911 
mª
->
cÚÃùiÚ
.
¡©e
 = 
MS_INITIAL
;

1912 
	`commªd_lše_»£t
(
mª
->
cÚÃùiÚ
.
š
);

1913 
	`bufãr_li¡_»£t
(
mª
->
cÚÃùiÚ
.
out
);

1914 #ifdeà
MANAGEMENT_IN_EXTRA


1915 
	`š_exŒa_»£t
(&
mª
->
cÚÃùiÚ
, 
IER_RESET
);

1917 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: Client disconnected");

1919 ià(!
ex™šg
)

1921 #ifdeà
ENABLE_CRYPTO


1922 ià(
mª
->
£‰šgs
.
æags
 & 
MF_FORGET_DISCONNECT
)

1924 
	`s¦_purge_auth
(
çl£
);

1927 ià(
mª
->
£‰šgs
.
æags
 & 
MF_SIGNAL
)

1929 
mysig
 = 
	`mª_mod_sigÇl
(
mª
, 
SIGUSR1
);

1930 ià(
mysig
 >= 0)

1932 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: Triggering management signal");

1933 
	`throw_sigÇl_soá
(
mysig
, "management-disconnect");

1937 ià(
mª
->
£‰šgs
.
æags
 & 
MF_CONNECT_AS_CLIENT
)

1939 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: Triggering managementƒxit");

1940 
	`throw_sigÇl_soá
(
SIGTERM
, "management-exit");

1944 
	`mª_li¡’
(
mª
);

1947 
	}
}

1950 
	$mª_´oûss_commªd
(
mªagem’t
 *
mª
, cÚ¡ *
lše
)

1952 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1953 
¡©us_ouut
 *
so
;

1954 
Å¬ms
;

1955 *
·rms
[
MAX_PARMS
+1];

1957 
	`CLEAR
(
·rms
);

1958 
so
 = 
	`¡©us_İ’
(
NULL
, 0, -1, &
mª
->
³rsi¡
.
vout
, 0);

1959 #ifdeà
MANAGEMENT_IN_EXTRA


1960 
	`š_exŒa_»£t
(&
mª
->
cÚÃùiÚ
, 
IER_RESET
);

1963 ià(
	`mª_·sswÜd_Ãeded
(
mª
))

1965 
	`mª_check_·sswÜd
(
mª
, 
lše
);

1969 
Å¬ms
 = 
	`·r£_lše
(
lše
, 
·rms
, 
MAX_PARMS
, "TCP", 0, 
M_CLIENT
, &
gc
);

1970 ià(
·rms
[0] && 
	`¡»q
(parms[0], "password"))

1972 
	`msg
(
D_MANAGEMENT_DEBUG
, "MANAGEMENT: CMD 'password [...]'");

1974 ià(!
	`¡»q
(
lše
, "load-stats"))

1976 
	`msg
(
D_MANAGEMENT_DEBUG
, "MANAGEMENT: CMD '%s'", 
lše
);

1982 
i
;

1983 
i
 = 0; i < 
Å¬ms
; ++i)

1985 
	`msg
(
M_INFO
, "[%d] '%s'", 
i
, 
·rms
[i]);

1990 ià(
Å¬ms
 > 0)

1992 
	`mª_di¥©ch_commªd
(
mª
, 
so
, (cÚ¡ **)
·rms
, 
Å¬ms
);

1996 
	`CLEAR
(
·rms
);

1997 
	`¡©us_şo£
(
so
);

1998 
	`gc_ä“
(&
gc
);

1999 
	}
}

2001 
boŞ


2002 
	$mª_io_”rÜ
(
mªagem’t
 *
mª
, cÚ¡ *
´efix
)

2004 cÚ¡ 
”r
 = 
	`İ’v²_”ºo
();

2006 ià(!
	`ignÜe_sys_”rÜ
(
”r
))

2008 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2009 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: TCP % ”rÜ: %s", 
´efix
,

2010 
	`¡»¼Ü
(
”r
));

2011 
	`gc_ä“
(&
gc
);

2012  
Œue
;

2016  
çl£
;

2018 
	}
}

2020 #ifdeà
TARGET_ANDROID


2021 
ssize_t


2022 
	$mª_£nd_w™h_fd
(
fd
, *
±r
, 
size_t
 
nby‹s
, 
æags
, 
£ndfd
)

2024 
msghdr
 
msg
;

2025 
iovec
 
iov
[1];

2028 
cmsghdr
 
cm
;

2029 
cÚŒŞ
[
	`CMSG_SPACE
(())];

2030 } 
cÚŒŞ_un
;

2031 
cmsghdr
 *
cm±r
;

2033 
msg
.
msg_cÚŒŞ
 = 
cÚŒŞ_un
.
cÚŒŞ
;

2034 
msg
.
msg_cÚŒŞËn
 = (
cÚŒŞ_un
.
cÚŒŞ
);

2036 
cm±r
 = 
	`CMSG_FIRSTHDR
(&
msg
);

2037 
cm±r
->
cmsg_Ën
 = 
	`CMSG_LEN
(());

2038 
cm±r
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

2039 
cm±r
->
cmsg_ty³
 = 
SCM_RIGHTS
;

2040 *((*è
	`CMSG_DATA
(
cm±r
)èğ
£ndfd
;

2042 
msg
.
msg_Çme
 = 
NULL
;

2043 
msg
.
msg_Çm–’
 = 0;

2045 
iov
[0].
iov_ba£
 = 
±r
;

2046 
iov
[0].
iov_Ën
 = 
nby‹s
;

2047 
msg
.
msg_iov
 = 
iov
;

2048 
msg
.
msg_iovËn
 = 1;

2050  (
	`£ndmsg
(
fd
, &
msg
, 
æags
));

2051 
	}
}

2053 
ssize_t


2054 
	$mª_»cv_w™h_fd
(
fd
, *
±r
, 
size_t
 
nby‹s
, 
æags
, *
»cvfd
)

2056 
msghdr
 msghdr;

2057 
iovec
 
iov
[1];

2058 
ssize_t
 
n
;

2061 
cmsghdr
 
cm
;

2062 
cÚŒŞ
[
	`CMSG_SPACE
(())];

2063 } 
cÚŒŞ_un
;

2064 
cmsghdr
 *
cm±r
;

2066 
msghdr
.
msg_cÚŒŞ
 = 
cÚŒŞ_un
.
cÚŒŞ
;

2067 
msghdr
.
msg_cÚŒŞËn
 = (
cÚŒŞ_un
.
cÚŒŞ
);

2069 
msghdr
.
msg_Çme
 = 
NULL
;

2070 
msghdr
.
msg_Çm–’
 = 0;

2072 
iov
[0].
iov_ba£
 = 
±r
;

2073 
iov
[0].
iov_Ën
 = 
nby‹s
;

2074 
msghdr
.
msg_iov
 = 
iov
;

2075 
msghdr
.
msg_iovËn
 = 1;

2077 iàĞ(
n
 = 
	`»cvmsg
(
fd
, &
msghdr
, 
æags
)) <= 0)

2079  (
n
);

2082 iàĞ(
cm±r
 = 
	`CMSG_FIRSTHDR
(&
msghdr
)è!ğ
NULL


2083 && 
cm±r
->
cmsg_Ën
 =ğ
	`CMSG_LEN
(()))

2085 ià(
cm±r
->
cmsg_Ëv–
 !ğ
SOL_SOCKET
)

2087 
	`msg
(
M_ERR
, "control†evel != SOL_SOCKET");

2089 ià(
cm±r
->
cmsg_ty³
 !ğ
SCM_RIGHTS
)

2091 
	`msg
(
M_ERR
, "controlype != SCM_RIGHTS");

2093 *
»cvfd
 = *((*è
	`CMSG_DATA
(
cm±r
));

2097 *
»cvfd
 = -1;

2100  (
n
);

2101 
	}
}

2107 
boŞ


2108 
	$mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
 *
mª
, cÚ¡ *
commªd
, cÚ¡ *
msg
)

2110 
u£r_·ss
 
up
;

2111 
	`CLEAR
(
up
);

2112 
	`¡ºıy
(
up
.
u£ºame
, 
msg
, (up.username)-1);

2114 
	`mªagem’t_qu”y_u£r_·ss
(
mªagem’t
, &
up
, 
commªd
, 
GET_USER_PASS_NEED_OK
,(*) 0);

2115  
	`¡rcmp
("ok", 
up
.
·sswÜd
)==0;

2116 
	}
}

2125 
	$mªagm’t_ªdroid_³rsi¡tun_aùiÚ
(
mªagem’t
 *
mª
)

2127 
u£r_·ss
 
up
;

2128 
	`CLEAR
(
up
);

2129 
	`¡rıy
(
up
.
u£ºame
,"tunmethod");

2130 
	`mªagem’t_qu”y_u£r_·ss
(
mªagem’t
, &
up
, "PERSIST_TUN_ACTION",

2131 
GET_USER_PASS_NEED_OK
,(*) 0);

2132 ià(!
	`¡rcmp
("NOACTION", 
up
.
·sswÜd
))

2134  
ANDROID_KEEP_OLD_TUN
;

2136 ià(!
	`¡rcmp
("OPEN_AFTER_CLOSE", 
up
.
·sswÜd
))

2138  
ANDROID_OPEN_AFTER_CLOSE
;

2140 ià(!
	`¡rcmp
("OPEN_BEFORE_CLOSE", 
up
.
·sswÜd
))

2142  
ANDROID_OPEN_BEFORE_CLOSE
;

2146 
	`msg
(
M_ERR
, "GÙ uÄecogni£d '%s' from mªagem’ˆfÜ PERSIST_TUN_ACTION qu”y", 
up
.
·sswÜd
);

2149 
	`ASSERT
(0);

2150  
ANDROID_OPEN_AFTER_CLOSE
;

2151 
	}
}

2157 
	$mª_»ad
(
mªagem’t
 *
mª
)

2162 
buf
[256];

2163 
Ën
 = 0;

2165 #ifdeà
TARGET_ANDROID


2166 
fd
;

2167 
Ën
 = 
	`mª_»cv_w™h_fd
(
mª
->
cÚÃùiÚ
.
sd_şi
, 
buf
, (buf), 
MSG_NOSIGNAL
, &
fd
);

2168 ià(
fd
 >= 0)

2170 
mª
->
cÚÃùiÚ
.
Ï¡fd»ûived
 = 
fd
;

2173 
Ën
 = 
	`»cv
(
mª
->
cÚÃùiÚ
.
sd_şi
, 
buf
, (buf), 
MSG_NOSIGNAL
);

2176 ià(
Ën
 == 0)

2178 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
çl£
);

2180 ià(
Ën
 > 0)

2182 
boŞ
 
´oûs£d_commªd
 = 
çl£
;

2184 
	`ASSERT
(
Ën
 <ğ(è(
buf
));

2185 
	`commªd_lše_add
(
mª
->
cÚÃùiÚ
.
š
, 
buf
, 
Ën
);

2190 
	`bufãr_li¡_»£t
(
mª
->
cÚÃùiÚ
.
out
);

2196 cÚ¡ *
lše
;

2197 (
lše
 = 
	`commªd_lše_g‘
(
mª
->
cÚÃùiÚ
.
š
)))

2199 #ifdeà
MANAGEMENT_IN_EXTRA


2200 ià(
mª
->
cÚÃùiÚ
.
š_exŒa
)

2202 ià(!
	`¡rcmp
(
lše
, "END"))

2204 
	`š_exŒa_di¥©ch
(
mª
);

2208 
	`bufãr_li¡_push
(
mª
->
cÚÃùiÚ
.
š_exŒa
, 
lše
);

2213 
	`mª_´oûss_commªd
(
mª
, (*è
lše
);

2214 ià(
mª
->
cÚÃùiÚ
.
h®t
)

2218 
	`commªd_lše_Ãxt
(
mª
->
cÚÃùiÚ
.
š
);

2219 
´oûs£d_commªd
 = 
Œue
;

2226 ià(
mª
->
cÚÃùiÚ
.
h®t
)

2228 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
çl£
);

2229 
Ën
 = 0;

2233 ià(
´oûs£d_commªd
)

2235 
	`mª_´om±
(
mª
);

2237 
	`mª_upd©e_io_¡©e
(
mª
);

2242 ià(
	`mª_io_”rÜ
(
mª
, "recv"))

2244 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
çl£
);

2247  
Ën
;

2248 
	}
}

2251 
	$mª_wr™e
(
mªagem’t
 *
mª
)

2253 cÚ¡ 
size_hšt
 = 1024;

2254 
£Á
 = 0;

2255 cÚ¡ 
bufãr
 *
buf
;

2257 
	`bufãr_li¡_agg»g©e
(
mª
->
cÚÃùiÚ
.
out
, 
size_hšt
);

2258 
buf
 = 
	`bufãr_li¡_³ek
(
mª
->
cÚÃùiÚ
.
out
);

2259 ià(
buf
 && 
	`BLEN
(buf))

2261 cÚ¡ 
Ën
 = 
	`mš_št
(
size_hšt
, 
	`BLEN
(
buf
));

2262 #ifdeà
TARGET_ANDROID


2263 ià(
mª
->
cÚÃùiÚ
.
fdto£nd
 > 0)

2265 
£Á
 = 
	`mª_£nd_w™h_fd
(
mª
->
cÚÃùiÚ
.
sd_şi
, 
	`BPTR
(
buf
), 
Ën
, 
MSG_NOSIGNAL
,mª->cÚÃùiÚ.
fdto£nd
);

2266 
mª
->
cÚÃùiÚ
.
fdto£nd
 = -1;

2270 
£Á
 = 
	`£nd
(
mª
->
cÚÃùiÚ
.
sd_şi
, 
	`BPTR
(
buf
), 
Ën
, 
MSG_NOSIGNAL
);

2271 ià(
£Á
 >= 0)

2273 
	`bufãr_li¡_advªû
(
mª
->
cÚÃùiÚ
.
out
, 
£Á
);

2275 ià(
£Á
 < 0)

2277 ià(
	`mª_io_”rÜ
(
mª
, "send"))

2279 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
çl£
);

2287 
	`mª_upd©e_io_¡©e
(
mª
);

2289  
£Á
;

2290 
	}
}

2293 
	$mª_cÚÃùiÚ_ş—r
(
mª_cÚÃùiÚ
 *
mc
)

2295 
	`CLEAR
(*
mc
);

2298 
mc
->
¡©e
 = 
MS_INITIAL
;

2301 
mc
->
sd_tİ
 = 
SOCKET_UNDEFINED
;

2302 
mc
->
sd_şi
 = 
SOCKET_UNDEFINED
;

2303 
	}
}

2306 
	$mª_³rsi¡_š™
(
mªagem’t
 *
mª
,

2307 cÚ¡ 
log_hi¡Üy_ÿche
,

2308 cÚ¡ 
echo_bufãr_size
,

2309 cÚ¡ 
¡©e_bufãr_size
)

2311 
mª_³rsi¡
 *
mp
 = &
mª
->
³rsi¡
;

2312 ià(!
mp
->
defšed
)

2314 
	`CLEAR
(*
mp
);

2317 
mp
->
log
 = 
	`log_hi¡Üy_š™
(
log_hi¡Üy_ÿche
);

2324 
mp
->
vout
.
func
 = 
vœtu®_ouut_ÿÎback_func
;

2325 
mp
->
vout
.
¬g
 = 
mª
;

2326 
mp
->
vout
.
æags_deçuÉ
 = 
M_CLIENT
;

2327 
	`msg_£t_vœtu®_ouut
(&
mp
->
vout
);

2332 
mª
->
³rsi¡
.
echo
 = 
	`log_hi¡Üy_š™
(
echo_bufãr_size
);

2337 
mª
->
³rsi¡
.
¡©e
 = 
	`log_hi¡Üy_š™
(
¡©e_bufãr_size
);

2339 
mp
->
defšed
 = 
Œue
;

2341 
	}
}

2344 
	$mª_³rsi¡_şo£
(
mª_³rsi¡
 *
mp
)

2346 ià(
mp
->
log
)

2348 
	`msg_£t_vœtu®_ouut
(
NULL
);

2349 
	`log_hi¡Üy_şo£
(
mp
->
log
);

2352 ià(
mp
->
echo
)

2354 
	`log_hi¡Üy_şo£
(
mp
->
echo
);

2357 ià(
mp
->
¡©e
)

2359 
	`log_hi¡Üy_şo£
(
mp
->
¡©e
);

2362 
	`CLEAR
(*
mp
);

2363 
	}
}

2366 
	$mª_£‰šgs_š™
(
mª_£‰šgs
 *
ms
,

2367 cÚ¡ *
addr
,

2368 cÚ¡ *
pÜt
,

2369 cÚ¡ *
·ss_fe
,

2370 cÚ¡ *
ş›Á_u£r
,

2371 cÚ¡ *
ş›Á_group
,

2372 cÚ¡ 
log_hi¡Üy_ÿche
,

2373 cÚ¡ 
echo_bufãr_size
,

2374 cÚ¡ 
¡©e_bufãr_size
,

2375 cÚ¡ *
wr™e_³”_šfo_fe
,

2376 cÚ¡ 
»m­_sigu¤1
,

2377 cÚ¡ 
æags
)

2379 ià(!
ms
->
defšed
)

2381 
	`CLEAR
(*
ms
);

2383 
ms
->
æags
 = flags;

2384 
ms
->
ş›Á_uid
 = -1;

2385 
ms
->
ş›Á_gid
 = -1;

2390 ià(
·ss_fe
)

2392 
	`g‘_u£r_·ss
(&
ms
->
up
, 
·ss_fe
, "Mªagem’t", 
GET_USER_PASS_PASSWORD_ONLY
);

2398 ià(
ş›Á_u£r
)

2400 
¶©fÜm_¡©e_u£r
 
s
;

2401 
	`¶©fÜm_u£r_g‘
(
ş›Á_u£r
, &
s
);

2402 
ms
->
ş›Á_uid
 = 
	`¶©fÜm_¡©e_u£r_uid
(&
s
);

2403 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: cl›Á_uid=%d", 
ms
->
ş›Á_uid
);

2404 
	`ASSERT
(
ms
->
ş›Á_uid
 >= 0);

2406 ià(
ş›Á_group
)

2408 
¶©fÜm_¡©e_group
 
s
;

2409 
	`¶©fÜm_group_g‘
(
ş›Á_group
, &
s
);

2410 
ms
->
ş›Á_gid
 = 
	`¶©fÜm_¡©e_group_gid
(&
s
);

2411 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: cl›Á_gid=%d", 
ms
->
ş›Á_gid
);

2412 
	`ASSERT
(
ms
->
ş›Á_gid
 >= 0);

2415 
ms
->
wr™e_³”_šfo_fe
 = 
	`¡ršg_®loc
(wr™e_³”_šfo_fe, 
NULL
);

2417 #ià
UNIX_SOCK_SUPPORT


2418 ià(
ms
->
æags
 & 
MF_UNIX_SOCK
)

2420 
	`sockaddr_unix_š™
(&
ms
->
loÿl_unix
, 
addr
);

2430 ià(
	`¡»q
(
addr
, "tuÂ–"è&& !(
æags
 & 
MF_CONNECT_AS_CLIENT
))

2432 
ms
->
mªagem’t_ov”_tuÂ–
 = 
Œue
;

2436 
¡©us
;

2437 
»sŞve_æags
 = 
GETADDR_RESOLVE
|
GETADDR_WARN_ON_SIGNAL
|
GETADDR_FATAL
;

2439 ià(!(
æags
 & 
MF_CONNECT_AS_CLIENT
))

2441 
»sŞve_æags
 |ğ
GETADDR_PASSIVE
;

2444 
¡©us
 = 
	`İ’v²_g‘addršfo
(
»sŞve_æags
, 
addr
, 
pÜt
, 0,

2445 
NULL
, 
AF_UNSPEC
, &
ms
->
loÿl
);

2446 
	`ASSERT
(
¡©us
==0);

2453 
ms
->
log_hi¡Üy_ÿche
 =†og_history_cache;

2454 
ms
->
echo_bufãr_size
 =ƒcho_buffer_size;

2455 
ms
->
¡©e_bufãr_size
 = state_buffer_size;

2460 ià(
»m­_sigu¤1
 =ğ
SIGHUP
)

2462 
ms
->
mªsig
 |ğ
MANSIG_MAP_USR1_TO_HUP
;

2464 ià(
»m­_sigu¤1
 =ğ
SIGTERM
)

2466 
ms
->
mªsig
 |ğ
MANSIG_MAP_USR1_TO_TERM
;

2469 
ms
->
defšed
 = 
Œue
;

2471 
	}
}

2474 
	$mª_£‰šgs_şo£
(
mª_£‰šgs
 *
ms
)

2476 ià(
ms
->
loÿl
)

2478 
	`ä“addršfo
(
ms
->
loÿl
);

2480 
	`ä“
(
ms
->
wr™e_³”_šfo_fe
);

2481 
	`CLEAR
(*
ms
);

2482 
	}
}

2486 
	$mª_cÚÃùiÚ_š™
(
mªagem’t
 *
mª
)

2488 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_INITIAL
)

2490 #ifdeà
_WIN32


2495 
	`Ãt_ev’t_wš32_š™
(&
mª
->
cÚÃùiÚ
.
Ã32
);

2502 
mª
->
cÚÃùiÚ
.
š
 = 
	`commªd_lše_Ãw
(1024);

2503 
mª
->
cÚÃùiÚ
.
out
 = 
	`bufãr_li¡_Ãw
(0);

2510 
maxev’ts
 = 1;

2511 
mª
->
cÚÃùiÚ
.
es
 = 
	`ev’t_£t_š™
(&
maxev’ts
, 
EVENT_METHOD_FAST
);

2517 ià(
mª
->
£‰šgs
.
æags
 & 
MF_CONNECT_AS_CLIENT
)

2519 
	`mª_cÚÃù
(
mª
);

2523 
	`mª_li¡’
(
mª
);

2526 
	}
}

2529 
	$mª_cÚÃùiÚ_şo£
(
mªagem’t
 *
mª
)

2531 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

2533 ià(
mc
->
es
)

2535 
	`ev’t_ä“
(
mc
->
es
);

2537 #ifdeà
_WIN32


2538 
	`Ãt_ev’t_wš32_şo£
(&
mc
->
Ã32
);

2540 ià(
	`sock‘_defšed
(
mc
->
sd_tİ
))

2542 
	`mª_şo£_sock‘
(
mª
, 
mc
->
sd_tİ
);

2543 
	`mª_d–‘e_unix_sock‘
(
mª
);

2545 ià(
	`sock‘_defšed
(
mc
->
sd_şi
))

2547 
	`mª_şo£_sock‘
(
mª
, 
mc
->
sd_şi
);

2549 ià(
mc
->
š
)

2551 
	`commªd_lše_ä“
(
mc
->
š
);

2553 ià(
mc
->
out
)

2555 
	`bufãr_li¡_ä“
(
mc
->
out
);

2557 #ifdeà
MANAGEMENT_IN_EXTRA


2558 
	`š_exŒa_»£t
(&
mª
->
cÚÃùiÚ
, 
IER_RESET
);

2560 #ifdeà
MANAGMENT_EXTERNAL_KEY


2561 
	`bufãr_li¡_ä“
(
mc
->
ext_key_šput
);

2563 
	`mª_cÚÃùiÚ_ş—r
(
mc
);

2564 
	}
}

2566 
mªagem’t
 *

2567 
	$mªagem’t_š™
()

2569 
mªagem’t
 *
mª
;

2570 
	`ALLOC_OBJ_CLEAR
(
mª
, 
mªagem’t
);

2572 
	`mª_³rsi¡_š™
(
mª
,

2573 
MANAGEMENT_LOG_HISTORY_INITIAL_SIZE
,

2574 
MANAGEMENT_ECHO_BUFFER_SIZE
,

2575 
MANAGEMENT_STATE_BUFFER_SIZE
);

2577 
	`mª_cÚÃùiÚ_ş—r
(&
mª
->
cÚÃùiÚ
);

2579  
mª
;

2580 
	}
}

2582 
boŞ


2583 
	$mªagem’t_İ’
(
mªagem’t
 *
mª
,

2584 cÚ¡ *
addr
,

2585 cÚ¡ *
pÜt
,

2586 cÚ¡ *
·ss_fe
,

2587 cÚ¡ *
ş›Á_u£r
,

2588 cÚ¡ *
ş›Á_group
,

2589 cÚ¡ 
log_hi¡Üy_ÿche
,

2590 cÚ¡ 
echo_bufãr_size
,

2591 cÚ¡ 
¡©e_bufãr_size
,

2592 cÚ¡ *
wr™e_³”_šfo_fe
,

2593 cÚ¡ 
»m­_sigu¤1
,

2594 cÚ¡ 
æags
)

2596 
boŞ
 
»t
 = 
çl£
;

2602 
	`mª_£‰šgs_š™
(&
mª
->
£‰šgs
,

2603 
addr
,

2604 
pÜt
,

2605 
·ss_fe
,

2606 
ş›Á_u£r
,

2607 
ş›Á_group
,

2608 
log_hi¡Üy_ÿche
,

2609 
echo_bufãr_size
,

2610 
¡©e_bufãr_size
,

2611 
wr™e_³”_šfo_fe
,

2612 
»m­_sigu¤1
,

2613 
æags
);

2619 
	`log_hi¡Üy_»size
(
mª
->
³rsi¡
.
log
, mª->
£‰šgs
.
log_hi¡Üy_ÿche
);

2620 
	`log_hi¡Üy_»size
(
mª
->
³rsi¡
.
echo
, mª->
£‰šgs
.
echo_bufãr_size
);

2621 
	`log_hi¡Üy_»size
(
mª
->
³rsi¡
.
¡©e
, mª->
£‰šgs
.
¡©e_bufãr_size
);

2627 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_INITIAL
)

2629 ià(!
mª
->
£‰šgs
.
mªagem’t_ov”_tuÂ–
)

2631 
	`mª_cÚÃùiÚ_š™
(
mª
);

2632 
»t
 = 
Œue
;

2636  
»t
;

2637 
	}
}

2640 
	$mªagem’t_şo£
(
mªagem’t
 *
mª
)

2642 
	`mª_ouut_li¡_push_fš®ize
(
mª
);

2643 
	`mª_cÚÃùiÚ_şo£
(
mª
);

2644 
	`mª_£‰šgs_şo£
(&
mª
->
£‰šgs
);

2645 
	`mª_³rsi¡_şo£
(&
mª
->
³rsi¡
);

2646 
	`ä“
(
mª
);

2647 
	}
}

2650 
	$mªagem’t_£t_ÿÎback
(
mªagem’t
 *
mª
,

2651 cÚ¡ 
mªagem’t_ÿÎback
 *
cb
)

2653 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
Œue
;

2654 
mª
->
³rsi¡
.
ÿÎback
 = *
cb
;

2655 
	}
}

2658 
	$mªagem’t_ş—r_ÿÎback
(
mªagem’t
 *
mª
)

2660 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

2661 
mª
->
³rsi¡
.
hŞd_»Ëa£
 = 
çl£
;

2662 
	`CLEAR
(
mª
->
³rsi¡
.
ÿÎback
);

2663 
	`mª_ouut_li¡_push_fš®ize
(
mª
);

2664 
	}
}

2667 
	$mªagem’t_£t_¡©e
(
mªagem’t
 *
mª
,

2668 cÚ¡ 
¡©e
,

2669 cÚ¡ *
d‘a
,

2670 cÚ¡ 
š_addr_t
 *
tun_loÿl_
,

2671 cÚ¡ 
š6_addr
 *
tun_loÿl_6
,

2672 cÚ¡ 
İ’v²_sockaddr
 *
loÿl
,

2673 cÚ¡ 
İ’v²_sockaddr
 *
»mÙe
)

2675 ià(
mª
->
³rsi¡
.
¡©e
 && (!(mª->
£‰šgs
.
æags
 & 
MF_SERVER
è|| s‹ < 
OPENVPN_STATE_CLIENT_BASE
))

2677 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2678 
log_’Œy
 
e
;

2679 cÚ¡ *
out
 = 
NULL
;

2681 
	`upd©e_time
();

2682 
	`CLEAR
(
e
);

2683 
e
.
time¡amp
 = 
now
;

2684 
e
.
u
.
¡©e
 = state;

2685 
e
.
¡ršg
 = 
d‘a
;

2686 ià(
tun_loÿl_
)

2688 
e
.
loÿl_
 = *
tun_loÿl_
;

2690 ià(
tun_loÿl_6
)

2692 
e
.
loÿl_6
 = *
tun_loÿl_6
;

2694 ià(
loÿl
)

2696 
e
.
loÿl_sock
 = *
loÿl
;

2698 ià(
»mÙe
)

2700 
e
.
»mÙe_sock
 = *
»mÙe
;

2703 
	`log_hi¡Üy_add
(
mª
->
³rsi¡
.
¡©e
, &
e
);

2705 ià(
mª
->
cÚÃùiÚ
.
¡©e_»®time
)

2707 
out
 = 
	`log_’Œy_´št
(&
e
, 
LOG_PRINT_STATE_PREFIX


2708 | 
LOG_PRINT_INT_DATE


2709 | 
LOG_PRINT_STATE


2710 | 
LOG_PRINT_LOCAL_IP


2711 | 
LOG_PRINT_REMOTE_IP


2712 | 
LOG_PRINT_CRLF


2713 | 
LOG_ECHO_TO_LOG
, &
gc
);

2716 ià(
out
)

2718 
	`mª_ouut_li¡_push
(
mª
, 
out
);

2721 
	`gc_ä“
(&
gc
);

2723 
	}
}

2725 
boŞ


2726 
	$’v_f‹r_m©ch
(cÚ¡ *
’v_¡r
, cÚ¡ 
’v_f‹r_Ëv–
)

2728 cÚ¡ *
’v_Çmes
[] = {

2746 ià(
’v_f‹r_Ëv–
 == 0)

2748  
Œue
;

2750 ià(
’v_f‹r_Ëv–
 <ğ1 && !
	`¡ºcmp
(
’v_¡r
, "X509_", 5))

2752  
Œue
;

2754 ià(
’v_f‹r_Ëv–
 <= 2)

2756 
size_t
 
i
;

2757 
i
 = 0; i < 
	`SIZE
(
’v_Çmes
); ++i)

2759 cÚ¡ *
’
 = 
’v_Çmes
[
i
];

2760 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
(
’
);

2761 ià(!
	`¡ºcmp
(
’v_¡r
, 
’
, 
Ën
))

2763  
Œue
;

2766  
çl£
;

2768  
çl£
;

2769 
	}
}

2772 
	$mª_ouut_’v
(cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
boŞ
 

, cÚ¡ 
’v_f‹r_Ëv–
, cÚ¡ *
´efix
)

2774 ià(
es
)

2776 
’v_™em
 *
e
;

2777 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

2779 ià(
e
->
¡ršg
 && (!
’v_f‹r_Ëv–
 || 
	`’v_f‹r_m©ch
(e->string,ƒnv_filter_level)))

2781 
	`msg
(
M_CLIENT
, ">%s:ENV,%s", 
´efix
, 
e
->
¡ršg
);

2785 ià(

)

2787 
	`msg
(
M_CLIENT
, ">%s:ENV,END", 
´efix
);

2789 
	}
}

2792 
	$mª_ouut_exŒa_’v
(
mªagem’t
 *
mª
, cÚ¡ *
´efix
)

2794 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2795 
’v_£t
 *
es
 = 
	`’v_£t_ü—‹
(&
gc
);

2796 ià(
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)

2798 cÚ¡ 
nş›Ás
 = (*
mª
->
³rsi¡
.
ÿÎback
.
n_ş›Ás
)(mª->³rsi¡.ÿÎback.
¬g
);

2799 
	`£‹nv_št
(
es
, "n_ş›Ás", 
nş›Ás
);

2801 
	`mª_ouut_’v
(
es
, 
çl£
, 
mª
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
, 
´efix
);

2802 
	`gc_ä“
(&
gc
);

2803 
	}
}

2806 
	$mªagem’t_up_down
(
mªagem’t
 *
mª
, cÚ¡ *
updown
, cÚ¡ 
’v_£t
 *
es
)

2808 ià(
mª
->
£‰šgs
.
æags
 & 
MF_UP_DOWN
)

2810 
	`msg
(
M_CLIENT
, ">UPDOWN:%s", 
updown
);

2811 
	`mª_ouut_’v
(
es
, 
Œue
, 0, "UPDOWN");

2813 
	}
}

2816 
	$mªagem’t_nÙify
(
mªagem’t
 *
mª
, cÚ¡ *
£v”™y
, cÚ¡ *
ty³
, cÚ¡ *
‹xt
)

2818 
	`msg
(
M_CLIENT
, ">NOTIFY:%s,%s,%s", 
£v”™y
, 
ty³
, 
‹xt
);

2819 
	}
}

2822 
	$mªagem’t_nÙify_g’”ic
(
mªagem’t
 *
mª
, cÚ¡ *
¡r
)

2824 
	`msg
(
M_CLIENT
, "%s", 
¡r
);

2825 
	}
}

2827 #ifdeà
MANAGEMENT_DEF_AUTH


2830 
	$mª_ouut_³”_šfo_’v
(
mªagem’t
 *
mª
, 
mª_def_auth_cÚ‹xt
 *
mdac
)

2832 
lše
[256];

2833 ià(
mª
->
³rsi¡
.
ÿÎback
.
g‘_³”_šfo
)

2835 cÚ¡ *
³”_šfo
 = (*
mª
->
³rsi¡
.
ÿÎback
.
g‘_³”_šfo
)(mª->³rsi¡.ÿÎback.
¬g
, 
mdac
->
cid
);

2836 ià(
³”_šfo
)

2838 
bufãr
 
buf
;

2839 
	`buf_£t_»ad
(&
buf
, (cÚ¡ 
ušt8_t
 *è
³”_šfo
, 
	`¡¾’
(peer_info));

2840 
	`buf_·r£
(&
buf
, '\n', 
lše
, (line)))

2842 
	`chomp
(
lše
);

2843 ià(
	`v®id©e_³”_šfo_lše
(
lše
))

2845 
	`msg
(
M_CLIENT
, ">CLIENT:ENV,%s", 
lše
);

2849 
	`msg
(
D_MANAGEMENT
, "validation failed on…eer_info†ine„eceived from client");

2854 
	}
}

2857 
	$mªagem’t_nÙify_ş›Á_Ãedšg_auth
(
mªagem’t
 *management,

2858 cÚ¡ 
mda_key_id
,

2859 
mª_def_auth_cÚ‹xt
 *
mdac
,

2860 cÚ¡ 
’v_£t
 *
es
)

2862 ià(!(
mdac
->
æags
 & 
DAF_CONNECTION_CLOSED
))

2864 cÚ¡ *
mode
 = "CONNECT";

2865 ià(
mdac
->
æags
 & 
DAF_CONNECTION_ESTABLISHED
)

2867 
mode
 = "REAUTH";

2869 
	`msg
(
M_CLIENT
, ">CLIENT:%s,%lu,%u", 
mode
, 
mdac
->
cid
, 
mda_key_id
);

2870 
	`mª_ouut_exŒa_’v
(
mªagem’t
, "CLIENT");

2871 ià(
mªagem’t
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
>0)

2873 
	`mª_ouut_³”_šfo_’v
(
mªagem’t
, 
mdac
);

2875 
	`mª_ouut_’v
(
es
, 
Œue
, 
mªagem’t
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
, "CLIENT");

2876 
mdac
->
æags
 |ğ
DAF_INITIAL_AUTH
;

2878 
	}
}

2881 
	$mªagem’t_cÚÃùiÚ_e¡ablished
(
mªagem’t
 *management,

2882 
mª_def_auth_cÚ‹xt
 *
mdac
,

2883 cÚ¡ 
’v_£t
 *
es
)

2885 
mdac
->
æags
 |ğ
DAF_CONNECTION_ESTABLISHED
;

2886 
	`msg
(
M_CLIENT
, ">CLIENT:ESTABLISHED,%lu", 
mdac
->
cid
);

2887 
	`mª_ouut_exŒa_’v
(
mªagem’t
, "CLIENT");

2888 
	`mª_ouut_’v
(
es
, 
Œue
, 
mªagem’t
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
, "CLIENT");

2889 
	}
}

2892 
	$mªagem’t_nÙify_ş›Á_şo£
(
mªagem’t
 *management,

2893 
mª_def_auth_cÚ‹xt
 *
mdac
,

2894 cÚ¡ 
’v_£t
 *
es
)

2896 ià((
mdac
->
æags
 & 
DAF_INITIAL_AUTH
è&& !(mdac->æag & 
DAF_CONNECTION_CLOSED
))

2898 
	`msg
(
M_CLIENT
, ">CLIENT:DISCONNECT,%lu", 
mdac
->
cid
);

2899 
	`mª_ouut_’v
(
es
, 
Œue
, 
mªagem’t
->
cÚÃùiÚ
.
’v_f‹r_Ëv–
, "CLIENT");

2900 
mdac
->
æags
 |ğ
DAF_CONNECTION_CLOSED
;

2902 
	}
}

2905 
	$mªagem’t_Ë¬n_addr
(
mªagem’t
 *management,

2906 
mª_def_auth_cÚ‹xt
 *
mdac
,

2907 cÚ¡ 
mrou‹_addr
 *
addr
,

2908 cÚ¡ 
boŞ
 
´im¬y
)

2910 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2911 ià((
mdac
->
æags
 & 
DAF_INITIAL_AUTH
è&& !(mdac->æag & 
DAF_CONNECTION_CLOSED
))

2913 
	`msg
(
M_CLIENT
, ">CLIENT:ADDRESS,%lu,%s,%d",

2914 
mdac
->
cid
,

2915 
	`mrou‹_addr_´št_ex
(
addr
, 
MAPF_SUBNET
, &
gc
),

2916 
	`BOOL_CAST
(
´im¬y
));

2918 
	`gc_ä“
(&
gc
);

2919 
	}
}

2924 
	$mªagem’t_echo
(
mªagem’t
 *
mª
, cÚ¡ *
¡ršg
, cÚ¡ 
boŞ
 
puÎ
)

2926 ià(
mª
->
³rsi¡
.
echo
)

2928 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2929 
log_’Œy
 
e
;

2930 cÚ¡ *
out
 = 
NULL
;

2932 
	`upd©e_time
();

2933 
	`CLEAR
(
e
);

2934 
e
.
time¡amp
 = 
now
;

2935 
e
.
¡ršg
 = string;

2936 
e
.
u
.
štv®
 = 
	`BOOL_CAST
(
puÎ
);

2938 
	`log_hi¡Üy_add
(
mª
->
³rsi¡
.
echo
, &
e
);

2940 ià(
mª
->
cÚÃùiÚ
.
echo_»®time
)

2942 
out
 = 
	`log_’Œy_´št
(&
e
, 
LOG_PRINT_INT_DATE
|
LOG_PRINT_ECHO_PREFIX
|
LOG_PRINT_CRLF
|
MANAGEMENT_ECHO_FLAGS
, &
gc
);

2945 ià(
out
)

2947 
	`mª_ouut_li¡_push
(
mª
, 
out
);

2950 
	`gc_ä“
(&
gc
);

2952 
	}
}

2955 
	$mªagem’t_po¡_tuÂ–_İ’
(
mªagem’t
 *
mª
, cÚ¡ 
š_addr_t
 
tun_loÿl_
)

2961 ià(
mª
->
£‰šgs
.
mªagem’t_ov”_tuÂ–


2962 && 
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_INITIAL
)

2965 
š_addr
 
Ÿ
;

2966 
»t
;

2968 
Ÿ
.
s_addr
 = 
	`htÚl
(
tun_loÿl_
);

2969 
»t
 = 
	`İ’v²_g‘addršfo
(
GETADDR_PASSIVE
, 
	`š‘_Áß
(
Ÿ
), 
NULL
, 0, NULL,

2970 
AF_INET
, &
mª
->
£‰šgs
.
loÿl
);

2971 
	`ASSERT
(
»t
==0);

2972 
	`mª_cÚÃùiÚ_š™
(
mª
);

2975 
	}
}

2978 
	$mªagem’t_´e_tuÂ–_şo£
(
mªagem’t
 *
mª
)

2980 ià(
mª
->
£‰šgs
.
mªagem’t_ov”_tuÂ–
)

2982 
	`mª_cÚÃùiÚ_şo£
(
mª
);

2984 
	}
}

2987 
	$mªagem’t_auth_çu»
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
»asÚ
)

2989 ià(
»asÚ
)

2991 
	`msg
(
M_CLIENT
, ">PASSWORD:V”ifiÿtiÚ Faed: '%s' ['%s']", 
ty³
, 
»asÚ
);

2995 
	`msg
(
M_CLIENT
, ">PASSWORD:V”ifiÿtiÚ Faed: '%s'", 
ty³
);

2997 
	}
}

3000 
	$mªagem’t_auth_tok’
(
mªagem’t
 *
mª
, cÚ¡ *
tok’
)

3002 
	`msg
(
M_CLIENT
, ">PASSWORD:Auth-Tok’:%s", 
tok’
);

3003 
	}
}

3005 
šlše
 
boŞ


3006 
	$mª_³rsi¡_¡©e
(*
³rsi¡’t
, cÚ¡ 
n
)

3008 ià(
³rsi¡’t
)

3010 ià(*
³rsi¡’t
 =ğ()
n
)

3012  
çl£
;

3014 *
³rsi¡’t
 = 
n
;

3016  
Œue
;

3017 
	}
}

3019 #ifdeà
_WIN32


3022 
	$mªagem’t_sock‘_£t
(
mªagem’t
 *
mª
,

3023 
ev’t_£t
 *
es
,

3024 *
¬g
,

3025 *
³rsi¡’t
)

3027 ià(
mª
->
cÚÃùiÚ
.
¡©e
 !ğ
MS_INITIAL
)

3029 
ev’t_t
 
ev
 = 
	`Ãt_ev’t_wš32_g‘_ev’t
(&
mª
->
cÚÃùiÚ
.
Ã32
);

3030 
	`Ãt_ev’t_wš32_»£t_wr™e
(&
mª
->
cÚÃùiÚ
.
Ã32
);

3032 
mª
->
cÚÃùiÚ
.
¡©e
)

3034 
MS_LISTEN
:

3035 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 1))

3037 
	`ev’t_ùl
(
es
, 
ev
, 
EVENT_READ
, 
¬g
);

3041 
MS_CC_WAIT_READ
:

3042 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 2))

3044 
	`ev’t_ùl
(
es
, 
ev
, 
EVENT_READ
, 
¬g
);

3048 
MS_CC_WAIT_WRITE
:

3049 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 3))

3051 
	`ev’t_ùl
(
es
, 
ev
, 
EVENT_READ
|
EVENT_WRITE
, 
¬g
);

3056 
	`ASSERT
(0);

3059 
	}
}

3062 
	$mªagem’t_io
(
mªagem’t
 *
mª
)

3064 ià(
mª
->
cÚÃùiÚ
.
¡©e
 !ğ
MS_INITIAL
)

3066 
Ãt_ev’ts
;

3067 
	`Ãt_ev’t_wš32_»£t
(&
mª
->
cÚÃùiÚ
.
Ã32
);

3068 
Ãt_ev’ts
 = 
	`Ãt_ev’t_wš32_g‘_ev’t_mask
(&
mª
->
cÚÃùiÚ
.
Ã32
);

3070 ià(
Ãt_ev’ts
 & 
FD_CLOSE
)

3072 
	`mª_»£t_ş›Á_sock‘
(
mª
, 
çl£
);

3076 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_LISTEN
)

3078 ià(
Ãt_ev’ts
 & 
FD_ACCEPT
)

3080 
	`mª_acû±
(
mª
);

3081 
	`Ãt_ev’t_wš32_ş—r_£Ëùed_ev’ts
(&
mª
->
cÚÃùiÚ
.
Ã32
, 
FD_ACCEPT
);

3084 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_CC_WAIT_READ
 || mª->cÚÃùiÚ.¡©=ğ
MS_CC_WAIT_WRITE
)

3086 ià(
Ãt_ev’ts
 & 
FD_READ
)

3088 
	`mª_»ad
(
mª
) > 0)

3091 
	`Ãt_ev’t_wš32_ş—r_£Ëùed_ev’ts
(&
mª
->
cÚÃùiÚ
.
Ã32
, 
FD_READ
);

3094 ià(
Ãt_ev’ts
 & 
FD_WRITE
)

3096 
¡©us
;

3097 
¡©us
 = 
	`mª_wr™e
(
mª
);

3098 ià(
¡©us
 < 0 && 
	`WSAG‘La¡E¼Ü
(è=ğ
WSAEWOULDBLOCK
)

3100 
	`Ãt_ev’t_wš32_ş—r_£Ëùed_ev’ts
(&
mª
->
cÚÃùiÚ
.
Ã32
, 
FD_WRITE
);

3106 
	}
}

3111 
	$mªagem’t_sock‘_£t
(
mªagem’t
 *
mª
,

3112 
ev’t_£t
 *
es
,

3113 *
¬g
,

3114 *
³rsi¡’t
)

3116 
mª
->
cÚÃùiÚ
.
¡©e
)

3118 
MS_LISTEN
:

3119 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 1))

3121 
	`ev’t_ùl
(
es
, 
mª
->
cÚÃùiÚ
.
sd_tİ
, 
EVENT_READ
, 
¬g
);

3125 
MS_CC_WAIT_READ
:

3126 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 2))

3128 
	`ev’t_ùl
(
es
, 
mª
->
cÚÃùiÚ
.
sd_şi
, 
EVENT_READ
, 
¬g
);

3132 
MS_CC_WAIT_WRITE
:

3133 ià(
	`mª_³rsi¡_¡©e
(
³rsi¡’t
, 3))

3135 
	`ev’t_ùl
(
es
, 
mª
->
cÚÃùiÚ
.
sd_şi
, 
EVENT_WRITE
, 
¬g
);

3139 
MS_INITIAL
:

3143 
	`ASSERT
(0);

3145 
	}
}

3148 
	$mªagem’t_io
(
mªagem’t
 *
mª
)

3150 
mª
->
cÚÃùiÚ
.
¡©e
)

3152 
MS_LISTEN
:

3153 
	`mª_acû±
(
mª
);

3156 
MS_CC_WAIT_READ
:

3157 
	`mª_»ad
(
mª
);

3160 
MS_CC_WAIT_WRITE
:

3161 
	`mª_wr™e
(
mª
);

3164 
MS_INITIAL
:

3168 
	`ASSERT
(0);

3170 
	}
}

3174 
šlše
 
boŞ


3175 
	$mª_¡ªd®Úe_ok
(cÚ¡ 
mªagem’t
 *
mª
)

3177  !
mª
->
£‰šgs
.
mªagem’t_ov”_tuÂ–
 && mª->
cÚÃùiÚ
.
¡©e
 !ğ
MS_INITIAL
;

3178 
	}
}

3180 
boŞ


3181 
	$mª_check_fÜ_sigÇls
(vŞ©*
sigÇl_»ûived
)

3183 ià(
sigÇl_»ûived
)

3185 
	`g‘_sigÇl
(
sigÇl_»ûived
);

3186 ià(*
sigÇl_»ûived
)

3188  
Œue
;

3191  
çl£
;

3192 
	}
}

3198 
	$mª_block
(
mªagem’t
 *
mª
, vŞ©*
sigÇl_»ûived
, cÚ¡ 
time_t
 
expœe
)

3200 
timev®
 
tv
;

3201 
ev’t_£t_»tuº
 
e¤
;

3202 
¡©us
 = -1;

3204 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3206 
Œue
)

3208 
	`ev’t_»£t
(
mª
->
cÚÃùiÚ
.
es
);

3209 
	`mªagem’t_sock‘_£t
(
mª
, mª->
cÚÃùiÚ
.
es
, 
NULL
, NULL);

3210 
tv
.
tv_u£c
 = 0;

3211 
tv
.
tv_£c
 = 1;

3212 ià(
	`mª_check_fÜ_sigÇls
(
sigÇl_»ûived
))

3214 
¡©us
 = -1;

3217 
¡©us
 = 
	`ev’t_wa™
(
mª
->
cÚÃùiÚ
.
es
, &
tv
, &
e¤
, 1);

3218 
	`upd©e_time
();

3219 ià(
	`mª_check_fÜ_sigÇls
(
sigÇl_»ûived
))

3221 
¡©us
 = -1;

3225 ià(
¡©us
 > 0)

3229 ià(
expœe
 && 
now
 >=ƒxpire)

3232 
¡©us
 = 0;

3233 ià(
sigÇl_»ûived
)

3235 *
sigÇl_»ûived
 = 
SIGINT
;

3241  
¡©us
;

3242 
	}
}

3248 
	$mª_ouut_¡ªd®Úe
(
mªagem’t
 *
mª
, vŞ©*
sigÇl_»ûived
)

3250 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3252 
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_CC_WAIT_WRITE
)

3254 
	`mªagem’t_io
(
mª
);

3255 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_CC_WAIT_WRITE
)

3257 
	`mª_block
(
mª
, 
sigÇl_»ûived
, 0);

3259 ià(
sigÇl_»ûived
 && *signal_received)

3265 
	}
}

3271 
	$mª_¡ªd®Úe_ev’t_loİ
(
mªagem’t
 *
mª
, vŞ©*
sigÇl_»ûived
, cÚ¡ 
time_t
 
expœe
)

3273 
¡©us
 = -1;

3274 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3276 
¡©us
 = 
	`mª_block
(
mª
, 
sigÇl_»ûived
, 
expœe
);

3277 ià(
¡©us
 > 0)

3279 
	`mªagem’t_io
(
mª
);

3282  
¡©us
;

3283 
	}
}

3285 
	#MWCC_PASSWORD_WAIT
 (1<<0)

	)

3286 
	#MWCC_HOLD_WAIT
 (1<<1)

	)

3287 
	#MWCC_OTHER_WAIT
 (1<<2)

	)

3293 
	$mª_wa™_fÜ_ş›Á_cÚÃùiÚ
(
mªagem’t
 *
mª
,

3294 vŞ©*
sigÇl_»ûived
,

3295 cÚ¡ 
time_t
 
expœe
,

3296 
æags
)

3298 
	`ASSERT
(
	`mª_¡ªd®Úe_ok
(
mª
));

3299 ià(
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_LISTEN
)

3301 ià(
æags
 & 
MWCC_PASSWORD_WAIT
)

3303 
	`msg
(
D_MANAGEMENT
, "Need…assword(s) from management interface, waiting...");

3305 ià(
æags
 & 
MWCC_HOLD_WAIT
)

3307 
	`msg
(
D_MANAGEMENT
, "Need hold„elease from management interface, waiting...");

3309 ià(
æags
 & 
MWCC_OTHER_WAIT
)

3311 
	`msg
(
D_MANAGEMENT
, "Need information from management interface, waiting...");

3315 
	`mª_¡ªd®Úe_ev’t_loİ
(
mª
, 
sigÇl_»ûived
, 
expœe
);

3316 ià(
sigÇl_»ûived
 && *signal_received)

3320 } 
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_LISTEN
 || 
	`mª_·sswÜd_Ãeded
(man));

3322 
	}
}

3328 
	$mªagem’t_ev’t_loİ_n_£cÚds
(
mªagem’t
 *
mª
, 
£c
)

3330 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3332 vŞ©
sigÇl_»ûived
 = 0;

3333 cÚ¡ 
boŞ
 
¡ªd®Úe_di§bËd_§ve
 = 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
;

3334 
time_t
 
expœe
 = 0;

3336 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

3339 
	`upd©e_time
();

3340 ià(
£c
)

3342 
expœe
 = 
now
 + 
£c
;

3346 
	`mª_wa™_fÜ_ş›Á_cÚÃùiÚ
(
mª
, &
sigÇl_»ûived
, 
expœe
, 0);

3347 ià(
sigÇl_»ûived
)

3355 
	`mª_¡ªd®Úe_ev’t_loİ
(
mª
, &
sigÇl_»ûived
, 
expœe
);

3356 ià(!
sigÇl_»ûived
)

3358 
	`mª_check_fÜ_sigÇls
(&
sigÇl_»ûived
);

3360 ià(
sigÇl_»ûived
)

3364 
	`upd©e_time
();

3365 } 
expœe
 &&ƒxpœ> 
now
);

3368 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
¡ªd®Úe_di§bËd_§ve
;

3372 
	`¦“p
(
£c
);

3374 
	}
}

3379 
boŞ


3380 
	$mªagem’t_qu”y_u£r_·ss
(
mªagem’t
 *
mª
,

3381 
u£r_·ss
 *
up
,

3382 cÚ¡ *
ty³
,

3383 cÚ¡ 
æags
,

3384 cÚ¡ *
¡©ic_ch®Ënge
)

3386 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3387 
boŞ
 
»t
 = 
çl£
;

3389 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3391 vŞ©
sigÇl_»ûived
 = 0;

3392 cÚ¡ 
boŞ
 
¡ªd®Úe_di§bËd_§ve
 = 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
;

3393 
bufãr
 
®”t_msg
 = 
	`®loc_buf_gc
(128, &
gc
);

3394 cÚ¡ *
®”t_ty³
 = 
NULL
;

3395 cÚ¡ *
´efix
 = 
NULL
;

3396 
up_qu”y_mode
 = 0;

3397 #ifdeà
ENABLE_CLIENT_CR


3398 cÚ¡ *
sc
 = 
NULL
;

3400 
»t
 = 
Œue
;

3401 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

3402 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3404 
	`CLEAR
(
mª
->
cÚÃùiÚ
.
up_qu”y
);

3406 ià(
æags
 & 
GET_USER_PASS_NEED_OK
)

3408 
up_qu”y_mode
 = 
UP_QUERY_NEED_OK
;

3409 
´efix
 = "NEED-OK";

3410 
®”t_ty³
 = "confirmation";

3412 ià(
æags
 & 
GET_USER_PASS_NEED_STR
)

3414 
up_qu”y_mode
 = 
UP_QUERY_NEED_STR
;

3415 
´efix
 = "NEED-STR";

3416 
®”t_ty³
 = "string";

3418 ià(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
)

3420 
up_qu”y_mode
 = 
UP_QUERY_PASS
;

3421 
´efix
 = "PASSWORD";

3422 
®”t_ty³
 = "password";

3426 
up_qu”y_mode
 = 
UP_QUERY_USER_PASS
;

3427 
´efix
 = "PASSWORD";

3428 
®”t_ty³
 = "username/password";

3429 #ifdeà
ENABLE_CLIENT_CR


3430 ià(
¡©ic_ch®Ënge
)

3432 
sc
 = 
¡©ic_ch®Ënge
;

3436 
	`buf_´štf
(&
®”t_msg
, ">%s:Need '%s' %s",

3437 
´efix
,

3438 
ty³
,

3439 
®”t_ty³
);

3441 ià(
æags
 & (
GET_USER_PASS_NEED_OK
 | 
GET_USER_PASS_NEED_STR
))

3443 
	`buf_´štf
(&
®”t_msg
, " MSG:%s", 
up
->
u£ºame
);

3446 #ifdeà
ENABLE_CLIENT_CR


3447 ià(
sc
)

3449 
	`buf_´štf
(&
®”t_msg
, " SC:%d,%s",

3450 
	`BOOL_CAST
(
æags
 & 
GET_USER_PASS_STATIC_CHALLENGE_ECHO
),

3451 
sc
);

3455 
	`mª_wa™_fÜ_ş›Á_cÚÃùiÚ
(
mª
, &
sigÇl_»ûived
, 0, 
MWCC_PASSWORD_WAIT
);

3456 ià(
sigÇl_»ûived
)

3458 
»t
 = 
çl£
;

3461 ià(
»t
)

3463 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
	`BSTR
(&
®”t_msg
);

3464 
	`msg
(
M_CLIENT
, "%s", 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
);

3467 
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 = up_query_mode;

3468 
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
 = 
ty³
;

3473 
	`mª_¡ªd®Úe_ev’t_loİ
(
mª
, &
sigÇl_»ûived
, 0);

3474 ià(!
sigÇl_»ûived
)

3476 
	`mª_check_fÜ_sigÇls
(&
sigÇl_»ûived
);

3478 ià(
sigÇl_»ûived
)

3480 
»t
 = 
çl£
;

3483 } !
mª
->
cÚÃùiÚ
.
up_qu”y
.
defšed
);

3487 
mª
->
cÚÃùiÚ
.
up_qu”y_mode
 = 
UP_QUERY_DISABLED
;

3488 
mª
->
cÚÃùiÚ
.
up_qu”y_ty³
 = 
NULL
;

3489 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
¡ªd®Úe_di§bËd_§ve
;

3490 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3493 ià(!
	`¡rcmp
(
mª
->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
, 
bÏnk_up
))

3495 
	`CLEAR
(
mª
->
cÚÃùiÚ
.
up_qu”y
.
·sswÜd
);

3502 ià(
»t
)

3505 
mª
->
cÚÃùiÚ
.
up_qu”y
.
noÿche
 = 
up
->nocache;

3506 
mª
->
cÚÃùiÚ
.
up_qu”y
.
wa™_fÜ_push
 = 
up
->wait_for_push;

3507 *
up
 = 
mª
->
cÚÃùiÚ
.
up_qu”y
;

3509 
	`£cu»_memz”o
(&
mª
->
cÚÃùiÚ
.
up_qu”y
, (man->connection.up_query));

3512 
	`gc_ä“
(&
gc
);

3513  
»t
;

3514 
	}
}

3516 #ifdeà
MANAGMENT_EXTERNAL_KEY


3519 
	$mªagem’t_qu”y_muÉše
(
mªagem’t
 *
mª
,

3520 cÚ¡ *
b64_d©a
, cÚ¡ *
´om±
, cÚ¡ *
cmd
, *
¡©e
, 
bufãr_li¡
 **
šput
)

3522 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3523 
»t
 = 0;

3524 vŞ©
sigÇl_»ûived
 = 0;

3525 
bufãr
 
®”t_msg
 = 
	`ş—r_buf
();

3526 cÚ¡ 
boŞ
 
¡ªd®Úe_di§bËd_§ve
 = 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
;

3527 
mª_cÚÃùiÚ
 *
mc
 = &
mª
->
cÚÃùiÚ
;

3529 ià(
	`mª_¡ªd®Úe_ok
(
mª
))

3531 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

3532 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3534 *
¡©e
 = 
EKS_SOLICIT
;

3536 ià(
b64_d©a
)

3538 
®”t_msg
 = 
	`®loc_buf_gc
(
	`¡¾’
(
b64_d©a
)+¡¾’(
´om±
)+3, &
gc
);

3539 
	`buf_´štf
(&
®”t_msg
, ">%s:%s", 
´om±
, 
b64_d©a
);

3543 
®”t_msg
 = 
	`®loc_buf_gc
(
	`¡¾’
(
´om±
)+3, &
gc
);

3544 
	`buf_´štf
(&
®”t_msg
, ">%s", 
´om±
);

3547 
	`mª_wa™_fÜ_ş›Á_cÚÃùiÚ
(
mª
, &
sigÇl_»ûived
, 0, 
MWCC_OTHER_WAIT
);

3549 ià(
sigÇl_»ûived
)

3551 
dÚe
;

3554 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
	`BSTR
(&
®”t_msg
);

3555 
	`msg
(
M_CLIENT
, "%s", 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
);

3560 
	`mª_¡ªd®Úe_ev’t_loİ
(
mª
, &
sigÇl_»ûived
, 0);

3561 ià(!
sigÇl_»ûived
)

3563 
	`mª_check_fÜ_sigÇls
(&
sigÇl_»ûived
);

3565 ià(
sigÇl_»ûived
)

3567 
dÚe
;

3569 } *
¡©e
 !ğ
EKS_READY
);

3571 
»t
 = 1;

3574 
dÚe
:

3575 ià(*
¡©e
 =ğ
EKS_READY
 && 
»t
)

3577 
	`msg
(
M_CLIENT
, "SUCCESS: % commªd sucûeded", 
cmd
);

3579 ià(*
¡©e
 =ğ
EKS_INPUT
 || *¡©=ğ
EKS_READY
)

3581 
	`msg
(
M_CLIENT
, "ERROR: % commªd faed", 
cmd
);

3585 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
¡ªd®Úe_di§bËd_§ve
;

3586 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3587 
	`š_exŒa_»£t
(
mc
, 
IER_RESET
);

3588 *
¡©e
 = 
EKS_UNDEF
;

3590 
	`gc_ä“
(&
gc
);

3591  
»t
;

3592 
	}
}

3596 
	$mªagem’t_qu”y_muÉše_æ©‹n_Ãwlše
(
mªagem’t
 *
mª
,

3597 cÚ¡ *
b64_d©a
, cÚ¡ *
´om±
, cÚ¡ *
cmd
, *
¡©e
, 
bufãr_li¡
 **
šput
)

3599 
ok
;

3600 *
»suÉ
 = 
NULL
;

3601 
bufãr
 *
buf
;

3603 
ok
 = 
	`mªagem’t_qu”y_muÉše
(
mª
, 
b64_d©a
, 
´om±
, 
cmd
, 
¡©e
, 
šput
);

3604 ià(
ok
 && 
	`bufãr_li¡_defšed
(*
šput
))

3606 
	`bufãr_li¡_agg»g©e_£·¿tÜ
(*
šput
, 10000, "\n");

3607 
buf
 = 
	`bufãr_li¡_³ek
(*
šput
);

3608 ià(
buf
 && 
	`BLEN
(buf) > 0)

3610 
»suÉ
 = (*è
	`m®loc
(
	`BLEN
(
buf
)+1);

3611 
	`check_m®loc_»tuº
(
»suÉ
);

3612 
	`memıy
(
»suÉ
, 
buf
->
d©a
, 
	`BLEN
(buf));

3613 
»suÉ
[
	`BLEN
(
buf
)] = '\0';

3617 
	`bufãr_li¡_ä“
(*
šput
);

3618 *
šput
 = 
NULL
;

3620  
»suÉ
;

3621 
	}
}

3625 
	$mªagem’t_qu”y_muÉše_æ©‹n
(
mªagem’t
 *
mª
,

3626 cÚ¡ *
b64_d©a
, cÚ¡ *
´om±
, cÚ¡ *
cmd
, *
¡©e
, 
bufãr_li¡
 **
šput
)

3628 
ok
;

3629 *
»suÉ
 = 
NULL
;

3630 
bufãr
 *
buf
;

3632 
ok
 = 
	`mªagem’t_qu”y_muÉše
(
mª
, 
b64_d©a
, 
´om±
, 
cmd
, 
¡©e
, 
šput
);

3633 ià(
ok
 && 
	`bufãr_li¡_defšed
(*
šput
))

3635 
	`bufãr_li¡_agg»g©e
(*
šput
, 2048);

3636 
buf
 = 
	`bufãr_li¡_³ek
(*
šput
);

3637 ià(
buf
 && 
	`BLEN
(buf) > 0)

3639 
»suÉ
 = (*è
	`m®loc
(
	`BLEN
(
buf
)+1);

3640 
	`check_m®loc_»tuº
(
»suÉ
);

3641 
	`memıy
(
»suÉ
, 
buf
->
d©a
, 
	`BLEN
(buf));

3642 
»suÉ
[
	`BLEN
(
buf
)] = '\0';

3646 
	`bufãr_li¡_ä“
(*
šput
);

3647 *
šput
 = 
NULL
;

3649  
»suÉ
;

3650 
	}
}

3654 
	$mªagem’t_qu”y_r§_sig
(
mªagem’t
 *
mª
,

3655 cÚ¡ *
b64_d©a
)

3657  
	`mªagem’t_qu”y_muÉše_æ©‹n
(
mª
, 
b64_d©a
, "RSA_SIGN", "rsa-sign",

3658 &
mª
->
cÚÃùiÚ
.
ext_key_¡©e
, &mª->cÚÃùiÚ.
ext_key_šput
);

3659 
	}
}

3663 
	$mªagem’t_qu”y_û¹
(
mªagem’t
 *
mª
, cÚ¡ *
û¹_Çme
)

3665 cÚ¡ 
´om±_1
[] = "NEED-CERTIFICATE:";

3666 
bufãr
 
buf_´om±
 = 
	`®loc_buf
(
	`¡¾’
(
û¹_Çme
) + 20);

3667 
	`buf_wr™e
(&
buf_´om±
, 
´om±_1
, 
	`¡¾’
(prompt_1));

3668 
	`buf_wr™e
(&
buf_´om±
, 
û¹_Çme
, 
	`¡¾’
(cert_name)+1);

3670 *
»suÉ
;

3671 
»suÉ
 = 
	`mªagem’t_qu”y_muÉše_æ©‹n_Ãwlše
(
mªagem’t
,

3672 
NULL
, (*)
	`buf_b±r
(&
buf_´om±
), "certificate",

3673 &
mª
->
cÚÃùiÚ
.
ext_û¹_¡©e
, &mª->cÚÃùiÚ.
ext_û¹_šput
);

3674 
	`ä“_buf
(&
buf_´om±
);

3675  
»suÉ
;

3676 
	}
}

3683 
boŞ


3684 
	$mªagem’t_would_hŞd
(
mªagem’t
 *
mª
)

3686  (
mª
->
£‰šgs
.
æags
 & 
MF_HOLD
è&& !mª->
³rsi¡
.
hŞd_»Ëa£
 && 
	`mª_¡ªd®Úe_ok
(man);

3687 
	}
}

3693 
boŞ


3694 
	$mªagem’t_should_d«mÚize
(
mªagem’t
 *
mª
)

3696  
	`mªagem’t_would_hŞd
(
mª
è|| (mª->
£‰šgs
.
æags
 & 
MF_QUERY_PASSWORDS
);

3697 
	}
}

3703 
boŞ


3704 
	$mªagem’t_hŞd
(
mªagem’t
 *
mª
, 
hŞdtime
)

3706 ià(
	`mªagem’t_would_hŞd
(
mª
))

3708 vŞ©
sigÇl_»ûived
 = 0;

3709 cÚ¡ 
boŞ
 
¡ªd®Úe_di§bËd_§ve
 = 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
;

3710 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3712 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
çl£
;

3713 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3714 
mª
->
£‰šgs
.
mªsig
 |ğ
MANSIG_IGNORE_USR1_HUP
;

3716 
	`mª_wa™_fÜ_ş›Á_cÚÃùiÚ
(
mª
, &
sigÇl_»ûived
, 0, 
MWCC_HOLD_WAIT
);

3718 ià(!
sigÇl_»ûived
)

3720 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, &
gc
);

3721 
	`buf_´štf
(&
out
, ">HOLD:Wa™šg fÜ hŞd„–—£:%d", 
hŞdtime
);

3722 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
	`BSTR
(&
out
);

3723 
	`msg
(
M_CLIENT
, "%s", 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
);

3728 
	`mª_¡ªd®Úe_ev’t_loİ
(
mª
, &
sigÇl_»ûived
, 0);

3729 ià(!
sigÇl_»ûived
)

3731 
	`mª_check_fÜ_sigÇls
(&
sigÇl_»ûived
);

3733 ià(
sigÇl_»ûived
)

3737 } !
mª
->
³rsi¡
.
hŞd_»Ëa£
);

3741 
mª
->
³rsi¡
.
¡ªd®Úe_di§bËd
 = 
¡ªd®Úe_di§bËd_§ve
;

3742 
mª
->
³rsi¡
.
¥ecŸl_¡©e_msg
 = 
NULL
;

3743 
mª
->
£‰šgs
.
mªsig
 &ğ~
MANSIG_IGNORE_USR1_HUP
;

3745 
	`gc_ä“
(&
gc
);

3746  
Œue
;

3748  
çl£
;

3749 
	}
}

3755 
commªd_lše
 *

3756 
	$commªd_lše_Ãw
(cÚ¡ 
buf_Ën
)

3758 
commªd_lše
 *
ş
;

3759 
	`ALLOC_OBJ_CLEAR
(
ş
, 
commªd_lše
);

3760 
ş
->
buf
 = 
	`®loc_buf
(
buf_Ën
);

3761 
ş
->
»sidu®
 = 
	`®loc_buf
(
buf_Ën
);

3762  
ş
;

3763 
	}
}

3766 
	$commªd_lše_»£t
(
commªd_lše
 *
ş
)

3768 
	`buf_ş—r
(&
ş
->
buf
);

3769 
	`buf_ş—r
(&
ş
->
»sidu®
);

3770 
	}
}

3773 
	$commªd_lše_ä“
(
commªd_lše
 *
ş
)

3775 
	`commªd_lše_»£t
(
ş
);

3776 
	`ä“_buf
(&
ş
->
buf
);

3777 
	`ä“_buf
(&
ş
->
»sidu®
);

3778 
	`ä“
(
ş
);

3779 
	}
}

3782 
	$commªd_lše_add
(
commªd_lše
 *
ş
, cÚ¡ *
buf
, cÚ¡ 
Ën
)

3784 
i
;

3785 
i
 = 0; i < 
Ën
; ++i)

3787 ià(
buf
[
i
] && 
	`ch¬_şass
(buf[i], (
CC_PRINT
|
CC_NEWLINE
)))

3789 ià(!
	`buf_wr™e_u8
(&
ş
->
buf
, buf[
i
]))

3791 
	`buf_ş—r
(&
ş
->
buf
);

3795 
	}
}

3798 
	$commªd_lše_g‘
(
commªd_lše
 *
ş
)

3800 
i
;

3801 cÚ¡ *
»t
 = 
NULL
;

3803 
i
 = 
	`buf_sub¡ršg_Ën
(&
ş
->
buf
, '\n');

3804 ià(
i
 >= 0)

3806 
	`buf_cİy_exûss
(&
ş
->
»sidu®
, &ş->
buf
, 
i
);

3807 
	`buf_chomp
(&
ş
->
buf
);

3808 
»t
 = 
	`BSTR
(&
ş
->
buf
);

3810  
»t
;

3811 
	}
}

3814 
	$commªd_lše_Ãxt
(
commªd_lše
 *
ş
)

3816 
	`buf_ş—r
(&
ş
->
buf
);

3817 
	`buf_cİy
(&
ş
->
buf
, &ş->
»sidu®
);

3818 
	`buf_ş—r
(&
ş
->
»sidu®
);

3819 
	}
}

3826 
	$log_’Œy_´št
(cÚ¡ 
log_’Œy
 *
e
, 
æags
, 
gc_¬’a
 *
gc
)

3828 
bufãr
 
out
 = 
	`®loc_buf_gc
(
ERR_BUF_SIZE
, 
gc
);

3829 ià(
æags
 & 
LOG_FATAL_NOTIFY
)

3831 
	`buf_´štf
(&
out
, ">FATAL:");

3833 ià(
æags
 & 
LOG_PRINT_LOG_PREFIX
)

3835 
	`buf_´štf
(&
out
, ">LOG:");

3837 ià(
æags
 & 
LOG_PRINT_ECHO_PREFIX
)

3839 
	`buf_´štf
(&
out
, ">ECHO:");

3841 ià(
æags
 & 
LOG_PRINT_STATE_PREFIX
)

3843 
	`buf_´štf
(&
out
, ">STATE:");

3845 ià(
æags
 & 
LOG_PRINT_INT_DATE
)

3847 
	`buf_´štf
(&
out
, "%u,", ()
e
->
time¡amp
);

3849 ià(
æags
 & 
LOG_PRINT_MSG_FLAGS
)

3851 
	`buf_´štf
(&
out
, "%s,", 
	`msg_æags_¡ršg
(
e
->
u
.
msg_æags
, 
gc
));

3853 ià(
æags
 & 
LOG_PRINT_STATE
)

3855 
	`buf_´štf
(&
out
, "%s,", 
	`mª_¡©e_Çme
(
e
->
u
.
¡©e
));

3857 ià(
æags
 & 
LOG_PRINT_INTVAL
)

3859 
	`buf_´štf
(&
out
, "%d,", 
e
->
u
.
štv®
);

3861 ià(
e
->
¡ršg
)

3863 
	`buf_´štf
(&
out
, "%s", 
e
->
¡ršg
);

3865 ià(
æags
 & 
LOG_PRINT_LOCAL_IP
)

3867 
	`buf_´štf
(&
out
, ",%s", 
	`´št_š_addr_t
(
e
->
loÿl_
, 
IA_EMPTY_IF_UNDEF
, 
gc
));

3869 ià(
æags
 & 
LOG_PRINT_REMOTE_IP
)

3871 
	`buf_´štf
(&
out
, ",%s", (!
	`addr_defšed
(&
e
->
»mÙe_sock
) ? "," :

3872 
	`´št_sockaddr_ex
(&
e
->
»mÙe_sock
.
addr
.
§
, ",", 
PS_DONT_SHOW_FAMILY
|
PS_SHOW_PORT
, 
gc
)));

3873 
	`buf_´štf
(&
out
, ",%s", (!
	`addr_defšed
(&
e
->
loÿl_sock
) ? "," :

3874 
	`´št_sockaddr_ex
(&
e
->
loÿl_sock
.
addr
.
§
, ",", 
PS_DONT_SHOW_FAMILY
|
PS_SHOW_PORT
, 
gc
)));

3876 ià(
æags
 & 
LOG_PRINT_LOCAL_IP
 && !
	`IN6_IS_ADDR_UNSPECIFIED
(&
e
->
loÿl_6
))

3878 
	`buf_´štf
(&
out
, ",%s", 
	`´št_š6_addr
(
e
->
loÿl_6
, 
IA_EMPTY_IF_UNDEF
, 
gc
));

3880 ià(
æags
 & 
LOG_ECHO_TO_LOG
)

3882 
	`msg
(
D_MANAGEMENT
, "MANAGEMENT: %s", 
	`BSTR
(&
out
));

3884 ià(
æags
 & 
LOG_PRINT_CRLF
)

3886 
	`buf_´štf
(&
out
, "\r\n");

3888  
	`BSTR
(&
out
);

3889 
	}
}

3892 
	$log_’Œy_ä“_cÚ‹Ás
(
log_’Œy
 *
e
)

3894 ià(
e
->
¡ršg
)

3896 
	`ä“
((*)
e
->
¡ršg
);

3898 
	`CLEAR
(*
e
);

3899 
	}
}

3905 
šlše
 

3906 
	$log_šdex
(cÚ¡ 
log_hi¡Üy
 *
h
, 
i
)

3908  
	`modulo_add
(
h
->
ba£
, 
i
, h->
ÿ·c™y
);

3909 
	}
}

3912 
	$log_hi¡Üy_obj_š™
(
log_hi¡Üy
 *
h
, 
ÿ·c™y
)

3914 
	`CLEAR
(*
h
);

3915 
h
->
ÿ·c™y
 = capacity;

3916 
	`ALLOC_ARRAY_CLEAR
(
h
->
¬¿y
, 
log_’Œy
, 
ÿ·c™y
);

3917 
	}
}

3919 
log_hi¡Üy
 *

3920 
	$log_hi¡Üy_š™
(cÚ¡ 
ÿ·c™y
)

3922 
log_hi¡Üy
 *
h
;

3923 
	`ASSERT
(
ÿ·c™y
 > 0);

3924 
	`ALLOC_OBJ
(
h
, 
log_hi¡Üy
);

3925 
	`log_hi¡Üy_obj_š™
(
h
, 
ÿ·c™y
);

3926  
h
;

3927 
	}
}

3930 
	$log_hi¡Üy_ä“_cÚ‹Ás
(
log_hi¡Üy
 *
h
)

3932 
i
;

3933 
i
 = 0; i < 
h
->
size
; ++i)

3935 
	`log_’Œy_ä“_cÚ‹Ás
(&
h
->
¬¿y
[
	`log_šdex
(h, 
i
)]);

3937 
	`ä“
(
h
->
¬¿y
);

3938 
	}
}

3941 
	$log_hi¡Üy_şo£
(
log_hi¡Üy
 *
h
)

3943 
	`log_hi¡Üy_ä“_cÚ‹Ás
(
h
);

3944 
	`ä“
(
h
);

3945 
	}
}

3948 
	$log_hi¡Üy_add
(
log_hi¡Üy
 *
h
, cÚ¡ 
log_’Œy
 *
Ë
)

3950 
log_’Œy
 *
e
;

3951 
	`ASSERT
(
h
->
size
 >ğ0 && h->siz<ğh->
ÿ·c™y
);

3952 ià(
h
->
size
 =ğh->
ÿ·c™y
)

3954 
e
 = &
h
->
¬¿y
[h->
ba£
];

3955 
	`log_’Œy_ä“_cÚ‹Ás
(
e
);

3956 
h
->
ba£
 = 
	`log_šdex
(h, 1);

3960 
e
 = &
h
->
¬¿y
[
	`log_šdex
(h, h->
size
)];

3961 ++
h
->
size
;

3964 *
e
 = *
Ë
;

3965 
e
->
¡ršg
 = 
	`¡ršg_®loc
(
Ë
->¡ršg, 
NULL
);

3966 
	}
}

3969 
	$log_hi¡Üy_»size
(
log_hi¡Üy
 *
h
, cÚ¡ 
ÿ·c™y
)

3971 ià(
ÿ·c™y
 !ğ
h
->capacity)

3973 
log_hi¡Üy
 
Ãwlog
;

3974 
i
;

3976 
	`ASSERT
(
ÿ·c™y
 > 0);

3977 
	`log_hi¡Üy_obj_š™
(&
Ãwlog
, 
ÿ·c™y
);

3979 
i
 = 0; i < 
h
->
size
; ++i)

3981 
	`log_hi¡Üy_add
(&
Ãwlog
, &
h
->
¬¿y
[
	`log_šdex
(h, 
i
)]);

3984 
	`log_hi¡Üy_ä“_cÚ‹Ás
(
h
);

3985 *
h
 = 
Ãwlog
;

3987 
	}
}

3989 cÚ¡ 
log_’Œy
 *

3990 
	$log_hi¡Üy_»f
(cÚ¡ 
log_hi¡Üy
 *
h
, cÚ¡ 
šdex
)

3992 ià(
šdex
 >ğ0 && index < 
h
->
size
)

3994  &
h
->
¬¿y
[
	`log_šdex
(h, (h->
size
 - 1è- 
šdex
)];

3998  
NULL
;

4000 
	}
}

4003 
	$mªagem’t_¦“p
(cÚ¡ 
n
)

4005 ià(
mªagem’t
)

4007 
	`mªagem’t_ev’t_loİ_n_£cÚds
(
mªagem’t
, 
n
);

4011 
	`¦“p
(
n
);

4013 
	}
}

4018 
	$mªagem’t_¦“p
(cÚ¡ 
n
)

4020 
	`¦“p
(
n
);

4021 
	}
}

	@manage.h

24 #iâdeà
MANAGE_H


25 
	#MANAGE_H


	)

27 #ifdeà
ENABLE_MANAGEMENT


29 
	~"misc.h
"

30 
	~"ev’t.h
"

31 
	~"sock‘.h
"

32 
	~"mrou‹.h
"

34 
	#MANAGEMENT_VERSION
 1

	)

35 
	#MANAGEMENT_N_PASSWORD_RETRIES
 3

	)

36 
	#MANAGEMENT_LOG_HISTORY_INITIAL_SIZE
 100

	)

37 
	#MANAGEMENT_ECHO_BUFFER_SIZE
 100

	)

38 
	#MANAGEMENT_STATE_BUFFER_SIZE
 100

	)

43 #ifdeà
MANAGEMENT_DEF_AUTH


44 
	smª_def_auth_cÚ‹xt
 {

45 
	mcid
;

47 
	#DAF_CONNECTION_ESTABLISHED
 (1<<0)

	)

48 
	#DAF_CONNECTION_CLOSED
 (1<<1)

	)

49 
	#DAF_INITIAL_AUTH
 (1<<2)

	)

50 
	mæags
;

52 
	mmda_key_id_couÁ”
;

54 
time_t
 
	mby‹couÁ_Ï¡_upd©e
;

61 
	scommªd_lše


63 
bufãr
 
	mbuf
;

64 
bufãr
 
	m»sidu®
;

67 
commªd_lše
 *
commªd_lše_Ãw
(cÚ¡ 
buf_Ën
);

69 
commªd_lše_ä“
(
commªd_lše
 *
ş
);

71 
commªd_lše_add
(
commªd_lše
 *
ş
, cÚ¡ *
buf
, cÚ¡ 
Ën
);

73 cÚ¡ *
commªd_lše_g‘
(
commªd_lše
 *
ş
);

75 
commªd_lše_»£t
(
commªd_lše
 *
ş
);

77 
commªd_lše_Ãxt
(
commªd_lše
 *
ş
);

83 
	ulog_’Œy_uniÚ
 {

84 
	mmsg_æags
;

85 
	m¡©e
;

86 
	mštv®
;

89 
	slog_’Œy


91 
time_t
 
	mtime¡amp
;

92 cÚ¡ *
	m¡ršg
;

93 
š_addr_t
 
	mloÿl_
;

94 
š6_addr
 
	mloÿl_6
;

95 
İ’v²_sockaddr
 
	mloÿl_sock
;

96 
İ’v²_sockaddr
 
	m»mÙe_sock
;

97 
log_’Œy_uniÚ
 
	mu
;

100 
	#LOG_PRINT_LOG_PREFIX
 (1<<0)

	)

101 
	#LOG_PRINT_ECHO_PREFIX
 (1<<1)

	)

102 
	#LOG_PRINT_STATE_PREFIX
 (1<<2)

	)

104 
	#LOG_PRINT_INT_DATE
 (1<<3)

	)

105 
	#LOG_PRINT_MSG_FLAGS
 (1<<4)

	)

106 
	#LOG_PRINT_STATE
 (1<<5)

	)

107 
	#LOG_PRINT_LOCAL_IP
 (1<<6)

	)

109 
	#LOG_PRINT_CRLF
 (1<<7)

	)

110 
	#LOG_FATAL_NOTIFY
 (1<<8)

	)

112 
	#LOG_PRINT_INTVAL
 (1<<9)

	)

114 
	#LOG_PRINT_REMOTE_IP
 (1<<10)

	)

116 
	#LOG_ECHO_TO_LOG
 (1<<11)

	)

118 cÚ¡ *
log_’Œy_´št
(cÚ¡ 
log_’Œy
 *
e
, 
æags
, 
gc_¬’a
 *
gc
);

120 
	slog_hi¡Üy


122 
	mba£
;

123 
	msize
;

124 
	mÿ·c™y
;

125 
log_’Œy
 *
	m¬¿y
;

128 
log_hi¡Üy
 *
log_hi¡Üy_š™
(cÚ¡ 
ÿ·c™y
);

130 
log_hi¡Üy_şo£
(
log_hi¡Üy
 *
h
);

132 
log_hi¡Üy_add
(
log_hi¡Üy
 *
h
, cÚ¡ 
log_’Œy
 *
Ë
);

134 
log_hi¡Üy_»size
(
log_hi¡Üy
 *
h
, cÚ¡ 
ÿ·c™y
);

136 cÚ¡ 
log_’Œy
 *
log_hi¡Üy_»f
(cÚ¡ 
log_hi¡Üy
 *
h
, cÚ¡ 
šdex
);

138 
šlše
 

139 
	$log_hi¡Üy_size
(cÚ¡ 
log_hi¡Üy
 *
h
)

141  
h
->
size
;

142 
	}
}

144 
šlše
 

145 
	$log_hi¡Üy_ÿ·c™y
(cÚ¡ 
log_hi¡Üy
 *
h
)

147  
h
->
ÿ·c™y
;

148 
	}
}

154 
	smªagem’t_ÿÎback


156 *
	m¬g
;

158 
	#MCF_SERVER
 (1<<0è

	)

159 
	mæags
;

161 (*
	m¡©us
è(*
	m¬g
, cÚ¡ 
	mv”siÚ
, 
¡©us_ouut
 *
	mso
);

162 (*
	mshow_Ãt
è(*
	m¬g
, cÚ¡ 
	mmsgËv–
);

163 (*
	mkl_by_ú
è(*
	m¬g
, cÚ¡ *
	mcommÚ_Çme
);

164 (*
	mkl_by_addr
è(*
	m¬g
, cÚ¡ 
š_addr_t
 
	maddr
, cÚ¡ 
	mpÜt
);

165 (*
	md–‘e_ev’t
è(*
	m¬g
, 
ev’t_t
 
	mev’t
);

166 (*
	mn_ş›Ás
è(*
	m¬g
);

167 #ifdeà
MANAGEMENT_DEF_AUTH


168 
boŞ
 (*
kl_by_cid
)(*
	m¬g
, cÚ¡ 
	mcid
, cÚ¡ *
	mkl_msg
);

169 
boŞ
 (*
ş›Á_auth
è(*
	m¬g
,

170 cÚ¡ 
	mcid
,

171 cÚ¡ 
	mmda_key_id
,

172 cÚ¡ 
boŞ
 
	mauth
,

173 cÚ¡ *
	m»asÚ
,

174 cÚ¡ *
	mş›Á_»asÚ
,

175 
bufãr_li¡
 *
	mcc_cÚfig
);

176 *(*
	mg‘_³”_šfo
è(*
	m¬g
, cÚ¡ 
	mcid
);

178 #ifdeà
MANAGEMENT_PF


179 
boŞ
 (*
ş›Á_pf
)(*
	m¬g
,

180 cÚ¡ 
	mcid
,

181 
bufãr_li¡
 *
	mpf_cÚfig
);

183 
boŞ
 (*
´oxy_cmd
)(*
	m¬g
, cÚ¡ **
	mp
);

184 
boŞ
 (*
»mÙe_cmd
è(*
	m¬g
, cÚ¡ **
	mp
);

185 #ifdeà
TARGET_ANDROID


186 (*
	mÃtwÜk_chªge
)(*
	m¬g
, 
boŞ
 
	m§m’‘wÜk
);

204 
	smª_³rsi¡
 {

205 
boŞ
 
	mdefšed
;

207 
log_hi¡Üy
 *
	mlog
;

208 
vœtu®_ouut
 
	mvout
;

210 
boŞ
 
	m¡ªd®Úe_di§bËd
;

211 
mªagem’t_ÿÎback
 
	mÿÎback
;

213 
log_hi¡Üy
 *
	mecho
;

214 
log_hi¡Üy
 *
	m¡©e
;

216 
boŞ
 
	mhŞd_»Ëa£
;

218 cÚ¡ *
	m¥ecŸl_¡©e_msg
;

220 
couÁ”_ty³
 
	mby‹s_š
;

221 
couÁ”_ty³
 
	mby‹s_out
;

224 
	smª_£‰šgs
 {

225 
boŞ
 
	mdefšed
;

226 
	mæags
;

227 
addršfo
 *
	mloÿl
;

228 #ià
UNIX_SOCK_SUPPORT


229 
sockaddr_un
 
	mloÿl_unix
;

231 
boŞ
 
	mmªagem’t_ov”_tuÂ–
;

232 
u£r_·ss
 
	mup
;

233 
	mlog_hi¡Üy_ÿche
;

234 
	mecho_bufãr_size
;

235 
	m¡©e_bufãr_size
;

236 *
	mwr™e_³”_šfo_fe
;

237 
	mş›Á_uid
;

238 
	mş›Á_gid
;

241 
	#MANSIG_IGNORE_USR1_HUP
 (1<<0)

	)

242 
	#MANSIG_MAP_USR1_TO_HUP
 (1<<1)

	)

243 
	#MANSIG_MAP_USR1_TO_TERM
 (1<<2)

	)

244 
	mmªsig
;

248 
	#UP_QUERY_DISABLED
 0

	)

249 
	#UP_QUERY_USER_PASS
 1

	)

250 
	#UP_QUERY_PASS
 2

	)

251 
	#UP_QUERY_NEED_OK
 3

	)

252 
	#UP_QUERY_NEED_STR
 4

	)

255 
	#MS_INITIAL
 0

	)

256 
	#MS_LISTEN
 1

	)

257 
	#MS_CC_WAIT_READ
 2

	)

258 
	#MS_CC_WAIT_WRITE
 3

	)

260 
	smª_cÚÃùiÚ
 {

261 
	m¡©e
;

263 
sock‘_desütÜ_t
 
	msd_tİ
;

264 
sock‘_desütÜ_t
 
	msd_şi
;

265 
İ’v²_sockaddr
 
	m»mÙe
;

267 #ifdeà
_WIN32


268 
Ãt_ev’t_wš32
 
	mÃ32
;

271 
boŞ
 
	mh®t
;

272 
boŞ
 
	m·sswÜd_v”if›d
;

273 
	m·sswÜd_Œ›s
;

275 
commªd_lše
 *
	mš
;

276 
bufãr_li¡
 *
	mout
;

278 #ifdeà
MANAGEMENT_IN_EXTRA


279 
	#IEC_UNDEF
 0

	)

280 
	#IEC_CLIENT_AUTH
 1

	)

281 
	#IEC_CLIENT_PF
 2

	)

282 
	#IEC_RSA_SIGN
 3

	)

283 
	#IEC_CERTIFICATE
 4

	)

284 
	mš_exŒa_cmd
;

285 
bufãr_li¡
 *
	mš_exŒa
;

286 #ifdeà
MANAGEMENT_DEF_AUTH


287 
	mš_exŒa_cid
;

288 
	mš_exŒa_kid
;

290 #ifdeà
MANAGMENT_EXTERNAL_KEY


291 
	#EKS_UNDEF
 0

	)

292 
	#EKS_SOLICIT
 1

	)

293 
	#EKS_INPUT
 2

	)

294 
	#EKS_READY
 3

	)

295 
	mext_key_¡©e
;

296 
bufãr_li¡
 *
	mext_key_šput
;

297 
	mext_û¹_¡©e
;

298 
bufãr_li¡
 *
	mext_û¹_šput
;

301 
ev’t_£t
 *
	mes
;

302 
	m’v_f‹r_Ëv–
;

304 
boŞ
 
	m¡©e_»®time
;

305 
boŞ
 
	mlog_»®time
;

306 
boŞ
 
	mecho_»®time
;

307 
	mby‹couÁ_upd©e_£cÚds
;

308 
time_t
 
	mby‹couÁ_Ï¡_upd©e
;

310 cÚ¡ *
	mup_qu”y_ty³
;

311 
	mup_qu”y_mode
;

312 
u£r_·ss
 
	mup_qu”y
;

314 #ifdeà
MANAGMENT_EXTERNAL_KEY


315 
bufãr_li¡
 *
	mr§_sig
;

317 #ifdeà
TARGET_ANDROID


318 
	mfdto£nd
;

319 
	mÏ¡fd»ûived
;

323 
	smªagem’t


325 
mª_³rsi¡
 
	m³rsi¡
;

326 
mª_£‰šgs
 
	m£‰šgs
;

327 
mª_cÚÃùiÚ
 
	mcÚÃùiÚ
;

330 
mªagem’t
 *management;

332 
	gu£r_·ss
;

334 
mªagem’t
 *
mªagem’t_š™
();

337 
	#MF_SERVER
 (1<<0)

	)

338 
	#MF_QUERY_PASSWORDS
 (1<<1)

	)

339 
	#MF_HOLD
 (1<<2)

	)

340 
	#MF_SIGNAL
 (1<<3)

	)

341 
	#MF_FORGET_DISCONNECT
 (1<<4)

	)

342 
	#MF_CONNECT_AS_CLIENT
 (1<<5)

	)

343 #ifdeà
MANAGEMENT_DEF_AUTH


344 
	#MF_CLIENT_AUTH
 (1<<6)

	)

346 #ifdeà
MANAGEMENT_PF


347 
	#MF_CLIENT_PF
 (1<<7)

	)

349 
	#MF_UNIX_SOCK
 (1<<8)

	)

350 #ifdeà
MANAGMENT_EXTERNAL_KEY


351 
	#MF_EXTERNAL_KEY
 (1<<9)

	)

353 
	#MF_UP_DOWN
 (1<<10)

	)

354 
	#MF_QUERY_REMOTE
 (1<<11)

	)

355 
	#MF_QUERY_PROXY
 (1<<12)

	)

356 
	#MF_EXTERNAL_CERT
 (1<<13)

	)

358 
boŞ
 
mªagem’t_İ’
(
mªagem’t
 *
mª
,

359 cÚ¡ *
addr
,

360 cÚ¡ *
pÜt
,

361 cÚ¡ *
·ss_fe
,

362 cÚ¡ *
ş›Á_u£r
,

363 cÚ¡ *
ş›Á_group
,

364 cÚ¡ 
log_hi¡Üy_ÿche
,

365 cÚ¡ 
echo_bufãr_size
,

366 cÚ¡ 
¡©e_bufãr_size
,

367 cÚ¡ *
wr™e_³”_šfo_fe
,

368 cÚ¡ 
»m­_sigu¤1
,

369 cÚ¡ 
æags
);

371 
mªagem’t_şo£
(
mªagem’t
 *
mª
);

373 
mªagem’t_po¡_tuÂ–_İ’
(
mªagem’t
 *
mª
, cÚ¡ 
š_addr_t
 
tun_loÿl_
);

375 
mªagem’t_´e_tuÂ–_şo£
(
mªagem’t
 *
mª
);

377 
mªagem’t_sock‘_£t
(
mªagem’t
 *
mª
,

378 
ev’t_£t
 *
es
,

379 *
¬g
,

380 *
³rsi¡’t
);

382 
mªagem’t_io
(
mªagem’t
 *
mª
);

384 
mªagem’t_£t_ÿÎback
(
mªagem’t
 *
mª
,

385 cÚ¡ 
mªagem’t_ÿÎback
 *
cb
);

387 
mªagem’t_ş—r_ÿÎback
(
mªagem’t
 *
mª
);

389 
boŞ
 
mªagem’t_qu”y_u£r_·ss
(
mªagem’t
 *
mª
,

390 
u£r_·ss
 *
up
,

391 cÚ¡ *
ty³
,

392 cÚ¡ 
æags
,

393 cÚ¡ *
¡©ic_ch®Ënge
);

395 #ifdeà
TARGET_ANDROID


396 
boŞ
 
mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
 *
mª
, cÚ¡ *
commªd
, cÚ¡ *
msg
);

398 
	#ANDROID_KEEP_OLD_TUN
 1

	)

399 
	#ANDROID_OPEN_AFTER_CLOSE
 2

	)

400 
	#ANDROID_OPEN_BEFORE_CLOSE
 3

	)

401 
mªagm’t_ªdroid_³rsi¡tun_aùiÚ
(
mªagem’t
 *
mª
);

405 
boŞ
 
mªagem’t_should_d«mÚize
(
mªagem’t
 *
mª
);

407 
boŞ
 
mªagem’t_would_hŞd
(
mªagem’t
 *
mª
);

409 
boŞ
 
mªagem’t_hŞd
(
mªagem’t
 *
mª
, 
hŞdtime
);

411 
mªagem’t_ev’t_loİ_n_£cÚds
(
mªagem’t
 *
mª
, 
£c
);

413 
mªagem’t_up_down
(
mªagem’t
 *
mª
, cÚ¡ *
updown
, cÚ¡ 
’v_£t
 *
es
);

415 
mªagem’t_nÙify
(
mªagem’t
 *
mª
, cÚ¡ *
£v”™y
, cÚ¡ *
ty³
, cÚ¡ *
‹xt
);

417 
mªagem’t_nÙify_g’”ic
(
mªagem’t
 *
mª
, cÚ¡ *
¡r
);

419 #ifdeà
MANAGEMENT_DEF_AUTH


420 
mªagem’t_nÙify_ş›Á_Ãedšg_auth
(
mªagem’t
 *management,

421 cÚ¡ 
auth_id
,

422 
mª_def_auth_cÚ‹xt
 *
mdac
,

423 cÚ¡ 
’v_£t
 *
es
);

425 
mªagem’t_cÚÃùiÚ_e¡ablished
(
mªagem’t
 *management,

426 
mª_def_auth_cÚ‹xt
 *
mdac
,

427 cÚ¡ 
’v_£t
 *
es
);

429 
mªagem’t_nÙify_ş›Á_şo£
(
mªagem’t
 *management,

430 
mª_def_auth_cÚ‹xt
 *
mdac
,

431 cÚ¡ 
’v_£t
 *
es
);

433 
mªagem’t_Ë¬n_addr
(
mªagem’t
 *management,

434 
mª_def_auth_cÚ‹xt
 *
mdac
,

435 cÚ¡ 
mrou‹_addr
 *
addr
,

436 cÚ¡ 
boŞ
 
´im¬y
);

440 #ifdeà
MANAGMENT_EXTERNAL_KEY


442 *
mªagem’t_qu”y_r§_sig
(
mªagem’t
 *
mª
, cÚ¡ *
b64_d©a
);

444 *
mªagem’t_qu”y_û¹
(
mªagem’t
 *
mª
, cÚ¡ *
û¹_Çme
);

448 
šlše
 
boŞ


449 
	$mªagem’t_cÚÃùed
(cÚ¡ 
mªagem’t
 *
mª
)

451  
mª
->
cÚÃùiÚ
.
¡©e
 =ğ
MS_CC_WAIT_READ
 || mª->cÚÃùiÚ.¡©=ğ
MS_CC_WAIT_WRITE
;

452 
	}
}

454 
šlše
 
boŞ


455 
	$mªagem’t_qu”y_u£r_·ss_’abËd
(cÚ¡ 
mªagem’t
 *
mª
)

457  
	`BOOL_CAST
(
mª
->
£‰šgs
.
æags
 & 
MF_QUERY_PASSWORDS
);

458 
	}
}

460 
šlše
 
boŞ


461 
	$mªagem’t_qu”y_»mÙe_’abËd
(cÚ¡ 
mªagem’t
 *
mª
)

463  
	`BOOL_CAST
(
mª
->
£‰šgs
.
æags
 & 
MF_QUERY_REMOTE
);

464 
	}
}

466 
šlše
 
boŞ


467 
	$mªagem’t_qu”y_´oxy_’abËd
(cÚ¡ 
mªagem’t
 *
mª
)

469  
	`BOOL_CAST
(
mª
->
£‰šgs
.
æags
 & 
MF_QUERY_PROXY
);

470 
	}
}

472 #ifdeà
MANAGEMENT_PF


473 
šlše
 
boŞ


474 
	$mªagem’t_’abË_pf
(cÚ¡ 
mªagem’t
 *
mª
)

476  
mª
 && 
	`BOOL_CAST
(mª->
£‰šgs
.
æags
 & 
MF_CLIENT_PF
);

477 
	}
}

480 #ifdeà
MANAGEMENT_DEF_AUTH


481 
šlše
 
boŞ


482 
	$mªagem’t_’abË_def_auth
(cÚ¡ 
mªagem’t
 *
mª
)

484  
mª
 && 
	`BOOL_CAST
(mª->
£‰šgs
.
æags
 & 
MF_CLIENT_AUTH
);

485 
	}
}

493 
	#OPENVPN_STATE_INITIAL
 0

	)

494 
	#OPENVPN_STATE_CONNECTING
 1

	)

495 
	#OPENVPN_STATE_ASSIGN_IP
 2

	)

496 
	#OPENVPN_STATE_ADD_ROUTES
 3

	)

497 
	#OPENVPN_STATE_CONNECTED
 4

	)

498 
	#OPENVPN_STATE_RECONNECTING
 5

	)

499 
	#OPENVPN_STATE_EXITING
 6

	)

502 
	#OPENVPN_STATE_WAIT
 7

	)

503 
	#OPENVPN_STATE_AUTH
 8

	)

504 
	#OPENVPN_STATE_GET_CONFIG
 9

	)

505 
	#OPENVPN_STATE_RESOLVE
 10

	)

506 
	#OPENVPN_STATE_TCP_CONNECT
 11

	)

508 
	#OPENVPN_STATE_CLIENT_BASE
 7

	)

510 
mªagem’t_£t_¡©e
(
mªagem’t
 *
mª
,

511 cÚ¡ 
¡©e
,

512 cÚ¡ *
d‘a
,

513 cÚ¡ 
š_addr_t
 *
tun_loÿl_
,

514 cÚ¡ 
š6_addr
 *
tun_loÿl_6
,

515 cÚ¡ 
İ’v²_sockaddr
 *
loÿl_addr
,

516 cÚ¡ 
İ’v²_sockaddr
 *
»mÙe_addr
);

522 
mªagem’t_echo
(
mªagem’t
 *
mª
, cÚ¡ *
¡ršg
, cÚ¡ 
boŞ
 
puÎ
);

528 
mªagem’t_auth_çu»
(
mªagem’t
 *
mª
, cÚ¡ *
ty³
, cÚ¡ *
»asÚ
);

533 
mªagem’t_auth_tok’
(
mªagem’t
 *
mª
, cÚ¡ *
tok’
);

539 
mª_by‹couÁ_ouut_ş›Á
(
mªagem’t
 *
mª
);

541 
šlše
 

542 
	$mª_by‹couÁ_possibË_ouut_ş›Á
(
mªagem’t
 *
mª
)

544 ià(
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
 > 0

545 && 
now
 >ğ
mª
->
cÚÃùiÚ
.
by‹couÁ_Ï¡_upd©e


546 + 
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
)

548 
	`mª_by‹couÁ_ouut_ş›Á
(
mª
);

550 
	}
}

552 
šlše
 

553 
	$mªagem’t_by‹s_out_ş›Á
(
mªagem’t
 *
mª
, cÚ¡ 
size
)

555 
mª
->
³rsi¡
.
by‹s_out
 +ğ
size
;

556 
	`mª_by‹couÁ_possibË_ouut_ş›Á
(
mª
);

557 
	}
}

559 
šlše
 

560 
	$mªagem’t_by‹s_š_ş›Á
(
mªagem’t
 *
mª
, cÚ¡ 
size
)

562 
mª
->
³rsi¡
.
by‹s_š
 +ğ
size
;

563 
	`mª_by‹couÁ_possibË_ouut_ş›Á
(
mª
);

564 
	}
}

566 
šlše
 

567 
	$mªagem’t_by‹s_out
(
mªagem’t
 *
mª
, cÚ¡ 
size
)

569 ià(!(
mª
->
³rsi¡
.
ÿÎback
.
æags
 & 
MCF_SERVER
))

571 
	`mªagem’t_by‹s_out_ş›Á
(
mª
, 
size
);

573 
	}
}

575 
šlše
 

576 
	$mªagem’t_by‹s_š
(
mªagem’t
 *
mª
, cÚ¡ 
size
)

578 ià(!(
mª
->
³rsi¡
.
ÿÎback
.
æags
 & 
MCF_SERVER
))

580 
	`mªagem’t_by‹s_š_ş›Á
(
mª
, 
size
);

582 
	}
}

584 #ifdeà
MANAGEMENT_DEF_AUTH


586 
šlše
 

587 
	$mªagem’t_by‹s_£rv”
(
mªagem’t
 *
mª
,

588 cÚ¡ 
couÁ”_ty³
 *
by‹s_š_tÙ®
,

589 cÚ¡ 
couÁ”_ty³
 *
by‹s_out_tÙ®
,

590 
mª_def_auth_cÚ‹xt
 *
mdac
)

592 
	`mª_by‹couÁ_ouut_£rv”
(
mªagem’t
 *
mª
,

593 cÚ¡ 
couÁ”_ty³
 *
by‹s_š_tÙ®
,

594 cÚ¡ 
couÁ”_ty³
 *
by‹s_out_tÙ®
,

595 
mª_def_auth_cÚ‹xt
 *
mdac
);

597 ià(
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds
 > 0

598 && 
now
 >ğ
mdac
->
by‹couÁ_Ï¡_upd©e
 + 
mª
->
cÚÃùiÚ
.
by‹couÁ_upd©e_£cÚds


599 && (
mdac
->
æags
 & (
DAF_CONNECTION_ESTABLISHED
|
DAF_CONNECTION_CLOSED
)) == DAF_CONNECTION_ESTABLISHED)

601 
	`mª_by‹couÁ_ouut_£rv”
(
mª
, 
by‹s_š_tÙ®
, 
by‹s_out_tÙ®
, 
mdac
);

603 
	}
}

613 
mªagem’t_¦“p
(cÚ¡ 
n
);

	@mbuf.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP


34 
	~"bufãr.h
"

35 
	~"”rÜ.h
"

36 
	~"š‹g”.h
"

37 
	~"misc.h
"

38 
	~"mbuf.h
"

40 
	~"memdbg.h
"

42 
mbuf_£t
 *

43 
	$mbuf_š™
(
size
)

45 
mbuf_£t
 *
»t
;

46 
	`ALLOC_OBJ_CLEAR
(
»t
, 
mbuf_£t
);

47 
»t
->
ÿ·c™y
 = 
	`adju¡_pow”_of_2
(
size
);

48 
	`ALLOC_ARRAY
(
»t
->
¬¿y
, 
mbuf_™em
,„‘->
ÿ·c™y
);

49  
»t
;

50 
	}
}

53 
	$mbuf_ä“
(
mbuf_£t
 *
ms
)

55 ià(
ms
)

57 
i
;

58 
i
 = 0; i < (è
ms
->
Ën
; ++i)

60 
mbuf_™em
 *
™em
 = &
ms
->
¬¿y
[
	`MBUF_INDEX
(ms->
h—d
, 
i
, ms->
ÿ·c™y
)];

61 
	`mbuf_ä“_buf
(
™em
->
bufãr
);

63 
	`ä“
(
ms
->
¬¿y
);

64 
	`ä“
(
ms
);

66 
	}
}

68 
mbuf_bufãr
 *

69 
	$mbuf_®loc_buf
(cÚ¡ 
bufãr
 *
buf
)

71 
mbuf_bufãr
 *
»t
;

72 
	`ALLOC_OBJ
(
»t
, 
mbuf_bufãr
);

73 
»t
->
buf
 = 
	`şÚe_buf
(buf);

74 
»t
->
»fcouÁ
 = 1;

75 
»t
->
æags
 = 0;

76  
»t
;

77 
	}
}

80 
	$mbuf_ä“_buf
(
mbuf_bufãr
 *
mb
)

82 ià(
mb
)

84 ià(--
mb
->
»fcouÁ
 <= 0)

86 
	`ä“_buf
(&
mb
->
buf
);

87 
	`ä“
(
mb
);

90 
	}
}

93 
	$mbuf_add_™em
(
mbuf_£t
 *
ms
, cÚ¡ 
mbuf_™em
 *
™em
)

95 
	`ASSERT
(
ms
);

96 ià(
ms
->
Ën
 =ğms->
ÿ·c™y
)

98 
mbuf_™em
 
rm
;

99 
	`ASSERT
(
	`mbuf_exŒaù_™em
(
ms
, &
rm
));

100 
	`mbuf_ä“_buf
(
rm
.
bufãr
);

101 
	`msg
(
D_MULTI_DROPPED
, "MBUF: mbuf…acket dropped");

104 
	`ASSERT
(
ms
->
Ën
 < ms->
ÿ·c™y
);

106 
ms
->
¬¿y
[
	`MBUF_INDEX
(ms->
h—d
, ms->
Ën
, ms->
ÿ·c™y
)] = *
™em
;

107 ià(++
ms
->
Ën
 > ms->
max_queued
)

109 
ms
->
max_queued
 = ms->
Ën
;

111 ++
™em
->
bufãr
->
»fcouÁ
;

112 
	}
}

114 
boŞ


115 
	$mbuf_exŒaù_™em
(
mbuf_£t
 *
ms
, 
mbuf_™em
 *
™em
)

117 
boŞ
 
»t
 = 
çl£
;

118 ià(
ms
)

120 
ms
->
Ën
)

122 *
™em
 = 
ms
->
¬¿y
[ms->
h—d
];

123 
ms
->
h—d
 = 
	`MBUF_INDEX
(ms->h—d, 1, ms->
ÿ·c™y
);

124 --
ms
->
Ën
;

125 ià(
™em
->
š¡ªû
)

127 
»t
 = 
Œue
;

132  
»t
;

133 
	}
}

135 
muÉi_š¡ªû
 *

136 
	$mbuf_³ek_dowÜk
(
mbuf_£t
 *
ms
)

138 
muÉi_š¡ªû
 *
»t
 = 
NULL
;

139 ià(
ms
)

141 
i
;

142 
i
 = 0; i < (è
ms
->
Ën
; ++i)

144 
mbuf_™em
 *
™em
 = &
ms
->
¬¿y
[
	`MBUF_INDEX
(ms->
h—d
, 
i
, ms->
ÿ·c™y
)];

145 ià(
™em
->
š¡ªû
)

147 
»t
 = 
™em
->
š¡ªû
;

152  
»t
;

153 
	}
}

156 
	$mbuf_d”eã»nû_š¡ªû
(
mbuf_£t
 *
ms
, 
muÉi_š¡ªû
 *
mi
)

158 ià(
ms
)

160 
i
;

161 
i
 = 0; i < (è
ms
->
Ën
; ++i)

163 
mbuf_™em
 *
™em
 = &
ms
->
¬¿y
[
	`MBUF_INDEX
(ms->
h—d
, 
i
, ms->
ÿ·c™y
)];

164 ià(
™em
->
š¡ªû
 =ğ
mi
)

166 
	`mbuf_ä“_buf
(
™em
->
bufãr
);

167 
™em
->
bufãr
 = 
NULL
;

168 
™em
->
š¡ªû
 = 
NULL
;

169 
	`msg
(
D_MBUF
, "MBUF: dereferenced queued…acket");

173 
	}
}

177 
	$dummy
()

179 
	}
}

	@mbuf.h

24 #iâdeà
MBUF_H


25 
	#MBUF_H


	)

31 #ià
P2MP


36 
	~"basic.h
"

37 
	~"bufãr.h
"

39 
	gmuÉi_š¡ªû
;

41 
	#MBUF_INDEX
(
h—d
, 
off£t
, 
size
è(((h—dè+ (off£t)è& ((size)-1))

	)

43 
	smbuf_bufãr


45 
bufãr
 
	mbuf
;

46 
	m»fcouÁ
;

48 
	#MF_UNICAST
 (1<<0)

	)

49 
	mæags
;

52 
	smbuf_™em


54 
mbuf_bufãr
 *
	mbufãr
;

55 
muÉi_š¡ªû
 *
	mš¡ªû
;

58 
	smbuf_£t


60 
	mh—d
;

61 
	mËn
;

62 
	mÿ·c™y
;

63 
	mmax_queued
;

64 
mbuf_™em
 *
	m¬¿y
;

67 
mbuf_£t
 *
mbuf_š™
(
size
);

69 
mbuf_ä“
(
mbuf_£t
 *
ms
);

71 
mbuf_bufãr
 *
mbuf_®loc_buf
(cÚ¡ 
bufãr
 *
buf
);

73 
mbuf_ä“_buf
(
mbuf_bufãr
 *
mb
);

75 
mbuf_add_™em
(
mbuf_£t
 *
ms
, cÚ¡ 
mbuf_™em
 *
™em
);

77 
boŞ
 
mbuf_exŒaù_™em
(
mbuf_£t
 *
ms
, 
mbuf_™em
 *
™em
);

79 
mbuf_d”eã»nû_š¡ªû
(
mbuf_£t
 *
ms
, 
muÉi_š¡ªû
 *
mi
);

81 
šlše
 
boŞ


82 
	$mbuf_defšed
(cÚ¡ 
mbuf_£t
 *
ms
)

84  
ms
 && ms->
Ën
;

85 
	}
}

87 
šlše
 

88 
	$mbuf_Ën
(cÚ¡ 
mbuf_£t
 *
ms
)

90  
ms
->
Ën
;

91 
	}
}

93 
šlše
 

94 
	$mbuf_maximum_queued
(cÚ¡ 
mbuf_£t
 *
ms
)

96  (è
ms
->
max_queued
;

97 
	}
}

99 
šlše
 
muÉi_š¡ªû
 *

100 
	$mbuf_³ek
(
mbuf_£t
 *
ms
)

102 
muÉi_š¡ªû
 *
	`mbuf_³ek_dowÜk
(
mbuf_£t
 *
ms
);

104 ià(
	`mbuf_defšed
(
ms
))

106  
	`mbuf_³ek_dowÜk
(
ms
);

110  
NULL
;

112 
	}
}

	@memdbg.h

24 #iâdeà
MEMDBG_H


25 
	#MEMDBG_H


	)

45 #ifdeà
USE_VALGRIND


47 
	~"v®gršd/memcheck.h
"

49 
	#VALGRIND_MAKE_READABLE
(
addr
, 
Ën
)

	)

53 
	#VALGRIND_MAKE_READABLE
(
addr
, 
Ën
)

	)

57 #ifdeà
DMALLOC


87 
	~"dm®loc.h
"

89 
	#İ’v²_dm®loc
(
fe
, 
lše
, 
size
è
	`dm®loc_m®loc
((fe), (lše), (size), 
DMALLOC_FUNC_MALLOC
, 0, 0)

	)

101 #undeà
m®loc


102 
	#m®loc
(
size
è
	`İ’v²_dm®loc
("logfe", 
x_msg_lše_num
, (size))

	)

	@misc.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~"cÚfig.h
"

28 #–ià
defšed
(
_MSC_VER
)

29 
	~"cÚfig-msvc.h
"

32 
	~"sysh—d.h
"

34 
	~"bufãr.h
"

35 
	~"misc.h
"

36 
	~"ba£64.h
"

37 
	~"tun.h
"

38 
	~"”rÜ.h
"

39 
	~"Ùime.h
"

40 
	~"¶ugš.h
"

41 
	~"İtiÚs.h
"

42 
	~"mªage.h
"

43 
	~"üy±o.h
"

44 
	~"rou‹.h
"

45 
	~"cÚsŞe.h
"

46 
	~"wš32.h
"

48 
	~"memdbg.h
"

50 #ifdeà
ENABLE_IPROUTE


51 cÚ¡ *
	grou‹_·th
 = 
IPROUTE_PATH
;

55 
	gsüt_£cur™y
 = 
SSEC_BUILT_IN
;

61 
	$£t_¡d_fes_to_nuÎ
(
boŞ
 
¡dš_Úly
)

63 #ià
	`defšed
(
HAVE_DUP
è&& defšed(
HAVE_DUP2
)

64 
fd
;

65 ià((
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1)

67 
	`dup2
(
fd
, 0);

68 ià(!
¡dš_Úly
)

70 
	`dup2
(
fd
, 1);

71 
	`dup2
(
fd
, 2);

73 ià(
fd
 > 2)

75 
	`şo£
(
fd
);

79 
	}
}

85 
	gš‘d_sock‘_desütÜ
 = 
SOCKET_UNDEFINED
;

88 
	$§ve_š‘d_sock‘_desütÜ
()

90 
š‘d_sock‘_desütÜ
 = 
INETD_SOCKET_DESCRIPTOR
;

91 #ià
	`defšed
(
HAVE_DUP
è&& defšed(
HAVE_DUP2
)

93 ià((
š‘d_sock‘_desütÜ
 = 
	`dup
(
INETD_SOCKET_DESCRIPTOR
)) < 0)

95 
	`msg
(
M_ERR
, "INETD_SOCKET_DESCRIPTOR dup(%dèçed", 
INETD_SOCKET_DESCRIPTOR
);

97 
	`£t_¡d_fes_to_nuÎ
(
Œue
);

99 
	}
}

105 
	$sy¡em_”rÜ_mes§ge
(
¡©
, 
gc_¬’a
 *
gc
)

107 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

109 
¡©
)

111 
OPENVPN_EXECVE_NOT_ALLOWED
:

112 
	`buf_´štf
(&
out
, "disallowed by script-security setting");

115 #ifdeà
_WIN32


116 
OPENVPN_EXECVE_ERROR
:

117 
	`buf_´štf
(&
out
, "external…rogram did‚otƒxecute -- ");

121 
	`buf_´štf
(&
out
, "»tuºedƒ¼Ü cod%d", 
¡©
);

125 
OPENVPN_EXECVE_ERROR
:

126 
	`buf_´štf
(&
out
, "external…rogram fork failed");

130 ià(!
	`WIFEXITED
(
¡©
))

132 
	`buf_´štf
(&
out
, "external…rogram did‚otƒxit‚ormally");

136 cÚ¡ 
cmd_»t
 = 
	`WEXITSTATUS
(
¡©
);

137 ià(!
cmd_»t
)

139 
	`buf_´štf
(&
out
, "external…rogramƒxited‚ormally");

141 ià(
cmd_»t
 =ğ
OPENVPN_EXECVE_FAILURE
)

143 
	`buf_´štf
(&
out
, "could‚otƒxecuteƒxternal…rogram");

147 
	`buf_´štf
(&
out
, "ex‹º®…rog¿mƒx™ed w™hƒ¼Ü stus: %d", 
cmd_»t
);

153  (cÚ¡ *)
out
.
d©a
;

154 
	}
}

159 
boŞ


160 
	$İ’v²_execve_check
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
, cÚ¡ *
”rÜ_mes§ge
)

162 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

163 cÚ¡ 
¡©
 = 
	`İ’v²_execve
(
a
, 
es
, 
æags
);

164 
»t
 = 
çl£
;

166 ià(
	`¶©fÜm_sy¡em_ok
(
¡©
))

168 
»t
 = 
Œue
;

172 ià(
”rÜ_mes§ge
)

174 
	`msg
(((
æags
 & 
S_FATAL
è? 
M_FATAL
 : 
M_WARN
), "%s: %s",

175 
”rÜ_mes§ge
,

176 
	`sy¡em_”rÜ_mes§ge
(
¡©
, &
gc
));

179 
	`gc_ä“
(&
gc
);

180  
»t
;

181 
	}
}

183 
boŞ


184 
	$İ’v²_execve_®lowed
(cÚ¡ 
æags
)

186 ià(
æags
 & 
S_SCRIPT
)

188  
süt_£cur™y
 >ğ
SSEC_SCRIPTS
;

192  
süt_£cur™y
 >ğ
SSEC_BUILT_IN
;

194 
	}
}

197 #iâdeà
_WIN32


206 
	$İ’v²_execve
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
)

208 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

209 
»t
 = 
OPENVPN_EXECVE_ERROR
;

210 
boŞ
 
w¬n_shown
 = 
çl£
;

212 ià(
a
 &&‡->
¬gv
[0])

214 #ià
	`defšed
(
ENABLE_FEATURE_EXECVE
)

215 ià(
	`İ’v²_execve_®lowed
(
æags
))

217 cÚ¡ *
cmd
 = 
a
->
¬gv
[0];

218 *cÚ¡ *
¬gv
 = 
a
->argv;

219 *cÚ¡ *
’vp
 = (*cÚ¡ *)
	`make_’v_¬¿y
(
es
, 
Œue
, &
gc
);

220 
pid_t
 
pid
;

222 
pid
 = 
	`fÜk
();

223 ià(
pid
 =ğ(
pid_t
)0)

225 
	`execve
(
cmd
, 
¬gv
, 
’vp
);

226 
	`ex™
(
OPENVPN_EXECVE_FAILURE
);

228 ià(
pid
 < (
pid_t
)0)

230 
	`msg
(
M_ERR
, "openvpn_execve: unableo fork");

234 ià(
	`wa™pid
(
pid
, &
»t
, 0) !=…id)

236 
»t
 = 
OPENVPN_EXECVE_ERROR
;

242 
»t
 = 
OPENVPN_EXECVE_NOT_ALLOWED
;

243 ià(!
w¬n_shown
 && (
süt_£cur™y
 < 
SSEC_SCRIPTS
))

245 
	`msg
(
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

246 
w¬n_shown
 = 
Œue
;

250 
	`msg
(
M_WARN
, "openvpn_execve:ƒxecve function‚ot‡vailable");

255 
	`msg
(
M_FATAL
, "openvpn_execve: called withƒmpty‡rgv");

258 
	`gc_ä“
(&
gc
);

259  
»t
;

260 
	}
}

269 
	$İ’v²_pİ’
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
)

271 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

272 
»t
 = -1;

273 
boŞ
 
w¬n_shown
 = 
çl£
;

275 ià(
a
 &&‡->
¬gv
[0])

277 #ià
	`defšed
(
ENABLE_FEATURE_EXECVE
)

278 ià(
süt_£cur™y
 >ğ
SSEC_BUILT_IN
)

280 cÚ¡ *
cmd
 = 
a
->
¬gv
[0];

281 *cÚ¡ *
¬gv
 = 
a
->argv;

282 *cÚ¡ *
’vp
 = (*cÚ¡ *)
	`make_’v_¬¿y
(
es
, 
Œue
, &
gc
);

283 
pid_t
 
pid
;

284 
pe_¡dout
[2];

286 ià(
	`pe
(
pe_¡dout
) == 0)

288 
pid
 = 
	`fÜk
();

289 ià(
pid
 =ğ(
pid_t
)0)

291 
	`şo£
(
pe_¡dout
[0]);

292 
	`dup2
(
pe_¡dout
[1],1);

293 
	`execve
(
cmd
, 
¬gv
, 
’vp
);

294 
	`ex™
(
OPENVPN_EXECVE_FAILURE
);

296 ià(
pid
 > (
pid_t
)0)

298 
¡©us
 = 0;

300 
	`şo£
(
pe_¡dout
[1]);

301 
	`wa™pid
(
pid
, &
¡©us
, 0);

302 
»t
 = 
pe_¡dout
[0];

306 
	`şo£
(
pe_¡dout
[0]);

307 
	`şo£
(
pe_¡dout
[1]);

308 
	`msg
(
M_ERR
, "İ’v²_pİ’: uÇbËØfÜk %s", 
cmd
);

313 
	`msg
(
M_WARN
, "İ’v²_pİ’: uÇbËØü—‹ stdouˆpfÜ %s", 
cmd
);

314 
»t
 = -1;

317 ià(!
w¬n_shown
 && (
süt_£cur™y
 < 
SSEC_SCRIPTS
))

319 
	`msg
(
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

320 
w¬n_shown
 = 
Œue
;

323 
	`msg
(
M_WARN
, "openvpn_popen:ƒxecve function‚ot‡vailable");

328 
	`msg
(
M_FATAL
, "openvpn_popen: called withƒmpty‡rgv");

331 
	`gc_ä“
(&
gc
);

332  
»t
;

333 
	}
}

348 
	$cÚ¡ruù_Çme_v®ue
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
gc_¬’a
 *
gc
)

350 
bufãr
 
out
;

352 
	`ASSERT
(
Çme
);

353 ià(!
v®ue
)

355 
v®ue
 = "";

357 
out
 = 
	`®loc_buf_gc
(
	`¡¾’
(
Çme
è+ sŒËn(
v®ue
è+ 2, 
gc
);

358 
	`buf_´štf
(&
out
, "%s=%s", 
Çme
, 
v®ue
);

359  
	`BSTR
(&
out
);

360 
	}
}

362 
boŞ


363 
	$’v_¡ršg_equ®
(cÚ¡ *
s1
, cÚ¡ *
s2
)

365 
c1
, 
c2
;

366 
	`ASSERT
(
s1
);

367 
	`ASSERT
(
s2
);

369 
Œue
)

371 
c1
 = *
s1
++;

372 
c2
 = *
s2
++;

373 ià(
c1
 == '=')

375 
c1
 = 0;

377 ià(
c2
 == '=')

379 
c2
 = 0;

381 ià(!
c1
 && !
c2
)

383  
Œue
;

385 ià(
c1
 !ğ
c2
)

390  
çl£
;

391 
	}
}

393 
boŞ


394 
	$»move_’v_™em
(cÚ¡ *
¡r
, cÚ¡ 
boŞ
 
do_ä“
, 
’v_™em
 **
li¡
)

396 
’v_™em
 *
cu¼’t
, *
´ev
;

398 
	`ASSERT
(
¡r
);

399 
	`ASSERT
(
li¡
);

401 
cu¼’t
 = *
li¡
, 
´ev
 = 
NULL
; cu¼’ˆ!ğNULL; cu¼’ˆğcu¼’t->
Ãxt
)

403 ià(
	`’v_¡ršg_equ®
(
cu¼’t
->
¡ršg
, 
¡r
))

405 ià(
´ev
)

407 
´ev
->
Ãxt
 = 
cu¼’t
->next;

411 *
li¡
 = 
cu¼’t
->
Ãxt
;

413 ià(
do_ä“
)

415 
	`£cu»_memz”o
(
cu¼’t
->
¡ršg
, 
	`¡¾’
(current->string));

416 
	`ä“
(
cu¼’t
->
¡ršg
);

417 
	`ä“
(
cu¼’t
);

419  
Œue
;

421 
´ev
 = 
cu¼’t
;

423  
çl£
;

424 
	}
}

427 
	$add_’v_™em
(*
¡r
, cÚ¡ 
boŞ
 
do_®loc
, 
’v_™em
 **
li¡
, 
gc_¬’a
 *
gc
)

429 
’v_™em
 *
™em
;

431 
	`ASSERT
(
¡r
);

432 
	`ASSERT
(
li¡
);

434 
	`ALLOC_OBJ_GC
(
™em
, 
’v_™em
, 
gc
);

435 
™em
->
¡ršg
 = 
do_®loc
 ? 
	`¡ršg_®loc
(
¡r
, 
gc
) : str;

436 
™em
->
Ãxt
 = *
li¡
;

437 *
li¡
 = 
™em
;

438 
	}
}

442 
boŞ


443 
	$’v_£t_d–_nŞock
(
’v_£t
 *
es
, cÚ¡ *
¡r
)

445  
	`»move_’v_™em
(
¡r
, 
es
->
gc
 =ğ
NULL
, &es->
li¡
);

446 
	}
}

449 
	$’v_£t_add_nŞock
(
’v_£t
 *
es
, cÚ¡ *
¡r
)

451 
	`»move_’v_™em
(
¡r
, 
es
->
gc
 =ğ
NULL
, &es->
li¡
);

452 
	`add_’v_™em
((*)
¡r
, 
Œue
, &
es
->
li¡
,ƒs->
gc
);

453 
	}
}

455 
’v_£t
 *

456 
	$’v_£t_ü—‹
(
gc_¬’a
 *
gc
)

458 
’v_£t
 *
es
;

459 
	`ALLOC_OBJ_CLEAR_GC
(
es
, 
’v_£t
, 
gc
);

460 
es
->
li¡
 = 
NULL
;

461 
es
->
gc
 = gc;

462  
es
;

463 
	}
}

466 
	$’v_£t_de¡roy
(
’v_£t
 *
es
)

468 ià(
es
 &&ƒs->
gc
 =ğ
NULL
)

470 
’v_™em
 *
e
 = 
es
->
li¡
;

471 
e
)

473 
’v_™em
 *
Ãxt
 = 
e
->next;

474 
	`ä“
(
e
->
¡ršg
);

475 
	`ä“
(
e
);

476 
e
 = 
Ãxt
;

478 
	`ä“
(
es
);

480 
	}
}

482 
boŞ


483 
	$’v_£t_d–
(
’v_£t
 *
es
, cÚ¡ *
¡r
)

485 
boŞ
 
»t
;

486 
	`ASSERT
(
es
);

487 
	`ASSERT
(
¡r
);

488 
»t
 = 
	`’v_£t_d–_nŞock
(
es
, 
¡r
);

489  
»t
;

490 
	}
}

493 
	$’v_£t_add
(
’v_£t
 *
es
, cÚ¡ *
¡r
)

495 
	`ASSERT
(
es
);

496 
	`ASSERT
(
¡r
);

497 
	`’v_£t_add_nŞock
(
es
, 
¡r
);

498 
	}
}

501 
	$’v_£t_g‘
(cÚ¡ 
’v_£t
 *
es
, cÚ¡ *
Çme
)

503 cÚ¡ 
’v_™em
 *
™em
 = 
es
->
li¡
;

504 
™em
 && !
	`’v_¡ršg_equ®
(™em->
¡ršg
, 
Çme
))

506 
™em
 = i‹m->
Ãxt
;

508  
™em
 ? i‹m->
¡ršg
 : 
NULL
;

509 
	}
}

512 
	$’v_£t_´št
(
msgËv–
, cÚ¡ 
’v_£t
 *
es
)

514 ià(
	`check_debug_Ëv–
(
msgËv–
))

516 cÚ¡ 
’v_™em
 *
e
;

517 
i
;

519 ià(
es
)

521 
e
 = 
es
->
li¡
;

522 
i
 = 0;

524 
e
)

526 ià(
	`’v_§ã_to_´št
(
e
->
¡ršg
))

528 
	`msg
(
msgËv–
, "ENV [%d] '%s'", 
i
, 
e
->
¡ršg
);

530 ++
i
;

531 
e
 =ƒ->
Ãxt
;

535 
	}
}

538 
	$’v_£t_šh”™
(
’v_£t
 *
es
, cÚ¡ ’v_£ˆ*
¤c
)

540 cÚ¡ 
’v_™em
 *
e
;

542 
	`ASSERT
(
es
);

544 ià(
¤c
)

546 
e
 = 
¤c
->
li¡
;

547 
e
)

549 
	`’v_£t_add_nŞock
(
es
, 
e
->
¡ršg
);

550 
e
 =ƒ->
Ãxt
;

553 
	}
}

559 
	$£‹nv_couÁ”
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
couÁ”_ty³
 
v®ue
)

561 
buf
[64];

562 
	`İ’v²_¢´štf
(
buf
, (buf), 
couÁ”_fÜm©
, 
v®ue
);

563 
	`£‹nv_¡r
(
es
, 
Çme
, 
buf
);

564 
	}
}

567 
	$£‹nv_št
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
v®ue
)

569 
buf
[64];

570 
	`İ’v²_¢´štf
(
buf
, (buf), "%d", 
v®ue
);

571 
	`£‹nv_¡r
(
es
, 
Çme
, 
buf
);

572 
	}
}

575 
	$£‹nv_unsigÃd
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
v®ue
)

577 
buf
[64];

578 
	`İ’v²_¢´štf
(
buf
, (buf), "%u", 
v®ue
);

579 
	`£‹nv_¡r
(
es
, 
Çme
, 
buf
);

580 
	}
}

583 
	$£‹nv_¡r
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

585 
	`£‹nv_¡r_ex
(
es
, 
Çme
, 
v®ue
, 
CC_NAME
, 0, 0, 
CC_PRINT
, 0, 0);

586 
	}
}

589 
	$£‹nv_¡r_§ã
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

591 
ušt8_t
 
b
[64];

592 
bufãr
 
buf
;

593 
	`buf_£t_wr™e
(&
buf
, 
b
, (b));

594 ià(
	`buf_´štf
(&
buf
, "OPENVPN_%s", 
Çme
))

596 
	`£‹nv_¡r
(
es
, 
	`BSTR
(&
buf
), 
v®ue
);

600 
	`msg
(
M_WARN
, "setenv_str_safe:‚ame overflow");

602 
	}
}

605 
	$£‹nv_¡r_šü
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

607 
couÁ”
 = 1;

608 cÚ¡ 
size_t
 
tm²ame_Ën
 = 
	`¡¾’
(
Çme
) + 5;

609 *
tm²ame
 = 
	`gc_m®loc
(
tm²ame_Ën
, 
Œue
, 
NULL
);

610 
	`¡rıy
(
tm²ame
, 
Çme
);

611 
NULL
 !ğ
	`’v_£t_g‘
(
es
, 
tm²ame
è&& 
couÁ”
 < 1000)

613 
	`ASSERT
(
	`İ’v²_¢´štf
(
tm²ame
, 
tm²ame_Ën
, "%s_%u", 
Çme
, 
couÁ”
));

614 
couÁ”
++;

616 ià(
couÁ”
 < 1000)

618 
	`£‹nv_¡r
(
es
, 
tm²ame
, 
v®ue
);

622 
	`msg
(
D_TLS_DEBUG_MED
, "ToØmªy same-Çm’v v¬ŸbËs, ignÜšg: %s", 
Çme
);

624 
	`ä“
(
tm²ame
);

625 
	}
}

628 
	$£‹nv_d–
(
’v_£t
 *
es
, cÚ¡ *
Çme
)

630 
	`ASSERT
(
Çme
);

631 
	`£‹nv_¡r
(
es
, 
Çme
, 
NULL
);

632 
	}
}

635 
	$£‹nv_¡r_ex
(
’v_£t
 *
es
,

636 cÚ¡ *
Çme
,

637 cÚ¡ *
v®ue
,

638 cÚ¡ 
Çme_šşude
,

639 cÚ¡ 
Çme_exşude
,

640 cÚ¡ 
Çme_»¶aû
,

641 cÚ¡ 
v®ue_šşude
,

642 cÚ¡ 
v®ue_exşude
,

643 cÚ¡ 
v®ue_»¶aû
)

645 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

646 cÚ¡ *
Çme_tmp
;

647 cÚ¡ *
v®_tmp
 = 
NULL
;

649 
	`ASSERT
(
Çme
 && 
	`¡¾’
(name) > 1);

651 
Çme_tmp
 = 
	`¡ršg_mod_cÚ¡
(
Çme
, 
Çme_šşude
, 
Çme_exşude
, 
Çme_»¶aû
, &
gc
);

653 ià(
v®ue
)

655 
v®_tmp
 = 
	`¡ršg_mod_cÚ¡
(
v®ue
, 
v®ue_šşude
, 
v®ue_exşude
, 
v®ue_»¶aû
, &
gc
);

658 
	`ASSERT
(
es
);

660 ià(
v®_tmp
)

662 cÚ¡ *
¡r
 = 
	`cÚ¡ruù_Çme_v®ue
(
Çme_tmp
, 
v®_tmp
, &
gc
);

663 
	`’v_£t_add
(
es
, 
¡r
);

664 #ià
DEBUG_VERBOSE_SETENV


665 
	`msg
(
M_INFO
, "SETENV_ES '%s'", 
¡r
);

670 
	`’v_£t_d–
(
es
, 
Çme_tmp
);

673 
	`gc_ä“
(&
gc
);

674 
	}
}

680 
	$£‹nv_fÜm©_šdexed_Çme
(cÚ¡ *
Çme
, cÚ¡ 
i
, 
gc_¬’a
 *
gc
)

682 
bufãr
 
out
 = 
	`®loc_buf_gc
(
	`¡¾’
(
Çme
è+ 16, 
gc
);

683 ià(
i
 >= 0)

685 
	`buf_´štf
(&
out
, "%s_%d", 
Çme
, 
i
);

689 
	`buf_´štf
(&
out
, "%s", 
Çme
);

691  
	`BSTR
(&
out
);

692 
	}
}

695 
	$£‹nv_št_i
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ 
v®ue
, cÚ¡ 
i
)

697 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

698 cÚ¡ *
Çme_¡r
 = 
	`£‹nv_fÜm©_šdexed_Çme
(
Çme
, 
i
, &
gc
);

699 
	`£‹nv_št
(
es
, 
Çme_¡r
, 
v®ue
);

700 
	`gc_ä“
(&
gc
);

701 
	}
}

704 
	$£‹nv_¡r_i
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
, cÚ¡ 
i
)

706 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

707 cÚ¡ *
Çme_¡r
 = 
	`£‹nv_fÜm©_šdexed_Çme
(
Çme
, 
i
, &
gc
);

708 
	`£‹nv_¡r
(
es
, 
Çme_¡r
, 
v®ue
);

709 
	`gc_ä“
(&
gc
);

710 
	}
}

713 
boŞ


714 
	$‹¡_fe
(cÚ¡ *
f’ame
)

716 
boŞ
 
»t
 = 
çl£
;

717 ià(
f’ame
)

719 
FILE
 *
å
 = 
	`¶©fÜm_fİ’
(
f’ame
, "r");

720 ià(
å
)

722 
	`fşo£
(
å
);

723 
»t
 = 
Œue
;

727 ià(
	`İ’v²_”ºo
(è=ğ
EACCES
)

729 
	`msg
Ğ
M_WARN
 | 
M_ERRNO
, "Could‚Ù‡cûs f'%s'", 
f’ame
);

734 
	`dmsg
(
D_TEST_FILE
, "TEST FILE '%s' [%d]",

735 
f’ame
 ? filename : "UNDEF",

736 
»t
);

738  
»t
;

739 
	}
}

743 
	$ü—‹_‹mp_fe
(cÚ¡ *
dœeùÜy
, cÚ¡ *
´efix
, 
gc_¬’a
 *
gc
)

745 
couÁ”
;

746 
bufãr
 
âame
 = 
	`®loc_buf_gc
(256, 
gc
);

747 
fd
;

748 cÚ¡ *
»tâame
 = 
NULL
;

749 
©‹m±s
 = 0;

753 ++
©‹m±s
;

754 ++
couÁ”
;

756 
	`buf_´štf
(&
âame
, 
PACKAGE
 "_%s_%08lx%08lx.tmp", 
´efix
,

757 (è
	`g‘_¿ndom
(), () get_random());

759 
»tâame
 = 
	`g’_·th
(
dœeùÜy
, 
	`BSTR
(&
âame
), 
gc
);

760 ià(!
»tâame
)

762 
	`msg
(
M_WARN
, "Failedo createemporary filename‡nd…ath");

763  
NULL
;

768 
fd
 = 
	`¶©fÜm_İ’
(
»tâame
, 
O_CREAT
 | 
O_EXCL
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
);

769 ià(
fd
 != -1)

771 
	`şo£
(
fd
);

772  
»tâame
;

774 ià(
fd
 =ğ-1 && 
”ºo
 !ğ
EEXIST
)

777 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Could‚ot createemporary file '%s'",

778 
»tâame
);

779  
NULL
;

782 
©‹m±s
 < 6);

784 
	`msg
(
M_WARN
, "FaedØü—‹empÜ¬y faá” %˜©‹m±s", 
©‹m±s
);

785  
NULL
;

786 
	}
}

788 #ifdeà
ENABLE_CRYPTO


796 
	$ho¡Çme_¿ndomize
(cÚ¡ *
ho¡Çme
, 
gc_¬’a
 *
gc
)

798 
	#n_ºd_by‹s
 6

	)

800 
ušt8_t
 
ºd_by‹s
[
n_ºd_by‹s
];

801 cÚ¡ *
ºd_¡r
;

802 
bufãr
 
hÇme
 = 
	`®loc_buf_gc
(
	`¡¾’
(
ho¡Çme
)+(
ºd_by‹s
)*2+4, 
gc
);

804 
	`´ng_by‹s
(
ºd_by‹s
, (rnd_bytes));

805 
ºd_¡r
 = 
	`fÜm©_hex_ex
(
ºd_by‹s
, Ônd_by‹s), 40, 0, 
NULL
, 
gc
);

806 
	`buf_´štf
(&
hÇme
, "%s.%s", 
ºd_¡r
, 
ho¡Çme
);

807  
	`BSTR
(&
hÇme
);

808 #undeà
n_ºd_by‹s


809 
	}
}

814 
	$ho¡Çme_¿ndomize
(cÚ¡ *
ho¡Çme
, 
gc_¬’a
 *
gc
)

816 
	`msg
(
M_WARN
, "WARNING: hostname„andomization disabled when crypto support is‚ot compiled");

817  
ho¡Çme
;

818 
	}
}

826 
	$g’_·th
(cÚ¡ *
dœeùÜy
, cÚ¡ *
f’ame
, 
gc_¬’a
 *
gc
)

828 #ifdeà
_WIN32


829 cÚ¡ 
CC_PATH_RESERVED
 = 
CC_LESS_THAN
|
CC_GREATER_THAN
|
CC_COLON


830 |
CC_DOUBLE_QUOTE
|
CC_SLASH
|
CC_BACKSLASH
|
CC_PIPE
|
CC_QUESTION_MARK
|
CC_ASTERISK
;

832 cÚ¡ 
CC_PATH_RESERVED
 = 
CC_SLASH
;

834 cÚ¡ *
§ã_f’ame
 = 
	`¡ršg_mod_cÚ¡
(
f’ame
, 
CC_PRINT
, 
CC_PATH_RESERVED
, '_', 
gc
);

836 ià(
§ã_f’ame


837 && 
	`¡rcmp
(
§ã_f’ame
, ".")

838 && 
	`¡rcmp
(
§ã_f’ame
, "..")

839 #ifdeà
_WIN32


840 && 
	`wš_§ã_f’ame
(
§ã_f’ame
)

844 cÚ¡ 
size_t
 
outsize
 = 
	`¡¾’
(
§ã_f’ame
è+ (
dœeùÜy
 ? strlen(directory) : 0) + 16;

845 
bufãr
 
out
 = 
	`®loc_buf_gc
(
outsize
, 
gc
);

846 
dœ£p
[2];

848 
dœ£p
[0] = 
OS_SPECIFIC_DIRSEP
;

849 
dœ£p
[1] = '\0';

851 ià(
dœeùÜy
)

853 
	`buf_´štf
(&
out
, "%s%s", 
dœeùÜy
, 
dœ£p
);

855 
	`buf_´štf
(&
out
, "%s", 
§ã_f’ame
);

857  
	`BSTR
(&
out
);

861  
NULL
;

863 
	}
}

865 
boŞ


866 
	$absŞu‹_·thÇme
(cÚ¡ *
·thÇme
)

868 ià(
·thÇme
)

870 cÚ¡ 
c
 = 
·thÇme
[0];

871 #ifdeà
_WIN32


872  
c
 =ğ'\\' || (
	`i§Íha
(cè&& 
·thÇme
[1] == ':' &&…athname[2] == '\\');

874  
c
 == '/';

879  
çl£
;

881 
	}
}

887 
boŞ


888 
	$g‘_u£r_·ss_ü
(
u£r_·ss
 *
up
,

889 cÚ¡ *
auth_fe
,

890 cÚ¡ *
´efix
,

891 cÚ¡ 
æags
,

892 cÚ¡ *
auth_ch®Ënge
)

894 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

896 ià(!
up
->
defšed
)

898 
boŞ
 
äom_authfe
 = (
auth_fe
 && !
	`¡»q
(auth_file, "stdin"));

899 
boŞ
 
u£ºame_äom_¡dš
 = 
çl£
;

900 
boŞ
 
·sswÜd_äom_¡dš
 = 
çl£
;

901 
boŞ
 
»¥Ú£_äom_¡dš
 = 
Œue
;

903 ià(
æags
 & 
GET_USER_PASS_PREVIOUS_CREDS_FAILED
)

905 
	`msg
(
M_WARN
, "NÙe:…»viou '%s' c»d’tŸl çed", 
´efix
);

908 #ifdeà
ENABLE_MANAGEMENT


912 ià(
mªagem’t


913 && (!
äom_authfe
 && (
æags
 & 
GET_USER_PASS_MANAGEMENT
))

914 && 
	`mªagem’t_qu”y_u£r_·ss_’abËd
(
mªagem’t
))

916 cÚ¡ *
sc
 = 
NULL
;

917 
»¥Ú£_äom_¡dš
 = 
çl£
;

919 ià(
æags
 & 
GET_USER_PASS_PREVIOUS_CREDS_FAILED
)

921 
	`mªagem’t_auth_çu»
(
mªagem’t
, 
´efix
, "previous‡uth credentials failed");

924 #ifdeà
ENABLE_CLIENT_CR


925 ià(
auth_ch®Ënge
 && (
æags
 & 
GET_USER_PASS_STATIC_CHALLENGE
))

927 
sc
 = 
auth_ch®Ënge
;

930 ià(!
	`mªagem’t_qu”y_u£r_·ss
(
mªagem’t
, 
up
, 
´efix
, 
æags
, 
sc
))

932 ià((
æags
 & 
GET_USER_PASS_NOFATAL
) != 0)

934  
çl£
;

938 
	`msg
(
M_FATAL
, "ERROR: could‚Ù„—d % u£ºame/·sswÜd/ok/¡ršg from mªagem’ˆš‹rçû", 
´efix
);

947 ià(
æags
 & 
GET_USER_PASS_NEED_OK
)

949 
bufãr
 
u£r_´om±
 = 
	`®loc_buf_gc
(128, &
gc
);

951 
	`buf_´štf
(&
u£r_´om±
, "NEED-OK|%s|%s:", 
´efix
, 
up
->
u£ºame
);

952 ià(!
	`qu”y_u£r_SINGLE
(
	`BSTR
(&
u£r_´om±
), 
	`BLEN
(&user_prompt),

953 
up
->
·sswÜd
, 
USER_PASS_LEN
, 
çl£
))

955 
	`msg
(
M_FATAL
, "ERROR: could‚Ù„—d % ok-cÚfœm©iÚ from stdš", 
´efix
);

958 ià(!
	`¡¾’
(
up
->
·sswÜd
))

960 
	`¡rıy
(
up
->
·sswÜd
, "ok");

963 ià(
æags
 & 
GET_USER_PASS_INLINE_CREDS
)

965 
bufãr
 
buf
;

966 
	`buf_£t_»ad
(&
buf
, (
ušt8_t
 *è
auth_fe
, 
	`¡¾’
(auth_file) + 1);

967 ià(!(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
))

969 
	`buf_·r£
(&
buf
, '\n', 
up
->
u£ºame
, 
USER_PASS_LEN
);

971 
	`buf_·r£
(&
buf
, '\n', 
up
->
·sswÜd
, 
USER_PASS_LEN
);

976 ià(
äom_authfe
 && !(
æags
 & 
GET_USER_PASS_DYNAMIC_CHALLENGE
))

981 
FILE
 *
å
;

982 
·sswÜd_buf
[
USER_PASS_LEN
] = { '\0' };

984 
å
 = 
	`¶©fÜm_fİ’
(
auth_fe
, "r");

985 ià(!
å
)

987 
	`msg
(
M_ERR
, "E¼Ü o³nšg '%s'‡uth fe: %s", 
´efix
, 
auth_fe
);

990 ià((
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
) == 0)

993 ià(
	`fg‘s
(
up
->
u£ºame
, 
USER_PASS_LEN
, 
å
è=ğ
NULL
)

995 
	`msg
(
M_FATAL
, "Error„eading username from %s‡uthfile: %s",

996 
´efix
,

997 
auth_fe
);

1000 
	`chomp
(
up
->
u£ºame
);

1002 ià(
	`fg‘s
(
·sswÜd_buf
, 
USER_PASS_LEN
, 
å
è!ğ
NULL
)

1004 
	`chomp
(
·sswÜd_buf
);

1007 ià(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
 && !
·sswÜd_buf
[0])

1009 
	`msg
(
M_FATAL
, "E¼Ü„—dšg…asswÜd from % authfe: %s", 
´efix
, 
auth_fe
);

1012 ià(
·sswÜd_buf
[0])

1014 
	`¡ºıy
(
up
->
·sswÜd
, 
·sswÜd_buf
, 
USER_PASS_LEN
);

1018 
·sswÜd_äom_¡dš
 = 1;

1021 
	`fşo£
(
å
);

1023 ià(!(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
è&& 
	`¡¾’
(
up
->
u£ºame
) == 0)

1025 
	`msg
(
M_FATAL
, "ERROR: u£ºamäom % authf'%s' i em±y", 
´efix
, 
auth_fe
);

1030 
u£ºame_äom_¡dš
 = 
Œue
;

1031 
·sswÜd_äom_¡dš
 = 
Œue
;

1037 ià(
u£ºame_äom_¡dš
 || 
·sswÜd_äom_¡dš
 || 
»¥Ú£_äom_¡dš
)

1039 #ifdeà
ENABLE_CLIENT_CR


1040 ià(
auth_ch®Ënge
 && (
æags
 & 
GET_USER_PASS_DYNAMIC_CHALLENGE
è&& 
»¥Ú£_äom_¡dš
)

1042 
auth_ch®Ënge_šfo
 *
ac
 = 
	`g‘_auth_ch®Ënge
(
auth_ch®Ënge
, &
gc
);

1043 ià(
ac
)

1045 *
»¥Ú£
 = (*è
	`gc_m®loc
(
USER_PASS_LEN
, 
çl£
, &
gc
);

1046 
bufãr
 
·cked_»¥
, 
ch®Ënge
;

1048 
ch®Ënge
 = 
	`®loc_buf_gc
(14+
	`¡¾’
(
ac
->
ch®Ënge_‹xt
), &
gc
);

1049 
	`buf_´štf
(&
ch®Ënge
, "CHALLENGE: %s", 
ac
->
ch®Ënge_‹xt
);

1050 
	`buf_£t_wr™e
(&
·cked_»¥
, (
ušt8_t
 *)
up
->
·sswÜd
, 
USER_PASS_LEN
);

1052 ià(!
	`qu”y_u£r_SINGLE
(
	`BSTR
(&
ch®Ënge
), 
	`BLEN
(&challenge),

1053 
»¥Ú£
, 
USER_PASS_LEN
, 
	`BOOL_CAST
(
ac
->
æags
&
CR_ECHO
)))

1055 
	`msg
(
M_FATAL
, "ERROR: could‚ot„ead challenge„esponse from stdin");

1057 
	`¡ºıyÁ
(
up
->
u£ºame
, 
ac
->
u£r
, 
USER_PASS_LEN
);

1058 
	`buf_´štf
(&
·cked_»¥
, "CRV1::%s::%s", 
ac
->
¡©e_id
, 
»¥Ú£
);

1062 
	`msg
(
M_FATAL
, "ERROR:„eceived malformed challenge„equest from server");

1068 
bufãr
 
u£r_´om±
 = 
	`®loc_buf_gc
(128, &
gc
);

1069 
bufãr
 
·ss_´om±
 = 
	`®loc_buf_gc
(128, &
gc
);

1071 
	`qu”y_u£r_ş—r
();

1072 
	`buf_´štf
(&
u£r_´om±
, "EÁ” % U£ºame:", 
´efix
);

1073 
	`buf_´štf
(&
·ss_´om±
, "EÁ” % PasswÜd:", 
´efix
);

1075 ià(
u£ºame_äom_¡dš
 && !(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
))

1077 
	`qu”y_u£r_add
(
	`BSTR
(&
u£r_´om±
), 
	`BLEN
(&user_prompt),

1078 
up
->
u£ºame
, 
USER_PASS_LEN
, 
Œue
);

1081 ià(
·sswÜd_äom_¡dš
)

1083 
	`qu”y_u£r_add
(
	`BSTR
(&
·ss_´om±
), 
	`BLEN
(&pass_prompt),

1084 
up
->
·sswÜd
, 
USER_PASS_LEN
, 
çl£
);

1087 ià(!
	`qu”y_u£r_exec
() )

1089 
	`msg
(
M_FATAL
, "ERROR: Failed„etrieving username or…assword");

1092 ià(!(
æags
 & 
GET_USER_PASS_PASSWORD_ONLY
))

1094 ià(
	`¡¾’
(
up
->
u£ºame
) == 0)

1096 
	`msg
(
M_FATAL
, "ERROR: % u£ºami em±y", 
´efix
);

1100 #ifdeà
ENABLE_CLIENT_CR


1101 ià(
auth_ch®Ënge
 && (
æags
 & 
GET_USER_PASS_STATIC_CHALLENGE
è&& 
»¥Ú£_äom_¡dš
)

1103 *
»¥Ú£
 = (*è
	`gc_m®loc
(
USER_PASS_LEN
, 
çl£
, &
gc
);

1104 
bufãr
 
·cked_»¥
, 
ch®Ënge
;

1105 *
pw64
 = 
NULL
, *
»¥64
 = NULL;

1107 
ch®Ënge
 = 
	`®loc_buf_gc
(14+
	`¡¾’
(
auth_ch®Ënge
), &
gc
);

1108 
	`buf_´štf
(&
ch®Ënge
, "CHALLENGE: %s", 
auth_ch®Ënge
);

1110 ià(!
	`qu”y_u£r_SINGLE
(
	`BSTR
(&
ch®Ënge
), 
	`BLEN
(&challenge),

1111 
»¥Ú£
, 
USER_PASS_LEN
,

1112 
	`BOOL_CAST
(
æags
 & 
GET_USER_PASS_STATIC_CHALLENGE_ECHO
)))

1114 
	`msg
(
M_FATAL
, "ERROR: could‚ot„etrieve static challenge„esponse");

1116 ià(
	`İ’v²_ba£64_’code
(
up
->
·sswÜd
, 
	`¡¾’
(up->·sswÜd), &
pw64
) == -1

1117 || 
	`İ’v²_ba£64_’code
(
»¥Ú£
, 
	`¡¾’
Ôe¥Ú£), &
»¥64
) == -1)

1119 
	`msg
(
M_FATAL
, "ERROR: could‚ot base64-encode…assword/static_response");

1121 
	`buf_£t_wr™e
(&
·cked_»¥
, (
ušt8_t
 *)
up
->
·sswÜd
, 
USER_PASS_LEN
);

1122 
	`buf_´štf
(&
·cked_»¥
, "SCRV1:%s:%s", 
pw64
, 
»¥64
);

1123 
	`¡ršg_ş—r
(
pw64
);

1124 
	`ä“
(
pw64
);

1125 
	`¡ršg_ş—r
(
»¥64
);

1126 
	`ä“
(
»¥64
);

1132 
	`¡ršg_mod
(
up
->
u£ºame
, 
CC_PRINT
, 
CC_CRLF
, 0);

1133 
	`¡ršg_mod
(
up
->
·sswÜd
, 
CC_PRINT
, 
CC_CRLF
, 0);

1135 
up
->
defšed
 = 
Œue
;

1139 
	`msg
(
M_INFO
, "GET_USER_PASS % u='%s'…='%s'", 
´efix
, 
up
->
u£ºame
, up->
·sswÜd
);

1142 
	`gc_ä“
(&
gc
);

1144  
Œue
;

1145 
	}
}

1147 #ifdeà
ENABLE_CLIENT_CR


1153 
auth_ch®Ënge_šfo
 *

1154 
	$g‘_auth_ch®Ënge
(cÚ¡ *
auth_ch®Ënge
, 
gc_¬’a
 *
gc
)

1156 ià(
auth_ch®Ënge
)

1158 
auth_ch®Ënge_šfo
 *
ac
;

1159 cÚ¡ 
Ën
 = 
	`¡¾’
(
auth_ch®Ënge
);

1160 *
wÜk
 = (*è
	`gc_m®loc
(
Ën
+1, 
çl£
, 
gc
);

1161 *
ı
;

1163 
bufãr
 
b
;

1164 
	`buf_£t_»ad
(&
b
, (cÚ¡ 
ušt8_t
 *)
auth_ch®Ënge
, 
Ën
);

1166 
	`ALLOC_OBJ_CLEAR_GC
(
ac
, 
auth_ch®Ënge_šfo
, 
gc
);

1169 ià(!
	`buf_·r£
(&
b
, ':', 
wÜk
, 
Ën
))

1171  
NULL
;

1173 ià(
	`¡rcmp
(
wÜk
, "CRV1"))

1175  
NULL
;

1179 ià(!
	`buf_·r£
(&
b
, ':', 
wÜk
, 
Ën
))

1181  
NULL
;

1183 
ı
 = 
wÜk
; *cp != '\0'; ++cp)

1185 cÚ¡ 
c
 = *
ı
;

1186 ià(
c
 == 'E')

1188 
ac
->
æags
 |ğ
CR_ECHO
;

1190 ià(
c
 == 'R')

1192 
ac
->
æags
 |ğ
CR_RESPONSE
;

1197 ià(!
	`buf_·r£
(&
b
, ':', 
wÜk
, 
Ën
))

1199  
NULL
;

1201 
ac
->
¡©e_id
 = 
	`¡ršg_®loc
(
wÜk
, 
gc
);

1204 ià(!
	`buf_·r£
(&
b
, ':', 
wÜk
, 
Ën
))

1206  
NULL
;

1208 
ac
->
u£r
 = (*è
	`gc_m®loc
(
	`¡¾’
(
wÜk
)+1, 
Œue
, 
gc
);

1209 
	`İ’v²_ba£64_decode
(
wÜk
, (*)
ac
->
u£r
, -1);

1212 
ac
->
ch®Ënge_‹xt
 = 
	`¡ršg_®loc
(
	`BSTR
(&
b
), 
gc
);

1214  
ac
;

1218  
NULL
;

1220 
	}
}

1224 #ià
AUTO_USERID


1227 
	$g‘_u£r_·ss_auto_u£rid
(
u£r_·ss
 *
up
, cÚ¡ *
g
)

1229 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1230 
bufãr
 
buf
;

1231 
ušt8_t
 
maÿddr
[6];

1232 
ušt8_t
 
dige¡
 [
MD5_DIGEST_LENGTH
];

1233 cÚ¡ 
ušt8_t
 
hash´efix
[] = "AUTO_USERID_DIGEST";

1235 cÚ¡ 
md_kt_t
 *
md5_kt
 = 
	`md_kt_g‘
("MD5");

1236 
md_ùx_t
 *
ùx
;

1238 
	`CLEAR
(*
up
);

1239 
	`buf_£t_wr™e
(&
buf
, (
ušt8_t
 *)
up
->
u£ºame
, 
USER_PASS_LEN
);

1240 
	`buf_´štf
(&
buf
, "%s", 
TARGET_PREFIX
);

1241 ià(
	`g‘_deçuÉ_g©eway_mac_addr
(
maÿddr
))

1243 
	`dmsg
(
D_AUTO_USERID
, "GUPAU: maÿddr=%s", 
	`fÜm©_hex_ex
(
maÿddr
, (maÿddr), 0, 1, ":", &
gc
));

1244 
ùx
 = 
	`md_ùx_Ãw
();

1245 
	`md_ùx_š™
(
ùx
, 
md5_kt
);

1246 
	`md_ùx_upd©e
(
ùx
, 
hash´efix
, (hashprefix) - 1);

1247 
	`md_ùx_upd©e
(
ùx
, 
maÿddr
, (macaddr));

1248 
	`md_ùx_fš®
(
ùx
, 
dige¡
);

1249 
	`md_ùx_ş—nup
(
ùx
);

1250 
	`md_ùx_ä“
(
ùx
);

1251 
	`buf_´štf
(&
buf
, "%s", 
	`fÜm©_hex_ex
(
dige¡
, (dige¡), 0, 256, " ", &
gc
));

1255 
	`buf_´štf
(&
buf
, "UNKNOWN");

1257 ià(
g
 && 
	`¡rcmp
(tag, "stdin"))

1259 
	`buf_´štf
(&
buf
, "-%s", 
g
);

1261 
up
->
defšed
 = 
Œue
;

1262 
	`gc_ä“
(&
gc
);

1264 
	`dmsg
(
D_AUTO_USERID
, "GUPAU: AUTO_USERID: '%s'", 
up
->
u£ºame
);

1265 
	}
}

1270 
	$purge_u£r_·ss
(
u£r_·ss
 *
up
, cÚ¡ 
boŞ
 
fÜû
)

1272 cÚ¡ 
boŞ
 
noÿche
 = 
up
->nocache;

1273 
boŞ
 
w¬n_shown
 = 
çl£
;

1274 ià(
noÿche
 || 
fÜû
)

1276 
	`£cu»_memz”o
(
up
, (*up));

1277 
up
->
noÿche
 =‚ocache;

1283 ià(!
w¬n_shown
)

1285 
	`msg
(
M_WARN
, "WARNING:his configuration may cache…asswords in memory -- usehe‡uth-nocache optiono…reventhis");

1286 
w¬n_shown
 = 
Œue
;

1288 
	}
}

1291 
	$£t_auth_tok’
(
u£r_·ss
 *
up
, u£r_·s *
tk
, cÚ¡ *
tok’
)

1294 ià(
tok’
 && 
	`¡¾’
Ñok’è&& 
up
 && up->
defšed
)

1296 
	`¡ºıyÁ
(
tk
->
·sswÜd
, 
tok’
, 
USER_PASS_LEN
);

1297 
	`¡ºıyÁ
(
tk
->
u£ºame
, 
up
->u£ºame, 
USER_PASS_LEN
);

1298 
tk
->
defšed
 = 
Œue
;

1302 
	`purge_u£r_·ss
(
up
, 
çl£
);

1303 
	}
}

1312 
	$§ã_´št
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
)

1314  
	`¡ršg_mod_cÚ¡
(
¡r
, 
CC_PRINT
, 
CC_CRLF
, '.', 
gc
);

1315 
	}
}

1317 
boŞ


1318 
	$is_·sswÜd_’v_v¬
(cÚ¡ *
¡r
)

1320  (
	`¡ºcmp
(
¡r
, "password", 8) == 0);

1321 
	}
}

1323 
boŞ


1324 
	$’v_®lowed
(cÚ¡ *
¡r
)

1326  (
süt_£cur™y
 >ğ
SSEC_PW_ENV
 || !
	`is_·sswÜd_’v_v¬
(
¡r
));

1327 
	}
}

1329 
boŞ


1330 
	$’v_§ã_to_´št
(cÚ¡ *
¡r
)

1332 #iâdeà
UNSAFE_DEBUG


1333 ià(
	`is_·sswÜd_’v_v¬
(
¡r
))

1335  
çl£
;

1338  
Œue
;

1339 
	}
}

1344 
	$make_’v_¬¿y
(cÚ¡ 
’v_£t
 *
es
,

1345 cÚ¡ 
boŞ
 
check_®lowed
,

1346 
gc_¬’a
 *
gc
)

1348 **
»t
 = 
NULL
;

1349 
’v_™em
 *
e
 = 
NULL
;

1350 
i
 = 0, 
n
 = 0;

1353 ià(
es
)

1355 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

1357 ++
n
;

1362 
	`ALLOC_ARRAY_CLEAR_GC
(
»t
, *, 
n
+1, 
gc
);

1365 ià(
es
)

1367 
i
 = 0;

1368 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

1370 ià(!
check_®lowed
 || 
	`’v_®lowed
(
e
->
¡ršg
))

1372 
	`ASSERT
(
i
 < 
n
);

1373 
»t
[
i
++] = 
e
->
¡ršg
;

1378 
»t
[
i
] = 
NULL
;

1379  (cÚ¡ **)
»t
;

1380 
	}
}

1383 
	$make_¬g_¬¿y
(cÚ¡ *
fœ¡
, cÚ¡ *
·rms
, 
gc_¬’a
 *
gc
)

1385 **
»t
 = 
NULL
;

1386 
ba£
 = 0;

1387 cÚ¡ 
max_·rms
 = 
MAX_PARMS
 + 2;

1388 
n
 = 0;

1391 
	`ALLOC_ARRAY_CLEAR_GC
(
»t
, *, 
max_·rms
, 
gc
);

1394 ià(
fœ¡
)

1396 
»t
[
ba£
++] = 
	`¡ršg_®loc
(
fœ¡
, 
gc
);

1399 ià(
·rms
)

1401 
n
 = 
	`·r£_lše
(
·rms
, &
»t
[
ba£
], 
max_·rms
 - ba£ - 1, "make_¬g_¬¿y", 0, 
M_WARN
, 
gc
);

1402 
	`ASSERT
(
n
 >ğ0 &&‚ + 
ba£
 + 1 <ğ
max_·rms
);

1404 
»t
[
ba£
 + 
n
] = 
NULL
;

1406  (cÚ¡ **)
»t
;

1407 
	}
}

1410 
	$make_šlše_¬¿y
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
)

1412 
lše
[
OPTION_LINE_SIZE
];

1413 
bufãr
 
buf
;

1414 
Ën
 = 0;

1415 **
»t
 = 
NULL
;

1416 
i
 = 0;

1418 
	`buf_£t_»ad
(&
buf
, (cÚ¡ 
ušt8_t
 *è
¡r
, 
	`¡¾’
(str));

1419 
	`buf_·r£
(&
buf
, '\n', 
lše
, (line)))

1421 ++
Ën
;

1425 
	`ALLOC_ARRAY_CLEAR_GC
(
»t
, *, 
Ën
 + 1, 
gc
);

1427 
	`buf_£t_»ad
(&
buf
, (cÚ¡ 
ušt8_t
 *è
¡r
, 
	`¡¾’
(str));

1428 
	`buf_·r£
(&
buf
, '\n', 
lše
, (line)))

1430 
	`chomp
(
lše
);

1431 
	`ASSERT
(
i
 < 
Ën
);

1432 
»t
[
i
] = 
	`¡ršg_®loc
(
	`sk_Ëadšg_wh™e¥aû
(
lše
), 
gc
);

1433 ++
i
;

1435 
	`ASSERT
(
i
 <ğ
Ën
);

1436 
»t
[
i
] = 
NULL
;

1437  (cÚ¡ **)
»t
;

1438 
	}
}

1441 
	$make_¬g_cİy
(**
p
, 
gc_¬’a
 *
gc
)

1443 **
»t
 = 
NULL
;

1444 cÚ¡ 
Ën
 = 
	`¡ršg_¬¿y_Ën
((cÚ¡ **)
p
);

1445 cÚ¡ 
max_·rms
 = 
Ën
 + 1;

1446 
i
;

1449 
	`ALLOC_ARRAY_CLEAR_GC
(
»t
, *, 
max_·rms
, 
gc
);

1451 
i
 = 0; i < 
Ën
; ++i)

1453 
»t
[
i
] = 
p
[i];

1456  (cÚ¡ **)
»t
;

1457 
	}
}

1460 
	$make_ex‹nded_¬g_¬¿y
(**
p
, 
gc_¬’a
 *
gc
)

1462 cÚ¡ 
¬gc
 = 
	`¡ršg_¬¿y_Ën
((cÚ¡ **)
p
);

1463 ià(!
	`¡rcmp
(
p
[0], 
INLINE_FILE_TAG
è&& 
¬gc
 == 2)

1465  
	`make_šlše_¬¿y
(
p
[1], 
gc
);

1467 ià(
¬gc
 == 0)

1469  
	`make_¬g_¬¿y
(
NULL
, NULL, 
gc
);

1471 ià(
¬gc
 == 1)

1473  
	`make_¬g_¬¿y
(
p
[0], 
NULL
, 
gc
);

1475 ià(
¬gc
 == 2)

1477  
	`make_¬g_¬¿y
(
p
[0],…[1], 
gc
);

1481  
	`make_¬g_cİy
(
p
, 
gc
);

1483 
	}
}

1490 
	$§n™ize_cÚŒŞ_mes§ge
(cÚ¡ *
¤c
, 
gc_¬’a
 *
gc
)

1492 *
»t
 = 
	`gc_m®loc
(
	`¡¾’
(
¤c
)+1, 
çl£
, 
gc
);

1493 *
de¡
 = 
»t
;

1494 
boŞ
 
»daù
 = 
çl£
;

1495 
sk
 = 0;

1499 cÚ¡ 
c
 = *
¤c
;

1500 ià(
c
 == '\0')

1504 ià(
c
 =ğ'S' && !
	`¡ºcmp
(
¤c
, "SESS_ID_", 8))

1506 
sk
 = 7;

1507 
»daù
 = 
Œue
;

1509 ià(
c
 =ğ'e' && !
	`¡ºcmp
(
¤c
, "echo ", 5))

1511 
sk
 = 4;

1512 
»daù
 = 
Œue
;

1514 ià(!
	`check_debug_Ëv–
(
D_SHOW_KEYS
)

1515 && (
c
 =ğ'a' && !
	`¡ºcmp
(
¤c
, "auth-token ", 11)))

1520 
sk
 = 10;

1521 
»daù
 = 
Œue
;

1524 ià(
c
 == ',')

1526 
sk
 = 0;

1527 
»daù
 = 
çl£
;

1530 ià(
»daù
)

1532 ià(
sk
 > 0)

1534 --
sk
;

1535 *
de¡
++ = 
c
;

1540 *
de¡
++ = 
c
;

1543 ++
¤c
;

1545 *
de¡
 = '\0';

1546  
»t
;

1547 
	}
}

1558 
boŞ


1559 
	$com·t_æag
(
æag
)

1561 
com·t_æags
 = 0;

1563 ià(
æag
 & 
COMPAT_FLAG_SET
)

1565 
com·t_æags
 |ğ(
æag
 >> 1);

1568  (
com·t_æags
 & (
æag
 >> 1));

1570 
	}
}

1572 #ià
P2MP_SERVER


1577 
boŞ


1578 
	$v®id©e_³”_šfo_lše
(*
lše
)

1580 
ušt8_t
 
c
;

1581 
¡©e
 = 0;

1582 *
lše
)

1584 
c
 = *
lše
;

1585 
¡©e
)

1589 ià(
c
 =ğ'=' && 
¡©e
 == 1)

1591 
¡©e
 = 2;

1593 ià(
	`i§Êum
(
c
) || c == '_')

1595 
¡©e
 = 1;

1599  
çl£
;

1604 ià(!
	`i¥ršt
(
c
è|| 
	`is¥aû
(c)

1605 || 
c
 == '$' || c == '(' || c == '`')

1607 *
lše
 = '_';

1610 
lše
++;

1612  (
¡©e
 == 2);

1613 
	}
}

1616 
	$ouut_³”_šfo_’v
(
’v_£t
 *
es
, cÚ¡ *
³”_šfo
)

1618 
lše
[256];

1619 
bufãr
 
buf
;

1620 
	`buf_£t_»ad
(&
buf
, (cÚ¡ 
ušt8_t
 *è
³”_šfo
, 
	`¡¾’
(peer_info));

1621 
	`buf_·r£
(&
buf
, '\n', 
lše
, (line)))

1623 
	`chomp
(
lše
);

1624 ià(
	`v®id©e_³”_šfo_lše
(
lše
)

1625 && (
	`¡ºcmp
(
lše
, "IV_", 3) == 0 || strncmp(line, "UV_", 3) == 0) )

1627 
	`msg
(
M_INFO
, "³” info: %s", 
lše
);

1628 
	`’v_£t_add
(
es
, 
lše
);

1632 
	`msg
(
M_WARN
, "validation failed on…eer_info†ine„eceived from client");

1635 
	}
}

	@misc.h

24 #iâdeà
MISC_H


25 
	#MISC_H


	)

27 
	~"¬gv.h
"

28 
	~"basic.h
"

29 
	~"commÚ.h
"

30 
	~"š‹g”.h
"

31 
	~"bufãr.h
"

32 
	~"¶©fÜm.h
"

35 
	#INETD_SOCKET_DESCRIPTOR
 0

	)

38 
	g¶ugš_li¡
;

44 
	s’v_™em
 {

45 *
	m¡ršg
;

46 
’v_™em
 *
	mÃxt
;

49 
	s’v_£t
 {

50 
gc_¬’a
 *
	mgc
;

51 
’v_™em
 *
	mli¡
;

55 
	#S_SCRIPT
 (1<<0)

	)

56 
	#S_FATAL
 (1<<1)

	)

58 cÚ¡ *
sy¡em_”rÜ_mes§ge
(, 
gc_¬’a
 *
gc
);

61 
	#OPENVPN_EXECVE_ERROR
 -1

	)

62 
	#OPENVPN_EXECVE_NOT_ALLOWED
 -2

	)

63 
	#OPENVPN_EXECVE_FAILURE
 127

	)

66 
İ’v²_pİ’
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
);

68 
İ’v²_execve
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
);

70 
boŞ
 
İ’v²_execve_check
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
, cÚ¡ *
”rÜ_mes§ge
);

72 
boŞ
 
İ’v²_execve_®lowed
(cÚ¡ 
æags
);

74 
šlše
 
boŞ


75 
	$İ’v²_run_süt
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
, cÚ¡ *
hook
)

77 
msg
[256];

79 
	`İ’v²_¢´štf
(
msg
, (msg), "WARNING: Faed„uÂšg commªd (%s)", 
hook
);

80  
	`İ’v²_execve_check
(
a
, 
es
, 
æags
 | 
S_SCRIPT
, 
msg
);

81 
	}
}

85 
£t_¡d_fes_to_nuÎ
(
boŞ
 
¡dš_Úly
);

88 
š‘d_sock‘_desütÜ
;

89 
§ve_š‘d_sock‘_desütÜ
();

92 
£‹nv_¡r_ex
(
’v_£t
 *
es
,

93 cÚ¡ *
Çme
,

94 cÚ¡ *
v®ue
,

95 cÚ¡ 
Çme_šşude
,

96 cÚ¡ 
Çme_exşude
,

97 cÚ¡ 
Çme_»¶aû
,

98 cÚ¡ 
v®ue_šşude
,

99 cÚ¡ 
v®ue_exşude
,

100 cÚ¡ 
v®ue_»¶aû
);

102 
£‹nv_couÁ”
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
couÁ”_ty³
 
v®ue
);

104 
£‹nv_št
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
v®ue
);

106 
£‹nv_unsigÃd
(
’v_£t
 *
es
, cÚ¡ *
Çme
, 
v®ue
);

108 
£‹nv_¡r
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

110 
£‹nv_¡r_§ã
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

112 
£‹nv_d–
(
’v_£t
 *
es
, cÚ¡ *
Çme
);

118 
£‹nv_¡r_šü
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

120 
£‹nv_št_i
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ 
v®ue
, cÚ¡ 
i
);

122 
£‹nv_¡r_i
(
’v_£t
 *
es
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
, cÚ¡ 
i
);

126 
’v_£t
 *
’v_£t_ü—‹
(
gc_¬’a
 *
gc
);

128 
’v_£t_de¡roy
(
’v_£t
 *
es
);

130 
boŞ
 
’v_£t_d–
(
’v_£t
 *
es
, cÚ¡ *
¡r
);

132 
’v_£t_add
(
’v_£t
 *
es
, cÚ¡ *
¡r
);

134 cÚ¡ *
’v_£t_g‘
(cÚ¡ 
’v_£t
 *
es
, cÚ¡ *
Çme
);

136 
’v_£t_´št
(
msgËv–
, cÚ¡ 
’v_£t
 *
es
);

138 
’v_£t_šh”™
(
’v_£t
 *
es
, cÚ¡ ’v_£ˆ*
¤c
);

142 cÚ¡ **
make_’v_¬¿y
(cÚ¡ 
’v_£t
 *
es
,

143 cÚ¡ 
boŞ
 
check_®lowed
,

144 
gc_¬’a
 *
gc
);

146 cÚ¡ **
make_¬g_¬¿y
(cÚ¡ *
fœ¡
, cÚ¡ *
·rms
, 
gc_¬’a
 *
gc
);

148 cÚ¡ **
make_ex‹nded_¬g_¬¿y
(**
p
, 
gc_¬’a
 *
gc
);

151 #ifdeà
ENABLE_CRYPTO


152 
g‘_¿ndom
();

155 
	#g‘_¿ndom
 
¿ndom


	)

159 
boŞ
 
‹¡_fe
(cÚ¡ *
f’ame
);

162 cÚ¡ *
ü—‹_‹mp_fe
(cÚ¡ *
dœeùÜy
, cÚ¡ *
´efix
, 
gc_¬’a
 *
gc
);

165 cÚ¡ *
g’_·th
(cÚ¡ *
dœeùÜy
, cÚ¡ *
f’ame
, 
gc_¬’a
 *
gc
);

168 
boŞ
 
absŞu‹_·thÇme
(cÚ¡ *
·thÇme
);

171 cÚ¡ *
ho¡Çme_¿ndomize
(cÚ¡ *
ho¡Çme
, 
gc_¬’a
 *
gc
);

177 
	su£r_·ss


179 
boŞ
 
	mdefšed
;

180 
boŞ
 
	mnoÿche
;

181 
boŞ
 
	mwa™_fÜ_push
;

184 #ifdeà
ENABLE_PKCS11


185 
	#USER_PASS_LEN
 4096

	)

187 
	#USER_PASS_LEN
 128

	)

189 
	mu£ºame
[
USER_PASS_LEN
];

190 
	m·sswÜd
[
USER_PASS_LEN
];

193 #ifdeà
ENABLE_CLIENT_CR


197 
	sauth_ch®Ënge_šfo
 {

198 
	#CR_ECHO
 (1<<0è

	)

199 
	#CR_RESPONSE
 (1<<1è

	)

200 
	mæags
;

202 cÚ¡ *
	mu£r
;

203 cÚ¡ *
	m¡©e_id
;

204 cÚ¡ *
	mch®Ënge_‹xt
;

207 
auth_ch®Ënge_šfo
 *
g‘_auth_ch®Ënge
(cÚ¡ *
auth_ch®Ënge
, 
gc_¬’a
 *
gc
);

212 
	s¡©ic_ch®Ënge_šfo
 {

213 
	#SC_ECHO
 (1<<0è

	)

214 
	mæags
;

216 cÚ¡ *
	mch®Ënge_‹xt
;

220 
	sauth_ch®Ënge_šfo
 {};

221 
	s¡©ic_ch®Ënge_šfo
 {};

227 
	#GET_USER_PASS_MANAGEMENT
 (1<<0)

	)

229 
	#GET_USER_PASS_PASSWORD_ONLY
 (1<<2)

	)

230 
	#GET_USER_PASS_NEED_OK
 (1<<3)

	)

231 
	#GET_USER_PASS_NOFATAL
 (1<<4)

	)

232 
	#GET_USER_PASS_NEED_STR
 (1<<5)

	)

233 
	#GET_USER_PASS_PREVIOUS_CREDS_FAILED
 (1<<6)

	)

235 
	#GET_USER_PASS_DYNAMIC_CHALLENGE
 (1<<7è

	)

236 
	#GET_USER_PASS_STATIC_CHALLENGE
 (1<<8è

	)

237 
	#GET_USER_PASS_STATIC_CHALLENGE_ECHO
 (1<<9è

	)

239 
	#GET_USER_PASS_INLINE_CREDS
 (1<<10è

	)

241 
boŞ
 
g‘_u£r_·ss_ü
(
u£r_·ss
 *
up
,

242 cÚ¡ *
auth_fe
,

243 cÚ¡ *
´efix
,

244 cÚ¡ 
æags
,

245 cÚ¡ *
auth_ch®Ënge
);

247 
šlše
 
boŞ


248 
	$g‘_u£r_·ss
(
u£r_·ss
 *
up
,

249 cÚ¡ *
auth_fe
,

250 cÚ¡ *
´efix
,

251 cÚ¡ 
æags
)

253  
	`g‘_u£r_·ss_ü
(
up
, 
auth_fe
, 
´efix
, 
æags
, 
NULL
);

254 
	}
}

256 
ç_u£r_·ss
(cÚ¡ *
´efix
,

257 cÚ¡ 
æags
,

258 cÚ¡ *
»asÚ
);

260 
purge_u£r_·ss
(
u£r_·ss
 *
up
, cÚ¡ 
boŞ
 
fÜû
);

262 
£t_auth_tok’
(
u£r_·ss
 *
up
, u£r_·s *
tk
,

263 cÚ¡ *
tok’
);

270 cÚ¡ *
§ã_´št
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
);

273 
boŞ
 
’v_§ã_to_´št
(cÚ¡ *
¡r
);

276 
boŞ
 
’v_®lowed
(cÚ¡ *
¡r
);

278 
cÚfigu»_·th
();

280 cÚ¡ *
§n™ize_cÚŒŞ_mes§ge
(cÚ¡ *
¡r
, 
gc_¬’a
 *
gc
);

282 #ià
AUTO_USERID


283 
g‘_u£r_·ss_auto_u£rid
(
u£r_·ss
 *
up
, cÚ¡ *
g
);

290 #ifdeà
ENABLE_IPROUTE


291 cÚ¡ *
rou‹_·th
;

295 
	#SSEC_NONE
 0

	)

296 
	#SSEC_BUILT_IN
 1

	)

297 
	#SSEC_SCRIPTS
 2

	)

298 
	#SSEC_PW_ENV
 3

	)

299 
süt_£cur™y
;

302 
	#COMPAT_FLAG_QUERY
 0

	)

303 
	#COMPAT_FLAG_SET
 (1<<0è

	)

304 
	#COMPAT_NAMES
 (1<<1è

	)

305 
	#COMPAT_NO_NAME_REMAPPING
 (1<<2è

	)

306 
boŞ
 
com·t_æag
(
æag
);

308 #ià
P2MP_SERVER


311 
boŞ
 
v®id©e_³”_šfo_lše
(*
lše
);

313 
ouut_³”_šfo_’v
(
’v_£t
 *
es
, cÚ¡ *
³”_šfo
);

	@mroute.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP_SERVER


34 
	~"mrou‹.h
"

35 
	~"´Ùo.h
"

36 
	~"”rÜ.h
"

37 
	~"sock‘.h
"

39 
	~"memdbg.h
"

42 
	$mrou‹_addr_š™
(
mrou‹_addr
 *
addr
)

44 
	`CLEAR
(*
addr
);

45 
	}
}

51 
šlše
 
boŞ


52 
	$is_mac_mÿ¡_addr
(cÚ¡ 
ušt8_t
 *
mac
)

54  (
boŞ
è(
mac
[0] & 1);

55 
	}
}

57 
šlše
 
boŞ


58 
	$is_mac_mÿ¡_maddr
(cÚ¡ 
mrou‹_addr
 *
addr
)

60  (
addr
->
ty³
 & 
MR_ADDR_MASK
è=ğ
MR_ADDR_ETHER


61 && 
	`is_mac_mÿ¡_addr
(
addr
->
‘h_addr
);

62 
	}
}

67 
boŞ


68 
	$mrou‹_Ë¬ÇbË_add»ss
(cÚ¡ 
mrou‹_addr
 *
addr
, 
gc_¬’a
 *
gc
)

70 
i
;

71 
boŞ
 
®l_z”os
 = 
Œue
;

72 
boŞ
 
®l_Úes
 = 
Œue
;

74 
i
 = 0; i < 
addr
->
Ën
; ++i)

76 
b
 = 
addr
->
¿w_addr
[
i
];

77 ià(
b
 != 0x00)

79 
®l_z”os
 = 
çl£
;

81 ià(
b
 != 0xFF)

83 
®l_Úes
 = 
çl£
;

88 ià(
®l_z”os


89 && !((
addr
->
ty³
 & 
MR_WITH_NETBITS
è&& (addr->
Ãtb™s
 < 8)))

91 
	`msg
(
D_MULTI_LOW
, "Can't†earn %s:‚etwork is‡ll 0s, but‚etbits >= 8",

92 
	`mrou‹_addr_´št
(
addr
, 
gc
));

93  
çl£
;

96 ià(
®l_Úes
)

98 
	`msg
(
D_MULTI_LOW
, "Can't†earn %s:‚etwork is‡ll 1s",

99 
	`mrou‹_addr_´št
(
addr
, 
gc
));

100  
çl£
;

103 ià(
	`is_mac_mÿ¡_maddr
(
addr
))

105 
	`msg
(
D_MULTI_LOW
, "Can't†earn %s:‚etwork is‡ multicast‡ddress",

106 
	`mrou‹_addr_´št
(
addr
, 
gc
));

107  
çl£
;

110  
Œue
;

111 
	}
}

113 
šlše
 

114 
	$mrou‹_g‘_š_addr_t
(
mrou‹_addr
 *
ma
, cÚ¡ 
š_addr_t
 
¤c
, 
mask
)

116 ià(
ma
)

118 
ma
->
ty³
 = 
MR_ADDR_IPV4
 | 
mask
;

119 
ma
->
Ãtb™s
 = 0;

120 
ma
->
Ën
 = 4;

121 
ma
->
v4
.
addr
 = 
¤c
;

123 
	}
}

125 
šlše
 

126 
	$mrou‹_g‘_š6_addr
(
mrou‹_addr
 *
ma
, cÚ¡ 
š6_addr
 
¤c
, 
mask
)

128 ià(
ma
)

130 
ma
->
ty³
 = 
MR_ADDR_IPV6
 | 
mask
;

131 
ma
->
Ãtb™s
 = 0;

132 
ma
->
Ën
 = 16;

133 
ma
->
v6
.
addr
 = 
¤c
;

135 
	}
}

137 
šlše
 
boŞ


138 
	$mrou‹_is_mÿ¡
(cÚ¡ 
š_addr_t
 
addr
)

140  ((
addr
 & 
	`htÚl
(
IP_MCAST_SUBNET_MASK
)è=ğhtÚl(
IP_MCAST_NETWORK
));

141 
	}
}

146 
šlše
 
boŞ


147 
	$mrou‹_is_mÿ¡_v6
(cÚ¡ 
š6_addr
 
addr
)

149  (
addr
.
s6_addr
[0] == 0xff);

150 
	}
}

152 #ifdeà
ENABLE_PF


155 
	$mrou‹_exŒaù_addr_¬p
(
mrou‹_addr
 *
¤c
,

156 
mrou‹_addr
 *
de¡
,

157 cÚ¡ 
bufãr
 *
buf
)

159 
»t
 = 0;

160 ià(
	`BLEN
(
buf
è>ğ(è(
İ’v²_¬p
))

162 cÚ¡ 
İ’v²_¬p
 *
¬p
 = (cÚ¡ İ’v²_¬°*è
	`BPTR
(
buf
);

163 ià(
¬p
->
mac_addr_ty³
 =ğ
	`htÚs
(0x0001)

164 && 
¬p
->
´Ùo_addr_ty³
 =ğ
	`htÚs
(0x0800)

165 && 
¬p
->
mac_addr_size
 == 0x06

166 && 
¬p
->
´Ùo_addr_size
 == 0x04)

168 
	`mrou‹_g‘_š_addr_t
(
¤c
, 
¬p
->
_¤c
, 
MR_ARP
);

169 
	`mrou‹_g‘_š_addr_t
(
de¡
, 
¬p
->
_de¡
, 
MR_ARP
);

172 ià(
	`mrou‹_is_mÿ¡
(
¬p
->
_de¡
))

174 
»t
 |ğ
MROUTE_EXTRACT_MCAST
;

177 
»t
 |ğ
MROUTE_EXTRACT_SUCCEEDED
;

180  
»t
;

181 
	}
}

186 
	$mrou‹_exŒaù_addr_
(
mrou‹_addr
 *
¤c
, mrou‹_add¸*
de¡
,

187 cÚ¡ 
bufãr
 *
buf
)

189 
»t
 = 0;

190 ià(
	`BLEN
(
buf
) >= 1)

192 
	`OPENVPN_IPH_GET_VER
(*
	`BPTR
(
buf
)))

195 ià(
	`BLEN
(
buf
è>ğ(è(
İ’v²_hdr
))

197 cÚ¡ 
İ’v²_hdr
 *

 = (cÚ¡ İ’v²_hd¸*è
	`BPTR
(
buf
);

199 
	`mrou‹_g‘_š_addr_t
(
¤c
, 

->
§ddr
, 0);

200 
	`mrou‹_g‘_š_addr_t
(
de¡
, 

->
daddr
, 0);

203 ià(
	`mrou‹_is_mÿ¡
(

->
daddr
))

205 
»t
 |ğ
MROUTE_EXTRACT_MCAST
;

209 ià(

->
´ÙocŞ
 =ğ
OPENVPN_IPPROTO_IGMP
)

211 
»t
 |ğ
MROUTE_EXTRACT_IGMP
;

214 
»t
 |ğ
MROUTE_EXTRACT_SUCCEEDED
;

219 ià(
	`BLEN
(
buf
è>ğ(è(
İ’v²_v6hdr
))

221 cÚ¡ 
İ’v²_v6hdr
 *
v6
 = (cÚ¡ İ’v²_v6hd¸*è
	`BPTR
(
buf
);

223 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

224 
	`msg
Ğ
M_INFO
, "IPv6…acket! src=%s, dst=%s",

225 
	`´št_š6_addr
Ğ
v6
->
§ddr
, 0, &
gc
 ),

226 
	`´št_š6_addr
Ğ
v6
->
daddr
, 0, &
gc
 ));

227 
	`gc_ä“
(&
gc
);

230 
	`mrou‹_g‘_š6_addr
(
¤c
, 
v6
->
§ddr
, 0);

231 
	`mrou‹_g‘_š6_addr
(
de¡
, 
v6
->
daddr
, 0);

233 ià(
	`mrou‹_is_mÿ¡_v6
(
v6
->
daddr
))

235 
»t
 |ğ
MROUTE_EXTRACT_MCAST
;

238 
»t
 |ğ
MROUTE_EXTRACT_SUCCEEDED
;

243 
	`msg
(
M_WARN
, "IP…acket with unknown IP version=%d seen",

244 
	`OPENVPN_IPH_GET_VER
(*
	`BPTR
(
buf
)));

247  
»t
;

248 
	}
}

251 
	$mrou‹_exŒaù_addr_‘h”
(
mrou‹_addr
 *
¤c
,

252 
mrou‹_addr
 *
de¡
,

253 
mrou‹_addr
 *
e¤c
,

254 
mrou‹_addr
 *
ede¡
,

255 cÚ¡ 
bufãr
 *
buf
)

257 
»t
 = 0;

258 ià(
	`BLEN
(
buf
è>ğ(è(
İ’v²_‘hhdr
))

260 cÚ¡ 
İ’v²_‘hhdr
 *
‘h
 = (cÚ¡ İ’v²_‘hhd¸*è
	`BPTR
(
buf
);

261 ià(
¤c
)

263 
¤c
->
ty³
 = 
MR_ADDR_ETHER
;

264 
¤c
->
Ãtb™s
 = 0;

265 
¤c
->
Ën
 = 6;

266 
	`memıy
(
¤c
->
‘h_addr
, 
‘h
->
sourû
, (
de¡
->eth_addr));

268 ià(
de¡
)

270 
de¡
->
ty³
 = 
MR_ADDR_ETHER
;

271 
de¡
->
Ãtb™s
 = 0;

272 
de¡
->
Ën
 = 6;

273 
	`memıy
(
de¡
->
‘h_addr
, 
‘h
->dest, (dest->eth_addr));

276 ià(
	`is_mac_mÿ¡_addr
(
‘h
->
de¡
))

278 
»t
 |ğ
MROUTE_EXTRACT_BCAST
;

282 
»t
 |ğ
MROUTE_EXTRACT_SUCCEEDED
;

284 #ifdeà
ENABLE_PF


285 ià(
e¤c
 || 
ede¡
)

287 
bufãr
 
b
 = *
buf
;

288 ià(
	`buf_advªû
(&
b
, (
İ’v²_‘hhdr
)))

290 
	`Áohs
(
‘h
->
´Ùo
))

292 
OPENVPN_ETH_P_IPV4
:

293 
»t
 |ğ(
	`mrou‹_exŒaù_addr_
(
e¤c
, 
ede¡
, &
b
è<< 
MROUTE_SEC_SHIFT
);

296 
OPENVPN_ETH_P_ARP
:

297 
»t
 |ğ(
	`mrou‹_exŒaù_addr_¬p
(
e¤c
, 
ede¡
, &
b
è<< 
MROUTE_SEC_SHIFT
);

304  
»t
;

305 
	}
}

311 
boŞ


312 
	$mrou‹_exŒaù_İ’v²_sockaddr
(
mrou‹_addr
 *
addr
,

313 cÚ¡ 
İ’v²_sockaddr
 *
o§ddr
,

314 
boŞ
 
u£_pÜt
)

316 
o§ddr
->
addr
.
§
.
§_çmy
)

318 
AF_INET
:

320 ià(
u£_pÜt
)

322 
addr
->
ty³
 = 
MR_ADDR_IPV4
 | 
MR_WITH_PORT
;

323 
addr
->
Ãtb™s
 = 0;

324 
addr
->
Ën
 = 6;

325 
addr
->
v4
.add¸ğ
o§ddr
->addr.
š4
.
sš_addr
.
s_addr
;

326 
addr
->
v4
.
pÜt
 = 
o§ddr
->addr.
š4
.
sš_pÜt
;

330 
addr
->
ty³
 = 
MR_ADDR_IPV4
;

331 
addr
->
Ãtb™s
 = 0;

332 
addr
->
Ën
 = 4;

333 
addr
->
v4
.add¸ğ
o§ddr
->addr.
š4
.
sš_addr
.
s_addr
;

335  
Œue
;

338 
AF_INET6
:

339 ià(
u£_pÜt
)

341 
addr
->
ty³
 = 
MR_ADDR_IPV6
 | 
MR_WITH_PORT
;

342 
addr
->
Ãtb™s
 = 0;

343 
addr
->
Ën
 = 18;

344 
addr
->
v6
.add¸ğ
o§ddr
->addr.
š6
.
sš6_addr
;

345 
addr
->
v6
.
pÜt
 = 
o§ddr
->addr.
š6
.
sš6_pÜt
;

349 
addr
->
ty³
 = 
MR_ADDR_IPV6
;

350 
addr
->
Ãtb™s
 = 0;

351 
addr
->
Ën
 = 16;

352 
addr
->
v6
.add¸ğ
o§ddr
->addr.
š6
.
sš6_addr
;

354  
Œue
;

356  
çl£
;

357 
	}
}

369 
	$mrou‹_addr_mask_ho¡_b™s
(
mrou‹_addr
 *
ma
)

371 ià((
ma
->
ty³
 & 
MR_ADDR_MASK
è=ğ
MR_ADDR_IPV4
)

373 
š_addr_t
 
addr
 = 
	`Áohl
(
ma
->
v4
.addr);

374 
addr
 &ğ
	`Ãtb™s_to_Ãtmask
(
ma
->
Ãtb™s
);

375 
ma
->
v4
.
addr
 = 
	`htÚl
(addr);

377 ià((
ma
->
ty³
 & 
MR_ADDR_MASK
è=ğ
MR_ADDR_IPV6
)

379 
by‹
 = (
ma
->
v6
.
addr
) - 1;

380 
b™s_to_ş—r
 = 128 - 
ma
->
Ãtb™s
;

382 
by‹
 >ğ0 && 
b™s_to_ş—r
 > 0)

384 ià(
b™s_to_ş—r
 >= 8)

386 
ma
->
v6
.
addr
.
s6_addr
[
by‹
--] = 0;

387 
b™s_to_ş—r
 -= 8;

391 
ma
->
v6
.
addr
.
s6_addr
[
by‹
--] &ğ(
IPV4_NETMASK_HOST
 << 
b™s_to_ş—r
);

392 
b™s_to_ş—r
 = 0;

395 
	`ASSERT
Ğ
b™s_to_ş—r
 == 0 );

399 
	`ASSERT
(0);

401 
	}
}

408 
ušt32_t


409 
	$mrou‹_addr_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

411  
	`hash_func
(
	`mrou‹_addr_hash_±r
((cÚ¡ 
mrou‹_addr
 *è
key
),

412 
	`mrou‹_addr_hash_Ën
((cÚ¡ 
mrou‹_addr
 *è
key
),

413 
iv
);

414 
	}
}

416 
boŞ


417 
	$mrou‹_addr_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

419  
	`mrou‹_addr_equ®
((cÚ¡ 
mrou‹_addr
 *è
key1
,

420 (cÚ¡ 
mrou‹_addr
 *è
key2
);

421 
	}
}

424 
	$mrou‹_addr_´št
(cÚ¡ 
mrou‹_addr
 *
ma
,

425 
gc_¬’a
 *
gc
)

427  
	`mrou‹_addr_´št_ex
(
ma
, 
MAPF_IA_EMPTY_IF_UNDEF
, 
gc
);

428 
	}
}

431 
	$mrou‹_addr_´št_ex
(cÚ¡ 
mrou‹_addr
 *
ma
,

432 cÚ¡ 
æags
,

433 
gc_¬’a
 *
gc
)

435 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

436 ià(
ma
)

438 
mrou‹_addr
 
maddr
 = *
ma
;

440 
maddr
.
ty³
 & 
MR_ADDR_MASK
)

442 
MR_ADDR_ETHER
:

443 
	`buf_´štf
(&
out
, "%s", 
	`fÜm©_hex_ex
(
ma
->
‘h_addr
,

444 (
ma
->
‘h_addr
), 0, 1, ":", 
gc
));

447 
MR_ADDR_IPV4
:

449 ià((
æags
 & 
MAPF_SHOW_ARP
è&& (
maddr
.
ty³
 & 
MR_ARP
))

451 
	`buf_´štf
(&
out
, "ARP/");

453 
	`buf_´štf
(&
out
, "%s", 
	`´št_š_addr_t
(
	`Áohl
(
maddr
.
v4
.
addr
),

454 (
æags
 & 
MAPF_IA_EMPTY_IF_UNDEF
è? 
IA_EMPTY_IF_UNDEF
 : 0, 
gc
));

455 ià(
maddr
.
ty³
 & 
MR_WITH_NETBITS
)

457 ià(
æags
 & 
MAPF_SUBNET
)

459 cÚ¡ 
š_addr_t
 
Ãtmask
 = 
	`Ãtb™s_to_Ãtmask
(
maddr
.
Ãtb™s
);

460 
	`buf_´štf
(&
out
, "/%s", 
	`´št_š_addr_t
(
Ãtmask
, 0, 
gc
));

464 
	`buf_´štf
(&
out
, "/%d", 
maddr
.
Ãtb™s
);

467 ià(
maddr
.
ty³
 & 
MR_WITH_PORT
)

469 
	`buf_´štf
(&
out
, ":%d", 
	`Áohs
(
maddr
.
v4
.
pÜt
));

474 
MR_ADDR_IPV6
:

476 ià(
	`IN6_IS_ADDR_V4MAPPED
Ğ&
maddr
.
v6
.
addr
 ) )

478 
	`buf_´štf
(&
out
, "%s", 
	`´št_š_addr_t
(
maddr
.
v4m­³dv6
.
addr
,

479 
IA_NET_ORDER
, 
gc
));

483 ià(
maddr
.
ty³
 & 
MR_WITH_PORT
)

485 
	`buf_´štf
(&
out
, ":%d", 
	`Áohs
(
maddr
.
v6
.
pÜt
));

490 
	`buf_´štf
(&
out
, "%s", 
	`´št_š6_addr
(
maddr
.
v6
.
addr
, 0, 
gc
));

492 ià(
maddr
.
ty³
 & 
MR_WITH_NETBITS
)

494 
	`buf_´štf
(&
out
, "/%d", 
maddr
.
Ãtb™s
);

500 
	`buf_´štf
(&
out
, "UNKNOWN");

503  
	`BSTR
(&
out
);

509 
	}
}

517 
mrou‹_h–³r
 *

518 
	$mrou‹_h–³r_š™
(
ag—bË_‰l_£cs
)

520 
mrou‹_h–³r
 *
mh
;

521 
	`ALLOC_OBJ_CLEAR
(
mh
, 
mrou‹_h–³r
);

522 
mh
->
ag—bË_‰l_£cs
 =‡geable_ttl_secs;

523  
mh
;

524 
	}
}

527 
	$mrou‹_h–³r_»g’”©e
(
mrou‹_h–³r
 *
mh
)

529 
i
, 
j
 = 0;

530 
i
 = 
MR_HELPER_NET_LEN
 - 1; i >= 0; --i)

532 ià(
mh
->
Ãt_Ën_»fcouÁ
[
i
] > 0)

534 
mh
->
Ãt_Ën
[
j
++] = (
ušt8_t
è
i
;

537 
mh
->
n_Ãt_Ën
 = 
j
;

539 #ifdeà
ENABLE_DEBUG


540 ià(
	`check_debug_Ëv–
(
D_MULTI_DEBUG
))

542 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

543 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

544 
	`buf_´štf
(&
out
, "MROUTE CIDR‚etlen:");

545 
i
 = 0; i < 
mh
->
n_Ãt_Ën
; ++i)

547 
	`buf_´štf
(&
out
, " /%d", 
mh
->
Ãt_Ën
[
i
]);

549 
	`dmsg
(
D_MULTI_DEBUG
, "%s", 
	`BSTR
(&
out
));

550 
	`gc_ä“
(&
gc
);

553 
	}
}

556 
	$mrou‹_h–³r_add_œou‹46
(
mrou‹_h–³r
 *
mh
, 
Ãtb™s
)

558 ià(
Ãtb™s
 >= 0)

560 
	`ASSERT
(
Ãtb™s
 < 
MR_HELPER_NET_LEN
);

561 ++
mh
->
ÿche_g’”©iÚ
;

562 ++
mh
->
Ãt_Ën_»fcouÁ
[
Ãtb™s
];

563 ià(
mh
->
Ãt_Ën_»fcouÁ
[
Ãtb™s
] == 1)

565 
	`mrou‹_h–³r_»g’”©e
(
mh
);

568 
	}
}

571 
	$mrou‹_h–³r_d–_œou‹46
(
mrou‹_h–³r
 *
mh
, 
Ãtb™s
)

573 ià(
Ãtb™s
 >= 0)

575 
	`ASSERT
(
Ãtb™s
 < 
MR_HELPER_NET_LEN
);

576 ++
mh
->
ÿche_g’”©iÚ
;

577 --
mh
->
Ãt_Ën_»fcouÁ
[
Ãtb™s
];

578 
	`ASSERT
(
mh
->
Ãt_Ën_»fcouÁ
[
Ãtb™s
] >= 0);

579 ià(!
mh
->
Ãt_Ën_»fcouÁ
[
Ãtb™s
])

581 
	`mrou‹_h–³r_»g’”©e
(
mh
);

584 
	}
}

587 
	$mrou‹_h–³r_ä“
(
mrou‹_h–³r
 *
mh
)

589 
	`ä“
(
mh
);

590 
	}
}

594 
	$dummy
()

596 
	}
}

	@mroute.h

24 #iâdeà
MROUTE_H


25 
	#MROUTE_H


	)

27 #ià
P2MP_SERVER


29 
	~"bufãr.h
"

30 
	~"li¡.h
"

31 
	~"rou‹.h
"

33 
	~<¡ddef.h
>

35 
	#IP_MCAST_SUBNET_MASK
 ((
š_addr_t
)240<<24)

	)

36 
	#IP_MCAST_NETWORK
 ((
š_addr_t
)224<<24)

	)

40 
	#MROUTE_EXTRACT_SUCCEEDED
 (1<<0)

	)

41 
	#MROUTE_EXTRACT_BCAST
 (1<<1)

	)

42 
	#MROUTE_EXTRACT_MCAST
 (1<<2)

	)

43 
	#MROUTE_EXTRACT_IGMP
 (1<<3)

	)

45 
	#MROUTE_SEC_EXTRACT_SUCCEEDED
 (1<<(0+
MROUTE_SEC_SHIFT
))

	)

46 
	#MROUTE_SEC_EXTRACT_BCAST
 (1<<(1+
MROUTE_SEC_SHIFT
))

	)

47 
	#MROUTE_SEC_EXTRACT_MCAST
 (1<<(2+
MROUTE_SEC_SHIFT
))

	)

48 
	#MROUTE_SEC_EXTRACT_IGMP
 (1<<(3+
MROUTE_SEC_SHIFT
))

	)

50 
	#MROUTE_SEC_SHIFT
 4

	)

57 
	#MR_MAX_ADDR_LEN
 20

	)

62 
	#MR_ADDR_NONE
 0

	)

63 
	#MR_ADDR_ETHER
 1

	)

64 
	#MR_ADDR_IPV4
 2

	)

65 
	#MR_ADDR_IPV6
 3

	)

66 
	#MR_ADDR_MASK
 3

	)

69 
	#MR_WITH_PORT
 4

	)

72 
	#MR_WITH_NETBITS
 8

	)

75 
	#MR_ARP
 16

	)

77 
	smrou‹_addr
 {

78 
ušt8_t
 
	mËn
;

79 
ušt8_t
 
	munu£d
;

80 
ušt8_t
 
	mty³
;

81 
ušt8_t
 
	mÃtb™s
;

84 
ušt8_t
 
	m¿w_addr
[
MR_MAX_ADDR_LEN
];

85 
ušt8_t
 
	m‘h_addr
[
OPENVPN_ETH_ALEN
];

87 
š_addr_t
 
	maddr
;

88 
š_pÜt_t
 
	mpÜt
;

89 } 
	mv4
;

91 
š6_addr
 
	maddr
;

92 
š_pÜt_t
 
	mpÜt
;

93 } 
	mv6
;

95 
ušt8_t
 
	m´efix
[12];

96 
š_addr_t
 
	maddr
;

97 } 
	mv4m­³dv6
;

99 #iâdeà
HAVE_ANONYMOUS_UNION_SUPPORT


101 
	mmrou‹_uniÚ


102 
	#¿w_addr
 
mrou‹_uniÚ
.
¿w_addr


	)

103 
	#‘h_addr
 
mrou‹_uniÚ
.
‘h_addr


	)

104 
	#v4
 
mrou‹_uniÚ
.
v4


	)

105 
	#v6
 
mrou‹_uniÚ
.
v6


	)

106 
	#v4m­³dv6
 
mrou‹_uniÚ
.
v4m­³dv6


	)

112 
¡©ic_as£¹
(
off£tof
(
mrou‹_addr
, 
v4
.
pÜt
) ==

113 
off£tof
(
mrou‹_addr
, 
v4
) + 4,

115 
¡©ic_as£¹
(
off£tof
(
mrou‹_addr
, 
v6
.
pÜt
) ==

116 
off£tof
(
mrou‹_addr
, 
v6
) + 16,

118 
¡©ic_as£¹
(
off£tof
(
mrou‹_addr
, 
v4m­³dv6
.
addr
) ==

119 
off£tof
(
mrou‹_addr
, 
v4m­³dv6
) + 12,

125 
	#MR_HELPER_NET_LEN
 129

	)

130 
	smrou‹_h–³r
 {

131 
	mÿche_g’”©iÚ
;

132 
	mag—bË_‰l_£cs
;

133 
	mn_Ãt_Ën
;

134 
ušt8_t
 
	mÃt_Ën
[
MR_HELPER_NET_LEN
];

135 
	mÃt_Ën_»fcouÁ
[
MR_HELPER_NET_LEN
];

138 
	gİ’v²_sockaddr
;

140 
boŞ
 
mrou‹_exŒaù_İ’v²_sockaddr
(
mrou‹_addr
 *
addr
,

141 cÚ¡ 
İ’v²_sockaddr
 *
o§ddr
,

142 
boŞ
 
u£_pÜt
);

144 
boŞ
 
mrou‹_Ë¬ÇbË_add»ss
(cÚ¡ 
mrou‹_addr
 *
addr
,

145 
gc_¬’a
 *
gc
);

147 
ušt32_t
 
mrou‹_addr_hash_funùiÚ
(cÚ¡ *
key
, ušt32_ˆ
iv
);

149 
boŞ
 
mrou‹_addr_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
);

151 
mrou‹_addr_š™
(
mrou‹_addr
 *
addr
);

153 cÚ¡ *
mrou‹_addr_´št
(cÚ¡ 
mrou‹_addr
 *
ma
,

154 
gc_¬’a
 *
gc
);

156 
	#MAPF_SUBNET
 (1<<0)

	)

157 
	#MAPF_IA_EMPTY_IF_UNDEF
 (1<<1)

	)

158 
	#MAPF_SHOW_ARP
 (1<<2)

	)

159 cÚ¡ *
mrou‹_addr_´št_ex
(cÚ¡ 
mrou‹_addr
 *
ma
,

160 cÚ¡ 
æags
,

161 
gc_¬’a
 *
gc
);

163 
mrou‹_addr_mask_ho¡_b™s
(
mrou‹_addr
 *
ma
);

165 
mrou‹_h–³r
 *
mrou‹_h–³r_š™
(
ag—bË_‰l_£cs
);

167 
mrou‹_h–³r_ä“
(
mrou‹_h–³r
 *
mh
);

169 
mrou‹_h–³r_add_œou‹46
(
mrou‹_h–³r
 *
mh
, 
Ãtb™s
);

171 
mrou‹_h–³r_d–_œou‹46
(
mrou‹_h–³r
 *
mh
, 
Ãtb™s
);

177 
šlše
 

178 
	$mrou‹_exŒaù_addr_äom_·ck‘
(
mrou‹_addr
 *
¤c
,

179 
mrou‹_addr
 *
de¡
,

180 
mrou‹_addr
 *
e¤c
,

181 
mrou‹_addr
 *
ede¡
,

182 cÚ¡ 
bufãr
 *
buf
,

183 
tuÂ–_ty³
)

185 
	`mrou‹_exŒaù_addr_
(
mrou‹_addr
 *
¤c
,

186 
mrou‹_addr
 *
de¡
,

187 cÚ¡ 
bufãr
 *
buf
);

189 
	`mrou‹_exŒaù_addr_‘h”
(
mrou‹_addr
 *
¤c
,

190 
mrou‹_addr
 *
de¡
,

191 
mrou‹_addr
 *
e¤c
,

192 
mrou‹_addr
 *
ede¡
,

193 cÚ¡ 
bufãr
 *
buf
);

195 
»t
 = 0;

196 
	`v”ify_®ign_4
(
buf
);

197 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TUN
)

199 
»t
 = 
	`mrou‹_exŒaù_addr_
(
¤c
, 
de¡
, 
buf
);

201 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TAP
)

203 
»t
 = 
	`mrou‹_exŒaù_addr_‘h”
(
¤c
, 
de¡
, 
e¤c
, 
ede¡
, 
buf
);

205  
»t
;

206 
	}
}

208 
šlše
 
boŞ


209 
	$mrou‹_addr_equ®
(cÚ¡ 
mrou‹_addr
 *
a1
, cÚ¡ mrou‹_add¸*
a2
)

211 ià(
a1
->
ty³
 !ğ
a2
->type)

213  
çl£
;

215 ià(
a1
->
Ãtb™s
 !ğ
a2
->netbits)

217  
çl£
;

219 ià(
a1
->
Ën
 !ğ
a2
->len)

221  
çl£
;

223  
	`memcmp
(
a1
->
¿w_addr
, 
a2
->¿w_addr,‡1->
Ën
) == 0;

224 
	}
}

226 
šlše
 cÚ¡ 
ušt8_t
 *

227 
	$mrou‹_addr_hash_±r
(cÚ¡ 
mrou‹_addr
 *
a
)

230  (
ušt8_t
 *è&
a
->
ty³
;

231 
	}
}

233 
šlše
 
ušt32_t


234 
	$mrou‹_addr_hash_Ën
(cÚ¡ 
mrou‹_addr
 *
a
)

236  (
ušt32_t
è
a
->
Ën
 + 2;

237 
	}
}

239 
šlše
 

240 
	$mrou‹_exŒaù_š_addr_t
(
mrou‹_addr
 *
de¡
, cÚ¡ 
š_addr_t
 
¤c
)

242 
de¡
->
ty³
 = 
MR_ADDR_IPV4
;

243 
de¡
->
Ãtb™s
 = 0;

244 
de¡
->
Ën
 = 4;

245 
de¡
->
v4
.
addr
 = 
	`htÚl
(
¤c
);

246 
	}
}

248 
šlše
 
š_addr_t


249 
	$š_addr_t_äom_mrou‹_addr
(cÚ¡ 
mrou‹_addr
 *
addr
)

251 ià((
addr
->
ty³
 & 
MR_ADDR_MASK
è=ğ
MR_ADDR_IPV4
 &&‡ddr->
Ãtb™s
 =ğ0 &&‡ddr->
Ën
 == 4)

253  
	`Áohl
(
addr
->
v4
.addr);

259 
	}
}

261 
šlše
 

262 
	$mrou‹_addr_»£t
(
mrou‹_addr
 *
ma
)

264 
ma
->
Ën
 = 0;

265 
ma
->
ty³
 = 
MR_ADDR_NONE
;

266 
	}
}

	@mss.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

31 
	~"”rÜ.h
"

32 
	~"mss.h
"

33 
	~"memdbg.h
"

46 
	$mss_fixup_v4
(
bufãr
 *
buf
, 
maxmss
)

48 cÚ¡ 
İ’v²_hdr
 *
p
;

49 
hËn
;

51 ià(
	`BLEN
(
buf
è< (è(
İ’v²_hdr
))

56 
	`v”ify_®ign_4
(
buf
);

57 
p
 = (
İ’v²_hdr
 *è
	`BPTR
(
buf
);

59 
hËn
 = 
	`OPENVPN_IPH_GET_LEN
(
p
->
v”siÚ_Ën
);

61 ià(
p
->
´ÙocŞ
 =ğ
OPENVPN_IPPROTO_TCP


62 && 
	`Áohs
(
p
->
tÙ_Ën
è=ğ
	`BLEN
(
buf
)

63 && (
	`Áohs
(
p
->
äag_off
è& 
OPENVPN_IP_OFFMASK
) == 0

64 && 
hËn
 <ğ
	`BLEN
(
buf
)

65 && 
	`BLEN
(
buf
è- 
hËn


66 >ğ(è(
İ’v²_tıhdr
))

68 
bufãr
 
Ãwbuf
 = *
buf
;

69 ià(
	`buf_advªû
(&
Ãwbuf
, 
hËn
))

71 
İ’v²_tıhdr
 *
tc
 = (İ’v²_tıhd¸*è
	`BPTR
(&
Ãwbuf
);

72 ià(
tc
->
æags
 & 
OPENVPN_TCPH_SYN_MASK
)

74 
	`mss_fixup_dowÜk
(&
Ãwbuf
, (
ušt16_t
è
maxmss
);

78 
	}
}

86 
	$mss_fixup_v6
(
bufãr
 *
buf
, 
maxmss
)

88 cÚ¡ 
İ’v²_v6hdr
 *
p6
;

89 
bufãr
 
Ãwbuf
;

91 ià(
	`BLEN
(
buf
è< (è(
İ’v²_v6hdr
))

96 
	`v”ify_®ign_4
(
buf
);

97 
p6
 = (
İ’v²_v6hdr
 *è
	`BPTR
(
buf
);

102 ià(
	`BLEN
(
buf
è!ğ(è
	`Áohs
(
p6
->
·ylßd_Ën
)+40)

117 ià(
p6
->
Ãxthdr
 !ğ
OPENVPN_IPPROTO_TCP
)

125 
Ãwbuf
 = *
buf
;

126 ià(
	`buf_advªû
Ğ&
Ãwbuf
, 40 )

127 && 
	`BLEN
(&
Ãwbuf
è>ğ(è(
İ’v²_tıhdr
))

129 
İ’v²_tıhdr
 *
tc
 = (İ’v²_tıhd¸*è
	`BPTR
(&
Ãwbuf
);

130 ià(
tc
->
æags
 & 
OPENVPN_TCPH_SYN_MASK
)

132 
	`mss_fixup_dowÜk
(&
Ãwbuf
, (
ušt16_t
è
maxmss
-20);

135 
	}
}

143 
	$mss_fixup_dowÜk
(
bufãr
 *
buf
, 
ušt16_t
 
maxmss
)

145 
hËn
, 
Ş’
, 
İ’
;

146 
ušt8_t
 *
İt
;

147 
ušt16_t
 
mssv®
;

148 
accumuÏ‹
;

149 
İ’v²_tıhdr
 *
tc
;

151 ià(
	`BLEN
(
buf
è< (è(
İ’v²_tıhdr
))

156 
	`v”ify_®ign_4
(
buf
);

157 
tc
 = (
İ’v²_tıhdr
 *è
	`BPTR
(
buf
);

158 
hËn
 = 
	`OPENVPN_TCPH_GET_DOFF
(
tc
->
doff_»s
);

161 ià(
hËn
 <ğ(è(
İ’v²_tıhdr
)

162 || 
hËn
 > 
	`BLEN
(
buf
))

167 
Ş’
 = 
hËn
 - (
İ’v²_tıhdr
),

168 
İt
 = (
ušt8_t
 *)(
tc
 + 1);

169 
Ş’
 > 1;

170 
Ş’
 -ğ
İ’
, 
İt
 += optlen)

172 ià(*
İt
 =ğ
OPENVPN_TCPOPT_EOL
)

176 ià(*
İt
 =ğ
OPENVPN_TCPOPT_NOP
)

178 
İ’
 = 1;

182 
İ’
 = *(
İt
 + 1);

183 ià(
İ’
 <ğ0 || o±ËÀ> 
Ş’
)

187 ià(*
İt
 =ğ
OPENVPN_TCPOPT_MAXSEG
)

189 ià(
İ’
 !ğ
OPENVPN_TCPOLEN_MAXSEG
)

193 
mssv®
 = (
İt
[2]<<8)+opt[3];

194 ià(
mssv®
 > 
maxmss
)

196 
	`dmsg
(
D_MSS
, "MSS: %d -> %d", (è
mssv®
, (è
maxmss
);

197 
accumuÏ‹
 = 
	`htÚs
(
mssv®
);

198 
İt
[2] = (
maxmss
>>8)&0xff;

199 
İt
[3] = 
maxmss
&0xff;

200 
accumuÏ‹
 -ğ
	`htÚs
(
maxmss
);

201 
	`ADJUST_CHECKSUM
(
accumuÏ‹
, 
tc
->
check
);

206 
	}
}

	@mss.h

24 #iâdeà
MSS_H


25 
	#MSS_H


	)

27 
	~"´Ùo.h
"

28 
	~"”rÜ.h
"

30 
mss_fixup_v4
(
bufãr
 *
buf
, 
maxmss
);

32 
mss_fixup_v6
(
bufãr
 *
buf
, 
maxmss
);

34 
mss_fixup_dowÜk
(
bufãr
 *
buf
, 
ušt16_t
 
maxmss
);

	@mstats.c

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

30 #–ià
defšed
(
_MSC_VER
)

31 
	~"cÚfig-msvc.h
"

34 
	~"sysh—d.h
"

36 #ià
defšed
(
ENABLE_MEMSTATS
)

38 
	~<sys/mmª.h
>

40 
	~"”rÜ.h
"

41 
	~"misc.h
"

42 
	~"m¡©s.h
"

44 
	~"memdbg.h
"

46 vŞ©
mm­_¡©s
 *
	gmm­_¡©s
 = 
NULL
;

47 
	gmm­_â
[128];

50 
	$m¡©s_İ’
(cÚ¡ *
â
)

52 *
d©a
;

53 
ssize_t
 
¡©
;

54 
fd
;

55 
mm­_¡©s
 
ms
;

57 ià(
mm­_¡©s
)

63 ià(
	`¡¾’
(
â
è>ğ(
mm­_â
))

65 
	`msg
(
M_FATAL
, "mstats_open: filenameoo†ong");

69 
fd
 = 
	`İ’
(
â
, 
O_CREAT
 | 
O_TRUNC
 | 
O_RDWR
, 
S_IRUSR
 | 
S_IWUSR
);

70 ià(
fd
 < 0)

72 
	`msg
(
M_ERR
, "m¡©s_İ’: cªnÙ o³n: %s", 
â
);

78 
	`CLEAR
(
ms
);

79 
ms
.
¡©e
 = 
MSTATS_ACTIVE
;

80 
¡©
 = 
	`wr™e
(
fd
, &
ms
, (ms));

81 ià(
¡©
 !ğ(
ms
))

83 
	`msg
(
M_ERR
, "m¡©s_İ’: wr™”rÜ: %s", 
â
);

84 
	`şo£
(
fd
);

89 
d©a
 = 
	`mm­
(
NULL
, (
mm­_¡©s
), 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
fd
, 0);

90 ià(
d©a
 =ğ
MAP_FAILED
)

92 
	`msg
(
M_ERR
, "m¡©s_İ’: wr™”rÜ: %s", 
â
);

93 
	`şo£
(
fd
);

98 ià(
	`şo£
(
fd
))

100 
	`msg
(
M_ERR
, "m¡©s_İ’: clo£ƒ¼Ü: %s", 
â
);

104 
	`¡rıy
(
mm­_â
, 
â
);

107 
mm­_¡©s
 = (mm­_¡© *)
d©a
;

109 
	`msg
(
M_INFO
, "mem¡© d©¨wÈbwr™‹ÀtØ%s", 
â
);

110 
	}
}

113 
	$m¡©s_şo£
()

115 ià(
mm­_¡©s
)

117 
mm­_¡©s
->
¡©e
 = 
MSTATS_EXPIRED
;

118 ià(
	`munm­
((*)
mm­_¡©s
, (mmap_stats)))

120 
	`msg
(
M_WARN
 | 
M_ERRNO
, "mstats_close: munmapƒrror");

122 
	`¶©fÜm_uÆšk
(
mm­_â
);

123 
mm­_¡©s
 = 
NULL
;

125 
	}
}

	@mstats.h

28 #ià!
defšed
(
OPENVPN_MEMSTATS_H
è&& defšed(
ENABLE_MEMSTATS
)

29 
	#OPENVPN_MEMSTATS_H


	)

31 
	~"basic.h
"

34 
	smm­_¡©s
 {

35 
couÁ”_ty³
 
	mlšk_»ad_by‹s
;

36 
couÁ”_ty³
 
	mlšk_wr™e_by‹s
;

37 
	mn_ş›Ás
;

39 
	#MSTATS_UNDEF
 0

	)

40 
	#MSTATS_ACTIVE
 1

	)

41 
	#MSTATS_EXPIRED
 2

	)

42 
	m¡©e
;

45 vŞ©
mm­_¡©s
 *mmap_stats;

47 
m¡©s_İ’
(cÚ¡ *
â
);

49 
m¡©s_şo£
();

	@mtcp.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP_SERVER


34 
	~"muÉi.h
"

35 
	~"fÜw¬d-šlše.h
"

37 
	~"memdbg.h
"

39 #ifdeà
HAVE_SYS_INOTIFY_H


40 
	~<sys/šÙify.h
>

46 
	#TA_UNDEF
 0

	)

47 
	#TA_SOCKET_READ
 1

	)

48 
	#TA_SOCKET_READ_RESIDUAL
 2

	)

49 
	#TA_SOCKET_WRITE
 3

	)

50 
	#TA_SOCKET_WRITE_READY
 4

	)

51 
	#TA_SOCKET_WRITE_DEFERRED
 5

	)

52 
	#TA_TUN_READ
 6

	)

53 
	#TA_TUN_WRITE
 7

	)

54 
	#TA_INITIAL
 8

	)

55 
	#TA_TIMEOUT
 9

	)

56 
	#TA_TUN_WRITE_TIMEOUT
 10

	)

61 
	#MTCP_SOCKET
 ((*)1)

	)

62 
	#MTCP_TUN
 ((*)2)

	)

63 
	#MTCP_SIG
 ((*)3è

	)

64 #ifdeà
ENABLE_MANAGEMENT


65 
	#MTCP_MANAGEMENT
 ((*)4)

	)

68 #ifdeà
ENABLE_ASYNC_PUSH


69 
	#MTCP_FILE_CLOSE_WRITE
 ((*)5)

	)

72 
	#MTCP_N
 ((*)16è

	)

74 
	s_iow_æags


76 
	mæags
;

77 
	m»t
;

78 
	mtun
;

79 
	msock
;

83 
	$´aù
(
aùiÚ
)

85 
aùiÚ
)

87 
TA_UNDEF
:

90 
TA_SOCKET_READ
:

93 
TA_SOCKET_READ_RESIDUAL
:

96 
TA_SOCKET_WRITE
:

99 
TA_SOCKET_WRITE_READY
:

102 
TA_SOCKET_WRITE_DEFERRED
:

105 
TA_TUN_READ
:

108 
TA_TUN_WRITE
:

111 
TA_INITIAL
:

114 
TA_TIMEOUT
:

117 
TA_TUN_WRITE_TIMEOUT
:

123 
	}
}

125 
muÉi_š¡ªû
 *

126 
	$muÉi_ü—‹_š¡ªû_tı
(
muÉi_cÚ‹xt
 *
m
)

128 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

129 
muÉi_š¡ªû
 *
mi
 = 
NULL
;

130 
hash
 *hash = 
m
->hash;

132 
mi
 = 
	`muÉi_ü—‹_š¡ªû
(
m
, 
NULL
);

133 ià(
mi
)

135 
hash_–em’t
 *
he
;

136 cÚ¡ 
ušt32_t
 
hv
 = 
	`hash_v®ue
(
hash
, &
mi
->
»®
);

137 
hash_buck‘
 *
buck‘
 = 
	`hash_buck‘
(
hash
, 
hv
);

139 
he
 = 
	`hash_lookup_ç¡
(
hash
, 
buck‘
, &
mi
->
»®
, 
hv
);

141 ià(
he
)

143 
muÉi_š¡ªû
 *
Şdmi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

144 
	`msg
(
D_MULTI_LOW
, "MULTI TCP:‚ew incoming client‡ddress matchesƒxisting client‡ddress --‚ew clientakes…recedence");

145 
Şdmi
->
did_»®_hash
 = 
çl£
;

146 
	`muÉi_şo£_š¡ªû
(
m
, 
Şdmi
, 
çl£
);

147 
he
->
key
 = &
mi
->
»®
;

148 
he
->
v®ue
 = 
mi
;

152 
	`hash_add_ç¡
(
hash
, 
buck‘
, &
mi
->
»®
, 
hv
, mi);

155 
mi
->
did_»®_hash
 = 
Œue
;

158 #ifdeà
ENABLE_DEBUG


159 ià(
mi
)

161 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP: in¡ªû‡dded: %s", 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
));

165 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP:‚ew client instance failed");

169 
	`gc_ä“
(&
gc
);

170 
	`ASSERT
(!(
mi
 && mi->
h®t
));

171  
mi
;

172 
	}
}

174 
boŞ


175 
	$muÉi_tı_š¡ªû_¥ecific_š™
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

178 
mi
->
tı_lšk_out_deã¼ed
 = 
	`mbuf_š™
(
m
->
tİ
.
İtiÚs
.
n_bÿ¡_buf
);

180 
	`ASSERT
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
);

181 
	`ASSERT
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
->
šfo
.
l§
);

182 
	`ASSERT
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
->
mode
 =ğ
LS_MODE_TCP_ACCEPT_FROM
);

183 
	`ASSERT
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 =ğ
AF_INET


184 || 
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 =ğ
AF_INET6


186 ià(!
	`mrou‹_exŒaù_İ’v²_sockaddr
(&
mi
->
»®
, &mi->
cÚ‹xt
.
c2
.
lšk_sock‘
->
šfo
.
l§
->
aùu®
.
de¡
, 
Œue
))

188 
	`msg
(
D_MULTI_ERRORS
, "MULTI TCP: TCP client‡ddress is undefined");

189  
çl£
;

191  
Œue
;

192 
	}
}

195 
	$muÉi_tı_š¡ªû_¥ecific_ä“
(
muÉi_š¡ªû
 *
mi
)

197 
	`mbuf_ä“
(
mi
->
tı_lšk_out_deã¼ed
);

198 
	}
}

200 
muÉi_tı
 *

201 
	$muÉi_tı_š™
(
maxev’ts
, *
maxş›Ás
)

203 
muÉi_tı
 *
mtı
;

204 cÚ¡ 
exŒa_ev’ts
 = 
BASE_N_EVENTS
;

206 
	`ASSERT
(
maxev’ts
 >= 1);

207 
	`ASSERT
(
maxş›Ás
);

209 
	`ALLOC_OBJ_CLEAR
(
mtı
, 
muÉi_tı
);

210 
mtı
->
maxev’ts
 = maxev’t + 
exŒa_ev’ts
;

211 
mtı
->
es
 = 
	`ev’t_£t_š™
(&mtı->
maxev’ts
, 0);

212 
	`wa™_sigÇl
(
mtı
->
es
, 
MTCP_SIG
);

213 
	`ALLOC_ARRAY
(
mtı
->
e¤
, 
ev’t_£t_»tuº
, mtı->
maxev’ts
);

214 *
maxş›Ás
 = 
	`max_št
(
	`mš_št
(
mtı
->
maxev’ts
 - 
exŒa_ev’ts
, *maxclients), 1);

215 
	`msg
(
D_MULTI_LOW
, "MULTI: TCP INIT maxş›Ás=%d maxev’ts=%d", *
maxş›Ás
, 
mtı
->
maxev’ts
);

216  
mtı
;

217 
	}
}

220 
	$muÉi_tı_d–‘e_ev’t
(
muÉi_tı
 *
mtı
, 
ev’t_t
 
ev’t
)

222 ià(
mtı
 && mtı->
es
)

224 
	`ev’t_d–
(
mtı
->
es
, 
ev’t
);

226 
	}
}

229 
	$muÉi_tı_ä“
(
muÉi_tı
 *
mtı
)

231 ià(
mtı
)

233 
	`ev’t_ä“
(
mtı
->
es
);

234 ià(
mtı
->
e¤
)

236 
	`ä“
(
mtı
->
e¤
);

238 
	`ä“
(
mtı
);

240 
	}
}

243 
	$muÉi_tı_d”eã»nû_š¡ªû
(
muÉi_tı
 *
mtı
, 
muÉi_š¡ªû
 *
mi
)

245 
lšk_sock‘
 *
ls
 = 
mi
->
cÚ‹xt
.
c2
.link_socket;

246 ià(
ls
 && 
mi
->
sock‘_£t_ÿÎed
)

248 
	`ev’t_d–
(
mtı
->
es
, 
	`sock‘_ev’t_hªdË
(
ls
));

250 
mtı
->
n_e¤
 = 0;

251 
	}
}

253 
šlše
 

254 
	$muÉi_tı_£t_glob®_rw_æags
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

256 ià(
mi
)

258 
mi
->
sock‘_£t_ÿÎed
 = 
Œue
;

259 
	`sock‘_£t
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
,

260 
m
->
mtı
->
es
,

261 
	`mbuf_defšed
(
mi
->
tı_lšk_out_deã¼ed
è? 
EVENT_WRITE
 : 
EVENT_READ
,

262 
mi
,

263 &
mi
->
tı_rwæags
);

265 
	}
}

267 
šlše
 

268 
	$muÉi_tı_wa™
(cÚ¡ 
cÚ‹xt
 *
c
,

269 
muÉi_tı
 *
mtı
)

271 
¡©us
;

272 
	`sock‘_£t_li¡’_³rsi¡’t
(
c
->
c2
.
lšk_sock‘
, 
mtı
->
es
, 
MTCP_SOCKET
);

273 
	`tun_£t
(
c
->
c1
.
tuÁ­
, 
mtı
->
es
, 
EVENT_READ
, 
MTCP_TUN
, &mtı->
tun_rwæags
);

274 #ifdeà
ENABLE_MANAGEMENT


275 ià(
mªagem’t
)

277 
	`mªagem’t_sock‘_£t
(
mªagem’t
, 
mtı
->
es
, 
MTCP_MANAGEMENT
, &mtı->
mªagem’t_³rsi¡_æags
);

281 #ifdeà
ENABLE_ASYNC_PUSH


283 
	`ev’t_ùl
(
mtı
->
es
, 
c
->
c2
.
šÙify_fd
, 
EVENT_READ
, 
MTCP_FILE_CLOSE_WRITE
);

286 
¡©us
 = 
	`ev’t_wa™
(
mtı
->
es
, &
c
->
c2
.
timev®
, mtı->
e¤
, mtı->
maxev’ts
);

287 
	`upd©e_time
();

288 
mtı
->
n_e¤
 = 0;

289 ià(
¡©us
 > 0)

291 
mtı
->
n_e¤
 = 
¡©us
;

293  
¡©us
;

294 
	}
}

296 
šlše
 
cÚ‹xt
 *

297 
	$muÉi_tı_cÚ‹xt
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

299 ià(
mi
)

301  &
mi
->
cÚ‹xt
;

305  &
m
->
tİ
;

307 
	}
}

309 
boŞ


310 
	$muÉi_tı_´oûss_outgošg_lšk_»ady
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
mµ_æags
)

312 
mbuf_™em
 
™em
;

313 
boŞ
 
»t
 = 
Œue
;

314 
	`ASSERT
(
mi
);

317 ià(
	`mbuf_exŒaù_™em
(
mi
->
tı_lšk_out_deã¼ed
, &
™em
))

319 
	`dmsg
(
D_MULTI_TCP
, "MULTI TCP:ransmitting…reviously deferred…acket");

321 
	`ASSERT
(
mi
 =ğ
™em
.
š¡ªû
);

322 
mi
->
cÚ‹xt
.
c2
.
to_lšk
 = 
™em
.
bufãr
->
buf
;

323 
»t
 = 
	`muÉi_´oûss_outgošg_lšk_dowÜk
(
m
, 
mi
, 
mµ_æags
);

324 ià(!
»t
)

326 
mi
 = 
NULL
;

328 
	`mbuf_ä“_buf
(
™em
.
bufãr
);

330  
»t
;

331 
	}
}

333 
boŞ


334 
	$muÉi_tı_´oûss_outgošg_lšk
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 
deãr
, cÚ¡ 
mµ_æags
)

336 
muÉi_š¡ªû
 *
mi
 = 
	`muÉi_´oûss_outgošg_lšk_´e
(
m
);

337 
boŞ
 
»t
 = 
Œue
;

339 ià(
mi
)

341 ià(
deãr
 || 
	`mbuf_defšed
(
mi
->
tı_lšk_out_deã¼ed
))

344 
bufãr
 *
buf
 = &
mi
->
cÚ‹xt
.
c2
.
to_lšk
;

345 ià(
	`BLEN
(
buf
) > 0)

347 
mbuf_bufãr
 *
mb
 = 
	`mbuf_®loc_buf
(
buf
);

348 
mbuf_™em
 
™em
;

350 
	`£t_´efix
(
mi
);

351 
	`dmsg
(
D_MULTI_TCP
, "MULTI TCP: queuing deferred…acket");

352 
™em
.
bufãr
 = 
mb
;

353 
™em
.
š¡ªû
 = 
mi
;

354 
	`mbuf_add_™em
(
mi
->
tı_lšk_out_deã¼ed
, &
™em
);

355 
	`mbuf_ä“_buf
(
mb
);

356 
	`buf_»£t
(
buf
);

357 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

358 ià(!
»t
)

360 
mi
 = 
NULL
;

362 
	`ş—r_´efix
();

367 
»t
 = 
	`muÉi_´oûss_outgošg_lšk_dowÜk
(
m
, 
mi
, 
mµ_æags
);

368 ià(!
»t
)

370 
mi
 = 
NULL
;

374  
»t
;

375 
	}
}

378 
	$muÉi_tı_wa™_l™e
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
aùiÚ
, 
boŞ
 *
tun_šput_³ndšg
)

380 
cÚ‹xt
 *
c
 = 
	`muÉi_tı_cÚ‹xt
(
m
, 
mi
);

381 
lookšg_fÜ
 = 0;

383 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP: muÉi_tı_wa™_l™a=% mi=" 
±r_fÜm©
,

384 
	`´aù
(
aùiÚ
),

385 (
±r_ty³
)
mi
);

387 
	`tv_ş—r
(&
c
->
c2
.
timev®
);

389 
aùiÚ
)

391 
TA_TUN_READ
:

392 
lookšg_fÜ
 = 
TUN_READ
;

393 
tun_šput_³ndšg
 = 
NULL
;

394 
	`io_wa™
(
c
, 
IOW_READ_TUN
);

397 
TA_SOCKET_READ
:

398 
lookšg_fÜ
 = 
SOCKET_READ
;

399 
tun_šput_³ndšg
 = 
NULL
;

400 
	`io_wa™
(
c
, 
IOW_READ_LINK
);

403 
TA_TUN_WRITE
:

404 
lookšg_fÜ
 = 
TUN_WRITE
;

405 
tun_šput_³ndšg
 = 
NULL
;

406 
c
->
c2
.
timev®
.
tv_£c
 = 1;

407 
	`³rf_push
(
PERF_PROC_OUT_TUN_MTCP
);

408 
	`io_wa™
(
c
, 
IOW_TO_TUN
);

409 
	`³rf_pİ
();

412 
TA_SOCKET_WRITE
:

413 
lookšg_fÜ
 = 
SOCKET_WRITE
;

414 
	`io_wa™
(
c
, 
IOW_TO_LINK
|
IOW_READ_TUN_FORCE
);

418 
	`msg
(
M_FATAL
, "MULTI TCP: muÉi_tı_wa™_l™e, unhªdËd‡ùiÚ=%d", 
aùiÚ
);

421 ià(
tun_šput_³ndšg
 && (
c
->
c2
.
ev’t_£t_¡©us
 & 
TUN_READ
))

423 *
tun_šput_³ndšg
 = 
Œue
;

426 ià(
c
->
c2
.
ev’t_£t_¡©us
 & 
lookšg_fÜ
)

428  
aùiÚ
;

432 
aùiÚ
)

435 
TA_SOCKET_WRITE
:

436  
TA_SOCKET_WRITE_DEFERRED
;

439 
TA_TUN_WRITE
:

440  
TA_TUN_WRITE_TIMEOUT
;

443  
TA_UNDEF
;

445 
	}
}

447 
muÉi_š¡ªû
 *

448 
	$muÉi_tı_di¥©ch
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
aùiÚ
)

450 cÚ¡ 
mµ_æags
 = 
MPP_PRE_SELECT
|
MPP_RECORD_TOUCH
;

451 
muÉi_š¡ªû
 *
touched
 = 
mi
;

452 
m
->
mµ_touched
 = &
touched
;

454 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP: muÉi_tı_di¥©ch‡=% mi=" 
±r_fÜm©
,

455 
	`´aù
(
aùiÚ
),

456 (
±r_ty³
)
mi
);

458 
aùiÚ
)

460 
TA_TUN_READ
:

461 
	`»ad_šcomšg_tun
(&
m
->
tİ
);

462 ià(!
	`IS_SIG
(&
m
->
tİ
))

464 
	`muÉi_´oûss_šcomšg_tun
(
m
, 
mµ_æags
);

468 
TA_SOCKET_READ
:

469 
TA_SOCKET_READ_RESIDUAL
:

470 
	`ASSERT
(
mi
);

471 
	`ASSERT
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
);

472 
	`£t_´efix
(
mi
);

473 
	`»ad_šcomšg_lšk
(&
mi
->
cÚ‹xt
);

474 
	`ş—r_´efix
();

475 ià(!
	`IS_SIG
(&
mi
->
cÚ‹xt
))

477 
	`muÉi_´oûss_šcomšg_lšk
(
m
, 
mi
, 
mµ_æags
);

478 ià(!
	`IS_SIG
(&
mi
->
cÚ‹xt
))

480 
	`¡»am_buf_»ad_£tup
(
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
);

485 
TA_TIMEOUT
:

486 
	`muÉi_´oûss_timeout
(
m
, 
mµ_æags
);

489 
TA_TUN_WRITE
:

490 
	`muÉi_´oûss_outgošg_tun
(
m
, 
mµ_æags
);

493 
TA_TUN_WRITE_TIMEOUT
:

494 
	`muÉi_´oûss_drİ_outgošg_tun
(
m
, 
mµ_æags
);

497 
TA_SOCKET_WRITE_READY
:

498 
	`ASSERT
(
mi
);

499 
	`muÉi_tı_´oûss_outgošg_lšk_»ady
(
m
, 
mi
, 
mµ_æags
);

502 
TA_SOCKET_WRITE
:

503 
	`muÉi_tı_´oûss_outgošg_lšk
(
m
, 
çl£
, 
mµ_æags
);

506 
TA_SOCKET_WRITE_DEFERRED
:

507 
	`muÉi_tı_´oûss_outgošg_lšk
(
m
, 
Œue
, 
mµ_æags
);

510 
TA_INITIAL
:

511 
	`ASSERT
(
mi
);

512 
	`muÉi_tı_£t_glob®_rw_æags
(
m
, 
mi
);

513 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

517 
	`msg
(
M_FATAL
, "MULTI TCP: muÉi_tı_di¥©ch, unhªdËd‡ùiÚ=%d", 
aùiÚ
);

520 
m
->
mµ_touched
 = 
NULL
;

521  
touched
;

522 
	}
}

525 
	$muÉi_tı_po¡
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
aùiÚ
)

527 
cÚ‹xt
 *
c
 = 
	`muÉi_tı_cÚ‹xt
(
m
, 
mi
);

528 
ÃwaùiÚ
 = 
TA_UNDEF
;

530 
	#MTP_NONE
 0

	)

531 
	#MTP_TUN_OUT
 (1<<0)

	)

532 
	#MTP_LINK_OUT
 (1<<1)

	)

533 
æags
 = 
MTP_NONE
;

535 ià(
	`TUN_OUT
(
c
))

537 
æags
 |ğ
MTP_TUN_OUT
;

539 ià(
	`LINK_OUT
(
c
))

541 
æags
 |ğ
MTP_LINK_OUT
;

544 
æags
)

546 
MTP_TUN_OUT
|
MTP_LINK_OUT
:

547 
MTP_TUN_OUT
:

548 
ÃwaùiÚ
 = 
TA_TUN_WRITE
;

551 
MTP_LINK_OUT
:

552 
ÃwaùiÚ
 = 
TA_SOCKET_WRITE
;

555 
MTP_NONE
:

556 ià(
mi
 && 
	`sock‘_»ad_»sidu®
(
c
->
c2
.
lšk_sock‘
))

558 
ÃwaùiÚ
 = 
TA_SOCKET_READ_RESIDUAL
;

562 
	`muÉi_tı_£t_glob®_rw_æags
(
m
, 
mi
);

568 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

569 
	`msg
(
M_FATAL
, "MULTI TCP: multi_tcp_post bad state, mi=%s flags=%d",

570 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
),

571 
æags
);

572 
	`gc_ä“
(&
gc
);

577 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP: multi_tcp_post %s -> %s",

578 
	`´aù
(
aùiÚ
),

579 
	`´aù
(
ÃwaùiÚ
));

581  
ÃwaùiÚ
;

582 
	}
}

585 
	$muÉi_tı_aùiÚ
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, 
aùiÚ
, 
boŞ
 
pŞl
)

587 
boŞ
 
tun_šput_³ndšg
 = 
çl£
;

591 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI TCP: multi_tcp_action‡=%s…=%d",

592 
	`´aù
(
aùiÚ
),

593 
pŞl
);

606 ià(
pŞl
 && 
aùiÚ
 !ğ
TA_SOCKET_READ_RESIDUAL
)

608 cÚ¡ 
Üig_aùiÚ
 = 
aùiÚ
;

609 
aùiÚ
 = 
	`muÉi_tı_wa™_l™e
(
m
, 
mi
,‡ùiÚ, &
tun_šput_³ndšg
);

610 ià(
aùiÚ
 =ğ
TA_UNDEF
)

612 
	`msg
(
M_FATAL
, "MULTI TCP: I/O wa™„equœed blockšg iÀmuÉi_tı_aùiÚ,‡ùiÚ=%d", 
Üig_aùiÚ
);

620 
muÉi_š¡ªû
 *
touched
 = 
	`muÉi_tı_di¥©ch
(
m
, 
mi
, 
aùiÚ
);

626 ià(
touched
 && 
	`IS_SIG
(&touched->
cÚ‹xt
))

628 ià(
mi
 =ğ
touched
)

630 
mi
 = 
NULL
;

632 
	`muÉi_şo£_š¡ªû_Ú_sigÇl
(
m
, 
touched
);

641 ià(
m
->
³ndšg
)

643 
mi
 = 
m
->
³ndšg
;

651 
aùiÚ
 = 
	`muÉi_tı_po¡
(
m
, 
mi
,‡ction);

658 ià(
tun_šput_³ndšg
 && 
aùiÚ
 =ğ
TA_UNDEF
)

660 
aùiÚ
 = 
TA_TUN_READ
;

661 
mi
 = 
NULL
;

662 
tun_šput_³ndšg
 = 
çl£
;

663 
pŞl
 = 
çl£
;

667 
pŞl
 = 
Œue
;

670 } 
aùiÚ
 !ğ
TA_UNDEF
);

671 
	}
}

674 
	$muÉi_tı_´oûss_io
(
muÉi_cÚ‹xt
 *
m
)

676 
muÉi_tı
 *
mtı
 = 
m
->mtcp;

677 
i
;

679 
i
 = 0; i < 
mtı
->
n_e¤
; ++i)

681 
ev’t_£t_»tuº
 *
e
 = &
mtı
->
e¤
[
i
];

684 ià(
e
->
¬g
 >ğ
MTCP_N
)

686 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
e
->
¬g
;

687 ià(
mi
)

689 ià(
e
->
rwæags
 & 
EVENT_WRITE
)

691 
	`muÉi_tı_aùiÚ
(
m
, 
mi
, 
TA_SOCKET_WRITE_READY
, 
çl£
);

693 ià(
e
->
rwæags
 & 
EVENT_READ
)

695 
	`muÉi_tı_aùiÚ
(
m
, 
mi
, 
TA_SOCKET_READ
, 
çl£
);

701 #ifdeà
ENABLE_MANAGEMENT


702 ià(
e
->
¬g
 =ğ
MTCP_MANAGEMENT
)

704 
	`ASSERT
(
mªagem’t
);

705 
	`mªagem’t_io
(
mªagem’t
);

710 ià(
e
->
¬g
 =ğ
MTCP_TUN
)

712 ià(
e
->
rwæags
 & 
EVENT_WRITE
)

714 
	`muÉi_tı_aùiÚ
(
m
, 
NULL
, 
TA_TUN_WRITE
, 
çl£
);

716 ià(
e
->
rwæags
 & 
EVENT_READ
)

718 
	`muÉi_tı_aùiÚ
(
m
, 
NULL
, 
TA_TUN_READ
, 
çl£
);

722 ià(
e
->
¬g
 =ğ
MTCP_SOCKET
)

724 
muÉi_š¡ªû
 *
mi
;

725 
	`ASSERT
(
m
->
tİ
.
c2
.
lšk_sock‘
);

726 
	`sock‘_»£t_li¡’_³rsi¡’t
(
m
->
tİ
.
c2
.
lšk_sock‘
);

727 
mi
 = 
	`muÉi_ü—‹_š¡ªû_tı
(
m
);

728 ià(
mi
)

730 
	`muÉi_tı_aùiÚ
(
m
, 
mi
, 
TA_INITIAL
, 
çl£
);

734 ià(
e
->
¬g
 =ğ
MTCP_SIG
)

736 
	`g‘_sigÇl
(&
m
->
tİ
.
sig
->
sigÇl_»ûived
);

738 #ifdeà
ENABLE_ASYNC_PUSH


739 ià(
e
->
¬g
 =ğ
MTCP_FILE_CLOSE_WRITE
)

741 
	`muÉi_´oûss_fe_şo£d
(
m
, 
MPP_PRE_SELECT
 | 
MPP_RECORD_TOUCH
);

745 ià(
	`IS_SIG
(&
m
->
tİ
))

750 
mtı
->
n_e¤
 = 0;

756 
muÉi_š¡ªû
 *
mi
;

757 !
	`IS_SIG
(&
m
->
tİ
è&& (
mi
 = 
	`mbuf_³ek
(m->
mbuf
)è!ğ
NULL
)

759 
	`muÉi_tı_aùiÚ
(
m
, 
mi
, 
TA_SOCKET_WRITE
, 
Œue
);

762 
	}
}

769 
	$tuÂ–_£rv”_tı
(
cÚ‹xt
 *
tİ
)

771 
muÉi_cÚ‹xt
 
muÉi
;

772 
¡©us
;

774 
tİ
->
mode
 = 
CM_TOP
;

775 
	`cÚ‹xt_ş—r_2
(
tİ
);

778 
	`š™_š¡ªû_hªdË_sigÇls
(
tİ
,İ->
es
, 
CC_HARD_USR1_TO_HUP
);

779 ià(
	`IS_SIG
(
tİ
))

785 
	`muÉi_š™
(&
muÉi
, 
tİ
, 
Œue
, 
MC_SINGLE_THREADED
);

788 
	`muÉi_tİ_š™
(&
muÉi
, 
tİ
);

791 
	`š™_mªagem’t_ÿÎback_muÉi
(&
muÉi
);

794 
	`š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
tİ
, 
ISC_SERVER
);

796 #ifdeà
ENABLE_ASYNC_PUSH


797 
muÉi
.
tİ
.
c2
.
šÙify_fd
 = 
	`šÙify_š™
();

798 ià(
muÉi
.
tİ
.
c2
.
šÙify_fd
 < 0)

800 
	`msg
(
D_MULTI_ERRORS
 | 
M_ERRNO
, "MULTI: inotify_initƒrror");

805 
Œue
)

807 
	`³rf_push
(
PERF_EVENT_LOOP
);

810 
	`muÉi_g‘_timeout
(&
muÉi
, &muÉi.
tİ
.
c2
.
timev®
);

811 
¡©us
 = 
	`muÉi_tı_wa™
(&
muÉi
.
tİ
, muÉi.
mtı
);

812 
	`MULTI_CHECK_SIG
(&
muÉi
);

815 
	`muÉi_´oûss_³r_£cÚd_tim”s
(&
muÉi
);

818 ià(
¡©us
 > 0)

821 
	`muÉi_tı_´oûss_io
(&
muÉi
);

822 
	`MULTI_CHECK_SIG
(&
muÉi
);

824 ià(
¡©us
 == 0)

826 
	`muÉi_tı_aùiÚ
(&
muÉi
, 
NULL
, 
TA_TIMEOUT
, 
çl£
);

829 
	`³rf_pİ
();

832 #ifdeà
ENABLE_ASYNC_PUSH


833 
	`şo£
(
tİ
->
c2
.
šÙify_fd
);

837 
	`unš™_mªagem’t_ÿÎback_muÉi
(&
muÉi
);

840 
	`muÉi_ifcÚfig_poŞ_³rsi¡
(&
muÉi
, 
Œue
);

843 
	`muÉi_unš™
(&
muÉi
);

844 
	`muÉi_tİ_ä“
(&
muÉi
);

845 
	`şo£_š¡ªû
(
tİ
);

846 
	}
}

	@mtcp.h

28 #iâdeà
MTCP_H


29 
	#MTCP_H


	)

31 #ià
P2MP_SERVER


33 
	~"ev’t.h
"

38 
	smuÉi_tı


40 
ev’t_£t
 *
	mes
;

41 
ev’t_£t_»tuº
 *
	me¤
;

42 
	mn_e¤
;

43 
	mmaxev’ts
;

44 
	mtun_rwæags
;

45 #ifdeà
ENABLE_MANAGEMENT


46 
	mmªagem’t_³rsi¡_æags
;

50 
	gmuÉi_š¡ªû
;

51 
	gcÚ‹xt
;

53 
muÉi_tı
 *
muÉi_tı_š™
(
maxev’ts
, *
maxş›Ás
);

55 
muÉi_tı_ä“
(
muÉi_tı
 *
mtı
);

57 
muÉi_tı_d”eã»nû_š¡ªû
(
muÉi_tı
 *
mtı
, 
muÉi_š¡ªû
 *
mi
);

59 
boŞ
 
muÉi_tı_š¡ªû_¥ecific_š™
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
);

61 
muÉi_tı_š¡ªû_¥ecific_ä“
(
muÉi_š¡ªû
 *
mi
);

63 
muÉi_tı_lšk_out_deã¼ed
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
);

73 
tuÂ–_£rv”_tı
(
cÚ‹xt
 *
tİ
);

76 
muÉi_tı_d–‘e_ev’t
(
muÉi_tı
 *
mtı
, 
ev’t_t
 
ev’t
);

	@mtu.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"commÚ.h
"

33 
	~"bufãr.h
"

34 
	~"”rÜ.h
"

35 
	~"š‹g”.h
"

36 
	~"mtu.h
"

37 
	~"İtiÚs.h
"

39 
	~"memdbg.h
"

43 
	$®loc_buf_sock_tun
(
bufãr
 *
buf
,

44 cÚ¡ 
äame
 *frame,

45 cÚ¡ 
boŞ
 
tuÁ­_bufãr
,

46 cÚ¡ 
®ign_mask
)

49 *
buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(
äame
));

50 
	`ASSERT
(
	`buf_š™
(
buf
, 
	`FRAME_HEADROOM_ADJ
(
äame
, 
®ign_mask
)));

51 
buf
->
Ën
 = 
tuÁ­_bufãr
 ? 
	`MAX_RW_SIZE_TUN
(
äame
è: 
	`MAX_RW_SIZE_LINK
(frame);

52 
	`ASSERT
(
	`buf_§ã
(
buf
, 0));

53 
	}
}

56 
	$äame_fš®ize
(
äame
 *frame,

57 
boŞ
 
lšk_mtu_defšed
,

58 
lšk_mtu
,

59 
boŞ
 
tun_mtu_defšed
,

60 
tun_mtu
)

63 ià(
tun_mtu_defšed
)

65 
	`ASSERT
(!
lšk_mtu_defšed
);

66 
äame
->
lšk_mtu
 = 
tun_mtu
 + 
	`TUN_LINK_DELTA
(frame);

70 
	`ASSERT
(
lšk_mtu_defšed
);

71 
äame
->
lšk_mtu
 =†ink_mtu;

74 ià(
	`TUN_MTU_SIZE
(
äame
è< 
TUN_MTU_MIN
)

76 
	`msg
(
M_WARN
, "TUN MTU v®u(%dèmu¡ b©†—¡ %d", 
	`TUN_MTU_SIZE
(
äame
), 
TUN_MTU_MIN
);

77 
	`äame_´št
(
äame
, 
M_FATAL
, "MTU isoo small");

80 
äame
->
lšk_mtu_dyÇmic
 = f¿me->
lšk_mtu
;

81 
	}
}

87 
	$äame_£t_mtu_dyÇmic
(
äame
 *äame, 
mtu
, 
æags
)

90 #ifdeà
ENABLE_DEBUG


91 cÚ¡ 
Üig_mtu
 = 
mtu
;

92 cÚ¡ 
Üig_lšk_mtu_dyÇmic
 = 
äame
->
lšk_mtu_dyÇmic
;

95 
	`ASSERT
(
mtu
 >= 0);

97 ià(
æags
 & 
SET_MTU_TUN
)

99 
mtu
 +ğ
	`TUN_LINK_DELTA
(
äame
);

102 ià(!(
æags
 & 
SET_MTU_UPPER_BOUND
è|| 
mtu
 < 
äame
->
lšk_mtu_dyÇmic
)

104 
äame
->
lšk_mtu_dyÇmic
 = 
	`cÚ¡¿š_št
(

105 
mtu
,

106 
	`EXPANDED_SIZE_MIN
(
äame
),

107 
	`EXPANDED_SIZE
(
äame
));

110 
	`dmsg
(
D_MTU_DEBUG
, "MTU DYNAMIC mtu=%d, flags=%u, %d -> %d",

111 
Üig_mtu
,

112 
æags
,

113 
Üig_lšk_mtu_dyÇmic
,

114 
äame
->
lšk_mtu_dyÇmic
);

115 
	}
}

123 
	$äame_subŒaù_exŒa
(
äame
 *äame, cÚ¡ äam*
¤c
)

125 
äame
->
exŒa_äame
 -ğ
¤c
->extra_frame;

126 
äame
->
exŒa_tun
 +ğ
¤c
->
exŒa_äame
;

127 
	}
}

130 
	$äame_š™_mssfix
(
äame
 *äame, cÚ¡ 
İtiÚs
 *options)

132 ià(
İtiÚs
->
û
.
mssfix
)

134 
	`äame_£t_mtu_dyÇmic
(
äame
, 
İtiÚs
->
û
.
mssfix
, 
SET_MTU_UPPER_BOUND
);

136 
	}
}

139 
	$äame_´št
(cÚ¡ 
äame
 *frame,

140 
Ëv–
,

141 cÚ¡ *
´efix
)

143 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

144 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

145 ià(
´efix
)

147 
	`buf_´štf
(&
out
, "% ", 
´efix
);

149 
	`buf_´štf
(&
out
, "[");

150 
	`buf_´štf
(&
out
, " L:%d", 
äame
->
lšk_mtu
);

151 
	`buf_´štf
(&
out
, " D:%d", 
äame
->
lšk_mtu_dyÇmic
);

152 
	`buf_´štf
(&
out
, " EF:%d", 
äame
->
exŒa_äame
);

153 
	`buf_´štf
(&
out
, " EB:%d", 
äame
->
exŒa_bufãr
);

154 
	`buf_´štf
(&
out
, " ET:%d", 
äame
->
exŒa_tun
);

155 
	`buf_´štf
(&
out
, " EL:%d", 
äame
->
exŒa_lšk
);

156 ià(
äame
->
®ign_æags
 && f¿me->
®ign_adju¡
)

158 
	`buf_´štf
(&
out
, " AF:%u/%d", 
äame
->
®ign_æags
, f¿me->
®ign_adju¡
);

160 
	`buf_´štf
(&
out
, " ]");

162 
	`msg
(
Ëv–
, "%s", 
out
.
d©a
);

163 
	`gc_ä“
(&
gc
);

164 
	}
}

166 
	#MTUDISC_NOT_SUPPORTED_MSG
 "--mtu-disøi nÙ suµÜ‹d oÀthi OS"

	)

169 
	$£t_mtu_discov”_ty³
(
sd
, 
mtu_ty³
, 
§_çmy_t
 
´Ùo_af
)

171 ià(
mtu_ty³
 >= 0)

173 
´Ùo_af
)

175 #ià
	`defšed
(
HAVE_SETSOCKOPT
è&& defšed(
IP_MTU_DISCOVER
)

176 
AF_INET
:

177 ià(
£tsockİt


178 (
sd
, 
IPPROTO_IP
, 
IP_MTU_DISCOVER
, &
mtu_ty³
, (mtu_type)))

180 
	`msg
(
M_ERR
, "Error setting IP_MTU_DISCOVERype=%d on TCP/UDP socket",

181 
mtu_ty³
);

186 #ià
	`defšed
(
HAVE_SETSOCKOPT
è&& defšed(
IPV6_MTU_DISCOVER
)

187 
AF_INET6
:

188 ià(
£tsockİt


189 (
sd
, 
IPPROTO_IPV6
, 
IPV6_MTU_DISCOVER
, &
mtu_ty³
, (mtu_type)))

191 
	`msg
(
M_ERR
, "Error setting IPV6_MTU_DISCOVERype=%d on TCP6/UDP6 socket",

192 
mtu_ty³
);

198 
	`msg
(
M_FATAL
, 
MTUDISC_NOT_SUPPORTED_MSG
);

202 
	}
}

205 
	$Œª¦©e_mtu_discov”_ty³_Çme
(cÚ¡ *
Çme
)

207 #ià
	`defšed
(
IP_PMTUDISC_DONT
è&& defšed(
IP_PMTUDISC_WANT
è&& defšed(
IP_PMTUDISC_DO
)

208 ià(!
	`¡rcmp
(
Çme
, "yes"))

210  
IP_PMTUDISC_DO
;

212 ià(!
	`¡rcmp
(
Çme
, "maybe"))

214  
IP_PMTUDISC_WANT
;

216 ià(!
	`¡rcmp
(
Çme
, "no"))

218  
IP_PMTUDISC_DONT
;

220 
	`msg
(
M_FATAL
,

222 
Çme
);

224 
	`msg
(
M_FATAL
, 
MTUDISC_NOT_SUPPORTED_MSG
);

227 
	}
}

229 #ià
EXTENDED_SOCKET_ERROR_CAPABILITY


231 
	s´obehdr


233 
ušt32_t
 
	m‰l
;

234 
timev®
 
	mtv
;

238 
	$fÜm©_ex‹nded_sock‘_”rÜ
(
fd
, *
mtu
, 
gc_¬’a
 *
gc
)

240 
»s
;

241 
´obehdr
 
rcvbuf
;

242 
iovec
 
iov
;

243 
msghdr
 
msg
;

244 
cmsghdr
 *
cmsg
;

245 
sock_ex‹nded_”r
 *
e
;

246 
sockaddr_š
 
addr
;

247 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

248 *
cbuf
 = (*è
	`gc_m®loc
(256, 
çl£
, 
gc
);

250 *
mtu
 = 0;

252 
Œue
)

254 
	`mem£t
(&
rcvbuf
, -1, (rcvbuf));

255 
iov
.
iov_ba£
 = &
rcvbuf
;

256 
iov
.
iov_Ën
 = (
rcvbuf
);

257 
msg
.
msg_Çme
 = (
ušt8_t
 *è&
addr
;

258 
msg
.
msg_Çm–’
 = (
addr
);

259 
msg
.
msg_iov
 = &
iov
;

260 
msg
.
msg_iovËn
 = 1;

261 
msg
.
msg_æags
 = 0;

262 
msg
.
msg_cÚŒŞ
 = 
cbuf
;

263 
msg
.
msg_cÚŒŞËn
 = 256;

265 
»s
 = 
	`»cvmsg
(
fd
, &
msg
, 
MSG_ERRQUEUE
);

266 ià(
»s
 < 0)

268 
ex™
;

271 
e
 = 
NULL
;

273 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
); cmsg; cmsg = 
	`CMSG_NXTHDR
(&msg, cmsg))

275 ià(
cmsg
->
cmsg_Ëv–
 =ğ
SOL_IP
)

277 ià(
cmsg
->
cmsg_ty³
 =ğ
IP_RECVERR
)

279 
e
 = (
sock_ex‹nded_”r
 *è
	`CMSG_DATA
(
cmsg
);

283 
	`buf_´štf
(&
out
,"CMSG=%d|", 
cmsg
->
cmsg_ty³
);

287 ià(
e
 =ğ
NULL
)

289 
	`buf_´štf
(&
out
, "NO-INFO|");

290 
ex™
;

293 
e
->
“_”ºo
)

295 
ETIMEDOUT
:

296 
	`buf_´štf
(&
out
, "ETIMEDOUT|");

299 
EMSGSIZE
:

300 
	`buf_´štf
(&
out
, "EMSGSIZE P©h-MTU=%d|", 
e
->
“_šfo
);

301 *
mtu
 = 
e
->
“_šfo
;

304 
ECONNREFUSED
:

305 
	`buf_´štf
(&
out
, "ECONNREFUSED|");

308 
EPROTO
:

309 
	`buf_´štf
(&
out
, "EPROTO|");

312 
EHOSTUNREACH
:

313 
	`buf_´štf
(&
out
, "EHOSTUNREACH|");

316 
ENETUNREACH
:

317 
	`buf_´štf
(&
out
, "ENETUNREACH|");

320 
EACCES
:

321 
	`buf_´štf
(&
out
, "EACCES|");

325 
	`buf_´štf
(&
out
, "UNKNOWN|");

330 
ex™
:

331 
	`buf_rm
(&
out
, '|');

332  
	`BSTR
(&
out
);

333 
	}
}

336 
	$£t_sock_ex‹nded_”rÜ_·ssšg
(
sd
)

338 
Ú
 = 1;

339 ià(
	`£tsockİt
(
sd
, 
SOL_IP
, 
IP_RECVERR
, (*è&
Ú
, (on)))

341 
	`msg
(
M_WARN
 | 
M_ERRNO
,

344 
	}
}

	@mtu.h

24 #iâdeà
MTU_H


25 
	#MTU_H


	)

27 
	~"bufãr.h
"

54 
	#ETHERNET_MTU
 1500

	)

60 
	#TUN_MTU_MIN
 100

	)

65 
	#LINK_MTU_DEFAULT
 1500

	)

70 
	#TUN_MTU_DEFAULT
 1500

	)

75 
	#TAP_MTU_EXTRA_DEFAULT
 32

	)

80 
	#MSSFIX_DEFAULT
 1450

	)

86 
	#PAYLOAD_ALIGN
 4

	)

93 
	säame
 {

94 
	mlšk_mtu
;

97 
	mlšk_mtu_dyÇmic
;

100 
	mexŒa_äame
;

107 
	mexŒa_bufãr
;

117 
	mexŒa_tun
;

122 
	mexŒa_lšk
;

129 
	#FRAME_HEADROOM_MARKER_DECRYPT
 (1<<0)

	)

130 
	#FRAME_HEADROOM_MARKER_FRAGMENT
 (1<<1)

	)

131 
	#FRAME_HEADROOM_MARKER_READ_LINK
 (1<<2)

	)

132 
	#FRAME_HEADROOM_MARKER_READ_STREAM
 (1<<3)

	)

133 
	m®ign_æags
;

134 
	m®ign_adju¡
;

138 
	gİtiÚs
;

145 
	#EXTRA_FRAME
(
f
è((f)->
exŒa_äame
)

	)

151 
	#TUN_LINK_DELTA
(
f
è((f)->
exŒa_äame
 + (f)->
exŒa_tun
)

	)

156 
	#TUN_MTU_SIZE
(
f
è((f)->
lšk_mtu
 - 
	`TUN_LINK_DELTA
(f))

	)

157 
	#TUN_MTU_SIZE_DYNAMIC
(
f
è((f)->
lšk_mtu_dyÇmic
 - 
	`TUN_LINK_DELTA
(f))

	)

165 
	#PAYLOAD_SIZE
(
f
è((f)->
lšk_mtu
 - (f)->
exŒa_äame
)

	)

166 
	#PAYLOAD_SIZE_DYNAMIC
(
f
è((f)->
lšk_mtu_dyÇmic
 - (f)->
exŒa_äame
)

	)

172 
	#EXPANDED_SIZE
(
f
è((f)->
lšk_mtu
)

	)

173 
	#EXPANDED_SIZE_DYNAMIC
(
f
è((f)->
lšk_mtu_dyÇmic
)

	)

174 
	#EXPANDED_SIZE_MIN
(
f
è(
TUN_MTU_MIN
 + 
	`TUN_LINK_DELTA
(f))

	)

180 
	#MAX_RW_SIZE_TUN
(
f
è(
	`PAYLOAD_SIZE
(f))

	)

181 
	#MAX_RW_SIZE_LINK
(
f
è(
	`EXPANDED_SIZE
(fè+ (f)->
exŒa_lšk
)

	)

186 
	#FRAME_HEADROOM_BASE
(
f
è(
	`TUN_LINK_DELTA
(fè+ (f)->
exŒa_bufãr
 + (f)->
exŒa_lšk
)

	)

187 
	#FRAME_HEADROOM
(
f
è
	`äame_h—droom
(f, 0)

	)

188 
	#FRAME_HEADROOM_ADJ
(
f
, 
fm
è
	`äame_h—droom
(f, fm)

	)

194 
	#BUF_SIZE
(
f
è(
	`TUN_MTU_SIZE
(fè+ 
	`FRAME_HEADROOM_BASE
(fè* 2)

	)

200 
äame_fš®ize
(
äame
 *frame,

201 
boŞ
 
lšk_mtu_defšed
,

202 
lšk_mtu
,

203 
boŞ
 
tun_mtu_defšed
,

204 
tun_mtu
);

206 
äame_subŒaù_exŒa
(
äame
 *äame, cÚ¡ äam*
¤c
);

208 
äame_´št
(cÚ¡ 
äame
 *frame,

209 
Ëv–
,

210 cÚ¡ *
´efix
);

212 
£t_mtu_discov”_ty³
(
sd
, 
mtu_ty³
, 
§_çmy_t
 
´Ùo_af
);

214 
Œª¦©e_mtu_discov”_ty³_Çme
(cÚ¡ *
Çme
);

220 
	#SET_MTU_TUN
 (1<<0è

	)

221 
	#SET_MTU_UPPER_BOUND
 (1<<1è

	)

223 
äame_£t_mtu_dyÇmic
(
äame
 *äame, 
mtu
, 
æags
);

228 
®loc_buf_sock_tun
(
bufãr
 *
buf
,

229 cÚ¡ 
äame
 *frame,

230 cÚ¡ 
boŞ
 
tuÁ­_bufãr
,

231 cÚ¡ 
®ign_mask
);

234 
äame_š™_mssfix
(
äame
 *äame, cÚ¡ 
İtiÚs
 *options);

242 #ià
EXTENDED_SOCKET_ERROR_CAPABILITY


244 
£t_sock_ex‹nded_”rÜ_·ssšg
(
sd
);

246 cÚ¡ *
fÜm©_ex‹nded_sock‘_”rÜ
(
fd
, *
mtu
, 
gc_¬’a
 *
gc
);

254 
šlše
 

255 
	$äame_h—droom
(cÚ¡ 
äame
 *
f
, cÚ¡ 
æag_mask
)

257 cÚ¡ 
off£t
 = 
	`FRAME_HEADROOM_BASE
(
f
);

258 cÚ¡ 
adju¡
 = (
æag_mask
 & 
f
->
®ign_æags
è? f->
®ign_adju¡
 : 0;

259 cÚ¡ 
d–
 = ((
PAYLOAD_ALIGN
 << 24è- (
off£t
 + 
adju¡
)) & (PAYLOAD_ALIGN - 1);

260  
off£t
 + 
d–
;

261 
	}
}

267 
šlše
 

268 
	$äame_add_to_lšk_mtu
(
äame
 *äame, cÚ¡ 
šüem’t
)

270 
äame
->
lšk_mtu
 +ğ
šüem’t
;

271 
	}
}

273 
šlše
 

274 
	$äame_add_to_exŒa_äame
(
äame
 *äame, cÚ¡ 
šüem’t
)

276 
äame
->
exŒa_äame
 +ğ
šüem’t
;

277 
	}
}

279 
šlše
 

280 
	$äame_»move_äom_exŒa_äame
(
äame
 *äame, cÚ¡ 
deüem’t
)

282 
äame
->
exŒa_äame
 -ğ
deüem’t
;

283 
	}
}

285 
šlše
 

286 
	$äame_add_to_exŒa_tun
(
äame
 *äame, cÚ¡ 
šüem’t
)

288 
äame
->
exŒa_tun
 +ğ
šüem’t
;

289 
	}
}

291 
šlše
 

292 
	$äame_add_to_exŒa_lšk
(
äame
 *äame, cÚ¡ 
šüem’t
)

294 
äame
->
exŒa_lšk
 +ğ
šüem’t
;

295 
	}
}

297 
šlše
 

298 
	$äame_add_to_exŒa_bufãr
(
äame
 *äame, cÚ¡ 
šüem’t
)

300 
äame
->
exŒa_bufãr
 +ğ
šüem’t
;

301 
	}
}

303 
šlše
 

304 
	$äame_add_to_®ign_adju¡
(
äame
 *äame, cÚ¡ 
šüem’t
)

306 
äame
->
®ign_adju¡
 +ğ
šüem’t
;

307 
	}
}

309 
šlše
 

310 
	$äame_®ign_to_exŒa_äame
(
äame
 *frame)

312 
äame
->
®ign_adju¡
 = f¿me->
exŒa_äame
 + f¿me->
exŒa_lšk
;

313 
	}
}

315 
šlše
 

316 
	$äame_Ü_®ign_æags
(
äame
 *äame, cÚ¡ 
æag_mask
)

318 
äame
->
®ign_æags
 |ğ
æag_mask
;

319 
	}
}

321 
šlše
 
boŞ


322 
	$äame_defšed
(cÚ¡ 
äame
 *frame)

324  
äame
->
lšk_mtu
 > 0;

325 
	}
}

	@mudp.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP_SERVER


34 
	~"muÉi.h
"

35 
	~<š‰y³s.h
>

36 
	~"fÜw¬d-šlše.h
"

38 
	~"memdbg.h
"

40 #ifdeà
HAVE_SYS_INOTIFY_H


41 
	~<sys/šÙify.h
>

50 
muÉi_š¡ªû
 *

51 
	$muÉi_g‘_ü—‹_š¡ªû_udp
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 *
æß‹d
)

53 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

54 
mrou‹_addr
 
»®
;

55 
muÉi_š¡ªû
 *
mi
 = 
NULL
;

56 
hash
 *hash = 
m
->hash;

58 ià(
	`mrou‹_exŒaù_İ’v²_sockaddr
(&
»®
, &
m
->
tİ
.
c2
.
äom
.
de¡
, 
Œue
)

59 && 
m
->
tİ
.
c2
.
buf
.
Ën
 > 0)

61 
hash_–em’t
 *
he
;

62 cÚ¡ 
ušt32_t
 
hv
 = 
	`hash_v®ue
(
hash
, &
»®
);

63 
hash_buck‘
 *
buck‘
 = 
	`hash_buck‘
(
hash
, 
hv
);

64 
ušt8_t
 *
±r
 = 
	`BPTR
(&
m
->
tİ
.
c2
.
buf
);

65 
ušt8_t
 
İ
 = 
±r
[0] >> 
P_OPCODE_SHIFT
;

66 
boŞ
 
v2
 = (
İ
 =ğ
P_DATA_V2
è&& (
m
->
tİ
.
c2
.
buf
.
Ën
 >= (1 + 3));

67 
boŞ
 
³”_id_di§bËd
 = 
çl£
;

70 ià(
v2
)

72 
ušt32_t
 
³”_id
 = 
	`Áohl
(*(ušt32_ˆ*)
±r
) & 0xFFFFFF;

73 
³”_id_di§bËd
 = (
³”_id
 =ğ
MAX_PEER_ID
);

75 ià(!
³”_id_di§bËd
 && (
³”_id
 < 
m
->
max_ş›Ás
è&& (m->
š¡ªûs
[peer_id]))

77 
mi
 = 
m
->
š¡ªûs
[
³”_id
];

79 *
æß‹d
 = !
	`lšk_sock‘_aùu®_m©ch
(&
mi
->
cÚ‹xt
.
c2
.
äom
, &
m
->
tİ
.c2.from);

81 ià(*
æß‹d
)

84 
	`ung’”©e_´efix
(
mi
);

85 
	`msg
(
D_MULTI_MEDIUM
, "Flßˆ»que¡ed fÜ…“¸%" 
PRIu32
 "Ø%s", 
³”_id
,

86 
	`mrou‹_addr_´št
(&
»®
, &
gc
));

90 ià(!
v2
 || 
³”_id_di§bËd
)

92 
he
 = 
	`hash_lookup_ç¡
(
hash
, 
buck‘
, &
»®
, 
hv
);

93 ià(
he
)

95 
mi
 = (
muÉi_š¡ªû
 *è
he
->
v®ue
;

98 ià(!
mi
)

100 ià(!
m
->
tİ
.
c2
.
s_auth_¡ªd®Úe


101 || 
	`s_´e_deüy±_l™e
(
m
->
tİ
.
c2
.
s_auth_¡ªd®Úe
, &m->tİ.c2.
äom
, &m->tİ.c2.
buf
))

103 ià(
	`äequ’cy_lim™_ev’t_®lowed
(
m
->
Ãw_cÚÃùiÚ_lim™”
))

105 
mi
 = 
	`muÉi_ü—‹_š¡ªû
(
m
, &
»®
);

106 ià(
mi
)

108 
i
;

110 
	`hash_add_ç¡
(
hash
, 
buck‘
, &
mi
->
»®
, 
hv
, mi);

111 
mi
->
did_»®_hash
 = 
Œue
;

114 
	`ASSERT
(
m
->
max_ş›Ás
 < 
MAX_PEER_ID
);

116 
i
 = 0; i < 
m
->
max_ş›Ás
; ++i)

118 ià(!
m
->
š¡ªûs
[
i
])

120 
mi
->
cÚ‹xt
.
c2
.
s_muÉi
->
³”_id
 = 
i
;

121 
m
->
š¡ªûs
[
i
] = 
mi
;

128 
	`ASSERT
(
i
 < 
m
->
max_ş›Ás
);

133 
	`msg
(
D_MULTI_ERRORS
,

135 
	`mrou‹_addr_´št
(&
»®
, &
gc
));

140 #ifdeà
ENABLE_DEBUG


141 ià(
	`check_debug_Ëv–
(
D_MULTI_DEBUG
))

143 cÚ¡ *
¡©us
 = 
mi
 ? "[ok]" : "[failed]";

145 
	`dmsg
(
D_MULTI_DEBUG
, "GET INST BY REAL: %s %s",

146 
	`mrou‹_addr_´št
(&
»®
, &
gc
),

147 
¡©us
);

152 
	`gc_ä“
(&
gc
);

153 
	`ASSERT
(!(
mi
 && mi->
h®t
));

154  
mi
;

155 
	}
}

160 
šlše
 

161 
	$muÉi_´oûss_outgošg_lšk
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

163 
muÉi_š¡ªû
 *
mi
 = 
	`muÉi_´oûss_outgošg_lšk_´e
(
m
);

164 ià(
mi
)

166 
	`muÉi_´oûss_outgošg_lšk_dowÜk
(
m
, 
mi
, 
mµ_æags
);

168 
	}
}

174 
	$muÉi_´oûss_io_udp
(
muÉi_cÚ‹xt
 *
m
)

176 cÚ¡ 
¡©us
 = 
m
->
tİ
.
c2
.
ev’t_£t_¡©us
;

177 cÚ¡ 
mµ_æags
 = 
m
->
tİ
.
c2
.
ç¡_io


178 ? (
MPP_CONDITIONAL_PRE_SELECT
 | 
MPP_CLOSE_ON_SIGNAL
)

179 : (
MPP_PRE_SELECT
 | 
MPP_CLOSE_ON_SIGNAL
);

181 #ifdeà
MULTI_DEBUG_EVENT_LOOP


182 
buf
[16];

183 
buf
[0] = 0;

184 ià(
¡©us
 & 
SOCKET_READ
)

186 
	`¡rÿt
(
buf
, "SR/");

188 ià(
¡©us
 & 
SOCKET_WRITE
)

190 
	`¡rÿt
(
buf
, "SW/");

192 ià(
¡©us
 & 
TUN_READ
)

194 
	`¡rÿt
(
buf
, "TR/");

196 ià(
¡©us
 & 
TUN_WRITE
)

198 
	`¡rÿt
(
buf
, "TW/");

200 #ifdeà
ENABLE_ASYNC_PUSH


201 ià(
¡©us
 & 
FILE_CLOSED
)

203 
	`¡rÿt
(
buf
, "FC/");

206 
	`´štf
("IO %s\n", 
buf
);

209 #ifdeà
ENABLE_MANAGEMENT


210 ià(
¡©us
 & (
MANAGEMENT_READ
|
MANAGEMENT_WRITE
))

212 
	`ASSERT
(
mªagem’t
);

213 
	`mªagem’t_io
(
mªagem’t
);

218 ià(
¡©us
 & 
SOCKET_WRITE
)

220 
	`muÉi_´oûss_outgošg_lšk
(
m
, 
mµ_æags
);

223 ià(
¡©us
 & 
TUN_WRITE
)

225 
	`muÉi_´oûss_outgošg_tun
(
m
, 
mµ_æags
);

228 ià(
¡©us
 & 
SOCKET_READ
)

230 
	`»ad_šcomšg_lšk
(&
m
->
tİ
);

231 ià(!
	`IS_SIG
(&
m
->
tİ
))

233 
	`muÉi_´oûss_šcomšg_lšk
(
m
, 
NULL
, 
mµ_æags
);

237 ià(
¡©us
 & 
TUN_READ
)

239 
	`»ad_šcomšg_tun
(&
m
->
tİ
);

240 ià(!
	`IS_SIG
(&
m
->
tİ
))

242 
	`muÉi_´oûss_šcomšg_tun
(
m
, 
mµ_æags
);

245 #ifdeà
ENABLE_ASYNC_PUSH


247 ià(
¡©us
 & 
FILE_CLOSED
)

249 
	`muÉi_´oûss_fe_şo£d
(
m
, 
mµ_æags
);

252 
	}
}

258 
šlše
 

259 
	$p2mp_iow_æags
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
)

261 
æags
 = 
IOW_WAIT_SIGNAL
;

262 ià(
m
->
³ndšg
)

264 ià(
	`TUN_OUT
(&
m
->
³ndšg
->
cÚ‹xt
))

266 
æags
 |ğ
IOW_TO_TUN
;

268 ià(
	`LINK_OUT
(&
m
->
³ndšg
->
cÚ‹xt
))

270 
æags
 |ğ
IOW_TO_LINK
;

273 ià(
	`mbuf_defšed
(
m
->
mbuf
))

275 
æags
 |ğ
IOW_MBUF
;

279 
æags
 |ğ
IOW_READ
;

282  
æags
;

283 
	}
}

298 
	$tuÂ–_£rv”_udp_sšgË_th»aded
(
cÚ‹xt
 *
tİ
)

300 
muÉi_cÚ‹xt
 
muÉi
;

302 
tİ
->
mode
 = 
CM_TOP
;

303 
	`cÚ‹xt_ş—r_2
(
tİ
);

306 
	`š™_š¡ªû_hªdË_sigÇls
(
tİ
,İ->
es
, 
CC_HARD_USR1_TO_HUP
);

307 ià(
	`IS_SIG
(
tİ
))

313 
	`muÉi_š™
(&
muÉi
, 
tİ
, 
çl£
, 
MC_SINGLE_THREADED
);

316 
	`muÉi_tİ_š™
(&
muÉi
, 
tİ
);

319 
	`š™_mªagem’t_ÿÎback_muÉi
(&
muÉi
);

322 
	`š™Ÿliz©iÚ_£qu’û_com¶‘ed
(
tİ
, 
ISC_SERVER
);

324 #ifdeà
ENABLE_ASYNC_PUSH


325 
muÉi
.
tİ
.
c2
.
šÙify_fd
 = 
	`šÙify_š™
();

326 ià(
muÉi
.
tİ
.
c2
.
šÙify_fd
 < 0)

328 
	`msg
(
D_MULTI_ERRORS
 | 
M_ERRNO
, "MULTI: inotify_initƒrror");

333 
Œue
)

335 
	`³rf_push
(
PERF_EVENT_LOOP
);

338 
	`muÉi_g‘_timeout
(&
muÉi
, &muÉi.
tİ
.
c2
.
timev®
);

339 
	`io_wa™
(&
muÉi
.
tİ
, 
	`p2mp_iow_æags
(&multi));

340 
	`MULTI_CHECK_SIG
(&
muÉi
);

343 
	`muÉi_´oûss_³r_£cÚd_tim”s
(&
muÉi
);

346 ià(
muÉi
.
tİ
.
c2
.
ev’t_£t_¡©us
 =ğ
ES_TIMEOUT
)

348 
	`muÉi_´oûss_timeout
(&
muÉi
, 
MPP_PRE_SELECT
|
MPP_CLOSE_ON_SIGNAL
);

353 
	`muÉi_´oûss_io_udp
(&
muÉi
);

354 
	`MULTI_CHECK_SIG
(&
muÉi
);

357 
	`³rf_pİ
();

360 #ifdeà
ENABLE_ASYNC_PUSH


361 
	`şo£
(
tİ
->
c2
.
šÙify_fd
);

365 
	`unš™_mªagem’t_ÿÎback_muÉi
(&
muÉi
);

368 
	`muÉi_ifcÚfig_poŞ_³rsi¡
(&
muÉi
, 
Œue
);

371 
	`muÉi_unš™
(&
muÉi
);

372 
	`muÉi_tİ_ä“
(&
muÉi
);

373 
	`şo£_š¡ªû
(
tİ
);

374 
	}
}

377 
	$tuÂ–_£rv”_udp
(
cÚ‹xt
 *
tİ
)

379 
	`tuÂ–_£rv”_udp_sšgË_th»aded
(
tİ
);

380 
	}
}

	@mudp.h

28 #iâdeà
MUDP_H


29 
	#MUDP_H


	)

31 #ià
P2MP_SERVER


33 
	gcÚ‹xt
;

34 
	gmuÉi_cÚ‹xt
;

46 
tuÂ–_£rv”_udp
(
cÚ‹xt
 *
tİ
);

67 
muÉi_š¡ªû
 *
muÉi_g‘_ü—‹_š¡ªû_udp
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 *
æß‹d
);

	@multi.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 #ifdeà
HAVE_SYS_INOTIFY_H


31 
	~<sys/šÙify.h
>

32 
	#INOTIFY_EVENT_BUFFER_SIZE
 16384

	)

35 
	~"sysh—d.h
"

37 #ià
P2MP_SERVER


39 
	~"muÉi.h
"

40 
	~"push.h
"

41 
	~"misc.h
"

42 
	~"Ùime.h
"

43 
	~"g»mlš.h
"

44 
	~"m¡©s.h
"

45 
	~"s¦_v”ify.h
"

46 
	~<š‰y³s.h
>

48 
	~"memdbg.h
"

50 
	~"fÜw¬d-šlše.h
"

51 
	~"pf-šlše.h
"

55 #ifdeà
MULTI_DEBUG_EVENT_LOOP


57 
	$id
(
muÉi_š¡ªû
 *
mi
)

59 ià(
mi
)

61  
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
);

67 
	}
}

70 #ifdeà
MANAGEMENT_DEF_AUTH


72 
	$£t_cc_cÚfig
(
muÉi_š¡ªû
 *
mi
, 
bufãr_li¡
 *
cc_cÚfig
)

74 ià(
mi
->
cc_cÚfig
)

76 
	`bufãr_li¡_ä“
(
mi
->
cc_cÚfig
);

78 
mi
->
cc_cÚfig
 = cc_config;

79 
	}
}

82 
šlše
 

83 
	$upd©e_m¡©_n_ş›Ás
(cÚ¡ 
n_ş›Ás
)

85 #ifdeà
ENABLE_MEMSTATS


86 ià(
mm­_¡©s
)

88 
mm­_¡©s
->
n_ş›Ás
 =‚_clients;

91 
	}
}

93 
boŞ


94 
	$Ë¬n_add»ss_süt
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
,

95 cÚ¡ 
muÉi_š¡ªû
 *
mi
,

96 cÚ¡ *
İ
,

97 cÚ¡ 
mrou‹_addr
 *
addr
)

99 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

100 
’v_£t
 *
es
;

101 
boŞ
 
»t
 = 
Œue
;

102 
¶ugš_li¡
 *
¶ugšs
;

105 ià(
mi
 && mi->
cÚ‹xt
.
c2
.
es
)

107 
es
 = 
mi
->
cÚ‹xt
.
c2
.es;

111 
es
 = 
	`’v_£t_ü—‹
(&
gc
);

115 ià(
mi
)

117 
¶ugšs
 = 
mi
->
cÚ‹xt
.plugins;

121 
¶ugšs
 = 
m
->
tİ
.plugins;

124 ià(
	`¶ugš_defšed
(
¶ugšs
, 
OPENVPN_PLUGIN_LEARN_ADDRESS
))

126 
¬gv
‡rgv = 
	`¬gv_Ãw
();

127 
	`¬gv_´štf
(&
¬gv
, "%s %s",

128 
İ
,

129 
	`mrou‹_addr_´št
(
addr
, &
gc
));

130 ià(
mi
)

132 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
));

134 ià(
	`¶ugš_ÿÎ
(
¶ugšs
, 
OPENVPN_PLUGIN_LEARN_ADDRESS
, &
¬gv
, 
NULL
, 
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

136 
	`msg
(
M_WARN
, "WARNING:†earn-address…lugin call failed");

137 
»t
 = 
çl£
;

139 
	`¬gv_»£t
(&
¬gv
);

142 ià(
m
->
tİ
.
İtiÚs
.
Ë¬n_add»ss_süt
)

144 
¬gv
‡rgv = 
	`¬gv_Ãw
();

145 
	`£‹nv_¡r
(
es
, "script_type", "learn-address");

146 
	`¬gv_·r£_cmd
(&
¬gv
, 
m
->
tİ
.
İtiÚs
.
Ë¬n_add»ss_süt
);

147 
	`¬gv_´štf_ÿt
(&
¬gv
, "% %s", 
İ
, 
	`mrou‹_addr_´št
(
addr
, &
gc
));

148 ià(
mi
)

150 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
));

152 ià(!
	`İ’v²_run_süt
(&
¬gv
, 
es
, 0, "--learn-address"))

154 
»t
 = 
çl£
;

156 
	`¬gv_»£t
(&
¬gv
);

159 
	`gc_ä“
(&
gc
);

160  
»t
;

161 
	}
}

164 
	$muÉi_ifcÚfig_poŞ_³rsi¡
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 
fÜû
)

167 ià(
m
->
ifcÚfig_poŞ


168 && 
m
->
tİ
.
c1
.
ifcÚfig_poŞ_³rsi¡


169 && (
fÜû
 || 
	`ifcÚfig_poŞ_wr™e_Œigg”
(
m
->
tİ
.
c1
.
ifcÚfig_poŞ_³rsi¡
)))

171 
	`ifcÚfig_poŞ_wr™e
(
m
->
tİ
.
c1
.
ifcÚfig_poŞ_³rsi¡
, m->
ifcÚfig_poŞ
);

173 
	}
}

176 
	$muÉi_»­_¿nge
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
,

177 
¡¬t_buck‘
,

178 
’d_buck‘
)

180 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

181 
hash_™”©Ü
 
hi
;

182 
hash_–em’t
 *
he
;

184 ià(
¡¬t_buck‘
 < 0)

186 
¡¬t_buck‘
 = 0;

187 
’d_buck‘
 = 
	`hash_n_buck‘s
(
m
->
vhash
);

190 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: REAP„ªg%d -> %d", 
¡¬t_buck‘
, 
’d_buck‘
);

191 
	`hash_™”©Ü_š™_¿nge
(
m
->
vhash
, &
hi
, 
¡¬t_buck‘
, 
’d_buck‘
);

192 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)è!ğ
NULL
)

194 
muÉi_rou‹
 *
r
 = (muÉi_rou‹ *è
he
->
v®ue
;

195 ià(!
	`muÉi_rou‹_defšed
(
m
, 
r
))

197 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: REAP DEL %s",

198 
	`mrou‹_addr_´št
(&
r
->
addr
, &
gc
));

199 
	`Ë¬n_add»ss_süt
(
m
, 
NULL
, "d–‘e", &
r
->
addr
);

200 
	`muÉi_rou‹_d–
(
r
);

201 
	`hash_™”©Ü_d–‘e_–em’t
(&
hi
);

204 
	`hash_™”©Ü_ä“
(&
hi
);

205 
	`gc_ä“
(&
gc
);

206 
	}
}

209 
	$muÉi_»­_®l
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
)

211 
	`muÉi_»­_¿nge
(
m
, -1, 0);

212 
	}
}

214 
muÉi_»­
 *

215 
	$muÉi_»­_Ãw
(
buck‘s_³r_·ss
)

217 
muÉi_»­
 *
mr
;

218 
	`ALLOC_OBJ
(
mr
, 
muÉi_»­
);

219 
mr
->
buck‘_ba£
 = 0;

220 
mr
->
buck‘s_³r_·ss
 = buckets_per_pass;

221 
mr
->
Ï¡_ÿÎ
 = 
now
;

222  
mr
;

223 
	}
}

226 
	$muÉi_»­_´oûss_dowÜk
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
)

228 
muÉi_»­
 *
mr
 = 
m
->
»­”
;

229 ià(
mr
->
buck‘_ba£
 >ğ
	`hash_n_buck‘s
(
m
->
vhash
))

231 
mr
->
buck‘_ba£
 = 0;

233 
	`muÉi_»­_¿nge
(
m
, 
mr
->
buck‘_ba£
, mr->buck‘_ba£ + mr->
buck‘s_³r_·ss
);

234 
mr
->
buck‘_ba£
 +ğmr->
buck‘s_³r_·ss
;

235 
mr
->
Ï¡_ÿÎ
 = 
now
;

236 
	}
}

239 
	$muÉi_»­_ä“
(
muÉi_»­
 *
mr
)

241 
	`ä“
(
mr
);

242 
	}
}

248 
	$»­_buck‘s_³r_·ss
(
n_buck‘s
)

250  
	`cÚ¡¿š_št
(
n_buck‘s
 / 
REAP_DIVISOR
, 
REAP_MIN
, 
REAP_MAX
);

251 
	}
}

253 #ifdeà
MANAGEMENT_DEF_AUTH


255 
ušt32_t


256 
	$cid_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

258 cÚ¡ *
k
 = (cÚ¡ *)
key
;

259  (
ušt32_t
è*
k
;

260 
	}
}

262 
boŞ


263 
	$cid_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

265 cÚ¡ *
k1
 = (cÚ¡ *)
key1
;

266 cÚ¡ *
k2
 = (cÚ¡ *)
key2
;

267  *
k1
 =ğ*
k2
;

268 
	}
}

272 #ifdeà
ENABLE_ASYNC_PUSH


273 
ušt32_t


277 
	$št_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

279  ()
key
;

280 
	}
}

282 
boŞ


283 
	$št_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

285  ()
key1
 =ğ()
key2
;

286 
	}
}

293 
	$muÉi_š™
(
muÉi_cÚ‹xt
 *
m
, 
cÚ‹xt
 *
t
, 
boŞ
 
tı_mode
, 
th»ad_mode
)

295 
dev
 = 
DEV_TYPE_UNDEF
;

297 
	`msg
(
D_MULTI_LOW
, "MULTI: multi_init called,„=%d v=%d",

298 
t
->
İtiÚs
.
»®_hash_size
,

299 
t
->
İtiÚs
.
vœtu®_hash_size
);

304 
dev
 = 
	`dev_ty³_’um
(
t
->
İtiÚs
.dev,->İtiÚs.
dev_ty³
);

309 
	`CLEAR
(*
m
);

311 
m
->
th»ad_mode
 =hread_mode;

319 
m
->
hash
 = 
	`hash_š™
(
t
->
İtiÚs
.
»®_hash_size
,

320 
	`g‘_¿ndom
(),

321 
mrou‹_addr_hash_funùiÚ
,

322 
mrou‹_addr_com·»_funùiÚ
);

328 
m
->
vhash
 = 
	`hash_š™
(
t
->
İtiÚs
.
vœtu®_hash_size
,

329 
	`g‘_¿ndom
(),

330 
mrou‹_addr_hash_funùiÚ
,

331 
mrou‹_addr_com·»_funùiÚ
);

338 
m
->
™”
 = 
	`hash_š™
(1,

339 
	`g‘_¿ndom
(),

340 
mrou‹_addr_hash_funùiÚ
,

341 
mrou‹_addr_com·»_funùiÚ
);

343 #ifdeà
MANAGEMENT_DEF_AUTH


344 
m
->
cid_hash
 = 
	`hash_š™
(
t
->
İtiÚs
.
»®_hash_size
,

346 
cid_hash_funùiÚ
,

347 
cid_com·»_funùiÚ
);

350 #ifdeà
ENABLE_ASYNC_PUSH


355 
m
->
šÙify_w©ch”s
 = 
	`hash_š™
(
t
->
İtiÚs
.
»®_hash_size
,

356 
	`g‘_¿ndom
(),

357 
št_hash_funùiÚ
,

358 
št_com·»_funùiÚ
);

365 
m
->
scheduË
 = 
	`scheduË_š™
();

371 
m
->
Ãw_cÚÃùiÚ_lim™”
 = 
	`äequ’cy_lim™_š™
(
t
->
İtiÚs
.
cf_max
,

372 
t
->
İtiÚs
.
cf_³r
);

377 
m
->
mbuf
 = 
	`mbuf_š™
(
t
->
İtiÚs
.
n_bÿ¡_buf
);

382 
m
->
¡©us_fe_v”siÚ
 = 
t
->
İtiÚs
.status_file_version;

389 ià(
t
->
İtiÚs
.
ifcÚfig_poŞ_defšed
)

391 
poŞ_ty³
 = 
IFCONFIG_POOL_INDIV
;

393 ià(
dev
 =ğ
DEV_TYPE_TUN
 && 
t
->
İtiÚs
.
tİŞogy
 =ğ
TOP_NET30
)

395 
poŞ_ty³
 = 
IFCONFIG_POOL_30NET
;

398 
m
->
ifcÚfig_poŞ
 = 
	`ifcÚfig_poŞ_š™
(
poŞ_ty³
,

399 
t
->
İtiÚs
.
ifcÚfig_poŞ_¡¬t
,

400 
t
->
İtiÚs
.
ifcÚfig_poŞ_’d
,

401 
t
->
İtiÚs
.
du¶iÿ‹_ú
,

402 
t
->
İtiÚs
.
ifcÚfig_v6_poŞ_defšed
,

403 
t
->
İtiÚs
.
ifcÚfig_v6_poŞ_ba£
,

404 
t
->
İtiÚs
.
ifcÚfig_v6_poŞ_Ãtb™s
 );

407 ià(
t
->
c1
.
ifcÚfig_poŞ_³rsi¡
)

409 
	`ifcÚfig_poŞ_»ad
(
t
->
c1
.
ifcÚfig_poŞ_³rsi¡
, 
m
->
ifcÚfig_poŞ
);

416 
m
->
rou‹_h–³r
 = 
	`mrou‹_h–³r_š™
(
MULTI_CACHE_ROUTE_TTL
);

421 
m
->
»­”
 = 
	`muÉi_»­_Ãw
(
	`»­_buck‘s_³r_·ss
(
t
->
İtiÚs
.
vœtu®_hash_size
));

426 
	`CLEAR
(
m
->
loÿl
);

427 
	`ASSERT
(
t
->
c1
.
tuÁ­
);

428 
	`mrou‹_exŒaù_š_addr_t
(&
m
->
loÿl
, 
t
->
c1
.
tuÁ­
->local);

433 
m
->
max_ş›Ás
 = 
t
->
İtiÚs
.max_clients;

435 
m
->
š¡ªûs
 = 
	`ÿÎoc
(m->
max_ş›Ás
, (
muÉi_š¡ªû
 *));

440 ià(
tı_mode
)

442 
m
->
mtı
 = 
	`muÉi_tı_š™
(
t
->
İtiÚs
.
max_ş›Ás
, &m->max_clients);

444 
m
->
tı_queue_lim™
 = 
t
->
İtiÚs
.tcp_queue_limit;

450 
m
->
’abË_c2c
 = 
t
->
İtiÚs
.enable_c2c;

453 ià(
t
->
İtiÚs
.
¡®e_rou‹s_check_š‹rv®
 > 0)

455 
	`msg
(
M_INFO
, "Initializing stale„oute checkimero„unƒvery %i seconds‡ndo„emoving„outes with‡ctivityimeout olderhan %i seconds",

456 
t
->
İtiÚs
.
¡®e_rou‹s_check_š‹rv®
,->İtiÚs.
¡®e_rou‹s_agešg_time
);

457 
	`ev’t_timeout_š™
(&
m
->
¡®e_rou‹s_check_‘
, 
t
->
İtiÚs
.
¡®e_rou‹s_check_š‹rv®
, 0);

460 
m
->
deã¼ed_shutdown_sigÇl
.
sigÇl_»ûived
 = 0;

461 
	}
}

464 
	$muÉi_š¡ªû_¡ršg
(cÚ¡ 
muÉi_š¡ªû
 *
mi
, 
boŞ
 
nuÎ
, 
gc_¬’a
 *
gc
)

466 ià(
mi
)

468 
bufãr
 
out
 = 
	`®loc_buf_gc
(
MULTI_PREFIX_MAX_LENGTH
, 
gc
);

469 cÚ¡ *
ú
 = 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
Œue
);

471 ià(
ú
)

473 
	`buf_´štf
(&
out
, "%s/", 
ú
);

475 
	`buf_´štf
(&
out
, "%s", 
	`mrou‹_addr_´št
(&
mi
->
»®
, 
gc
));

476  
	`BSTR
(&
out
);

478 ià(
nuÎ
)

480  
NULL
;

486 
	}
}

489 
	$g’”©e_´efix
(
muÉi_š¡ªû
 *
mi
)

491 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

492 cÚ¡ *
´efix
 = 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
Œue
, &
gc
);

493 ià(
´efix
)

495 
	`¡ºıyÁ
(
mi
->
msg_´efix
, 
´efix
, (mi->msg_prefix));

499 
mi
->
msg_´efix
[0] = '\0';

501 
	`£t_´efix
(
mi
);

502 
	`gc_ä“
(&
gc
);

503 
	}
}

506 
	$ung’”©e_´efix
(
muÉi_š¡ªû
 *
mi
)

508 
mi
->
msg_´efix
[0] = '\0';

509 
	`£t_´efix
(
mi
);

510 
	}
}

513 
	$mi_´efix
(cÚ¡ 
muÉi_š¡ªû
 *
mi
)

515 ià(
mi
 && mi->
msg_´efix
[0])

517  
mi
->
msg_´efix
;

523 
	}
}

531 
	$muÉi_d–_œou‹s
(
muÉi_cÚ‹xt
 *
m
,

532 
muÉi_š¡ªû
 *
mi
)

534 cÚ¡ 
œou‹
 *
œ
;

535 cÚ¡ 
œou‹_v6
 *
œ6
;

536 ià(
	`TUNNEL_TYPE
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
è=ğ
DEV_TYPE_TUN
)

538 
œ
 = 
mi
->
cÚ‹xt
.
İtiÚs
.
œou‹s
; i¸!ğ
NULL
; i¸ğœ->
Ãxt
)

540 
	`mrou‹_h–³r_d–_œou‹46
(
m
->
rou‹_h–³r
, 
œ
->
Ãtb™s
);

543 
œ6
 = 
mi
->
cÚ‹xt
.
İtiÚs
.
œou‹s_v6
; ir6 !ğ
NULL
; ir6 = ir6->
Ãxt
)

545 
	`mrou‹_h–³r_d–_œou‹46
(
m
->
rou‹_h–³r
, 
œ6
->
Ãtb™s
);

548 
	}
}

551 
	$£‹nv_¡©s
(
cÚ‹xt
 *
c
)

553 
	`£‹nv_couÁ”
(
c
->
c2
.
es
, "by‹s_»ûived", c->c2.
lšk_»ad_by‹s
);

554 
	`£‹nv_couÁ”
(
c
->
c2
.
es
, "by‹s_£Á", c->c2.
lšk_wr™e_by‹s
);

555 
	}
}

558 
	$muÉi_ş›Á_discÚÃù_£‹nv
(
muÉi_cÚ‹xt
 *
m
,

559 
muÉi_š¡ªû
 *
mi
)

562 
	`£‹nv_Œu¡ed
(
mi
->
cÚ‹xt
.
c2
.
es
, 
	`g‘_lšk_sock‘_šfo
(&mi->context));

565 
	`£‹nv_¡©s
(&
mi
->
cÚ‹xt
);

569 cÚ¡ 
du¿tiÚ
 = (è
now
 - 
mi
->
ü—‹d
;

570 
	`£‹nv_unsigÃd
(
mi
->
cÚ‹xt
.
c2
.
es
, "time_du¿tiÚ", 
du¿tiÚ
);

572 
	}
}

575 
	$muÉi_ş›Á_discÚÃù_süt
(
muÉi_cÚ‹xt
 *
m
,

576 
muÉi_š¡ªû
 *
mi
)

578 ià((
mi
->
cÚ‹xt
.
c2
.
cÚ‹xt_auth
 =ğ
CAS_SUCCEEDED
 && mi->
cÚÃùiÚ_e¡ablished_æag
)

579 || 
mi
->
cÚ‹xt
.
c2
.
cÚ‹xt_auth
 =ğ
CAS_PARTIAL
)

581 
	`muÉi_ş›Á_discÚÃù_£‹nv
(
m
, 
mi
);

583 ià(
	`¶ugš_defšed
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
))

585 ià(
	`¶ugš_ÿÎ
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
, 
NULL
, NULL, mi->cÚ‹xt.
c2
.
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

587 
	`msg
(
M_WARN
, "WARNING: client-disconnect…lugin call failed");

591 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_discÚÃù_süt
)

593 
¬gv
‡rgv = 
	`¬gv_Ãw
();

594 
	`£‹nv_¡r
(
mi
->
cÚ‹xt
.
c2
.
es
, "script_type", "client-disconnect");

595 
	`¬gv_·r£_cmd
(&
¬gv
, 
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_discÚÃù_süt
);

596 
	`İ’v²_run_süt
(&
¬gv
, 
mi
->
cÚ‹xt
.
c2
.
es
, 0, "--client-disconnect");

597 
	`¬gv_»£t
(&
¬gv
);

599 #ifdeà
MANAGEMENT_DEF_AUTH


600 ià(
mªagem’t
)

602 
	`mªagem’t_nÙify_ş›Á_şo£
(
mªagem’t
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
, mi->cÚ‹xt.c2.
es
);

607 
	}
}

610 
	$muÉi_şo£_š¡ªû
(
muÉi_cÚ‹xt
 *
m
,

611 
muÉi_š¡ªû
 *
mi
,

612 
boŞ
 
shutdown
)

614 
	`³rf_push
(
PERF_MULTI_CLOSE_INSTANCE
);

616 
	`ASSERT
(!
mi
->
h®t
);

617 
mi
->
h®t
 = 
Œue
;

619 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: multi_close_instance called");

622 
m
->
n_ş›Ás
 +ğ
mi
->
n_ş›Ás_d–
;

623 
	`upd©e_m¡©_n_ş›Ás
(
m
->
n_ş›Ás
);

624 
mi
->
n_ş›Ás_d–
 = 0;

627 ià(
m
->
³ndšg
 =ğ
mi
)

629 
	`muÉi_£t_³ndšg
(
m
, 
NULL
);

631 ià(
m
->
—¾›¡_wakeup
 =ğ
mi
)

633 
m
->
—¾›¡_wakeup
 = 
NULL
;

636 ià(!
shutdown
)

638 ià(
mi
->
did_»®_hash
)

640 
	`ASSERT
(
	`hash_»move
(
m
->
hash
, &
mi
->
»®
));

642 ià(
mi
->
did_™”
)

644 
	`ASSERT
(
	`hash_»move
(
m
->
™”
, &
mi
->
»®
));

646 #ifdeà
MANAGEMENT_DEF_AUTH


647 ià(
mi
->
did_cid_hash
)

649 
	`ASSERT
(
	`hash_»move
(
m
->
cid_hash
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
.
cid
));

653 #ifdeà
ENABLE_ASYNC_PUSH


654 ià(
mi
->
šÙify_w©ch
 != -1)

656 
	`hash_»move
(
m
->
šÙify_w©ch”s
, (*è()
mi
->
šÙify_w©ch
);

657 
mi
->
šÙify_w©ch
 = -1;

661 ià(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
->
³”_id
 !ğ
MAX_PEER_ID
)

663 
m
->
š¡ªûs
[
mi
->
cÚ‹xt
.
c2
.
s_muÉi
->
³”_id
] = 
NULL
;

666 
	`scheduË_»move_’Œy
(
m
->
scheduË
, (
scheduË_’Œy
 *è
mi
);

668 
	`ifcÚfig_poŞ_»Ëa£
(
m
->
ifcÚfig_poŞ
, 
mi
->
vaddr_hªdË
, 
çl£
);

670 ià(
mi
->
did_œou‹s
)

672 
	`muÉi_d–_œou‹s
(
m
, 
mi
);

673 
mi
->
did_œou‹s
 = 
çl£
;

676 ià(
m
->
mtı
)

678 
	`muÉi_tı_d”eã»nû_š¡ªû
(
m
->
mtı
, 
mi
);

681 
	`mbuf_d”eã»nû_š¡ªû
(
m
->
mbuf
, 
mi
);

684 #ifdeà
MANAGEMENT_DEF_AUTH


685 
	`£t_cc_cÚfig
(
mi
, 
NULL
);

688 
	`muÉi_ş›Á_discÚÃù_süt
(
m
, 
mi
);

690 ià(
mi
->
did_İ’_cÚ‹xt
)

692 
	`şo£_cÚ‹xt
(&
mi
->
cÚ‹xt
, 
SIGTERM
, 
CC_GC_FREE
);

695 
	`muÉi_tı_š¡ªû_¥ecific_ä“
(
mi
);

697 
	`ung’”©e_´efix
(
mi
);

704 
	`muÉi_š¡ªû_dec_»fcouÁ
(
mi
);

706 
	`³rf_pİ
();

707 
	}
}

713 
	$muÉi_unš™
(
muÉi_cÚ‹xt
 *
m
)

715 ià(
m
->
th»ad_mode
 & 
MC_WORK_THREAD
)

717 
	`muÉi_tİ_ä“
(
m
);

718 
m
->
th»ad_mode
 = 
MC_UNDEF
;

720 ià(
m
->
th»ad_mode
)

722 ià(
m
->
hash
)

724 
hash_™”©Ü
 
hi
;

725 
hash_–em’t
 *
he
;

727 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

728 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

730 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

731 
mi
->
did_™”
 = 
çl£
;

732 
	`muÉi_şo£_š¡ªû
(
m
, 
mi
, 
Œue
);

734 
	`hash_™”©Ü_ä“
(&
hi
);

736 
	`muÉi_»­_®l
(
m
);

738 
	`hash_ä“
(
m
->
hash
);

739 
	`hash_ä“
(
m
->
vhash
);

740 
	`hash_ä“
(
m
->
™”
);

741 #ifdeà
MANAGEMENT_DEF_AUTH


742 
	`hash_ä“
(
m
->
cid_hash
);

744 
m
->
hash
 = 
NULL
;

746 
	`ä“
(
m
->
š¡ªûs
);

748 #ifdeà
ENABLE_ASYNC_PUSH


749 
	`hash_ä“
(
m
->
šÙify_w©ch”s
);

750 
m
->
šÙify_w©ch”s
 = 
NULL
;

753 
	`scheduË_ä“
(
m
->
scheduË
);

754 
	`mbuf_ä“
(
m
->
mbuf
);

755 
	`ifcÚfig_poŞ_ä“
(
m
->
ifcÚfig_poŞ
);

756 
	`äequ’cy_lim™_ä“
(
m
->
Ãw_cÚÃùiÚ_lim™”
);

757 
	`muÉi_»­_ä“
(
m
->
»­”
);

758 
	`mrou‹_h–³r_ä“
(
m
->
rou‹_h–³r
);

759 
	`muÉi_tı_ä“
(
m
->
mtı
);

760 
m
->
th»ad_mode
 = 
MC_UNDEF
;

763 
	}
}

768 
muÉi_š¡ªû
 *

769 
	$muÉi_ü—‹_š¡ªû
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mrou‹_addr
 *
»®
)

771 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

772 
muÉi_š¡ªû
 *
mi
;

774 
	`³rf_push
(
PERF_MULTI_CREATE_INSTANCE
);

776 
	`msg
(
D_MULTI_MEDIUM
, "MULTI: multi_create_instance called");

778 
	`ALLOC_OBJ_CLEAR
(
mi
, 
muÉi_š¡ªû
);

780 
mi
->
gc
 = 
	`gc_Ãw
();

781 
	`muÉi_š¡ªû_šc_»fcouÁ
(
mi
);

782 
mi
->
vaddr_hªdË
 = -1;

783 
mi
->
ü—‹d
 = 
now
;

784 
	`mrou‹_addr_š™
(&
mi
->
»®
);

786 ià(
»®
)

788 
mi
->
»®
 = *real;

789 
	`g’”©e_´efix
(
mi
);

792 
mi
->
did_İ’_cÚ‹xt
 = 
Œue
;

793 
	`šh”™_cÚ‹xt_chd
(&
mi
->
cÚ‹xt
, &
m
->
tİ
);

794 ià(
	`IS_SIG
(&
mi
->
cÚ‹xt
))

796 
”r
;

799 
mi
->
cÚ‹xt
.
c2
.
cÚ‹xt_auth
 = 
CAS_PENDING
;

801 ià(
	`hash_n_–em’ts
(
m
->
hash
è>ğm->
max_ş›Ás
)

803 
	`msg
(
D_MULTI_ERRORS
, "MULTI:‚ew incomšg cÚÃùiÚ wouldƒxûed maximum‚umb” oàş›Á (%d)", 
m
->
max_ş›Ás
);

804 
”r
;

807 ià(!
»®
)

809 ià(!
	`muÉi_tı_š¡ªû_¥ecific_š™
(
m
, 
mi
))

811 
”r
;

813 
	`g’”©e_´efix
(
mi
);

816 ià(!
	`hash_add
(
m
->
™”
, &
mi
->
»®
, mi, 
çl£
))

818 
	`msg
(
D_MULTI_LOW
, "MULTI: unableo‡dd„eal‡ddress [%s]o iterator hashable",

819 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
));

820 
”r
;

822 
mi
->
did_™”
 = 
Œue
;

824 #ifdeà
MANAGEMENT_DEF_AUTH


827 
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
.
cid
 = 
m
->
cid_couÁ”
++;

828 } !
	`hash_add
(
m
->
cid_hash
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
.
cid
, mi, 
çl£
));

829 
mi
->
did_cid_hash
 = 
Œue
;

832 
mi
->
cÚ‹xt
.
c2
.
push_»¶y_deã¼ed
 = 
Œue
;

834 #ifdeà
ENABLE_ASYNC_PUSH


835 
mi
->
cÚ‹xt
.
c2
.
push_»que¡_»ûived
 = 
çl£
;

836 
mi
->
šÙify_w©ch
 = -1;

839 ià(!
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
MPP_PRE_SELECT
))

841 
	`msg
(
D_MULTI_ERRORS
, "MULTI: signal occurred during client instance initialization");

842 
”r
;

845 
	`³rf_pİ
();

846 
	`gc_ä“
(&
gc
);

847  
mi
;

849 
”r
:

850 
	`muÉi_şo£_š¡ªû
(
m
, 
mi
, 
çl£
);

851 
	`³rf_pİ
();

852 
	`gc_ä“
(&
gc
);

853  
NULL
;

854 
	}
}

862 
	$muÉi_´št_¡©us
(
muÉi_cÚ‹xt
 *
m
, 
¡©us_ouut
 *
so
, cÚ¡ 
v”siÚ
)

864 ià(
m
->
hash
)

866 
gc_¬’a
 
gc_tİ
 = 
	`gc_Ãw
();

867 
hash_™”©Ü
 
hi
;

868 cÚ¡ 
hash_–em’t
 *
he
;

870 
	`¡©us_»£t
(
so
);

872 ià(
v”siÚ
 == 1)

877 
	`¡©us_´štf
(
so
, "OpenVPN CLIENT LIST");

878 
	`¡©us_´štf
(
so
, "Upd©ed,%s", 
	`time_¡ršg
(0, 0, 
çl£
, &
gc_tİ
));

879 
	`¡©us_´štf
(
so
, "Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since");

880 
	`hash_™”©Ü_š™
(
m
->
hash
, &
hi
);

881 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

883 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

884 cÚ¡ 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

886 ià(!
mi
->
h®t
)

888 
	`¡©us_´štf
(
so
, "%s,%s," 
couÁ”_fÜm©
 "," counter_format ",%s",

889 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

890 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
),

891 
mi
->
cÚ‹xt
.
c2
.
lšk_»ad_by‹s
,

892 
mi
->
cÚ‹xt
.
c2
.
lšk_wr™e_by‹s
,

893 
	`time_¡ršg
(
mi
->
ü—‹d
, 0, 
çl£
, &
gc
));

895 
	`gc_ä“
(&
gc
);

897 
	`hash_™”©Ü_ä“
(&
hi
);

899 
	`¡©us_´štf
(
so
, "ROUTING TABLE");

900 
	`¡©us_´štf
(
so
, "Virtual Address,Common Name,Real Address,Last Ref");

901 
	`hash_™”©Ü_š™
(
m
->
vhash
, &
hi
);

902 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

904 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

905 cÚ¡ 
muÉi_rou‹
 *
rou‹
 = (muÉi_rou‹ *è
he
->
v®ue
;

907 ià(
	`muÉi_rou‹_defšed
(
m
, 
rou‹
))

909 cÚ¡ 
muÉi_š¡ªû
 *
mi
 = 
rou‹
->
š¡ªû
;

910 cÚ¡ 
mrou‹_addr
 *
ma
 = &
rou‹
->
addr
;

911 
æags
[2] = {0, 0};

913 ià(
rou‹
->
æags
 & 
MULTI_ROUTE_CACHE
)

915 
æags
[0] = 'C';

917 
	`¡©us_´štf
(
so
, "%s%s,%s,%s,%s",

918 
	`mrou‹_addr_´št
(
ma
, &
gc
),

919 
æags
,

920 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

921 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
),

922 
	`time_¡ršg
(
rou‹
->
Ï¡_»ã»nû
, 0, 
çl£
, &
gc
));

924 
	`gc_ä“
(&
gc
);

926 
	`hash_™”©Ü_ä“
(&
hi
);

928 
	`¡©us_´štf
(
so
, "GLOBAL STATS");

929 ià(
m
->
mbuf
)

931 
	`¡©us_´štf
(
so
, "Max bcast/mcast queue†ength,%d",

932 
	`mbuf_maximum_queued
(
m
->
mbuf
));

935 
	`¡©us_´štf
(
so
, "END");

937 ià(
v”siÚ
 == 2 || version == 3)

939 cÚ¡ 
£p
 = (
v”siÚ
 == 3) ? '\t' : ',';

944 
	`¡©us_´štf
(
so
, "TITLE%c%s", 
£p
, 
t™Ë_¡ršg
);

945 
	`¡©us_´štf
(
so
, "TIME%c%s%c%u", 
£p
, 
	`time_¡ršg
(
now
, 0, 
çl£
, &
gc_tİ
), sep, ()now);

946 
	`¡©us_´štf
(
so
, "HEADER%cCLIENT_LIST%cCommon Name%cReal Address%cVirtual Address%cVirtual IPv6 Address%cBytes Received%cBytes Sent%cConnected Since%cConnected Since (time_t)%cUsername%cClient ID%cPeer ID",

947 
£p
, sep, sep, sep, sep, sep, sep, sep, sep, sep, sep, sep);

948 
	`hash_™”©Ü_š™
(
m
->
hash
, &
hi
);

949 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

951 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

952 cÚ¡ 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

954 ià(!
mi
->
h®t
)

956 
	`¡©us_´štf
(
so
, "CLIENT_LIST%c%s%c%s%c%s%c%s%c" 
couÁ”_fÜm©
 "%c" counter_format "%c%s%c%u%c%s%c"

957 #ifdeà
MANAGEMENT_DEF_AUTH


962 "%c%" 
PRIu32
,

963 
£p
, 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

964 
£p
, 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
),

965 
£p
, 
	`´št_š_addr_t
(
mi
->
»pÜtšg_addr
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

966 
£p
, 
	`´št_š6_addr
(
mi
->
»pÜtšg_addr_v6
, 
IA_EMPTY_IF_UNDEF
, &
gc
),

967 
£p
, 
mi
->
cÚ‹xt
.
c2
.
lšk_»ad_by‹s
,

968 
£p
, 
mi
->
cÚ‹xt
.
c2
.
lšk_wr™e_by‹s
,

969 
£p
, 
	`time_¡ršg
(
mi
->
ü—‹d
, 0, 
çl£
, &
gc
),

970 
£p
, ()
mi
->
ü—‹d
,

971 
£p
, 
	`s_u£ºame
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

972 #ifdeà
MANAGEMENT_DEF_AUTH


973 
£p
, 
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
.
cid
,

975 
£p
,

977 
£p
, 
mi
->
cÚ‹xt
.
c2
.
s_muÉi
 ? mi->cÚ‹xt.c2.s_muÉi->
³”_id
 : 
UINT32_MAX
);

979 
	`gc_ä“
(&
gc
);

981 
	`hash_™”©Ü_ä“
(&
hi
);

983 
	`¡©us_´štf
(
so
, "HEADER%cROUTING_TABLE%cVirtual Address%cCommon Name%cReal Address%cLast Ref%cLast Ref (time_t)",

984 
£p
, sep, sep, sep, sep, sep);

985 
	`hash_™”©Ü_š™
(
m
->
vhash
, &
hi
);

986 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

988 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

989 cÚ¡ 
muÉi_rou‹
 *
rou‹
 = (muÉi_rou‹ *è
he
->
v®ue
;

991 ià(
	`muÉi_rou‹_defšed
(
m
, 
rou‹
))

993 cÚ¡ 
muÉi_š¡ªû
 *
mi
 = 
rou‹
->
š¡ªû
;

994 cÚ¡ 
mrou‹_addr
 *
ma
 = &
rou‹
->
addr
;

995 
æags
[2] = {0, 0};

997 ià(
rou‹
->
æags
 & 
MULTI_ROUTE_CACHE
)

999 
æags
[0] = 'C';

1001 
	`¡©us_´štf
(
so
, "ROUTING_TABLE%c%s%s%c%s%c%s%c%s%c%u",

1002 
£p
, 
	`mrou‹_addr_´št
(
ma
, &
gc
), 
æags
,

1003 
£p
, 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

1004 
£p
, 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
),

1005 
£p
, 
	`time_¡ršg
(
rou‹
->
Ï¡_»ã»nû
, 0, 
çl£
, &
gc
),

1006 
£p
, ()
rou‹
->
Ï¡_»ã»nû
);

1008 
	`gc_ä“
(&
gc
);

1010 
	`hash_™”©Ü_ä“
(&
hi
);

1012 ià(
m
->
mbuf
)

1014 
	`¡©us_´štf
(
so
, "GLOBAL_STATS%cMax bcast/mcast queue†ength%c%d",

1015 
£p
, s•, 
	`mbuf_maximum_queued
(
m
->
mbuf
));

1018 
	`¡©us_´štf
(
so
, "END");

1022 
	`¡©us_´štf
(
so
, "ERROR: bad status format version‚umber");

1025 #ifdeà
PACKET_TRUNCATION_CHECK


1027 
	`¡©us_´štf
(
so
, "HEADER,ERRORS,Common Name,TUN Read Trunc,TUN Write Trunc,Pre-encrypt Trunc,Post-decrypt Trunc");

1028 
	`hash_™”©Ü_š™
(
m
->
hash
, &
hi
);

1029 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

1031 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1032 cÚ¡ 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

1034 ià(!
mi
->
h®t
)

1036 
	`¡©us_´štf
(
so
, "ERRORS,%s," 
couÁ”_fÜm©
 "," counter_format "," counter_format "," counter_format,

1037 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

1038 
m
->
tİ
.
c2
.
n_Œunc_tun_»ad
,

1039 
mi
->
cÚ‹xt
.
c2
.
n_Œunc_tun_wr™e
,

1040 
mi
->
cÚ‹xt
.
c2
.
n_Œunc_´e_’üy±
,

1041 
mi
->
cÚ‹xt
.
c2
.
n_Œunc_po¡_deüy±
);

1043 
	`gc_ä“
(&
gc
);

1045 
	`hash_™”©Ü_ä“
(&
hi
);

1049 
	`¡©us_æush
(
so
);

1050 
	`gc_ä“
(&
gc_tİ
);

1053 #ifdeà
ENABLE_ASYNC_PUSH


1054 ià(
m
->
šÙify_w©ch”s
)

1056 
	`msg
(
D_MULTI_DEBUG
, "šÙify w©ch” couÁ: %d\n", 
	`hash_n_–em’ts
(
m
->
šÙify_w©ch”s
));

1059 
	}
}

1069 
muÉi_š¡ªû
 *

1070 
	$muÉi_Ë¬n_addr
(
muÉi_cÚ‹xt
 *
m
,

1071 
muÉi_š¡ªû
 *
mi
,

1072 cÚ¡ 
mrou‹_addr
 *
addr
,

1073 cÚ¡ 
æags
)

1075 
hash_–em’t
 *
he
;

1076 cÚ¡ 
ušt32_t
 
hv
 = 
	`hash_v®ue
(
m
->
vhash
, 
addr
);

1077 
hash_buck‘
 *
buck‘
 = 
	`hash_buck‘
(
m
->
vhash
, 
hv
);

1078 
muÉi_rou‹
 *
Şdrou‹
 = 
NULL
;

1079 
muÉi_š¡ªû
 *
owÃr
 = 
NULL
;

1080 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1083 
he
 = 
	`hash_lookup_ç¡
(
m
->
vhash
, 
buck‘
, 
addr
, 
hv
);

1084 ià(
he
)

1086 
Şdrou‹
 = (
muÉi_rou‹
 *è
he
->
v®ue
;

1088 ià(
Şdrou‹
 && 
	`muÉi_rou‹_defšed
(
m
, oldroute))

1090 
owÃr
 = 
Şdrou‹
->
š¡ªû
;

1094 ià((!
owÃr
 || owÃ¸!ğ
mi
è&& 
	`mrou‹_Ë¬ÇbË_add»ss
(
addr
, &
gc
)

1095 && !
	`mrou‹_addr_equ®
(
addr
, &
m
->
loÿl
))

1097 
muÉi_rou‹
 *
Ãwrou‹
;

1098 
boŞ
 
Ë¬n_sucûeded
 = 
çl£
;

1100 
	`ALLOC_OBJ
(
Ãwrou‹
, 
muÉi_rou‹
);

1101 
Ãwrou‹
->
addr
 = *addr;

1102 
Ãwrou‹
->
š¡ªû
 = 
mi
;

1103 
Ãwrou‹
->
æags
 = flags;

1104 
Ãwrou‹
->
Ï¡_»ã»nû
 = 
now
;

1105 
Ãwrou‹
->
ÿche_g’”©iÚ
 = 0;

1108 ià(
æags
 & 
MULTI_ROUTE_CACHE
)

1110 
Ãwrou‹
->
ÿche_g’”©iÚ
 = 
m
->
rou‹_h–³r
->cache_generation;

1113 ià(
Şdrou‹
)

1115 ià(
	`rou‹_quÙa_‹¡
(
m
, 
mi
è&& 
	`Ë¬n_add»ss_süt
(m, mi, "upd©e", &
Ãwrou‹
->
addr
))

1117 
Ë¬n_sucûeded
 = 
Œue
;

1118 
owÃr
 = 
mi
;

1119 
	`muÉi_š¡ªû_šc_»fcouÁ
(
mi
);

1120 
	`rou‹_quÙa_šc
(
mi
);

1123 
	`muÉi_rou‹_d–
(
Şdrou‹
);

1126 
he
->
key
 = &
Ãwrou‹
->
addr
;

1127 
he
->
v®ue
 = 
Ãwrou‹
;

1132 ià(
	`rou‹_quÙa_‹¡
(
m
, 
mi
è&& 
	`Ë¬n_add»ss_süt
(m, mi, "add", &
Ãwrou‹
->
addr
))

1134 
Ë¬n_sucûeded
 = 
Œue
;

1135 
owÃr
 = 
mi
;

1136 
	`muÉi_š¡ªû_šc_»fcouÁ
(
mi
);

1137 
	`rou‹_quÙa_šc
(
mi
);

1140 
	`hash_add_ç¡
(
m
->
vhash
, 
buck‘
, &
Ãwrou‹
->
addr
, 
hv
,‚ewroute);

1144 
	`msg
(
D_MULTI_LOW
, "MULTI: Learn%s: %s -> %s",

1145 
Ë¬n_sucûeded
 ? "" : " FAILED",

1146 
	`mrou‹_addr_´št
(&
Ãwrou‹
->
addr
, &
gc
),

1147 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

1149 ià(!
Ë¬n_sucûeded
)

1151 
	`ä“
(
Ãwrou‹
);

1154 
	`gc_ä“
(&
gc
);

1156  
owÃr
;

1157 
	}
}

1162 
muÉi_š¡ªû
 *

1163 
	$muÉi_g‘_š¡ªû_by_vœtu®_addr
(
muÉi_cÚ‹xt
 *
m
,

1164 cÚ¡ 
mrou‹_addr
 *
addr
,

1165 
boŞ
 
cidr_routšg
)

1167 
muÉi_rou‹
 *
rou‹
;

1168 
muÉi_š¡ªû
 *
»t
 = 
NULL
;

1171 ià(
	`mrou‹_addr_equ®
(
addr
, &
m
->
loÿl
))

1173  
NULL
;

1176 
rou‹
 = (
muÉi_rou‹
 *è
	`hash_lookup
(
m
->
vhash
, 
addr
);

1179 ià(
rou‹
 && 
	`muÉi_rou‹_defšed
(
m
,„oute))

1181 
muÉi_š¡ªû
 *
mi
 = 
rou‹
->
š¡ªû
;

1182 
rou‹
->
Ï¡_»ã»nû
 = 
now
;

1183 
»t
 = 
mi
;

1185 ià(
cidr_routšg
)

1187 
mrou‹_h–³r
 *
rh
 = 
m
->
rou‹_h–³r
;

1188 
mrou‹_addr
 
Œyaddr
;

1189 
i
;

1192 
i
 = 0; i < 
rh
->
n_Ãt_Ën
; ++i)

1194 
Œyaddr
 = *
addr
;

1195 
Œyaddr
.
ty³
 |ğ
MR_WITH_NETBITS
;

1196 
Œyaddr
.
Ãtb™s
 = 
rh
->
Ãt_Ën
[
i
];

1197 
	`mrou‹_addr_mask_ho¡_b™s
(&
Œyaddr
);

1200 
rou‹
 = (
muÉi_rou‹
 *è
	`hash_lookup
(
m
->
vhash
, &
Œyaddr
);

1202 ià(
rou‹
 && 
	`muÉi_rou‹_defšed
(
m
,„oute))

1205 
muÉi_š¡ªû
 *
mi
 = 
rou‹
->
š¡ªû
;

1206 
	`muÉi_Ë¬n_addr
(
m
, 
mi
, 
addr
, 
MULTI_ROUTE_CACHE
|
MULTI_ROUTE_AGEABLE
);

1207 
»t
 = 
mi
;

1213 #ifdeà
ENABLE_DEBUG


1214 ià(
	`check_debug_Ëv–
(
D_MULTI_DEBUG
))

1216 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1217 cÚ¡ *
addr_‹xt
 = 
	`mrou‹_addr_´št
(
addr
, &
gc
);

1218 ià(
»t
)

1220 
	`dmsg
(
D_MULTI_DEBUG
, "GET INST BY VIRT: %s -> %s via %s",

1221 
addr_‹xt
,

1222 
	`muÉi_š¡ªû_¡ršg
(
»t
, 
çl£
, &
gc
),

1223 
	`mrou‹_addr_´št
(&
rou‹
->
addr
, &
gc
));

1227 
	`dmsg
(
D_MULTI_DEBUG
, "GET INST BY VIRT: %s [failed]",

1228 
addr_‹xt
);

1230 
	`gc_ä“
(&
gc
);

1234 
	`ASSERT
(!(
»t
 &&„‘->
h®t
));

1235  
»t
;

1236 
	}
}

1241 
muÉi_š¡ªû
 *

1242 
	$muÉi_Ë¬n_š_addr_t
(
muÉi_cÚ‹xt
 *
m
,

1243 
muÉi_š¡ªû
 *
mi
,

1244 
š_addr_t
 
a
,

1245 
Ãtb™s
,

1246 
boŞ
 
´im¬y
)

1248 
İ’v²_sockaddr
 
»mÙe_si
;

1249 
mrou‹_addr
 
addr
;

1251 
	`CLEAR
(
»mÙe_si
);

1252 
»mÙe_si
.
addr
.
š4
.
sš_çmy
 = 
AF_INET
;

1253 
»mÙe_si
.
addr
.
š4
.
sš_addr
.
s_addr
 = 
	`htÚl
(
a
);

1254 
	`ASSERT
(
	`mrou‹_exŒaù_İ’v²_sockaddr
(&
addr
, &
»mÙe_si
, 
çl£
));

1256 ià(
Ãtb™s
 >= 0)

1258 
addr
.
ty³
 |ğ
MR_WITH_NETBITS
;

1259 
addr
.
Ãtb™s
 = (
ušt8_t
)‚etbits;

1263 
muÉi_š¡ªû
 *
owÃr
 = 
	`muÉi_Ë¬n_addr
(
m
, 
mi
, &
addr
, 0);

1264 #ifdeà
MANAGEMENT_DEF_AUTH


1265 ià(
mªagem’t
 && 
owÃr
)

1267 
	`mªagem’t_Ë¬n_addr
(
mªagem’t
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
, &
addr
, 
´im¬y
);

1270  
owÃr
;

1272 
	}
}

1274 
muÉi_š¡ªû
 *

1275 
	$muÉi_Ë¬n_š6_addr
(
muÉi_cÚ‹xt
 *
m
,

1276 
muÉi_š¡ªû
 *
mi
,

1277 
š6_addr
 
a6
,

1278 
Ãtb™s
,

1279 
boŞ
 
´im¬y
)

1281 
mrou‹_addr
 
addr
;

1283 
addr
.
Ën
 = 16;

1284 
addr
.
ty³
 = 
MR_ADDR_IPV6
;

1285 
addr
.
Ãtb™s
 = 0;

1286 
addr
.
v6
.add¸ğ
a6
;

1288 ià(
Ãtb™s
 >= 0)

1290 
addr
.
ty³
 |ğ
MR_WITH_NETBITS
;

1291 
addr
.
Ãtb™s
 = (
ušt8_t
)‚etbits;

1292 
	`mrou‹_addr_mask_ho¡_b™s
Ğ&
addr
 );

1296 
muÉi_š¡ªû
 *
owÃr
 = 
	`muÉi_Ë¬n_addr
(
m
, 
mi
, &
addr
, 0);

1297 #ifdeà
MANAGEMENT_DEF_AUTH


1298 ià(
mªagem’t
 && 
owÃr
)

1300 
	`mªagem’t_Ë¬n_addr
(
mªagem’t
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
, &
addr
, 
´im¬y
);

1303  
owÃr
;

1305 
	}
}

1312 
	$muÉi_add_œou‹s
(
muÉi_cÚ‹xt
 *
m
,

1313 
muÉi_š¡ªû
 *
mi
)

1315 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1316 cÚ¡ 
œou‹
 *
œ
;

1317 cÚ¡ 
œou‹_v6
 *
œ6
;

1318 ià(
	`TUNNEL_TYPE
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
è=ğ
DEV_TYPE_TUN
)

1320 
mi
->
did_œou‹s
 = 
Œue
;

1321 
œ
 = 
mi
->
cÚ‹xt
.
İtiÚs
.
œou‹s
; i¸!ğ
NULL
; i¸ğœ->
Ãxt
)

1323 ià(
œ
->
Ãtb™s
 >= 0)

1325 
	`msg
(
D_MULTI_LOW
, "MULTI: internal„oute %s/%d -> %s",

1326 
	`´št_š_addr_t
(
œ
->
ÃtwÜk
, 0, &
gc
),

1327 
œ
->
Ãtb™s
,

1328 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

1332 
	`msg
(
D_MULTI_LOW
, "MULTI: internal„oute %s -> %s",

1333 
	`´št_š_addr_t
(
œ
->
ÃtwÜk
, 0, &
gc
),

1334 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

1337 
	`mrou‹_h–³r_add_œou‹46
(
m
->
rou‹_h–³r
, 
œ
->
Ãtb™s
);

1339 
	`muÉi_Ë¬n_š_addr_t
(
m
, 
mi
, 
œ
->
ÃtwÜk
, ir->
Ãtb™s
, 
çl£
);

1341 
œ6
 = 
mi
->
cÚ‹xt
.
İtiÚs
.
œou‹s_v6
; ir6 !ğ
NULL
; ir6 = ir6->
Ãxt
)

1343 
	`msg
(
D_MULTI_LOW
, "MULTI: internal„oute %s/%d -> %s",

1344 
	`´št_š6_addr
(
œ6
->
ÃtwÜk
, 0, &
gc
),

1345 
œ6
->
Ãtb™s
,

1346 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

1348 
	`mrou‹_h–³r_add_œou‹46
(
m
->
rou‹_h–³r
, 
œ6
->
Ãtb™s
);

1350 
	`muÉi_Ë¬n_š6_addr
(
m
, 
mi
, 
œ6
->
ÃtwÜk
, ir6->
Ãtb™s
, 
çl£
);

1353 
	`gc_ä“
(&
gc
);

1354 
	}
}

1361 
	$muÉi_d–‘e_dup
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
Ãw_mi
)

1363 ià(
Ãw_mi
)

1365 cÚ¡ *
Ãw_ú
 = 
	`s_commÚ_Çme
(
Ãw_mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
Œue
);

1366 ià(
Ãw_ú
)

1368 
hash_™”©Ü
 
hi
;

1369 
hash_–em’t
 *
he
;

1370 
couÁ
 = 0;

1372 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

1373 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

1375 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

1376 ià(
mi
 !ğ
Ãw_mi
 && !mi->
h®t
)

1378 cÚ¡ *
ú
 = 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
Œue
);

1379 ià(
ú
 && !
	`¡rcmp
(ú, 
Ãw_ú
))

1381 
mi
->
did_™”
 = 
çl£
;

1382 
	`muÉi_şo£_š¡ªû
(
m
, 
mi
, 
çl£
);

1383 
	`hash_™”©Ü_d–‘e_–em’t
(&
hi
);

1384 ++
couÁ
;

1388 
	`hash_™”©Ü_ä“
(&
hi
);

1390 ià(
couÁ
)

1392 
	`msg
(
D_MULTI_LOW
, "MULTI:‚ew cÚÃùiÚ by cl›Á '%s' wÈÿu£…»viou aùiv£ssiÚ byhi ş›ÁØbdrİ³d. Rememb”Øu£h--du¶iÿ‹-ú o±iÚ iàyou wªˆmuÉË cl›Á usšgh§mû¹ifiÿ‹ o¸u£ºamtØcÚcu¼’y cÚÃù.", 
Ãw_ú
);

1396 
	}
}

1399 
	$check_¡®e_rou‹s
(
muÉi_cÚ‹xt
 *
m
)

1402 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1403 
hash_™”©Ü
 
hi
;

1404 
hash_–em’t
 *
he
;

1406 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: Checking stale„outes");

1407 
	`hash_™”©Ü_š™_¿nge
(
m
->
vhash
, &
hi
, 0, 
	`hash_n_buck‘s
(m->vhash));

1408 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)è!ğ
NULL
)

1410 
muÉi_rou‹
 *
r
 = (muÉi_rou‹ *è
he
->
v®ue
;

1411 ià(
	`muÉi_rou‹_defšed
(
m
, 
r
è&& 
	`difáime
(
now
,„->
Ï¡_»ã»nû
è>ğm->
tİ
.
İtiÚs
.
¡®e_rou‹s_agešg_time
)

1413 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: Deleting stale„oute for‡ddress '%s'",

1414 
	`mrou‹_addr_´št
(&
r
->
addr
, &
gc
));

1415 
	`Ë¬n_add»ss_süt
(
m
, 
NULL
, "d–‘e", &
r
->
addr
);

1416 
	`muÉi_rou‹_d–
(
r
);

1417 
	`hash_™”©Ü_d–‘e_–em’t
(&
hi
);

1420 
	`hash_™”©Ü_ä“
(&
hi
);

1421 
	`gc_ä“
(&
gc
);

1422 
	}
}

1428 
boŞ


1429 
	$ifcÚfig_push_cÚ¡¿št_§tisf›d
(cÚ¡ 
cÚ‹xt
 *
c
)

1431 cÚ¡ 
İtiÚs
 *
o
 = &
c
->options;

1432 ià(
o
->
push_ifcÚfig_cÚ¡¿št_defšed
 && 
c
->
c2
.
push_ifcÚfig_defšed
)

1434  (
o
->
push_ifcÚfig_cÚ¡¿št_Ãtmask
 & 
c
->
c2
.
push_ifcÚfig_loÿl
è=ğo->
push_ifcÚfig_cÚ¡¿št_ÃtwÜk
;

1438  
Œue
;

1440 
	}
}

1448 
	$muÉi_£Ëù_vœtu®_addr
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

1450 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1456 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_defšed
)

1460 ià(
mi
->
vaddr_hªdË
 >= 0)

1462 
	`ifcÚfig_poŞ_»Ëa£
(
m
->
ifcÚfig_poŞ
, 
mi
->
vaddr_hªdË
, 
Œue
);

1463 
mi
->
vaddr_hªdË
 = -1;

1466 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_defšed
 = 
Œue
;

1467 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
 = mi->cÚ‹xt.
İtiÚs
.push_ifconfig_local;

1468 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
 = mi->cÚ‹xt.
İtiÚs
.push_ifconfig_remote_netmask;

1469 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl_®Ÿs
 = mi->cÚ‹xt.
İtiÚs
.push_ifconfig_local_alias;

1475 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
ifcÚfig_v6_poŞ_defšed


1476 && !
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_v6_defšed
)

1478 
	`msg
Ğ
M_INFO
, "MULTI_sva: WARNING: if --ifconfig-push is used for IPv4,‡utomatic IPv6‡ssignment from --ifconfig-ipv6-pool does‚ot work. Use --ifconfig-ipv6-push for IPv6hen." );

1481 ià(
m
->
ifcÚfig_poŞ
 && 
mi
->
vaddr_hªdË
 < 0)

1483 
š_addr_t
 
loÿl
 = 0, 
»mÙe
 = 0;

1484 
š6_addr
 
»mÙe_v6
;

1485 cÚ¡ *
ú
 = 
NULL
;

1487 ià(!
mi
->
cÚ‹xt
.
İtiÚs
.
du¶iÿ‹_ú
)

1489 
ú
 = 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
Œue
);

1492 
	`CLEAR
(
»mÙe_v6
);

1493 
mi
->
vaddr_hªdË
 = 
	`ifcÚfig_poŞ_acquœe
(
m
->
ifcÚfig_poŞ
, &
loÿl
, &
»mÙe
, &
»mÙe_v6
, 
ú
);

1494 ià(
mi
->
vaddr_hªdË
 >= 0)

1496 cÚ¡ 
tuÂ–_ty³
 = 
	`TUNNEL_TYPE
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
);

1497 cÚ¡ 
tuÂ–_tİŞogy
 = 
	`TUNNEL_TOPOLOGY
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
);

1499 
	`msg
Ğ
M_INFO
, "MULTI_sva:…ool„eturned IPv4=%s, IPv6=%s",

1500 
	`´št_š_addr_t
Ğ
»mÙe
, 0, &
gc
 ),

1501 (
mi
->
cÚ‹xt
.
İtiÚs
.
ifcÚfig_v6_poŞ_defšed


1502 ? 
	`´št_š6_addr
Ğ
»mÙe_v6
, 0, &
gc
 )

1506 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
 = 
»mÙe
;

1507 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TAP
 || (tuÂ–_ty³ =ğ
DEV_TYPE_TUN
 && 
tuÂ–_tİŞogy
 =ğ
TOP_SUBNET
))

1509 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
 = mi->cÚ‹xt.
İtiÚs
.
ifcÚfig_poŞ_Ãtmask
;

1510 ià(!
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
)

1512 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
 = mi->cÚ‹xt.
c1
.
tuÁ­
->
»mÙe_Ãtmask
;

1515 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TUN
)

1517 ià(
tuÂ–_tİŞogy
 =ğ
TOP_P2P
)

1519 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
 = mi->cÚ‹xt.
c1
.
tuÁ­
->
loÿl
;

1521 ià(
tuÂ–_tİŞogy
 =ğ
TOP_NET30
)

1523 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
 = 
loÿl
;

1527 ià(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
)

1529 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_defšed
 = 
Œue
;

1533 
	`msg
(
D_MULTI_ERRORS
, "MULTI:‚o --ifconfig-pool‚etmask…arameter is‡vailableo…usho %s",

1534 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

1537 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
ifcÚfig_v6_poŞ_defšed
)

1539 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
 = 
»mÙe_v6
;

1540 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_»mÙe
 =

1541 
mi
->
cÚ‹xt
.
c1
.
tuÁ­
->
loÿl_v6
;

1542 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_Ãtb™s
 =

1543 
mi
->
cÚ‹xt
.
İtiÚs
.
ifcÚfig_v6_Ãtb™s
;

1544 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_defšed
 = 
Œue
;

1549 
	`msg
(
D_MULTI_ERRORS
, "MULTI:‚o free --ifconfig-pool‡ddresses‡re‡vailable");

1560 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_v6_defšed
)

1562 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
 =

1563 
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_v6_loÿl
;

1564 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_»mÙe
 =

1565 
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_v6_»mÙe
;

1566 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_Ãtb™s
 =

1567 
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_v6_Ãtb™s
;

1568 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_defšed
 = 
Œue
;

1570 
	`msg
Ğ
M_INFO
, "MULTI_sva:…ush_ifconfig_ipv6 %s/%d",

1571 
	`´št_š6_addr
Ğ
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
, 0, &
gc
 ),

1572 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_Ãtb™s
 );

1575 
	`gc_ä“
(&
gc
);

1576 
	}
}

1582 
	$muÉi_£t_vœtu®_addr_’v
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

1584 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_local_ip");

1585 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_remote_ip");

1586 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_netmask");

1588 ià(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_defšed
)

1590 cÚ¡ 
tuÂ–_ty³
 = 
	`TUNNEL_TYPE
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
);

1591 cÚ¡ 
tuÂ–_tİŞogy
 = 
	`TUNNEL_TOPOLOGY
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
);

1593 
	`£‹nv_š_addr_t
(
mi
->
cÚ‹xt
.
c2
.
es
,

1595 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
,

1596 
SA_SET_IF_NONZERO
);

1598 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TAP
 || (tuÂ–_ty³ =ğ
DEV_TYPE_TUN
 && 
tuÂ–_tİŞogy
 =ğ
TOP_SUBNET
))

1600 
	`£‹nv_š_addr_t
(
mi
->
cÚ‹xt
.
c2
.
es
,

1602 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
,

1603 
SA_SET_IF_NONZERO
);

1605 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TUN
)

1607 
	`£‹nv_š_addr_t
(
mi
->
cÚ‹xt
.
c2
.
es
,

1609 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_»mÙe_Ãtmask
,

1610 
SA_SET_IF_NONZERO
);

1614 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_local_ip6");

1615 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_remote_ip6");

1616 
	`£‹nv_d–
(
mi
->
cÚ‹xt
.
c2
.
es
, "ifconfig_pool_ip6_netbits");

1618 ià(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_defšed
)

1620 
	`£‹nv_š6_addr
(
mi
->
cÚ‹xt
.
c2
.
es
,

1622 &
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
,

1623 
SA_SET_IF_NONZERO
);

1624 
	`£‹nv_š6_addr
(
mi
->
cÚ‹xt
.
c2
.
es
,

1626 &
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_»mÙe
,

1627 
SA_SET_IF_NONZERO
);

1628 
	`£‹nv_št
(
mi
->
cÚ‹xt
.
c2
.
es
,

1630 
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_Ãtb™s
);

1632 
	}
}

1638 
	$muÉi_ş›Á_cÚÃù_po¡
(
muÉi_cÚ‹xt
 *
m
,

1639 
muÉi_š¡ªû
 *
mi
,

1640 cÚ¡ *
dc_fe
,

1641 
İtiÚ_³rmissiÚs_mask
,

1642 *
İtiÚ_ty³s_found
)

1645 ià(
	`‹¡_fe
(
dc_fe
))

1647 
	`İtiÚs_£rv”_impÜt
(&
mi
->
cÚ‹xt
.
İtiÚs
,

1648 
dc_fe
,

1649 
D_IMPORT_ERRORS
|
M_OPTERR
,

1650 
İtiÚ_³rmissiÚs_mask
,

1651 
İtiÚ_ty³s_found
,

1652 
mi
->
cÚ‹xt
.
c2
.
es
);

1660 
	`muÉi_£Ëù_vœtu®_addr
(
m
, 
mi
);

1661 
	`muÉi_£t_vœtu®_addr_’v
(
m
, 
mi
);

1663 
	}
}

1665 #ifdeà
ENABLE_PLUGIN


1671 
	$muÉi_ş›Á_cÚÃù_po¡_¶ugš
(
muÉi_cÚ‹xt
 *
m
,

1672 
muÉi_š¡ªû
 *
mi
,

1673 cÚ¡ 
¶ugš_»tuº
 *
´
,

1674 
İtiÚ_³rmissiÚs_mask
,

1675 *
İtiÚ_ty³s_found
)

1677 
¶ugš_»tuº
 
cÚfig
;

1679 
	`¶ugš_»tuº_g‘_cŞumn
(
´
, &
cÚfig
, "config");

1682 ià(
	`¶ugš_»tuº_defšed
(&
cÚfig
))

1684 
i
;

1685 
i
 = 0; i < 
cÚfig
.
n
; ++i)

1687 ià(
cÚfig
.
li¡
[
i
] && cÚfig.li¡[i]->
v®ue
)

1689 
	`İtiÚs_¡ršg_impÜt
(&
mi
->
cÚ‹xt
.
İtiÚs
,

1690 
cÚfig
.
li¡
[
i
]->
v®ue
,

1691 
D_IMPORT_ERRORS
|
M_OPTERR
,

1692 
İtiÚ_³rmissiÚs_mask
,

1693 
İtiÚ_ty³s_found
,

1694 
mi
->
cÚ‹xt
.
c2
.
es
);

1704 
	`muÉi_£Ëù_vœtu®_addr
(
m
, 
mi
);

1705 
	`muÉi_£t_vœtu®_addr_’v
(
m
, 
mi
);

1707 
	}
}

1711 #ifdeà
MANAGEMENT_DEF_AUTH


1717 
	$muÉi_ş›Á_cÚÃù_mda
(
muÉi_cÚ‹xt
 *
m
,

1718 
muÉi_š¡ªû
 *
mi
,

1719 cÚ¡ 
bufãr_li¡
 *
cÚfig
,

1720 
İtiÚ_³rmissiÚs_mask
,

1721 *
İtiÚ_ty³s_found
)

1723 ià(
cÚfig
)

1725 
bufãr_’Œy
 *
be
;

1727 
be
 = 
cÚfig
->
h—d
; b!ğ
NULL
; bğbe->
Ãxt
)

1729 cÚ¡ *
İt
 = 
	`BSTR
(&
be
->
buf
);

1730 
	`İtiÚs_¡ršg_impÜt
(&
mi
->
cÚ‹xt
.
İtiÚs
,

1731 
İt
,

1732 
D_IMPORT_ERRORS
|
M_OPTERR
,

1733 
İtiÚ_³rmissiÚs_mask
,

1734 
İtiÚ_ty³s_found
,

1735 
mi
->
cÚ‹xt
.
c2
.
es
);

1744 
	`muÉi_£Ëù_vœtu®_addr
(
m
, 
mi
);

1745 
	`muÉi_£t_vœtu®_addr_’v
(
m
, 
mi
);

1747 
	}
}

1752 
	$muÉi_ş›Á_cÚÃù_£‹nv
(
muÉi_cÚ‹xt
 *
m
,

1753 
muÉi_š¡ªû
 *
mi
)

1755 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1758 
	`£‹nv_¡r
(
mi
->
cÚ‹xt
.
c2
.
es
, "commÚ_Çme", 
	`s_commÚ_Çme
(mi->cÚ‹xt.c2.
s_muÉi
, 
Œue
));

1761 
	`£‹nv_Œu¡ed
(
mi
->
cÚ‹xt
.
c2
.
es
, 
	`g‘_lšk_sock‘_šfo
(&mi->context));

1764 
	`muÉi_£t_vœtu®_addr_’v
(
m
, 
mi
);

1768 cÚ¡ *
ü—‹d_ascii
 = 
	`time_¡ršg
(
mi
->
ü—‹d
, 0, 
çl£
, &
gc
);

1769 
	`£‹nv_¡r
(
mi
->
cÚ‹xt
.
c2
.
es
, "time_ascii", 
ü—‹d_ascii
);

1770 
	`£‹nv_unsigÃd
(
mi
->
cÚ‹xt
.
c2
.
es
, "time_unix", ()mi->
ü—‹d
);

1773 
	`gc_ä“
(&
gc
);

1774 
	}
}

1786 
	$muÉi_cÚÃùiÚ_e¡ablished
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

1788 ià(
	`s_auth’tiÿtiÚ_¡©us
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 0è=ğ
TLS_AUTHENTICATION_SUCCEEDED
)

1790 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1791 
İtiÚ_ty³s_found
 = 0;

1793 cÚ¡ 
İtiÚ_³rmissiÚs_mask
 =

1794 
OPT_P_INSTANCE


1795 | 
OPT_P_INHERIT


1796 | 
OPT_P_PUSH


1797 | 
OPT_P_TIMER


1798 | 
OPT_P_CONFIG


1799 | 
OPT_P_ECHO


1800 | 
OPT_P_COMP


1801 | 
OPT_P_SOCKFLAGS
;

1803 
cc_sucûeded
 = 
Œue
;

1804 
cc_sucûeded_couÁ
 = 0;

1806 
	`ASSERT
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
);

1809 
	`s_lock_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
);

1810 
	`s_lock_û¹_hash_£t
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
);

1813 
	`g’”©e_´efix
(
mi
);

1816 ià(!
mi
->
cÚ‹xt
.
İtiÚs
.
du¶iÿ‹_ú
)

1818 
	`muÉi_d–‘e_dup
(
m
, 
mi
);

1822 
mi
->
vaddr_hªdË
 = -1;

1828 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_cÚfig_dœ
)

1830 cÚ¡ *
ccd_fe
;

1832 
ccd_fe
 = 
	`g’_·th
(
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_cÚfig_dœ
,

1833 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

1834 &
gc
);

1837 ià(
	`‹¡_fe
(
ccd_fe
))

1839 
	`İtiÚs_£rv”_impÜt
(&
mi
->
cÚ‹xt
.
İtiÚs
,

1840 
ccd_fe
,

1841 
D_IMPORT_ERRORS
|
M_OPTERR
,

1842 
İtiÚ_³rmissiÚs_mask
,

1843 &
İtiÚ_ty³s_found
,

1844 
mi
->
cÚ‹xt
.
c2
.
es
);

1848 
ccd_fe
 = 
	`g’_·th
(
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_cÚfig_dœ
,

1849 
CCD_DEFAULT
,

1850 &
gc
);

1852 ià(
	`‹¡_fe
(
ccd_fe
))

1854 
	`İtiÚs_£rv”_impÜt
(&
mi
->
cÚ‹xt
.
İtiÚs
,

1855 
ccd_fe
,

1856 
D_IMPORT_ERRORS
|
M_OPTERR
,

1857 
İtiÚ_³rmissiÚs_mask
,

1858 &
İtiÚ_ty³s_found
,

1859 
mi
->
cÚ‹xt
.
c2
.
es
);

1868 
	`muÉi_£Ëù_vœtu®_addr
(
m
, 
mi
);

1871 
	`muÉi_ş›Á_cÚÃù_£‹nv
(
m
, 
mi
);

1873 #ifdeà
ENABLE_PLUGIN


1879 ià(
	`¶ugš_defšed
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_CONNECT
))

1881 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1882 cÚ¡ *
dc_fe
 = 
	`ü—‹_‹mp_fe
(
mi
->
cÚ‹xt
.
İtiÚs
.
tmp_dœ
, "cc", &
gc
);

1884 ià(!
dc_fe
)

1886 
cc_sucûeded
 = 
çl£
;

1887 
süt_d•r_çed
;

1890 
	`¬gv_´štf
(&
¬gv
, "%s", 
dc_fe
);

1891 ià(
	`¶ugš_ÿÎ
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_CONNECT
, &
¬gv
, 
NULL
, mi->cÚ‹xt.
c2
.
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1893 
	`msg
(
M_WARN
, "WARNING: client-connect…lugin call failed");

1894 
cc_sucûeded
 = 
çl£
;

1898 
	`muÉi_ş›Á_cÚÃù_po¡
(
m
, 
mi
, 
dc_fe
, 
İtiÚ_³rmissiÚs_mask
, &
İtiÚ_ty³s_found
);

1899 ++
cc_sucûeded_couÁ
;

1902 ià(!
	`¶©fÜm_uÆšk
(
dc_fe
))

1904 
	`msg
(
D_MULTI_ERRORS
, "MULTI:…roblem deletingemporary file: %s",

1905 
dc_fe
);

1908 
süt_d•r_çed
:

1909 
	`¬gv_»£t
(&
¬gv
);

1913 ià(
	`¶ugš_defšed
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
))

1915 
¶ugš_»tuº
 
´
;

1917 
	`¶ugš_»tuº_š™
(&
´
);

1919 ià(
	`¶ugš_ÿÎ
(
mi
->
cÚ‹xt
.
¶ugšs
, 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
, 
NULL
, &
´
, mi->cÚ‹xt.
c2
.
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

1921 
	`msg
(
M_WARN
, "WARNING: client-connect-v2…lugin call failed");

1922 
cc_sucûeded
 = 
çl£
;

1926 
	`muÉi_ş›Á_cÚÃù_po¡_¶ugš
(
m
, 
mi
, &
´
, 
İtiÚ_³rmissiÚs_mask
, &
İtiÚ_ty³s_found
);

1927 ++
cc_sucûeded_couÁ
;

1930 
	`¶ugš_»tuº_ä“
(&
´
);

1937 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_cÚÃù_süt
 && 
cc_sucûeded
)

1939 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1940 cÚ¡ *
dc_fe
 = 
NULL
;

1942 
	`£‹nv_¡r
(
mi
->
cÚ‹xt
.
c2
.
es
, "script_type", "client-connect");

1944 
dc_fe
 = 
	`ü—‹_‹mp_fe
(
mi
->
cÚ‹xt
.
İtiÚs
.
tmp_dœ
, "cc", &
gc
);

1945 ià(!
dc_fe
)

1947 
cc_sucûeded
 = 
çl£
;

1948 
süt_çed
;

1951 
	`¬gv_·r£_cmd
(&
¬gv
, 
mi
->
cÚ‹xt
.
İtiÚs
.
ş›Á_cÚÃù_süt
);

1952 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
dc_fe
);

1954 ià(
	`İ’v²_run_süt
(&
¬gv
, 
mi
->
cÚ‹xt
.
c2
.
es
, 0, "--client-connect"))

1956 
	`muÉi_ş›Á_cÚÃù_po¡
(
m
, 
mi
, 
dc_fe
, 
İtiÚ_³rmissiÚs_mask
, &
İtiÚ_ty³s_found
);

1957 ++
cc_sucûeded_couÁ
;

1961 
cc_sucûeded
 = 
çl£
;

1964 ià(!
	`¶©fÜm_uÆšk
(
dc_fe
))

1966 
	`msg
(
D_MULTI_ERRORS
, "MULTI:…roblem deletingemporary file: %s",

1967 
dc_fe
);

1970 
süt_çed
:

1971 
	`¬gv_»£t
(&
¬gv
);

1977 #ifdeà
MANAGEMENT_DEF_AUTH


1978 ià(
cc_sucûeded
 && 
mi
->
cc_cÚfig
)

1980 
	`muÉi_ş›Á_cÚÃù_mda
(
m
, 
mi
, mi->
cc_cÚfig
, 
İtiÚ_³rmissiÚs_mask
, &
İtiÚ_ty³s_found
);

1981 ++
cc_sucûeded_couÁ
;

1989 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
di§bË
)

1991 
	`msg
(
D_MULTI_ERRORS
, "MULTI: client has been„ejected dueo 'disable' directive");

1992 
cc_sucûeded
 = 
çl£
;

1993 
cc_sucûeded_couÁ
 = 0;

1996 ià(
cc_sucûeded
)

2001 
	`do_deã¼ed_İtiÚs
(&
mi
->
cÚ‹xt
, 
İtiÚ_ty³s_found
);

2006 ià(!
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_defšed
)

2008 
	`msg
(
D_MULTI_ERRORS
, "MULTI:‚o dynamic or static„emote --ifconfig‡ddress is‡vailable for %s",

2009 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

2015 ià(!
	`ifcÚfig_push_cÚ¡¿št_§tisf›d
(&
mi
->
cÚ‹xt
))

2018 
	`msg
(
D_MULTI_ERRORS
, "MULTI ERROR:…rimary virtual IP for %s (%s) violatesunnel‚etwork/netmask constraint (%s/%s)",

2019 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
),

2020 
	`´št_š_addr_t
(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
, 0, &
gc
),

2021 
	`´št_š_addr_t
(
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_cÚ¡¿št_ÃtwÜk
, 0, &
gc
),

2022 
	`´št_š_addr_t
(
mi
->
cÚ‹xt
.
İtiÚs
.
push_ifcÚfig_cÚ¡¿št_Ãtmask
, 0, &
gc
));

2029 ià(
	`TUNNEL_TYPE
(
mi
->
cÚ‹xt
.
c1
.
tuÁ­
è=ğ
DEV_TYPE_TUN
)

2031 ià(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_defšed
)

2033 
	`muÉi_Ë¬n_š_addr_t
(
m
, 
mi
, mi->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
, -1, 
Œue
);

2034 
	`msg
(
D_MULTI_LOW
, "MULTI:…rimary virtual IP for %s: %s",

2035 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
),

2036 
	`´št_š_addr_t
(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
, 0, &
gc
));

2039 ià(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_defšed
)

2041 
	`muÉi_Ë¬n_š6_addr
(
m
, 
mi
, mi->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
, -1, 
Œue
);

2043 
	`msg
(
D_MULTI_LOW
, "MULTI:…rimary virtual IPv6 for %s: %s",

2044 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
),

2045 
	`´št_š6_addr
(
mi
->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
, 0, &
gc
));

2050 
	`muÉi_add_œou‹s
(
m
, 
mi
);

2057 
	`»move_œou‹s_äom_push_rou‹_li¡
(&
mi
->
cÚ‹xt
.
İtiÚs
);

2059 ià(
mi
->
cÚ‹xt
.
İtiÚs
.
œou‹s
)

2061 
	`msg
(
D_MULTI_ERRORS
, "MULTI: --iroute options„ejected for %s -- iroute only works withun-styleunnels",

2062 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

2066 
mi
->
»pÜtšg_addr
 = mi->
cÚ‹xt
.
c2
.
push_ifcÚfig_loÿl
;

2067 
mi
->
»pÜtšg_addr_v6
 = mi->
cÚ‹xt
.
c2
.
push_ifcÚfig_v6_loÿl
;

2070 
mi
->
cÚ‹xt
.
c2
.
cÚ‹xt_auth
 = 
CAS_SUCCEEDED
;

2072 #ifdeà
ENABLE_ASYNC_PUSH


2074 ià(
mi
->
cÚ‹xt
.
c2
.
push_»que¡_»ûived
)

2076 
	`´oûss_šcomšg_push_»que¡
(&
mi
->
cÚ‹xt
);

2083 
mi
->
cÚ‹xt
.
c2
.
cÚ‹xt_auth
 = 
cc_sucûeded_couÁ
 ? 
CAS_PARTIAL
 : 
CAS_FAILED
;

2087 
mi
->
cÚÃùiÚ_e¡ablished_æag
 = 
Œue
;

2090 ++
m
->
n_ş›Ás
;

2091 
	`upd©e_m¡©_n_ş›Ás
(
m
->
n_ş›Ás
);

2092 --
mi
->
n_ş›Ás_d–
;

2094 #ifdeà
MANAGEMENT_DEF_AUTH


2095 ià(
mªagem’t
)

2097 
	`mªagem’t_cÚÃùiÚ_e¡ablished
(
mªagem’t
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
, mi->cÚ‹xt.c2.
es
);

2101 
	`gc_ä“
(&
gc
);

2107 
mi
->
cÚ‹xt
.
c2
.
push_»¶y_deã¼ed
 = 
çl£
;

2108 
	}
}

2110 #ifdeà
ENABLE_ASYNC_PUSH


2116 
	$muÉi_´oûss_fe_şo£d
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

2118 
bufãr
[
INOTIFY_EVENT_BUFFER_SIZE
];

2119 
size_t
 
bufãr_i
 = 0;

2120 
r
 = 
	`»ad
(
m
->
tİ
.
c2
.
šÙify_fd
, 
bufãr
, 
INOTIFY_EVENT_BUFFER_SIZE
);

2122 
bufãr_i
 < 
r
)

2125 
šÙify_ev’t
 *
³v’t
 = (šÙify_ev’ˆ*è&
bufãr
[
bufãr_i
];

2126 
size_t
 
ev’t_size
 = (
šÙify_ev’t
è+ 
³v’t
->
Ën
;

2127 
bufãr_i
 +ğ
ev’t_size
;

2129 
	`msg
(
D_MULTI_DEBUG
, "MULTI: modif›d fd %d, mask %d", 
³v’t
->
wd
,…ev’t->
mask
);

2131 
muÉi_š¡ªû
 *
mi
 = 
	`hash_lookup
(
m
->
šÙify_w©ch”s
, (*è(è
³v’t
->
wd
);

2133 ià(
³v’t
->
mask
 & 
IN_CLOSE_WRITE
)

2135 ià(
mi
)

2138 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

2142 
	`msg
(
D_MULTI_ERRORS
, "MULTI: multi_instance‚ot found!");

2145 ià(
³v’t
->
mask
 & 
IN_IGNORED
)

2148 ià(
mi
)

2150 
	`hash_»move
(
m
->
šÙify_w©ch”s
, (*è(è
³v’t
->
wd
);

2151 
mi
->
šÙify_w©ch
 = -1;

2156 
	`msg
(
D_MULTI_ERRORS
, "MULTI: unknowÀmask %d", 
³v’t
->
mask
);

2159 
	}
}

2167 
	$muÉi_add_mbuf
(
muÉi_cÚ‹xt
 *
m
,

2168 
muÉi_š¡ªû
 *
mi
,

2169 
mbuf_bufãr
 *
mb
)

2171 ià(
	`muÉi_ouut_queue_»ady
(
m
, 
mi
))

2173 
mbuf_™em
 
™em
;

2174 
™em
.
bufãr
 = 
mb
;

2175 
™em
.
š¡ªû
 = 
mi
;

2176 
	`mbuf_add_™em
(
m
->
mbuf
, &
™em
);

2180 
	`msg
(
D_MULTI_DROPPED
, "MULTI:…acket dropped dueo output saturation (multi_add_mbuf)");

2182 
	}
}

2187 
šlše
 

2188 
	$muÉi_uniÿ¡
(
muÉi_cÚ‹xt
 *
m
,

2189 cÚ¡ 
bufãr
 *
buf
,

2190 
muÉi_š¡ªû
 *
mi
)

2192 
mbuf_bufãr
 *
mb
;

2194 ià(
	`BLEN
(
buf
) > 0)

2196 
mb
 = 
	`mbuf_®loc_buf
(
buf
);

2197 
mb
->
æags
 = 
MF_UNICAST
;

2198 
	`muÉi_add_mbuf
(
m
, 
mi
, 
mb
);

2199 
	`mbuf_ä“_buf
(
mb
);

2201 
	}
}

2207 
	$muÉi_bÿ¡
(
muÉi_cÚ‹xt
 *
m
,

2208 cÚ¡ 
bufãr
 *
buf
,

2209 cÚ¡ 
muÉi_š¡ªû
 *
£nd”_š¡ªû
,

2210 cÚ¡ 
mrou‹_addr
 *
£nd”_addr
)

2212 
hash_™”©Ü
 
hi
;

2213 
hash_–em’t
 *
he
;

2214 
muÉi_š¡ªû
 *
mi
;

2215 
mbuf_bufãr
 *
mb
;

2217 ià(
	`BLEN
(
buf
) > 0)

2219 
	`³rf_push
(
PERF_MULTI_BCAST
);

2220 #ifdeà
MULTI_DEBUG_EVENT_LOOP


2221 
	`´štf
("BCAST†’=%d\n", 
	`BLEN
(
buf
));

2223 
mb
 = 
	`mbuf_®loc_buf
(
buf
);

2224 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

2226 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

2228 
mi
 = (
muÉi_š¡ªû
 *è
he
->
v®ue
;

2229 ià(
mi
 !ğ
£nd”_š¡ªû
 && !mi->
h®t
)

2231 #ifdeà
ENABLE_PF


2232 ià(
£nd”_š¡ªû
)

2234 ià(!
	`pf_c2c_‹¡
(&
£nd”_š¡ªû
->
cÚ‹xt
, &
mi
->context, "bcast_c2c"))

2236 
	`msg
(
D_PF_DROPPED_BCAST
, "PF: client[%s] -> client[%s]…acket dropped by BCAST…acket filter",

2237 
	`mi_´efix
(
£nd”_š¡ªû
),

2238 
	`mi_´efix
(
mi
));

2242 ià(
£nd”_addr
)

2244 ià(!
	`pf_addr_‹¡
(&
mi
->
cÚ‹xt
, 
£nd”_addr
, "bcast_src_addr"))

2246 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2247 
	`msg
(
D_PF_DROPPED_BCAST
, "PF:‡ddr[%s] -> client[%s]…acket dropped by BCAST…acket filter",

2248 
	`mrou‹_addr_´št_ex
(
£nd”_addr
, 
MAPF_SHOW_ARP
, &
gc
),

2249 
	`mi_´efix
(
mi
));

2250 
	`gc_ä“
(&
gc
);

2255 
	`muÉi_add_mbuf
(
m
, 
mi
, 
mb
);

2259 
	`hash_™”©Ü_ä“
(&
hi
);

2260 
	`mbuf_ä“_buf
(
mb
);

2261 
	`³rf_pİ
();

2263 
	}
}

2276 
šlše
 

2277 
	$compu‹_wakeup_sigma
(cÚ¡ 
timev®
 *
d–
)

2279 ià(
d–
->
tv_£c
 < 1)

2282  
d–
->
tv_u£c
 >> 3;

2287 ià(
d–
->
tv_£c
 < 600)

2289  
d–
->
tv_£c
 << 17;

2296 
	}
}

2299 
	$muÉi_scheduË_cÚ‹xt_wakeup
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

2302 
	`ASSERT
(!
	`İ’v²_g‘timeofday
(&
mi
->
wakeup
, 
NULL
));

2303 
	`tv_add
(&
mi
->
wakeup
, &mi->
cÚ‹xt
.
c2
.
timev®
);

2306 
	`scheduË_add_’Œy
(
m
->
scheduË
,

2307 (
scheduË_’Œy
 *è
mi
,

2308 &
mi
->
wakeup
,

2309 
	`compu‹_wakeup_sigma
(&
mi
->
cÚ‹xt
.
c2
.
timev®
));

2310 
	}
}

2319 
boŞ


2320 
	$muÉi_´oûss_po¡
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
æags
)

2322 
boŞ
 
»t
 = 
Œue
;

2324 ià(!
	`IS_SIG
(&
mi
->
cÚ‹xt
è&& ((
æags
 & 
MPP_PRE_SELECT
è|| ((æag & 
MPP_CONDITIONAL_PRE_SELECT
è&& !
	`ANY_OUT
(&mi->context))))

2326 #ià
	`defšed
(
ENABLE_ASYNC_PUSH
è&& defšed(
ENABLE_DEF_AUTH
)

2327 
boŞ
 
was_auth’tiÿ‹d
 = 
çl£
;

2328 
key_¡©e
 *
ks
 = 
NULL
;

2329 ià(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
)

2331 
ks
 = &
mi
->
cÚ‹xt
.
c2
.
s_muÉi
->
£ssiÚ
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

2332 
was_auth’tiÿ‹d
 = 
ks
->
auth’tiÿ‹d
;

2338 
	`´e_£Ëù
(&
mi
->
cÚ‹xt
);

2340 #ià
	`defšed
(
ENABLE_ASYNC_PUSH
è&& defšed(
ENABLE_DEF_AUTH
)

2341 ià(
ks
 && ks->
auth_cÚŒŞ_fe
 && ks->
auth_deã¼ed
 && !
was_auth’tiÿ‹d
)

2344 
w©ch_desütÜ
 = 
	`šÙify_add_w©ch
(
m
->
tİ
.
c2
.
šÙify_fd
, 
ks
->
auth_cÚŒŞ_fe
, 
IN_CLOSE_WRITE
 | 
IN_ONESHOT
);

2345 ià(
w©ch_desütÜ
 >= 0)

2347 ià(
mi
->
šÙify_w©ch
 != -1)

2349 
	`hash_»move
(
m
->
šÙify_w©ch”s
, (*è()
mi
->
šÙify_w©ch
);

2351 
	`hash_add
(
m
->
šÙify_w©ch”s
, (cÚ¡ 
ušŒ_t
 *)
w©ch_desütÜ
, 
mi
, 
Œue
);

2352 
mi
->
šÙify_w©ch
 = 
w©ch_desütÜ
;

2356 
	`msg
(
M_NONFATAL
 | 
M_ERRNO
, "MULTI: inotify_add_watchƒrror");

2361 ià(!
	`IS_SIG
(&
mi
->
cÚ‹xt
))

2365 ià(!
mi
->
cÚÃùiÚ_e¡ablished_æag
 && 
	`CONNECTION_ESTABLISHED
(&mi->
cÚ‹xt
))

2367 
	`muÉi_cÚÃùiÚ_e¡ablished
(
m
, 
mi
);

2371 
	`muÉi_scheduË_cÚ‹xt_wakeup
(
m
, 
mi
);

2375 ià(
	`IS_SIG
(&
mi
->
cÚ‹xt
))

2377 ià(
æags
 & 
MPP_CLOSE_ON_SIGNAL
)

2379 
	`muÉi_şo£_š¡ªû_Ú_sigÇl
(
m
, 
mi
);

2380 
»t
 = 
çl£
;

2386 
	`muÉi_£t_³ndšg
(
m
, 
	`ANY_OUT
(&
mi
->
cÚ‹xt
è? m˜: 
NULL
);

2388 #ifdeà
MULTI_DEBUG_EVENT_LOOP


2389 
	`´štf
("POST %s[%d]o=%d†o=%d/%d w=%d/%d\n",

2390 
	`id
(
mi
),

2391 (è(
mi
 =ğ
m
->
³ndšg
),

2392 
mi
 ? mi->
cÚ‹xt
.
c2
.
to_tun
.
Ën
 : -1,

2393 
mi
 ? mi->
cÚ‹xt
.
c2
.
to_lšk
.
Ën
 : -1,

2394 (
mi
 && mi->
cÚ‹xt
.
c2
.
äagm’t
è? mi->cÚ‹xt.c2.äagm’t->
outgošg
.
Ën
 : -1,

2395 ()
mi
->
cÚ‹xt
.
c2
.
timev®
.
tv_£c
,

2396 ()
mi
->
cÚ‹xt
.
c2
.
timev®
.
tv_u£c
);

2400 ià((
æags
 & 
MPP_RECORD_TOUCH
è&& 
m
->
mµ_touched
)

2402 *
m
->
mµ_touched
 = 
mi
;

2405  
»t
;

2406 
	}
}

2409 
	$muÉi_´oûss_æßt
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

2411 
mrou‹_addr
 
»®
;

2412 
hash
 *hash = 
m
->hash;

2413 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2415 ià(!
	`mrou‹_exŒaù_İ’v²_sockaddr
(&
»®
, &
m
->
tİ
.
c2
.
äom
.
de¡
, 
Œue
))

2417 
dÚe
;

2420 cÚ¡ 
ušt32_t
 
hv
 = 
	`hash_v®ue
(
hash
, &
»®
);

2421 
hash_buck‘
 *
buck‘
 = 
	`hash_buck‘
(
hash
, 
hv
);

2424 
hash_–em’t
 *
he
 = 
	`hash_lookup_ç¡
(
hash
, 
buck‘
, &
»®
, 
hv
);

2425 ià(
he
)

2427 
muÉi_š¡ªû
 *
ex_mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

2429 
s_muÉi
 *
m1
 = 
mi
->
cÚ‹xt
.
c2
.tls_multi;

2430 
s_muÉi
 *
m2
 = 
ex_mi
->
cÚ‹xt
.
c2
.tls_multi;

2433 ià(!
	`û¹_hash_com·»
(
m1
->
locked_û¹_hash_£t
, 
m2
->locked_cert_hash_set))

2435 
	`msg
(
D_MULTI_LOW
, "Disallow floato‡n‡ddressaken by‡nother client %s",

2436 
	`muÉi_š¡ªû_¡ršg
(
ex_mi
, 
çl£
, &
gc
));

2438 
mi
->
cÚ‹xt
.
c2
.
buf
.
Ën
 = 0;

2440 
dÚe
;

2443 
	`msg
(
D_MULTI_MEDIUM
, "şosšg in¡ªû %s", 
	`muÉi_š¡ªû_¡ršg
(
ex_mi
, 
çl£
, &
gc
));

2444 
	`muÉi_şo£_š¡ªû
(
m
, 
ex_mi
, 
çl£
);

2447 
	`msg
(
D_MULTI_MEDIUM
, "³” %" 
PRIu32
 " (%s) floated from %so %s",

2448 
mi
->
cÚ‹xt
.
c2
.
s_muÉi
->
³”_id
,

2449 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
),

2450 
	`mrou‹_addr_´št
(&
mi
->
»®
, &
gc
),

2451 
	`´št_lšk_sock‘_aùu®
(&
m
->
tİ
.
c2
.
äom
, &
gc
));

2454 
	`ASSERT
(
	`hash_»move
(
m
->
hash
, &
mi
->
»®
));

2455 
	`ASSERT
(
	`hash_»move
(
m
->
™”
, &
mi
->
»®
));

2458 
mi
->
»®
 =„eal;

2459 
	`g’”©e_´efix
(
mi
);

2461 
mi
->
cÚ‹xt
.
c2
.
äom
 = 
m
->
tİ
.c2.from;

2462 
mi
->
cÚ‹xt
.
c2
.
to_lšk_addr
 = &mi->cÚ‹xt.c2.
äom
;

2465 
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘
 = 
m
->
tİ
.c2.link_socket;

2466 
mi
->
cÚ‹xt
.
c2
.
lšk_sock‘_šfo
->
l§
->
aùu®
 = 
m
->
tİ
.c2.
äom
;

2468 
	`s_upd©e_»mÙe_addr
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, &mi->cÚ‹xt.c2.
äom
);

2470 
	`ASSERT
(
	`hash_add
(
m
->
hash
, &
mi
->
»®
, mi, 
çl£
));

2471 
	`ASSERT
(
	`hash_add
(
m
->
™”
, &
mi
->
»®
, mi, 
çl£
));

2473 #ifdeà
MANAGEMENT_DEF_AUTH


2474 
	`ASSERT
(
	`hash_add
(
m
->
cid_hash
, &
mi
->
cÚ‹xt
.
c2
.
mda_cÚ‹xt
.
cid
, mi, 
Œue
));

2477 
dÚe
:

2478 
	`gc_ä“
(&
gc
);

2479 
	}
}

2485 
boŞ


2486 
	$muÉi_´oûss_šcomšg_lšk
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
š¡ªû
, cÚ¡ 
mµ_æags
)

2488 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2490 
cÚ‹xt
 *
c
;

2491 
mrou‹_addr
 
¤c
, 
de¡
;

2492 
mrou‹_æags
;

2493 
muÉi_š¡ªû
 *
mi
;

2494 
boŞ
 
»t
 = 
Œue
;

2495 
boŞ
 
æß‹d
 = 
çl£
;

2497 ià(
m
->
³ndšg
)

2499  
Œue
;

2502 ià(!
š¡ªû
)

2504 #ifdeà
MULTI_DEBUG_EVENT_LOOP


2505 
	`´štf
("TCP/UDP -> TUN [%d]\n", 
	`BLEN
(&
m
->
tİ
.
c2
.
buf
));

2507 
	`muÉi_£t_³ndšg
(
m
, 
	`muÉi_g‘_ü—‹_š¡ªû_udp
(m, &
æß‹d
));

2511 
	`muÉi_£t_³ndšg
(
m
, 
š¡ªû
);

2514 ià(
m
->
³ndšg
)

2516 
	`£t_´efix
(
m
->
³ndšg
);

2519 
c
 = &
m
->
³ndšg
->
cÚ‹xt
;

2521 ià(!
š¡ªû
)

2524 
c
->
c2
.
buf
 = 
m
->
tİ
.c2.buf;

2527 ià(!
æß‹d
)

2529 
c
->
c2
.
äom
 = 
m
->
tİ
.c2.from;

2533 ià(
	`BLEN
(&
c
->
c2
.
buf
) > 0)

2535 
lšk_sock‘_šfo
 *
lsi
;

2536 cÚ¡ 
ušt8_t
 *
Üig_buf
;

2540 
	`³rf_push
(
PERF_PROC_IN_LINK
);

2541 
lsi
 = 
	`g‘_lšk_sock‘_šfo
(
c
);

2542 
Üig_buf
 = 
c
->
c2
.
buf
.
d©a
;

2543 ià(
	`´oûss_šcomšg_lšk_·¹1
(
c
, 
lsi
, 
æß‹d
))

2545 ià(
æß‹d
)

2547 
	`muÉi_´oûss_æßt
(
m
, m->
³ndšg
);

2550 
	`´oûss_šcomšg_lšk_·¹2
(
c
, 
lsi
, 
Üig_buf
);

2552 
	`³rf_pİ
();

2554 ià(
	`TUNNEL_TYPE
(
m
->
tİ
.
c1
.
tuÁ­
è=ğ
DEV_TYPE_TUN
)

2557 
mrou‹_æags
 = 
	`mrou‹_exŒaù_addr_äom_·ck‘
(&
¤c
,

2558 &
de¡
,

2559 
NULL
,

2560 
NULL
,

2561 &
c
->
c2
.
to_tun
,

2562 
DEV_TYPE_TUN
);

2565 ià(!(
mrou‹_æags
 & 
MROUTE_EXTRACT_SUCCEEDED
))

2567 
c
->
c2
.
to_tun
.
Ën
 = 0;

2570 ià(
	`muÉi_g‘_š¡ªû_by_vœtu®_addr
(
m
, &
¤c
, 
Œue
è!ğm->
³ndšg
)

2573 iàĞ(
¤c
.
ty³
 & 
MR_ADDR_MASK
è=ğ
MR_ADDR_IPV6


2574 && 
	`IN6_IS_ADDR_LINKLOCAL
(&
¤c
.
v6
.
addr
) )

2580 
	`msg
(
D_MULTI_DROPPED
, "MULTI: bad source‡ddress from client [%s],…acket dropped",

2581 
	`mrou‹_addr_´št
(&
¤c
, &
gc
));

2583 
c
->
c2
.
to_tun
.
Ën
 = 0;

2586 ià(
m
->
’abË_c2c
)

2589 ià(
mrou‹_æags
 & 
MROUTE_EXTRACT_MCAST
)

2592 
	`muÉi_bÿ¡
(
m
, &
c
->
c2
.
to_tun
, m->
³ndšg
, 
NULL
);

2596 
	`ASSERT
(!(
mrou‹_æags
 & 
MROUTE_EXTRACT_BCAST
));

2597 
mi
 = 
	`muÉi_g‘_š¡ªû_by_vœtu®_addr
(
m
, &
de¡
, 
Œue
);

2600 ià(
mi
)

2602 #ifdeà
ENABLE_PF


2603 ià(!
	`pf_c2c_‹¡
(
c
, &
mi
->
cÚ‹xt
, "tun_c2c"))

2605 
	`msg
(
D_PF_DROPPED
, "PF: client -> client[%s]…acket dropped by TUN…acket filter",

2606 
	`mi_´efix
(
mi
));

2611 
	`muÉi_uniÿ¡
(
m
, &
c
->
c2
.
to_tun
, 
mi
);

2612 
	`»gi¡”_aùiv™y
(
c
, 
	`BLEN
(&c->
c2
.
to_tun
));

2614 
c
->
c2
.
to_tun
.
Ën
 = 0;

2618 #ifdeà
ENABLE_PF


2619 ià(
c
->
c2
.
to_tun
.
Ën
 && !
	`pf_addr_‹¡
(c, &
de¡
, "tun_dest_addr"))

2621 
	`msg
(
D_PF_DROPPED
, "PF: client ->‡ddr[%s]…acket dropped by TUN…acket filter",

2622 
	`mrou‹_addr_´št_ex
(&
de¡
, 
MAPF_SHOW_ARP
, &
gc
));

2623 
c
->
c2
.
to_tun
.
Ën
 = 0;

2627 ià(
	`TUNNEL_TYPE
(
m
->
tİ
.
c1
.
tuÁ­
è=ğ
DEV_TYPE_TAP
)

2629 #ifdeà
ENABLE_PF


2630 
mrou‹_addr
 
ede¡
;

2631 
	`mrou‹_addr_»£t
(&
ede¡
);

2634 
mrou‹_æags
 = 
	`mrou‹_exŒaù_addr_äom_·ck‘
(&
¤c
,

2635 &
de¡
,

2636 
NULL
,

2637 #ifdeà
ENABLE_PF


2638 &
ede¡
,

2640 
NULL
,

2642 &
c
->
c2
.
to_tun
,

2643 
DEV_TYPE_TAP
);

2645 ià(
mrou‹_æags
 & 
MROUTE_EXTRACT_SUCCEEDED
)

2647 ià(
	`muÉi_Ë¬n_addr
(
m
, m->
³ndšg
, &
¤c
, 0) == m->pending)

2650 ià(
m
->
’abË_c2c
)

2652 ià(
mrou‹_æags
 & (
MROUTE_EXTRACT_BCAST
|
MROUTE_EXTRACT_MCAST
))

2654 
	`muÉi_bÿ¡
(
m
, &
c
->
c2
.
to_tun
, m->
³ndšg
, 
NULL
);

2658 
mi
 = 
	`muÉi_g‘_š¡ªû_by_vœtu®_addr
(
m
, &
de¡
, 
çl£
);

2661 ià(
mi
)

2663 #ifdeà
ENABLE_PF


2664 ià(!
	`pf_c2c_‹¡
(
c
, &
mi
->
cÚ‹xt
, "tap_c2c"))

2666 
	`msg
(
D_PF_DROPPED
, "PF: client -> client[%s]…acket dropped by TAP…acket filter",

2667 
	`mi_´efix
(
mi
));

2672 
	`muÉi_uniÿ¡
(
m
, &
c
->
c2
.
to_tun
, 
mi
);

2673 
	`»gi¡”_aùiv™y
(
c
, 
	`BLEN
(&c->
c2
.
to_tun
));

2675 
c
->
c2
.
to_tun
.
Ën
 = 0;

2679 #ifdeà
ENABLE_PF


2680 ià(
c
->
c2
.
to_tun
.
Ën
 && !
	`pf_addr_‹¡
(c, &
ede¡
, "tap_dest_addr"))

2682 
	`msg
(
D_PF_DROPPED
, "PF: client ->‡ddr[%s]…acket dropped by TAP…acket filter",

2683 
	`mrou‹_addr_´št_ex
(&
ede¡
, 
MAPF_SHOW_ARP
, &
gc
));

2684 
c
->
c2
.
to_tun
.
Ën
 = 0;

2690 
	`msg
(
D_MULTI_DROPPED
, "MULTI: bad source‡ddress from client [%s],…acket dropped",

2691 
	`mrou‹_addr_´št
(&
¤c
, &
gc
));

2692 
c
->
c2
.
to_tun
.
Ën
 = 0;

2697 
c
->
c2
.
to_tun
.
Ën
 = 0;

2703 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, m->
³ndšg
, 
mµ_æags
);

2705 
	`ş—r_´efix
();

2708 
	`gc_ä“
(&
gc
);

2709  
»t
;

2710 
	}
}

2716 
boŞ


2717 
	$muÉi_´oûss_šcomšg_tun
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

2719 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2720 
boŞ
 
»t
 = 
Œue
;

2722 ià(
	`BLEN
(&
m
->
tİ
.
c2
.
buf
) > 0)

2724 
mrou‹_æags
;

2725 
mrou‹_addr
 
¤c
, 
de¡
;

2726 cÚ¡ 
dev_ty³
 = 
	`TUNNEL_TYPE
(
m
->
tİ
.
c1
.
tuÁ­
);

2728 #ifdeà
ENABLE_PF


2729 
mrou‹_addr
 
e¤c
, *
e1
, *
e2
;

2730 ià(
dev_ty³
 =ğ
DEV_TYPE_TUN
)

2732 
e1
 = 
NULL
;

2733 
e2
 = &
¤c
;

2737 
e1
 = 
e2
 = &
e¤c
;

2738 
	`mrou‹_addr_»£t
(&
e¤c
);

2742 #ifdeà
MULTI_DEBUG_EVENT_LOOP


2743 
	`´štf
("TUN -> TCP/UDP [%d]\n", 
	`BLEN
(&
m
->
tİ
.
c2
.
buf
));

2746 ià(
m
->
³ndšg
)

2748  
Œue
;

2756 
mrou‹_æags
 = 
	`mrou‹_exŒaù_addr_äom_·ck‘
(&
¤c
,

2757 &
de¡
,

2758 #ifdeà
ENABLE_PF


2759 
e1
,

2761 
NULL
,

2763 
NULL
,

2764 &
m
->
tİ
.
c2
.
buf
,

2765 
dev_ty³
);

2767 ià(
mrou‹_æags
 & 
MROUTE_EXTRACT_SUCCEEDED
)

2769 
cÚ‹xt
 *
c
;

2772 ià(
mrou‹_æags
 & (
MROUTE_EXTRACT_BCAST
|
MROUTE_EXTRACT_MCAST
))

2775 #ifdeà
ENABLE_PF


2776 
	`muÉi_bÿ¡
(
m
, &m->
tİ
.
c2
.
buf
, 
NULL
, 
e2
);

2778 
	`muÉi_bÿ¡
(
m
, &m->
tİ
.
c2
.
buf
, 
NULL
, NULL);

2783 
	`muÉi_£t_³ndšg
(
m
, 
	`muÉi_g‘_š¡ªû_by_vœtu®_addr
(m, &
de¡
, 
dev_ty³
 =ğ
DEV_TYPE_TUN
));

2785 ià(
m
->
³ndšg
)

2788 
c
 = &
m
->
³ndšg
->
cÚ‹xt
;

2790 
	`£t_´efix
(
m
->
³ndšg
);

2792 #ifdeà
ENABLE_PF


2793 ià(!
	`pf_addr_‹¡
(
c
, 
e2
, "tun_tap_src_addr"))

2795 
	`msg
(
D_PF_DROPPED
, "PF:‡ddr[%s] -> client…acket dropped by…acket filter",

2796 
	`mrou‹_addr_´št_ex
(&
¤c
, 
MAPF_SHOW_ARP
, &
gc
));

2797 
	`buf_»£t_Ën
(&
c
->
c2
.
buf
);

2802 ià(
	`muÉi_ouut_queue_»ady
(
m
, m->
³ndšg
))

2805 
c
->
c2
.
buf
 = 
m
->
tİ
.c2.buf;

2810 
	`msg
(
D_MULTI_DROPPED
, "MULTI:…acket dropped dueo output saturation (multi_process_incoming_tun)");

2811 
	`buf_»£t_Ën
(&
c
->
c2
.
buf
);

2816 
	`´oûss_šcomšg_tun
(
c
);

2819 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, m->
³ndšg
, 
mµ_æags
);

2821 
	`ş—r_´efix
();

2826 
	`gc_ä“
(&
gc
);

2827  
»t
;

2828 
	}
}

2834 
muÉi_š¡ªû
 *

2835 
	$muÉi_g‘_queue
(
mbuf_£t
 *
ms
)

2837 
mbuf_™em
 
™em
;

2839 ià(
	`mbuf_exŒaù_™em
(
ms
, &
™em
))

2841 
p_æags
 = 
PIPV4_PASSTOS
;

2843 
	`£t_´efix
(
™em
.
š¡ªû
);

2844 
™em
.
š¡ªû
->
cÚ‹xt
.
c2
.
buf
 = i‹m.
bufãr
->buf;

2845 ià(
™em
.
bufãr
->
æags
 & 
MF_UNICAST
)

2847 
p_æags
 |ğ
PIP_MSSFIX
;

2849 
	`´oûss__h—d”
(&
™em
.
š¡ªû
->
cÚ‹xt
, 
p_æags
, &™em.š¡ªû->cÚ‹xt.
c2
.
buf
);

2850 
	`’üy±_sign
(&
™em
.
š¡ªû
->
cÚ‹xt
, 
Œue
);

2851 
	`mbuf_ä“_buf
(
™em
.
bufãr
);

2853 
	`dmsg
(
D_MULTI_DEBUG
, "MULTI: C2C/MCAST/BCAST");

2855 
	`ş—r_´efix
();

2856  
™em
.
š¡ªû
;

2860  
NULL
;

2862 
	}
}

2868 
boŞ


2869 
	$muÉi_´oûss_timeout
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

2871 
boŞ
 
»t
 = 
Œue
;

2873 #ifdeà
MULTI_DEBUG_EVENT_LOOP


2874 
	`´štf
("% -> TIMEOUT\n", 
	`id
(
m
->
—¾›¡_wakeup
));

2878 ià(
m
->
—¾›¡_wakeup
)

2880 ià(
m
->
—¾›¡_wakeup
 =ğ(
muÉi_š¡ªû
 *)&m->
deã¼ed_shutdown_sigÇl
)

2882 
	`scheduË_»move_’Œy
(
m
->
scheduË
, (
scheduË_’Œy
 *è&m->
deã¼ed_shutdown_sigÇl
);

2883 
	`throw_sigÇl
(
m
->
deã¼ed_shutdown_sigÇl
.
sigÇl_»ûived
);

2887 
	`£t_´efix
(
m
->
—¾›¡_wakeup
);

2888 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, m->
—¾›¡_wakeup
, 
mµ_æags
);

2889 
	`ş—r_´efix
();

2891 
m
->
—¾›¡_wakeup
 = 
NULL
;

2893  
»t
;

2894 
	}
}

2900 
	$muÉi_´oûss_drİ_outgošg_tun
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

2902 
muÉi_š¡ªû
 *
mi
 = 
m
->
³ndšg
;

2904 
	`ASSERT
(
mi
);

2906 
	`£t_´efix
(
mi
);

2908 
	`msg
(
D_MULTI_ERRORS
, "MULTI: Outgoing TUN queue full, dropped…acket†en=%d",

2909 
mi
->
cÚ‹xt
.
c2
.
to_tun
.
Ën
);

2911 
	`buf_»£t
(&
mi
->
cÚ‹xt
.
c2
.
to_tun
);

2913 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

2914 
	`ş—r_´efix
();

2915 
	}
}

2922 
	$rou‹_quÙa_exûeded
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
muÉi_š¡ªû
 *
mi
)

2924 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2925 
	`msg
(
D_ROUTE_QUOTA
, "MULTI ROUTE:„oute quota (%d)ƒxceeded for %s (see --max-routes-per-client option)",

2926 
mi
->
cÚ‹xt
.
İtiÚs
.
max_rou‹s_³r_ş›Á
,

2927 
	`muÉi_š¡ªû_¡ršg
(
mi
, 
çl£
, &
gc
));

2928 
	`gc_ä“
(&
gc
);

2929 
	}
}

2931 #ifdeà
ENABLE_DEBUG


2936 
	$g»mlš_æood_ş›Ás
(
muÉi_cÚ‹xt
 *
m
)

2938 cÚ¡ 
Ëv–
 = 
	`GREMLIN_PACKET_FLOOD_LEVEL
(
m
->
tİ
.
İtiÚs
.
g»mlš
);

2939 ià(
Ëv–
)

2941 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2942 
bufãr
 
buf
 = 
	`®loc_buf_gc
(
	`BUF_SIZE
(&
m
->
tİ
.
c2
.
äame
), &
gc
);

2943 
·ck‘_æood_·rms
 
·rm
 = 
	`g‘_·ck‘_æood_·rms
(
Ëv–
);

2944 
i
;

2946 
	`ASSERT
(
	`buf_š™
(&
buf
, 
	`FRAME_HEADROOM
(&
m
->
tİ
.
c2
.
äame
)));

2947 
·rm
.
·ck‘_size
 = 
	`mš_št
Õ¬m.·ck‘_size, 
	`MAX_RW_SIZE_TUN
(&
m
->
tİ
.
c2
.
äame
));

2949 
	`msg
(
D_GREMLIN
, "GREMLIN_FLOOD_CLIENTS: flooding clients with %d…ackets of size %d",

2950 
·rm
.
n_·ck‘s
,

2951 
·rm
.
·ck‘_size
);

2953 
i
 = 0; i < 
·rm
.
·ck‘_size
; ++i)

2955 
	`ASSERT
(
	`buf_wr™e_u8
(&
buf
, 
	`g‘_¿ndom
() & 0xFF));

2958 
i
 = 0; i < 
·rm
.
n_·ck‘s
; ++i)

2960 
	`muÉi_bÿ¡
(
m
, &
buf
, 
NULL
, NULL);

2963 
	`gc_ä“
(&
gc
);

2965 
	}
}

2968 
boŞ


2969 
	$¡®e_rou‹_check_Œigg”
(
muÉi_cÚ‹xt
 *
m
)

2971 
timev®
 
nuÎ
;

2972 
	`CLEAR
(
nuÎ
);

2973  
	`ev’t_timeout_Œigg”
(&
m
->
¡®e_rou‹s_check_‘
, &
nuÎ
, 
ETT_DEFAULT
);

2974 
	}
}

2980 
	$muÉi_´oûss_³r_£cÚd_tim”s_dowÜk
(
muÉi_cÚ‹xt
 *
m
)

2983 
	`muÉi_»­_´oûss
(
m
);

2986 ià(
m
->
tİ
.
c1
.
¡©us_ouut
)

2988 ià(
	`¡©us_Œigg”
(
m
->
tİ
.
c1
.
¡©us_ouut
))

2990 
	`muÉi_´št_¡©us
(
m
, m->
tİ
.
c1
.
¡©us_ouut
, m->
¡©us_fe_v”siÚ
);

2995 
	`muÉi_ifcÚfig_poŞ_³rsi¡
(
m
, 
çl£
);

2997 #ifdeà
ENABLE_DEBUG


2998 
	`g»mlš_æood_ş›Ás
(
m
);

3002 ià(
m
->
tİ
.
İtiÚs
.
¡®e_rou‹s_check_š‹rv®
 && 
	`¡®e_rou‹_check_Œigg”
(m))

3004 
	`check_¡®e_rou‹s
(
m
);

3006 
	}
}

3009 
	$muÉi_tİ_š™
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
cÚ‹xt
 *
tİ
)

3011 
	`šh”™_cÚ‹xt_tİ
(&
m
->
tİ
,op);

3012 
m
->
tİ
.
c2
.
bufãrs
 = 
	`š™_cÚ‹xt_bufãrs
(&tİ->c2.
äame
);

3013 
	}
}

3016 
	$muÉi_tİ_ä“
(
muÉi_cÚ‹xt
 *
m
)

3018 
	`şo£_cÚ‹xt
(&
m
->
tİ
, -1, 
CC_GC_FREE
);

3019 
	`ä“_cÚ‹xt_bufãrs
(
m
->
tİ
.
c2
.
bufãrs
);

3020 
	}
}

3022 
boŞ


3023 
	$is_ex™_»¡¬t
(
sig
)

3025  (
sig
 =ğ
SIGUSR1
 || sig =ğ
SIGTERM
 || sig =ğ
SIGHUP
 || sig =ğ
SIGINT
);

3026 
	}
}

3029 
	$muÉi_push_»¡¬t_scheduË_ex™
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 
Ãxt_£rv”
)

3031 
hash_™”©Ü
 
hi
;

3032 
hash_–em’t
 *
he
;

3033 
timev®
 
tv
;

3036 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

3037 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

3039 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

3040 ià(!
mi
->
h®t
)

3042 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(&
mi
->
cÚ‹xt
, 
Ãxt_£rv”
 ? "RESTART,[N]" : "RESTART", 
D_PUSH
);

3043 
	`muÉi_scheduË_cÚ‹xt_wakeup
(
m
, 
mi
);

3046 
	`hash_™”©Ü_ä“
(&
hi
);

3049 
	`ASSERT
(!
	`İ’v²_g‘timeofday
(&
m
->
deã¼ed_shutdown_sigÇl
.
wakeup
, 
NULL
));

3050 
tv
.
tv_£c
 = 2;

3051 
tv
.
tv_u£c
 = 0;

3052 
	`tv_add
(&
m
->
deã¼ed_shutdown_sigÇl
.
wakeup
, &
tv
);

3054 
m
->
deã¼ed_shutdown_sigÇl
.
sigÇl_»ûived
 = m->
tİ
.
sig
->signal_received;

3056 
	`scheduË_add_’Œy
(
m
->
scheduË
,

3057 (
scheduË_’Œy
 *è&
m
->
deã¼ed_shutdown_sigÇl
,

3058 &
m
->
deã¼ed_shutdown_sigÇl
.
wakeup
,

3059 
	`compu‹_wakeup_sigma
(&
m
->
deã¼ed_shutdown_sigÇl
.
wakeup
));

3061 
m
->
tİ
.
sig
->
sigÇl_»ûived
 = 0;

3062 
	}
}

3068 
boŞ


3069 
	$muÉi_´oûss_sigÇl
(
muÉi_cÚ‹xt
 *
m
)

3071 ià(
m
->
tİ
.
sig
->
sigÇl_»ûived
 =ğ
SIGUSR2
)

3073 
¡©us_ouut
 *
so
 = 
	`¡©us_İ’
(
NULL
, 0, 
M_INFO
, NULL, 0);

3074 
	`muÉi_´št_¡©us
(
m
, 
so
, m->
¡©us_fe_v”siÚ
);

3075 
	`¡©us_şo£
(
so
);

3076 
m
->
tİ
.
sig
->
sigÇl_»ûived
 = 0;

3077  
çl£
;

3079 ià(
	`´Ùo_is_dg¿m
(
m
->
tİ
.
İtiÚs
.
û
.
´Ùo
)

3080 && 
	`is_ex™_»¡¬t
(
m
->
tİ
.
sig
->
sigÇl_»ûived
)

3081 && (
m
->
deã¼ed_shutdown_sigÇl
.
sigÇl_»ûived
 == 0)

3082 && 
m
->
tİ
.
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
 != 0)

3084 
	`muÉi_push_»¡¬t_scheduË_ex™
(
m
, m->
tİ
.
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
 == 2);

3085  
çl£
;

3087  
Œue
;

3088 
	}
}

3095 
	$muÉi_şo£_š¡ªû_Ú_sigÇl
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

3097 
	`»m­_sigÇl
(&
mi
->
cÚ‹xt
);

3098 
	`£t_´efix
(
mi
);

3099 
	`´št_sigÇl
(
mi
->
cÚ‹xt
.
sig
, "ş›Á-š¡ªû", 
D_MULTI_LOW
);

3100 
	`ş—r_´efix
();

3101 
	`muÉi_şo£_š¡ªû
(
m
, 
mi
, 
çl£
);

3102 
	}
}

3105 
	$muÉi_sigÇl_š¡ªû
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
sig
)

3107 
mi
->
cÚ‹xt
.
sig
->
sigÇl_»ûived
 = sig;

3108 
	`muÉi_şo£_š¡ªû_Ú_sigÇl
(
m
, 
mi
);

3109 
	}
}

3115 #ifdeà
ENABLE_MANAGEMENT


3118 
	$mªagem’t_ÿÎback_¡©us
(*
¬g
, cÚ¡ 
v”siÚ
, 
¡©us_ouut
 *
so
)

3120 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3122 ià(!
v”siÚ
)

3124 
	`muÉi_´št_¡©us
(
m
, 
so
, m->
¡©us_fe_v”siÚ
);

3128 
	`muÉi_´št_¡©us
(
m
, 
so
, 
v”siÚ
);

3130 
	}
}

3133 
	$mªagem’t_ÿÎback_n_ş›Ás
(*
¬g
)

3135 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3136  
m
->
n_ş›Ás
;

3137 
	}
}

3140 
	$mªagem’t_ÿÎback_kl_by_ú
(*
¬g
, cÚ¡ *
d–_ú
)

3142 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3143 
hash_™”©Ü
 
hi
;

3144 
hash_–em’t
 *
he
;

3145 
couÁ
 = 0;

3147 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

3148 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

3150 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

3151 ià(!
mi
->
h®t
)

3153 cÚ¡ *
ú
 = 
	`s_commÚ_Çme
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
çl£
);

3154 ià(
ú
 && !
	`¡rcmp
(ú, 
d–_ú
))

3156 
	`muÉi_sigÇl_š¡ªû
(
m
, 
mi
, 
SIGTERM
);

3157 ++
couÁ
;

3161 
	`hash_™”©Ü_ä“
(&
hi
);

3162  
couÁ
;

3163 
	}
}

3166 
	$mªagem’t_ÿÎback_kl_by_addr
(*
¬g
, cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
pÜt
)

3168 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3169 
hash_™”©Ü
 
hi
;

3170 
hash_–em’t
 *
he
;

3171 
İ’v²_sockaddr
 
§ddr
;

3172 
mrou‹_addr
 
maddr
;

3173 
couÁ
 = 0;

3175 
	`CLEAR
(
§ddr
);

3176 
§ddr
.
addr
.
š4
.
sš_çmy
 = 
AF_INET
;

3177 
§ddr
.
addr
.
š4
.
sš_addr
.
s_addr
 = 
	`htÚl
(addr);

3178 
§ddr
.
addr
.
š4
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

3179 ià(
	`mrou‹_exŒaù_İ’v²_sockaddr
(&
maddr
, &
§ddr
, 
Œue
))

3181 
	`hash_™”©Ü_š™
(
m
->
™”
, &
hi
);

3182 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

3184 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
he
->
v®ue
;

3185 ià(!
mi
->
h®t
 && 
	`mrou‹_addr_equ®
(&
maddr
, &mi->
»®
))

3187 
	`muÉi_sigÇl_š¡ªû
(
m
, 
mi
, 
SIGTERM
);

3188 ++
couÁ
;

3191 
	`hash_™”©Ü_ä“
(&
hi
);

3193  
couÁ
;

3194 
	}
}

3197 
	$mªagem’t_d–‘e_ev’t
(*
¬g
, 
ev’t_t
 
ev’t
)

3199 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3200 ià(
m
->
mtı
)

3202 
	`muÉi_tı_d–‘e_ev’t
(
m
->
mtı
, 
ev’t
);

3204 
	}
}

3208 #ifdeà
MANAGEMENT_DEF_AUTH


3210 
muÉi_š¡ªû
 *

3211 
	$lookup_by_cid
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
cid
)

3213 ià(
m
)

3215 
muÉi_š¡ªû
 *
mi
 = (muÉi_š¡ªû *è
	`hash_lookup
(
m
->
cid_hash
, &
cid
);

3216 ià(
mi
 && !mi->
h®t
)

3218  
mi
;

3221  
NULL
;

3222 
	}
}

3224 
boŞ


3225 
	$mªagem’t_kl_by_cid
(*
¬g
, cÚ¡ 
cid
, cÚ¡ *
kl_msg
)

3227 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3228 
muÉi_š¡ªû
 *
mi
 = 
	`lookup_by_cid
(
m
, 
cid
);

3229 ià(
mi
)

3231 
	`£nd_»¡¬t
(&
mi
->
cÚ‹xt
, 
kl_msg
);

3232 
	`muÉi_scheduË_cÚ‹xt_wakeup
(
m
, 
mi
);

3233  
Œue
;

3237  
çl£
;

3239 
	}
}

3241 
boŞ


3242 
	$mªagem’t_ş›Á_auth
(*
¬g
,

3243 cÚ¡ 
cid
,

3244 cÚ¡ 
mda_key_id
,

3245 cÚ¡ 
boŞ
 
auth
,

3246 cÚ¡ *
»asÚ
,

3247 cÚ¡ *
ş›Á_»asÚ
,

3248 
bufãr_li¡
 *
cc_cÚfig
)

3250 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3251 
muÉi_š¡ªû
 *
mi
 = 
	`lookup_by_cid
(
m
, 
cid
);

3252 
boŞ
 
cc_cÚfig_owÃd
 = 
Œue
;

3253 
boŞ
 
»t
 = 
çl£
;

3255 ià(
mi
)

3257 
»t
 = 
	`s_auth’tiÿ‹_key
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
, 
mda_key_id
, 
auth
, 
ş›Á_»asÚ
);

3258 ià(
»t
)

3260 ià(
auth
)

3262 ià(!
mi
->
cÚÃùiÚ_e¡ablished_æag
)

3264 
	`£t_cc_cÚfig
(
mi
, 
cc_cÚfig
);

3265 
cc_cÚfig_owÃd
 = 
çl£
;

3270 ià(
»asÚ
)

3272 
	`msg
(
D_MULTI_LOW
, "MULTI: cÚÃùiÚ„ejeùed: %s, CLI:%s", 
»asÚ
, 
	`Å
(
ş›Á_»asÚ
));

3274 ià(
mi
->
cÚÃùiÚ_e¡ablished_æag
)

3276 
	`£nd_auth_çed
(&
mi
->
cÚ‹xt
, 
ş›Á_»asÚ
);

3277 
	`muÉi_scheduË_cÚ‹xt_wakeup
(
m
, 
mi
);

3282 ià(
cc_cÚfig_owÃd
 && 
cc_cÚfig
)

3284 
	`bufãr_li¡_ä“
(
cc_cÚfig
);

3286  
»t
;

3287 
	}
}

3290 
	$mªagem’t_g‘_³”_šfo
(*
¬g
, cÚ¡ 
cid
)

3292 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3293 
muÉi_š¡ªû
 *
mi
 = 
	`lookup_by_cid
(
m
, 
cid
);

3294 *
»t
 = 
NULL
;

3296 ià(
mi
)

3298 
»t
 = 
	`s_g‘_³”_šfo
(
mi
->
cÚ‹xt
.
c2
.
s_muÉi
);

3301  
»t
;

3302 
	}
}

3306 #ifdeà
MANAGEMENT_PF


3307 
boŞ


3308 
	$mªagem’t_ş›Á_pf
(*
¬g
,

3309 cÚ¡ 
cid
,

3310 
bufãr_li¡
 *
pf_cÚfig
)

3312 
muÉi_cÚ‹xt
 *
m
 = (muÉi_cÚ‹xˆ*è
¬g
;

3313 
muÉi_š¡ªû
 *
mi
 = 
	`lookup_by_cid
(
m
, 
cid
);

3314 
boŞ
 
»t
 = 
çl£
;

3316 ià(
mi
 && 
pf_cÚfig
)

3318 
»t
 = 
	`pf_lßd_äom_bufãr_li¡
(&
mi
->
cÚ‹xt
, 
pf_cÚfig
);

3321 ià(
pf_cÚfig
)

3323 
	`bufãr_li¡_ä“
(
pf_cÚfig
);

3325  
»t
;

3326 
	}
}

3330 
	$š™_mªagem’t_ÿÎback_muÉi
(
muÉi_cÚ‹xt
 *
m
)

3332 #ifdeà
ENABLE_MANAGEMENT


3333 ià(
mªagem’t
)

3335 
mªagem’t_ÿÎback
 
cb
;

3336 
	`CLEAR
(
cb
);

3337 
cb
.
¬g
 = 
m
;

3338 
cb
.
æags
 = 
MCF_SERVER
;

3339 
cb
.
¡©us
 = 
mªagem’t_ÿÎback_¡©us
;

3340 
cb
.
show_Ãt
 = 
mªagem’t_show_Ãt_ÿÎback
;

3341 
cb
.
kl_by_ú
 = 
mªagem’t_ÿÎback_kl_by_ú
;

3342 
cb
.
kl_by_addr
 = 
mªagem’t_ÿÎback_kl_by_addr
;

3343 
cb
.
d–‘e_ev’t
 = 
mªagem’t_d–‘e_ev’t
;

3344 
cb
.
n_ş›Ás
 = 
mªagem’t_ÿÎback_n_ş›Ás
;

3345 #ifdeà
MANAGEMENT_DEF_AUTH


3346 
cb
.
kl_by_cid
 = 
mªagem’t_kl_by_cid
;

3347 
cb
.
ş›Á_auth
 = 
mªagem’t_ş›Á_auth
;

3348 
cb
.
g‘_³”_šfo
 = 
mªagem’t_g‘_³”_šfo
;

3350 #ifdeà
MANAGEMENT_PF


3351 
cb
.
ş›Á_pf
 = 
mªagem’t_ş›Á_pf
;

3353 
	`mªagem’t_£t_ÿÎback
(
mªagem’t
, &
cb
);

3356 
	}
}

3359 
	$unš™_mªagem’t_ÿÎback_muÉi
(
muÉi_cÚ‹xt
 *
m
)

3361 
	`unš™_mªagem’t_ÿÎback
();

3362 
	}
}

3368 
	$tuÂ–_£rv”
(
cÚ‹xt
 *
tİ
)

3370 
	`ASSERT
(
tİ
->
İtiÚs
.
mode
 =ğ
MODE_SERVER
);

3372 ià(
	`´Ùo_is_dg¿m
(
tİ
->
İtiÚs
.
û
.
´Ùo
))

3374 
	`tuÂ–_£rv”_udp
(
tİ
);

3378 
	`tuÂ–_£rv”_tı
(
tİ
);

3380 
	}
}

3384 
	$dummy
()

3386 
	}
}

	@multi.h

28 #iâdeà
MULTI_H


29 
	#MULTI_H


	)

31 #ià
P2MP_SERVER


33 
	~"š™.h
"

34 
	~"fÜw¬d.h
"

35 
	~"mrou‹.h
"

36 
	~"mbuf.h
"

37 
	~"li¡.h
"

38 
	~"scheduË.h
"

39 
	~"poŞ.h
"

40 
	~"mudp.h
"

41 
	~"mtı.h
"

42 
	~"³rf.h
"

44 
	#MULTI_PREFIX_MAX_LENGTH
 256

	)

51 
	smuÉi_»­


53 
	mbuck‘_ba£
;

54 
	mbuck‘s_³r_·ss
;

55 
time_t
 
	mÏ¡_ÿÎ
;

59 
	sdeã¼ed_sigÇl_scheduË_’Œy


61 
scheduË_’Œy
 
	m£
;

62 
	msigÇl_»ûived
;

63 
timev®
 
	mwakeup
;

76 
	smuÉi_š¡ªû
 {

77 
scheduË_’Œy
 
	m£
;

78 
gc_¬’a
 
	mgc
;

79 
boŞ
 
	mdefšed
;

80 
boŞ
 
	mh®t
;

81 
	m»fcouÁ
;

82 
	mrou‹_couÁ
;

83 
time_t
 
	mü—‹d
;

87 
timev®
 
	mwakeup
;

88 
mrou‹_addr
 
	m»®
;

90 
ifcÚfig_poŞ_hªdË
 
	mvaddr_hªdË
;

91 
	mmsg_´efix
[
MULTI_PREFIX_MAX_LENGTH
];

94 
	mtı_rwæags
;

95 
mbuf_£t
 *
	mtı_lšk_out_deã¼ed
;

96 
boŞ
 
	msock‘_£t_ÿÎed
;

98 
š_addr_t
 
	m»pÜtšg_addr
;

99 
š6_addr
 
	m»pÜtšg_addr_v6
;

101 
boŞ
 
	mdid_İ’_cÚ‹xt
;

102 
boŞ
 
	mdid_»®_hash
;

103 
boŞ
 
	mdid_™”
;

104 #ifdeà
MANAGEMENT_DEF_AUTH


105 
boŞ
 
	mdid_cid_hash
;

106 
bufãr_li¡
 *
	mcc_cÚfig
;

108 
boŞ
 
	mcÚÃùiÚ_e¡ablished_æag
;

109 
boŞ
 
	mdid_œou‹s
;

110 
	mn_ş›Ás_d–
;

112 
cÚ‹xt
 
	mcÚ‹xt
;

115 #ifdeà
ENABLE_ASYNC_PUSH


116 
	mšÙify_w©ch
;

131 
	smuÉi_cÚ‹xt
 {

132 
	#MC_UNDEF
 0

	)

133 
	#MC_SINGLE_THREADED
 (1<<0)

	)

134 
	#MC_MULTI_THREADED_MASTER
 (1<<1)

	)

135 
	#MC_MULTI_THREADED_WORKER
 (1<<2)

	)

136 
	#MC_MULTI_THREADED_SCHEDULER
 (1<<3)

	)

137 
	#MC_WORK_THREAD
 (
MC_MULTI_THREADED_WORKER
|
MC_MULTI_THREADED_SCHEDULER
)

	)

138 
	mth»ad_mode
;

140 
muÉi_š¡ªû
 **
	mš¡ªûs
;

143 
hash
 *
	mhash
;

145 
hash
 *
	mvhash
;

147 
hash
 *
	m™”
;

150 
scheduË
 *
	mscheduË
;

151 
mbuf_£t
 *
	mmbuf
;

154 
muÉi_tı
 *
	mmtı
;

156 
ifcÚfig_poŞ
 *
	mifcÚfig_poŞ
;

157 
äequ’cy_lim™
 *
	mÃw_cÚÃùiÚ_lim™”
;

158 
mrou‹_h–³r
 *
	mrou‹_h–³r
;

159 
muÉi_»­
 *
	m»­”
;

160 
mrou‹_addr
 
	mloÿl
;

161 
boŞ
 
	m’abË_c2c
;

162 
	mmax_ş›Ás
;

163 
	mtı_queue_lim™
;

164 
	m¡©us_fe_v”siÚ
;

165 
	mn_ş›Ás
;

167 #ifdeà
MANAGEMENT_DEF_AUTH


168 
hash
 *
	mcid_hash
;

169 
	mcid_couÁ”
;

172 
muÉi_š¡ªû
 *
	m³ndšg
;

173 
muÉi_š¡ªû
 *
	m—¾›¡_wakeup
;

174 
muÉi_š¡ªû
 **
	mmµ_touched
;

175 
cÚ‹xt_bufãrs
 *
	mcÚ‹xt_bufãrs
;

176 
time_t
 
	m³r_£cÚd_Œigg”
;

178 
cÚ‹xt
 
	mtİ
;

184 
ev’t_timeout
 
	m¡®e_rou‹s_check_‘
;

186 #ifdeà
ENABLE_ASYNC_PUSH


188 
hash
 *
	mšÙify_w©ch”s
;

191 
deã¼ed_sigÇl_scheduË_’Œy
 
	mdeã¼ed_shutdown_sigÇl
;

197 
	smuÉi_rou‹


199 
mrou‹_addr
 
	maddr
;

200 
muÉi_š¡ªû
 *
	mš¡ªû
;

202 
	#MULTI_ROUTE_CACHE
 (1<<0)

	)

203 
	#MULTI_ROUTE_AGEABLE
 (1<<1)

	)

204 
	mæags
;

206 
	mÿche_g’”©iÚ
;

207 
time_t
 
	mÏ¡_»ã»nû
;

223 
tuÂ–_£rv”
(
cÚ‹xt
 *
tİ
);

226 cÚ¡ *
muÉi_š¡ªû_¡ršg
(cÚ¡ 
muÉi_š¡ªû
 *
mi
, 
boŞ
 
nuÎ
, 
gc_¬’a
 *
gc
);

232 
muÉi_š™
(
muÉi_cÚ‹xt
 *
m
, 
cÚ‹xt
 *
t
, 
boŞ
 
tı_mode
, 
th»ad_mode
);

234 
muÉi_unš™
(
muÉi_cÚ‹xt
 *
m
);

236 
muÉi_tİ_š™
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
cÚ‹xt
 *
tİ
);

238 
muÉi_tİ_ä“
(
muÉi_cÚ‹xt
 *
m
);

240 
muÉi_š¡ªû
 *
muÉi_ü—‹_š¡ªû
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mrou‹_addr
 *
»®
);

242 
muÉi_şo£_š¡ªû
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, 
boŞ
 
shutdown
);

244 
boŞ
 
muÉi_´oûss_timeout
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
);

254 
muÉi_´oûss_æßt
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
);

256 
	#MPP_PRE_SELECT
 (1<<0)

	)

257 
	#MPP_CONDITIONAL_PRE_SELECT
 (1<<1)

	)

258 
	#MPP_CLOSE_ON_SIGNAL
 (1<<2)

	)

259 
	#MPP_RECORD_TOUCH
 (1<<3)

	)

284 
boŞ
 
muÉi_´oûss_po¡
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
æags
);

310 
boŞ
 
muÉi_´oûss_šcomšg_lšk
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
š¡ªû
, cÚ¡ 
mµ_æags
);

328 
boŞ
 
muÉi_´oûss_šcomšg_tun
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
);

331 
muÉi_´oûss_drİ_outgošg_tun
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
);

333 
muÉi_´št_¡©us
(
muÉi_cÚ‹xt
 *
m
, 
¡©us_ouut
 *
so
, cÚ¡ 
v”siÚ
);

335 
muÉi_š¡ªû
 *
muÉi_g‘_queue
(
mbuf_£t
 *
ms
);

337 
muÉi_add_mbuf
(
muÉi_cÚ‹xt
 *
m
,

338 
muÉi_š¡ªû
 *
mi
,

339 
mbuf_bufãr
 *
mb
);

341 
muÉi_ifcÚfig_poŞ_³rsi¡
(
muÉi_cÚ‹xt
 *
m
, 
boŞ
 
fÜû
);

343 
boŞ
 
muÉi_´oûss_sigÇl
(
muÉi_cÚ‹xt
 *
m
);

345 
muÉi_şo£_š¡ªû_Ú_sigÇl
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
);

347 
š™_mªagem’t_ÿÎback_muÉi
(
muÉi_cÚ‹xt
 *
m
);

349 
unš™_mªagem’t_ÿÎback_muÉi
(
muÉi_cÚ‹xt
 *
m
);

352 #ifdeà
ENABLE_ASYNC_PUSH


360 
muÉi_´oûss_fe_şo£d
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
);

367 
šlše
 
boŞ


368 
	$muÉi_ouut_queue_»ady
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
,

369 cÚ¡ 
muÉi_š¡ªû
 *
mi
)

371 ià(
mi
->
tı_lšk_out_deã¼ed
)

373  
	`mbuf_Ën
(
mi
->
tı_lšk_out_deã¼ed
è<ğ
m
->
tı_queue_lim™
;

377  
Œue
;

379 
	}
}

386 
šlše
 
muÉi_š¡ªû
 *

387 
	$muÉi_´oûss_outgošg_lšk_´e
(
muÉi_cÚ‹xt
 *
m
)

389 
muÉi_š¡ªû
 *
mi
 = 
NULL
;

391 ià(
m
->
³ndšg
)

393 
mi
 = 
m
->
³ndšg
;

395 ià(
	`mbuf_defšed
(
m
->
mbuf
))

397 
mi
 = 
	`muÉi_g‘_queue
(
m
->
mbuf
);

399  
mi
;

400 
	}
}

406 
rou‹_quÙa_exûeded
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
muÉi_š¡ªû
 *
mi
);

408 
šlše
 

409 
	$rou‹_quÙa_šc
(
muÉi_š¡ªû
 *
mi
)

411 ++
mi
->
rou‹_couÁ
;

412 
	}
}

414 
šlše
 

415 
	$rou‹_quÙa_dec
(
muÉi_š¡ªû
 *
mi
)

417 --
mi
->
rou‹_couÁ
;

418 
	}
}

421 
šlše
 
boŞ


422 
	$rou‹_quÙa_‹¡
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
muÉi_š¡ªû
 *
mi
)

424 ià(
mi
->
rou‹_couÁ
 >ğmi->
cÚ‹xt
.
İtiÚs
.
max_rou‹s_³r_ş›Á
)

426 
	`rou‹_quÙa_exûeded
(
m
, 
mi
);

427  
çl£
;

431  
Œue
;

433 
	}
}

439 
šlše
 

440 
	$muÉi_š¡ªû_šc_»fcouÁ
(
muÉi_š¡ªû
 *
mi
)

442 ++
mi
->
»fcouÁ
;

443 
	}
}

445 
šlše
 

446 
	$muÉi_š¡ªû_dec_»fcouÁ
(
muÉi_š¡ªû
 *
mi
)

448 ià(--
mi
->
»fcouÁ
 <= 0)

450 
	`gc_ä“
(&
mi
->
gc
);

451 
	`ä“
(
mi
);

453 
	}
}

455 
šlše
 

456 
	$muÉi_rou‹_d–
(
muÉi_rou‹
 *
rou‹
)

458 
muÉi_š¡ªû
 *
mi
 = 
rou‹
->
š¡ªû
;

459 
	`rou‹_quÙa_dec
(
mi
);

460 
	`muÉi_š¡ªû_dec_»fcouÁ
(
mi
);

461 
	`ä“
(
rou‹
);

462 
	}
}

464 
šlše
 
boŞ


465 
	$muÉi_rou‹_defšed
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
,

466 cÚ¡ 
muÉi_rou‹
 *
r
)

468 ià(
r
->
š¡ªû
->
h®t
)

470  
çl£
;

472 ià((
r
->
æags
 & 
MULTI_ROUTE_CACHE
)

473 && 
r
->
ÿche_g’”©iÚ
 !ğ
m
->
rou‹_h–³r
->cache_generation)

475  
çl£
;

477 ià((
r
->
æags
 & 
MULTI_ROUTE_AGEABLE
)

478 && 
r
->
Ï¡_»ã»nû
 + 
m
->
rou‹_h–³r
->
ag—bË_‰l_£cs
 < 
now
)

480  
çl£
;

484  
Œue
;

486 
	}
}

492 
ung’”©e_´efix
(
muÉi_š¡ªû
 *
mi
);

498 
šlše
 

499 
	$£t_´efix
(
muÉi_š¡ªû
 *
mi
)

501 #ifdeà
MULTI_DEBUG_EVENT_LOOP


502 ià(
mi
->
msg_´efix
[0])

504 
	`´štf
("[%s]\n", 
mi
->
msg_´efix
);

507 
	`msg_£t_´efix
(
mi
->
msg_´efix
[0] ? mi->msg_´efix : 
NULL
);

508 
	}
}

510 
šlše
 

511 
	$ş—r_´efix
()

513 #ifdeà
MULTI_DEBUG_EVENT_LOOP


514 
	`´štf
("[NULL]\n");

516 
	`msg_£t_´efix
(
NULL
);

517 
	}
}

528 
	#REAP_MAX_WAKEUP
 10

	)

529 
	#REAP_DIVISOR
 256

	)

530 
	#REAP_MIN
 16

	)

531 
	#REAP_MAX
 1024

	)

537 
	#MULTI_CACHE_ROUTE_TTL
 60

	)

539 
šlše
 

540 
	$muÉi_»­_´oûss
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
)

542 
	`muÉi_»­_´oûss_dowÜk
(cÚ¡ 
muÉi_cÚ‹xt
 *
m
);

544 ià(
m
->
»­”
->
Ï¡_ÿÎ
 !ğ
now
)

546 
	`muÉi_»­_´oûss_dowÜk
(
m
);

548 
	}
}

550 
šlše
 

551 
	$muÉi_´oûss_³r_£cÚd_tim”s
(
muÉi_cÚ‹xt
 *
m
)

553 ià(
m
->
³r_£cÚd_Œigg”
 !ğ
now
)

555 
	`muÉi_´oûss_³r_£cÚd_tim”s_dowÜk
(
muÉi_cÚ‹xt
 *
m
);

557 
	`muÉi_´oûss_³r_£cÚd_tim”s_dowÜk
(
m
);

558 
m
->
³r_£cÚd_Œigg”
 = 
now
;

560 
	}
}

570 
šlše
 

571 
	$muÉi_g‘_timeout
(
muÉi_cÚ‹xt
 *
m
, 
timev®
 *
de¡
)

573 
timev®
 
tv
, 
cu¼’t
;

575 
	`CLEAR
(
tv
);

576 
m
->
—¾›¡_wakeup
 = (
muÉi_š¡ªû
 *è
	`scheduË_g‘_—¾›¡_wakeup
(m->
scheduË
, &
tv
);

577 ià(
m
->
—¾›¡_wakeup
)

579 
	`ASSERT
(!
	`İ’v²_g‘timeofday
(&
cu¼’t
, 
NULL
));

580 
	`tv_d–
(
de¡
, &
cu¼’t
, &
tv
);

581 ià(
de¡
->
tv_£c
 >ğ
REAP_MAX_WAKEUP
)

583 
m
->
—¾›¡_wakeup
 = 
NULL
;

584 
de¡
->
tv_£c
 = 
REAP_MAX_WAKEUP
;

585 
de¡
->
tv_u£c
 = 0;

590 
de¡
->
tv_£c
 = 
REAP_MAX_WAKEUP
;

591 
de¡
->
tv_u£c
 = 0;

593 
	}
}

613 
šlše
 
boŞ


614 
	$muÉi_´oûss_outgošg_tun
(
muÉi_cÚ‹xt
 *
m
, cÚ¡ 
mµ_æags
)

616 
muÉi_š¡ªû
 *
mi
 = 
m
->
³ndšg
;

617 
boŞ
 
»t
 = 
Œue
;

619 
	`ASSERT
(
mi
);

620 #ifdeà
MULTI_DEBUG_EVENT_LOOP


621 
	`´štf
("%s -> TUN†en=%d\n",

622 
	`id
(
mi
),

623 
mi
->
cÚ‹xt
.
c2
.
to_tun
.
Ën
);

625 
	`£t_´efix
(
mi
);

626 
	`´oûss_outgošg_tun
(&
mi
->
cÚ‹xt
);

627 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

628 
	`ş—r_´efix
();

629  
»t
;

630 
	}
}

634 
šlše
 
boŞ


635 
	$muÉi_´oûss_outgošg_lšk_dowÜk
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
, cÚ¡ 
mµ_æags
)

637 
boŞ
 
»t
 = 
Œue
;

638 
	`£t_´efix
(
mi
);

639 
	`´oûss_outgošg_lšk
(&
mi
->
cÚ‹xt
);

640 
»t
 = 
	`muÉi_´oûss_po¡
(
m
, 
mi
, 
mµ_æags
);

641 
	`ş—r_´efix
();

642  
»t
;

643 
	}
}

648 
	#MULTI_CHECK_SIG
(
m
è
	`EVENT_LOOP_CHECK_SIGNAL
(&(m)->
tİ
, 
muÉi_´oûss_sigÇl
, (m))

	)

650 
šlše
 

651 
	$muÉi_£t_³ndšg
(
muÉi_cÚ‹xt
 *
m
, 
muÉi_š¡ªû
 *
mi
)

653 
m
->
³ndšg
 = 
mi
;

654 
	}
}

	@ntlm.c

23 #ifdeà
HAVE_CONFIG_H


24 
	~"cÚfig.h
"

25 #–ià
defšed
(
_MSC_VER
)

26 
	~"cÚfig-msvc.h
"

29 
	~"sysh—d.h
"

31 #ià
NTLM


33 
	~"commÚ.h
"

34 
	~"bufãr.h
"

35 
	~"misc.h
"

36 
	~"sock‘.h
"

37 
	~"fdmisc.h
"

38 
	~"´oxy.h
"

39 
	~"Álm.h
"

40 
	~"ba£64.h
"

41 
	~"üy±o.h
"

43 
	~"memdbg.h
"

47 #ifdeà
_MSC_VER


49 
	#UINTEGER64
 
__št64


	)

50 
	#UINT64
(
c
èø## 
Ui64


	)

53 
	#UINTEGER64
 

	)

54 
	#UINT64
(
c
èø## 
LL


	)

60 
	$ü—‹_des_keys
(cÚ¡ *
hash
, *
key
)

62 
key
[0] = 
hash
[0];

63 
key
[1] = ((
hash
[0] & 1) << 7) | (hash[1] >> 1);

64 
key
[2] = ((
hash
[1] & 3) << 6) | (hash[2] >> 2);

65 
key
[3] = ((
hash
[2] & 7) << 5) | (hash[3] >> 3);

66 
key
[4] = ((
hash
[3] & 15) << 4) | (hash[4] >> 4);

67 
key
[5] = ((
hash
[4] & 31) << 3) | (hash[5] >> 5);

68 
key
[6] = ((
hash
[5] & 63) << 2) | (hash[6] >> 6);

69 
key
[7] = ((
hash
[6] & 127) << 1);

70 
	`key_des_fixup
(
key
, 8, 1);

71 
	}
}

74 
	$g’_md4_hash
(cÚ¡ 
ušt8_t
 *
d©a
, 
d©a_Ën
, ušt8_ˆ*
»suÉ
)

77 cÚ¡ 
md_kt_t
 *
md4_kt
 = 
	`md_kt_g‘
("MD4");

78 
ušt8_t
 
md
[
MD4_DIGEST_LENGTH
];

80 
	`md_fuÎ
(
md4_kt
, 
d©a
, 
d©a_Ën
, 
md
);

81 
	`memıy
(
»suÉ
, 
md
, 
MD4_DIGEST_LENGTH
);

82 
	}
}

85 
	$g’_hmac_md5
(cÚ¡ 
ušt8_t
 *
d©a
, 
d©a_Ën
, cÚ¡ ušt8_ˆ*
key
, 
key_Ën
,

86 
ušt8_t
 *
»suÉ
)

88 cÚ¡ 
md_kt_t
 *
md5_kt
 = 
	`md_kt_g‘
("MD5");

89 
hmac_ùx_t
 *
hmac_ùx
 = 
	`hmac_ùx_Ãw
();

91 
	`hmac_ùx_š™
(
hmac_ùx
, 
key
, 
key_Ën
, 
md5_kt
);

92 
	`hmac_ùx_upd©e
(
hmac_ùx
, 
d©a
, 
d©a_Ën
);

93 
	`hmac_ùx_fš®
(
hmac_ùx
, 
»suÉ
);

94 
	`hmac_ùx_ş—nup
(
hmac_ùx
);

95 
	`hmac_ùx_ä“
(
hmac_ùx
);

96 
	}
}

99 
	$g’_time¡amp
(
ušt8_t
 *
time¡amp
)

106 
UINTEGER64
 
time¡amp_uÎ
;

108 
time¡amp_uÎ
 = 
	`İ’v²_time
(
NULL
);

109 
time¡amp_uÎ
 = (time¡amp_uÎ + 
	`UINT64
(11644473600)) * UINT64(10000000);

112 
time¡amp
[0] = 
time¡amp_uÎ
 & 
	`UINT64
(0xFF);

113 
time¡amp
[1] = (
time¡amp_uÎ
 >> 8è& 
	`UINT64
(0xFF);

114 
time¡amp
[2] = (
time¡amp_uÎ
 >> 16è& 
	`UINT64
(0xFF);

115 
time¡amp
[3] = (
time¡amp_uÎ
 >> 24è& 
	`UINT64
(0xFF);

116 
time¡amp
[4] = (
time¡amp_uÎ
 >> 32è& 
	`UINT64
(0xFF);

117 
time¡amp
[5] = (
time¡amp_uÎ
 >> 40è& 
	`UINT64
(0xFF);

118 
time¡amp
[6] = (
time¡amp_uÎ
 >> 48è& 
	`UINT64
(0xFF);

119 
time¡amp
[7] = (
time¡amp_uÎ
 >> 56è& 
	`UINT64
(0xFF);

120 
	}
}

123 
	$g’_nÚû
(*
nÚû
)

126 
i
;

128 
i
 = 0; i<8; i++)

130 
nÚû
[
i
] = ()
	`g‘_¿ndom
();

132 
	}
}

135 
	$my_¡ru´
(*
¡r
)

139 *
¡r
)

141 *
¡r
 = 
	`touµ”
(*str);

142 
¡r
++;

144 
	}
}

147 
	$unicodize
(*
d¡
, cÚ¡ *
¤c
)

150 
i
 = 0;

153 
d¡
[
i
++] = *
¤c
;

154 
d¡
[
i
++] = 0;

155 } *
¤c
++);

157  
i
;

158 
	}
}

161 
	$add_£cur™y_bufãr
(
sb_off£t
, *
d©a
, 
Ëngth
,

162 *
msg_buf
, *
msg_buåos
)

166 
msg_buf
[
sb_off£t
] = ()
Ëngth
;

167 
msg_buf
[
sb_off£t
 + 2] = msg_buf[sb_offset];

168 
msg_buf
[
sb_off£t
 + 4] = ()(*
msg_buåos
 & 0xff);

169 
msg_buf
[
sb_off£t
 + 5] = ()((*
msg_buåos
 >> 8) & 0xff);

170 
	`memıy
(&
msg_buf
[*
msg_buåos
], 
d©a
, msg_buf[
sb_off£t
]);

171 *
msg_buåos
 +ğ
Ëngth
;

172 
	}
}

175 
	$Álm_pha£_1
(cÚ¡ 
h‰p_´oxy_šfo
 *
p
, 
gc_¬’a
 *
gc
)

177 
bufãr
 
out
 = 
	`®loc_buf_gc
(96, 
gc
);

187 
	`buf_´štf
(&
out
, "%s", "TlRMTVNTUAABAAAAAgIAAA==");

188  (
	`BSTR
(&
out
));

189 
	}
}

192 
	$Álm_pha£_3
(cÚ¡ 
h‰p_´oxy_šfo
 *
p
, cÚ¡ *
pha£_2
,

193 
gc_¬’a
 *
gc
)

201 
pwbuf
[(
p
->
up
.
·sswÜd
) * 2];

202 
ušt8_t
 
buf2
[128];

203 
ušt8_t
 
pha£3
[464];

205 
ušt8_t
 
md4_hash
[
MD4_DIGEST_LENGTH
 + 5];

206 
ušt8_t
 
ch®Ënge
[8], 
Álm_»¥Ú£
[24];

207 
i
, 
»t_v®
;

209 
ušt8_t
 
Álmv2_»¥Ú£
[144];

210 
u£rdomaš_u
[256];

211 
u£rdomaš
[128];

212 
ušt8_t
 
Álmv2_hash
[
MD5_DIGEST_LENGTH
];

213 
ušt8_t
 
Álmv2_hmacmd5
[16];

214 
ušt8_t
 *
Álmv2_blob
 = 
Álmv2_»¥Ú£
 + 16;

215 
Álmv2_blob_size
 = 0;

216 
pha£3_buåos
 = 0x40;

217 
size_t
 
Ën
;

219 
domaš
[128];

220 
u£ºame
[128];

221 *
£·¿tÜ
;

223 
boŞ
 
Álmv2_’abËd
 = (
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_NTLM2
);

225 
	`CLEAR
(
buf2
);

227 
	`ASSERT
(
	`¡¾’
(
p
->
up
.
u£ºame
) > 0);

228 
	`ASSERT
(
	`¡¾’
(
p
->
up
.
·sswÜd
) > 0);

231 
£·¿tÜ
 = 
	`¡rchr
(
p
->
up
.
u£ºame
, '\\');

232 ià(
£·¿tÜ
 =ğ
NULL
)

234 
	`¡ºıy
(
u£ºame
, 
p
->
up
.username, (username)-1);

235 
u£ºame
[(username)-1] = 0;

236 
domaš
[0] = 0;

240 
	`¡ºıy
(
u£ºame
, 
£·¿tÜ
+1, (username)-1);

241 
u£ºame
[(username)-1] = 0;

242 
Ën
 = 
£·¿tÜ
 - 
p
->
up
.
u£ºame
;

243 ià(
Ën
 > (
domaš
) - 1)

245 
Ën
 = (
domaš
) - 1;

247 
	`¡ºıy
(
domaš
, 
p
->
up
.
u£ºame
, 
Ën
);

248 
domaš
[
Ën
] = 0;

253 
unicode_Ën
 = 
	`unicodize
(
pwbuf
, 
p
->
up
.
·sswÜd
) - 2;

254 
	`g’_md4_hash
((
ušt8_t
 *)
pwbuf
, 
unicode_Ën
, 
md4_hash
);

257 
	`mem£t
(
md4_hash
 + 
MD4_DIGEST_LENGTH
, 0, 5);

259 
»t_v®
 = 
	`İ’v²_ba£64_decode
(
pha£_2
, 
buf2
, -1);

260 ià(
»t_v®
 < 0)

262  
NULL
;

269 
i
 = 0; i<8; i++)

271 
ch®Ënge
[
i
] = 
buf2
[i+24];

274 ià(
Álmv2_’abËd
)

276 
tib_Ën
;

279 
	`¡rıy
(
u£rdomaš
, 
u£ºame
);

280 
	`my_¡ru´
(
u£rdomaš
);

281 ià(
	`¡¾’
(
u£ºame
è+ sŒËn(
domaš
è< (
u£rdomaš
))

283 
	`¡rÿt
(
u£rdomaš
, 
domaš
);

287 
	`msg
(
M_INFO
, "Warning: Username or domainoo†ong");

289 
	`unicodize
(
u£rdomaš_u
, 
u£rdomaš
);

290 
	`g’_hmac_md5
((
ušt8_t
 *)
u£rdomaš_u
, 2 * 
	`¡¾’
(
u£rdomaš
), 
md4_hash
,

291 
MD5_DIGEST_LENGTH
, 
Álmv2_hash
);

294 
	`mem£t
(
Álmv2_blob
, 0, 128);

295 
Álmv2_blob
[0x00] = 1;

296 
Álmv2_blob
[0x01] = 1;

297 
Álmv2_blob
[0x04] = 0;

298 
	`g’_time¡amp
(&
Álmv2_blob
[0x08]);

299 
	`g’_nÚû
(&
Álmv2_blob
[0x10]);

300 
Álmv2_blob
[0x18] = 0;

316 cÚ¡ 
size_t
 
hoff
 = 0x14;

317 
æags
 = 
buf2
[
hoff
] | (buf2[hoff + 1] << 8) |

318 (
buf2
[
hoff
 + 2] << 16) | (buf2[hoff + 3] << 24);

319 ià((
æags
 & 0x00800000) == 0x00800000)

321 
tib_Ën
 = 
buf2
[0x28];

322 ià(
tib_Ën
 > 96)

324 
tib_Ën
 = 96;

328 
ušt8_t
 *
tib_±r
;

329 
ušt8_t
 
tib_pos
 = 
buf2
[0x2c];

330 ià(
tib_pos
 + 
tib_Ën
 > (
buf2
))

332  
NULL
;

335 
tib_±r
 = 
buf2
 + 
tib_pos
;

337 
	`memıy
(&
Álmv2_blob
[0x1c], 
tib_±r
, 
tib_Ën
);

342 
tib_Ën
 = 0;

346 
Álmv2_blob
[0x1ø+ 
tib_Ën
] = 0;

349 
Álmv2_blob_size
 = 0x20 + 
tib_Ën
;

352 
	`memıy
(&
Álmv2_»¥Ú£
[8], 
ch®Ënge
, 8);

355 
	`g’_hmac_md5
(&
Álmv2_»¥Ú£
[8], 
Álmv2_blob_size
 + 8, 
Álmv2_hash
,

356 
MD5_DIGEST_LENGTH
, 
Álmv2_hmacmd5
);

361 
	`memıy
(
Álmv2_»¥Ú£
, 
Álmv2_hmacmd5
, 
MD5_DIGEST_LENGTH
);

365 
key1
[
DES_KEY_LENGTH
], 
key2
[DES_KEY_LENGTH];

366 
key3
[
DES_KEY_LENGTH
];

368 
	`ü—‹_des_keys
(
md4_hash
, 
key1
);

369 
	`ch”_des_’üy±_ecb
(
key1
, 
ch®Ënge
, 
Álm_»¥Ú£
);

371 
	`ü—‹_des_keys
(&
md4_hash
[
DES_KEY_LENGTH
 - 1], 
key2
);

372 
	`ch”_des_’üy±_ecb
(
key2
, 
ch®Ënge
, &
Álm_»¥Ú£
[
DES_KEY_LENGTH
]);

374 
	`ü—‹_des_keys
(&
md4_hash
[2 * (
DES_KEY_LENGTH
 - 1)], 
key3
);

375 
	`ch”_des_’üy±_ecb
(
key3
, 
ch®Ënge
,

376 &
Álm_»¥Ú£
[
DES_KEY_LENGTH
 * 2]);

380 
	`mem£t
(
pha£3
, 0, (phase3));

382 
	`¡rıy
((*)
pha£3
, "NTLMSSP\0");

383 
pha£3
[8] = 3;

385 ià(
Álmv2_’abËd
)

387 
	`add_£cur™y_bufãr
(0x14, 
Álmv2_»¥Ú£
, 
Álmv2_blob_size
 + 16,

388 
pha£3
, &
pha£3_buåos
);

392 
	`add_£cur™y_bufãr
(0x14, 
Álm_»¥Ú£
, 24, 
pha£3
, &
pha£3_buåos
);

396 
	`add_£cur™y_bufãr
(0x24, 
u£ºame
, 
	`¡¾’
(u£ºame), 
pha£3
,

397 &
pha£3_buåos
);

401 
	`add_£cur™y_bufãr
(0x1c, 
domaš
, 
	`¡¾’
(domaš), 
pha£3
, &
pha£3_buåos
);

404 
pha£3
[0x10] = 
pha£3_buåos
;

405 
pha£3
[0x30] = 
pha£3_buåos
;

406 
pha£3
[0x38] = 
pha£3_buåos
;

409 
pha£3
[0x3c] = 0x02;

410 
pha£3
[0x3d] = 0x02;

412  ((cÚ¡ *)
	`make_ba£64_¡ršg2
((*)
pha£3
,

413 
pha£3_buåos
, 
gc
));

414 
	}
}

418 
	$dummy
()

420 
	}
}

	@ntlm.h

1 #iâdeà
NTLM_H


2 
	#NTLM_H


	)

4 #ià
NTLM


6 cÚ¡ *
Álm_pha£_1
(cÚ¡ 
h‰p_´oxy_šfo
 *
p
, 
gc_¬’a
 *
gc
);

8 cÚ¡ *
Álm_pha£_3
(cÚ¡ 
h‰p_´oxy_šfo
 *
p
, cÚ¡ *
pha£_2
, 
gc_¬’a
 *
gc
);

	@occ-inline.h

24 #iâdeà
OCC_INLINE_H


25 
	#OCC_INLINE_H


	)

27 #ifdeà
ENABLE_OCC


33 
šlše
 

34 
	$occ_»£t_İ
()

37 
	}
}

42 
šlše
 

43 
	$check_£nd_occ_»q
(
cÚ‹xt
 *
c
)

45 
	`check_£nd_occ_»q_dowÜk
(
cÚ‹xt
 *
c
);

47 ià(
	`ev’t_timeout_defšed
(&
c
->
c2
.
occ_š‹rv®
)

48 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
occ_š‹rv®
,

49 &
c
->
c2
.
timev®
,

50 (!
	`TO_LINK_DEF
(
c
è&& c->
c2
.
occ_İ
 < 0è? 
ETT_DEFAULT
 : 0))

52 
	`check_£nd_occ_»q_dowÜk
(
c
);

54 
	}
}

59 
šlše
 

60 
	$check_£nd_occ_lßd_‹¡
(
cÚ‹xt
 *
c
)

62 
	`check_£nd_occ_lßd_‹¡_dowÜk
(
cÚ‹xt
 *
c
);

64 ià(
	`ev’t_timeout_defšed
(&
c
->
c2
.
occ_mtu_lßd_‹¡_š‹rv®
)

65 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
occ_mtu_lßd_‹¡_š‹rv®
,

66 &
c
->
c2
.
timev®
,

67 (!
	`TO_LINK_DEF
(
c
è&& c->
c2
.
occ_İ
 < 0è? 
ETT_DEFAULT
 : 0))

69 
	`check_£nd_occ_lßd_‹¡_dowÜk
(
c
);

71 
	}
}

76 
šlše
 

77 
	$check_£nd_occ_msg
(
cÚ‹xt
 *
c
)

79 
	`check_£nd_occ_msg_dowÜk
(
cÚ‹xt
 *
c
);

81 ià(
c
->
c2
.
occ_İ
 >= 0)

83 ià(!
	`TO_LINK_DEF
(
c
))

85 
	`check_£nd_occ_msg_dowÜk
(
c
);

89 
	`tv_ş—r
(&
c
->
c2
.
timev®
);

92 
	}
}

	@occ.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
ENABLE_OCC


34 
	~"occ.h
"

36 
	~"memdbg.h
"

38 
	~"fÜw¬d-šlše.h
"

39 
	~"occ-šlše.h
"

61 cÚ¡ 
ušt8_t
 
	gocc_magic
[] = {

66 cÚ¡ 
mtu_lßd_‹¡
 
	gmtu_lßd_‹¡_£qu’û
[] = {

68 {
OCC_MTU_LOAD_REQUEST
, -1000},

69 {
OCC_MTU_LOAD
, -1000},

70 {
OCC_MTU_LOAD_REQUEST
, -1000},

71 {
OCC_MTU_LOAD
, -1000},

72 {
OCC_MTU_LOAD_REQUEST
, -1000},

73 {
OCC_MTU_LOAD
, -1000},

75 {
OCC_MTU_LOAD_REQUEST
, -750},

76 {
OCC_MTU_LOAD
, -750},

77 {
OCC_MTU_LOAD_REQUEST
, -750},

78 {
OCC_MTU_LOAD
, -750},

79 {
OCC_MTU_LOAD_REQUEST
, -750},

80 {
OCC_MTU_LOAD
, -750},

82 {
OCC_MTU_LOAD_REQUEST
, -500},

83 {
OCC_MTU_LOAD
, -500},

84 {
OCC_MTU_LOAD_REQUEST
, -500},

85 {
OCC_MTU_LOAD
, -500},

86 {
OCC_MTU_LOAD_REQUEST
, -500},

87 {
OCC_MTU_LOAD
, -500},

89 {
OCC_MTU_LOAD_REQUEST
, -400},

90 {
OCC_MTU_LOAD
, -400},

91 {
OCC_MTU_LOAD_REQUEST
, -400},

92 {
OCC_MTU_LOAD
, -400},

93 {
OCC_MTU_LOAD_REQUEST
, -400},

94 {
OCC_MTU_LOAD
, -400},

96 {
OCC_MTU_LOAD_REQUEST
, -300},

97 {
OCC_MTU_LOAD
, -300},

98 {
OCC_MTU_LOAD_REQUEST
, -300},

99 {
OCC_MTU_LOAD
, -300},

100 {
OCC_MTU_LOAD_REQUEST
, -300},

101 {
OCC_MTU_LOAD
, -300},

103 {
OCC_MTU_LOAD_REQUEST
, -200},

104 {
OCC_MTU_LOAD
, -200},

105 {
OCC_MTU_LOAD_REQUEST
, -200},

106 {
OCC_MTU_LOAD
, -200},

107 {
OCC_MTU_LOAD_REQUEST
, -200},

108 {
OCC_MTU_LOAD
, -200},

110 {
OCC_MTU_LOAD_REQUEST
, -150},

111 {
OCC_MTU_LOAD
, -150},

112 {
OCC_MTU_LOAD_REQUEST
, -150},

113 {
OCC_MTU_LOAD
, -150},

114 {
OCC_MTU_LOAD_REQUEST
, -150},

115 {
OCC_MTU_LOAD
, -150},

117 {
OCC_MTU_LOAD_REQUEST
, -100},

118 {
OCC_MTU_LOAD
, -100},

119 {
OCC_MTU_LOAD_REQUEST
, -100},

120 {
OCC_MTU_LOAD
, -100},

121 {
OCC_MTU_LOAD_REQUEST
, -100},

122 {
OCC_MTU_LOAD
, -100},

124 {
OCC_MTU_LOAD_REQUEST
, -50},

125 {
OCC_MTU_LOAD
, -50},

126 {
OCC_MTU_LOAD_REQUEST
, -50},

127 {
OCC_MTU_LOAD
, -50},

128 {
OCC_MTU_LOAD_REQUEST
, -50},

129 {
OCC_MTU_LOAD
, -50},

131 {
OCC_MTU_LOAD_REQUEST
, 0},

132 {
OCC_MTU_LOAD
, 0},

133 {
OCC_MTU_LOAD_REQUEST
, 0},

134 {
OCC_MTU_LOAD
, 0},

135 {
OCC_MTU_LOAD_REQUEST
, 0},

136 {
OCC_MTU_LOAD
, 0},

138 {
OCC_MTU_REQUEST
, 0},

139 {
OCC_MTU_REQUEST
, 0},

140 {
OCC_MTU_REQUEST
, 0},

141 {
OCC_MTU_REQUEST
, 0},

142 {
OCC_MTU_REQUEST
, 0},

143 {
OCC_MTU_REQUEST
, 0},

144 {
OCC_MTU_REQUEST
, 0},

145 {
OCC_MTU_REQUEST
, 0},

146 {
OCC_MTU_REQUEST
, 0},

147 {
OCC_MTU_REQUEST
, 0},

153 
	$check_£nd_occ_»q_dowÜk
(
cÚ‹xt
 *
c
)

155 ià(++
c
->
c2
.
occ_n_Œ›s
 >ğ
OCC_N_TRIES
)

157 ià(
c
->
İtiÚs
.
û
.
»mÙe
)

163 
	`msg
(
D_SHOW_OCC
,

166 
PACKAGE_NAME


168 
PACKAGE_NAME


169 " from„uÂšg (" 
couÁ”_fÜm©
 " bytes„eceived from…eer, " counter_format

172 
c
->
c2
.
lšk_»ad_by‹s
,

173 
c
->
c2
.
lšk_»ad_by‹s_auth
);

175 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
occ_š‹rv®
);

179 
c
->
c2
.
occ_İ
 = 
OCC_REQUEST
;

185 
	`ev’t_timeout_»£t
(&
c
->
c2
.
occ_š‹rv®
);

187 
	}
}

190 
	$check_£nd_occ_lßd_‹¡_dowÜk
(
cÚ‹xt
 *
c
)

192 ià(
	`CONNECTION_ESTABLISHED
(
c
))

194 cÚ¡ 
mtu_lßd_‹¡
 *
’Œy
;

196 ià(!
c
->
c2
.
occ_mtu_lßd_n_Œ›s
)

198 
	`msg
(
M_INFO
,

202 
’Œy
 = &
mtu_lßd_‹¡_£qu’û
[
c
->
c2
.
occ_mtu_lßd_n_Œ›s
++];

203 ià(
’Œy
->
İ
 >= 0)

205 
c
->
c2
.
occ_İ
 = 
’Œy
->
İ
;

206 
c
->
c2
.
occ_mtu_lßd_size
 =

207 
	`EXPANDED_SIZE
(&
c
->
c2
.
äame
è+ 
’Œy
->
d–
;

211 
	`msg
(
M_INFO
,

212 "NOTE: faedØempœiÿÎy m—su» MTU (»quœe " 
PACKAGE_NAME
 " 1.5 or higher‡t otherƒnd of connection).");

213 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
occ_mtu_lßd_‹¡_š‹rv®
);

214 
c
->
c2
.
occ_mtu_lßd_n_Œ›s
 = 0;

217 
	}
}

220 
	$check_£nd_occ_msg_dowÜk
(
cÚ‹xt
 *
c
)

222 
boŞ
 
do™
 = 
çl£
;

224 
c
->
c2
.
buf
 = c->c2.
bufãrs
->
aux_buf
;

225 
	`ASSERT
(
	`buf_š™
(&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
(&c->c2.
äame
)));

226 
	`ASSERT
(
	`buf_§ã
(&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
)));

227 
	`ASSERT
(
	`buf_wr™e
(&
c
->
c2
.
buf
, 
occ_magic
, 
OCC_STRING_SIZE
));

229 
c
->
c2
.
occ_İ
)

231 
OCC_REQUEST
:

232 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_REQUEST
))

236 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_REQUEST");

237 
do™
 = 
Œue
;

240 
OCC_REPLY
:

241 ià(!
c
->
c2
.
İtiÚs_¡ršg_loÿl
)

245 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_REPLY
))

249 ià(!
	`buf_wr™e
(&
c
->
c2
.
buf
, c->c2.
İtiÚs_¡ršg_loÿl
,

250 
	`¡¾’
(
c
->
c2
.
İtiÚs_¡ršg_loÿl
) + 1))

254 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_REPLY");

255 
do™
 = 
Œue
;

258 
OCC_MTU_REQUEST
:

259 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_MTU_REQUEST
))

263 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_MTU_REQUEST");

264 
do™
 = 
Œue
;

267 
OCC_MTU_REPLY
:

268 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_MTU_REPLY
))

272 ià(!
	`buf_wr™e_u16
(&
c
->
c2
.
buf
, c->c2.
max_»cv_size_loÿl
))

276 ià(!
	`buf_wr™e_u16
(&
c
->
c2
.
buf
, c->c2.
max_£nd_size_loÿl
))

280 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_MTU_REPLY");

281 
do™
 = 
Œue
;

284 
OCC_MTU_LOAD_REQUEST
:

285 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_MTU_LOAD_REQUEST
))

289 ià(!
	`buf_wr™e_u16
(&
c
->
c2
.
buf
, c->c2.
occ_mtu_lßd_size
))

293 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_MTU_LOAD_REQUEST");

294 
do™
 = 
Œue
;

297 
OCC_MTU_LOAD
:

299 
Ãed_to_add
;

301 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_MTU_LOAD
))

305 
Ãed_to_add
 = 
	`mš_št
(
c
->
c2
.
occ_mtu_lßd_size
, 
	`EXPANDED_SIZE
(&c->c2.
äame
))

306 - 
OCC_STRING_SIZE


307 - (
ušt8_t
)

308 - 
	`EXTRA_FRAME
(&
c
->
c2
.
äame
);

310 
Ãed_to_add
 > 0)

315 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
	`g‘_¿ndom
() & 0xFF))

319 --
Ãed_to_add
;

321 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_MTU_LOAD min_int(%d-%d-%d-%d,%d) size=%d",

322 
c
->
c2
.
occ_mtu_lßd_size
,

323 
OCC_STRING_SIZE
,

324 (è(
ušt8_t
),

325 
	`EXTRA_FRAME
(&
c
->
c2
.
äame
),

326 
	`MAX_RW_SIZE_TUN
(&
c
->
c2
.
äame
),

327 
	`BLEN
(&
c
->
c2
.
buf
));

328 
do™
 = 
Œue
;

332 
OCC_EXIT
:

333 ià(!
	`buf_wr™e_u8
(&
c
->
c2
.
buf
, 
OCC_EXIT
))

337 
	`dmsg
(
D_PACKET_CONTENT
, "SENT OCC_EXIT");

338 
do™
 = 
Œue
;

342 ià(
do™
)

348 
	`’üy±_sign
(
c
, 
Œue
);

351 
c
->
c2
.
occ_İ
 = -1;

352 
	}
}

355 
	$´oûss_»ûived_occ_msg
(
cÚ‹xt
 *
c
)

357 
	`ASSERT
(
	`buf_advªû
(&
c
->
c2
.
buf
, 
OCC_STRING_SIZE
));

358 
	`buf_»ad_u8
(&
c
->
c2
.
buf
))

360 
OCC_REQUEST
:

361 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_REQUEST");

362 
c
->
c2
.
occ_İ
 = 
OCC_REPLY
;

365 
OCC_MTU_REQUEST
:

366 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_REQUEST");

367 
c
->
c2
.
occ_İ
 = 
OCC_MTU_REPLY
;

370 
OCC_MTU_LOAD_REQUEST
:

371 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_LOAD_REQUEST");

372 
c
->
c2
.
occ_mtu_lßd_size
 = 
	`buf_»ad_u16
(&c->c2.
buf
);

373 ià(
c
->
c2
.
occ_mtu_lßd_size
 >= 0)

375 
c
->
c2
.
occ_İ
 = 
OCC_MTU_LOAD
;

379 
OCC_REPLY
:

380 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_REPLY");

381 ià(
c
->
İtiÚs
.
occ
 && !
	`TLS_MODE
(cè&& c->
c2
.
İtiÚs_¡ršg_»mÙe
)

383 ià(!
	`İtiÚs_cmp_equ®_§ã
((*è
	`BPTR
(&
c
->
c2
.
buf
),

384 
c
->
c2
.
İtiÚs_¡ršg_»mÙe
,

385 
c
->
c2
.
buf
.
Ën
))

387 
	`İtiÚs_w¬nšg_§ã
((*è
	`BPTR
(&
c
->
c2
.
buf
),

388 
c
->
c2
.
İtiÚs_¡ršg_»mÙe
,

389 
c
->
c2
.
buf
.
Ën
);

392 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
occ_š‹rv®
);

395 
OCC_MTU_REPLY
:

396 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_MTU_REPLY");

397 
c
->
c2
.
max_»cv_size_»mÙe
 = 
	`buf_»ad_u16
(&c->c2.
buf
);

398 
c
->
c2
.
max_£nd_size_»mÙe
 = 
	`buf_»ad_u16
(&c->c2.
buf
);

399 ià(
c
->
İtiÚs
.
mtu_‹¡


400 && 
c
->
c2
.
max_»cv_size_»mÙe
 > 0

401 && 
c
->
c2
.
max_£nd_size_»mÙe
 > 0)

403 
	`msg
(
M_INFO
, "NOTE: Empirical MTUest completed [Tried,Actual]†ocal->remote=[%d,%d]„emote->local=[%d,%d]",

404 
c
->
c2
.
max_£nd_size_loÿl
,

405 
c
->
c2
.
max_»cv_size_»mÙe
,

406 
c
->
c2
.
max_£nd_size_»mÙe
,

407 
c
->
c2
.
max_»cv_size_loÿl
);

408 ià(!
c
->
İtiÚs
.
û
.
äagm’t


409 && (
	`´Ùo_is_dg¿m
(
c
->
İtiÚs
.
û
.
´Ùo
))

410 && 
c
->
c2
.
max_£nd_size_loÿl
 > 
TUN_MTU_MIN


411 && (
c
->
c2
.
max_»cv_size_»mÙe
 < c->c2.
max_£nd_size_loÿl


412 || 
c
->
c2
.
max_»cv_size_loÿl
 < c->c2.
max_£nd_size_»mÙe
))

414 
	`msg
(
M_INFO
, "NOTE: This connection is unableo‡ccommodate‡ UDP…acket size of %d. Consider using --fragment or --mssfix options‡s‡ workaround.",

415 
c
->
c2
.
max_£nd_size_loÿl
);

418 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
occ_mtu_lßd_‹¡_š‹rv®
);

421 
OCC_EXIT
:

422 
	`dmsg
(
D_PACKET_CONTENT
, "RECEIVED OCC_EXIT");

423 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

424 
c
->
sig
->
sigÇl_‹xt
 = "remote-exit";

427 
c
->
c2
.
buf
.
Ën
 = 0;

428 
	}
}

432 
	$dummy
()

434 
	}
}

	@occ.h

24 #iâdeà
OCC_H


25 
	#OCC_H


	)

27 #ifdeà
ENABLE_OCC


29 
	~"fÜw¬d.h
"

32 
	#OCC_STRING_SIZE
 16

	)

38 
	#OCC_REQUEST
 0

	)

39 
	#OCC_REPLY
 1

	)

48 
	#OCC_INTERVAL_SECONDS
 10

	)

49 
	#OCC_N_TRIES
 12

	)

54 
	#OCC_MTU_LOAD_REQUEST
 2

	)

55 
	#OCC_MTU_LOAD
 3

	)

56 
	#OCC_MTU_REQUEST
 4

	)

58 
	#OCC_MTU_REPLY
 5

	)

64 
	#OCC_MTU_LOAD_INTERVAL_SECONDS
 3

	)

69 
	#OCC_EXIT
 6

	)

75 
	smtu_lßd_‹¡


77 
	mİ
;

78 
	md–
;

83 cÚ¡ 
ušt8_t
 
occ_magic
[];

85 
šlše
 
boŞ


86 
	$is_occ_msg
(cÚ¡ 
bufãr
 *
buf
)

88  
	`buf_¡ršg_m©ch_h—d
(
buf
, 
occ_magic
, 
OCC_STRING_SIZE
);

89 
	}
}

91 
´oûss_»ûived_occ_msg
(
cÚ‹xt
 *
c
);

	@openssl_compat.h

34 #iâdeà
OPENSSL_COMPAT_H_


35 
	#OPENSSL_COMPAT_H_


	)

37 #ifdeà
HAVE_CONFIG_H


38 
	~"cÚfig.h
"

39 #–ià
defšed
(
_MSC_VER
)

40 
	~"cÚfig-msvc.h
"

43 
	~"bufãr.h
"

45 
	~<İ’s¦/s¦.h
>

46 
	~<İ’s¦/x509.h
>

48 #ià!
defšed
(
HAVE_EVP_MD_CTX_RESET
)

55 
šlše
 

56 
	$EVP_MD_CTX_»£t
(
EVP_MD_CTX
 *
ùx
)

58 
	`EVP_MD_CTX_ş—nup
(
ùx
);

60 
	}
}

63 #ià!
defšed
(
HAVE_EVP_MD_CTX_FREE
)

69 
šlše
 

70 
	$EVP_MD_CTX_ä“
(
EVP_MD_CTX
 *
ùx
)

72 
	`ä“
(
ùx
);

73 
	}
}

76 #ià!
defšed
(
HAVE_EVP_MD_CTX_NEW
)

82 
šlše
 
EVP_MD_CTX
 *

83 
	$EVP_MD_CTX_Ãw
()

85 
EVP_MD_CTX
 *
ùx
 = 
NULL
;

86 
	`ALLOC_OBJ_CLEAR
(
ùx
, 
EVP_MD_CTX
);

87  
ùx
;

88 
	}
}

91 #ià!
defšed
(
HAVE_HMAC_CTX_RESET
)

107 
šlše
 

108 
	$HMAC_CTX_»£t
(
HMAC_CTX
 *
ùx
)

110 
	`HMAC_CTX_ş—nup
(
ùx
);

111 
	`HMAC_CTX_š™
(
ùx
);

113 
	}
}

116 #ià!
defšed
(
HAVE_HMAC_CTX_FREE
)

122 
šlše
 

123 
	$HMAC_CTX_ä“
(
HMAC_CTX
 *
ùx
)

125 
	`HMAC_CTX_ş—nup
(
ùx
);

126 
	`ä“
(
ùx
);

127 
	}
}

130 #ià!
defšed
(
HAVE_HMAC_CTX_NEW
)

136 
šlše
 
HMAC_CTX
 *

137 
	$HMAC_CTX_Ãw
()

139 
HMAC_CTX
 *
ùx
 = 
NULL
;

140 
	`ALLOC_OBJ_CLEAR
(
ùx
, 
HMAC_CTX
);

141  
ùx
;

142 
	}
}

145 #ià!
defšed
(
HAVE_SSL_CTX_GET_DEFAULT_PASSWD_CB_USERDATA
)

152 
šlše
 *

153 
	$SSL_CTX_g‘_deçuÉ_·sswd_cb_u£rd©a
(
SSL_CTX
 *
ùx
)

155  
ùx
 ? ctx->
deçuÉ_·sswd_ÿÎback_u£rd©a
 : 
NULL
;

156 
	}
}

159 #ià!
defšed
(
HAVE_SSL_CTX_GET_DEFAULT_PASSWD_CB
)

166 
šlše
 
³m_·sswÜd_cb
 *

167 
	$SSL_CTX_g‘_deçuÉ_·sswd_cb
(
SSL_CTX
 *
ùx
)

169  
ùx
 ? ctx->
deçuÉ_·sswd_ÿÎback
 : 
NULL
;

170 
	}
}

173 #ià!
defšed
(
HAVE_X509_GET0_PUBKEY
)

180 
šlše
 
EVP_PKEY
 *

181 
	$X509_g‘0_pubkey
(cÚ¡ 
X509
 *
x
)

183  (
x
 && x->
û¹_šfo
 && x->û¹_šfo->
key
) ?

184 
x
->
û¹_šfo
->
key
->
pkey
 : 
NULL
;

185 
	}
}

188 #ià!
defšed
(
HAVE_X509_STORE_GET0_OBJECTS
)

195 
šlše
 
STACK_OF
(
X509_OBJECT
) *

196 
	$X509_STORE_g‘0_objeùs
(
X509_STORE
 *
¡Üe
)

198  
¡Üe
 ? stÜe->
objs
 : 
NULL
;

199 
	}
}

202 #ià!
defšed
(
HAVE_X509_OBJECT_FREE
)

208 
šlše
 

209 
	$X509_OBJECT_ä“
(
X509_OBJECT
 *
obj
)

211 ià(
obj
)

213 
	`X509_OBJECT_ä“_cÚ‹Ás
(
obj
);

214 
	`OPENSSL_ä“
(
obj
);

216 
	}
}

219 #ià!
defšed
(
HAVE_X509_OBJECT_GET_TYPE
)

226 
šlše
 

227 
	$X509_OBJECT_g‘_ty³
(cÚ¡ 
X509_OBJECT
 *
obj
)

229  
obj
 ? obj->
ty³
 : 
X509_LU_FAIL
;

230 
	}
}

233 #ià!
defšed
(
HAVE_EVP_PKEY_GET0_RSA
)

240 
šlše
 
RSA
 *

241 
	$EVP_PKEY_g‘0_RSA
(
EVP_PKEY
 *
pkey
)

243  (
pkey
 &&…key->
ty³
 =ğ
EVP_PKEY_RSA
è?…key->pkey.
r§
 : 
NULL
;

244 
	}
}

247 #ià!
defšed
(
HAVE_EVP_PKEY_GET0_EC_KEY
è&& !defšed(
OPENSSL_NO_EC
)

254 
šlše
 
EC_KEY
 *

255 
	$EVP_PKEY_g‘0_EC_KEY
(
EVP_PKEY
 *
pkey
)

257  (
pkey
 &&…key->
ty³
 =ğ
EVP_PKEY_EC
è?…key->pkey.
ec
 : 
NULL
;

258 
	}
}

261 #ià!
defšed
(
HAVE_EVP_PKEY_ID
)

268 
šlše
 

269 
	$EVP_PKEY_id
(cÚ¡ 
EVP_PKEY
 *
pkey
)

271  
pkey
 ?…key->
ty³
 : 
EVP_PKEY_NONE
;

272 
	}
}

275 #ià!
defšed
(
HAVE_EVP_PKEY_GET0_DSA
)

282 
šlše
 
DSA
 *

283 
	$EVP_PKEY_g‘0_DSA
(
EVP_PKEY
 *
pkey
)

285  (
pkey
 &&…key->
ty³
 =ğ
EVP_PKEY_DSA
è?…key->pkey.
d§
 : 
NULL
;

286 
	}
}

289 #ià!
defšed
(
HAVE_RSA_SET_FLAGS
)

296 
šlše
 

297 
	$RSA_£t_æags
(
RSA
 *
r§
, 
æags
)

299 ià(
r§
)

301 
r§
->
æags
 = flags;

303 
	}
}

306 #ià!
defšed
(
HAVE_RSA_GET0_KEY
)

315 
šlše
 

316 
	$RSA_g‘0_key
(cÚ¡ 
RSA
 *
r§
, cÚ¡ 
BIGNUM
 **
n
,

317 cÚ¡ 
BIGNUM
 **
e
, cÚ¡ BIGNUM **
d
)

319 ià(
n
 !ğ
NULL
)

321 *
n
 = 
r§
 ?„§->À: 
NULL
;

323 ià(
e
 !ğ
NULL
)

325 *
e
 = 
r§
 ?„§->: 
NULL
;

327 ià(
d
 !ğ
NULL
)

329 *
d
 = 
r§
 ?„§->d : 
NULL
;

331 
	}
}

334 #ià!
defšed
(
HAVE_RSA_SET0_KEY
)

344 
šlše
 

345 
	$RSA_£t0_key
(
RSA
 *
r§
, 
BIGNUM
 *
n
, BIGNUM *
e
, BIGNUM *
d
)

347 ià((
r§
->
n
 =ğ
NULL
 &&‚ == NULL)

348 || (
r§
->
e
 =ğ
NULL
 &&ƒ == NULL))

353 ià(
n
 !ğ
NULL
)

355 
	`BN_ä“
(
r§
->
n
);

356 
r§
->
n
 =‚;

358 ià(
e
 !ğ
NULL
)

360 
	`BN_ä“
(
r§
->
e
);

361 
r§
->
e
 =ƒ;

363 ià(
d
 !ğ
NULL
)

365 
	`BN_ä“
(
r§
->
d
);

366 
r§
->
d
 = d;

370 
	}
}

373 #ià!
defšed
(
HAVE_RSA_BITS
)

380 
šlše
 

381 
	$RSA_b™s
(cÚ¡ 
RSA
 *
r§
)

383 cÚ¡ 
BIGNUM
 *
n
 = 
NULL
;

384 
	`RSA_g‘0_key
(
r§
, &
n
, 
NULL
, NULL);

385  
n
 ? 
	`BN_num_b™s
(n) : 0;

386 
	}
}

389 #ià!
defšed
(
HAVE_DSA_GET0_PQG
)

398 
šlše
 

399 
	$DSA_g‘0_pqg
(cÚ¡ 
DSA
 *
d§
, cÚ¡ 
BIGNUM
 **
p
,

400 cÚ¡ 
BIGNUM
 **
q
, cÚ¡ BIGNUM **
g
)

402 ià(
p
 !ğ
NULL
)

404 *
p
 = 
d§
 ? d§->°: 
NULL
;

406 ià(
q
 !ğ
NULL
)

408 *
q
 = 
d§
 ? d§->q : 
NULL
;

410 ià(
g
 !ğ
NULL
)

412 *
g
 = 
d§
 ? d§->g : 
NULL
;

414 
	}
}

417 #ià!
defšed
(
HAVE_DSA_BITS
)

424 
šlše
 

425 
	$DSA_b™s
(cÚ¡ 
DSA
 *
d§
)

427 cÚ¡ 
BIGNUM
 *
p
 = 
NULL
;

428 
	`DSA_g‘0_pqg
(
d§
, &
p
, 
NULL
, NULL);

429  
p
 ? 
	`BN_num_b™s
(p) : 0;

430 
	}
}

433 #ià!
defšed
(
HAVE_RSA_METH_NEW
)

441 
šlše
 
RSA_METHOD
 *

442 
	$RSA_m‘h_Ãw
(cÚ¡ *
Çme
, 
æags
)

444 
RSA_METHOD
 *
r§_m‘h
 = 
NULL
;

445 
	`ALLOC_OBJ_CLEAR
(
r§_m‘h
, 
RSA_METHOD
);

446 
r§_m‘h
->
Çme
 = 
	`¡ršg_®loc
Òame, 
NULL
);

447 
r§_m‘h
->
æags
 = flags;

448  
r§_m‘h
;

449 
	}
}

452 #ià!
defšed
(
HAVE_RSA_METH_FREE
)

458 
šlše
 

459 
	$RSA_m‘h_ä“
(
RSA_METHOD
 *
m‘h
)

461 ià(
m‘h
)

469 
	`ä“
((*)
m‘h
->
Çme
);

470 
	`ä“
(
m‘h
);

472 
	}
}

475 #ià!
defšed
(
HAVE_RSA_METH_SET_PUB_ENC
)

483 
šlše
 

484 
	$RSA_m‘h_£t_pub_’c
(
RSA_METHOD
 *
m‘h
,

485 (*
pub_’c
è(
æ’
, cÚ¡ *
äom
,

486 *
to
, 
RSA
 *
r§
,

487 
·ddšg
))

489 ià(
m‘h
)

491 
m‘h
->
r§_pub_’c
 = 
pub_’c
;

495 
	}
}

498 #ià!
defšed
(
HAVE_RSA_METH_SET_PUB_DEC
)

506 
šlše
 

507 
	$RSA_m‘h_£t_pub_dec
(
RSA_METHOD
 *
m‘h
,

508 (*
pub_dec
è(
æ’
, cÚ¡ *
äom
,

509 *
to
, 
RSA
 *
r§
,

510 
·ddšg
))

512 ià(
m‘h
)

514 
m‘h
->
r§_pub_dec
 = 
pub_dec
;

518 
	}
}

521 #ià!
defšed
(
HAVE_RSA_METH_SET_PRIV_ENC
)

529 
šlše
 

530 
	$RSA_m‘h_£t_´iv_’c
(
RSA_METHOD
 *
m‘h
,

531 (*
´iv_’c
è(
æ’
, cÚ¡ *
äom
,

532 *
to
, 
RSA
 *
r§
,

533 
·ddšg
))

535 ià(
m‘h
)

537 
m‘h
->
r§_´iv_’c
 = 
´iv_’c
;

541 
	}
}

544 #ià!
defšed
(
HAVE_RSA_METH_SET_PRIV_DEC
)

552 
šlše
 

553 
	$RSA_m‘h_£t_´iv_dec
(
RSA_METHOD
 *
m‘h
,

554 (*
´iv_dec
è(
æ’
, cÚ¡ *
äom
,

555 *
to
, 
RSA
 *
r§
,

556 
·ddšg
))

558 ià(
m‘h
)

560 
m‘h
->
r§_´iv_dec
 = 
´iv_dec
;

564 
	}
}

567 #ià!
defšed
(
HAVE_RSA_METH_SET_INIT
)

575 
šlše
 

576 
	$RSA_m‘h_£t_š™
(
RSA_METHOD
 *
m‘h
, (*
š™
è(
RSA
 *
r§
))

578 ià(
m‘h
)

580 
m‘h
->
š™
 = init;

584 
	}
}

587 #ià!
defšed
 (
HAVE_RSA_METH_SET_SIGN
)

595 
šlše


596 
	$RSA_m‘h_£t_sign
(
RSA_METHOD
 *
m‘h
,

597 (*
sign
è(
ty³
, cÚ¡ *
m
,

598 
m_Ëngth
,

599 *
sig»t
, *
sigËn
,

600 cÚ¡ 
RSA
 *
r§
))

602 
m‘h
->
r§_sign
 = 
sign
;

604 
	}
}

607 #ià!
defšed
(
HAVE_RSA_METH_SET_FINISH
)

615 
šlše
 

616 
	$RSA_m‘h_£t_fšish
(
RSA_METHOD
 *
m‘h
, (*
fšish
è(
RSA
 *
r§
))

618 ià(
m‘h
)

620 
m‘h
->
fšish
 = finish;

624 
	}
}

627 #ià!
defšed
(
HAVE_RSA_METH_SET0_APP_DATA
)

635 
šlše
 

636 
	$RSA_m‘h_£t0_­p_d©a
(
RSA_METHOD
 *
m‘h
, *
­p_d©a
)

638 ià(
m‘h
)

640 
m‘h
->
­p_d©a
 =‡pp_data;

644 
	}
}

647 #ià!
defšed
(
HAVE_RSA_METH_GET0_APP_DATA
)

654 
šlše
 *

655 
	$RSA_m‘h_g‘0_­p_d©a
(cÚ¡ 
RSA_METHOD
 *
m‘h
)

657  
m‘h
 ? m‘h->
­p_d©a
 : 
NULL
;

658 
	}
}

661 #ià!
defšed
(
HAVE_EC_GROUP_ORDER_BITS
è&& !defšed(
OPENSSL_NO_EC
)

668 
šlše
 

669 
	$EC_GROUP_Üd”_b™s
(cÚ¡ 
EC_GROUP
 *
group
)

671 
BIGNUM
* 
Üd”
 = 
	`BN_Ãw
();

672 
	`EC_GROUP_g‘_Üd”
(
group
, 
Üd”
, 
NULL
);

673 
b™s
 = 
	`BN_num_b™s
(
Üd”
);

674 
	`BN_ä“
(
Üd”
);

675  
b™s
;

676 
	}
}

680 #ià!
defšed
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
)

681 
	#RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
 
RSA_F_RSA_EAY_PRIVATE_ENCRYPT


	)

684 #iâdeà
SSL_CTX_g‘_mš_´Ùo_v”siÚ


687 
šlše
 

688 
	$SSL_CTX_g‘_mš_´Ùo_v”siÚ
(
SSL_CTX
 *
ùx
)

690 
s¦İt
 = 
	`SSL_CTX_g‘_İtiÚs
(
ùx
);

691 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1
))

693  
TLS1_VERSION
;

695 #ifdeà
SSL_OP_NO_TLSv1_1


696 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1_1
))

698  
TLS1_1_VERSION
;

701 #ifdeà
SSL_OP_NO_TLSv1_2


702 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1_2
))

704  
TLS1_2_VERSION
;

708 
	}
}

711 #iâdeà
SSL_CTX_g‘_max_´Ùo_v”siÚ


714 
šlše
 

715 
	$SSL_CTX_g‘_max_´Ùo_v”siÚ
(
SSL_CTX
 *
ùx
)

717 
s¦İt
 = 
	`SSL_CTX_g‘_İtiÚs
(
ùx
);

718 #ifdeà
SSL_OP_NO_TLSv1_2


719 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1_2
))

721  
TLS1_2_VERSION
;

724 #ifdeà
SSL_OP_NO_TLSv1_1


725 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1_1
))

727  
TLS1_1_VERSION
;

730 ià(!(
s¦İt
 & 
SSL_OP_NO_TLSv1
))

732  
TLS1_VERSION
;

735 
	}
}

738 #iâdeà
SSL_CTX_£t_mš_´Ùo_v”siÚ


740 
šlše
 

741 
	$SSL_CTX_£t_mš_´Ùo_v”siÚ
(
SSL_CTX
 *
ùx
, 
s_v”_mš
)

743 
s¦İt
 = 
SSL_OP_NO_SSLv2
 | 
SSL_OP_NO_SSLv3
;

745 ià(
s_v”_mš
 > 
TLS1_VERSION
)

747 
s¦İt
 |ğ
SSL_OP_NO_TLSv1
;

749 #ifdeà
SSL_OP_NO_TLSv1_1


750 ià(
s_v”_mš
 > 
TLS1_1_VERSION
)

752 
s¦İt
 |ğ
SSL_OP_NO_TLSv1_1
;

755 #ifdeà
SSL_OP_NO_TLSv1_2


756 ià(
s_v”_mš
 > 
TLS1_2_VERSION
)

758 
s¦İt
 |ğ
SSL_OP_NO_TLSv1_2
;

761 
	`SSL_CTX_£t_İtiÚs
(
ùx
, 
s¦İt
);

764 
	}
}

767 #iâdeà
SSL_CTX_£t_max_´Ùo_v”siÚ


769 
šlše
 

770 
	$SSL_CTX_£t_max_´Ùo_v”siÚ
(
SSL_CTX
 *
ùx
, 
s_v”_max
)

772 
s¦İt
 = 0;

774 ià(
s_v”_max
 < 
TLS1_VERSION
)

776 
s¦İt
 |ğ
SSL_OP_NO_TLSv1
;

778 #ifdeà
SSL_OP_NO_TLSv1_1


779 ià(
s_v”_max
 < 
TLS1_1_VERSION
)

781 
s¦İt
 |ğ
SSL_OP_NO_TLSv1_1
;

784 #ifdeà
SSL_OP_NO_TLSv1_2


785 ià(
s_v”_max
 < 
TLS1_2_VERSION
)

787 
s¦İt
 |ğ
SSL_OP_NO_TLSv1_2
;

790 
	`SSL_CTX_£t_İtiÚs
(
ùx
, 
s¦İt
);

793 
	}
}

	@openvpn.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"š™.h
"

33 
	~"fÜw¬d.h
"

34 
	~"muÉi.h
"

35 
	~"wš32.h
"

36 
	~"¶©fÜm.h
"

38 
	~"memdbg.h
"

40 
	~"fÜw¬d-šlše.h
"

42 
	#P2P_CHECK_SIG
(è
	`EVENT_LOOP_CHECK_SIGNAL
(
c
, 
´oûss_sigÇl_p2p
, c);

	)

44 
boŞ


45 
	$´oûss_sigÇl_p2p
(
cÚ‹xt
 *
c
)

47 
	`»m­_sigÇl
(
c
);

48  
	`´oûss_sigÇl
(
c
);

49 
	}
}

53 
	$wr™e_pid
(cÚ¡ *
f’ame
)

55 ià(
f’ame
)

57 
pid
 = 0;

58 
FILE
 *
å
 = 
	`¶©fÜm_fİ’
(
f’ame
, "w");

59 ià(!
å
)

61 
	`msg
(
M_ERR
, "O³À”rÜ oÀpid f%s", 
f’ame
);

64 
pid
 = 
	`¶©fÜm_g‘pid
();

65 
	`årštf
(
å
, "%u\n", 
pid
);

66 ià(
	`fşo£
(
å
))

68 
	`msg
(
M_ERR
, "Clo£ƒ¼Ü oÀpid f%s", 
f’ame
);

71 
	}
}

83 
	$tuÂ–_pošt_to_pošt
(
cÚ‹xt
 *
c
)

85 
	`cÚ‹xt_ş—r_2
(
c
);

88 
c
->
mode
 = 
CM_P2P
;

91 
	`š™_š¡ªû_hªdË_sigÇls
(
c
, c->
es
, 
CC_HARD_USR1_TO_HUP
);

92 ià(
	`IS_SIG
(
c
))

98 
Œue
)

100 
	`³rf_push
(
PERF_EVENT_LOOP
);

103 
	`´e_£Ëù
(
c
);

104 
	`P2P_CHECK_SIG
();

107 
	`io_wa™
(
c
, 
	`p2p_iow_æags
(c));

108 
	`P2P_CHECK_SIG
();

111 ià(
c
->
c2
.
ev’t_£t_¡©us
 =ğ
ES_TIMEOUT
)

113 
	`³rf_pİ
();

118 
	`´oûss_io
(
c
);

119 
	`P2P_CHECK_SIG
();

121 
	`³rf_pİ
();

124 
	`unš™_mªagem’t_ÿÎback
();

127 
	`şo£_š¡ªû
(
c
);

128 
	}
}

130 #undeà
PROCESS_SIGNAL_P2P


155 
	$İ’v²_maš
(
¬gc
, *
¬gv
[])

157 
cÚ‹xt
 
c
;

159 #ià
PEDANTIC


160 
	`årštf
(
¡d”r
, "Sorry, I was built with --enable-pedantic‡nd I‡m incapable of doing‡ny„eal work!\n");

164 #ifdeà
_WIN32


165 
	`S‘CÚsŞeOuutCP
(
CP_UTF8
);

168 
	`CLEAR
(
c
);

172 
c
.
fœ¡_time
 = 
Œue
;

175 ià(
	`š™_¡©ic
())

184 
	`´e_š™_sigÇl_ÿtch
();

187 
	`cÚ‹xt_ş—r_®l_exû±_fœ¡_time
(&
c
);

190 
	`CLEAR
(
sigšfo_¡©ic
);

191 
c
.
sig
 = &
sigšfo_¡©ic
;

194 
	`gc_š™
(&
c
.
gc
);

197 
c
.
es
 = 
	`’v_£t_ü—‹
(
NULL
);

198 #ifdeà
_WIN32


199 
	`£t_wš_sys_·th_vŸ_’v
(
c
.
es
);

202 #ifdeà
ENABLE_MANAGEMENT


204 
	`š™_mªagem’t
(&
c
);

208 
	`š™_İtiÚs
(&
c
.
İtiÚs
, 
Œue
);

211 
	`·r£_¬gv
(&
c
.
İtiÚs
, 
¬gc
, 
¬gv
, 
M_USAGE
, 
OPT_P_DEFAULT
, 
NULL
, c.
es
);

213 #ifdeà
ENABLE_PLUGIN


215 
	`š™_v”b_mu‹
(&
c
, 
IVM_LEVEL_1
);

216 
	`š™_¶ugšs
(&
c
);

217 
	`İ’_¶ugšs
(&
c
, 
Œue
, 
OPENVPN_PLUGIN_INIT_PRE_CONFIG_PARSE
);

221 
	`š™_v”b_mu‹
(&
c
, 
IVM_LEVEL_1
);

224 
	`š™_İtiÚs_dev
(&
c
.
İtiÚs
);

227 ià(
	`´št_İ’s¦_šfo
(&
c
.
İtiÚs
))

233 ià(
	`do_g’key
(&
c
.
İtiÚs
))

239 ià(
	`do_³rsi¡_tuÁ­
(&
c
.
İtiÚs
))

245 
	`İtiÚs_po¡´oûss
(&
c
.
İtiÚs
);

248 
	`show_£‰šgs
(&
c
.
İtiÚs
);

251 
	`msg
(
M_INFO
, "%s", 
t™Ë_¡ršg
);

252 #ifdeà
_WIN32


253 
	`show_wšdows_v”siÚ
(
M_INFO
);

255 
	`show_lib¿ry_v”siÚs
(
M_INFO
);

258 
	`´e_£tup
(&
c
.
İtiÚs
);

261 ià(
	`do_‹¡_üy±o
(&
c
.
İtiÚs
))

268 #ifdeà
ENABLE_MANAGEMENT


269 ià(!(
c
.
İtiÚs
.
mªagem’t_æags
 & 
MF_QUERY_PASSWORDS
))

271 
	`š™_qu”y_·sswÜds
(&
c
);

274 ià(
c
.
fœ¡_time
)

276 
c
.
did_we_d«mÚize
 = 
	`possibly_become_d«mÚ
(&c.
İtiÚs
);

277 
	`wr™e_pid
(
c
.
İtiÚs
.
wr™•id
);

280 #ifdeà
ENABLE_MANAGEMENT


282 ià(!
	`İ’_mªagem’t
(&
c
))

287 ià(
c
.
İtiÚs
.
mªagem’t_æags
 & 
MF_QUERY_PASSWORDS
)

289 
	`š™_qu”y_·sswÜds
(&
c
);

294 
	`£‹nv_£‰šgs
(
c
.
es
, &c.
İtiÚs
);

297 
	`cÚ‹xt_š™_1
(&
c
);

302 
c
.
İtiÚs
.
mode
)

304 
MODE_POINT_TO_POINT
:

305 
	`tuÂ–_pošt_to_pošt
(&
c
);

308 #ià
P2MP_SERVER


309 
MODE_SERVER
:

310 
	`tuÂ–_£rv”
(&
c
);

315 
	`ASSERT
(0);

319 
c
.
fœ¡_time
 = 
çl£
;

322 ià(
	`IS_SIG
(&
c
))

324 
	`´št_sigÇl
(
c
.
sig
, 
NULL
, 
M_INFO
);

328 
	`sigÇl_»¡¬t_¡©us
(
c
.
sig
);

330 
c
.
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
);

332 
	`’v_£t_de¡roy
(
c
.
es
);

333 
	`unš™_İtiÚs
(&
c
.
İtiÚs
);

334 
	`gc_»£t
(&
c
.
gc
);

336 
c
.
sig
->
sigÇl_»ûived
 =ğ
SIGHUP
);

339 
	`cÚ‹xt_gc_ä“
(&
c
);

341 #ifdeà
ENABLE_MANAGEMENT


343 
	`şo£_mªagem’t
();

347 
	`unš™_¡©ic
();

349 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

351 
	}
}

353 #ifdeà
_WIN32


355 
	$wmaš
(
¬gc
, 
wch¬_t
 *
w¬gv
[])

357 **
¬gv
;

358 
»t
;

359 
i
;

361 ià((
¬gv
 = 
	`ÿÎoc
(
¬gc
+1, (*))è=ğ
NULL
)

366 
i
 = 0; i < 
¬gc
; i++)

368 
n
 = 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
w¬gv
[
i
], -1, 
NULL
, 0, NULL, NULL);

369 
¬gv
[
i
] = 
	`m®loc
(
n
);

370 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
w¬gv
[
i
], -1, 
¬gv
[i], 
n
, 
NULL
, NULL);

373 
»t
 = 
	`İ’v²_maš
(
¬gc
, 
¬gv
);

375 
i
 = 0; i < 
¬gc
; i++)

377 
	`ä“
(
¬gv
[
i
]);

379 
	`ä“
(
¬gv
);

381  
»t
;

382 
	}
}

385 
	$maš
(
¬gc
, *
¬gv
[])

387  
	`İ’v²_maš
(
¬gc
, 
¬gv
);

388 
	}
}

	@openvpn.h

24 #iâdeà
OPENVPN_H


25 
	#OPENVPN_H


	)

27 
	~"bufãr.h
"

28 
	~"İtiÚs.h
"

29 
	~"sock‘.h
"

30 
	~"üy±o.h
"

31 
	~"s¦.h
"

32 
	~"·ck‘_id.h
"

33 
	~"comp.h
"

34 
	~"tun.h
"

35 
	~"š‹rv®.h
"

36 
	~"¡©us.h
"

37 
	~"äagm’t.h
"

38 
	~"sh­”.h
"

39 
	~"rou‹.h
"

40 
	~"´oxy.h
"

41 
	~"socks.h
"

42 
	~"sig.h
"

43 
	~"misc.h
"

44 
	~"mbuf.h
"

45 
	~"poŞ.h
"

46 
	~"¶ugš.h
"

47 
	~"mªage.h
"

48 
	~"pf.h
"

55 
	skey_scheduË


57 #ifdeà
ENABLE_CRYPTO


59 
key_ty³
 
	mkey_ty³
;

62 
key_ùx_bi
 
	m¡©ic_key
;

65 
s_roÙ_ùx
 
	ms¦_ùx
;

68 
key_ty³
 
	ms_auth_key_ty³
;

69 
key_ùx_bi
 
	ms_w¿p_key
;

71 
	mdummy
;

79 #iâdeà
PACKET_ID_H


80 
	s·ck‘_id_³rsi¡


82 
	mdummy
;

84 
šlše
 

85 
	$·ck‘_id_³rsi¡_š™
(
·ck‘_id_³rsi¡
 *
p
)

87 
	}
}

93 
	scÚ‹xt_bufãrs


96 
bufãr
 
	maux_buf
;

99 #ifdeà
ENABLE_CRYPTO


100 
bufãr
 
	m’üy±_buf
;

101 
bufãr
 
	mdeüy±_buf
;

105 #ifdeà
USE_COMP


106 
bufãr
 
	mcom´ess_buf
;

107 
bufãr
 
	mdecom´ess_buf
;

114 
bufãr
 
	m»ad_lšk_buf
;

115 
bufãr
 
	m»ad_tun_buf
;

121 
	scÚ‹xt_³rsi¡


123 
	m»¡¬t_¦“p_£cÚds
;

136 
	scÚ‹xt_0


139 
boŞ
 
	muid_gid_¥ecif›d
;

141 
boŞ
 
	muid_gid_chroÙ_£t
;

142 
¶©fÜm_¡©e_u£r
 
	m¶©fÜm_¡©e_u£r
;

143 
¶©fÜm_¡©e_group
 
	m¶©fÜm_¡©e_group
;

156 
	scÚ‹xt_1


158 
lšk_sock‘_addr
 
	mlšk_sock‘_addr
;

163 
key_scheduË
 
	mks
;

166 
ÿched_dns_’Œy
 *
	mdns_ÿche
;

169 
·ck‘_id_³rsi¡
 
	mpid_³rsi¡
;

171 
tuÁ­
 *
	mtuÁ­
;

172 
boŞ
 
	mtuÁ­_owÃd
;

176 
rou‹_li¡
 *
	mrou‹_li¡
;

181 
rou‹_v6_li¡
 *
	mrou‹_v6_li¡
;

184 
¡©us_ouut
 *
	m¡©us_ouut
;

185 
boŞ
 
	m¡©us_ouut_owÃd
;

188 
h‰p_´oxy_šfo
 *
	mh‰p_´oxy
;

189 
boŞ
 
	mh‰p_´oxy_owÃd
;

192 
socks_´oxy_šfo
 *
	msocks_´oxy
;

193 
boŞ
 
	msocks_´oxy_owÃd
;

195 #ià
P2MP


197 #ià
P2MP_SERVER


199 
ifcÚfig_poŞ_³rsi¡
 *
	mifcÚfig_poŞ_³rsi¡
;

200 
boŞ
 
	mifcÚfig_poŞ_³rsi¡_owÃd
;

204 
sha256_dige¡
 
	mpuÎed_İtiÚs_dige¡_§ve
;

209 
u£r_·ss
 *
	mauth_u£r_·ss
;

213 cÚ¡ *
	mch”Çme
;

214 cÚ¡ *
	mauthÇme
;

215 
	mkeysize
;

228 
	scÚ‹xt_2


230 
gc_¬’a
 
	mgc
;

235 
ev’t_£t
 *
	mev’t_£t
;

236 
	mev’t_£t_max
;

237 
boŞ
 
	mev’t_£t_owÃd
;

240 
	#SOCKET_READ
 (1<<0)

	)

241 
	#SOCKET_WRITE
 (1<<1)

	)

242 
	#TUN_READ
 (1<<2)

	)

243 
	#TUN_WRITE
 (1<<3)

	)

244 
	#ES_ERROR
 (1<<4)

	)

245 
	#ES_TIMEOUT
 (1<<5)

	)

246 #ifdeà
ENABLE_MANAGEMENT


247 
	#MANAGEMENT_READ
 (1<<6)

	)

248 
	#MANAGEMENT_WRITE
 (1<<7)

	)

250 #ifdeà
ENABLE_ASYNC_PUSH


251 
	#FILE_CLOSED
 (1<<8)

	)

254 
	mev’t_£t_¡©us
;

256 
lšk_sock‘
 *
	mlšk_sock‘
;

257 
boŞ
 
	mlšk_sock‘_owÃd
;

258 
lšk_sock‘_šfo
 *
	mlšk_sock‘_šfo
;

259 cÚ¡ 
lšk_sock‘
 *
	macû±_äom
;

261 
lšk_sock‘_aùu®
 *
	mto_lšk_addr
;

262 
lšk_sock‘_aùu®
 
	mäom
;

265 
äame
 
	mäame
;

266 
äame
 
	mäame_š™Ÿl
;

268 #ifdeà
ENABLE_FRAGMENT


270 
äagm’t_ma¡”
 *
	mäagm’t
;

271 
äame
 
	mäame_äagm’t
;

272 
äame
 
	mäame_äagm’t_om™
;

275 #ifdeà
ENABLE_FEATURE_SHAPER


279 
sh­”
 
	msh­”
;

285 
couÁ”_ty³
 
	mtun_»ad_by‹s
;

286 
couÁ”_ty³
 
	mtun_wr™e_by‹s
;

287 
couÁ”_ty³
 
	mlšk_»ad_by‹s
;

288 
couÁ”_ty³
 
	mlšk_»ad_by‹s_auth
;

289 
couÁ”_ty³
 
	mlšk_wr™e_by‹s
;

290 #ifdeà
PACKET_TRUNCATION_CHECK


291 
couÁ”_ty³
 
	mn_Œunc_tun_»ad
;

292 
couÁ”_ty³
 
	mn_Œunc_tun_wr™e
;

293 
couÁ”_ty³
 
	mn_Œunc_´e_’üy±
;

294 
couÁ”_ty³
 
	mn_Œunc_po¡_deüy±
;

301 
ev’t_timeout
 
	mwa™_fÜ_cÚÃù
;

302 
ev’t_timeout
 
	mpšg_£nd_š‹rv®
;

303 
ev’t_timeout
 
	mpšg_»c_š‹rv®
;

306 
ev’t_timeout
 
	mšaùiv™y_š‹rv®
;

307 
	mšaùiv™y_by‹s
;

309 #ifdeà
ENABLE_OCC


311 *
	mİtiÚs_¡ršg_loÿl
;

312 *
	mİtiÚs_¡ršg_»mÙe
;

314 
	mocc_İ
;

315 
	mocc_n_Œ›s
;

316 
ev’t_timeout
 
	mocc_š‹rv®
;

323 
	mÜigš®_»cv_size
;

324 
	mmax_»cv_size_loÿl
;

325 
	mmax_»cv_size_»mÙe
;

326 
	mmax_£nd_size_loÿl
;

327 
	mmax_£nd_size_»mÙe
;

329 #ifdeà
ENABLE_OCC


331 
	mocc_mtu_lßd_size
;

333 
ev’t_timeout
 
	mocc_mtu_lßd_‹¡_š‹rv®
;

334 
	mocc_mtu_lßd_n_Œ›s
;

337 #ifdeà
ENABLE_CRYPTO


342 
s_muÉi
 *
	ms_muÉi
;

345 
s_auth_¡ªd®Úe
 *
	ms_auth_¡ªd®Úe
;

357 
š‹rv®
 
	mtmp_št
;

360 
	ms_ex™_sigÇl
;

362 
üy±o_İtiÚs
 
	müy±o_İtiÚs
;

368 
ev’t_timeout
 
	m·ck‘_id_³rsi¡_š‹rv®
;

372 #ifdeà
USE_COMP


373 
com´ess_cÚ‹xt
 *
	mcomp_cÚ‹xt
;

382 
cÚ‹xt_bufãrs
 *
	mbufãrs
;

383 
boŞ
 
	mbufãrs_owÃd
;

390 
bufãr
 
	mbuf
;

391 
bufãr
 
	mto_tun
;

392 
bufãr
 
	mto_lšk
;

395 
boŞ
 
	mlog_rw
;

398 
ev’t_timeout
 
	mrou‹_wakeup
;

399 
ev’t_timeout
 
	mrou‹_wakeup_expœe
;

402 
boŞ
 
	mdid_İ’_tun
;

409 
timev®
 
	mtimev®
;

412 
time_t
 
	mcßr£_tim”_wakeup
;

416 
time_t
 
	mupd©e_timeout_¿ndom_compÚ’t
;

417 
timev®
 
	mtimeout_¿ndom_compÚ’t
;

421 
ev’t_timeout
 
	m£rv”_pŞl_š‹rv®
;

424 
boŞ
 
	mdo_up_¿n
;

426 #ifdeà
ENABLE_OCC


430 
time_t
 
	mex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
;

431 
ev’t_timeout
 
	mex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
;

435 
’v_£t
 *
	mes
;

436 
boŞ
 
	mes_owÃd
;

439 
boŞ
 
	mç¡_io
;

441 #ià
P2MP


443 #ià
P2MP_SERVER


445 
boŞ
 
	mpush_»¶y_deã¼ed
;

446 #ifdeà
ENABLE_ASYNC_PUSH


447 
boŞ
 
	mpush_»que¡_»ûived
;

449 
boŞ
 
	mpush_ifcÚfig_defšed
;

450 
time_t
 
	m£Á_push_»¶y_expœy
;

451 
š_addr_t
 
	mpush_ifcÚfig_loÿl
;

452 
š_addr_t
 
	mpush_ifcÚfig_»mÙe_Ãtmask
;

453 
š_addr_t
 
	mpush_ifcÚfig_loÿl_®Ÿs
;

455 
boŞ
 
	mpush_ifcÚfig_v6_defšed
;

456 
š6_addr
 
	mpush_ifcÚfig_v6_loÿl
;

457 
	mpush_ifcÚfig_v6_Ãtb™s
;

458 
š6_addr
 
	mpush_ifcÚfig_v6_»mÙe
;

461 
	#CAS_SUCCEEDED
 0

	)

462 
	#CAS_PENDING
 1

	)

463 
	#CAS_FAILED
 2

	)

464 
	#CAS_PARTIAL
 3

	)

466 
	mcÚ‹xt_auth
;

469 
ev’t_timeout
 
	mpush_»que¡_š‹rv®
;

470 
	mn_£Á_push_»que¡s
;

471 
boŞ
 
	mdid_´e_puÎ_»¡Üe
;

474 
boŞ
 
	mpuÎed_İtiÚs_dige¡_š™_dÚe
;

475 
md_ùx_t
 *
	mpuÎed_İtiÚs_¡©e
;

476 
sha256_dige¡
 
	mpuÎed_İtiÚs_dige¡
;

478 
ev’t_timeout
 
	mscheduËd_ex™
;

479 
	mscheduËd_ex™_sigÇl
;

483 #ifdeà
ENABLE_PF


484 
pf_cÚ‹xt
 
	mpf
;

487 #ifdeà
MANAGEMENT_DEF_AUTH


488 
mª_def_auth_cÚ‹xt
 
	mmda_cÚ‹xt
;

491 #ifdeà
ENABLE_ASYNC_PUSH


492 
	mšÙify_fd
;

508 
	scÚ‹xt


510 
İtiÚs
 
	mİtiÚs
;

513 
boŞ
 
	mfœ¡_time
;

517 
	#CM_P2P
 0

	)

518 
	#CM_TOP
 1

	)

519 
	#CM_TOP_CLONE
 2

	)

520 
	#CM_CHILD_UDP
 3

	)

521 
	#CM_CHILD_TCP
 4

	)

522 
	mmode
;

527 
gc_¬’a
 
	mgc
;

531 
’v_£t
 *
	mes
;

533 
sigÇl_šfo
 *
	msig
;

535 
¶ugš_li¡
 *
	m¶ugšs
;

536 
boŞ
 
	m¶ugšs_owÃd
;

540 
boŞ
 
	mdid_we_d«mÚize
;

543 
cÚ‹xt_³rsi¡
 
	m³rsi¡
;

545 
cÚ‹xt_0
 *
	mc0
;

546 
cÚ‹xt_1
 
	mc1
;

547 
cÚ‹xt_2
 
	mc2
;

553 
	#EVENT_LOOP_CHECK_SIGNAL
(
c
, 
func
, 
¬g
) \

554 ià(
	`IS_SIG
(
c
)) \

556 cÚ¡ 
brk
 = 
	`func
(
¬g
); \

557 
	`³rf_pİ
(); \

558 ià(
brk
) { \

562 }

	)

569 #ifdeà
ENABLE_CRYPTO


570 
	#TLS_MODE
(
c
è((c)->
c2
.
s_muÉi
 !ğ
NULL
)

	)

571 
	#PROTO_DUMP_FLAGS
 (
	`check_debug_Ëv–
(
D_LINK_RW_VERBOSE
è? (
PD_SHOW_DATA
|
PD_VERBOSE
è: 0)

	)

572 
	#PROTO_DUMP
(
buf
, 
gc
è
	`´ÙocŞ_dump
((buf), \

573 
PROTO_DUMP_FLAGS
 \

574 |(
c
->
c2
.
s_muÉi
 ? 
PD_TLS
 : 0) \

575 |(
c
->
İtiÚs
.
s_auth_fe
 ? c->
c1
.
ks
.
key_ty³
.
hmac_Ëngth
 : 0), \

576 
gc
)

	)

578 
	#TLS_MODE
(
c
è(
çl£
)

	)

579 
	#PROTO_DUMP
(
buf
, 
gc
è
	`fÜm©_hex
(
	`BPTR
(buf), 
	`BLEN
(buf), 80, gc)

	)

582 #ifdeà
ENABLE_CRYPTO


583 
	#MD5SUM
(
buf
, 
Ën
, 
gc
è
	`md5sum
((buf), (Ën), 0, (gc))

	)

585 
	#MD5SUM
(
buf
, 
Ën
, 
gc
è"[uÇvaabË]"

	)

588 #ifdeà
ENABLE_CRYPTO


589 
	#CIPHER_ENABLED
(
c
è(c->
c1
.
ks
.
key_ty³
.
ch”
 !ğ
NULL
)

	)

591 
	#CIPHER_ENABLED
(
c
è(
çl£
)

	)

595 
	#MAX_PEER_ID
 0xFFFFFF

	)

	@options.c

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

32 #–ià
defšed
(
_MSC_VER
)

33 
	~"cÚfig-msvc.h
"

35 #ifdeà
HAVE_CONFIG_VERSION_H


36 
	~"cÚfig-v”siÚ.h
"

39 
	~"sysh—d.h
"

41 
	~"bufãr.h
"

42 
	~"”rÜ.h
"

43 
	~"commÚ.h
"

44 
	~"sh­”.h
"

45 
	~"üy±o.h
"

46 
	~"s¦.h
"

47 
	~"İtiÚs.h
"

48 
	~"misc.h
"

49 
	~"sock‘.h
"

50 
	~"·ck‘_id.h
"

51 
	~"pkcs11.h
"

52 
	~"wš32.h
"

53 
	~"push.h
"

54 
	~"poŞ.h
"

55 
	~"h–³r.h
"

56 
	~"mªage.h
"

57 
	~"fÜw¬d.h
"

58 
	~"s¦_v”ify.h
"

59 
	~"¶©fÜm.h
"

60 
	~<ùy³.h
>

62 
	~"memdbg.h
"

64 cÚ¡ 
	gt™Ë_¡ršg
[] =

65 
PACKAGE_STRING


66 #ifdeà
CONFIGURE_GIT_REVISION


67 " [g™:" 
CONFIGURE_GIT_REVISION
 
CONFIGURE_GIT_FLAGS
 "]"

69 " " 
TARGET_ALIAS


70 #ifdeà
ENABLE_CRYPTO


71 #ià
defšed
(
ENABLE_CRYPTO_MBEDTLS
)

73 #–ià
defšed
(
ENABLE_CRYPTO_OPENSSL
)

79 #ifdeà
USE_COMP


80 #ifdeà
ENABLE_LZO


83 #ifdeà
ENABLE_LZ4


86 #ifdeà
ENABLE_COMP_STUB


90 #ià
EPOLL


93 #ifdeà
PRODUCT_TAP_DEBUG


96 #ifdeà
ENABLE_PKCS11


99 #ià
ENABLE_IP_PKTINFO


100 #ià
defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

102 #–ià
defšed
(
IP_RECVDSTADDR
)

106 #ifdeà
HAVE_AEAD_CIPHER_MODES


109 " buˆÚ " 
__DATE__


112 #iâdeà
ENABLE_SMALL


114 cÚ¡ 
	gu§ge_mes§ge
[] =

180 #ifdeà
ENABLE_IPROUTE


181 "--rou‹ cmd : U£hi commªd in¡—d oàdeçuÉ " 
IPROUTE_PATH
 ".\n"

221 " VPN. Add 'loÿl' fÏg iàbÙh " 
PACKAGE_NAME
 " servers‡re directly\n"

230 #ifdeà
ENABLE_PUSH_PEER_INFO


254 #ià
ENABLE_IP_PKTINFO


263 #ià
PASSTOS_CAPABILITY


277 #ifdeà
ENABLE_OCC


280 #ifdeà
ENABLE_FRAGMENT


289 #ià
defšed
(
TARGET_LINUX
è&& 
HAVE_DECL_SO_MARK


294 #ifdeà
ENABLE_MEMSTATS


314 #ifdeà
ENABLE_SELINUX


347 #ifdeà
ENABLE_OCC


350 #ifdeà
ENABLE_DEBUG


353 #ià
defšed
(
USE_COMP
)

355 #ià
defšed
(
ENABLE_LZO
)

362 #ifdeà
ENABLE_MANAGEMENT


366 #ià
UNIX_SOCK_SUPPORT


376 "--mªagem’t-hŞd : S¹ " 
PACKAGE_NAME
 " in‡ hibernating state, until‡ client\n"

384 #ià
UNIX_SOCK_SUPPORT


390 #ifdeà
MANAGEMENT_DEF_AUTH


395 #ifdeà
MANAGEMENT_PF


400 #ifdeà
ENABLE_PLUGIN


404 #ià
P2MP


405 #ià
P2MP_SERVER


485 #ià
PORT_SHARE


517 #ifdeà
ENABLE_OCC


521 #ifdeà
ENABLE_CRYPTO


542 #ifdeà
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


546 #iâdeà
ENABLE_CRYPTO_MBEDTLS


559 #ifdeà
ENABLE_PREDICTION_RESISTANCE


572 #iâdeà
ENABLE_CRYPTO_MBEDTLS


587 #iâdeà
ENABLE_CRYPTO_MBEDTLS


591 #ifdeà
ENABLE_X509ALTUSERNAME


597 #ifdeà
_WIN32


646 #ià
defšed
(
ENABLE_CRYPTO_OPENSSL
è&& 
OPENSSL_VERSION_NUMBER
 >= 0x10001000

659 #ifdeà
ENABLE_PKCS11


684 #ifdeà
_WIN32


726 "--£rviûƒx [0|1] : FÜ u£ wh’ " 
PACKAGE_NAME
 " is being instantiated by‡\n"

729 " sigÇËd, wÈÿu£ " 
PACKAGE_NAME
 "oƒxit. A second\n"

731 "--show-Ãt-u° : Show " 
PACKAGE_NAME
 "'s view of„outingable‡nd‚et‡dapter†ist\n"

733 #ifdeà
_WIN32


739 "--show-Ãˆ : Show " 
PACKAGE_NAME
 "'s view of„outingable‡nd‚et‡dapter†ist.\n"

741 "--®low-nÚadmš [TAP-ad­‹r] : AÎow " 
PACKAGE_NAME
 "„unning without‡dmin…rivileges\n"

750 #ifdeà
ENABLE_FEATURE_TUN_PERSIST


760 #ifdeà
ENABLE_PKCS11


763 #ifdeà
DEFAULT_PKCS11_MODULE


772 #ifdeà
ENABLE_DEBUG


785 
	$š™_İtiÚs
(
İtiÚs
 *
o
, cÚ¡ 
boŞ
 
š™_gc
)

787 
	`CLEAR
(*
o
);

788 ià(
š™_gc
)

790 
	`gc_š™
(&
o
->
gc
);

791 
o
->
gc_owÃd
 = 
Œue
;

793 
o
->
mode
 = 
MODE_POINT_TO_POINT
;

794 
o
->
tİŞogy
 = 
TOP_NET30
;

795 
o
->
û
.
´Ùo
 = 
PROTO_UDP
;

796 
o
->
û
.
af
 = 
AF_UNSPEC
;

797 
o
->
û
.
bšd_v6_Úly
 = 
çl£
;

798 
o
->
û
.
cÚÃù_»Œy_£cÚds
 = 5;

799 
o
->
û
.
cÚÃù_»Œy_£cÚds_max
 = 300;

800 
o
->
û
.
cÚÃù_timeout
 = 120;

801 
o
->
cÚÃù_»Œy_max
 = 0;

802 
o
->
û
.
loÿl_pÜt
 = o->û.
»mÙe_pÜt
 = 
OPENVPN_PORT
;

803 
o
->
v”bos™y
 = 1;

804 
o
->
¡©us_fe_upd©e_äeq
 = 60;

805 
o
->
¡©us_fe_v”siÚ
 = 1;

806 
o
->
û
.
bšd_loÿl
 = 
Œue
;

807 
o
->
û
.
tun_mtu
 = 
TUN_MTU_DEFAULT
;

808 
o
->
û
.
lšk_mtu
 = 
LINK_MTU_DEFAULT
;

809 
o
->
û
.
mtu_discov”_ty³
 = -1;

810 
o
->
û
.
mssfix
 = 
MSSFIX_DEFAULT
;

811 
o
->
rou‹_d–ay_wšdow
 = 30;

812 
o
->
»sŞve_»Œy_£cÚds
 = 
RESOLV_RETRY_INFINITE
;

813 
o
->
»sŞve_š_advªû
 = 
çl£
;

814 
o
->
´Ùo_fÜû
 = -1;

815 #ifdeà
ENABLE_OCC


816 
o
->
occ
 = 
Œue
;

818 #ifdeà
ENABLE_MANAGEMENT


819 
o
->
mªagem’t_log_hi¡Üy_ÿche
 = 250;

820 
o
->
mªagem’t_echo_bufãr_size
 = 100;

821 
o
->
mªagem’t_¡©e_bufãr_size
 = 100;

823 #ifdeà
ENABLE_FEATURE_TUN_PERSIST


824 
o
->
³rsi¡_mode
 = 1;

826 #ifdeà
TARGET_LINUX


827 
o
->
tuÁ­_İtiÚs
.
txqueu–’
 = 100;

829 #ifdeà
_WIN32


831 
o
->
tuÁ­_İtiÚs
.
_wš32_ty³
 = 
IPW32_SET_ADAPTIVE
;

833 
o
->
tuÁ­_İtiÚs
.
_wš32_ty³
 = 
IPW32_SET_DHCP_MASQ
;

835 
o
->
tuÁ­_İtiÚs
.
dhı_Ëa£_time
 = 31536000;

836 
o
->
tuÁ­_İtiÚs
.
dhı_masq_off£t
 = 0;

837 
o
->
rou‹_m‘hod
 = 
ROUTE_METHOD_ADAPTIVE
;

838 
o
->
block_outside_dns
 = 
çl£
;

840 #ià
P2MP_SERVER


841 
o
->
»®_hash_size
 = 256;

842 
o
->
vœtu®_hash_size
 = 256;

843 
o
->
n_bÿ¡_buf
 = 256;

844 
o
->
tı_queue_lim™
 = 64;

845 
o
->
max_ş›Ás
 = 1024;

846 
o
->
max_rou‹s_³r_ş›Á
 = 256;

847 
o
->
¡®e_rou‹s_check_š‹rv®
 = 0;

848 
o
->
ifcÚfig_poŞ_³rsi¡_»äesh_äeq
 = 600;

850 #ià
P2MP


851 
o
->
scheduËd_ex™_š‹rv®
 = 5;

853 #ifdeà
ENABLE_CRYPTO


854 
o
->
ch”Çme
 = "BF-CBC";

855 #ifdeà
HAVE_AEAD_CIPHER_MODES


856 
o
->
nı_’abËd
 = 
Œue
;

858 
o
->
nı_’abËd
 = 
çl£
;

860 
o
->
nı_ch”s
 = "AES-256-GCM:AES-128-GCM";

861 
o
->
authÇme
 = "SHA1";

862 
o
->
´ng_hash
 = "SHA1";

863 
o
->
´ng_nÚû_£ü‘_Ën
 = 16;

864 
o
->
»¶ay
 = 
Œue
;

865 
o
->
»¶ay_wšdow
 = 
DEFAULT_SEQ_BACKTRACK
;

866 
o
->
»¶ay_time
 = 
DEFAULT_TIME_BACKTRACK
;

867 
o
->
u£_iv
 = 
Œue
;

868 
o
->
key_dœeùiÚ
 = 
KEY_DIRECTION_BIDIRECTIONAL
;

869 #ifdeà
ENABLE_PREDICTION_RESISTANCE


870 
o
->
u£_´ediùiÚ_»si¡ªû
 = 
çl£
;

872 
o
->
key_m‘hod
 = 2;

873 
o
->
s_timeout
 = 2;

874 
o
->
»ÃgÙŸ‹_by‹s
 = -1;

875 
o
->
»ÃgÙŸ‹_£cÚds
 = 3600;

876 
o
->
hªdshake_wšdow
 = 60;

877 
o
->
Œªs™iÚ_wšdow
 = 3600;

878 
o
->
s_û¹_´ofe
 = 
NULL
;

879 
o
->
ecdh_curve
 = 
NULL
;

880 #ifdeà
ENABLE_X509ALTUSERNAME


881 
o
->
x509_u£ºame_f›ld
 = 
X509_USERNAME_FIELD_DEFAULT
;

884 #ifdeà
ENABLE_PKCS11


885 
o
->
pkcs11_pš_ÿche_³riod
 = -1;

889 #ià
P2MP_SERVER


890 
o
->
auth_tok’_g’”©e
 = 
çl£
;

893 #ifdeà
_WIN32


895 
o
->
tmp_dœ
 = 
	`wš_g‘_‹mpdœ
();

898 
o
->
tmp_dœ
 = 
	`g‘’v
("TMPDIR");

899 ià(!
o
->
tmp_dœ
)

901 
o
->
tmp_dœ
 = "/tmp";

905 
o
->
®low_»cursive_routšg
 = 
çl£
;

906 
	}
}

909 
	$unš™_İtiÚs
(
İtiÚs
 *
o
)

911 ià(
o
->
gc_owÃd
)

913 
	`gc_ä“
(&
o
->
gc
);

915 
	}
}

917 
	spuÎ_f‹r


919 
	#PUF_TYPE_UNDEF
 0

	)

920 
	#PUF_TYPE_ACCEPT
 1

	)

921 
	#PUF_TYPE_IGNORE
 2

	)

922 
	#PUF_TYPE_REJECT
 3

	)

923 
	mty³
;

924 
	msize
;

925 *
	m·‰”n
;

926 
puÎ_f‹r
 *
	mÃxt
;

929 
	spuÎ_f‹r_li¡


931 
puÎ_f‹r
 *
	mh—d
;

932 
puÎ_f‹r
 *
	m
;

936 
	$puÎ_f‹r_ty³_Çme
(
ty³
)

938 ià(
ty³
 =ğ
PUF_TYPE_ACCEPT
)

942 ià(
ty³
 =ğ
PUF_TYPE_IGNORE
)

946 ià(
ty³
 =ğ
PUF_TYPE_REJECT
)

954 
	}
}

956 #iâdeà
ENABLE_SMALL


958 
	#SHOW_PARM
(
Çme
, 
v®ue
, 
fÜm©
è
	`msg
(
D_SHOW_PARMS
, " " #Çm" = " fÜm©, (v®ue))

	)

959 
	#SHOW_STR
(
v¬
è
	`SHOW_PARM
(v¬, (
o
->v¬ ? o->v¬ : "[UNDEF]"), "'%s'")

	)

960 
	#SHOW_INT
(
v¬
è
	`SHOW_PARM
(v¬, 
o
->v¬, "%d")

	)

961 
	#SHOW_UINT
(
v¬
è
	`SHOW_PARM
(v¬, 
o
->v¬, "%u")

	)

962 
	#SHOW_UNSIGNED
(
v¬
è
	`SHOW_PARM
(v¬, 
o
->v¬, "0x%08x")

	)

963 
	#SHOW_BOOL
(
v¬
è
	`SHOW_PARM
(v¬, (
o
->v¬ ? "ENABLED" : "DISABLED"), "%s");

	)

968 
	$£‹nv_cÚÃùiÚ_’Œy
(
’v_£t
 *
es
,

969 cÚ¡ 
cÚÃùiÚ_’Œy
 *
e
,

970 cÚ¡ 
i
)

972 
	`£‹nv_¡r_i
(
es
, "´Ùo", 
	`´Ùo2ascii
(
e
->
´Ùo
,ƒ->
af
, 
çl£
), 
i
);

973 
	`£‹nv_¡r_i
(
es
, "loÿl", 
e
->
loÿl
, 
i
);

974 
	`£‹nv_¡r_i
(
es
, "loÿl_pÜt", 
e
->
loÿl_pÜt
, 
i
);

975 
	`£‹nv_¡r_i
(
es
, "»mÙe", 
e
->
»mÙe
, 
i
);

976 
	`£‹nv_¡r_i
(
es
, "»mÙe_pÜt", 
e
->
»mÙe_pÜt
, 
i
);

978 ià(
e
->
h‰p_´oxy_İtiÚs
)

980 
	`£‹nv_¡r_i
(
es
, "h‰p_´oxy_£rv”", 
e
->
h‰p_´oxy_İtiÚs
->
£rv”
, 
i
);

981 
	`£‹nv_¡r_i
(
es
, "h‰p_´oxy_pÜt", 
e
->
h‰p_´oxy_İtiÚs
->
pÜt
, 
i
);

983 ià(
e
->
socks_´oxy_£rv”
)

985 
	`£‹nv_¡r_i
(
es
, "socks_´oxy_£rv”", 
e
->
socks_´oxy_£rv”
, 
i
);

986 
	`£‹nv_¡r_i
(
es
, "socks_´oxy_pÜt", 
e
->
socks_´oxy_pÜt
, 
i
);

988 
	}
}

991 
	$£‹nv_£‰šgs
(
’v_£t
 *
es
, cÚ¡ 
İtiÚs
 *
o
)

993 
	`£‹nv_¡r
(
es
, "cÚfig", 
o
->
cÚfig
);

994 
	`£‹nv_št
(
es
, "v”b", 
o
->
v”bos™y
);

995 
	`£‹nv_št
(
es
, "d«mÚ", 
o
->
d«mÚ
);

996 
	`£‹nv_št
(
es
, "d«mÚ_log_»dœeù", 
o
->
log
);

997 
	`£‹nv_unsigÃd
(
es
, "d«mÚ_¡¬t_time", 
	`time
(
NULL
));

998 
	`£‹nv_št
(
es
, "d«mÚ_pid", 
	`¶©fÜm_g‘pid
());

1000 ià(
o
->
cÚÃùiÚ_li¡
)

1002 
i
;

1003 
i
 = 0; i < 
o
->
cÚÃùiÚ_li¡
->
Ën
; ++i)

1005 
	`£‹nv_cÚÃùiÚ_’Œy
(
es
, 
o
->
cÚÃùiÚ_li¡
->
¬¿y
[
i
], i+1);

1010 
	`£‹nv_cÚÃùiÚ_’Œy
(
es
, &
o
->
û
, 1);

1012 
	}
}

1014 
š_addr_t


1015 
	$g‘__addr
(cÚ¡ *
_¡ršg
, 
msgËv–
, 
boŞ
 *
”rÜ
)

1017 
æags
 = 
GETADDR_HOST_ORDER
;

1018 
boŞ
 
sucûeded
 = 
çl£
;

1019 
š_addr_t
 
»t
;

1021 ià(
msgËv–
 & 
M_FATAL
)

1023 
æags
 |ğ
GETADDR_FATAL
;

1026 
»t
 = 
	`g‘addr
(
æags
, 
_¡ršg
, 0, &
sucûeded
, 
NULL
);

1027 ià(!
sucûeded
 && 
”rÜ
)

1029 *
”rÜ
 = 
Œue
;

1031  
»t
;

1032 
	}
}

1040 
	$g‘_v6_addr_no_Ãtb™s
(cÚ¡ *
addr
, 
gc_¬’a
 *
gc
)

1042 cÚ¡ *
’d
 = 
	`¡rchr
(
addr
, '/');

1043 *
»t
 = 
NULL
;

1044 ià(
NULL
 =ğ
’d
)

1046 
»t
 = 
	`¡ršg_®loc
(
addr
, 
gc
);

1050 
size_t
 
Ën
 = 
’d
 - 
addr
;

1051 
»t
 = 
	`gc_m®loc
(
Ën
 + 1, 
Œue
, 
gc
);

1052 
	`memıy
(
»t
, 
addr
, 
Ën
);

1054  
»t
;

1055 
	}
}

1057 
boŞ


1058 
	$v6_addr_§ã_hex¶usb™s
ĞcÚ¡ *
v6_´efix_¥ec
 )

1060 
š6_addr
 
t_addr
;

1061 
t_b™s
;

1063  
	`g‘_v6_addr
Ğ
v6_´efix_¥ec
, &
t_addr
, &
t_b™s
, 
M_WARN
 );

1064 
	}
}

1067 
	$¡ršg_sub¡™u‹
(cÚ¡ *
¤c
, 
äom
, 
to
, 
gc_¬’a
 *
gc
)

1069 *
»t
 = (*è
	`gc_m®loc
(
	`¡¾’
(
¤c
è+ 1, 
Œue
, 
gc
);

1070 *
de¡
 = 
»t
;

1071 
c
;

1075 
c
 = *
¤c
++;

1076 ià(
c
 =ğ
äom
)

1078 
c
 = 
to
;

1080 *
de¡
++ = 
c
;

1082 
c
);

1083  
»t
;

1084 
	}
}

1086 #ifdeà
ENABLE_CRYPTO


1087 
ušt8_t
 *

1088 
	$·r£_hash_fšg”´št
(cÚ¡ *
¡r
, 
nby‹s
, 
msgËv–
, 
gc_¬’a
 *
gc
)

1090 
i
;

1091 cÚ¡ *
ı
 = 
¡r
;

1092 
ušt8_t
 *
»t
 = (ušt8_ˆ*è
	`gc_m®loc
(
nby‹s
, 
Œue
, 
gc
);

1093 
‹rm
 = 1;

1094 
by‹
;

1095 
bs
[3];

1097 
i
 = 0; i < 
nby‹s
; ++i)

1099 ià(
	`¡¾’
(
ı
) < 2)

1101 
	`msg
(
msgËv–
, "fÜm©ƒ¼Ü iÀhash fšg”´št: %s", 
¡r
);

1103 
bs
[0] = *
ı
++;

1104 
bs
[1] = *
ı
++;

1105 
bs
[2] = 0;

1106 
by‹
 = 0;

1107 ià(
	`ssÿnf
(
bs
, "%x", &
by‹
) != 1)

1109 
	`msg
(
msgËv–
, "fÜm©ƒ¼Ü iÀhash fšg”´šˆhex by‹: %s", 
¡r
);

1111 
»t
[
i
] = (
ušt8_t
)
by‹
;

1112 
‹rm
 = *
ı
++;

1113 ià(
‹rm
 != ':' &&erm != 0)

1115 
	`msg
(
msgËv–
, "fÜm©ƒ¼Ü iÀhash fšg”´šˆd–im™”: %s", 
¡r
);

1117 ià(
‹rm
 == 0)

1122 ià(
‹rm
 !ğ0 || 
i
 !ğ
nby‹s
-1)

1124 
	`msg
(
msgËv–
, "hash fšg”´šˆi difã»Á†’gthhªƒx³ùed (%d by‹s): %s", 
nby‹s
, 
¡r
);

1126  
»t
;

1127 
	}
}

1130 #ifdeà
_WIN32


1132 #iâdeà
ENABLE_SMALL


1135 
	$show_dhı_İtiÚ_addrs
(cÚ¡ *
Çme
, cÚ¡ 
š_addr_t
 *
¬¿y
, 
Ën
)

1137 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1138 
i
;

1139 
i
 = 0; i < 
Ën
; ++i)

1141 
	`msg
(
D_SHOW_PARMS
, " %s[%d] = %s",

1142 
Çme
,

1143 
i
,

1144 
	`´št_š_addr_t
(
¬¿y
[
i
], 0, &
gc
));

1146 
	`gc_ä“
(&
gc
);

1147 
	}
}

1150 
	$show_tuÁ­_İtiÚs
(cÚ¡ 
tuÁ­_İtiÚs
 *
o
)

1152 
	`SHOW_BOOL
(
_wš32_defšed
);

1153 
	`SHOW_INT
(
_wš32_ty³
);

1154 
	`SHOW_INT
(
dhı_masq_off£t
);

1155 
	`SHOW_INT
(
dhı_Ëa£_time
);

1156 
	`SHOW_INT
(
p_¦“p
);

1157 
	`SHOW_BOOL
(
dhı_İtiÚs
);

1158 
	`SHOW_BOOL
(
dhı_»Ãw
);

1159 
	`SHOW_BOOL
(
dhı_´e_»Ëa£
);

1160 
	`SHOW_STR
(
domaš
);

1161 
	`SHOW_STR
(
Ãtbios_scİe
);

1162 
	`SHOW_INT
(
Ãtbios_node_ty³
);

1163 
	`SHOW_BOOL
(
di§bË_nbt
);

1165 
	`show_dhı_İtiÚ_addrs
("DNS", 
o
->
dns
, o->
dns_Ën
);

1166 
	`show_dhı_İtiÚ_addrs
("WINS", 
o
->
wšs
, o->
wšs_Ën
);

1167 
	`show_dhı_İtiÚ_addrs
("NTP", 
o
->
Áp
, o->
Áp_Ën
);

1168 
	`show_dhı_İtiÚ_addrs
("NBDD", 
o
->
nbdd
, o->
nbdd_Ën
);

1169 
	}
}

1174 #ià
defšed
(
_WIN32
è|| defšed(
TARGET_ANDROID
)

1176 
	$dhı_İtiÚ_dns6_·r£
(cÚ¡ *
·rm
, 
š6_addr
 *
dns6_li¡
, *
Ën
, 
msgËv–
)

1178 
š6_addr
 
addr
;

1179 ià(*
Ën
 >ğ
N_DHCP_ADDR
)

1181 
	`msg
(
msgËv–
, "--dhcp-option DNS: maximum of %d IPv6 dns servers can be specified",

1182 
N_DHCP_ADDR
);

1184 ià(
	`g‘_v6_addr
(
·rm
, &
addr
, 
NULL
, 
msgËv–
))

1186 
dns6_li¡
[(*
Ën
)++] = 
addr
;

1188 
	}
}

1190 
	$dhı_İtiÚ_add»ss_·r£
(cÚ¡ *
Çme
, cÚ¡ *
·rm
, 
š_addr_t
 *
¬¿y
, *
Ën
, 
msgËv–
)

1192 ià(*
Ën
 >ğ
N_DHCP_ADDR
)

1194 
	`msg
(
msgËv–
, "--dhcp-option %s: maximum of %d %s servers can be specified",

1195 
Çme
,

1196 
N_DHCP_ADDR
,

1197 
Çme
);

1201 ià(
	`_addr_dÙ‹d_quad_§ã
(
·rm
))

1203 
boŞ
 
”rÜ
 = 
çl£
;

1204 cÚ¡ 
š_addr_t
 
addr
 = 
	`g‘__addr
(
·rm
, 
msgËv–
, &
”rÜ
);

1205 ià(!
”rÜ
)

1207 
¬¿y
[(*
Ën
)++] = 
addr
;

1212 
	`msg
(
msgËv–
, "dhı-İtiÚ…¬am‘” % '%s' mu¡ bª IP‡dd»ss", 
Çme
, 
·rm
);

1215 
	}
}

1219 #ià
P2MP


1221 #iâdeà
ENABLE_SMALL


1224 
	$show_p2mp_·rms
(cÚ¡ 
İtiÚs
 *
o
)

1226 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1228 #ià
P2MP_SERVER


1229 
	`msg
(
D_SHOW_PARMS
, " s”v”_ÃtwÜk = %s", 
	`´št_š_addr_t
(
o
->
£rv”_ÃtwÜk
, 0, &
gc
));

1230 
	`msg
(
D_SHOW_PARMS
, " s”v”_Ãtmask = %s", 
	`´št_š_addr_t
(
o
->
£rv”_Ãtmask
, 0, &
gc
));

1231 
	`msg
(
D_SHOW_PARMS
, " s”v”_ÃtwÜk_v6 = %s", 
	`´št_š6_addr
(
o
->
£rv”_ÃtwÜk_v6
, 0, &
gc
) );

1232 
	`SHOW_INT
(
£rv”_Ãtb™s_v6
);

1233 
	`msg
(
D_SHOW_PARMS
, " s”v”_bridge_ = %s", 
	`´št_š_addr_t
(
o
->
£rv”_bridge_
, 0, &
gc
));

1234 
	`msg
(
D_SHOW_PARMS
, " s”v”_bridge_Ãtmask = %s", 
	`´št_š_addr_t
(
o
->
£rv”_bridge_Ãtmask
, 0, &
gc
));

1235 
	`msg
(
D_SHOW_PARMS
, " s”v”_bridge_poŞ_¡¬ˆğ%s", 
	`´št_š_addr_t
(
o
->
£rv”_bridge_poŞ_¡¬t
, 0, &
gc
));

1236 
	`msg
(
D_SHOW_PARMS
, " s”v”_bridge_poŞ_’d = %s", 
	`´št_š_addr_t
(
o
->
£rv”_bridge_poŞ_’d
, 0, &
gc
));

1237 ià(
o
->
push_li¡
.
h—d
)

1239 cÚ¡ 
push_’Œy
 *
e
 = 
o
->
push_li¡
.
h—d
;

1240 
e
)

1242 ià(
e
->
’abË
)

1244 
	`msg
(
D_SHOW_PARMS
, "…ush_’Œy = '%s'", 
e
->
İtiÚ
);

1246 
e
 =ƒ->
Ãxt
;

1249 
	`SHOW_BOOL
(
ifcÚfig_poŞ_defšed
);

1250 
	`msg
(
D_SHOW_PARMS
, " ifcÚfig_poŞ_¡¬ˆğ%s", 
	`´št_š_addr_t
(
o
->
ifcÚfig_poŞ_¡¬t
, 0, &
gc
));

1251 
	`msg
(
D_SHOW_PARMS
, " ifcÚfig_poŞ_’d = %s", 
	`´št_š_addr_t
(
o
->
ifcÚfig_poŞ_’d
, 0, &
gc
));

1252 
	`msg
(
D_SHOW_PARMS
, " ifcÚfig_poŞ_Ãtmask = %s", 
	`´št_š_addr_t
(
o
->
ifcÚfig_poŞ_Ãtmask
, 0, &
gc
));

1253 
	`SHOW_STR
(
ifcÚfig_poŞ_³rsi¡_f’ame
);

1254 
	`SHOW_INT
(
ifcÚfig_poŞ_³rsi¡_»äesh_äeq
);

1255 
	`SHOW_BOOL
(
ifcÚfig_v6_poŞ_defšed
);

1256 
	`msg
(
D_SHOW_PARMS
, " ifcÚfig_v6_poŞ_ba£ = %s", 
	`´št_š6_addr
(
o
->
ifcÚfig_v6_poŞ_ba£
, 0, &
gc
));

1257 
	`SHOW_INT
(
ifcÚfig_v6_poŞ_Ãtb™s
);

1258 
	`SHOW_INT
(
n_bÿ¡_buf
);

1259 
	`SHOW_INT
(
tı_queue_lim™
);

1260 
	`SHOW_INT
(
»®_hash_size
);

1261 
	`SHOW_INT
(
vœtu®_hash_size
);

1262 
	`SHOW_STR
(
ş›Á_cÚÃù_süt
);

1263 
	`SHOW_STR
(
Ë¬n_add»ss_süt
);

1264 
	`SHOW_STR
(
ş›Á_discÚÃù_süt
);

1265 
	`SHOW_STR
(
ş›Á_cÚfig_dœ
);

1266 
	`SHOW_BOOL
(
ccd_exşusive
);

1267 
	`SHOW_STR
(
tmp_dœ
);

1268 
	`SHOW_BOOL
(
push_ifcÚfig_defšed
);

1269 
	`msg
(
D_SHOW_PARMS
, "…ush_ifcÚfig_loÿÈğ%s", 
	`´št_š_addr_t
(
o
->
push_ifcÚfig_loÿl
, 0, &
gc
));

1270 
	`msg
(
D_SHOW_PARMS
, "…ush_ifcÚfig_»mÙe_Ãtmask = %s", 
	`´št_š_addr_t
(
o
->
push_ifcÚfig_»mÙe_Ãtmask
, 0, &
gc
));

1271 
	`SHOW_BOOL
(
push_ifcÚfig_v6_defšed
);

1272 
	`msg
(
D_SHOW_PARMS
, "…ush_ifcÚfig_v6_loÿÈğ%s/%d", 
	`´št_š6_addr
(
o
->
push_ifcÚfig_v6_loÿl
, 0, &
gc
), o->
push_ifcÚfig_v6_Ãtb™s
 );

1273 
	`msg
(
D_SHOW_PARMS
, "…ush_ifcÚfig_v6_»mÙğ%s", 
	`´št_š6_addr
(
o
->
push_ifcÚfig_v6_»mÙe
, 0, &
gc
));

1274 
	`SHOW_BOOL
(
’abË_c2c
);

1275 
	`SHOW_BOOL
(
du¶iÿ‹_ú
);

1276 
	`SHOW_INT
(
cf_max
);

1277 
	`SHOW_INT
(
cf_³r
);

1278 
	`SHOW_INT
(
max_ş›Ás
);

1279 
	`SHOW_INT
(
max_rou‹s_³r_ş›Á
);

1280 
	`SHOW_STR
(
auth_u£r_·ss_v”ify_süt
);

1281 
	`SHOW_BOOL
(
auth_u£r_·ss_v”ify_süt_vŸ_fe
);

1282 
	`SHOW_BOOL
(
auth_tok’_g’”©e
);

1283 
	`SHOW_INT
(
auth_tok’_liãtime
);

1284 #ià
PORT_SHARE


1285 
	`SHOW_STR
(
pÜt_sh¬e_ho¡
);

1286 
	`SHOW_STR
(
pÜt_sh¬e_pÜt
);

1290 
	`SHOW_BOOL
(
ş›Á
);

1291 
	`SHOW_BOOL
(
puÎ
);

1292 
	`SHOW_STR
(
auth_u£r_·ss_fe
);

1294 
	`gc_ä“
(&
gc
);

1295 
	}
}

1299 #ià
P2MP_SERVER


1302 
	$İtiÚ_œou‹
(
İtiÚs
 *
o
,

1303 cÚ¡ *
ÃtwÜk_¡r
,

1304 cÚ¡ *
Ãtmask_¡r
,

1305 
msgËv–
)

1307 
œou‹
 *
œ
;

1309 
	`ALLOC_OBJ_GC
(
œ
, 
œou‹
, &
o
->
gc
);

1310 
œ
->
ÃtwÜk
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
ÃtwÜk_¡r
, 0, 
NULL
, NULL);

1311 
œ
->
Ãtb™s
 = -1;

1313 ià(
Ãtmask_¡r
)

1315 cÚ¡ 
š_addr_t
 
Ãtmask
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
Ãtmask_¡r
, 0, 
NULL
, NULL);

1316 ià(!
	`Ãtmask_to_Ãtb™s
(
œ
->
ÃtwÜk
, 
Ãtmask
, &œ->
Ãtb™s
))

1318 
	`msg
(
msgËv–
, "in --iroute %s %s : Bad‚etwork/subnet specification",

1319 
ÃtwÜk_¡r
,

1320 
Ãtmask_¡r
);

1325 
œ
->
Ãxt
 = 
o
->
œou‹s
;

1326 
o
->
œou‹s
 = 
œ
;

1327 
	}
}

1330 
	$İtiÚ_œou‹_v6
(
İtiÚs
 *
o
,

1331 cÚ¡ *
´efix_¡r
,

1332 
msgËv–
)

1334 
œou‹_v6
 *
œ
;

1336 
	`ALLOC_OBJ_GC
(
œ
, 
œou‹_v6
, &
o
->
gc
);

1338 ià(!
	`g‘_v6_addr
(
´efix_¡r
, &
œ
->
ÃtwÜk
, &œ->
Ãtb™s
, 
msgËv–
 ))

1340 
	`msg
(
msgËv–
, "in --iroute-ipv6 %s: Bad IPv6…refix specification",

1341 
´efix_¡r
);

1345 
œ
->
Ãxt
 = 
o
->
œou‹s_v6
;

1346 
o
->
œou‹s_v6
 = 
œ
;

1347 
	}
}

1351 #iâdeà
ENABLE_SMALL


1353 
	$show_h‰p_´oxy_İtiÚs
(cÚ¡ 
h‰p_´oxy_İtiÚs
 *
o
)

1355 
i
;

1356 
	`msg
(
D_SHOW_PARMS
, "BEGIN http_proxy");

1357 
	`SHOW_STR
(
£rv”
);

1358 
	`SHOW_STR
(
pÜt
);

1359 
	`SHOW_STR
(
auth_m‘hod_¡ršg
);

1360 
	`SHOW_STR
(
auth_fe
);

1361 
	`SHOW_STR
(
h‰p_v”siÚ
);

1362 
	`SHOW_STR
(
u£r_ag’t
);

1363 
i
 = 0; i < 
MAX_CUSTOM_HTTP_HEADER
 && 
o
->
cu¡om_h—d”s
[i].
Çme
; i++)

1365 ià(
o
->
cu¡om_h—d”s
[
i
].
cÚ‹Á
)

1367 
	`msg
(
D_SHOW_PARMS
, " cu¡om_h—d”[%d] = %s: %s", 
i
,

1368 
o
->
cu¡om_h—d”s
[
i
].
Çme
, o->cu¡om_h—d”s[i].
cÚ‹Á
);

1372 
	`msg
(
D_SHOW_PARMS
, " cu¡om_h—d”[%d] = %s", 
i
,

1373 
o
->
cu¡om_h—d”s
[
i
].
Çme
);

1376 
	`msg
(
D_SHOW_PARMS
, "END http_proxy");

1377 
	}
}

1381 
	$İtiÚs_d‘ach
(
İtiÚs
 *
o
)

1383 
	`gc_d‘ach
(&
o
->
gc
);

1384 
o
->
rou‹s
 = 
NULL
;

1385 
o
->
ş›Á_Çt
 = 
NULL
;

1386 #ià
P2MP_SERVER


1387 
	`şÚe_push_li¡
(
o
);

1389 
	}
}

1392 
	$rŞ_check_®loc
(
İtiÚs
 *options)

1394 ià(!
İtiÚs
->
rou‹s
)

1396 
İtiÚs
->
rou‹s
 = 
	`Ãw_rou‹_İtiÚ_li¡
(&İtiÚs->
gc
);

1398 
	}
}

1401 
	$rŞ6_check_®loc
(
İtiÚs
 *options)

1403 ià(!
İtiÚs
->
rou‹s_v6
)

1405 
İtiÚs
->
rou‹s_v6
 = 
	`Ãw_rou‹_v6_İtiÚ_li¡
(&İtiÚs->
gc
);

1407 
	}
}

1410 
	$úŞ_check_®loc
(
İtiÚs
 *options)

1412 ià(!
İtiÚs
->
ş›Á_Çt
)

1414 
İtiÚs
->
ş›Á_Çt
 = 
	`Ãw_ş›Á_Çt_li¡
(&İtiÚs->
gc
);

1416 
	}
}

1418 #iâdeà
ENABLE_SMALL


1420 
	$show_cÚÃùiÚ_’Œy
(cÚ¡ 
cÚÃùiÚ_’Œy
 *
o
)

1422 
	`msg
(
D_SHOW_PARMS
, "…rÙØğ%s", 
	`´Ùo2ascii
(
o
->
´Ùo
, o->
af
, 
çl£
));

1423 
	`SHOW_STR
(
loÿl
);

1424 
	`SHOW_STR
(
loÿl_pÜt
);

1425 
	`SHOW_STR
(
»mÙe
);

1426 
	`SHOW_STR
(
»mÙe_pÜt
);

1427 
	`SHOW_BOOL
(
»mÙe_æßt
);

1428 
	`SHOW_BOOL
(
bšd_defšed
);

1429 
	`SHOW_BOOL
(
bšd_loÿl
);

1430 
	`SHOW_BOOL
(
bšd_v6_Úly
);

1431 
	`SHOW_INT
(
cÚÃù_»Œy_£cÚds
);

1432 
	`SHOW_INT
(
cÚÃù_timeout
);

1434 ià(
o
->
h‰p_´oxy_İtiÚs
)

1436 
	`show_h‰p_´oxy_İtiÚs
(
o
->
h‰p_´oxy_İtiÚs
);

1438 
	`SHOW_STR
(
socks_´oxy_£rv”
);

1439 
	`SHOW_STR
(
socks_´oxy_pÜt
);

1440 
	`SHOW_INT
(
tun_mtu
);

1441 
	`SHOW_BOOL
(
tun_mtu_defšed
);

1442 
	`SHOW_INT
(
lšk_mtu
);

1443 
	`SHOW_BOOL
(
lšk_mtu_defšed
);

1444 
	`SHOW_INT
(
tun_mtu_exŒa
);

1445 
	`SHOW_BOOL
(
tun_mtu_exŒa_defšed
);

1447 
	`SHOW_INT
(
mtu_discov”_ty³
);

1449 #ifdeà
ENABLE_FRAGMENT


1450 
	`SHOW_INT
(
äagm’t
);

1452 
	`SHOW_INT
(
mssfix
);

1454 #ifdeà
ENABLE_OCC


1455 
	`SHOW_INT
(
ex¶ic™_ex™_nÙifiÿtiÚ
);

1457 
	}
}

1461 
	$show_cÚÃùiÚ_’Œ›s
(cÚ¡ 
İtiÚs
 *
o
)

1463 ià(
o
->
cÚÃùiÚ_li¡
)

1465 cÚ¡ 
cÚÃùiÚ_li¡
 *
l
 = 
o
->connection_list;

1466 
i
;

1467 
i
 = 0; i < 
l
->
Ën
; ++i)

1469 
	`msg
(
D_SHOW_PARMS
, "CÚÃùiÚ…rofe [%d]:", 
i
);

1470 
	`show_cÚÃùiÚ_’Œy
(
l
->
¬¿y
[
i
]);

1475 
	`msg
(
D_SHOW_PARMS
, "Connection…rofiles [default]:");

1476 
	`show_cÚÃùiÚ_’Œy
(&
o
->
û
);

1478 
	`msg
(
D_SHOW_PARMS
, "Connection…rofiles END");

1479 
	}
}

1482 
	$show_puÎ_f‹r_li¡
(cÚ¡ 
puÎ_f‹r_li¡
 *
l
)

1484 
puÎ_f‹r
 *
f
;

1485 ià(!
l
)

1490 
	`msg
(
D_SHOW_PARMS
, " Pull filters:");

1491 
f
 = 
l
->
h—d
; f; f = f->
Ãxt
)

1493 
	`msg
(
D_SHOW_PARMS
, " % \"%s\"", 
	`puÎ_f‹r_ty³_Çme
(
f
->
ty³
), f->
·‰”n
);

1495 
	}
}

1500 
	$show_£‰šgs
(cÚ¡ 
İtiÚs
 *
o
)

1502 #iâdeà
ENABLE_SMALL


1503 
	`msg
(
D_SHOW_PARMS
, "Current Parameter Settings:");

1505 
	`SHOW_STR
(
cÚfig
);

1507 
	`SHOW_INT
(
mode
);

1509 #ifdeà
ENABLE_FEATURE_TUN_PERSIST


1510 
	`SHOW_BOOL
(
³rsi¡_cÚfig
);

1511 
	`SHOW_INT
(
³rsi¡_mode
);

1514 #ifdeà
ENABLE_CRYPTO


1515 
	`SHOW_BOOL
(
show_ch”s
);

1516 
	`SHOW_BOOL
(
show_dige¡s
);

1517 
	`SHOW_BOOL
(
show_’gšes
);

1518 
	`SHOW_BOOL
(
g’key
);

1519 
	`SHOW_STR
(
key_·ss_fe
);

1520 
	`SHOW_BOOL
(
show_s_ch”s
);

1523 
	`SHOW_INT
(
cÚÃù_»Œy_max
);

1524 
	`show_cÚÃùiÚ_’Œ›s
(
o
);

1526 
	`SHOW_BOOL
(
»mÙe_¿ndom
);

1528 
	`SHOW_STR
(
chªge
);

1529 
	`SHOW_STR
(
dev
);

1530 
	`SHOW_STR
(
dev_ty³
);

1531 
	`SHOW_STR
(
dev_node
);

1532 
	`SHOW_STR
(
Îaddr
);

1533 
	`SHOW_INT
(
tİŞogy
);

1534 
	`SHOW_STR
(
ifcÚfig_loÿl
);

1535 
	`SHOW_STR
(
ifcÚfig_»mÙe_Ãtmask
);

1536 
	`SHOW_BOOL
(
ifcÚfig_nÛxec
);

1537 
	`SHOW_BOOL
(
ifcÚfig_now¬n
);

1538 
	`SHOW_STR
(
ifcÚfig_v6_loÿl
);

1539 
	`SHOW_INT
(
ifcÚfig_v6_Ãtb™s
);

1540 
	`SHOW_STR
(
ifcÚfig_v6_»mÙe
);

1542 #ifdeà
ENABLE_FEATURE_SHAPER


1543 
	`SHOW_INT
(
sh­”
);

1545 #ifdeà
ENABLE_OCC


1546 
	`SHOW_INT
(
mtu_‹¡
);

1549 
	`SHOW_BOOL
(
mlock
);

1551 
	`SHOW_INT
(
k“·live_pšg
);

1552 
	`SHOW_INT
(
k“·live_timeout
);

1553 
	`SHOW_INT
(
šaùiv™y_timeout
);

1554 
	`SHOW_INT
(
pšg_£nd_timeout
);

1555 
	`SHOW_INT
(
pšg_»c_timeout
);

1556 
	`SHOW_INT
(
pšg_»c_timeout_aùiÚ
);

1557 
	`SHOW_BOOL
(
pšg_tim”_»mÙe
);

1558 
	`SHOW_INT
(
»m­_sigu¤1
);

1559 
	`SHOW_BOOL
(
³rsi¡_tun
);

1560 
	`SHOW_BOOL
(
³rsi¡_loÿl_
);

1561 
	`SHOW_BOOL
(
³rsi¡_»mÙe_
);

1562 
	`SHOW_BOOL
(
³rsi¡_key
);

1564 #ià
PASSTOS_CAPABILITY


1565 
	`SHOW_BOOL
(
·s¡os
);

1568 
	`SHOW_INT
(
»sŞve_»Œy_£cÚds
);

1569 
	`SHOW_BOOL
(
»sŞve_š_advªû
);

1571 
	`SHOW_STR
(
u£ºame
);

1572 
	`SHOW_STR
(
grou²ame
);

1573 
	`SHOW_STR
(
chroÙ_dœ
);

1574 
	`SHOW_STR
(
cd_dœ
);

1575 #ifdeà
ENABLE_SELINUX


1576 
	`SHOW_STR
(
£lšux_cÚ‹xt
);

1578 
	`SHOW_STR
(
wr™•id
);

1579 
	`SHOW_STR
(
up_süt
);

1580 
	`SHOW_STR
(
down_süt
);

1581 
	`SHOW_BOOL
(
down_´e
);

1582 
	`SHOW_BOOL
(
up_»¡¬t
);

1583 
	`SHOW_BOOL
(
up_d–ay
);

1584 
	`SHOW_BOOL
(
d«mÚ
);

1585 
	`SHOW_INT
(
š‘d
);

1586 
	`SHOW_BOOL
(
log
);

1587 
	`SHOW_BOOL
(
suµ»ss_time¡amps
);

1588 
	`SHOW_BOOL
(
machše_»adabË_ouut
);

1589 
	`SHOW_INT
(
niû
);

1590 
	`SHOW_INT
(
v”bos™y
);

1591 
	`SHOW_INT
(
mu‹
);

1592 #ifdeà
ENABLE_DEBUG


1593 
	`SHOW_INT
(
g»mlš
);

1595 
	`SHOW_STR
(
¡©us_fe
);

1596 
	`SHOW_INT
(
¡©us_fe_v”siÚ
);

1597 
	`SHOW_INT
(
¡©us_fe_upd©e_äeq
);

1599 #ifdeà
ENABLE_OCC


1600 
	`SHOW_BOOL
(
occ
);

1602 
	`SHOW_INT
(
rcvbuf
);

1603 
	`SHOW_INT
(
¢dbuf
);

1604 #ià
	`defšed
(
TARGET_LINUX
è&& 
HAVE_DECL_SO_MARK


1605 
	`SHOW_INT
(
m¬k
);

1607 
	`SHOW_INT
(
sockæags
);

1609 
	`SHOW_BOOL
(
ç¡_io
);

1611 #ifdeà
USE_COMP


1612 
	`SHOW_INT
(
comp
.
®g
);

1613 
	`SHOW_INT
(
comp
.
æags
);

1616 
	`SHOW_STR
(
rou‹_süt
);

1617 
	`SHOW_STR
(
rou‹_deçuÉ_g©eway
);

1618 
	`SHOW_INT
(
rou‹_deçuÉ_m‘ric
);

1619 
	`SHOW_BOOL
(
rou‹_nÛxec
);

1620 
	`SHOW_INT
(
rou‹_d–ay
);

1621 
	`SHOW_INT
(
rou‹_d–ay_wšdow
);

1622 
	`SHOW_BOOL
(
rou‹_d–ay_defšed
);

1623 
	`SHOW_BOOL
(
rou‹_nİuÎ
);

1624 
	`SHOW_BOOL
(
rou‹_g©eway_vŸ_dhı
);

1625 
	`SHOW_BOOL
(
®low_puÎ_fqdn
);

1626 
	`show_puÎ_f‹r_li¡
(
o
->
puÎ_f‹r_li¡
);

1628 ià(
o
->
rou‹s
)

1630 
	`´št_rou‹_İtiÚs
(
o
->
rou‹s
, 
D_SHOW_PARMS
);

1633 ià(
o
->
ş›Á_Çt
)

1635 
	`´št_ş›Á_Çt_li¡
(
o
->
ş›Á_Çt
, 
D_SHOW_PARMS
);

1638 #ifdeà
ENABLE_MANAGEMENT


1639 
	`SHOW_STR
(
mªagem’t_addr
);

1640 
	`SHOW_STR
(
mªagem’t_pÜt
);

1641 
	`SHOW_STR
(
mªagem’t_u£r_·ss
);

1642 
	`SHOW_INT
(
mªagem’t_log_hi¡Üy_ÿche
);

1643 
	`SHOW_INT
(
mªagem’t_echo_bufãr_size
);

1644 
	`SHOW_STR
(
mªagem’t_wr™e_³”_šfo_fe
);

1645 
	`SHOW_STR
(
mªagem’t_ş›Á_u£r
);

1646 
	`SHOW_STR
(
mªagem’t_ş›Á_group
);

1647 
	`SHOW_INT
(
mªagem’t_æags
);

1649 #ifdeà
ENABLE_PLUGIN


1650 ià(
o
->
¶ugš_li¡
)

1652 
	`¶ugš_İtiÚ_li¡_´št
(
o
->
¶ugš_li¡
, 
D_SHOW_PARMS
);

1656 #ifdeà
ENABLE_CRYPTO


1657 
	`SHOW_STR
(
sh¬ed_£ü‘_fe
);

1658 
	`SHOW_PARM
(
key_dœeùiÚ
, 
	`keydœeùiÚ2ascii
(
o
->key_dœeùiÚ, 
çl£
, 
Œue
), "%s");

1659 
	`SHOW_STR
(
ch”Çme
);

1660 
	`SHOW_BOOL
(
nı_’abËd
);

1661 
	`SHOW_STR
(
nı_ch”s
);

1662 
	`SHOW_STR
(
authÇme
);

1663 
	`SHOW_STR
(
´ng_hash
);

1664 
	`SHOW_INT
(
´ng_nÚû_£ü‘_Ën
);

1665 
	`SHOW_INT
(
keysize
);

1666 #iâdeà
ENABLE_CRYPTO_MBEDTLS


1667 
	`SHOW_BOOL
(
’gše
);

1669 
	`SHOW_BOOL
(
»¶ay
);

1670 
	`SHOW_BOOL
(
mu‹_»¶ay_w¬nšgs
);

1671 
	`SHOW_INT
(
»¶ay_wšdow
);

1672 
	`SHOW_INT
(
»¶ay_time
);

1673 
	`SHOW_STR
(
·ck‘_id_fe
);

1674 
	`SHOW_BOOL
(
u£_iv
);

1675 
	`SHOW_BOOL
(
‹¡_üy±o
);

1676 #ifdeà
ENABLE_PREDICTION_RESISTANCE


1677 
	`SHOW_BOOL
(
u£_´ediùiÚ_»si¡ªû
);

1680 
	`SHOW_BOOL
(
s_£rv”
);

1681 
	`SHOW_BOOL
(
s_ş›Á
);

1682 
	`SHOW_INT
(
key_m‘hod
);

1683 
	`SHOW_STR
(
ÿ_fe
);

1684 
	`SHOW_STR
(
ÿ_·th
);

1685 
	`SHOW_STR
(
dh_fe
);

1686 #ifdeà
MANAGMENT_EXTERNAL_KEY


1687 ià((
o
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
))

1689 
	`SHOW_PARM
("cert_file","EXTERNAL_CERT","%s");

1693 
	`SHOW_STR
(
û¹_fe
);

1694 
	`SHOW_STR
(
exŒa_û¹s_fe
);

1696 #ifdeà
MANAGMENT_EXTERNAL_KEY


1697 ià((
o
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
))

1699 
	`SHOW_PARM
("priv_key_file","EXTERNAL_PRIVATE_KEY","%s");

1703 
	`SHOW_STR
(
´iv_key_fe
);

1704 #iâdeà
ENABLE_CRYPTO_MBEDTLS


1705 
	`SHOW_STR
(
pkcs12_fe
);

1707 #ifdeà
ENABLE_CRYPTOAPI


1708 
	`SHOW_STR
(
üy±ßpi_û¹
);

1710 
	`SHOW_STR
(
ch”_li¡
);

1711 
	`SHOW_STR
(
ch”_li¡_s13
);

1712 
	`SHOW_STR
(
s_û¹_´ofe
);

1713 
	`SHOW_STR
(
s_v”ify
);

1714 
	`SHOW_STR
(
s_expÜt_û¹
);

1715 
	`SHOW_INT
(
v”ify_x509_ty³
);

1716 
	`SHOW_STR
(
v”ify_x509_Çme
);

1717 
	`SHOW_STR
(
ül_fe
);

1718 
	`SHOW_INT
(
ns_û¹_ty³
);

1720 
i
;

1721 
i
 = 0; i<
MAX_PARMS
; i++)

1723 
	`SHOW_INT
(
»mÙe_û¹_ku
[
i
]);

1726 
	`SHOW_STR
(
»mÙe_û¹_eku
);

1727 
	`SHOW_INT
(
s¦_æags
);

1729 
	`SHOW_INT
(
s_timeout
);

1731 
	`SHOW_INT
(
»ÃgÙŸ‹_by‹s
);

1732 
	`SHOW_INT
(
»ÃgÙŸ‹_·ck‘s
);

1733 
	`SHOW_INT
(
»ÃgÙŸ‹_£cÚds
);

1735 
	`SHOW_INT
(
hªdshake_wšdow
);

1736 
	`SHOW_INT
(
Œªs™iÚ_wšdow
);

1738 
	`SHOW_BOOL
(
sšgË_£ssiÚ
);

1739 #ifdeà
ENABLE_PUSH_PEER_INFO


1740 
	`SHOW_BOOL
(
push_³”_šfo
);

1742 
	`SHOW_BOOL
(
s_ex™
);

1744 
	`SHOW_STR
(
s_auth_fe
);

1745 
	`SHOW_STR
(
s_üy±_fe
);

1748 #ifdeà
ENABLE_PKCS11


1750 
i
;

1751 
i
 = 0; i<
MAX_PARMS
 && 
o
->
pkcs11_´ovid”s
[i] !ğ
NULL
; i++)

1753 
	`SHOW_PARM
(
pkcs11_´ovid”s
, 
o
->pkcs11_´ovid”s[
i
], "%s");

1757 
i
;

1758 
i
 = 0; i<
MAX_PARMS
; i++)

1760 
	`SHOW_PARM
(
pkcs11_´Ùeùed_auth’tiÿtiÚ
, 
o
->pkcs11_´Ùeùed_auth’tiÿtiÚ[
i
] ? "ENABLED" : "DISABLED", "%s");

1764 
i
;

1765 
i
 = 0; i<
MAX_PARMS
; i++)

1767 
	`SHOW_PARM
(
pkcs11_´iv©e_mode
, 
o
->pkcs11_´iv©e_mode[
i
], "%08x");

1771 
i
;

1772 
i
 = 0; i<
MAX_PARMS
; i++)

1774 
	`SHOW_PARM
(
pkcs11_û¹_´iv©e
, 
o
->pkcs11_û¹_´iv©e[
i
] ? "ENABLED" : "DISABLED", "%s");

1777 
	`SHOW_INT
(
pkcs11_pš_ÿche_³riod
);

1778 
	`SHOW_STR
(
pkcs11_id
);

1779 
	`SHOW_BOOL
(
pkcs11_id_mªagem’t
);

1782 #ià
P2MP


1783 
	`show_p2mp_·rms
(
o
);

1786 #ifdeà
_WIN32


1787 
	`SHOW_BOOL
(
show_Ãt_up
);

1788 
	`SHOW_INT
(
rou‹_m‘hod
);

1789 
	`SHOW_BOOL
(
block_outside_dns
);

1790 
	`show_tuÁ­_İtiÚs
(&
o
->
tuÁ­_İtiÚs
);

1793 
	}
}

1795 #undeà
SHOW_PARM


1796 #undeà
SHOW_STR


1797 #undeà
SHOW_INT


1798 #undeà
SHOW_BOOL


1800 #ifdeà
ENABLE_MANAGEMENT


1802 
h‰p_´oxy_İtiÚs
 *

1803 
	$·r£_h‰p_´oxy_ov”ride
(cÚ¡ *
£rv”
,

1804 cÚ¡ *
pÜt
,

1805 cÚ¡ *
æags
,

1806 cÚ¡ 
msgËv–
,

1807 
gc_¬’a
 *
gc
)

1809 ià(
£rv”
 && 
pÜt
)

1811 
h‰p_´oxy_İtiÚs
 *
ho
;

1812 
	`ALLOC_OBJ_CLEAR_GC
(
ho
, 
h‰p_´oxy_İtiÚs
, 
gc
);

1813 
ho
->
£rv”
 = 
	`¡ršg_®loc
(£rv”, 
gc
);

1814 
ho
->
pÜt
 =…ort;

1815 ià(
æags
 && !
	`¡rcmp
(flags, "nct"))

1817 
ho
->
auth_»Œy
 = 
PAR_NCT
;

1821 
ho
->
auth_»Œy
 = 
PAR_ALL
;

1823 
ho
->
h‰p_v”siÚ
 = "1.0";

1824 
ho
->
u£r_ag’t
 = "OpenVPN-Autoproxy/1.0";

1825  
ho
;

1829  
NULL
;

1831 
	}
}

1834 
	$İtiÚs_po¡´oûss_h‰p_´oxy_ov”ride
(
İtiÚs
 *
o
)

1836 cÚ¡ 
cÚÃùiÚ_li¡
 *
l
 = 
o
->connection_list;

1837 
i
;

1838 
boŞ
 
sucûed
 = 
çl£
;

1839 
i
 = 0; i < 
l
->
Ën
; ++i)

1841 
cÚÃùiÚ_’Œy
 *
û
 = 
l
->
¬¿y
[
i
];

1842 ià(
û
->
´Ùo
 =ğ
PROTO_TCP_CLIENT
 || ce->´ÙØ=ğ
PROTO_TCP
)

1844 
û
->
h‰p_´oxy_İtiÚs
 = 
o
->
h‰p_´oxy_ov”ride
;

1845 
sucûed
 = 
Œue
;

1848 ià(
sucûed
)

1850 
i
 = 0; i < 
l
->
Ën
; ++i)

1852 
cÚÃùiÚ_’Œy
 *
û
 = 
l
->
¬¿y
[
i
];

1853 ià(
û
->
´Ùo
 =ğ
PROTO_UDP
)

1855 
û
->
æags
 |ğ
CE_DISABLED
;

1861 
	`msg
(
M_WARN
, "Note: option http-proxy-override ignored because‚o TCP-based connection…rofiles‡re defined");

1863 
	}
}

1867 
cÚÃùiÚ_li¡
 *

1868 
	$®loc_cÚÃùiÚ_li¡_if_undef
(
İtiÚs
 *options)

1870 ià(!
İtiÚs
->
cÚÃùiÚ_li¡
)

1872 
	`ALLOC_OBJ_CLEAR_GC
(
İtiÚs
->
cÚÃùiÚ_li¡
, cÚÃùiÚ_li¡, &İtiÚs->
gc
);

1874  
İtiÚs
->
cÚÃùiÚ_li¡
;

1875 
	}
}

1877 
cÚÃùiÚ_’Œy
 *

1878 
	$®loc_cÚÃùiÚ_’Œy
(
İtiÚs
 *İtiÚs, cÚ¡ 
msgËv–
)

1880 
cÚÃùiÚ_li¡
 *
l
 = 
	`®loc_cÚÃùiÚ_li¡_if_undef
(
İtiÚs
);

1881 
cÚÃùiÚ_’Œy
 *
e
;

1883 ià(
l
->
Ën
 >ğ
CONNECTION_LIST_SIZE
)

1885 
	`msg
(
msgËv–
, "Maximum‚umb” oà'cÚÃùiÚ' o±iÚ (%dèexûeded", 
CONNECTION_LIST_SIZE
);

1886  
NULL
;

1888 
	`ALLOC_OBJ_GC
(
e
, 
cÚÃùiÚ_’Œy
, &
İtiÚs
->
gc
);

1889 
l
->
¬¿y
[l->
Ën
++] = 
e
;

1890  
e
;

1891 
	}
}

1893 
»mÙe_li¡
 *

1894 
	$®loc_»mÙe_li¡_if_undef
(
İtiÚs
 *options)

1896 ià(!
İtiÚs
->
»mÙe_li¡
)

1898 
	`ALLOC_OBJ_CLEAR_GC
(
İtiÚs
->
»mÙe_li¡
, »mÙe_li¡, &İtiÚs->
gc
);

1900  
İtiÚs
->
»mÙe_li¡
;

1901 
	}
}

1903 
»mÙe_’Œy
 *

1904 
	$®loc_»mÙe_’Œy
(
İtiÚs
 *İtiÚs, cÚ¡ 
msgËv–
)

1906 
»mÙe_li¡
 *
l
 = 
	`®loc_»mÙe_li¡_if_undef
(
İtiÚs
);

1907 
»mÙe_’Œy
 *
e
;

1909 ià(
l
->
Ën
 >ğ
CONNECTION_LIST_SIZE
)

1911 
	`msg
(
msgËv–
, "Maximum‚umb” oà'»mÙe' o±iÚ (%dèexûeded", 
CONNECTION_LIST_SIZE
);

1912  
NULL
;

1914 
	`ALLOC_OBJ_GC
(
e
, 
»mÙe_’Œy
, &
İtiÚs
->
gc
);

1915 
l
->
¬¿y
[l->
Ën
++] = 
e
;

1916  
e
;

1917 
	}
}

1919 
puÎ_f‹r_li¡
 *

1920 
	$®loc_puÎ_f‹r_li¡
(
İtiÚs
 *
o
)

1922 ià(!
o
->
puÎ_f‹r_li¡
)

1924 
	`ALLOC_OBJ_CLEAR_GC
(
o
->
puÎ_f‹r_li¡
, puÎ_f‹r_li¡, &o->
gc
);

1926  
o
->
puÎ_f‹r_li¡
;

1927 
	}
}

1929 
puÎ_f‹r
 *

1930 
	$®loc_puÎ_f‹r
(
İtiÚs
 *
o
, cÚ¡ 
msgËv–
)

1932 
puÎ_f‹r_li¡
 *
l
 = 
	`®loc_puÎ_f‹r_li¡
(
o
);

1933 
puÎ_f‹r
 *
f
;

1935 
	`ALLOC_OBJ_CLEAR_GC
(
f
, 
puÎ_f‹r
, &
o
->
gc
);

1936 ià(
l
->
h—d
)

1938 
	`ASSERT
(
l
->

);

1939 
l
->

->
Ãxt
 = 
f
;

1943 
	`ASSERT
(!
l
->

);

1944 
l
->
h—d
 = 
f
;

1946 
l
->

 = 
f
;

1947  
f
;

1948 
	}
}

1951 
	$cÚÃùiÚ_’Œy_lßd_»
(
cÚÃùiÚ_’Œy
 *
û
, cÚ¡ 
»mÙe_’Œy
 *
»
)

1953 ià(
»
->
»mÙe
)

1955 
û
->
»mÙe
 = 
»
->remote;

1957 ià(
»
->
»mÙe_pÜt
)

1959 
û
->
»mÙe_pÜt
 = 
»
->remote_port;

1961 ià(
»
->
´Ùo
 >= 0)

1963 
û
->
´Ùo
 = 
»
->proto;

1965 ià(
»
->
af
 > 0)

1967 
û
->
af
 = 
»
->af;

1969 
	}
}

1972 
	$İtiÚs_po¡´oûss_v”ify_û
(cÚ¡ 
İtiÚs
 *İtiÚs, cÚ¡ 
cÚÃùiÚ_’Œy
 *
û
)

1974 
İtiÚs
 
deçuÉs
;

1975 
dev
 = 
DEV_TYPE_UNDEF
;

1976 
boŞ
 
puÎ
 = 
çl£
;

1978 
	`š™_İtiÚs
(&
deçuÉs
, 
Œue
);

1980 #ifdeà
ENABLE_CRYPTO


1981 ià(
İtiÚs
->
‹¡_üy±o
)

1983 
	`nÙnuÎ
(
İtiÚs
->
sh¬ed_£ü‘_fe
, "key file (--secret)");

1987 
	`nÙnuÎ
(
İtiÚs
->
dev
, "TUN/TAP device (--dev)");

1992 
dev
 = 
	`dev_ty³_’um
(
İtiÚs
->dev, o±iÚs->
dev_ty³
);

1998 ià(
û
->
´Ùo
 =ğ
PROTO_TCP
)

2000 
	`msg
(
M_USAGE
, "--protocp is‡mbiguous inhis context. Please specify --protocp-server or --protocp-client");

2007 ià(
İtiÚs
->
d«mÚ
 && o±iÚs->
š‘d
)

2009 
	`msg
(
M_USAGE
, "only one of --daemon or --inetd may be specified");

2012 ià(
İtiÚs
->
š‘d
 && (
û
->
loÿl
 || ce->
»mÙe
))

2014 
	`msg
(
M_USAGE
, "--local or --remote cannot be used with --inetd");

2017 ià(
İtiÚs
->
š‘d
 && 
û
->
´Ùo
 =ğ
PROTO_TCP_CLIENT
)

2019 
	`msg
(
M_USAGE
, "--protocp-client cannot be used with --inetd");

2022 ià(
İtiÚs
->
š‘d
 =ğ
INETD_NOWAIT
 && 
û
->
´Ùo
 !ğ
PROTO_TCP_SERVER
)

2024 
	`msg
(
M_USAGE
, "--inetd‚owait can only be used with --protocp-server");

2027 ià(
İtiÚs
->
š‘d
 =ğ
INETD_NOWAIT


2028 #ifdeà
ENABLE_CRYPTO


2029 && !(
İtiÚs
->
s_£rv”
 || o±iÚs->
s_ş›Á
)

2033 
	`msg
(
M_USAGE
, "--inetd‚owait can only be used in TLS mode");

2036 ià(
İtiÚs
->
š‘d
 =ğ
INETD_NOWAIT
 && 
dev
 !ğ
DEV_TYPE_TAP
)

2038 
	`msg
(
M_USAGE
, "--inetd‚owait only makes sense in --devap mode");

2042 ià(
İtiÚs
->
Îaddr
 && 
dev
 !ğ
DEV_TYPE_TAP
)

2044 
	`msg
(
M_USAGE
, "--lladdr can only be used in --devap mode");

2050 ià(
İtiÚs
->
û
.
tun_mtu_defšed
 && o±iÚs->û.
lšk_mtu_defšed
)

2052 
	`msg
(
M_USAGE
, "Úly oÃ oà--tun-mtu o¸--lšk-mtu may bdefšed (nÙth© --ifcÚfig im¶› --lšk-mtu %d)", 
LINK_MTU_DEFAULT
);

2055 #ifdeà
ENABLE_OCC


2056 ià(!
	`´Ùo_is_udp
(
û
->
´Ùo
è&& 
İtiÚs
->
mtu_‹¡
)

2058 
	`msg
(
M_USAGE
, "--mtu-test only makes sense with --proto udp");

2063 #ià
P2MP


2064 
puÎ
 = 
İtiÚs
->pull;

2071 ià(
	`´Ùo_is_Ãt
(
û
->
´Ùo
)

2072 && 
	`¡ršg_defšed_equ®
(
û
->
loÿl
, ce->
»mÙe
)

2073 && 
	`¡ršg_defšed_equ®
(
û
->
loÿl_pÜt
, ce->
»mÙe_pÜt
))

2075 
	`msg
(
M_USAGE
, "--remote‡nd --local‡ddresses‡rehe same");

2078 ià(
	`¡ršg_defšed_equ®
(
û
->
»mÙe
, 
İtiÚs
->
ifcÚfig_loÿl
)

2079 || 
	`¡ršg_defšed_equ®
(
û
->
»mÙe
, 
İtiÚs
->
ifcÚfig_»mÙe_Ãtmask
))

2081 
	`msg
(
M_USAGE
, "--local‡nd --remote‡ddresses must be distinct from --ifconfig‡ddresses");

2084 ià(
	`¡ršg_defšed_equ®
(
û
->
loÿl
, 
İtiÚs
->
ifcÚfig_loÿl
)

2085 || 
	`¡ršg_defšed_equ®
(
û
->
loÿl
, 
İtiÚs
->
ifcÚfig_»mÙe_Ãtmask
))

2087 
	`msg
(
M_USAGE
, "--local‡ddresses must be distinct from --ifconfig‡ddresses");

2090 ià(
	`¡ršg_defšed_equ®
(
İtiÚs
->
ifcÚfig_loÿl
, o±iÚs->
ifcÚfig_»mÙe_Ãtmask
))

2092 
	`msg
(
M_USAGE
, "local‡nd„emote/netmask --ifconfig‡ddresses must be different");

2095 ià(
û
->
bšd_defšed
 && !û->
bšd_loÿl
)

2097 
	`msg
(
M_USAGE
, "--bind‡nd --nobind can't be usedogether");

2100 ià(
û
->
loÿl
 && !û->
bšd_loÿl
)

2102 
	`msg
(
M_USAGE
, "--local‡nd --nobind don't make sense when usedogether");

2105 ià(
û
->
loÿl_pÜt_defšed
 && !û->
bšd_loÿl
)

2107 
	`msg
(
M_USAGE
, "--lport‡nd --nobind don't make sense when usedogether");

2110 ià(!
û
->
»mÙe
 && !û->
bšd_loÿl
)

2112 
	`msg
(
M_USAGE
, "--nobind doesn't make sense unless used with --remote");

2118 #ifdeà
ENABLE_MANAGEMENT


2119 ià(!
İtiÚs
->
mªagem’t_addr


2120 && (
İtiÚs
->
mªagem’t_æags


2121 || 
İtiÚs
->
mªagem’t_wr™e_³”_šfo_fe


2122 || 
İtiÚs
->
mªagem’t_log_hi¡Üy_ÿche
 !ğ
deçuÉs
.management_log_history_cache))

2124 
	`msg
(
M_USAGE
, "--management is‚ot specified, however one or more options which modifyhe behavior of --management were specified");

2127 ià((
İtiÚs
->
mªagem’t_ş›Á_u£r
 || o±iÚs->
mªagem’t_ş›Á_group
)

2128 && !(
İtiÚs
->
mªagem’t_æags
 & 
MF_UNIX_SOCK
))

2130 
	`msg
(
M_USAGE
, "--management-client-(user|group) can only be used on unix domain sockets");

2133 ià(
İtiÚs
->
mªagem’t_addr


2134 && !(
İtiÚs
->
mªagem’t_æags
 & 
MF_UNIX_SOCK
)

2135 && (!
İtiÚs
->
mªagem’t_u£r_·ss
))

2137 
	`msg
(
M_WARN
, "WARNING: Using --management on‡ TCP…ort WITHOUT "

2147 #ifdeà
_WIN32


2148 ià(
dev
 =ğ
DEV_TYPE_TUN
 && !(
puÎ
 || (
İtiÚs
->
ifcÚfig_loÿl
 && o±iÚs->
ifcÚfig_»mÙe_Ãtmask
)))

2150 
	`msg
(
M_USAGE
, "On Windows, --ifconfig is„equired when --devun is used");

2153 ià((
İtiÚs
->
tuÁ­_İtiÚs
.
_wš32_defšed
)

2154 && !(
puÎ
 || (
İtiÚs
->
ifcÚfig_loÿl
 && o±iÚs->
ifcÚfig_»mÙe_Ãtmask
)))

2156 
	`msg
(
M_USAGE
, "On Windows, --ip-win32 doesn't make sense unless --ifconfig is‡lso used");

2159 ià(
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_İtiÚs


2160 && 
İtiÚs
->
tuÁ­_İtiÚs
.
_wš32_ty³
 !ğ
IPW32_SET_DHCP_MASQ


2161 && 
İtiÚs
->
tuÁ­_İtiÚs
.
_wš32_ty³
 !ğ
IPW32_SET_ADAPTIVE
)

2163 
	`msg
(
M_USAGE
, "--dhcp-options„equires --ip-win32 dynamic or‡daptive");

2171 #ifdeà
ENABLE_FRAGMENT


2172 ià(!
	`´Ùo_is_udp
(
û
->
´Ùo
è&& ce->
äagm’t
)

2174 
	`msg
(
M_USAGE
, "--fragment can only be used with --proto udp");

2178 #ifdeà
ENABLE_OCC


2179 ià(!
	`´Ùo_is_udp
(
û
->
´Ùo
è&& ce->
ex¶ic™_ex™_nÙifiÿtiÚ
)

2181 
	`msg
(
M_USAGE
, "--explicit-exit-notify can only be used with --proto udp");

2185 ià(!
û
->
»mÙe
 && ce->
´Ùo
 =ğ
PROTO_TCP_CLIENT
)

2187 
	`msg
(
M_USAGE
, "--remote MUST be used in TCP Client mode");

2190 ià((
û
->
h‰p_´oxy_İtiÚs
è&& ce->
´Ùo
 !ğ
PROTO_TCP_CLIENT
)

2192 
	`msg
(
M_USAGE
, "--http-proxy MUST be used in TCP Client mode (i.e. --protocp-client)");

2194 ià((
û
->
h‰p_´oxy_İtiÚs
è&& !û->h‰p_´oxy_İtiÚs->
£rv”
)

2196 
	`msg
(
M_USAGE
, "--http-proxy‚ot specified but other http…roxy options…resent");

2199 ià(
û
->
h‰p_´oxy_İtiÚs
 && ce->
socks_´oxy_£rv”
)

2201 
	`msg
(
M_USAGE
, "--http-proxy can‚ot be usedogether with --socks-proxy");

2204 ià(
û
->
socks_´oxy_£rv”
 && ce->
´Ùo
 =ğ
PROTO_TCP_SERVER
)

2206 
	`msg
(
M_USAGE
, "--socks-proxy can‚ot be used in TCP Server mode");

2209 ià(
û
->
´Ùo
 =ğ
PROTO_TCP_SERVER
 && (
İtiÚs
->
cÚÃùiÚ_li¡
->
Ën
 > 1))

2211 
	`msg
(
M_USAGE
, "TCP server mode‡llows‡t most one --remote‡ddress");

2214 #ià
P2MP_SERVER


2219 ià(
İtiÚs
->
mode
 =ğ
MODE_SERVER
)

2221 ià(!(
dev
 =ğ
DEV_TYPE_TUN
 || dev =ğ
DEV_TYPE_TAP
))

2223 
	`msg
(
M_USAGE
, "--mode server only works with --devun or --devap");

2225 ià(
İtiÚs
->
puÎ
)

2227 
	`msg
(
M_USAGE
, "--pull cannot be used with --mode server");

2229 ià(
İtiÚs
->
puÎ_f‹r_li¡
)

2231 
	`msg
(
M_USAGE
, "--pull-filter cannot be used with --mode server");

2233 ià(!(
	`´Ùo_is_udp
(
û
->
´Ùo
è|| ce->´ÙØ=ğ
PROTO_TCP_SERVER
))

2235 
	`msg
(
M_USAGE
, "--mode server currently only supports "

2238 #ià
PORT_SHARE


2239 ià((
İtiÚs
->
pÜt_sh¬e_ho¡
 || o±iÚs->
pÜt_sh¬e_pÜt
)

2240 && (
û
->
´Ùo
 !ğ
PROTO_TCP_SERVER
))

2242 
	`msg
(
M_USAGE
, "--port-share only works in TCP server mode "

2246 ià(!
İtiÚs
->
s_£rv”
)

2248 
	`msg
(
M_USAGE
, "--mode server„equires --tls-server");

2250 ià(
û
->
»mÙe
)

2252 
	`msg
(
M_USAGE
, "--remote cannot be used with --mode server");

2254 ià(!
û
->
bšd_loÿl
)

2256 
	`msg
(
M_USAGE
, "--nobind cannot be used with --mode server");

2258 ià(
û
->
h‰p_´oxy_İtiÚs
)

2260 
	`msg
(
M_USAGE
, "--http-proxy cannot be used with --mode server");

2262 ià(
û
->
socks_´oxy_£rv”
)

2264 
	`msg
(
M_USAGE
, "--socks-proxy cannot be used with --mode server");

2268 ià(
İtiÚs
->
cÚÃùiÚ_li¡
->
Ën
 >1

2269 || 
İtiÚs
->
cÚÃùiÚ_li¡
->
¬¿y
[0]->
»mÙe
)

2271 
	`msg
(
M_USAGE
, "<connection> cannot be used with --mode server");

2274 ià(
İtiÚs
->
sh­”
)

2276 
	`msg
(
M_USAGE
, "--shaper cannot be used with --mode server");

2278 ià(
İtiÚs
->
š‘d
)

2280 
	`msg
(
M_USAGE
, "--inetd cannot be used with --mode server");

2282 ià(
İtiÚs
->
chªge
)

2284 
	`msg
(
M_USAGE
, "--ipchange cannot be used with --mode server (use --client-connect instead)");

2286 ià(!(
	`´Ùo_is_dg¿m
(
û
->
´Ùo
è|| ce->´ÙØ=ğ
PROTO_TCP_SERVER
))

2288 
	`msg
(
M_USAGE
, "--mode server currently only supports "

2291 ià(!
	`´Ùo_is_udp
(
û
->
´Ùo
è&& (
İtiÚs
->
cf_max
 || o±iÚs->
cf_³r
))

2293 
	`msg
(
M_USAGE
, "--connect-freq only works with --mode server --proto udp. Try --max-clients instead.");

2295 ià(!(
dev
 =ğ
DEV_TYPE_TAP
 || (dev =ğ
DEV_TYPE_TUN
 && 
İtiÚs
->
tİŞogy
 =ğ
TOP_SUBNET
)è&& o±iÚs->
ifcÚfig_poŞ_Ãtmask
)

2297 
	`msg
(
M_USAGE
, "Thehird…arametero --ifconfig-pool (netmask) is only valid in --devap mode");

2299 ià(
İtiÚs
->
rou‹s
 && (İtiÚs->rou‹s->
æags
 & 
RG_ENABLE
))

2301 
	`msg
(
M_USAGE
, "--redirect-gateway cannot be used with --mode server (however --push \"redirect-gateway\" is fine)");

2303 ià(
İtiÚs
->
rou‹_d–ay_defšed
)

2305 
	`msg
(
M_USAGE
, "--route-delay cannot be used with --mode server");

2307 ià(
İtiÚs
->
up_d–ay
)

2309 
	`msg
(
M_USAGE
, "--up-delay cannot be used with --mode server");

2311 ià(!
İtiÚs
->
ifcÚfig_poŞ_defšed
 && o±iÚs->
ifcÚfig_poŞ_³rsi¡_f’ame
)

2313 
	`msg
(
M_USAGE
, "--ifconfig-pool-persist must be used with --ifconfig-pool");

2315 ià(
İtiÚs
->
ifcÚfig_v6_poŞ_defšed
 && !İtiÚs->
ifcÚfig_v6_loÿl
)

2317 
	`msg
(
M_USAGE
, "--ifconfig-ipv6-pool‚eeds --ifconfig-ipv6");

2319 ià(
İtiÚs
->
®low_»cursive_routšg
)

2321 
	`msg
(
M_USAGE
, "--allow-recursive-routing cannot be used with --mode server");

2323 ià(
İtiÚs
->
auth_u£r_·ss_fe
)

2325 
	`msg
(
M_USAGE
, "--auth-user-pass cannot be used with --mode server (it should be used onhe client side only)");

2327 ià(
İtiÚs
->
ccd_exşusive
 && !İtiÚs->
ş›Á_cÚfig_dœ
)

2329 
	`msg
(
M_USAGE
, "--ccd-exclusive must be used with --client-config-dir");

2331 ià(
İtiÚs
->
key_m‘hod
 != 2)

2333 
	`msg
(
M_USAGE
, "--mode server„equires --key-method 2");

2337 cÚ¡ 
boŞ
 
cúr
 = (
İtiÚs
->
auth_u£r_·ss_v”ify_süt


2338 || 
	`PLUGIN_OPTION_LIST
(
İtiÚs
)

2339 || 
	`MAN_CLIENT_AUTH_ENABLED
(
İtiÚs
));

2340 cÚ¡ *
po¡fix
 = "must be used with --management-client-auth,‡n --auth-user-pass-verify script, or…lugin";

2341 ià((
İtiÚs
->
s¦_æags
 & (
SSLF_CLIENT_CERT_NOT_REQUIRED
|
SSLF_CLIENT_CERT_OPTIONAL
)è&& !
cúr
)

2343 
	`msg
(
M_USAGE
, "--v”ify-ş›Á-û¹‚Úe|İtiÚ® %s", 
po¡fix
);

2345 ià((
İtiÚs
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
è&& !
cúr
)

2347 
	`msg
(
M_USAGE
, "--u£ºame-as-commÚ-Çm%s", 
po¡fix
);

2349 ià((
İtiÚs
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
è&& !
cúr
)

2351 
	`msg
(
M_USAGE
, "--auth-u£r-·ss-İtiÚ® %s", 
po¡fix
);

2361 ià(
İtiÚs
->
ifcÚfig_poŞ_defšed
 || o±iÚs->
ifcÚfig_poŞ_³rsi¡_f’ame
)

2363 
	`msg
(
M_USAGE
, "--ifconfig-pool/--ifconfig-pool-persist„equires --mode server");

2365 ià(
İtiÚs
->
ifcÚfig_v6_poŞ_defšed
)

2367 
	`msg
(
M_USAGE
, "--ifconfig-ipv6-pool„equires --mode server");

2369 ià(
İtiÚs
->
»®_hash_size
 !ğ
deçuÉs
.real_hash_size

2370 || 
İtiÚs
->
vœtu®_hash_size
 !ğ
deçuÉs
.virtual_hash_size)

2372 
	`msg
(
M_USAGE
, "--hash-size„equires --mode server");

2374 ià(
İtiÚs
->
Ë¬n_add»ss_süt
)

2376 
	`msg
(
M_USAGE
, "--learn-address„equires --mode server");

2378 ià(
İtiÚs
->
ş›Á_cÚÃù_süt
)

2380 
	`msg
(
M_USAGE
, "--client-connect„equires --mode server");

2382 ià(
İtiÚs
->
ş›Á_discÚÃù_süt
)

2384 
	`msg
(
M_USAGE
, "--client-disconnect„equires --mode server");

2386 ià(
İtiÚs
->
ş›Á_cÚfig_dœ
 || o±iÚs->
ccd_exşusive
)

2388 
	`msg
(
M_USAGE
, "--client-config-dir/--ccd-exclusive„equires --mode server");

2390 ià(
İtiÚs
->
’abË_c2c
)

2392 
	`msg
(
M_USAGE
, "--client-to-client„equires --mode server");

2394 ià(
İtiÚs
->
du¶iÿ‹_ú
)

2396 
	`msg
(
M_USAGE
, "--duplicate-cn„equires --mode server");

2398 ià(
İtiÚs
->
cf_max
 || o±iÚs->
cf_³r
)

2400 
	`msg
(
M_USAGE
, "--connect-freq„equires --mode server");

2402 ià(
İtiÚs
->
s¦_æags
 & (
SSLF_CLIENT_CERT_NOT_REQUIRED
|
SSLF_CLIENT_CERT_OPTIONAL
))

2404 
	`msg
(
M_USAGE
, "--client-cert-not-required‡nd --verify-client-cert„equire --mode server");

2406 ià(
İtiÚs
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
)

2408 
	`msg
(
M_USAGE
, "--username-as-common-name„equires --mode server");

2410 ià(
İtiÚs
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
)

2412 
	`msg
(
M_USAGE
, "--auth-user-pass-optional„equires --mode server");

2414 ià(
İtiÚs
->
s¦_æags
 & 
SSLF_OPT_VERIFY
)

2416 
	`msg
(
M_USAGE
, "--opt-verify„equires --mode server");

2418 ià(
İtiÚs
->
£rv”_æags
 & 
SF_TCP_NODELAY_HELPER
)

2420 
	`msg
(
M_WARN
, "WARNING: settingcp-nodelay onhe client side will‚ot "

2424 ià(
İtiÚs
->
auth_u£r_·ss_v”ify_süt
)

2426 
	`msg
(
M_USAGE
, "--auth-user-pass-verify„equires --mode server");

2428 ià(
İtiÚs
->
auth_tok’_g’”©e
)

2430 
	`msg
(
M_USAGE
, "--auth-gen-token„equires --mode server");

2432 #ià
PORT_SHARE


2433 ià(
İtiÚs
->
pÜt_sh¬e_ho¡
 || o±iÚs->
pÜt_sh¬e_pÜt
)

2435 
	`msg
(
M_USAGE
, "--port-share„equires TCP server mode (--mode server --protocp-server)");

2439 ià(
İtiÚs
->
¡®e_rou‹s_check_š‹rv®
)

2441 
	`msg
(
M_USAGE
, "--stale-routes-check„equires --mode server");

2443 ià(
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NO_NAME_REMAPPING
))

2445 
	`msg
(
M_USAGE
, "--compat-x509-names‚o-remapping„equires --mode server");

2450 #ifdeà
ENABLE_CRYPTO


2452 ià(
İtiÚs
->
nı_’abËd
 && !
	`s_check_nı_ch”_li¡
(İtiÚs->
nı_ch”s
))

2454 
	`msg
(
M_USAGE
, "NCP cipher†ist contains unsupported ciphers.");

2456 ià(
İtiÚs
->
nı_’abËd
 && !İtiÚs->
u£_iv
)

2458 
	`msg
(
M_USAGE
, "--no-iv‚ot‡llowed when NCP isƒnabled.");

2460 ià(!
İtiÚs
->
u£_iv
)

2462 
	`msg
(
M_WARN
, "WARNING: --no-iv is deprecated‡nd will be„emoved in 2.5");

2465 ià(
İtiÚs
->
keysize
)

2467 
	`msg
(
M_WARN
, "WARNING: --keysize is DEPRECATED‡nd will be„emoved in OpenVPN 2.6");

2470 ià(!
İtiÚs
->
»¶ay
)

2472 
	`msg
(
M_WARN
, "WARNING: --no-replay is DEPRECATED‡nd will be„emoved in OpenVPN 2.5");

2478 ià(!
İtiÚs
->
»¶ay


2479 && (
İtiÚs
->
»¶ay_wšdow
 !ğ
deçuÉs
.replay_window

2480 || 
İtiÚs
->
»¶ay_time
 !ğ
deçuÉs
.replay_time))

2482 
	`msg
(
M_USAGE
, "--replay-window doesn't make sense when„eplay…rotection is disabled with --no-replay");

2488 ià(
İtiÚs
->
s_£rv”
 + o±iÚs->
s_ş›Á


2489 +(
İtiÚs
->
sh¬ed_£ü‘_fe
 !ğ
NULL
) > 1)

2491 
	`msg
(
M_USAGE
, "specify only one of --tls-server, --tls-client, or --secret");

2494 ià(
İtiÚs
->
s¦_æags
 & (
SSLF_CLIENT_CERT_NOT_REQUIRED
|
SSLF_CLIENT_CERT_OPTIONAL
))

2496 
	`msg
(
M_WARN
, "WARNING: POTENTIALLY DANGEROUS OPTION "

2501 ià(
İtiÚs
->
key_m‘hod
 == 1)

2503 
	`msg
(
M_WARN
, "WARNING: --key-method 1 is deprecated‡nd will be„emoved "

2508 cÚ¡ 
s_v”siÚ_max
 =

2509 (
İtiÚs
->
s¦_æags
 >> 
SSLF_TLS_VERSION_MAX_SHIFT
)

2510 & 
SSLF_TLS_VERSION_MAX_MASK
;

2511 cÚ¡ 
s_v”siÚ_mš
 =

2512 (
İtiÚs
->
s¦_æags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
)

2513 & 
SSLF_TLS_VERSION_MIN_MASK
;

2515 ià(
s_v”siÚ_max
 > 0 &&ls_v”siÚ_max < 
s_v”siÚ_mš
)

2517 
	`msg
(
M_USAGE
, "--tls-version-min biggerhan --tls-version-max");

2520 ià(
İtiÚs
->
s_£rv”
 || o±iÚs->
s_ş›Á
)

2522 #ifdeà
ENABLE_PKCS11


2523 ià(
İtiÚs
->
pkcs11_´ovid”s
[0])

2525 
	`nÙnuÎ
(
İtiÚs
->
ÿ_fe
, "CA file (--ca)");

2527 ià(
İtiÚs
->
pkcs11_id_mªagem’t
 && o±iÚs->
pkcs11_id
 !ğ
NULL
)

2529 
	`msg
(
M_USAGE
, "Parameter --pkcs11-id cannot be used when --pkcs11-id-management is‡lso specified.");

2531 ià(!
İtiÚs
->
pkcs11_id_mªagem’t
 && o±iÚs->
pkcs11_id
 =ğ
NULL
)

2533 
	`msg
(
M_USAGE
, "Parameter --pkcs11-id or --pkcs11-id-management should be specified.");

2535 ià(
İtiÚs
->
û¹_fe
)

2537 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --pkcs11-provider is‡lso specified.");

2539 ià(
İtiÚs
->
´iv_key_fe
)

2541 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --pkcs11-provider is‡lso specified.");

2543 #ifdeà
MANAGMENT_EXTERNAL_KEY


2544 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
)

2546 
	`msg
(
M_USAGE
, "Parameter --management-external-key cannot be used when --pkcs11-provider is‡lso specified.");

2548 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
)

2550 
	`msg
(
M_USAGE
, "Parameter --management-external-cert cannot be used when --pkcs11-provider is‡lso specified.");

2553 ià(
İtiÚs
->
pkcs12_fe
)

2555 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used when --pkcs11-provider is‡lso specified.");

2557 #ifdeà
ENABLE_CRYPTOAPI


2558 ià(
İtiÚs
->
üy±ßpi_û¹
)

2560 
	`msg
(
M_USAGE
, "Parameter --cryptoapicert cannot be used when --pkcs11-provider is‡lso specified.");

2566 #ifdeà
MANAGMENT_EXTERNAL_KEY


2567 ià((
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
è&& o±iÚs->
´iv_key_fe
)

2569 
	`msg
(
M_USAGE
, "--key‡nd --management-external-key‡re mutuallyƒxclusive");

2571 ià((
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
))

2573 ià(
İtiÚs
->
û¹_fe
)

2575 
	`msg
(
M_USAGE
, "--cert‡nd --management-external-cert‡re mutuallyƒxclusive");

2577 ià(!(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
))

2579 
	`msg
(
M_USAGE
, "--management-external-cert must be used with --management-external-key");

2584 #ifdeà
ENABLE_CRYPTOAPI


2585 ià(
İtiÚs
->
üy±ßpi_û¹
)

2587 ià((!(
İtiÚs
->
ÿ_fe
)è&& (!(İtiÚs->
ÿ_·th
)))

2589 
	`msg
(
M_USAGE
, "You must define CA file (--ca) or CA…ath (--capath)");

2591 ià(
İtiÚs
->
û¹_fe
)

2593 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --cryptoapicert is‡lso specified.");

2595 ià(
İtiÚs
->
´iv_key_fe
)

2597 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --cryptoapicert is‡lso specified.");

2599 ià(
İtiÚs
->
pkcs12_fe
)

2601 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used when --cryptoapicert is‡lso specified.");

2603 #ifdeà
MANAGMENT_EXTERNAL_KEY


2604 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
)

2606 
	`msg
(
M_USAGE
, "Parameter --management-external-key cannot be used when --cryptoapicert is‡lso specified.");

2608 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
)

2610 
	`msg
(
M_USAGE
, "Parameter --management-external-cert cannot be used when --cryptoapicert is‡lso specified.");

2616 ià(
İtiÚs
->
pkcs12_fe
)

2618 #ifdeà
ENABLE_CRYPTO_MBEDTLS


2619 
	`msg
(
M_USAGE
, "Parameter --pkcs12 cannot be used withhe mbed TLS version version of OpenVPN.");

2621 ià(
İtiÚs
->
ÿ_·th
)

2623 
	`msg
(
M_USAGE
, "Parameter --capath cannot be used when --pkcs12 is‡lso specified.");

2625 ià(
İtiÚs
->
û¹_fe
)

2627 
	`msg
(
M_USAGE
, "Parameter --cert cannot be used when --pkcs12 is‡lso specified.");

2629 ià(
İtiÚs
->
´iv_key_fe
)

2631 
	`msg
(
M_USAGE
, "Parameter --key cannot be used when --pkcs12 is‡lso specified.");

2633 #ifdeà
MANAGMENT_EXTERNAL_KEY


2634 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
)

2636 
	`msg
(
M_USAGE
, "Parameter --management-external-key cannot be used when --pkcs12 is‡lso specified.");

2638 ià(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
)

2640 
	`msg
(
M_USAGE
, "Parameter --management-external-cert cannot be used when --pkcs12 is‡lso specified.");

2647 #ifdeà
ENABLE_CRYPTO_MBEDTLS


2648 ià(!(
İtiÚs
->
ÿ_fe
))

2650 
	`msg
(
M_USAGE
, "You must define CA file (--ca)");

2652 ià(
İtiÚs
->
ÿ_·th
)

2654 
	`msg
(
M_USAGE
, "Parameter --capath cannot be used withhe mbed TLS version version of OpenVPN.");

2657 ià((!(
İtiÚs
->
ÿ_fe
)è&& (!(İtiÚs->
ÿ_·th
)))

2659 
	`msg
(
M_USAGE
, "You must define CA file (--ca) or CA…ath (--capath)");

2662 ià(
puÎ
)

2665 cÚ¡ 
sum
 =

2666 #ifdeà
MANAGMENT_EXTERNAL_KEY


2667 ((
İtiÚs
->
û¹_fe
 !ğ
NULL
è|| (İtiÚs->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
))

2668 +((
İtiÚs
->
´iv_key_fe
 !ğ
NULL
è|| (İtiÚs->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
));

2670 (
İtiÚs
->
û¹_fe
 !ğ
NULL
è+ (İtiÚs->
´iv_key_fe
 != NULL);

2673 ià(
sum
 == 0)

2675 #ià
P2MP


2676 ià(!
İtiÚs
->
auth_u£r_·ss_fe
)

2678 
	`msg
(
M_USAGE
, "No client-side‡uthentication method is specified. You must useƒither --cert/--key, --pkcs12, or --auth-user-pass");

2680 ià(
sum
 == 2)

2685 
	`msg
(
M_USAGE
, "If you use one of --cert or --key, you must usehem both");

2690 #ifdeà
MANAGMENT_EXTERNAL_KEY


2691 ià(!(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
))

2693 
	`nÙnuÎ
(
İtiÚs
->
û¹_fe
, "certificate file (--cert) or PKCS#12 file (--pkcs12)");

2694 #ifdeà
MANAGMENT_EXTERNAL_KEY


2695 ià(!(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
))

2697 
	`nÙnuÎ
(
İtiÚs
->
´iv_key_fe
, "private key file (--key) or PKCS#12 file (--pkcs12)");

2700 ià(
İtiÚs
->
s_auth_fe
 && o±iÚs->
s_üy±_fe
)

2702 
	`msg
(
M_USAGE
, "--tls-auth‡nd --tls-crypt‡re mutuallyƒxclusive");

2712 
	#MUST_BE_UNDEF
(
·rm
èià(
İtiÚs
->·rm !ğ
deçuÉs
.·rmè{
	`msg
(
M_USAGE
, 
”r
, #parm); \

2713 }

	)

2715 cÚ¡ 
”r
[] = "Parameter %s can only be specified in TLS-mode, i.e. where --tls-server or --tls-client is‡lso specified.";

2717 
	`MUST_BE_UNDEF
(
ÿ_fe
);

2718 
	`MUST_BE_UNDEF
(
ÿ_·th
);

2719 
	`MUST_BE_UNDEF
(
dh_fe
);

2720 
	`MUST_BE_UNDEF
(
û¹_fe
);

2721 
	`MUST_BE_UNDEF
(
´iv_key_fe
);

2722 #iâdeà
ENABLE_CRYPTO_MBEDTLS


2723 
	`MUST_BE_UNDEF
(
pkcs12_fe
);

2725 
	`MUST_BE_UNDEF
(
ch”_li¡
);

2726 
	`MUST_BE_UNDEF
(
ch”_li¡_s13
);

2727 
	`MUST_BE_UNDEF
(
s_û¹_´ofe
);

2728 
	`MUST_BE_UNDEF
(
s_v”ify
);

2729 
	`MUST_BE_UNDEF
(
s_expÜt_û¹
);

2730 
	`MUST_BE_UNDEF
(
v”ify_x509_Çme
);

2731 
	`MUST_BE_UNDEF
(
s_timeout
);

2732 
	`MUST_BE_UNDEF
(
»ÃgÙŸ‹_by‹s
);

2733 
	`MUST_BE_UNDEF
(
»ÃgÙŸ‹_·ck‘s
);

2734 
	`MUST_BE_UNDEF
(
»ÃgÙŸ‹_£cÚds
);

2735 
	`MUST_BE_UNDEF
(
hªdshake_wšdow
);

2736 
	`MUST_BE_UNDEF
(
Œªs™iÚ_wšdow
);

2737 
	`MUST_BE_UNDEF
(
s_auth_fe
);

2738 
	`MUST_BE_UNDEF
(
s_üy±_fe
);

2739 
	`MUST_BE_UNDEF
(
sšgË_£ssiÚ
);

2740 #ifdeà
ENABLE_PUSH_PEER_INFO


2741 
	`MUST_BE_UNDEF
(
push_³”_šfo
);

2743 
	`MUST_BE_UNDEF
(
s_ex™
);

2744 
	`MUST_BE_UNDEF
(
ül_fe
);

2745 
	`MUST_BE_UNDEF
(
key_m‘hod
);

2746 
	`MUST_BE_UNDEF
(
ns_û¹_ty³
);

2747 
	`MUST_BE_UNDEF
(
»mÙe_û¹_ku
[0]);

2748 
	`MUST_BE_UNDEF
(
»mÙe_û¹_eku
);

2749 #ifdeà
ENABLE_PKCS11


2750 
	`MUST_BE_UNDEF
(
pkcs11_´ovid”s
[0]);

2751 
	`MUST_BE_UNDEF
(
pkcs11_´iv©e_mode
[0]);

2752 
	`MUST_BE_UNDEF
(
pkcs11_id
);

2753 
	`MUST_BE_UNDEF
(
pkcs11_id_mªagem’t
);

2756 ià(
puÎ
)

2758 
	`msg
(
M_USAGE
, 
”r
, "--pull");

2761 #undeà
MUST_BE_UNDEF


2764 #ià
P2MP


2765 ià(
İtiÚs
->
auth_u£r_·ss_fe
 && !İtiÚs->
puÎ
)

2767 
	`msg
(
M_USAGE
, "--auth-user-pass„equires --pull");

2771 
	`unš™_İtiÚs
(&
deçuÉs
);

2772 
	}
}

2775 
	$İtiÚs_po¡´oûss_mu‹_û
(
İtiÚs
 *
o
, 
cÚÃùiÚ_’Œy
 *
û
)

2777 cÚ¡ 
dev
 = 
	`dev_ty³_’um
(
o
->dev, o->
dev_ty³
);

2779 #ià
P2MP_SERVER


2780 ià(
o
->
£rv”_defšed
 || o->
£rv”_bridge_defšed
 || o->
£rv”_bridge_´oxy_dhı
)

2782 ià(
û
->
´Ùo
 =ğ
PROTO_TCP
)

2784 
û
->
´Ùo
 = 
PROTO_TCP_SERVER
;

2788 #ià
P2MP


2789 ià(
o
->
ş›Á
)

2791 ià(
û
->
´Ùo
 =ğ
PROTO_TCP
)

2793 
û
->
´Ùo
 = 
PROTO_TCP_CLIENT
;

2798 ià(
û
->
´Ùo
 =ğ
PROTO_TCP_CLIENT
 && !û->
loÿl
 && !û->
loÿl_pÜt_defšed
 && !û->
bšd_defšed
)

2800 
û
->
bšd_loÿl
 = 
çl£
;

2803 ià(
û
->
´Ùo
 =ğ
PROTO_UDP
 && ce->
socks_´oxy_£rv”
 && !û->
loÿl
 && !û->
loÿl_pÜt_defšed
 && !û->
bšd_defšed
)

2805 
û
->
bšd_loÿl
 = 
çl£
;

2808 ià(!
û
->
bšd_loÿl
)

2810 
û
->
loÿl_pÜt
 = 
NULL
;

2814 ià(
o
->
´Ùo_fÜû
 >ğ0 && o->´Ùo_fÜû !ğ
û
->
´Ùo
)

2816 
û
->
æags
 |ğ
CE_DISABLED
;

2823 ià(
o
->
û
.
mssfix_deçuÉ
)

2825 #ifdeà
ENABLE_FRAGMENT


2826 ià(
û
->
äagm’t
)

2828 
û
->
mssfix
 = ce->
äagm’t
;

2831 
	`msg
(
M_USAGE
, "--mssfix must specify‡…arameter");

2839 ià(!
û
->
tun_mtu_defšed
 && !û->
lšk_mtu_defšed
)

2841 
û
->
tun_mtu_defšed
 = 
Œue
;

2843 ià((
dev
 =ğ
DEV_TYPE_TAP
è&& !
û
->
tun_mtu_exŒa_defšed
)

2845 
û
->
tun_mtu_exŒa_defšed
 = 
Œue
;

2846 
û
->
tun_mtu_exŒa
 = 
TAP_MTU_EXTRA_DEFAULT
;

2850 
	}
}

2852 #ifdeà
_WIN32


2855 
	$»m­_»dœeù_g©eway_æags
(
İtiÚs
 *
İt
)

2857 ià(
İt
->
rou‹s


2858 && 
İt
->
rou‹_m‘hod
 =ğ
ROUTE_METHOD_SERVICE


2859 && 
İt
->
rou‹s
->
æags
 & 
RG_REROUTE_GW


2860 && !(
İt
->
rou‹s
->
æags
 & 
RG_DEF1
))

2862 
	`msg
(
M_INFO
, "Flag 'def1'‡ddedo --redirect-gateway (iservice is in use)");

2863 
İt
->
rou‹s
->
æags
 |ğ
RG_DEF1
;

2865 
	}
}

2869 
	$İtiÚs_po¡´oûss_mu‹_šv¬ŸÁ
(
İtiÚs
 *options)

2871 #ifdeà
_WIN32


2872 cÚ¡ 
dev
 = 
	`dev_ty³_’um
(
İtiÚs
->dev, o±iÚs->
dev_ty³
);

2879 ià(
İtiÚs
->
š‘d
 =ğ
INETD_NOWAIT
)

2881 
İtiÚs
->
ifcÚfig_nÛxec
 = 
Œue
;

2884 #ifdeà
_WIN32


2885 ià((
dev
 =ğ
DEV_TYPE_TUN
 || dev =ğ
DEV_TYPE_TAP
è&& !
İtiÚs
->
rou‹_d–ay_defšed
)

2887 ià(
İtiÚs
->
mode
 =ğ
MODE_POINT_TO_POINT
)

2889 
İtiÚs
->
rou‹_d–ay_defšed
 = 
Œue
;

2890 
İtiÚs
->
rou‹_d–ay
 = 5;

2894 ià(
İtiÚs
->
ifcÚfig_nÛxec
)

2896 
İtiÚs
->
tuÁ­_İtiÚs
.
_wš32_ty³
 = 
IPW32_SET_MANUAL
;

2897 
İtiÚs
->
ifcÚfig_nÛxec
 = 
çl£
;

2900 
	`»m­_»dœeù_g©eway_æags
(
İtiÚs
);

2903 #ià
P2MP_SERVER


2907 ià(
İtiÚs
->
mode
 =ğ
MODE_SERVER
)

2909 #ifdeà
_WIN32


2914 
İtiÚs
->
tuÁ­_İtiÚs
.
p_¦“p
 = 10;

2915 ià(
İtiÚs
->
rou‹_d–ay_defšed
 && o±iÚs->
rou‹_d–ay
)

2917 
İtiÚs
->
tuÁ­_İtiÚs
.
p_¦“p
 = o±iÚs->
rou‹_d–ay
;

2919 
İtiÚs
->
rou‹_d–ay_defšed
 = 
çl£
;

2924 #ifdeà
DEFAULT_PKCS11_MODULE


2928 ià(!
İtiÚs
->
pkcs11_´ovid”s
[0]

2929 && (
İtiÚs
->
pkcs11_id
 || o±iÚs->
pkcs11_id_mªagem’t
))

2931 
İtiÚs
->
pkcs11_´ovid”s
[0] = 
DEFAULT_PKCS11_MODULE
;

2934 
	}
}

2937 
	$İtiÚs_po¡´oûss_v”ify
(cÚ¡ 
İtiÚs
 *
o
)

2939 ià(
o
->
cÚÃùiÚ_li¡
)

2941 
i
;

2942 
i
 = 0; i < 
o
->
cÚÃùiÚ_li¡
->
Ën
; ++i)

2944 
	`İtiÚs_po¡´oûss_v”ify_û
(
o
, o->
cÚÃùiÚ_li¡
->
¬¿y
[
i
]);

2949 
	`İtiÚs_po¡´oûss_v”ify_û
(
o
, &o->
û
);

2951 
	}
}

2954 
	$İtiÚs_po¡´oûss_mu‹
(
İtiÚs
 *
o
)

2956 
i
;

2961 
	`h–³r_ş›Á_£rv”
(
o
);

2962 
	`h–³r_k“·live
(
o
);

2963 
	`h–³r_tı_nod–ay
(
o
);

2965 
	`İtiÚs_po¡´oûss_mu‹_šv¬ŸÁ
(
o
);

2967 ià(
o
->
»mÙe_li¡
 && !o->
cÚÃùiÚ_li¡
)

2972 cÚ¡ 
»mÙe_li¡
 *
¾
 = 
o
->remote_list;

2973 
i
 = 0; i < 
¾
->
Ën
; ++i)

2975 cÚ¡ 
»mÙe_’Œy
 *
»
 = 
¾
->
¬¿y
[
i
];

2976 
cÚÃùiÚ_’Œy
 
û
 = 
o
->ce;

2977 
cÚÃùiÚ_’Œy
 *
aû
;

2979 
	`ASSERT
(
»
->
»mÙe
);

2980 
	`cÚÃùiÚ_’Œy_lßd_»
(&
û
, 
»
);

2981 
aû
 = 
	`®loc_cÚÃùiÚ_’Œy
(
o
, 
M_USAGE
);

2982 
	`ASSERT
(
aû
);

2983 *
aû
 = 
û
;

2986 ià(!
o
->
»mÙe_li¡
 && !o->
cÚÃùiÚ_li¡
)

2988 
cÚÃùiÚ_’Œy
 *
aû
;

2989 
aû
 = 
	`®loc_cÚÃùiÚ_’Œy
(
o
, 
M_USAGE
);

2990 
	`ASSERT
(
aû
);

2991 *
aû
 = 
o
->
û
;

2994 
	`ASSERT
(
o
->
cÚÃùiÚ_li¡
);

2995 
i
 = 0; i < 
o
->
cÚÃùiÚ_li¡
->
Ën
; ++i)

2997 
	`İtiÚs_po¡´oûss_mu‹_û
(
o
, o->
cÚÃùiÚ_li¡
->
¬¿y
[
i
]);

3000 #ifdeà
ENABLE_CRYPTO


3001 ià(
o
->
s_£rv”
)

3004 
	`nÙnuÎ
(
o
->
dh_fe
, "DH file (--dh)");

3005 ià(
	`¡»q
(
o
->
dh_fe
, "none"))

3007 
o
->
dh_fe
 = 
NULL
;

3010 ià(
o
->
dh_fe
)

3013 
	`msg
(
M_WARN
, "WARNING: Ignoring option 'dh' inls-client mode,…lease only "

3015 
o
->
dh_fe
 = 
NULL
;

3019 ià(
o
->
nı_’abËd


3020 && !(
o
->
puÎ
 || o->
mode
 =ğ
MODE_SERVER
) )

3022 
	`msg
Ğ
M_WARN
, "disabling NCP mode (--ncp-disable) because‚ot "

3024 
o
->
nı_’abËd
 = 
çl£
;

3028 #ià
ENABLE_MANAGEMENT


3029 ià(
o
->
h‰p_´oxy_ov”ride
)

3031 
	`İtiÚs_po¡´oûss_h‰p_´oxy_ov”ride
(
o
);

3035 #ià
P2MP


3039 
	`´e_puÎ_§ve
(
o
);

3041 
	}
}

3047 #iâdeà
ENABLE_SMALL


3049 
	#CHKACC_FILE
 (1<<0è

	)

3050 
	#CHKACC_DIRPATH
 (1<<1è

	)

3051 
	#CHKACC_FILEXSTWR
 (1<<2è

	)

3052 
	#CHKACC_INLINE
 (1<<3è

	)

3053 
	#CHKACC_ACPTSTDIN
 (1<<4è

	)

3054 
	#CHKACC_PRIVATE
 (1<<5è

	)

3056 
boŞ


3057 
	$check_fe_acûss
(cÚ¡ 
ty³
, cÚ¡ *
fe
, cÚ¡ 
mode
, cÚ¡ *
İt
)

3059 
”rcode
 = 0;

3062 ià(!
fe
)

3064  
çl£
;

3068 ià((
ty³
 & 
CHKACC_INLINE
è&& 
	`¡»q
(
fe
, 
INLINE_FILE_TAG
) )

3070  
çl£
;

3076 iàĞ(
ty³
 & 
CHKACC_ACPTSTDIN
è&& 
	`¡»q
(
fe
, "stdin") )

3078  
çl£
;

3082 ià(
ty³
 & 
CHKACC_DIRPATH
)

3084 *
fuÎ·th
 = 
	`¡ršg_®loc
(
fe
, 
NULL
);

3085 *
dœ·th
 = 
	`dœÇme
(
fuÎ·th
);

3087 ià(
	`¶©fÜm_acûss
(
dœ·th
, 
mode
|
X_OK
) != 0)

3089 
”rcode
 = 
”ºo
;

3091 
	`ä“
(
fuÎ·th
);

3095 ià(!
”rcode
 && (
ty³
 & 
CHKACC_FILE
è&& (
	`¶©fÜm_acûss
(
fe
, 
mode
) != 0) )

3097 
”rcode
 = 
”ºo
;

3101 ià(!
”rcode
 && (
ty³
 & 
CHKACC_FILEXSTWR
è&& (
	`¶©fÜm_acûss
(
fe
, 
F_OK
) == 0) )

3103 ià(
	`¶©fÜm_acûss
(
fe
, 
W_OK
) != 0)

3105 
”rcode
 = 
”ºo
;

3110 ià(
ty³
 & 
CHKACC_PRIVATE
)

3112 
¶©fÜm_¡©_t
 
¡
;

3113 ià(
	`¶©fÜm_¡©
(
fe
, &
¡
))

3115 
	`msg
(
M_WARN
 | 
M_ERRNO
, "WARNING: cªnÙ sˆf'%s'", 
fe
);

3117 #iâdeà
_WIN32


3120 ià(
¡
.
¡_mode
 & (
S_IRWXG
|
S_IRWXO
))

3122 
	`msg
(
M_WARN
, "WARNING: f'%s' i grou°Ü oth” acûssibË", 
fe
);

3129 ià(
”rcode
 > 0)

3131 
	`msg
(
M_NOPREFIX
 | 
M_OPTERR
 | 
M_ERRNO
, "% ç w™h '%s'", 
İt
, 
fe
);

3135  (
”rcode
 !ğ0 ? 
Œue
 : 
çl£
);

3136 
	}
}

3142 
boŞ


3143 
	$check_fe_acûss_chroÙ
(cÚ¡ *
chroÙ
, cÚ¡ 
ty³
, cÚ¡ *
fe
, cÚ¡ 
mode
, cÚ¡ *
İt
)

3145 
boŞ
 
»t
 = 
çl£
;

3148 ià(!
fe
)

3150  
çl£
;

3154 ià(
chroÙ
)

3156 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3157 
bufãr
 
chroÙ_fe
;

3158 
Ën
 = 0;

3161 
Ën
 = 
	`¡¾’
(
chroÙ
è+ sŒËn(
PATH_SEPARATOR_STR
è+ sŒËn(
fe
) + 1;

3162 
chroÙ_fe
 = 
	`®loc_buf_gc
(
Ën
, &
gc
);

3163 
	`buf_´štf
(&
chroÙ_fe
, "%s%s%s", 
chroÙ
, 
PATH_SEPARATOR_STR
, 
fe
);

3164 
	`ASSERT
(
chroÙ_fe
.
Ën
 > 0);

3166 
»t
 = 
	`check_fe_acûss
(
ty³
, 
	`BSTR
(&
chroÙ_fe
), 
mode
, 
İt
);

3167 
	`gc_ä“
(&
gc
);

3172 
»t
 = 
	`check_fe_acûss
(
ty³
, 
fe
, 
mode
, 
İt
);

3174  
»t
;

3175 
	}
}

3194 
boŞ


3195 
	$check_cmd_acûss
(cÚ¡ *
commªd
, cÚ¡ *
İt
, cÚ¡ *
chroÙ
)

3197 
¬gv
‡rgv;

3198 
boŞ
 
»tuº_code
;

3201 ià(!
commªd
)

3203  
çl£
;

3207 
¬gv
 = 
	`¬gv_Ãw
();

3208 
	`¬gv_·r£_cmd
(&
¬gv
, 
commªd
);

3211 ià(
¬gv
.argv[0])

3217 
»tuº_code
 = 
	`check_fe_acûss_chroÙ
(
chroÙ
, 
CHKACC_FILE
, 
¬gv
.¬gv[0], 
X_OK
, 
İt
);

3221 
	`msg
(
M_NOPREFIX
|
M_OPTERR
, "%s fails with '%s': No…athoƒxecutable.",

3222 
İt
, 
commªd
);

3223 
»tuº_code
 = 
Œue
;

3226 
	`¬gv_»£t
(&
¬gv
);

3228  
»tuº_code
;

3229 
	}
}

3236 
	$İtiÚs_po¡´oûss_fechecks
(
İtiÚs
 *options)

3238 
boŞ
 
”rs
 = 
çl£
;

3240 #ifdeà
ENABLE_CRYPTO


3242 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
, 
İtiÚs
->
dh_fe
, 
R_OK
, "--dh");

3243 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
, 
İtiÚs
->
ÿ_fe
, 
R_OK
, "--ca");

3244 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
, o±iÚs->
ÿ_·th
, 
R_OK
, "--capath");

3245 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
, 
İtiÚs
->
û¹_fe
, 
R_OK
, "--cert");

3246 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
, 
İtiÚs
->
exŒa_û¹s_fe
, 
R_OK
,

3248 #ifdeà
MANAGMENT_EXTERNAL_KEY


3249 ià(!(
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
))

3252 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
|
CHKACC_PRIVATE
,

3253 
İtiÚs
->
´iv_key_fe
, 
R_OK
, "--key");

3255 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
|
CHKACC_PRIVATE
,

3256 
İtiÚs
->
pkcs12_fe
, 
R_OK
, "--pkcs12");

3258 ià(
İtiÚs
->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
)

3260 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
, o±iÚs->
ül_fe
, 
R_OK
|
X_OK
,

3265 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
|
CHKACC_INLINE
,

3266 
İtiÚs
->
ül_fe
, 
R_OK
, "--crl-verify");

3269 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
|
CHKACC_PRIVATE
,

3270 
İtiÚs
->
s_auth_fe
, 
R_OK
, "--tls-auth");

3271 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
|
CHKACC_PRIVATE
,

3272 
İtiÚs
->
s_üy±_fe
, 
R_OK
, "--tls-crypt");

3273 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_INLINE
|
CHKACC_PRIVATE
,

3274 
İtiÚs
->
sh¬ed_£ü‘_fe
, 
R_OK
, "--secret");

3275 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
,

3276 
İtiÚs
->
·ck‘_id_fe
, 
R_OK
|
W_OK
, "--replay-persist");

3279 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_ACPTSTDIN
|
CHKACC_PRIVATE
,

3280 
İtiÚs
->
key_·ss_fe
, 
R_OK
, "--askpass");

3282 #ifdeà
ENABLE_MANAGEMENT


3283 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_ACPTSTDIN
|
CHKACC_PRIVATE
,

3284 
İtiÚs
->
mªagem’t_u£r_·ss
, 
R_OK
,

3287 #ià
P2MP


3288 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
|
CHKACC_ACPTSTDIN
|
CHKACC_PRIVATE
,

3289 
İtiÚs
->
auth_u£r_·ss_fe
, 
R_OK
,

3294 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_FILE
, 
İtiÚs
->
chroÙ_dœ
,

3295 
R_OK
|
X_OK
, "--chroot directory");

3296 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
, 
İtiÚs
->
wr™•id
,

3297 
R_OK
|
W_OK
, "--writepid");

3300 
”rs
 |ğ
	`check_fe_acûss
(
CHKACC_DIRPATH
|
CHKACC_FILEXSTWR
, 
İtiÚs
->
¡©us_fe
,

3301 
R_OK
|
W_OK
, "--status");

3304 #ifdeà
ENABLE_CRYPTO


3305 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
, o±iÚs->
s_expÜt_û¹
,

3306 
R_OK
|
W_OK
|
X_OK
, "--tls-export-cert");

3308 #ià
P2MP_SERVER


3309 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
, o±iÚs->
ş›Á_cÚfig_dœ
,

3310 
R_OK
|
X_OK
, "--client-config-dir");

3311 
”rs
 |ğ
	`check_fe_acûss_chroÙ
(
İtiÚs
->
chroÙ_dœ
, 
CHKACC_FILE
, o±iÚs->
tmp_dœ
,

3312 
R_OK
|
W_OK
|
X_OK
, "Temporary directory (--tmp-dir)");

3316 ià(
”rs
)

3318 
	`msg
(
M_USAGE
, "Please correctheseƒrrors.");

3320 
	}
}

3329 
	$İtiÚs_po¡´oûss
(
İtiÚs
 *options)

3331 
	`İtiÚs_po¡´oûss_mu‹
(
İtiÚs
);

3332 
	`İtiÚs_po¡´oûss_v”ify
(
İtiÚs
);

3333 #iâdeà
ENABLE_SMALL


3334 
	`İtiÚs_po¡´oûss_fechecks
(
İtiÚs
);

3336 
	}
}

3338 #ià
P2MP


3345 
	$´e_puÎ_§ve
(
İtiÚs
 *
o
)

3347 ià(
o
->
puÎ
)

3349 
	`ALLOC_OBJ_CLEAR_GC
(
o
->
´e_puÎ
, 
İtiÚs_´e_puÎ
, &o->
gc
);

3350 
o
->
´e_puÎ
->
tuÁ­_İtiÚs
 = o->tuntap_options;

3351 
o
->
´e_puÎ
->
tuÁ­_İtiÚs_defšed
 = 
Œue
;

3352 
o
->
´e_puÎ
->
fÜeign_İtiÚ_šdex
 = o->foreign_option_index;

3353 ià(
o
->
rou‹s
)

3355 
o
->
´e_puÎ
->
rou‹s
 = 
	`şÚe_rou‹_İtiÚ_li¡
(o->rou‹s, &o->
gc
);

3356 
o
->
´e_puÎ
->
rou‹s_defšed
 = 
Œue
;

3358 ià(
o
->
rou‹s_v6
)

3360 
o
->
´e_puÎ
->
rou‹s_v6
 = 
	`şÚe_rou‹_v6_İtiÚ_li¡
(o->rou‹s_v6, &o->
gc
);

3361 
o
->
´e_puÎ
->
rou‹s_v6_defšed
 = 
Œue
;

3363 ià(
o
->
ş›Á_Çt
)

3365 
o
->
´e_puÎ
->
ş›Á_Çt
 = 
	`şÚe_ş›Á_Çt_İtiÚ_li¡
(o->ş›Á_Çt, &o->
gc
);

3366 
o
->
´e_puÎ
->
ş›Á_Çt_defšed
 = 
Œue
;

3369 
	}
}

3372 
	$´e_puÎ_»¡Üe
(
İtiÚs
 *
o
, 
gc_¬’a
 *
gc
)

3374 cÚ¡ 
İtiÚs_´e_puÎ
 *
µ
 = 
o
->
´e_puÎ
;

3375 ià(
µ
)

3377 
	`CLEAR
(
o
->
tuÁ­_İtiÚs
);

3378 ià(
µ
->
tuÁ­_İtiÚs_defšed
)

3380 
o
->
tuÁ­_İtiÚs
 = 
µ
->tuntap_options;

3383 ià(
µ
->
rou‹s_defšed
)

3385 
	`rŞ_check_®loc
(
o
);

3386 
	`cİy_rou‹_İtiÚ_li¡
(
o
->
rou‹s
, 
µ
->rou‹s, 
gc
);

3390 
o
->
rou‹s
 = 
NULL
;

3393 ià(
µ
->
rou‹s_v6_defšed
)

3395 
	`rŞ6_check_®loc
(
o
);

3396 
	`cİy_rou‹_v6_İtiÚ_li¡
(
o
->
rou‹s_v6
, 
µ
->rou‹s_v6, 
gc
);

3400 
o
->
rou‹s_v6
 = 
NULL
;

3403 ià(
µ
->
ş›Á_Çt_defšed
)

3405 
	`úŞ_check_®loc
(
o
);

3406 
	`cİy_ş›Á_Çt_İtiÚ_li¡
(
o
->
ş›Á_Çt
, 
µ
->client_nat);

3410 
o
->
ş›Á_Çt
 = 
NULL
;

3413 
o
->
fÜeign_İtiÚ_šdex
 = 
µ
->foreign_option_index;

3416 
o
->
push_cÚtšu©iÚ
 = 0;

3417 
o
->
push_İtiÚ_ty³s_found
 = 0;

3418 
	}
}

3422 #ifdeà
ENABLE_OCC


3431 
size_t


3432 
	$ÿlc_İtiÚs_¡ršg_lšk_mtu
(cÚ¡ 
İtiÚs
 *
o
, cÚ¡ 
äame
 *frame)

3434 
size_t
 
lšk_mtu
 = 
	`EXPANDED_SIZE
(
äame
);

3435 #ifdeà
ENABLE_CRYPTO


3436 ià(
o
->
puÎ
 || o->
mode
 =ğ
MODE_SERVER
)

3438 
äame
 
çke_äame
 = *frame;

3439 
key_ty³
 
çke_kt
;

3440 
	`š™_key_ty³
(&
çke_kt
, 
o
->
ch”Çme
, o->
authÇme
, o->
keysize
, 
Œue
,

3441 
çl£
);

3442 
	`äame_»move_äom_exŒa_äame
(&
çke_äame
, 
	`üy±o_max_ov”h—d
());

3443 
	`üy±o_adju¡_äame_·¿m‘”s
(&
çke_äame
, &
çke_kt
, 
o
->
u£_iv
,

3444 
o
->
»¶ay
, 
	`ch”_kt_mode_ofb_cfb
(
çke_kt
.
ch”
));

3445 
	`äame_fš®ize
(&
çke_äame
, 
o
->
û
.
lšk_mtu_defšed
, o->û.
lšk_mtu
,

3446 
o
->
û
.
tun_mtu_defšed
, o->û.
tun_mtu
);

3447 
	`msg
(
D_MTU_DEBUG
, "%s:†šk-mtu %u -> %d", 
__func__
, (è
lšk_mtu
,

3448 
	`EXPANDED_SIZE
(&
çke_äame
));

3449 
lšk_mtu
 = 
	`EXPANDED_SIZE
(&
çke_äame
);

3452  
lšk_mtu
;

3453 
	}
}

3500 
	$İtiÚs_¡ršg
(cÚ¡ 
İtiÚs
 *
o
,

3501 cÚ¡ 
äame
 *frame,

3502 
tuÁ­
 *
‰
,

3503 
boŞ
 
»mÙe
,

3504 
gc_¬’a
 *
gc
)

3506 
bufãr
 
out
 = 
	`®loc_buf
(
OPTION_LINE_SIZE
);

3507 
boŞ
 
‰_loÿl
 = 
çl£
;

3509 
	`buf_´štf
(&
out
, "V4");

3515 
	`buf_´štf
(&
out
, ",dev-ty³ %s", 
	`dev_ty³_¡ršg
(
o
->
dev
, o->
dev_ty³
));

3516 
	`buf_´štf
(&
out
, ",lšk-mtu %u", (è
	`ÿlc_İtiÚs_¡ršg_lšk_mtu
(
o
, 
äame
));

3517 
	`buf_´štf
(&
out
, ",tun-mtu %d", 
	`PAYLOAD_SIZE
(
äame
));

3518 
	`buf_´štf
(&
out
, ",´ÙØ%s", 
	`´Ùo_»mÙe
(
o
->
û
.
´Ùo
, 
»mÙe
));

3523 ià(
o
->
ifcÚfig_v6_loÿl
 && o->
mode
 =ğ
MODE_POINT_TO_POINT
 && !
	`PULL_DEFINED
(o))

3525 
	`buf_´štf
(&
out
, ",tun-ipv6");

3532 ià(!
‰
)

3534 
‰
 = 
	`š™_tun
(
o
->
dev
,

3535 
o
->
dev_ty³
,

3536 
o
->
tİŞogy
,

3537 
o
->
ifcÚfig_loÿl
,

3538 
o
->
ifcÚfig_»mÙe_Ãtmask
,

3539 
o
->
ifcÚfig_v6_loÿl
,

3540 
o
->
ifcÚfig_v6_Ãtb™s
,

3541 
o
->
ifcÚfig_v6_»mÙe
,

3542 
NULL
,

3543 
NULL
,

3544 
çl£
,

3545 
NULL
);

3546 ià(
‰
)

3548 
‰_loÿl
 = 
Œue
;

3552 ià(
‰
 && 
o
->
mode
 =ğ
MODE_POINT_TO_POINT
 && !
	`PULL_DEFINED
(o))

3554 cÚ¡ *
ios
 = 
	`ifcÚfig_İtiÚs_¡ršg
(
‰
, 
»mÙe
, 
o
->
ifcÚfig_now¬n
, 
gc
);

3555 ià(
ios
 && 
	`¡¾’
(ios))

3557 
	`buf_´štf
(&
out
, ",ifcÚfig %s", 
ios
);

3560 ià(
‰_loÿl
)

3562 
	`ä“
(
‰
);

3563 
‰
 = 
NULL
;

3566 #ifdeà
USE_COMP


3567 ià(
o
->
comp
.
®g
 !ğ
COMP_ALG_UNDEF
)

3569 
	`buf_´štf
(&
out
, ",comp-lzo");

3573 #ifdeà
ENABLE_FRAGMENT


3574 ià(
o
->
û
.
äagm’t
)

3576 
	`buf_´štf
(&
out
, ",mtu-dynamic");

3580 #ifdeà
ENABLE_CRYPTO


3582 
	#TLS_CLIENT
 (
o
->
s_ş›Á
)

	)

3583 
	#TLS_SERVER
 (
o
->
s_£rv”
)

	)

3589 cÚ¡ *
kd
 = 
	`keydœeùiÚ2ascii
(
o
->
key_dœeùiÚ
, 
»mÙe
, 
çl£
);

3590 ià(
kd
)

3592 
	`buf_´štf
(&
out
, ",keydœ %s", 
kd
);

3599 ià(
o
->
sh¬ed_£ü‘_fe
 || 
TLS_CLIENT
 || 
TLS_SERVER
)

3601 
key_ty³
 
kt
;

3603 
	`ASSERT
((
o
->
sh¬ed_£ü‘_fe
 !ğ
NULL
)

3604 + (
TLS_CLIENT
 =ğ
Œue
)

3605 + (
TLS_SERVER
 =ğ
Œue
)

3608 
	`š™_key_ty³
(&
kt
, 
o
->
ch”Çme
, o->
authÇme
, o->
keysize
, 
Œue
,

3609 
çl£
);

3611 
	`buf_´štf
(&
out
, ",cipher %s",

3612 
	`Œª¦©e_ch”_Çme_to_İ’v²
(
	`ch”_kt_Çme
(
kt
.
ch”
)));

3613 
	`buf_´štf
(&
out
, ",auth %s", 
	`md_kt_Çme
(
kt
.
dige¡
));

3614 
	`buf_´štf
(&
out
, ",keysiz%d", 
kt
.
ch”_Ëngth
 * 8);

3615 ià(
o
->
sh¬ed_£ü‘_fe
)

3617 
	`buf_´štf
(&
out
, ",secret");

3619 ià(!
o
->
»¶ay
)

3621 
	`buf_´štf
(&
out
, ",no-replay");

3623 ià(!
o
->
u£_iv
)

3625 
	`buf_´štf
(&
out
, ",no-iv");

3628 #ifdeà
ENABLE_PREDICTION_RESISTANCE


3629 ià(
o
->
u£_´ediùiÚ_»si¡ªû
)

3631 
	`buf_´štf
(&
out
, ",use-prediction-resistance");

3640 ià(
TLS_CLIENT
 || 
TLS_SERVER
)

3642 ià(
o
->
s_auth_fe
)

3644 
	`buf_´štf
(&
out
, ",tls-auth");

3650 ià(
o
->
key_m‘hod
 > 1)

3652 
	`buf_´štf
(&
out
, ",key-m‘hod %d", 
o
->
key_m‘hod
);

3656 ià(
»mÙe
)

3658 ià(
TLS_CLIENT
)

3660 
	`buf_´štf
(&
out
, ",tls-server");

3662 ià(
TLS_SERVER
)

3664 
	`buf_´štf
(&
out
, ",tls-client");

3669 ià(
TLS_CLIENT
)

3671 
	`buf_´štf
(&
out
, ",tls-client");

3673 ià(
TLS_SERVER
)

3675 
	`buf_´štf
(&
out
, ",tls-server");

3680 #undeà
TLS_CLIENT


3681 #undeà
TLS_SERVER


3685  
	`BSTR
(&
out
);

3686 
	}
}

3695 
boŞ


3696 
	$İtiÚs_cmp_equ®
(*
aùu®
, cÚ¡ *
ex³ùed
)

3698  
	`İtiÚs_cmp_equ®_§ã
(
aùu®
, 
ex³ùed
, 
	`¡¾’
(actual) + 1);

3699 
	}
}

3702 
	$İtiÚs_w¬nšg
(*
aùu®
, cÚ¡ *
ex³ùed
)

3704 
	`İtiÚs_w¬nšg_§ã
(
aùu®
, 
ex³ùed
, 
	`¡¾’
(actual) + 1);

3705 
	}
}

3708 
	$İtiÚs_w¬nšg_exŒaù_·rm1
(cÚ¡ *
İtiÚ_¡ršg
,

3709 
gc_¬’a
 *
gc_»t
)

3711 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3712 
bufãr
 
b
 = 
	`¡ršg_®loc_buf
(
İtiÚ_¡ršg
, &
gc
);

3713 *
p
 = 
	`gc_m®loc
(
OPTION_PARM_SIZE
, 
çl£
, &
gc
);

3714 cÚ¡ *
»t
;

3716 
	`buf_·r£
(&
b
, ' ', 
p
, 
OPTION_PARM_SIZE
);

3717 
»t
 = 
	`¡ršg_®loc
(
p
, 
gc_»t
);

3718 
	`gc_ä“
(&
gc
);

3719  
»t
;

3720 
	}
}

3723 
	$İtiÚs_w¬nšg_§ã_sÿn2
(cÚ¡ 
msgËv–
,

3724 cÚ¡ 
d–im
,

3725 cÚ¡ 
boŞ
 
»pÜt_šcÚsi¡’t
,

3726 cÚ¡ *
p1
,

3727 cÚ¡ 
bufãr
 *
b2_¤c
,

3728 cÚ¡ *
b1_Çme
,

3729 cÚ¡ *
b2_Çme
)

3735 ià(
	`¡½»fix
(
p1
, "key-method ")

3736 || 
	`¡½»fix
(
p1
, "keydir ")

3737 || 
	`¡½»fix
(
p1
, "proto ")

3738 || 
	`¡½»fix
(
p1
, "tls-auth ")

3739 || 
	`¡½»fix
(
p1
, "tun-ipv6"))

3744 ià(
	`¡¾’
(
p1
) > 0)

3746 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3747 
bufãr
 
b2
 = *
b2_¤c
;

3748 cÚ¡ *
p1_´efix
 = 
	`İtiÚs_w¬nšg_exŒaù_·rm1
(
p1
, &
gc
);

3749 *
p2
 = 
	`gc_m®loc
(
OPTION_PARM_SIZE
, 
çl£
, &
gc
);

3751 
	`buf_·r£
(&
b2
, 
d–im
, 
p2
, 
OPTION_PARM_SIZE
))

3753 ià(
	`¡¾’
(
p2
))

3755 cÚ¡ *
p2_´efix
 = 
	`İtiÚs_w¬nšg_exŒaù_·rm1
(
p2
, &
gc
);

3757 ià(!
	`¡rcmp
(
p1
, 
p2
))

3759 
dÚe
;

3761 ià(!
	`¡rcmp
(
p1_´efix
, 
p2_´efix
))

3763 ià(
»pÜt_šcÚsi¡’t
)

3765 
	`msg
(
msgËv–
, "WARNING: '%s' is used inconsistently, %s='%s', %s='%s'",

3766 
	`§ã_´št
(
p1_´efix
, &
gc
),

3767 
b1_Çme
,

3768 
	`§ã_´št
(
p1
, &
gc
),

3769 
b2_Çme
,

3770 
	`§ã_´št
(
p2
, &
gc
));

3772 
dÚe
;

3777 
	`msg
(
msgËv–
, "WARNING: '%s' is…resent in %s config but missing in %s config, %s='%s'",

3778 
	`§ã_´št
(
p1_´efix
, &
gc
),

3779 
b1_Çme
,

3780 
b2_Çme
,

3781 
b1_Çme
,

3782 
	`§ã_´št
(
p1
, &
gc
));

3784 
dÚe
:

3785 
	`gc_ä“
(&
gc
);

3787 
	}
}

3790 
	$İtiÚs_w¬nšg_§ã_sÿn1
(cÚ¡ 
msgËv–
,

3791 cÚ¡ 
d–im
,

3792 cÚ¡ 
boŞ
 
»pÜt_šcÚsi¡’t
,

3793 cÚ¡ 
bufãr
 *
b1_¤c
,

3794 cÚ¡ 
bufãr
 *
b2_¤c
,

3795 cÚ¡ *
b1_Çme
,

3796 cÚ¡ *
b2_Çme
)

3798 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3799 
bufãr
 
b
 = *
b1_¤c
;

3800 *
p
 = 
	`gc_m®loc
(
OPTION_PARM_SIZE
, 
Œue
, &
gc
);

3802 
	`buf_·r£
(&
b
, 
d–im
, 
p
, 
OPTION_PARM_SIZE
))

3804 
	`İtiÚs_w¬nšg_§ã_sÿn2
(
msgËv–
, 
d–im
, 
»pÜt_šcÚsi¡’t
, 
p
, 
b2_¤c
, 
b1_Çme
, 
b2_Çme
);

3807 
	`gc_ä“
(&
gc
);

3808 
	}
}

3811 
	$İtiÚs_w¬nšg_§ã_ml
(cÚ¡ 
msgËv–
, *
aùu®
, cÚ¡ *
ex³ùed
, 
size_t
 
aùu®_n
)

3813 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3815 ià(
aùu®_n
 > 0)

3817 
bufãr
 
loÿl
 = 
	`®loc_buf_gc
(
OPTION_PARM_SIZE
 + 16, &
gc
);

3818 
bufãr
 
»mÙe
 = 
	`®loc_buf_gc
(
OPTION_PARM_SIZE
 + 16, &
gc
);

3819 
aùu®
[
aùu®_n
 - 1] = 0;

3821 
	`buf_´štf
(&
loÿl
, "v”siÚ %s", 
ex³ùed
);

3822 
	`buf_´štf
(&
»mÙe
, "v”siÚ %s", 
aùu®
);

3824 
	`İtiÚs_w¬nšg_§ã_sÿn1
(
msgËv–
, ',', 
Œue
,

3825 &
loÿl
, &
»mÙe
,

3828 
	`İtiÚs_w¬nšg_§ã_sÿn1
(
msgËv–
, ',', 
çl£
,

3829 &
»mÙe
, &
loÿl
,

3833 
	`gc_ä“
(&
gc
);

3834 
	}
}

3836 
boŞ


3837 
	$İtiÚs_cmp_equ®_§ã
(*
aùu®
, cÚ¡ *
ex³ùed
, 
size_t
 
aùu®_n
)

3839 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3840 
boŞ
 
»t
 = 
Œue
;

3842 ià(
aùu®_n
 > 0)

3844 
aùu®
[
aùu®_n
 - 1] = 0;

3845 #iâdeà
ENABLE_STRICT_OPTIONS_CHECK


3846 ià(
	`¡ºcmp
(
aùu®
, 
ex³ùed
, 2))

3848 
	`msg
(
D_SHOW_OCC
, "NOTE: Options consistency check may be skewed by version differences");

3849 
	`İtiÚs_w¬nšg_§ã_ml
(
D_SHOW_OCC
, 
aùu®
, 
ex³ùed
, 
aùu®_n
);

3853 
»t
 = !
	`¡rcmp
(
aùu®
, 
ex³ùed
);

3855 
	`gc_ä“
(&
gc
);

3856  
»t
;

3857 
	}
}

3860 
	$İtiÚs_w¬nšg_§ã
(*
aùu®
, cÚ¡ *
ex³ùed
, 
size_t
 
aùu®_n
)

3862 
	`İtiÚs_w¬nšg_§ã_ml
(
M_WARN
, 
aùu®
, 
ex³ùed
, 
aùu®_n
);

3863 
	}
}

3866 
	$İtiÚs_¡ršg_v”siÚ
(cÚ¡ *
s
, 
gc_¬’a
 *
gc
)

3868 
bufãr
 
out
 = 
	`®loc_buf_gc
(4, 
gc
);

3869 
	`¡ºıyÁ
((*è
	`BPTR
(&
out
), 
s
, 3);

3870  
	`BSTR
(&
out
);

3871 
	}
}

3876 
	$İtiÚs_¡ršg_exŒaù_İtiÚ
(cÚ¡ *
İtiÚs_¡ršg
,cÚ¡ *
İt_Çme
,

3877 
gc_¬’a
 *
gc
)

3879 *
»t
 = 
NULL
;

3880 cÚ¡ 
size_t
 
İt_Çme_Ën
 = 
	`¡¾’
(
İt_Çme
);

3882 cÚ¡ *
p
 = 
İtiÚs_¡ršg
;

3883 
p
)

3885 ià(0 =ğ
	`¡ºcmp
(
p
, 
İt_Çme
, 
İt_Çme_Ën
)

3886 && 
	`¡¾’
(
p
è> (
İt_Çme_Ën
+1) &&…[opt_name_len] == ' ')

3889 cÚ¡ *
¡¬t
 = &
p
[
İt_Çme_Ën
+1];

3890 cÚ¡ *
’d
 = 
	`¡rchr
(
p
, ',');

3891 
size_t
 
v®_Ën
 = 
’d
 ?ƒnd - 
¡¬t
 : 
	`¡¾’
(start);

3892 
»t
 = 
	`gc_m®loc
(
v®_Ën
+1, 
Œue
, 
gc
);

3893 
	`memıy
(
»t
, 
¡¬t
, 
v®_Ën
);

3896 
p
 = 
	`¡rchr
(p, ',');

3897 ià(
p
)

3899 
p
++;

3902  
»t
;

3903 
	}
}

3906 
	$fÜeign_İtiÚ
(
İtiÚs
 *
o
, *
¬gv
[], 
Ën
, 
’v_£t
 *
es
)

3908 ià(
Ën
 > 0)

3910 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3911 
bufãr
 
Çme
 = 
	`®loc_buf_gc
(
OPTION_PARM_SIZE
, &
gc
);

3912 
bufãr
 
v®ue
 = 
	`®loc_buf_gc
(
OPTION_PARM_SIZE
, &
gc
);

3913 
i
;

3914 
boŞ
 
fœ¡
 = 
Œue
;

3915 
boŞ
 
good
 = 
Œue
;

3917 
good
 &ğ
	`buf_´štf
(&
Çme
, "fÜeign_İtiÚ_%d", 
o
->
fÜeign_İtiÚ_šdex
 + 1);

3918 ++
o
->
fÜeign_İtiÚ_šdex
;

3919 
i
 = 0; i < 
Ën
; ++i)

3921 ià(
¬gv
[
i
])

3923 ià(!
fœ¡
)

3925 
good
 &ğ
	`buf_´štf
(&
v®ue
, " ");

3927 
good
 &ğ
	`buf_´štf
(&
v®ue
, "%s", 
¬gv
[
i
]);

3928 
fœ¡
 = 
çl£
;

3931 ià(
good
)

3933 
	`£‹nv_¡r
(
es
, 
	`BSTR
(&
Çme
), BSTR(&
v®ue
));

3937 
	`msg
(
M_WARN
, "foreign_option:‚ame/value overflow");

3939 
	`gc_ä“
(&
gc
);

3941 
	}
}

3948 
	$·r£_tİŞogy
(cÚ¡ *
¡r
, cÚ¡ 
msgËv–
)

3950 ià(
	`¡»q
(
¡r
, "net30"))

3952  
TOP_NET30
;

3954 ià(
	`¡»q
(
¡r
, "p2p"))

3956  
TOP_P2P
;

3958 ià(
	`¡»q
(
¡r
, "subnet"))

3960  
TOP_SUBNET
;

3964 
	`msg
(
msgËv–
, "--topology must be‚et30,…2p, or subnet");

3965  
TOP_UNDEF
;

3967 
	}
}

3970 
	$´št_tİŞogy
(cÚ¡ 
tİŞogy
)

3972 
tİŞogy
)

3974 
TOP_UNDEF
:

3977 
TOP_NET30
:

3980 
TOP_P2P
:

3983 
TOP_SUBNET
:

3989 
	}
}

3991 #ià
P2MP


3997 
	gglob®_auth_»Œy
;

4000 
	$auth_»Œy_g‘
()

4002  
glob®_auth_»Œy
;

4003 
	}
}

4005 
boŞ


4006 
	$auth_»Œy_£t
(cÚ¡ 
msgËv–
, cÚ¡ *
İtiÚ
)

4008 ià(
	`¡»q
(
İtiÚ
, "interact"))

4010 
glob®_auth_»Œy
 = 
AR_INTERACT
;

4012 ià(
	`¡»q
(
İtiÚ
, "nointeract"))

4014 
glob®_auth_»Œy
 = 
AR_NOINTERACT
;

4016 ià(
	`¡»q
(
İtiÚ
, "none"))

4018 
glob®_auth_»Œy
 = 
AR_NONE
;

4022 
	`msg
(
msgËv–
, "--auth-retry method must be 'interact', 'nointeract', or 'none'");

4023  
çl£
;

4025  
Œue
;

4026 
	}
}

4029 
	$auth_»Œy_´št
()

4031 
glob®_auth_»Œy
)

4033 
AR_NONE
:

4036 
AR_NOINTERACT
:

4039 
AR_INTERACT
:

4045 
	}
}

4053 
	$u§ge
()

4055 
FILE
 *
å
 = 
	`msg_å
(0);

4057 #ifdeà
ENABLE_SMALL


4059 
	`årštf
(
å
, "Usage message‚ot‡vailable\n");

4063 
İtiÚs
 
o
;

4064 
	`š™_İtiÚs
(&
o
, 
Œue
);

4066 #ifdeà
ENABLE_CRYPTO


4067 
	`årštf
(
å
, 
u§ge_mes§ge
,

4068 
t™Ë_¡ršg
,

4069 
o
.
û
.
cÚÃù_»Œy_£cÚds
,

4070 
o
.
û
.
cÚÃù_»Œy_£cÚds_max
,

4071 
o
.
û
.
loÿl_pÜt
, o.û.
»mÙe_pÜt
,

4072 
TUN_MTU_DEFAULT
, 
TAP_MTU_EXTRA_DEFAULT
,

4073 
o
.
v”bos™y
,

4074 
o
.
authÇme
, o.
ch”Çme
,

4075 
o
.
»¶ay_wšdow
, o.
»¶ay_time
,

4076 
o
.
s_timeout
, o.
»ÃgÙŸ‹_£cÚds
,

4077 
o
.
hªdshake_wšdow
, o.
Œªs™iÚ_wšdow
);

4079 
	`årštf
(
å
, 
u§ge_mes§ge
,

4080 
t™Ë_¡ršg
,

4081 
o
.
û
.
cÚÃù_»Œy_£cÚds
,

4082 
o
.
û
.
cÚÃù_»Œy_£cÚds_max
,

4083 
o
.
û
.
loÿl_pÜt
, o.û.
»mÙe_pÜt
,

4084 
TUN_MTU_DEFAULT
, 
TAP_MTU_EXTRA_DEFAULT
,

4085 
o
.
v”bos™y
);

4087 
	`fæush
(
å
);

4091 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_USAGE
);

4092 
	}
}

4095 
	$u§ge_sm®l
()

4097 
	`msg
(
M_WARN
|
M_NOPREFIX
, "Use --help for more information.");

4098 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_USAGE
);

4099 
	}
}

4101 #ifdeà
_WIN32


4103 
	$show_wšdows_v”siÚ
(cÚ¡ 
æags
)

4105 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4106 
	`msg
(
æags
, "Wšdow v”siÚ %s", 
	`wš32_v”siÚ_¡ršg
(&
gc
, 
Œue
));

4107 
	`gc_ä“
(&
gc
);

4108 
	}
}

4112 
	$show_lib¿ry_v”siÚs
(cÚ¡ 
æags
)

4114 #ifdeà
ENABLE_CRYPTO


4115 
	#SSL_LIB_VER_STR
 
	`g‘_s¦_lib¿ry_v”siÚ
()

	)

4117 
	#SSL_LIB_VER_STR
 ""

	)

4119 #ifdeà
ENABLE_LZO


4120 
	#LZO_LIB_VER_STR
 ", LZO ", 
	`lzo_v”siÚ_¡ršg
()

	)

4122 
	#LZO_LIB_VER_STR
 "", ""

	)

4125 
	`msg
(
æags
, "lib¿ry v”siÚs: %s%s%s", 
SSL_LIB_VER_STR
, 
LZO_LIB_VER_STR
);

4127 #undeà
SSL_LIB_VER_STR


4128 #undeà
LZO_LIB_VER_STR


4129 
	}
}

4132 
	$u§ge_v”siÚ
()

4134 
	`msg
(
M_INFO
|
M_NOPREFIX
, "%s", 
t™Ë_¡ršg
);

4135 
	`show_lib¿ry_v”siÚs
Ğ
M_INFO
|
M_NOPREFIX
 );

4136 #ifdeà
_WIN32


4137 
	`show_wšdows_v”siÚ
Ğ
M_INFO
|
M_NOPREFIX
 );

4139 
	`msg
(
M_INFO
|
M_NOPREFIX
, "Originally developed by James Yonan");

4140 
	`msg
(
M_INFO
|
M_NOPREFIX
, "Copyright (C) 2002-2018 OpenVPN Inc <sales@openvpn.net>");

4141 #iâdeà
ENABLE_SMALL


4142 #ifdeà
CONFIGURE_DEFINES


4143 
	`msg
(
M_INFO
|
M_NOPREFIX
, "Comptimdefšes: %s", 
CONFIGURE_DEFINES
);

4145 #ifdeà
CONFIGURE_SPECIAL_BUILD


4146 
	`msg
(
M_INFO
|
M_NOPREFIX
, "¥ecŸÈbud: %s", 
CONFIGURE_SPECIAL_BUILD
);

4149 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_USAGE
);

4150 
	}
}

4153 
	$nÙnuÎ
(cÚ¡ *
¬g
, cÚ¡ *
desütiÚ
)

4155 ià(!
¬g
)

4157 
	`msg
(
M_USAGE
, "You mu¡ defš%s", 
desütiÚ
);

4159 
	}
}

4161 
boŞ


4162 
	$¡ršg_defšed_equ®
(cÚ¡ *
s1
, cÚ¡ *
s2
)

4164 ià(
s1
 && 
s2
)

4166  !
	`¡rcmp
(
s1
, 
s2
);

4170  
çl£
;

4172 
	}
}

4176 
	$pšg_»c_”r
(
msgËv–
)

4178 
	`msg
(
msgËv–
, "only one of --ping-exit or --ping-restart options may be specified");

4179 
	}
}

4183 
	$pos™ive_©oi
(cÚ¡ *
¡r
)

4185 cÚ¡ 
i
 = 
	`©oi
(
¡r
);

4186  
i
 < 0 ? 0 : i;

4187 
	}
}

4189 #ifdeà
_WIN32


4191 
	$©ou
(cÚ¡ *
¡r
)

4193 
v®
 = 0;

4194 
	`ssÿnf
(
¡r
, "%u", &
v®
);

4195  
v®
;

4196 
	}
}

4199 
šlše
 
boŞ


4200 
	$¥aû
(
c
)

4202  
c
 =ğ'\0' || 
	`is¥aû
(c);

4203 
	}
}

4206 
	$·r£_lše
(cÚ¡ *
lše
,

4207 *
p
[],

4208 cÚ¡ 
n
,

4209 cÚ¡ *
fe
,

4210 cÚ¡ 
lše_num
,

4211 
msgËv–
,

4212 
gc_¬’a
 *
gc
)

4214 cÚ¡ 
STATE_INITIAL
 = 0;

4215 cÚ¡ 
STATE_READING_QUOTED_PARM
 = 1;

4216 cÚ¡ 
STATE_READING_UNQUOTED_PARM
 = 2;

4217 cÚ¡ 
STATE_DONE
 = 3;

4218 cÚ¡ 
STATE_READING_SQUOTED_PARM
 = 4;

4220 cÚ¡ *
”rÜ_´efix
 = "";

4222 
»t
 = 0;

4223 cÚ¡ *
c
 = 
lše
;

4224 
¡©e
 = 
STATE_INITIAL
;

4225 
boŞ
 
back¦ash
 = 
çl£
;

4226 
š
, 
out
;

4228 
·rm
[
OPTION_PARM_SIZE
];

4229 
·rm_Ën
 = 0;

4231 
msgËv–
 &ğ~
M_OPTERR
;

4233 ià(
msgËv–
 & 
M_MSG_VIRT_OUT
)

4235 
”rÜ_´efix
 = "ERROR: ";

4240 
š
 = *
c
;

4241 
out
 = 0;

4243 ià(!
back¦ash
 && 
š
 =ğ'\\' && 
¡©e
 !ğ
STATE_READING_SQUOTED_PARM
)

4245 
back¦ash
 = 
Œue
;

4249 ià(
¡©e
 =ğ
STATE_INITIAL
)

4251 ià(!
	`¥aû
(
š
))

4253 ià(
š
 == ';' || in == '#')

4257 ià(!
back¦ash
 && 
š
 == '\"')

4259 
¡©e
 = 
STATE_READING_QUOTED_PARM
;

4261 ià(!
back¦ash
 && 
š
 == '\'')

4263 
¡©e
 = 
STATE_READING_SQUOTED_PARM
;

4267 
out
 = 
š
;

4268 
¡©e
 = 
STATE_READING_UNQUOTED_PARM
;

4272 ià(
¡©e
 =ğ
STATE_READING_UNQUOTED_PARM
)

4274 ià(!
back¦ash
 && 
	`¥aû
(
š
))

4276 
¡©e
 = 
STATE_DONE
;

4280 
out
 = 
š
;

4283 ià(
¡©e
 =ğ
STATE_READING_QUOTED_PARM
)

4285 ià(!
back¦ash
 && 
š
 == '\"')

4287 
¡©e
 = 
STATE_DONE
;

4291 
out
 = 
š
;

4294 ià(
¡©e
 =ğ
STATE_READING_SQUOTED_PARM
)

4296 ià(
š
 == '\'')

4298 
¡©e
 = 
STATE_DONE
;

4302 
out
 = 
š
;

4305 ià(
¡©e
 =ğ
STATE_DONE
)

4308 
p
[
»t
] = 
	`gc_m®loc
(
·rm_Ën
 + 1, 
Œue
, 
gc
);

4309 
	`memıy
(
p
[
»t
], 
·rm
, 
·rm_Ën
);

4310 
p
[
»t
][
·rm_Ën
] = '\0';

4311 
¡©e
 = 
STATE_INITIAL
;

4312 
·rm_Ën
 = 0;

4313 ++
»t
;

4316 ià(
back¦ash
 && 
out
)

4318 ià(!(
out
 =ğ'\\' || ouˆ=ğ'\"' || 
	`¥aû
(out)))

4320 #ifdeà
ENABLE_SMALL


4321 
	`msg
(
msgËv–
, "%sO±iÚ w¬nšg: Bad back¦ash ('\\'èu§gš %s:%d", 
”rÜ_´efix
, 
fe
, 
lše_num
);

4323 
	`msg
(
msgËv–
, "%sO±iÚ w¬nšg: Bad back¦ash ('\\'èu§gš %s:%d:„ememb”h© back¦ashe ¬Œ—‹d‡ sh–l-esÿ³ ªd iàyou‚“dØ·s back¦ash ch¬aù” a ·¹ oà¨Wšdow f’ame, you should u£ doubË back¦ashe such‡ \"c:\\\\" 
PACKAGE
 "\\\\¡©ic.key\"", 
”rÜ_´efix
, 
fe
, 
lše_num
);

4328 
back¦ash
 = 
çl£
;

4332 ià(
out
)

4334 ià(
·rm_Ën
 >ğ
	`SIZE
(
·rm
))

4336 
·rm
[
	`SIZE
(parm) - 1] = 0;

4337 
	`msg
(
msgËv–
, "%sOptionsƒrror: Parameter‡t %s:%d isoo†ong (%d chars max): %s",

4338 
”rÜ_´efix
, 
fe
, 
lše_num
, (è
	`SIZE
(
·rm
),…arm);

4341 
·rm
[
·rm_Ën
++] = 
out
;

4345 ià(
»t
 >ğ
n
)

4350 } *
c
++ != '\0');

4352 ià(
¡©e
 =ğ
STATE_READING_QUOTED_PARM
)

4354 
	`msg
(
msgËv–
, "%sO±iÚ ”rÜ: NØşosšg quÙ©iÚ (\"èš %s:%d", 
”rÜ_´efix
, 
fe
, 
lše_num
);

4357 ià(
¡©e
 =ğ
STATE_READING_SQUOTED_PARM
)

4359 
	`msg
(
msgËv–
, "%sO±iÚ ”rÜ: NØşosšg sšgË quÙ©iÚ (\'èš %s:%d", 
”rÜ_´efix
, 
fe
, 
lše_num
);

4362 ià(
¡©e
 !ğ
STATE_INITIAL
)

4364 
	`msg
(
msgËv–
, "%sO±iÚ ”rÜ: Residu®…¬£ s‹ (%dèš %s:%d", 
”rÜ_´efix
, 
¡©e
, 
fe
, 
lše_num
);

4369 
i
;

4370 
i
 = 0; i < 
»t
; ++i)

4372 
	`msg
(
M_INFO
|
M_NOPREFIX
, "%s:%d ARG[%d] '%s'", 
fe
, 
lše_num
, 
i
, 
p
[i]);

4376  
»t
;

4377 
	}
}

4380 
	$by·ss_doubËdash
(**
p
)

4382 ià(
	`¡¾’
(*
p
è>ğ3 && !
	`¡ºcmp
(*p, "--", 2))

4384 *
p
 += 2;

4386 
	}
}

4388 
	sš_¤c
 {

4389 
	#IS_TYPE_FP
 1

	)

4390 
	#IS_TYPE_BUF
 2

	)

4391 
	mty³
;

4393 
FILE
 *
	må
;

4394 
bufãr
 *
	mmuÉše
;

4395 } 
	mu
;

4398 
boŞ


4399 
	$š_¤c_g‘
(cÚ¡ 
š_¤c
 *
is
, *
lše
, cÚ¡ 
size
)

4401 ià(
is
->
ty³
 =ğ
IS_TYPE_FP
)

4403  
	`BOOL_CAST
(
	`fg‘s
(
lše
, 
size
, 
is
->
u
.
å
));

4405 ià(
is
->
ty³
 =ğ
IS_TYPE_BUF
)

4407 
boŞ
 
¡©us
 = 
	`buf_·r£
(
is
->
u
.
muÉše
, '\n', 
lše
, 
size
);

4408 ià((è
	`¡¾’
(
lše
è+ 1 < 
size
)

4410 
	`¡rÿt
(
lše
, "\n");

4412  
¡©us
;

4416 
	`ASSERT
(0);

4417  
çl£
;

4419 
	}
}

4422 
	$»ad_šlše_fe
(
š_¤c
 *
is
, cÚ¡ *
şo£_g
, 
gc_¬’a
 *
gc
)

4424 
lše
[
OPTION_LINE_SIZE
];

4425 
bufãr
 
buf
 = 
	`®loc_buf
(8*
OPTION_LINE_SIZE
);

4426 *
»t
;

4427 
boŞ
 
’dgfound
 = 
çl£
;

4429 
	`š_¤c_g‘
(
is
, 
lše
, (line)))

4431 *
lše_±r
 = 
lše
;

4433 
	`is¥aû
(*
lše_±r
))

4435 
lše_±r
++;

4437 ià(!
	`¡ºcmp
(
lše_±r
, 
şo£_g
, 
	`¡¾’
(close_tag)))

4439 
’dgfound
 = 
Œue
;

4442 ià(!
	`buf_§ã
(&
buf
, 
	`¡¾’
(
lše
)+1))

4445 
bufãr
 
buf2
 = 
	`®loc_buf
(
buf
.
ÿ·c™y
 * 2);

4446 
	`ASSERT
(
	`buf_cİy
(&
buf2
, &
buf
));

4447 
	`buf_ş—r
(&
buf
);

4448 
	`ä“_buf
(&
buf
);

4449 
buf
 = 
buf2
;

4451 
	`buf_´štf
(&
buf
, "%s", 
lše
);

4453 ià(!
’dgfound
)

4455 
	`msg
(
M_FATAL
, "ERROR: Endg % missšg", 
şo£_g
);

4457 
»t
 = 
	`¡ršg_®loc
(
	`BSTR
(&
buf
), 
gc
);

4458 
	`buf_ş—r
(&
buf
);

4459 
	`ä“_buf
(&
buf
);

4460 
	`£cu»_memz”o
(
lše
, (line));

4461  
»t
;

4462 
	}
}

4464 
boŞ


4465 
	$check_šlše_fe
(
š_¤c
 *
is
, *
p
[], 
gc_¬’a
 *
gc
)

4467 
boŞ
 
»t
 = 
çl£
;

4468 ià(
p
[0] && !p[1])

4470 *
¬g
 = 
p
[0];

4471 ià(
¬g
[0] =ğ'<' &&‡rg[
	`¡¾’
(arg)-1] == '>')

4473 
bufãr
 
şo£_g
;

4474 
¬g
[
	`¡¾’
(arg)-1] = '\0';

4475 
p
[0] = 
	`¡ršg_®loc
(
¬g
+1, 
gc
);

4476 
p
[1] = 
	`¡ršg_®loc
(
INLINE_FILE_TAG
, 
gc
);

4477 
şo£_g
 = 
	`®loc_buf
(
	`¡¾’
(
p
[0]) + 4);

4478 
	`buf_´štf
(&
şo£_g
, "</%s>", 
p
[0]);

4479 
p
[2] = 
	`»ad_šlše_fe
(
is
, 
	`BSTR
(&
şo£_g
), 
gc
);

4480 
p
[3] = 
NULL
;

4481 
	`ä“_buf
(&
şo£_g
);

4482 
»t
 = 
Œue
;

4485  
»t
;

4486 
	}
}

4488 
boŞ


4489 
	$check_šlše_fe_vŸ_å
(
FILE
 *
å
, *
p
[], 
gc_¬’a
 *
gc
)

4491 
š_¤c
 
is
;

4492 
is
.
ty³
 = 
IS_TYPE_FP
;

4493 
is
.
u
.
å
 = fp;

4494  
	`check_šlše_fe
(&
is
, 
p
, 
gc
);

4495 
	}
}

4497 
boŞ


4498 
	$check_šlše_fe_vŸ_buf
(
bufãr
 *
muÉše
, *
p
[], 
gc_¬’a
 *
gc
)

4500 
š_¤c
 
is
;

4501 
is
.
ty³
 = 
IS_TYPE_BUF
;

4502 
is
.
u
.
muÉše
 = multiline;

4503  
	`check_šlše_fe
(&
is
, 
p
, 
gc
);

4504 
	}
}

4507 
add_İtiÚ
(
İtiÚs
 *options,

4508 *
p
[],

4509 cÚ¡ *
fe
,

4510 
lše
,

4511 cÚ¡ 
Ëv–
,

4512 cÚ¡ 
msgËv–
,

4513 cÚ¡ 
³rmissiÚ_mask
,

4514 *
İtiÚ_ty³s_found
,

4515 
’v_£t
 *
es
);

4518 
	$»ad_cÚfig_fe
(
İtiÚs
 *options,

4519 cÚ¡ *
fe
,

4520 
Ëv–
,

4521 cÚ¡ *
tİ_fe
,

4522 cÚ¡ 
tİ_lše
,

4523 cÚ¡ 
msgËv–
,

4524 cÚ¡ 
³rmissiÚ_mask
,

4525 *
İtiÚ_ty³s_found
,

4526 
’v_£t
 *
es
)

4528 cÚ¡ 
max_»cursive_Ëv–s
 = 10;

4529 
FILE
 *
å
;

4530 
lše_num
;

4531 
lše
[
OPTION_LINE_SIZE
+1];

4532 *
p
[
MAX_PARMS
+1];

4534 ++
Ëv–
;

4535 ià(
Ëv–
 <ğ
max_»cursive_Ëv–s
)

4537 ià(
	`¡»q
(
fe
, "stdin"))

4539 
å
 = 
¡dš
;

4543 
å
 = 
	`¶©fÜm_fİ’
(
fe
, "r");

4545 ià(
å
)

4547 
lše_num
 = 0;

4548 
	`fg‘s
(
lše
, Öše), 
å
))

4550 
off£t
 = 0;

4551 
	`CLEAR
(
p
);

4552 ++
lše_num
;

4553 ià(
	`¡¾’
(
lše
è=ğ
OPTION_LINE_SIZE
)

4555 
	`msg
(
msgËv–
, "In %s:%d: Maximum option†ine†ength (%d)ƒxceeded,†ine starts with %s",

4556 
fe
, 
lše_num
, 
OPTION_LINE_SIZE
, 
lše
);

4560 ià(
lše_num
 =ğ1 && 
	`¡ºcmp
(
lše
, "\xEF\xBB\xBF", 3) == 0)

4562 
off£t
 = 3;

4564 ià(
	`·r£_lše
(
lše
 + 
off£t
, 
p
, 
	`SIZE
Õ)-1, 
fe
, 
lše_num
, 
msgËv–
, &
İtiÚs
->
gc
))

4566 
	`by·ss_doubËdash
(&
p
[0]);

4567 
	`check_šlše_fe_vŸ_å
(
å
, 
p
, &
İtiÚs
->
gc
);

4568 
	`add_İtiÚ
(
İtiÚs
, 
p
, 
fe
, 
lše_num
, 
Ëv–
, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4571 ià(
å
 !ğ
¡dš
)

4573 
	`fşo£
(
å
);

4578 
	`msg
(
msgËv–
, "IÀ%s:%d: E¼Ü o³nšg cÚfigu¿tiÚ fe: %s", 
tİ_fe
, 
tİ_lše
, 
fe
);

4583 
	`msg
(
msgËv–
, "IÀ%s:%d: Maximum„ecursivšşudËv– exûeded iÀšşud©‹m± oàf% --…robably you hav¨cÚfigu¿tiÚ fth©r› tØšşud™£lf.", 
tİ_fe
, 
tİ_lše
, 
fe
);

4585 
	`£cu»_memz”o
(
lše
, (line));

4586 
	`CLEAR
(
p
);

4587 
	}
}

4590 
	$»ad_cÚfig_¡ršg
(cÚ¡ *
´efix
,

4591 
İtiÚs
 *options,

4592 cÚ¡ *
cÚfig
,

4593 cÚ¡ 
msgËv–
,

4594 cÚ¡ 
³rmissiÚ_mask
,

4595 *
İtiÚ_ty³s_found
,

4596 
’v_£t
 *
es
)

4598 
lše
[
OPTION_LINE_SIZE
];

4599 
bufãr
 
muÉše
;

4600 
lše_num
 = 0;

4602 
	`buf_£t_»ad
(&
muÉše
, (
ušt8_t
 *)
cÚfig
, 
	`¡¾’
(config));

4604 
	`buf_·r£
(&
muÉše
, '\n', 
lše
, (line)))

4606 *
p
[
MAX_PARMS
+1];

4607 
	`CLEAR
(
p
);

4608 ++
lše_num
;

4609 ià(
	`·r£_lše
(
lše
, 
p
, 
	`SIZE
Õ)-1, 
´efix
, 
lše_num
, 
msgËv–
, &
İtiÚs
->
gc
))

4611 
	`by·ss_doubËdash
(&
p
[0]);

4612 
	`check_šlše_fe_vŸ_buf
(&
muÉše
, 
p
, &
İtiÚs
->
gc
);

4613 
	`add_İtiÚ
(
İtiÚs
, 
p
, 
´efix
, 
lše_num
, 0, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4615 
	`CLEAR
(
p
);

4617 
	`£cu»_memz”o
(
lše
, (line));

4618 
	}
}

4621 
	$·r£_¬gv
(
İtiÚs
 *options,

4622 cÚ¡ 
¬gc
,

4623 *
¬gv
[],

4624 cÚ¡ 
msgËv–
,

4625 cÚ¡ 
³rmissiÚ_mask
,

4626 *
İtiÚ_ty³s_found
,

4627 
’v_£t
 *
es
)

4629 
i
, 
j
;

4632 ià(
¬gc
 <= 1)

4634 
	`u§ge
();

4638 ià(
¬gc
 =ğ2 && 
	`¡ºcmp
(
¬gv
[1], "--", 2))

4640 *
p
[
MAX_PARMS
];

4641 
	`CLEAR
(
p
);

4642 
p
[0] = "config";

4643 
p
[1] = 
¬gv
[1];

4644 
	`add_İtiÚ
(
İtiÚs
, 
p
, 
NULL
, 0, 0, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4649 
i
 = 1; i < 
¬gc
; ++i)

4651 *
p
[
MAX_PARMS
];

4652 
	`CLEAR
(
p
);

4653 
p
[0] = 
¬gv
[
i
];

4654 ià(
	`¡ºcmp
(
p
[0], "--", 2))

4656 
	`msg
(
msgËv–
, "I'mryšgØ·r£ \"%s\"‡ ª --İtiÚ…¬am‘” buˆI dÚ'ˆ£¨Ëadšg '--'", 
p
[0]);

4660 
p
[0] += 2;

4663 
j
 = 1; j < 
MAX_PARMS
; ++j)

4665 ià(
i
 + 
j
 < 
¬gc
)

4667 *
¬g
 = 
¬gv
[
i
 + 
j
];

4668 ià(
	`¡ºcmp
(
¬g
, "--", 2))

4670 
p
[
j
] = 
¬g
;

4678 
	`add_İtiÚ
(
İtiÚs
, 
p
, 
NULL
, 0, 0, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4679 
i
 +ğ
j
 - 1;

4682 
	}
}

4692 
boŞ


4693 
	$­¶y_puÎ_f‹r
(cÚ¡ 
İtiÚs
 *
o
, *
lše
)

4695 
puÎ_f‹r
 *
f
;

4697 ià(!
o
->
puÎ_f‹r_li¡
)

4699  
Œue
;

4702 
f
 = 
o
->
puÎ_f‹r_li¡
->
h—d
; f; f = f->
Ãxt
)

4704 ià(
f
->
ty³
 =ğ
PUF_TYPE_ACCEPT
 && 
	`¡ºcmp
(
lše
, f->
·‰”n
, f->
size
) == 0)

4706 
	`msg
(
D_LOW
, "Pushed o±iÚ‡cû±ed by f‹r: '%s'", 
lše
);

4707  
Œue
;

4709 ià(
f
->
ty³
 =ğ
PUF_TYPE_IGNORE
 && 
	`¡ºcmp
(
lše
, f->
·‰”n
, f->
size
) == 0)

4711 
	`msg
(
D_PUSH
, "Pushed o±iÚ„emoved by f‹r: '%s'", 
lše
);

4712 *
lše
 = '\0';

4713  
Œue
;

4715 ià(
f
->
ty³
 =ğ
PUF_TYPE_REJECT
 && 
	`¡ºcmp
(
lše
, f->
·‰”n
, f->
size
) == 0)

4717 
	`msg
(
M_WARN
, "Pushed o±iÚ„ejeùed by f‹r: '%s'. Re¡¬tšg.", 
lše
);

4718 *
lše
 = '\0';

4719 
	`throw_sigÇl_soá
(
SIGUSR1
, "Offending option„eceived from server");

4720  
çl£
;

4723  
Œue
;

4724 
	}
}

4726 
boŞ


4727 
	$­¶y_push_İtiÚs
(
İtiÚs
 *options,

4728 
bufãr
 *
buf
,

4729 
³rmissiÚ_mask
,

4730 *
İtiÚ_ty³s_found
,

4731 
’v_£t
 *
es
)

4733 
lše
[
OPTION_PARM_SIZE
];

4734 
lše_num
 = 0;

4735 cÚ¡ *
fe
 = "[PUSH-OPTIONS]";

4736 cÚ¡ 
msgËv–
 = 
D_PUSH_ERRORS
|
M_OPTERR
;

4738 
	`buf_·r£
(
buf
, ',', 
lše
, (line)))

4740 *
p
[
MAX_PARMS
+1];

4741 
	`CLEAR
(
p
);

4742 ++
lše_num
;

4743 ià(!
	`­¶y_puÎ_f‹r
(
İtiÚs
, 
lše
))

4745  
çl£
;

4747 ià(
	`·r£_lše
(
lše
, 
p
, 
	`SIZE
Õ)-1, 
fe
, 
lše_num
, 
msgËv–
, &
İtiÚs
->
gc
))

4749 
	`add_İtiÚ
(
İtiÚs
, 
p
, 
fe
, 
lše_num
, 0, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4752  
Œue
;

4753 
	}
}

4756 
	$İtiÚs_£rv”_impÜt
(
İtiÚs
 *
o
,

4757 cÚ¡ *
f’ame
,

4758 
msgËv–
,

4759 
³rmissiÚ_mask
,

4760 *
İtiÚ_ty³s_found
,

4761 
’v_£t
 *
es
)

4763 
	`msg
(
D_PUSH
, "OPTIONS IMPORT:„—dšg cl›Á s³cifiøİtiÚ äom: %s", 
f’ame
);

4764 
	`»ad_cÚfig_fe
(
o
,

4765 
f’ame
,

4767 
f’ame
,

4769 
msgËv–
,

4770 
³rmissiÚ_mask
,

4771 
İtiÚ_ty³s_found
,

4772 
es
);

4773 
	}
}

4776 
	$İtiÚs_¡ršg_impÜt
(
İtiÚs
 *options,

4777 cÚ¡ *
cÚfig
,

4778 cÚ¡ 
msgËv–
,

4779 cÚ¡ 
³rmissiÚ_mask
,

4780 *
İtiÚ_ty³s_found
,

4781 
’v_£t
 *
es
)

4783 
	`»ad_cÚfig_¡ršg
("[CONFIG-STRING]", 
İtiÚs
, 
cÚfig
, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4784 
	}
}

4786 #ià
P2MP


4788 
	#VERIFY_PERMISSION
(
mask
è{ ià(!
	`v”ify_³rmissiÚ
(
p
[0], 
fe
, 
lše
, (mask), 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
msgËv–
, 
İtiÚs
)è{
”r
;}}

	)

4790 
boŞ


4791 
	$v”ify_³rmissiÚ
(cÚ¡ *
Çme
,

4792 cÚ¡ *
fe
,

4793 
lše
,

4794 cÚ¡ 
ty³
,

4795 cÚ¡ 
®lowed
,

4796 *
found
,

4797 cÚ¡ 
msgËv–
,

4798 
İtiÚs
 *options)

4800 ià(!(
ty³
 & 
®lowed
))

4802 
	`msg
(
msgËv–
, "İtiÚ '%s' cªnÙ bu£d iÀthi cÚ‹xˆ(%s)", 
Çme
, 
fe
);

4803  
çl£
;

4806 ià(
found
)

4808 *
found
 |ğ
ty³
;

4811 #iâdeà
ENABLE_SMALL


4819 ià((
ty³
 & 
OPT_P_CONNECTION
è&& 
İtiÚs
->
cÚÃùiÚ_li¡


4820 && !(
®lowed
 & 
OPT_P_PULL_MODE
))

4822 ià(
fe
)

4824 
	`msg
(
M_WARN
, "O±iÚ '%s' iÀ%s:%d i ignÜed by…»viou <cÚÃùiÚ> block ", 
Çme
, 
fe
, 
lše
);

4828 
	`msg
(
M_WARN
, "O±iÚ '%s' i ignÜed by…»viou <cÚÃùiÚ> blocks", 
Çme
);

4832  
Œue
;

4833 
	}
}

4837 
	#VERIFY_PERMISSION
(
mask
)

	)

4846 
	#NM_QUOTE_HINT
 (1<<0)

	)

4848 
boŞ


4849 
	$no_mÜe_thª_n_¬gs
(cÚ¡ 
msgËv–
,

4850 *
p
[],

4851 cÚ¡ 
max
,

4852 cÚ¡ 
æags
)

4854 cÚ¡ 
Ën
 = 
	`¡ršg_¬¿y_Ën
((cÚ¡ **)
p
);

4856 ià(!
Ën
)

4858  
çl£
;

4861 ià(
Ën
 > 
max
)

4863 
	`msg
(
msgËv–
, "the --%s directive should have‡t most %d…arameter%s.%s",

4864 
p
[0],

4865 
max
 - 1,

4866 
max
 >= 3 ? "s" : "",

4867 (
æags
 & 
NM_QUOTE_HINT
) ? " To…ass‡†ist of‡rguments‡s one ofhe…arameters,ryƒnclosinghem in double quotes (\"\")." : "");

4868  
çl£
;

4872  
Œue
;

4874 
	}
}

4876 
šlše
 

4877 
	$msgËv–_fÜw¬d_com·tibË
(
İtiÚs
 *İtiÚs, cÚ¡ 
msgËv–
)

4879  
İtiÚs
->
fÜw¬d_com·tibË
 ? 
M_WARN
 : 
msgËv–
;

4880 
	}
}

4883 
	$£t_u£r_süt
(
İtiÚs
 *options,

4884 cÚ¡ **
süt
,

4885 cÚ¡ *
Ãw_süt
,

4886 cÚ¡ *
ty³
,

4887 
boŞ
 
š_chroÙ
)

4889 ià(*
süt
)

4891 
	`msg
(
M_WARN
, "Multiple --%s scripts defined. "

4892 "Th´eviou¦y cÚfigu»d süˆi ov”ridd’.", 
ty³
);

4894 *
süt
 = 
Ãw_süt
;

4895 
İtiÚs
->
u£r_süt_u£d
 = 
Œue
;

4897 #iâdeà
ENABLE_SMALL


4899 
süt_Çme
[100];

4900 
	`İ’v²_¢´štf
(
süt_Çme
, (script_name),

4901 "--% süt", 
ty³
);

4903 ià(
	`check_cmd_acûss
(*
süt
, 
süt_Çme
, (
š_chroÙ
 ? 
İtiÚs
->
chroÙ_dœ
 : 
NULL
)))

4905 
	`msg
(
M_USAGE
, "Please correcthisƒrror.");

4910 
	}
}

4914 
	$add_İtiÚ
(
İtiÚs
 *options,

4915 *
p
[],

4916 cÚ¡ *
fe
,

4917 
lše
,

4918 cÚ¡ 
Ëv–
,

4919 cÚ¡ 
msgËv–
,

4920 cÚ¡ 
³rmissiÚ_mask
,

4921 *
İtiÚ_ty³s_found
,

4922 
’v_£t
 *
es
)

4924 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4925 cÚ¡ 
boŞ
 
puÎ_mode
 = 
	`BOOL_CAST
(
³rmissiÚ_mask
 & 
OPT_P_PULL_MODE
);

4926 
msgËv–_fc
 = 
	`msgËv–_fÜw¬d_com·tibË
(
İtiÚs
, 
msgËv–
);

4928 
	`ASSERT
(
MAX_PARMS
 >= 7);

4934 ià(
	`¡»q
(
p
[0], "£‹nv"è&&…[1] && sŒeqÕ[1], "İt"è&& !(
³rmissiÚ_mask
 & 
OPT_P_PULL_MODE
))

4936 ià(!
p
[2])

4938 
p
[2] = "setenv opt";

4940 
p
 += 2;

4941 
msgËv–_fc
 = 
M_WARN
;

4944 ià(!
fe
)

4946 
fe
 = "[CMD-LINE]";

4947 
lše
 = 1;

4949 ià(
	`¡»q
(
p
[0], "help"))

4951 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

4952 
	`u§ge
();

4953 ià(
p
[1])

4955 
	`msg
(
msgËv–
, "--help does‚ot‡ccept‡ny…arameters");

4956 
”r
;

4959 ià(
	`¡»q
(
p
[0], "version") && !p[1])

4961 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

4962 
	`u§ge_v”siÚ
();

4964 ià(
	`¡»q
(
p
[0], "config") &&…[1] && !p[2])

4966 
	`VERIFY_PERMISSION
(
OPT_P_CONFIG
);

4969 ià(!
İtiÚs
->
cÚfig
)

4971 
İtiÚs
->
cÚfig
 = 
p
[1];

4974 
	`»ad_cÚfig_fe
(
İtiÚs
, 
p
[1], 
Ëv–
, 
fe
, 
lše
, 
msgËv–
, 
³rmissiÚ_mask
, 
İtiÚ_ty³s_found
, 
es
);

4976 #ià
	`defšed
(
ENABLE_DEBUG
è&& !defšed(
ENABLE_SMALL
)

4977 ià(
	`¡»q
(
p
[0], "show-gateway") && !p[2])

4979 
rou‹_g©eway_šfo
 
rgi
;

4980 
rou‹_v6_g©eway_šfo
 
rgi6
;

4981 
š6_addr
 
»mÙe
 = 
IN6ADDR_ANY_INIT
;

4982 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

4983 ià(
p
[1])

4985 
	`g‘_v6_addr
(
p
[1], &
»mÙe
, 
NULL
, 
M_WARN
);

4987 
	`g‘_deçuÉ_g©eway
(&
rgi
);

4988 
	`g‘_deçuÉ_g©eway_v6
(&
rgi6
, &
»mÙe
);

4989 
	`´št_deçuÉ_g©eway
(
M_INFO
, &
rgi
, &
rgi6
);

4990 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

4994 ià(
	`¡»q
(
p
[0], "foreign-option") &&…[1])

4996 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

4997 
	`fÜeign_İtiÚ
(
İtiÚs
, 
p
, 3, 
es
);

5000 ià(
	`¡»q
(
p
[0], "echo") || streq(p[0], "parameter"))

5002 
bufãr
 
¡ršg
 = 
	`®loc_buf_gc
(
OPTION_PARM_SIZE
, &
gc
);

5003 
j
;

5004 
boŞ
 
good
 = 
Œue
;

5006 
	`VERIFY_PERMISSION
(
OPT_P_ECHO
);

5008 
j
 = 1; j < 
MAX_PARMS
; ++j)

5010 ià(!
p
[
j
])

5014 ià(
j
 > 1)

5016 
good
 &ğ
	`buf_´štf
(&
¡ršg
, " ");

5018 
good
 &ğ
	`buf_´štf
(&
¡ršg
, "%s", 
p
[
j
]);

5020 ià(
good
)

5025 
	`msg
(
M_INFO
, "%s:%s",

5026 
puÎ_mode
 ? "ECHO-PULL" : "ECHO",

5027 
	`BSTR
(&
¡ršg
));

5029 #ifdeà
ENABLE_MANAGEMENT


5030 ià(
mªagem’t
)

5032 
	`mªagem’t_echo
(
mªagem’t
, 
	`BSTR
(&
¡ršg
), 
puÎ_mode
);

5038 
	`msg
(
M_WARN
, "echo/parameter option overflow");

5041 #ifdeà
ENABLE_MANAGEMENT


5042 ià(
	`¡»q
(
p
[0], "management") &&…[1] &&…[2] && !p[4])

5044 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5045 ià(
	`¡»q
(
p
[2], "unix"))

5047 #ià
UNIX_SOCK_SUPPORT


5048 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_UNIX_SOCK
;

5050 
	`msg
(
msgËv–
, "MANAGEMENT:his…latform does‚ot support unix domain sockets");

5051 
”r
;

5055 
İtiÚs
->
mªagem’t_addr
 = 
p
[1];

5056 
İtiÚs
->
mªagem’t_pÜt
 = 
p
[2];

5057 ià(
p
[3])

5059 
İtiÚs
->
mªagem’t_u£r_·ss
 = 
p
[3];

5062 ià(
	`¡»q
(
p
[0], "management-client-user") &&…[1] && !p[2])

5064 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5065 
İtiÚs
->
mªagem’t_ş›Á_u£r
 = 
p
[1];

5067 ià(
	`¡»q
(
p
[0], "management-client-group") &&…[1] && !p[2])

5069 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5070 
İtiÚs
->
mªagem’t_ş›Á_group
 = 
p
[1];

5072 ià(
	`¡»q
(
p
[0], "management-query-passwords") && !p[1])

5074 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5075 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_QUERY_PASSWORDS
;

5077 ià(
	`¡»q
(
p
[0], "management-query-remote") && !p[1])

5079 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5080 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_QUERY_REMOTE
;

5082 ià(
	`¡»q
(
p
[0], "management-query-proxy") && !p[1])

5084 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5085 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_QUERY_PROXY
;

5087 ià(
	`¡»q
(
p
[0], "management-hold") && !p[1])

5089 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5090 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_HOLD
;

5092 ià(
	`¡»q
(
p
[0], "management-signal") && !p[1])

5094 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5095 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_SIGNAL
;

5097 ià(
	`¡»q
(
p
[0], "management-forget-disconnect") && !p[1])

5099 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5100 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_FORGET_DISCONNECT
;

5102 ià(
	`¡»q
(
p
[0], "management-up-down") && !p[1])

5104 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5105 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_UP_DOWN
;

5107 ià(
	`¡»q
(
p
[0], "management-client") && !p[2])

5109 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5110 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_CONNECT_AS_CLIENT
;

5111 
İtiÚs
->
mªagem’t_wr™e_³”_šfo_fe
 = 
p
[1];

5113 #ifdeà
MANAGMENT_EXTERNAL_KEY


5114 ià(
	`¡»q
(
p
[0], "management-external-key") && !p[1])

5116 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5117 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_EXTERNAL_KEY
;

5119 ià(
	`¡»q
(
p
[0], "management-external-cert") &&…[1] && !p[2])

5121 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5122 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_EXTERNAL_CERT
;

5123 
İtiÚs
->
mªagem’t_û¹ifiÿ‹
 = 
p
[1];

5126 #ifdeà
MANAGEMENT_DEF_AUTH


5127 ià(
	`¡»q
(
p
[0], "management-client-auth") && !p[1])

5129 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5130 
İtiÚs
->
mªagem’t_æags
 |ğ
MF_CLIENT_AUTH
;

5133 #ifdeà
MANAGEMENT_PF


5134 ià(
	`¡»q
(
p
[0], "management-client-pf") && !p[1])

5136 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5137 
İtiÚs
->
mªagem’t_æags
 |ğ(
MF_CLIENT_PF
 | 
MF_CLIENT_AUTH
);

5140 ià(
	`¡»q
(
p
[0], "management-log-cache") &&…[1] && !p[2])

5142 
ÿche
;

5144 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5145 
ÿche
 = 
	`©oi
(
p
[1]);

5146 ià(
ÿche
 < 1)

5148 
	`msg
(
msgËv–
, "--management-log-cache…arameter is out of„ange");

5149 
”r
;

5151 
İtiÚs
->
mªagem’t_log_hi¡Üy_ÿche
 = 
ÿche
;

5154 #ifdeà
ENABLE_PLUGIN


5155 ià(
	`¡»q
(
p
[0], "plugin") &&…[1])

5157 
	`VERIFY_PERMISSION
(
OPT_P_PLUGIN
);

5158 ià(!
İtiÚs
->
¶ugš_li¡
)

5160 
İtiÚs
->
¶ugš_li¡
 = 
	`¶ugš_İtiÚ_li¡_Ãw
(&İtiÚs->
gc
);

5162 ià(!
	`¶ugš_İtiÚ_li¡_add
(
İtiÚs
->
¶ugš_li¡
, &
p
[1], &İtiÚs->
gc
))

5164 
	`msg
(
msgËv–
, "¶ugš‡dd faed: %s", 
p
[1]);

5165 
”r
;

5169 ià(
	`¡»q
(
p
[0], "mode") &&…[1] && !p[2])

5171 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5172 ià(
	`¡»q
(
p
[1], "p2p"))

5174 
İtiÚs
->
mode
 = 
MODE_POINT_TO_POINT
;

5176 #ià
P2MP_SERVER


5177 ià(
	`¡»q
(
p
[1], "server"))

5179 
İtiÚs
->
mode
 = 
MODE_SERVER
;

5184 
	`msg
(
msgËv–
, "Bad --mod·¿m‘”: %s", 
p
[1]);

5185 
”r
;

5188 ià(
	`¡»q
(
p
[0], "dev") &&…[1] && !p[2])

5190 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5191 
İtiÚs
->
dev
 = 
p
[1];

5193 ià(
	`¡»q
(
p
[0], "dev-type") &&…[1] && !p[2])

5195 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5196 
İtiÚs
->
dev_ty³
 = 
p
[1];

5198 ià(
	`¡»q
(
p
[0], "dev-node") &&…[1] && !p[2])

5200 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5201 
İtiÚs
->
dev_node
 = 
p
[1];

5203 ià(
	`¡»q
(
p
[0], "lladdr") &&…[1] && !p[2])

5205 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5206 ià(
	`mac_addr_§ã
(
p
[1]))

5208 
İtiÚs
->
Îaddr
 = 
p
[1];

5212 
	`msg
(
msgËv–
, "Îadd¸·rm '%s' mu¡ b¨MAC‡dd»ss", 
p
[1]);

5213 
”r
;

5216 ià(
	`¡»q
(
p
[0], "topology") &&…[1] && !p[2])

5218 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5219 
İtiÚs
->
tİŞogy
 = 
	`·r£_tİŞogy
(
p
[1], 
msgËv–
);

5221 ià(
	`¡»q
(
p
[0], "tun-ipv6") && !p[1])

5223 ià(!
puÎ_mode
)

5225 
	`msg
(
M_WARN
, "Note: optionun-ipv6 is ignored because modern operating systems do‚ot‚eed special IPv6un handling‡nymore.");

5228 #ifdeà
ENABLE_IPROUTE


5229 ià(
	`¡»q
(
p
[0], "iproute") &&…[1] && !p[2])

5231 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5232 
rou‹_·th
 = 
p
[1];

5235 ià(
	`¡»q
(
p
[0], "ifconfig") &&…[1] &&…[2] && !p[3])

5237 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5238 ià(
	`_Ü_dns_addr_§ã
(
p
[1], 
İtiÚs
->
®low_puÎ_fqdn
) && ip_or_dns_addr_safe(p[2], options->allow_pull_fqdn))

5240 
İtiÚs
->
ifcÚfig_loÿl
 = 
p
[1];

5241 
İtiÚs
->
ifcÚfig_»mÙe_Ãtmask
 = 
p
[2];

5245 
	`msg
(
msgËv–
, "ifcÚfig…¬m '%s'‡nd '%s' mu¡ bv®id‡dd»s£s", 
p
[1],…[2]);

5246 
”r
;

5249 ià(
	`¡»q
(
p
[0], "ifconfig-ipv6") &&…[1] &&…[2] && !p[3])

5251 
Ãtb™s
;

5253 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5254 ià(
	`g‘_v6_addr
Ğ
p
[1], 
NULL
, &
Ãtb™s
, 
msgËv–
 )

5255 && 
	`v6_addr_§ã
Ğ
p
[2] ) )

5257 ià(
Ãtb™s
 < 64 ||‚etbits > 124)

5259 
	`msg
Ğ
msgËv–
, "ifcÚfig-v6: /Ãtb™ mu¡ bb‘w“À64‡nd 124,‚Ù '/%d'", 
Ãtb™s
 );

5260 
”r
;

5263 
İtiÚs
->
ifcÚfig_v6_loÿl
 = 
	`g‘_v6_addr_no_Ãtb™s
(
p
[1], &İtiÚs->
gc
);

5264 
İtiÚs
->
ifcÚfig_v6_Ãtb™s
 = 
Ãtb™s
;

5265 
İtiÚs
->
ifcÚfig_v6_»mÙe
 = 
p
[2];

5269 
	`msg
(
msgËv–
, "ifcÚfig-v6…¬m '%s'‡nd '%s' mu¡ bv®id‡dd»s£s", 
p
[1],…[2]);

5270 
”r
;

5273 ià(
	`¡»q
(
p
[0], "ifconfig-noexec") && !p[1])

5275 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5276 
İtiÚs
->
ifcÚfig_nÛxec
 = 
Œue
;

5278 ià(
	`¡»q
(
p
[0], "ifconfig-nowarn") && !p[1])

5280 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

5281 
İtiÚs
->
ifcÚfig_now¬n
 = 
Œue
;

5283 ià(
	`¡»q
(
p
[0], "local") &&…[1] && !p[2])

5285 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5286 
İtiÚs
->
û
.
loÿl
 = 
p
[1];

5288 ià(
	`¡»q
(
p
[0], "remote-random") && !p[1])

5290 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5291 
İtiÚs
->
»mÙe_¿ndom
 = 
Œue
;

5293 ià(
	`¡»q
(
p
[0], "connection") &&…[1] && !p[3])

5295 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5296 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

5298 
İtiÚs
 
sub
;

5299 
cÚÃùiÚ_’Œy
 *
e
;

5301 
	`š™_İtiÚs
(&
sub
, 
Œue
);

5302 
sub
.
û
 = 
İtiÚs
->ce;

5303 
	`»ad_cÚfig_¡ršg
("[CONNECTION-OPTIONS]", &
sub
, 
p
[2], 
msgËv–
, 
OPT_P_CONNECTION
, 
İtiÚ_ty³s_found
, 
es
);

5304 ià(!
sub
.
û
.
»mÙe
)

5306 
	`msg
(
msgËv–
, "Each 'connection' block must containƒxactly one 'remote' directive");

5307 
	`unš™_İtiÚs
(&
sub
);

5308 
”r
;

5311 
e
 = 
	`®loc_cÚÃùiÚ_’Œy
(
İtiÚs
, 
msgËv–
);

5312 ià(!
e
)

5314 
	`unš™_İtiÚs
(&
sub
);

5315 
”r
;

5317 *
e
 = 
sub
.
û
;

5318 
	`gc_Œªsãr
(&
İtiÚs
->
gc
, &
sub
.gc);

5319 
	`unš™_İtiÚs
(&
sub
);

5322 ià(
	`¡»q
(
p
[0], "ignore-unknown-option") &&…[1])

5324 
i
;

5325 
j
;

5326 
numignÜed
 = 0;

5327 cÚ¡ **
ignÜe
;

5329 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5331 
i
 = 1; 
p
[i]; i++)

5333 
numignÜed
++;

5337 
i
 = 0; 
İtiÚs
->
ignÜe_unknown_İtiÚ


5338 && 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
]; i++)

5340 
numignÜed
++;

5344 
	`ALLOC_ARRAY_GC
(
ignÜe
, cÚ¡ *, 
numignÜed
+1, &
İtiÚs
->
gc
);

5345 
i
 = 0; 
İtiÚs
->
ignÜe_unknown_İtiÚ


5346 && 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
]; i++)

5348 
ignÜe
[
i
] = 
İtiÚs
->
ignÜe_unknown_İtiÚ
[i];

5351 
İtiÚs
->
ignÜe_unknown_İtiÚ
 = 
ignÜe
;

5353 
j
 = 1; 
p
[j]; j++)

5356 ià(
p
[
j
][0]=='-' &&…[j][1]=='-')

5358 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
] = (
p
[
j
]+2);

5362 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
] = 
p
[
j
];

5364 
i
++;

5367 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
] = 
NULL
;

5369 #ià
ENABLE_MANAGEMENT


5370 ià(
	`¡»q
(
p
[0], "http-proxy-override") &&…[1] &&…[2] && !p[4])

5372 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5373 
İtiÚs
->
h‰p_´oxy_ov”ride
 = 
	`·r£_h‰p_´oxy_ov”ride
(
p
[1],…[2],…[3], 
msgËv–
, &İtiÚs->
gc
);

5374 ià(!
İtiÚs
->
h‰p_´oxy_ov”ride
)

5376 
”r
;

5380 ià(
	`¡»q
(
p
[0], "remote") &&…[1] && !p[4])

5382 
»mÙe_’Œy
 
»
;

5383 
»
.
»mÙe
 =„e.
»mÙe_pÜt
 = 
NULL
;

5384 
»
.
´Ùo
 = -1;

5385 
»
.
af
 = 0;

5387 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5388 
»
.
»mÙe
 = 
p
[1];

5389 ià(
p
[2])

5391 
»
.
»mÙe_pÜt
 = 
p
[2];

5392 ià(
p
[3])

5394 cÚ¡ 
´Ùo
 = 
	`ascii2´Ùo
(
p
[3]);

5395 cÚ¡ 
§_çmy_t
 
af
 = 
	`ascii2af
(
p
[3]);

5396 ià(
´Ùo
 < 0)

5398 
	`msg
(
msgËv–
, "»mÙe: bad…rÙocŞ‡ssocŸ‹d w™h ho¡ %s: '%s'", 
p
[1],…[3]);

5399 
”r
;

5401 
»
.
´Ùo
 =…roto;

5402 
»
.
af
 =‡f;

5405 ià(
³rmissiÚ_mask
 & 
OPT_P_GENERAL
)

5407 
»mÙe_’Œy
 *
e
 = 
	`®loc_»mÙe_’Œy
(
İtiÚs
, 
msgËv–
);

5408 ià(!
e
)

5410 
”r
;

5412 *
e
 = 
»
;

5414 ià(
³rmissiÚ_mask
 & 
OPT_P_CONNECTION
)

5416 
	`cÚÃùiÚ_’Œy_lßd_»
(&
İtiÚs
->
û
, &
»
);

5419 ià(
	`¡»q
(
p
[0], "resolv-retry") &&…[1] && !p[2])

5421 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5422 ià(
	`¡»q
(
p
[1], "infinite"))

5424 
İtiÚs
->
»sŞve_»Œy_£cÚds
 = 
RESOLV_RETRY_INFINITE
;

5428 
İtiÚs
->
»sŞve_»Œy_£cÚds
 = 
	`pos™ive_©oi
(
p
[1]);

5431 ià((
	`¡»q
(
p
[0], "preresolve") || streq(p[0], "ip-remote-hint")) && !p[2])

5433 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5434 
İtiÚs
->
»sŞve_š_advªû
 = 
Œue
;

5437 ià(
p
[1])

5439 
İtiÚs
->
_»mÙe_hšt
 = 
p
[1];

5442 ià(
	`¡»q
(
p
[0], "connect-retry") &&…[1] && !p[3])

5444 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5445 
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds
 = 
	`pos™ive_©oi
(
p
[1]);

5450 ià(
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds
 > 0xFFFF)

5452 
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds
 = 0xFFFF;

5453 
	`msg
(
M_WARN
, "connect„etry wait intervalruncatedo %d",

5454 
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds
);

5457 ià(
p
[2])

5459 
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds_max
 =

5460 
	`max_št
(
	`pos™ive_©oi
(
p
[2]), 
İtiÚs
->
û
.
cÚÃù_»Œy_£cÚds
);

5463 ià((
	`¡»q
(
p
[0], "connect-timeout") || streq(p[0], "server-poll-timeout"))

5464 && 
p
[1] && !p[2])

5466 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5467 
İtiÚs
->
û
.
cÚÃù_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

5469 ià(
	`¡»q
(
p
[0], "connect-retry-max") &&…[1] && !p[2])

5471 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5472 
İtiÚs
->
cÚÃù_»Œy_max
 = 
	`pos™ive_©oi
(
p
[1]);

5474 ià(
	`¡»q
(
p
[0], "ipchange") &&…[1])

5476 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

5477 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

5479 
”r
;

5481 
	`£t_u£r_süt
(
İtiÚs
,

5482 &
İtiÚs
->
chªge
,

5483 
	`¡ršg_sub¡™u‹
(
p
[1], ',', ' ', &
İtiÚs
->
gc
),

5484 "chªge", 
Œue
);

5486 ià(
	`¡»q
(
p
[0], "float") && !p[1])

5488 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5489 
İtiÚs
->
û
.
»mÙe_æßt
 = 
Œue
;

5491 #ifdeà
ENABLE_DEBUG


5492 ià(
	`¡»q
(
p
[0], "gremlin") &&…[1] && !p[2])

5494 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5495 
İtiÚs
->
g»mlš
 = 
	`pos™ive_©oi
(
p
[1]);

5498 ià(
	`¡»q
(
p
[0], "chroot") &&…[1] && !p[2])

5500 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5501 
İtiÚs
->
chroÙ_dœ
 = 
p
[1];

5503 ià(
	`¡»q
(
p
[0], "cd") &&…[1] && !p[2])

5505 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5506 ià(
	`¶©fÜm_chdœ
(
p
[1]))

5508 
	`msg
(
M_ERR
, "cdØ'%s' faed", 
p
[1]);

5509 
”r
;

5511 
İtiÚs
->
cd_dœ
 = 
p
[1];

5513 #ifdeà
ENABLE_SELINUX


5514 ià(
	`¡»q
(
p
[0], "setcon") &&…[1] && !p[2])

5516 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5517 
İtiÚs
->
£lšux_cÚ‹xt
 = 
p
[1];

5520 ià(
	`¡»q
(
p
[0], "writepid") &&…[1] && !p[2])

5522 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5523 
İtiÚs
->
wr™•id
 = 
p
[1];

5525 ià(
	`¡»q
(
p
[0], "up") &&…[1])

5527 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

5528 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

5530 
”r
;

5532 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
up_süt
, 
p
[1], "up", 
çl£
);

5534 ià(
	`¡»q
(
p
[0], "down") &&…[1])

5536 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

5537 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

5539 
”r
;

5541 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
down_süt
, 
p
[1], "down", 
Œue
);

5543 ià(
	`¡»q
(
p
[0], "down-pre") && !p[1])

5545 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5546 
İtiÚs
->
down_´e
 = 
Œue
;

5548 ià(
	`¡»q
(
p
[0], "up-delay") && !p[1])

5550 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5551 
İtiÚs
->
up_d–ay
 = 
Œue
;

5553 ià(
	`¡»q
(
p
[0], "up-restart") && !p[1])

5555 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5556 
İtiÚs
->
up_»¡¬t
 = 
Œue
;

5558 ià(
	`¡»q
(
p
[0], "syslog") && !p[2])

5560 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5561 
	`İ’_sy¦og
(
p
[1], 
çl£
);

5563 ià(
	`¡»q
(
p
[0], "daemon") && !p[2])

5565 
boŞ
 
did™
 = 
çl£
;

5566 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5567 ià(!
İtiÚs
->
d«mÚ
)

5569 
İtiÚs
->
d«mÚ
 = 
did™
 = 
Œue
;

5570 
	`İ’_sy¦og
(
p
[1], 
çl£
);

5572 ià(
p
[1])

5574 ià(!
did™
)

5576 
	`msg
(
M_WARN
, "WARNING: MuÉË --d«mÚ dœeùive ¥ecif›d, ignÜšg --d«mÚ %s. (NÙth© in™süt som‘ime addheœ owÀ--d«mÚ dœeùive.)", 
p
[1]);

5577 
”r
;

5581 ià(
	`¡»q
(
p
[0], "inetd") && !p[3])

5583 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5584 ià(!
İtiÚs
->
š‘d
)

5586 
z
;

5587 cÚ¡ *
Çme
 = 
NULL
;

5588 cÚ¡ *
İ‹¼
 = "when --inetd is used withwo…arameters, one ofhem must be 'wait' or 'nowait'‡ndhe other must be‡ daemon‚ameo use for system†ogging";

5590 
İtiÚs
->
š‘d
 = -1;

5592 
z
 = 1; z <= 2; ++z)

5594 ià(
p
[
z
])

5596 ià(
	`¡»q
(
p
[
z
], "wait"))

5598 ià(
İtiÚs
->
š‘d
 != -1)

5600 
	`msg
(
msgËv–
, "%s", 
İ‹¼
);

5601 
”r
;

5605 
İtiÚs
->
š‘d
 = 
INETD_WAIT
;

5608 ià(
	`¡»q
(
p
[
z
], "nowait"))

5610 ià(
İtiÚs
->
š‘d
 != -1)

5612 
	`msg
(
msgËv–
, "%s", 
İ‹¼
);

5613 
”r
;

5617 
İtiÚs
->
š‘d
 = 
INETD_NOWAIT
;

5622 ià(
Çme
 !ğ
NULL
)

5624 
	`msg
(
msgËv–
, "%s", 
İ‹¼
);

5625 
”r
;

5627 
Çme
 = 
p
[
z
];

5633 ià(
İtiÚs
->
š‘d
 == -1)

5635 
İtiÚs
->
š‘d
 = 
INETD_WAIT
;

5638 
	`§ve_š‘d_sock‘_desütÜ
();

5639 
	`İ’_sy¦og
(
Çme
, 
Œue
);

5642 ià(
	`¡»q
(
p
[0], "log") &&…[1] && !p[2])

5644 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5645 
İtiÚs
->
log
 = 
Œue
;

5646 
	`»dœeù_¡dout_¡d”r
(
p
[1], 
çl£
);

5648 ià(
	`¡»q
(
p
[0], "suppress-timestamps") && !p[1])

5650 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5651 
İtiÚs
->
suµ»ss_time¡amps
 = 
Œue
;

5652 
	`£t_suµ»ss_time¡amps
(
Œue
);

5654 ià(
	`¡»q
(
p
[0], "machine-readable-output") && !p[1])

5656 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5657 
İtiÚs
->
machše_»adabË_ouut
 = 
Œue
;

5658 
	`£t_machše_»adabË_ouut
(
Œue
);

5660 ià(
	`¡»q
(
p
[0], "log-append") &&…[1] && !p[2])

5662 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5663 
İtiÚs
->
log
 = 
Œue
;

5664 
	`»dœeù_¡dout_¡d”r
(
p
[1], 
Œue
);

5666 #ifdeà
ENABLE_MEMSTATS


5667 ià(
	`¡»q
(
p
[0], "memstats") &&…[1] && !p[2])

5669 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5670 
İtiÚs
->
mem¡©s_â
 = 
p
[1];

5673 ià(
	`¡»q
(
p
[0], "mlock") && !p[1])

5675 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5676 
İtiÚs
->
mlock
 = 
Œue
;

5678 #ià
ENABLE_IP_PKTINFO


5679 ià(
	`¡»q
(
p
[0], "multihome") && !p[1])

5681 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5682 
İtiÚs
->
sockæags
 |ğ
SF_USE_IP_PKTINFO
;

5685 ià(
	`¡»q
(
p
[0], "verb") &&…[1] && !p[2])

5687 
	`VERIFY_PERMISSION
(
OPT_P_MESSAGES
);

5688 
İtiÚs
->
v”bos™y
 = 
	`pos™ive_©oi
(
p
[1]);

5689 #ià!
	`defšed
(
ENABLE_DEBUG
è&& !defšed(
ENABLE_SMALL
)

5691 ià(
İtiÚs
->
v”bos™y
 >= 7)

5693 
	`msg
(
M_WARN
, "NOTE: debug verbosity (--verb %d) isƒnabled buthis build†acks debug support.",

5694 
İtiÚs
->
v”bos™y
);

5698 ià(
	`¡»q
(
p
[0], "mute") &&…[1] && !p[2])

5700 
	`VERIFY_PERMISSION
(
OPT_P_MESSAGES
);

5701 
İtiÚs
->
mu‹
 = 
	`pos™ive_©oi
(
p
[1]);

5703 ià(
	`¡»q
(
p
[0], "errors-to-stderr") && !p[1])

5705 
	`VERIFY_PERMISSION
(
OPT_P_MESSAGES
);

5706 
	`”rÜs_to_¡d”r
();

5708 ià(
	`¡»q
(
p
[0], "status") &&…[1] && !p[3])

5710 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5711 
İtiÚs
->
¡©us_fe
 = 
p
[1];

5712 ià(
p
[2])

5714 
İtiÚs
->
¡©us_fe_upd©e_äeq
 = 
	`pos™ive_©oi
(
p
[2]);

5717 ià(
	`¡»q
(
p
[0], "status-version") &&…[1] && !p[2])

5719 
v”siÚ
;

5721 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5722 
v”siÚ
 = 
	`©oi
(
p
[1]);

5723 ià(
v”siÚ
 < 1 || version > 3)

5725 
	`msg
(
msgËv–
, "--status-version must be 1o 3");

5726 
”r
;

5728 
İtiÚs
->
¡©us_fe_v”siÚ
 = 
v”siÚ
;

5730 ià(
	`¡»q
(
p
[0], "remap-usr1") &&…[1] && !p[2])

5732 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5733 ià(
	`¡»q
(
p
[1], "SIGHUP"))

5735 
İtiÚs
->
»m­_sigu¤1
 = 
SIGHUP
;

5737 ià(
	`¡»q
(
p
[1], "SIGTERM"))

5739 
İtiÚs
->
»m­_sigu¤1
 = 
SIGTERM
;

5743 
	`msg
(
msgËv–
, "--remap-usr1…arm must be 'SIGHUP' or 'SIGTERM'");

5744 
”r
;

5747 ià((
	`¡»q
(
p
[0], "link-mtu") || streq(p[0], "udp-mtu")) &&…[1] && !p[2])

5749 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5750 
İtiÚs
->
û
.
lšk_mtu
 = 
	`pos™ive_©oi
(
p
[1]);

5751 
İtiÚs
->
û
.
lšk_mtu_defšed
 = 
Œue
;

5753 ià(
	`¡»q
(
p
[0], "tun-mtu") &&…[1] && !p[2])

5755 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5756 
İtiÚs
->
û
.
tun_mtu
 = 
	`pos™ive_©oi
(
p
[1]);

5757 
İtiÚs
->
û
.
tun_mtu_defšed
 = 
Œue
;

5759 ià(
	`¡»q
(
p
[0], "tun-mtu-extra") &&…[1] && !p[2])

5761 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5762 
İtiÚs
->
û
.
tun_mtu_exŒa
 = 
	`pos™ive_©oi
(
p
[1]);

5763 
İtiÚs
->
û
.
tun_mtu_exŒa_defšed
 = 
Œue
;

5765 #ifdeà
ENABLE_FRAGMENT


5766 ià(
	`¡»q
(
p
[0], "mtu-dynamic"))

5768 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5769 
	`msg
(
msgËv–
, "--mtu-dynamic has been„eplaced by --fragment");

5770 
”r
;

5772 ià(
	`¡»q
(
p
[0], "fragment") &&…[1] && !p[2])

5775 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5776 
İtiÚs
->
û
.
äagm’t
 = 
	`pos™ive_©oi
(
p
[1]);

5779 ià(
	`¡»q
(
p
[0], "mtu-disc") &&…[1] && !p[2])

5781 
	`VERIFY_PERMISSION
(
OPT_P_MTU
|
OPT_P_CONNECTION
);

5782 
İtiÚs
->
û
.
mtu_discov”_ty³
 = 
	`Œª¦©e_mtu_discov”_ty³_Çme
(
p
[1]);

5784 #ifdeà
ENABLE_OCC


5785 ià(
	`¡»q
(
p
[0], "mtu-test") && !p[1])

5787 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5788 
İtiÚs
->
mtu_‹¡
 = 
Œue
;

5791 ià(
	`¡»q
(
p
[0], "nice") &&…[1] && !p[2])

5793 
	`VERIFY_PERMISSION
(
OPT_P_NICE
);

5794 
İtiÚs
->
niû
 = 
	`©oi
(
p
[1]);

5796 ià(
	`¡»q
(
p
[0], "rcvbuf") &&…[1] && !p[2])

5798 
	`VERIFY_PERMISSION
(
OPT_P_SOCKBUF
);

5799 
İtiÚs
->
rcvbuf
 = 
	`pos™ive_©oi
(
p
[1]);

5801 ià(
	`¡»q
(
p
[0], "sndbuf") &&…[1] && !p[2])

5803 
	`VERIFY_PERMISSION
(
OPT_P_SOCKBUF
);

5804 
İtiÚs
->
¢dbuf
 = 
	`pos™ive_©oi
(
p
[1]);

5806 ià(
	`¡»q
(
p
[0], "mark") &&…[1] && !p[2])

5808 #ià
	`defšed
(
TARGET_LINUX
è&& 
HAVE_DECL_SO_MARK


5809 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5810 
İtiÚs
->
m¬k
 = 
	`©oi
(
p
[1]);

5813 ià(
	`¡»q
(
p
[0], "socket-flags"))

5815 
j
;

5816 
	`VERIFY_PERMISSION
(
OPT_P_SOCKFLAGS
);

5817 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j]; ++j)

5819 ià(
	`¡»q
(
p
[
j
], "TCP_NODELAY"))

5821 
İtiÚs
->
sockæags
 |ğ
SF_TCP_NODELAY
;

5825 
	`msg
(
msgËv–
, "unknowÀsock‘ fÏg: %s", 
p
[
j
]);

5829 ià(
	`¡»q
(
p
[0], "txqueuelen") &&…[1] && !p[2])

5831 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5832 #ifdeà
TARGET_LINUX


5833 
İtiÚs
->
tuÁ­_İtiÚs
.
txqueu–’
 = 
	`pos™ive_©oi
(
p
[1]);

5835 
	`msg
(
msgËv–
, "--txqueuelen‚ot supported onhis OS");

5836 
”r
;

5839 ià(
	`¡»q
(
p
[0], "shaper") &&…[1] && !p[2])

5841 #ifdeà
ENABLE_FEATURE_SHAPER


5842 
sh­”
;

5844 
	`VERIFY_PERMISSION
(
OPT_P_SHAPER
);

5845 
sh­”
 = 
	`©oi
(
p
[1]);

5846 ià(
sh­”
 < 
SHAPER_MIN
 || sh­” > 
SHAPER_MAX
)

5848 
	`msg
(
msgËv–
, "Bad shaper value, must be between %d‡nd %d",

5849 
SHAPER_MIN
, 
SHAPER_MAX
);

5850 
”r
;

5852 
İtiÚs
->
sh­”
 = shaper;

5854 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5855 
	`msg
(
msgËv–
, "--shaper„equireshe gettimeofday() function which is missing");

5856 
”r
;

5859 ià(
	`¡»q
(
p
[0], "port") &&…[1] && !p[2])

5861 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5862 
İtiÚs
->
û
.
loÿl_pÜt
 = o±iÚs->û.
»mÙe_pÜt
 = 
p
[1];

5864 ià(
	`¡»q
(
p
[0], "lport") &&…[1] && !p[2])

5866 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5867 
İtiÚs
->
û
.
loÿl_pÜt_defšed
 = 
Œue
;

5868 
İtiÚs
->
û
.
loÿl_pÜt
 = 
p
[1];

5870 ià(
	`¡»q
(
p
[0], "rport") &&…[1] && !p[2])

5872 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5873 
İtiÚs
->
û
.
»mÙe_pÜt
 = 
p
[1];

5875 ià(
	`¡»q
(
p
[0], "bind") && !p[2])

5877 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5878 
İtiÚs
->
û
.
bšd_defšed
 = 
Œue
;

5879 ià(
p
[1] && 
	`¡»q
(p[1], "ipv6only"))

5881 
İtiÚs
->
û
.
bšd_v6_Úly
 = 
Œue
;

5885 ià(
	`¡»q
(
p
[0], "nobind") && !p[1])

5887 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5888 
İtiÚs
->
û
.
bšd_loÿl
 = 
çl£
;

5890 ià(
	`¡»q
(
p
[0], "fast-io") && !p[1])

5892 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5893 
İtiÚs
->
ç¡_io
 = 
Œue
;

5895 ià(
	`¡»q
(
p
[0], "inactive") &&…[1] && !p[3])

5897 
	`VERIFY_PERMISSION
(
OPT_P_TIMER
);

5898 
İtiÚs
->
šaùiv™y_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

5899 ià(
p
[2])

5901 
İtiÚs
->
šaùiv™y_mšimum_by‹s
 = 
	`pos™ive_©oi
(
p
[2]);

5904 ià(
	`¡»q
(
p
[0], "proto") &&…[1] && !p[2])

5906 
´Ùo
;

5907 
§_çmy_t
 
af
;

5908 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5909 
´Ùo
 = 
	`ascii2´Ùo
(
p
[1]);

5910 
af
 = 
	`ascii2af
(
p
[1]);

5911 ià(
´Ùo
 < 0)

5913 
	`msg
(
msgËv–
, "Bad…rotocol: '%s'. Allowed…rotocols with --proto option: %s",

5914 
p
[1],

5915 
	`´Ùo2ascii_®l
(&
gc
));

5916 
”r
;

5918 
İtiÚs
->
û
.
´Ùo
 =…roto;

5919 
İtiÚs
->
û
.
af
 =‡f;

5921 ià(
	`¡»q
(
p
[0], "proto-force") &&…[1] && !p[2])

5923 
´Ùo_fÜû
;

5924 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5925 
´Ùo_fÜû
 = 
	`ascii2´Ùo
(
p
[1]);

5926 ià(
´Ùo_fÜû
 < 0)

5928 
	`msg
(
msgËv–
, "Bad --´Ùo-fÜû…rÙocŞ: '%s'", 
p
[1]);

5929 
”r
;

5931 
İtiÚs
->
´Ùo_fÜû
 =…roto_force;

5933 ià(
	`¡»q
(
p
[0], "http-proxy") &&…[1] && !p[5])

5935 
h‰p_´oxy_İtiÚs
 *
ho
;

5937 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5940 ià(!
p
[2])

5942 
	`msg
(
msgËv–
, "http-proxy…ort‚umber‚ot defined");

5943 
”r
;

5946 
ho
 = 
	`š™_h‰p_´oxy_İtiÚs_Úû
(&
İtiÚs
->
û
.
h‰p_´oxy_İtiÚs
, &İtiÚs->
gc
);

5948 
ho
->
£rv”
 = 
p
[1];

5949 
ho
->
pÜt
 = 
p
[2];

5952 ià(
p
[3])

5957 ià(
	`¡»q
(
p
[3], "auto"))

5959 
ho
->
auth_»Œy
 = 
PAR_ALL
;

5961 ià(
	`¡»q
(
p
[3], "auto-nct"))

5963 
ho
->
auth_»Œy
 = 
PAR_NCT
;

5967 
ho
->
auth_m‘hod_¡ršg
 = "basic";

5968 
ho
->
auth_fe
 = 
p
[3];

5970 ià(
p
[4])

5972 
ho
->
auth_m‘hod_¡ršg
 = 
p
[4];

5978 
ho
->
auth_m‘hod_¡ršg
 = "none";

5981 ià(
	`¡»q
(
p
[0], "http-proxy-user-pass") &&…[1])

5983 
h‰p_´oxy_İtiÚs
 *
ho
;

5984 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

5985 
ho
 = 
	`š™_h‰p_´oxy_İtiÚs_Úû
(&
İtiÚs
->
û
.
h‰p_´oxy_İtiÚs
, &İtiÚs->
gc
);

5986 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

5988 
ho
->
auth_fe
 = 
p
[2];

5989 
ho
->
šlše_üeds
 = 
Œue
;

5993 
ho
->
auth_fe
 = 
p
[1];

5996 ià(
	`¡»q
(
p
[0], "http-proxy-retry") || streq(p[0], "socks-proxy-retry"))

5998 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

5999 
	`msg
(
M_WARN
, "DEPRECATED OPTION: http-proxy-retry‡nd socks-proxy-retry: "

6003 ià(
	`¡»q
(
p
[0], "http-proxy-timeout") &&…[1] && !p[2])

6005 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

6006 
	`msg
(
M_WARN
, "DEPRECATED OPTION: http-proxy-timeout: In OpenVPN 2.4heimeout until‡ connectiono‡ "

6009 ià(
	`¡»q
(
p
[0], "http-proxy-option") &&…[1] && !p[4])

6011 
h‰p_´oxy_İtiÚs
 *
ho
;

6013 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

6014 
ho
 = 
	`š™_h‰p_´oxy_İtiÚs_Úû
(&
İtiÚs
->
û
.
h‰p_´oxy_İtiÚs
, &İtiÚs->
gc
);

6016 ià(
	`¡»q
(
p
[1], "VERSION") &&…[2] && !p[3])

6018 
ho
->
h‰p_v”siÚ
 = 
p
[2];

6020 ià(
	`¡»q
(
p
[1], "AGENT") &&…[2] && !p[3])

6022 
ho
->
u£r_ag’t
 = 
p
[2];

6024 ià((
	`¡»q
(
p
[1], "EXT1") || streq(p[1], "EXT2") || streq(p[1], "CUSTOM-HEADER"))

6025 && 
p
[2])

6030 
h‰p_cu¡om_h—d”
 *
cu¡om_h—d”
 = 
NULL
;

6031 
i
;

6033 
i
 = 0; i < 
MAX_CUSTOM_HTTP_HEADER
; i++)

6035 ià(!
ho
->
cu¡om_h—d”s
[
i
].
Çme
)

6037 
cu¡om_h—d”
 = &
ho
->
cu¡om_h—d”s
[
i
];

6041 ià(!
cu¡om_h—d”
)

6043 
	`msg
(
msgËv–
, "CªnÙ u£ mÜthª %d h‰p-´oxy-İtiÚ CUSTOM-HEADER : '%s'", 
MAX_CUSTOM_HTTP_HEADER
, 
p
[1]);

6049 
cu¡om_h—d”
->
Çme
 = 
p
[2];

6050 
cu¡om_h—d”
->
cÚ‹Á
 = 
p
[3];

6055 
	`msg
(
msgËv–
, "Bad h‰p-´oxy-İtiÚ o¸missšg o¸exŒ¨·¿m‘”: '%s'", 
p
[1]);

6058 ià(
	`¡»q
(
p
[0], "socks-proxy") &&…[1] && !p[4])

6060 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

6062 ià(
p
[2])

6064 
İtiÚs
->
û
.
socks_´oxy_pÜt
 = 
p
[2];

6068 
İtiÚs
->
û
.
socks_´oxy_pÜt
 = "1080";

6070 
İtiÚs
->
û
.
socks_´oxy_£rv”
 = 
p
[1];

6071 
İtiÚs
->
û
.
socks_´oxy_authfe
 = 
p
[3];

6073 ià(
	`¡»q
(
p
[0], "keepalive") &&…[1] &&…[2] && !p[3])

6075 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6076 
İtiÚs
->
k“·live_pšg
 = 
	`©oi
(
p
[1]);

6077 
İtiÚs
->
k“·live_timeout
 = 
	`©oi
(
p
[2]);

6079 ià(
	`¡»q
(
p
[0], "ping") &&…[1] && !p[2])

6081 
	`VERIFY_PERMISSION
(
OPT_P_TIMER
);

6082 
İtiÚs
->
pšg_£nd_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

6084 ià(
	`¡»q
(
p
[0], "ping-exit") &&…[1] && !p[2])

6086 
	`VERIFY_PERMISSION
(
OPT_P_TIMER
);

6087 
İtiÚs
->
pšg_»c_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

6088 
İtiÚs
->
pšg_»c_timeout_aùiÚ
 = 
PING_EXIT
;

6090 ià(
	`¡»q
(
p
[0], "ping-restart") &&…[1] && !p[2])

6092 
	`VERIFY_PERMISSION
(
OPT_P_TIMER
);

6093 
İtiÚs
->
pšg_»c_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

6094 
İtiÚs
->
pšg_»c_timeout_aùiÚ
 = 
PING_RESTART
;

6096 ià(
	`¡»q
(
p
[0], "ping-timer-rem") && !p[1])

6098 
	`VERIFY_PERMISSION
(
OPT_P_TIMER
);

6099 
İtiÚs
->
pšg_tim”_»mÙe
 = 
Œue
;

6101 #ifdeà
ENABLE_OCC


6102 ià(
	`¡»q
(
p
[0], "explicit-exit-notify") && !p[2])

6104 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
|
OPT_P_EXPLICIT_NOTIFY
);

6105 ià(
p
[1])

6107 
İtiÚs
->
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
 = 
	`pos™ive_©oi
(
p
[1]);

6111 
İtiÚs
->
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
 = 1;

6115 ià(
	`¡»q
(
p
[0], "persist-tun") && !p[1])

6117 
	`VERIFY_PERMISSION
(
OPT_P_PERSIST
);

6118 
İtiÚs
->
³rsi¡_tun
 = 
Œue
;

6120 ià(
	`¡»q
(
p
[0], "persist-key") && !p[1])

6122 
	`VERIFY_PERMISSION
(
OPT_P_PERSIST
);

6123 
İtiÚs
->
³rsi¡_key
 = 
Œue
;

6125 ià(
	`¡»q
(
p
[0], "persist-local-ip") && !p[1])

6127 
	`VERIFY_PERMISSION
(
OPT_P_PERSIST_IP
);

6128 
İtiÚs
->
³rsi¡_loÿl_
 = 
Œue
;

6130 ià(
	`¡»q
(
p
[0], "persist-remote-ip") && !p[1])

6132 
	`VERIFY_PERMISSION
(
OPT_P_PERSIST_IP
);

6133 
İtiÚs
->
³rsi¡_»mÙe_
 = 
Œue
;

6135 ià(
	`¡»q
(
p
[0], "client-nat") &&…[1] &&…[2] &&…[3] &&…[4] && !p[5])

6137 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE
);

6138 
	`úŞ_check_®loc
(
İtiÚs
);

6139 
	`add_ş›Á_Çt_to_İtiÚ_li¡
(
İtiÚs
->
ş›Á_Çt
, 
p
[1],…[2],…[3],…[4], 
msgËv–
);

6141 ià(
	`¡»q
(
p
[0], "route") &&…[1] && !p[5])

6143 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE
);

6144 
	`rŞ_check_®loc
(
İtiÚs
);

6145 ià(
puÎ_mode
)

6147 ià(!
	`_Ü_dns_addr_§ã
(
p
[1], 
İtiÚs
->
®low_puÎ_fqdn
è&& !
	`is_¥ecŸl_addr
(p[1]))

6149 
	`msg
(
msgËv–
, "rou‹…¬am‘”‚‘wÜk/IP '%s' mu¡ b¨v®id‡dd»ss", 
p
[1]);

6150 
”r
;

6152 ià(
p
[2] && !
	`_addr_dÙ‹d_quad_§ã
(p[2]))

6154 
	`msg
(
msgËv–
, "rou‹…¬am‘”‚‘mask '%s' mu¡ bª IP‡dd»ss", 
p
[2]);

6155 
”r
;

6157 ià(
p
[3] && !
	`_Ü_dns_addr_§ã
Õ[3], 
İtiÚs
->
®low_puÎ_fqdn
è&& !
	`is_¥ecŸl_addr
(p[3]))

6159 
	`msg
(
msgËv–
, "rou‹…¬am‘” g©eway '%s' mu¡ b¨v®id‡dd»ss", 
p
[3]);

6160 
”r
;

6163 
	`add_rou‹_to_İtiÚ_li¡
(
İtiÚs
->
rou‹s
, 
p
[1],…[2],…[3],…[4]);

6165 ià(
	`¡»q
(
p
[0], "route-ipv6") &&…[1] && !p[4])

6167 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE
);

6168 
	`rŞ6_check_®loc
(
İtiÚs
);

6169 ià(
puÎ_mode
)

6171 ià(!
	`v6_addr_§ã_hex¶usb™s
(
p
[1]))

6173 
	`msg
(
msgËv–
, "rou‹-v6…¬am‘”‚‘wÜk/IP '%s' mu¡ b¨v®id‡dd»ss", 
p
[1]);

6174 
”r
;

6176 ià(
p
[2] && !
	`v6_addr_§ã
(p[2]))

6178 
	`msg
(
msgËv–
, "rou‹-v6…¬am‘” g©eway '%s' mu¡ b¨v®id‡dd»ss", 
p
[2]);

6179 
”r
;

6183 
	`add_rou‹_v6_to_İtiÚ_li¡
(
İtiÚs
->
rou‹s_v6
, 
p
[1],…[2],…[3]);

6185 ià(
	`¡»q
(
p
[0], "max-routes") && !p[2])

6187 
	`msg
(
M_WARN
, "DEPRECATED OPTION: --max-routes option ignored."

6192 ià(
	`¡»q
(
p
[0], "route-gateway") &&…[1] && !p[2])

6194 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE_EXTRAS
);

6195 ià(
	`¡»q
(
p
[1], "dhcp"))

6197 
İtiÚs
->
rou‹_g©eway_vŸ_dhı
 = 
Œue
;

6201 ià(
	`_Ü_dns_addr_§ã
(
p
[1], 
İtiÚs
->
®low_puÎ_fqdn
è|| 
	`is_¥ecŸl_addr
(p[1]))

6203 
İtiÚs
->
rou‹_deçuÉ_g©eway
 = 
p
[1];

6207 
	`msg
(
msgËv–
, "rou‹-g©eway…¬m '%s' mu¡ b¨v®id‡dd»ss", 
p
[1]);

6208 
”r
;

6212 ià(
	`¡»q
(
p
[0], "route-metric") &&…[1] && !p[2])

6214 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE
);

6215 
İtiÚs
->
rou‹_deçuÉ_m‘ric
 = 
	`pos™ive_©oi
(
p
[1]);

6217 ià(
	`¡»q
(
p
[0], "route-delay") && !p[3])

6219 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE_EXTRAS
);

6220 
İtiÚs
->
rou‹_d–ay_defšed
 = 
Œue
;

6221 ià(
p
[1])

6223 
İtiÚs
->
rou‹_d–ay
 = 
	`pos™ive_©oi
(
p
[1]);

6224 ià(
p
[2])

6226 
İtiÚs
->
rou‹_d–ay_wšdow
 = 
	`pos™ive_©oi
(
p
[2]);

6231 
İtiÚs
->
rou‹_d–ay
 = 0;

6234 ià(
	`¡»q
(
p
[0], "route-up") &&…[1])

6236 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6237 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

6239 
”r
;

6241 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
rou‹_süt
, 
p
[1], "rou‹-up", 
çl£
);

6243 ià(
	`¡»q
(
p
[0], "route-pre-down") &&…[1])

6245 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6246 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

6248 
”r
;

6250 
	`£t_u£r_süt
(
İtiÚs
,

6251 &
İtiÚs
->
rou‹_´edown_süt
,

6252 
p
[1],

6253 "rou‹-´e-down", 
Œue
);

6255 ià(
	`¡»q
(
p
[0], "route-noexec") && !p[1])

6257 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6258 
İtiÚs
->
rou‹_nÛxec
 = 
Œue
;

6260 ià(
	`¡»q
(
p
[0], "route-nopull") && !p[1])

6262 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6263 
İtiÚs
->
rou‹_nİuÎ
 = 
Œue
;

6265 ià(
	`¡»q
(
p
[0], "pull-filter") &&…[1] &&…[2] && !p[3])

6267 
puÎ_f‹r
 *
f
;

6268 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
)

6269 
f
 = 
	`®loc_puÎ_f‹r
(
İtiÚs
, 
msgËv–
);

6271 ià(
	`¡rcmp
("acû±", 
p
[1]) == 0)

6273 
f
->
ty³
 = 
PUF_TYPE_ACCEPT
;

6275 ià(
	`¡rcmp
("ignÜe", 
p
[1]) == 0)

6277 
f
->
ty³
 = 
PUF_TYPE_IGNORE
;

6279 ià(
	`¡rcmp
("»jeù", 
p
[1]) == 0)

6281 
f
->
ty³
 = 
PUF_TYPE_REJECT
;

6285 
	`msg
(
msgËv–
, "UnknowÀ--puÎ-f‹¸ty³: %s", 
p
[1]);

6286 
”r
;

6288 
f
->
·‰”n
 = 
p
[2];

6289 
f
->
size
 = 
	`¡¾’
(
p
[2]);

6291 ià(
	`¡»q
(
p
[0], "allow-pull-fqdn") && !p[1])

6293 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6294 
İtiÚs
->
®low_puÎ_fqdn
 = 
Œue
;

6296 ià(
	`¡»q
(
p
[0], "redirect-gateway") || streq(p[0], "redirect-private"))

6298 
j
;

6299 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE
);

6300 
	`rŞ_check_®loc
(
İtiÚs
);

6301 ià(
	`¡»q
(
p
[0], "redirect-gateway"))

6303 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_REROUTE_GW
;

6305 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

6307 ià(
	`¡»q
(
p
[
j
], "local"))

6309 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_LOCAL
;

6311 ià(
	`¡»q
(
p
[
j
], "autolocal"))

6313 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_AUTO_LOCAL
;

6315 ià(
	`¡»q
(
p
[
j
], "def1"))

6317 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_DEF1
;

6319 ià(
	`¡»q
(
p
[
j
], "bypass-dhcp"))

6321 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_BYPASS_DHCP
;

6323 ià(
	`¡»q
(
p
[
j
], "bypass-dns"))

6325 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_BYPASS_DNS
;

6327 ià(
	`¡»q
(
p
[
j
], "block-local"))

6329 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_BLOCK_LOCAL
;

6331 ià(
	`¡»q
(
p
[
j
], "ipv6"))

6333 
	`rŞ6_check_®loc
(
İtiÚs
);

6334 
İtiÚs
->
rou‹s_v6
->
æags
 |ğ
RG_REROUTE_GW
;

6336 ià(
	`¡»q
(
p
[
j
], "!ipv4"))

6338 
İtiÚs
->
rou‹s
->
æags
 &ğ~
RG_REROUTE_GW
;

6342 
	`msg
(
msgËv–
, "unknowÀ--% æag: %s", 
p
[0],…[
j
]);

6343 
”r
;

6346 #ifdeà
_WIN32


6348 
	`»m­_»dœeù_g©eway_æags
(
İtiÚs
);

6350 
İtiÚs
->
rou‹s
->
æags
 |ğ
RG_ENABLE
;

6352 ià(
	`¡»q
(
p
[0], "remote-random-hostname") && !p[1])

6354 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6355 
İtiÚs
->
sockæags
 |ğ
SF_HOST_RANDOMIZE
;

6357 ià(
	`¡»q
(
p
[0], "setenv") &&…[1] && !p[3])

6359 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6360 ià(
	`¡»q
(
p
[1], "REMOTE_RANDOM_HOSTNAME") && !p[2])

6362 
İtiÚs
->
sockæags
 |ğ
SF_HOST_RANDOMIZE
;

6364 ià(
	`¡»q
(
p
[1], "GENERIC_CONFIG"))

6366 
	`msg
(
msgËv–
, "this is‡ generic configuration‡nd cannot directly be used");

6367 
”r
;

6369 #ifdeà
ENABLE_PUSH_PEER_INFO


6370 ià(
	`¡»q
(
p
[1], "PUSH_PEER_INFO") && !p[2])

6372 
İtiÚs
->
push_³”_šfo
 = 
Œue
;

6375 ià(
	`¡»q
(
p
[1], "SERVER_POLL_TIMEOUT") &&…[2])

6377 
İtiÚs
->
û
.
cÚÃù_timeout
 = 
	`pos™ive_©oi
(
p
[2]);

6381 ià(
	`¡»q
(
p
[1], "FORWARD_COMPATIBLE") &&…[2] && streq(p[2], "1"))

6383 
İtiÚs
->
fÜw¬d_com·tibË
 = 
Œue
;

6384 
msgËv–_fc
 = 
	`msgËv–_fÜw¬d_com·tibË
(
İtiÚs
, 
msgËv–
);

6386 
	`£‹nv_¡r
(
es
, 
p
[1],…[2] ?…[2] : "");

6389 ià(
	`¡»q
(
p
[0], "setenv-safe") &&…[1] && !p[3])

6391 
	`VERIFY_PERMISSION
(
OPT_P_SETENV
);

6392 
	`£‹nv_¡r_§ã
(
es
, 
p
[1],…[2] ?…[2] : "");

6394 ià(
	`¡»q
(
p
[0], "script-security") &&…[1] && !p[2])

6396 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6397 
süt_£cur™y
 = 
	`©oi
(
p
[1]);

6399 ià(
	`¡»q
(
p
[0], "mssfix") && !p[2])

6401 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_CONNECTION
);

6402 ià(
p
[1])

6404 
İtiÚs
->
û
.
mssfix
 = 
	`pos™ive_©oi
(
p
[1]);

6408 
İtiÚs
->
û
.
mssfix_deçuÉ
 = 
Œue
;

6412 #ifdeà
ENABLE_OCC


6413 ià(
	`¡»q
(
p
[0], "disable-occ") && !p[1])

6415 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6416 
İtiÚs
->
occ
 = 
çl£
;

6419 #ià
P2MP


6420 #ià
P2MP_SERVER


6421 ià(
	`¡»q
(
p
[0], "server") &&…[1] &&…[2] && !p[4])

6423 cÚ¡ 
Ëv
 = 
M_WARN
;

6424 
boŞ
 
”rÜ
 = 
çl£
;

6425 
š_addr_t
 
ÃtwÜk
, 
Ãtmask
;

6427 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6428 
ÃtwÜk
 = 
	`g‘__addr
(
p
[1], 
Ëv
, &
”rÜ
);

6429 
Ãtmask
 = 
	`g‘__addr
(
p
[2], 
Ëv
, &
”rÜ
);

6430 ià(
”rÜ
 || !
ÃtwÜk
 || !
Ãtmask
)

6432 
	`msg
(
msgËv–
, "error…arsing --server…arameters");

6433 
”r
;

6435 
İtiÚs
->
£rv”_defšed
 = 
Œue
;

6436 
İtiÚs
->
£rv”_ÃtwÜk
 = 
ÃtwÜk
;

6437 
İtiÚs
->
£rv”_Ãtmask
 = 
Ãtmask
;

6439 ià(
p
[3])

6441 ià(
	`¡»q
(
p
[3], "nopool"))

6443 
İtiÚs
->
£rv”_æags
 |ğ
SF_NOPOOL
;

6447 
	`msg
(
msgËv–
, "”rÜ…¬sšg --£rv”: % i nÙ‡„ecognized fÏg", 
p
[3]);

6448 
”r
;

6452 ià(
	`¡»q
(
p
[0], "server-ipv6") &&…[1] && !p[3])

6454 cÚ¡ 
Ëv
 = 
M_WARN
;

6455 
š6_addr
 
ÃtwÜk
;

6456 
Ãtb™s
 = 0;

6458 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6459 ià(!
	`g‘_v6_addr
(
p
[1], &
ÃtwÜk
, &
Ãtb™s
, 
Ëv
) )

6461 
	`msg
(
msgËv–
, "error…arsing --server-ipv6…arameter");

6462 
”r
;

6464 ià(
Ãtb™s
 < 64 ||‚etbits > 112)

6466 
	`msg
Ğ
msgËv–
, "--£rv”-v6 s‘tšgs: oÆy /64../112 suµÜ‹d„ighˆnow (nÙ /%d)", 
Ãtb™s
 );

6467 
”r
;

6469 
İtiÚs
->
£rv”_v6_defšed
 = 
Œue
;

6470 
İtiÚs
->
£rv”_ÃtwÜk_v6
 = 
ÃtwÜk
;

6471 
İtiÚs
->
£rv”_Ãtb™s_v6
 = 
Ãtb™s
;

6473 ià(
p
[2])

6475 
	`msg
(
msgËv–
, "”rÜ…¬sšg --£rv”-v6: % i nÙ‡„ecognized fÏg", 
p
[3]);

6476 
”r
;

6479 ià(
	`¡»q
(
p
[0], "server-bridge") &&…[1] &&…[2] &&…[3] &&…[4] && !p[5])

6481 cÚ¡ 
Ëv
 = 
M_WARN
;

6482 
boŞ
 
”rÜ
 = 
çl£
;

6483 
š_addr_t
 

, 
Ãtmask
, 
poŞ_¡¬t
, 
poŞ_’d
;

6485 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6486 

 = 
	`g‘__addr
(
p
[1], 
Ëv
, &
”rÜ
);

6487 
Ãtmask
 = 
	`g‘__addr
(
p
[2], 
Ëv
, &
”rÜ
);

6488 
poŞ_¡¬t
 = 
	`g‘__addr
(
p
[3], 
Ëv
, &
”rÜ
);

6489 
poŞ_’d
 = 
	`g‘__addr
(
p
[4], 
Ëv
, &
”rÜ
);

6490 ià(
”rÜ
 || !

 || !
Ãtmask
 || !
poŞ_¡¬t
 || !
poŞ_’d
)

6492 
	`msg
(
msgËv–
, "error…arsing --server-bridge…arameters");

6493 
”r
;

6495 
İtiÚs
->
£rv”_bridge_defšed
 = 
Œue
;

6496 
İtiÚs
->
£rv”_bridge_
 = 

;

6497 
İtiÚs
->
£rv”_bridge_Ãtmask
 = 
Ãtmask
;

6498 
İtiÚs
->
£rv”_bridge_poŞ_¡¬t
 = 
poŞ_¡¬t
;

6499 
İtiÚs
->
£rv”_bridge_poŞ_’d
 = 
poŞ_’d
;

6501 ià(
	`¡»q
(
p
[0], "server-bridge") &&…[1] && streq(p[1], "nogw") && !p[2])

6503 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6504 
İtiÚs
->
£rv”_bridge_´oxy_dhı
 = 
Œue
;

6505 
İtiÚs
->
£rv”_æags
 |ğ
SF_NO_PUSH_ROUTE_GATEWAY
;

6507 ià(
	`¡»q
(
p
[0], "server-bridge") && !p[1])

6509 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6510 
İtiÚs
->
£rv”_bridge_´oxy_dhı
 = 
Œue
;

6512 ià(
	`¡»q
(
p
[0], "push") &&…[1] && !p[2])

6514 
	`VERIFY_PERMISSION
(
OPT_P_PUSH
);

6515 
	`push_İtiÚs
(
İtiÚs
, &
p
[1], 
msgËv–
, &İtiÚs->
gc
);

6517 ià(
	`¡»q
(
p
[0], "push-reset") && !p[1])

6519 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6520 
	`push_»£t
(
İtiÚs
);

6522 ià(
	`¡»q
(
p
[0], "push-remove") &&…[1] && !p[2])

6524 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6525 
	`msg
(
D_PUSH
, "PUSH_REMOVE '%s'", 
p
[1]);

6526 
	`push_»move_İtiÚ
(
İtiÚs
,
p
[1]);

6528 ià(
	`¡»q
(
p
[0], "ifconfig-pool") &&…[1] &&…[2] && !p[4])

6530 cÚ¡ 
Ëv
 = 
M_WARN
;

6531 
boŞ
 
”rÜ
 = 
çl£
;

6532 
š_addr_t
 
¡¬t
, 
’d
, 
Ãtmask
 = 0;

6534 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6535 
¡¬t
 = 
	`g‘__addr
(
p
[1], 
Ëv
, &
”rÜ
);

6536 
’d
 = 
	`g‘__addr
(
p
[2], 
Ëv
, &
”rÜ
);

6537 ià(
p
[3])

6539 
Ãtmask
 = 
	`g‘__addr
(
p
[3], 
Ëv
, &
”rÜ
);

6541 ià(
”rÜ
)

6543 
	`msg
(
msgËv–
, "error…arsing --ifconfig-pool…arameters");

6544 
”r
;

6546 ià(!
	`ifcÚfig_poŞ_v”ify_¿nge
(
msgËv–
, 
¡¬t
, 
’d
))

6548 
”r
;

6551 
İtiÚs
->
ifcÚfig_poŞ_defšed
 = 
Œue
;

6552 
İtiÚs
->
ifcÚfig_poŞ_¡¬t
 = 
¡¬t
;

6553 
İtiÚs
->
ifcÚfig_poŞ_’d
 = 
’d
;

6554 ià(
Ãtmask
)

6556 
İtiÚs
->
ifcÚfig_poŞ_Ãtmask
 = 
Ãtmask
;

6559 ià(
	`¡»q
(
p
[0], "ifconfig-pool-persist") &&…[1] && !p[3])

6561 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6562 
İtiÚs
->
ifcÚfig_poŞ_³rsi¡_f’ame
 = 
p
[1];

6563 ià(
p
[2])

6565 
İtiÚs
->
ifcÚfig_poŞ_³rsi¡_»äesh_äeq
 = 
	`pos™ive_©oi
(
p
[2]);

6568 ià(
	`¡»q
(
p
[0], "ifconfig-pool-linear") && !p[1])

6570 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6571 
İtiÚs
->
tİŞogy
 = 
TOP_P2P
;

6572 
	`msg
(
M_WARN
, "DEPRECATED OPTION: --ifconfig-pool-linear, use --topology…2p instead");

6574 ià(
	`¡»q
(
p
[0], "ifconfig-ipv6-pool") &&…[1] && !p[2])

6576 cÚ¡ 
Ëv
 = 
M_WARN
;

6577 
š6_addr
 
ÃtwÜk
;

6578 
Ãtb™s
 = 0;

6580 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6581 ià(!
	`g‘_v6_addr
(
p
[1], &
ÃtwÜk
, &
Ãtb™s
, 
Ëv
 ) )

6583 
	`msg
(
msgËv–
, "error…arsing --ifconfig-ipv6-pool…arameters");

6584 
”r
;

6586 ià(
Ãtb™s
 < 64 ||‚etbits > 112)

6588 
	`msg
Ğ
msgËv–
, "--ifcÚfig-v6-poŞ s‘tšgs: oÆy /64../112 suµÜ‹d„ighˆnow (nÙ /%d)", 
Ãtb™s
 );

6589 
”r
;

6592 
İtiÚs
->
ifcÚfig_v6_poŞ_defšed
 = 
Œue
;

6593 
İtiÚs
->
ifcÚfig_v6_poŞ_ba£
 = 
ÃtwÜk
;

6594 
İtiÚs
->
ifcÚfig_v6_poŞ_Ãtb™s
 = 
Ãtb™s
;

6596 ià(
	`¡»q
(
p
[0], "hash-size") &&…[1] &&…[2] && !p[3])

6598 
»®
, 
vœtu®
;

6600 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6601 
»®
 = 
	`©oi
(
p
[1]);

6602 
vœtu®
 = 
	`©oi
(
p
[2]);

6603 ià(
»®
 < 1 || 
vœtu®
 < 1)

6605 
	`msg
(
msgËv–
, "--hash-size sizes must be >= 1 (preferably‡…ower of 2)");

6606 
”r
;

6608 
İtiÚs
->
»®_hash_size
 = 
»®
;

6609 
İtiÚs
->
vœtu®_hash_size
 = 
»®
;

6611 ià(
	`¡»q
(
p
[0], "connect-freq") &&…[1] &&…[2] && !p[3])

6613 
cf_max
, 
cf_³r
;

6615 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6616 
cf_max
 = 
	`©oi
(
p
[1]);

6617 
cf_³r
 = 
	`©oi
(
p
[2]);

6618 ià(
cf_max
 < 0 || 
cf_³r
 < 0)

6620 
	`msg
(
msgËv–
, "--connect-freq…arms must be > 0");

6621 
”r
;

6623 
İtiÚs
->
cf_max
 = cf_max;

6624 
İtiÚs
->
cf_³r
 = cf_per;

6626 ià(
	`¡»q
(
p
[0], "max-clients") &&…[1] && !p[2])

6628 
max_ş›Ás
;

6630 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6631 
max_ş›Ás
 = 
	`©oi
(
p
[1]);

6632 ià(
max_ş›Ás
 < 0)

6634 
	`msg
(
msgËv–
, "--max-clients must be‡t†east 1");

6635 
”r
;

6637 ià(
max_ş›Ás
 >ğ
MAX_PEER_ID
)

6639 
	`msg
(
msgËv–
, "--max-ş›Á mu¡ bËs thª %d", 
MAX_PEER_ID
);

6640 
”r
;

6642 
İtiÚs
->
max_ş›Ás
 = max_clients;

6644 ià(
	`¡»q
(
p
[0], "max-routes-per-client") &&…[1] && !p[2])

6646 
	`VERIFY_PERMISSION
(
OPT_P_INHERIT
);

6647 
İtiÚs
->
max_rou‹s_³r_ş›Á
 = 
	`max_št
(
	`©oi
(
p
[1]), 1);

6649 ià(
	`¡»q
(
p
[0], "client-cert-not-required") && !p[1])

6651 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6652 
İtiÚs
->
s¦_æags
 |ğ
SSLF_CLIENT_CERT_NOT_REQUIRED
;

6653 
	`msg
(
M_WARN
, "DEPRECATED OPTION: --client-cert-not-required, use --verify-client-cert instead");

6655 ià(
	`¡»q
(
p
[0], "verify-client-cert") && !p[2])

6657 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6660 
İtiÚs
->
s¦_æags
 &ğ~
SSLF_CLIENT_CERT_OPTIONAL
;

6661 
İtiÚs
->
s¦_æags
 &ğ~
SSLF_CLIENT_CERT_NOT_REQUIRED
;

6662 ià(
p
[1])

6664 ià(
	`¡»q
(
p
[1], "none"))

6666 
İtiÚs
->
s¦_æags
 |ğ
SSLF_CLIENT_CERT_NOT_REQUIRED
;

6668 ià(
	`¡»q
(
p
[1], "optional"))

6670 
İtiÚs
->
s¦_æags
 |ğ
SSLF_CLIENT_CERT_OPTIONAL
;

6672 ià(!
	`¡»q
(
p
[1], "require"))

6674 
	`msg
(
msgËv–
, "parametero --verify-client-cert must be 'none', 'optional' or 'require'");

6675 
”r
;

6679 ià(
	`¡»q
(
p
[0], "username-as-common-name") && !p[1])

6681 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6682 
İtiÚs
->
s¦_æags
 |ğ
SSLF_USERNAME_AS_COMMON_NAME
;

6684 ià(
	`¡»q
(
p
[0], "auth-user-pass-optional") && !p[1])

6686 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6687 
İtiÚs
->
s¦_æags
 |ğ
SSLF_AUTH_USER_PASS_OPTIONAL
;

6689 ià(
	`¡»q
(
p
[0], "opt-verify") && !p[1])

6691 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6692 
İtiÚs
->
s¦_æags
 |ğ
SSLF_OPT_VERIFY
;

6694 ià(
	`¡»q
(
p
[0], "auth-user-pass-verify") &&…[1])

6696 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6697 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 3, 
NM_QUOTE_HINT
))

6699 
”r
;

6701 ià(
p
[2])

6703 ià(
	`¡»q
(
p
[2], "via-env"))

6705 
İtiÚs
->
auth_u£r_·ss_v”ify_süt_vŸ_fe
 = 
çl£
;

6707 ià(
	`¡»q
(
p
[2], "via-file"))

6709 
İtiÚs
->
auth_u£r_·ss_v”ify_süt_vŸ_fe
 = 
Œue
;

6713 
	`msg
(
msgËv–
, "second…armo --auth-user-pass-verify must be 'via-env' or 'via-file'");

6714 
”r
;

6719 
	`msg
(
msgËv–
, "--auth-user-pass-verify„equires‡ second…arameter ('via-env' or 'via-file')");

6720 
”r
;

6722 
	`£t_u£r_süt
(
İtiÚs
,

6723 &
İtiÚs
->
auth_u£r_·ss_v”ify_süt
,

6724 
p
[1], "auth-u£r-·ss-v”ify", 
Œue
);

6726 ià(
	`¡»q
(
p
[0], "auth-gen-token"))

6728 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6729 
İtiÚs
->
auth_tok’_g’”©e
 = 
Œue
;

6730 
İtiÚs
->
auth_tok’_liãtime
 = 
p
[1] ? 
	`pos™ive_©oi
(p[1]) : 0;

6732 ià(
	`¡»q
(
p
[0], "client-connect") &&…[1])

6734 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6735 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

6737 
”r
;

6739 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
ş›Á_cÚÃù_süt
,

6740 
p
[1], "ş›Á-cÚÃù", 
Œue
);

6742 ià(
	`¡»q
(
p
[0], "client-disconnect") &&…[1])

6744 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6745 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

6747 
”r
;

6749 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
ş›Á_discÚÃù_süt
,

6750 
p
[1], "ş›Á-discÚÃù", 
Œue
);

6752 ià(
	`¡»q
(
p
[0], "learn-address") &&…[1])

6754 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

6755 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

6757 
”r
;

6759 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
Ë¬n_add»ss_süt
,

6760 
p
[1], "Ë¬n-add»ss", 
Œue
);

6762 ià(
	`¡»q
(
p
[0], "tmp-dir") &&…[1] && !p[2])

6764 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6765 
İtiÚs
->
tmp_dœ
 = 
p
[1];

6767 ià(
	`¡»q
(
p
[0], "client-config-dir") &&…[1] && !p[2])

6769 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6770 
İtiÚs
->
ş›Á_cÚfig_dœ
 = 
p
[1];

6772 ià(
	`¡»q
(
p
[0], "ccd-exclusive") && !p[1])

6774 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6775 
İtiÚs
->
ccd_exşusive
 = 
Œue
;

6777 ià(
	`¡»q
(
p
[0], "bcast-buffers") &&…[1] && !p[2])

6779 
n_bÿ¡_buf
;

6781 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6782 
n_bÿ¡_buf
 = 
	`©oi
(
p
[1]);

6783 ià(
n_bÿ¡_buf
 < 1)

6785 
	`msg
(
msgËv–
, "--bcast-buffers…arameter must be > 0");

6787 
İtiÚs
->
n_bÿ¡_buf
 =‚_bcast_buf;

6789 ià(
	`¡»q
(
p
[0], "tcp-queue-limit") &&…[1] && !p[2])

6791 
tı_queue_lim™
;

6793 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6794 
tı_queue_lim™
 = 
	`©oi
(
p
[1]);

6795 ià(
tı_queue_lim™
 < 1)

6797 
	`msg
(
msgËv–
, "--tcp-queue-limit…arameter must be > 0");

6799 
İtiÚs
->
tı_queue_lim™
 =cp_queue_limit;

6801 #ià
PORT_SHARE


6802 ià(
	`¡»q
(
p
[0], "port-share") &&…[1] &&…[2] && !p[4])

6804 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6805 
İtiÚs
->
pÜt_sh¬e_ho¡
 = 
p
[1];

6806 
İtiÚs
->
pÜt_sh¬e_pÜt
 = 
p
[2];

6807 
İtiÚs
->
pÜt_sh¬e_jouº®_dœ
 = 
p
[3];

6810 ià(
	`¡»q
(
p
[0], "client-to-client") && !p[1])

6812 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6813 
İtiÚs
->
’abË_c2c
 = 
Œue
;

6815 ià(
	`¡»q
(
p
[0], "duplicate-cn") && !p[1])

6817 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6818 
İtiÚs
->
du¶iÿ‹_ú
 = 
Œue
;

6820 ià(
	`¡»q
(
p
[0], "iroute") &&…[1] && !p[3])

6822 cÚ¡ *
Ãtmask
 = 
NULL
;

6824 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6825 ià(
p
[2])

6827 
Ãtmask
 = 
p
[2];

6829 
	`İtiÚ_œou‹
(
İtiÚs
, 
p
[1], 
Ãtmask
, 
msgËv–
);

6831 ià(
	`¡»q
(
p
[0], "iroute-ipv6") &&…[1] && !p[2])

6833 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6834 
	`İtiÚ_œou‹_v6
(
İtiÚs
, 
p
[1], 
msgËv–
);

6836 ià(
	`¡»q
(
p
[0], "ifconfig-push") &&…[1] &&…[2] && !p[4])

6838 
š_addr_t
 
loÿl
, 
»mÙe_Ãtmask
;

6840 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6841 
loÿl
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[1], 0, 
NULL
, NULL);

6842 
»mÙe_Ãtmask
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[2], 0, 
NULL
, NULL);

6843 ià(
loÿl
 && 
»mÙe_Ãtmask
)

6845 
İtiÚs
->
push_ifcÚfig_defšed
 = 
Œue
;

6846 
İtiÚs
->
push_ifcÚfig_loÿl
 = 
loÿl
;

6847 
İtiÚs
->
push_ifcÚfig_»mÙe_Ãtmask
 = 
»mÙe_Ãtmask
;

6848 ià(
p
[3])

6850 
İtiÚs
->
push_ifcÚfig_loÿl_®Ÿs
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[3], 0, 
NULL
, NULL);

6855 
	`msg
(
msgËv–
, "cannot…arse --ifconfig-push‡ddresses");

6856 
”r
;

6859 ià(
	`¡»q
(
p
[0], "ifconfig-push-constraint") &&…[1] &&…[2] && !p[3])

6861 
š_addr_t
 
ÃtwÜk
, 
Ãtmask
;

6863 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6864 
ÃtwÜk
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
|
GETADDR_RESOLVE
, 
p
[1], 0, 
NULL
, NULL);

6865 
Ãtmask
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
p
[2], 0, 
NULL
, NULL);

6866 ià(
ÃtwÜk
 && 
Ãtmask
)

6868 
İtiÚs
->
push_ifcÚfig_cÚ¡¿št_defšed
 = 
Œue
;

6869 
İtiÚs
->
push_ifcÚfig_cÚ¡¿št_ÃtwÜk
 = 
ÃtwÜk
;

6870 
İtiÚs
->
push_ifcÚfig_cÚ¡¿št_Ãtmask
 = 
Ãtmask
;

6874 
	`msg
(
msgËv–
, "cannot…arse --ifconfig-push-constraint‡ddresses");

6875 
”r
;

6878 ià(
	`¡»q
(
p
[0], "ifconfig-ipv6-push") &&…[1] && !p[3])

6880 
š6_addr
 
loÿl
, 
»mÙe
;

6881 
Ãtb™s
;

6883 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6885 ià(!
	`g‘_v6_addr
Ğ
p
[1], &
loÿl
, &
Ãtb™s
, 
msgËv–
 ) )

6887 
	`msg
(
msgËv–
, "cannot…arse --ifconfig-ipv6-push‡ddresses");

6888 
”r
;

6891 ià(
p
[2])

6893 ià(!
	`g‘_v6_addr
Ğ
p
[2], &
»mÙe
, 
NULL
, 
msgËv–
 ) )

6895 
	`msg
Ğ
msgËv–
, "cannot…arse --ifconfig-ipv6-push‡ddresses");

6896 
”r
;

6901 ià(!
İtiÚs
->
ifcÚfig_v6_loÿl


6902 || !
	`g‘_v6_addr
Ğ
İtiÚs
->
ifcÚfig_v6_loÿl
, &
»mÙe
,

6903 
NULL
, 
msgËv–
 ) )

6905 
	`msg
Ğ
msgËv–
, "second‡rgumento --ifconfig-ipv6-push missing‡nd‚o global --ifconfig-ipv6‡ddress set");

6906 
”r
;

6910 
İtiÚs
->
push_ifcÚfig_v6_defšed
 = 
Œue
;

6911 
İtiÚs
->
push_ifcÚfig_v6_loÿl
 = 
loÿl
;

6912 
İtiÚs
->
push_ifcÚfig_v6_Ãtb™s
 = 
Ãtb™s
;

6913 
İtiÚs
->
push_ifcÚfig_v6_»mÙe
 = 
»mÙe
;

6914 
İtiÚs
->
push_ifcÚfig_v6_blocked
 = 
çl£
;

6916 ià(
	`¡»q
(
p
[0], "disable") && !p[1])

6918 
	`VERIFY_PERMISSION
(
OPT_P_INSTANCE
);

6919 
İtiÚs
->
di§bË
 = 
Œue
;

6921 ià(
	`¡»q
(
p
[0], "tcp-nodelay") && !p[1])

6923 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6924 
İtiÚs
->
£rv”_æags
 |ğ
SF_TCP_NODELAY_HELPER
;

6926 ià(
	`¡»q
(
p
[0], "stale-routes-check") &&…[1] && !p[3])

6928 
agešg_time
, 
check_š‹rv®
;

6930 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6931 
agešg_time
 = 
	`©oi
(
p
[1]);

6932 ià(
p
[2])

6934 
check_š‹rv®
 = 
	`©oi
(
p
[2]);

6938 
check_š‹rv®
 = 
agešg_time
;

6941 ià(
agešg_time
 < 1 || 
check_š‹rv®
 < 1)

6943 
	`msg
(
msgËv–
, "--stale-routes-check‡gingime‡nd check interval must be >= 1");

6944 
”r
;

6946 
İtiÚs
->
¡®e_rou‹s_agešg_time
 = 
agešg_time
;

6947 
İtiÚs
->
¡®e_rou‹s_check_š‹rv®
 = 
check_š‹rv®
;

6951 ià(
	`¡»q
(
p
[0], "client") && !p[1])

6953 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6954 
İtiÚs
->
ş›Á
 = 
Œue
;

6956 ià(
	`¡»q
(
p
[0], "pull") && !p[1])

6958 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6959 
İtiÚs
->
puÎ
 = 
Œue
;

6961 ià(
	`¡»q
(
p
[0], "push-continuation") &&…[1] && !p[2])

6963 
	`VERIFY_PERMISSION
(
OPT_P_PULL_MODE
);

6964 
İtiÚs
->
push_cÚtšu©iÚ
 = 
	`©oi
(
p
[1]);

6966 ià(
	`¡»q
(
p
[0], "auth-user-pass") && !p[2])

6968 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6969 ià(
p
[1])

6971 
İtiÚs
->
auth_u£r_·ss_fe
 = 
p
[1];

6975 
İtiÚs
->
auth_u£r_·ss_fe
 = "stdin";

6978 ià(
	`¡»q
(
p
[0], "auth-retry") &&…[1] && !p[2])

6980 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6981 
	`auth_»Œy_£t
(
msgËv–
, 
p
[1]);

6983 #ifdeà
ENABLE_CLIENT_CR


6984 ià(
	`¡»q
(
p
[0], "static-challenge") &&…[1] &&…[2] && !p[3])

6986 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6987 
İtiÚs
->
sc_šfo
.
ch®Ënge_‹xt
 = 
p
[1];

6988 ià(
	`©oi
(
p
[2]))

6990 
İtiÚs
->
sc_šfo
.
æags
 |ğ
SC_ECHO
;

6995 ià(
	`¡»q
(
p
[0], "msg-channel") &&…[1])

6997 #ifdeà
_WIN32


6998 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

6999 
HANDLE
 
´oûss
 = 
	`G‘Cu¼’tProûss
();

7000 
HANDLE
 
hªdË
 = (HANDLEè
	`©oi
(
p
[1]);

7001 ià(!
	`Du¶iÿ‹HªdË
(
´oûss
, 
hªdË
,…roûss, &
İtiÚs
->
msg_chªÃl
, 0,

7002 
FALSE
, 
DUPLICATE_CLOSE_SOURCE
 | 
DUPLICATE_SAME_ACCESS
))

7004 
	`msg
(
msgËv–
, "could‚ot duplicate service…ipe handle");

7005 
”r
;

7007 
İtiÚs
->
rou‹_m‘hod
 = 
ROUTE_METHOD_SERVICE
;

7009 
	`msg
(
msgËv–
, "--msg-channel is only supported on Windows");

7010 
”r
;

7013 #ifdeà
_WIN32


7014 ià(
	`¡»q
(
p
[0], "win-sys") &&…[1] && !p[2])

7016 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7017 ià(
	`¡»q
(
p
[1], "env"))

7019 
	`msg
(
M_INFO
, "NOTE: --win-sysƒnv is default from OpenVPN 2.3. "

7025 
	`£t_wš_sys_·th
(
p
[1], 
es
);

7028 ià(
	`¡»q
(
p
[0], "route-method") &&…[1] && !p[2])

7030 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE_EXTRAS
);

7031 ià(
	`¡»q
(
p
[1], "adaptive"))

7033 
İtiÚs
->
rou‹_m‘hod
 = 
ROUTE_METHOD_ADAPTIVE
;

7035 ià(
	`¡»q
(
p
[1], "ipapi"))

7037 
İtiÚs
->
rou‹_m‘hod
 = 
ROUTE_METHOD_IPAPI
;

7039 ià(
	`¡»q
(
p
[1], "exe"))

7041 
İtiÚs
->
rou‹_m‘hod
 = 
ROUTE_METHOD_EXE
;

7045 
	`msg
(
msgËv–
, "--route method must be 'adaptive', 'ipapi', or 'exe'");

7046 
”r
;

7049 ià(
	`¡»q
(
p
[0], "ip-win32") &&…[1] && !p[4])

7051 cÚ¡ 
šdex
 = 
	`ascii2£t
(
p
[1]);

7052 
tuÁ­_İtiÚs
 *
to
 = &
İtiÚs
->tuntap_options;

7054 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7056 ià(
šdex
 < 0)

7058 
	`msg
(
msgËv–
,

7060 
p
[1],

7061 
	`£t2ascii_®l
(&
gc
));

7062 
”r
;

7065 ià(
šdex
 =ğ
IPW32_SET_ADAPTIVE
)

7067 
İtiÚs
->
rou‹_d–ay_wšdow
 = 
IPW32_SET_ADAPTIVE_DELAY_WINDOW
;

7070 ià(
šdex
 =ğ
IPW32_SET_DHCP_MASQ
)

7072 ià(
p
[2])

7074 ià(!
	`¡»q
(
p
[2], "default"))

7076 
off£t
 = 
	`©oi
(
p
[2]);

7078 ià(!(
off£t
 > -256 && offset < 256))

7080 
	`msg
(
msgËv–
, "---wš32 dyÇmiø[off£t] [Ëa£-time]: off£ˆ(%dèmu¡ b> -256‡nd < 256", 
off£t
);

7081 
”r
;

7084 
to
->
dhı_masq_cu¡om_off£t
 = 
Œue
;

7085 
to
->
dhı_masq_off£t
 = 
off£t
;

7088 ià(
p
[3])

7090 cÚ¡ 
mš_Ëa£
 = 30;

7091 
Ëa£_time
;

7092 
Ëa£_time
 = 
	`©oi
(
p
[3]);

7093 ià(
Ëa£_time
 < 
mš_Ëa£
)

7095 
	`msg
(
msgËv–
, "---wš32 dyÇmiø[off£t] [Ëa£-time]:†—£im·¿m‘” (%dèmu¡ b©†—¡ %d secÚds", 
Ëa£_time
, 
mš_Ëa£
);

7096 
”r
;

7098 
to
->
dhı_Ëa£_time
 = 
Ëa£_time
;

7102 
to
->
_wš32_ty³
 = 
šdex
;

7103 
to
->
_wš32_defšed
 = 
Œue
;

7106 #ià
	`defšed
(
_WIN32
è|| defšed(
TARGET_ANDROID
)

7107 ià(
	`¡»q
(
p
[0], "dhcp-option") &&…[1] && !p[3])

7109 
tuÁ­_İtiÚs
 *
o
 = &
İtiÚs
->tuntap_options;

7110 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7111 
boŞ
 
v6dns
 = 
çl£
;

7113 ià(
	`¡»q
(
p
[1], "DOMAIN") &&…[2])

7115 
o
->
domaš
 = 
p
[2];

7117 ià(
	`¡»q
(
p
[1], "NBS") &&…[2])

7119 
o
->
Ãtbios_scİe
 = 
p
[2];

7121 ià(
	`¡»q
(
p
[1], "NBT") &&…[2])

7123 
t
;

7124 
t
 = 
	`©oi
(
p
[2]);

7125 ià(!(
t
 == 1 || == 2 || == 4 || == 8))

7127 
	`msg
(
msgËv–
, "--dhı-İtiÚ NBT:…¬am‘” (%dèmu¡ b1, 2, 4, o¸8", 
t
);

7128 
”r
;

7130 
o
->
Ãtbios_node_ty³
 = 
t
;

7132 ià((
	`¡»q
(
p
[1], "DNS"è|| sŒeqÕ[1], "DNS6")è&&…[2] && (!
	`¡r¡r
Õ[2], ":"è|| 
	`v6_addr_§ã
(p[2])))

7134 ià(
	`¡r¡r
(
p
[2], ":"))

7136 
v6dns
=
Œue
;

7137 
	`fÜeign_İtiÚ
(
İtiÚs
, 
p
, 3, 
es
);

7138 
	`dhı_İtiÚ_dns6_·r£
(
p
[2], 
o
->
dns6
, &o->
dns6_Ën
, 
msgËv–
);

7142 
	`dhı_İtiÚ_add»ss_·r£
("DNS", 
p
[2], 
o
->
dns
, &o->
dns_Ën
, 
msgËv–
);

7145 ià(
	`¡»q
(
p
[1], "WINS") &&…[2])

7147 
	`dhı_İtiÚ_add»ss_·r£
("WINS", 
p
[2], 
o
->
wšs
, &o->
wšs_Ën
, 
msgËv–
);

7149 ià(
	`¡»q
(
p
[1], "NTP") &&…[2])

7151 
	`dhı_İtiÚ_add»ss_·r£
("NTP", 
p
[2], 
o
->
Áp
, &o->
Áp_Ën
, 
msgËv–
);

7153 ià(
	`¡»q
(
p
[1], "NBDD") &&…[2])

7155 
	`dhı_İtiÚ_add»ss_·r£
("NBDD", 
p
[2], 
o
->
nbdd
, &o->
nbdd_Ën
, 
msgËv–
);

7157 ià(
	`¡»q
(
p
[1], "DISABLE-NBT") && !p[2])

7159 
o
->
di§bË_nbt
 = 1;

7163 
	`msg
(
msgËv–
, "--dhı-İtiÚ: unknowÀİtiÚy³ '%s' o¸missšg o¸unknowÀ·¿m‘”", 
p
[1]);

7164 
”r
;

7170 ià(!
v6dns
)

7172 
o
->
dhı_İtiÚs
 = 
Œue
;

7176 #ifdeà
_WIN32


7177 ià(
	`¡»q
(
p
[0], "show-adapters") && !p[1])

7179 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7180 
	`show_p_wš_ad­‹rs
(
M_INFO
|
M_NOPREFIX
, 
M_WARN
|M_NOPREFIX);

7181 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7183 ià(
	`¡»q
(
p
[0], "show-net") && !p[1])

7185 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7186 
	`show_rou‹s
(
M_INFO
|
M_NOPREFIX
);

7187 
	`show_ad­‹rs
(
M_INFO
|
M_NOPREFIX
);

7188 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7190 ià(
	`¡»q
(
p
[0], "show-net-up") && !p[1])

7192 
	`VERIFY_PERMISSION
(
OPT_P_UP
);

7193 
İtiÚs
->
show_Ãt_up
 = 
Œue
;

7195 ià(
	`¡»q
(
p
[0], "tap-sleep") &&…[1] && !p[2])

7197 
s
;

7198 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7199 
s
 = 
	`©oi
(
p
[1]);

7200 ià(
s
 < 0 || s >= 256)

7202 
	`msg
(
msgËv–
, "--tap-sleep…arameter must be between 0‡nd 255");

7203 
”r
;

7205 
İtiÚs
->
tuÁ­_İtiÚs
.
p_¦“p
 = 
s
;

7207 ià(
	`¡»q
(
p
[0], "dhcp-renew") && !p[1])

7209 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7210 
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_»Ãw
 = 
Œue
;

7212 ià(
	`¡»q
(
p
[0], "dhcp-pre-release") && !p[1])

7214 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7215 
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_´e_»Ëa£
 = 
Œue
;

7216 
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_»Ãw
 = 
Œue
;

7218 ià(
	`¡»q
(
p
[0], "dhcp-release") && !p[1])

7220 
	`msg
(
M_WARN
, "Obsolete option --dhcp-release detected. This is‚ow on by default");

7222 ià(
	`¡»q
(
p
[0], "dhcp-internal") &&…[1] && !p[2])

7224 
ad­‹r_šdex
;

7225 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7226 
	`£t_debug_Ëv–
(
İtiÚs
->
v”bos™y
, 
SDL_CONSTRAIN
);

7227 
ad­‹r_šdex
 = 
	`©ou
(
p
[1]);

7228 
	`¦“p
(
İtiÚs
->
tuÁ­_İtiÚs
.
p_¦“p
);

7229 ià(
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_´e_»Ëa£
)

7231 
	`dhı_»Ëa£_by_ad­‹r_šdex
(
ad­‹r_šdex
);

7233 ià(
İtiÚs
->
tuÁ­_İtiÚs
.
dhı_»Ãw
)

7235 
	`dhı_»Ãw_by_ad­‹r_šdex
(
ad­‹r_šdex
);

7237 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7239 ià(
	`¡»q
(
p
[0], "register-dns") && !p[1])

7241 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7242 
İtiÚs
->
tuÁ­_İtiÚs
.
»gi¡”_dns
 = 
Œue
;

7244 ià(
	`¡»q
(
p
[0], "block-outside-dns") && !p[1])

7246 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7247 
İtiÚs
->
block_outside_dns
 = 
Œue
;

7249 ià(
	`¡»q
(
p
[0], "rdns-internal") && !p[1])

7257 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7258 
	`£t_debug_Ëv–
(
İtiÚs
->
v”bos™y
, 
SDL_CONSTRAIN
);

7259 ià(
İtiÚs
->
tuÁ­_İtiÚs
.
»gi¡”_dns
)

7261 
	`cÚfig_»gi¡”_dns
(
NULL
);

7263 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7265 ià(
	`¡»q
(
p
[0], "show-valid-subnets") && !p[1])

7267 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7268 
	`show_v®id_wš32_tun_subÃts
();

7269 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7271 ià(
	`¡»q
(
p
[0], "pause-exit") && !p[1])

7273 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7274 
	`£t_·u£_ex™_wš32
();

7276 ià(
	`¡»q
(
p
[0], "service") &&…[1] && !p[3])

7278 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7279 
İtiÚs
->
ex™_ev’t_Çme
 = 
p
[1];

7280 ià(
p
[2])

7282 
İtiÚs
->
ex™_ev’t_š™Ÿl_¡©e
 = (
	`©oi
(
p
[2]) != 0);

7285 ià(
	`¡»q
(
p
[0], "allow-nonadmin") && !p[2])

7287 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7288 
	`p_®low_nÚadmš_acûss
(
p
[1]);

7289 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

7291 ià(
	`¡»q
(
p
[0], "user") &&…[1] && !p[2])

7293 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7294 
	`msg
(
M_WARN
, "NOTE: --user option is‚ot implemented on Windows");

7296 ià(
	`¡»q
(
p
[0], "group") &&…[1] && !p[2])

7298 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7299 
	`msg
(
M_WARN
, "NOTE: --group option is‚ot implemented on Windows");

7302 ià(
	`¡»q
(
p
[0], "user") &&…[1] && !p[2])

7304 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7305 
İtiÚs
->
u£ºame
 = 
p
[1];

7307 ià(
	`¡»q
(
p
[0], "group") &&…[1] && !p[2])

7309 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7310 
İtiÚs
->
grou²ame
 = 
p
[1];

7312 ià(
	`¡»q
(
p
[0], "dhcp-option") &&…[1] && !p[3])

7314 
	`VERIFY_PERMISSION
(
OPT_P_IPWIN32
);

7315 
	`fÜeign_İtiÚ
(
İtiÚs
, 
p
, 3, 
es
);

7317 ià(
	`¡»q
(
p
[0], "route-method") &&…[1] && !p[2])

7319 
	`VERIFY_PERMISSION
(
OPT_P_ROUTE_EXTRAS
);

7322 #ià
PASSTOS_CAPABILITY


7323 ià(
	`¡»q
(
p
[0], "passtos") && !p[1])

7325 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7326 
İtiÚs
->
·s¡os
 = 
Œue
;

7329 #ià
	`defšed
(
USE_COMP
)

7330 ià(
	`¡»q
(
p
[0], "comp-lzo") && !p[2])

7332 
	`VERIFY_PERMISSION
(
OPT_P_COMP
);

7334 #ià
	`defšed
(
ENABLE_LZO
)

7335 ià(
p
[1] && 
	`¡»q
(p[1], "no"))

7338 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_STUB
;

7339 
İtiÚs
->
comp
.
æags
 = 0;

7341 #ià
	`defšed
(
ENABLE_LZO
)

7342 ià(
p
[1])

7344 ià(
	`¡»q
(
p
[1], "yes"))

7346 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_LZO
;

7347 
İtiÚs
->
comp
.
æags
 = 0;

7349 ià(
	`¡»q
(
p
[1], "adaptive"))

7351 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_LZO
;

7352 
İtiÚs
->
comp
.
æags
 = 
COMP_F_ADAPTIVE
;

7356 
	`msg
(
msgËv–
, "bad comp-lzØİtiÚ: % -- mu¡ b'yes', 'no', o¸'ad­tive'", 
p
[1]);

7357 
”r
;

7362 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_LZO
;

7363 
İtiÚs
->
comp
.
æags
 = 
COMP_F_ADAPTIVE
;

7367 ià(
	`¡»q
(
p
[0], "comp-noadapt") && !p[1])

7369 
	`VERIFY_PERMISSION
(
OPT_P_COMP
);

7370 
İtiÚs
->
comp
.
æags
 &ğ~
COMP_F_ADAPTIVE
;

7372 ià(
	`¡»q
(
p
[0], "compress") && !p[2])

7374 
	`VERIFY_PERMISSION
(
OPT_P_COMP
);

7375 ià(
p
[1])

7377 ià(
	`¡»q
(
p
[1], "stub"))

7379 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_STUB
;

7380 
İtiÚs
->
comp
.
æags
 = (
COMP_F_SWAP
|
COMP_F_ADVERTISE_STUBS_ONLY
);

7382 ià(
	`¡»q
(
p
[1], "stub-v2"))

7384 
İtiÚs
->
comp
.
®g
 = 
COMP_ALGV2_UNCOMPRESSED
;

7385 
İtiÚs
->
comp
.
æags
 = 
COMP_F_ADVERTISE_STUBS_ONLY
;

7387 #ià
	`defšed
(
ENABLE_LZO
)

7388 ià(
	`¡»q
(
p
[1], "lzo"))

7390 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_LZO
;

7391 
İtiÚs
->
comp
.
æags
 = 0;

7394 #ià
	`defšed
(
ENABLE_LZ4
)

7395 ià(
	`¡»q
(
p
[1], "lz4"))

7397 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_LZ4
;

7398 
İtiÚs
->
comp
.
æags
 = 
COMP_F_SWAP
;

7400 ià(
	`¡»q
(
p
[1], "lz4-v2"))

7402 
İtiÚs
->
comp
.
®g
 = 
COMP_ALGV2_LZ4
;

7403 
İtiÚs
->
comp
.
æags
 = 0;

7408 
	`msg
(
msgËv–
, "bad com°İtiÚ: %s", 
p
[1]);

7409 
”r
;

7414 
İtiÚs
->
comp
.
®g
 = 
COMP_ALG_STUB
;

7415 
İtiÚs
->
comp
.
æags
 = 
COMP_F_SWAP
;

7419 #ifdeà
ENABLE_CRYPTO


7420 ià(
	`¡»q
(
p
[0], "show-ciphers") && !p[1])

7422 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7423 
İtiÚs
->
show_ch”s
 = 
Œue
;

7425 ià(
	`¡»q
(
p
[0], "show-digests") && !p[1])

7427 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7428 
İtiÚs
->
show_dige¡s
 = 
Œue
;

7430 ià(
	`¡»q
(
p
[0], "show-engines") && !p[1])

7432 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7433 
İtiÚs
->
show_’gšes
 = 
Œue
;

7435 ià(
	`¡»q
(
p
[0], "key-direction") &&…[1] && !p[2])

7437 
key_dœeùiÚ
;

7439 
key_dœeùiÚ
 = 
	`ascii2keydœeùiÚ
(
msgËv–
, 
p
[1]);

7440 ià(
key_dœeùiÚ
 >= 0)

7442 
İtiÚs
->
key_dœeùiÚ
 = key_direction;

7446 
”r
;

7449 ià(
	`¡»q
(
p
[0], "secret") &&…[1] && !p[3])

7451 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7452 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7454 
İtiÚs
->
sh¬ed_£ü‘_fe_šlše
 = 
p
[2];

7456 ià(
p
[2])

7458 
key_dœeùiÚ
;

7460 
key_dœeùiÚ
 = 
	`ascii2keydœeùiÚ
(
msgËv–
, 
p
[2]);

7461 ià(
key_dœeùiÚ
 >= 0)

7463 
İtiÚs
->
key_dœeùiÚ
 = key_direction;

7467 
”r
;

7470 
İtiÚs
->
sh¬ed_£ü‘_fe
 = 
p
[1];

7472 ià(
	`¡»q
(
p
[0], "genkey") && !p[1])

7474 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7475 
İtiÚs
->
g’key
 = 
Œue
;

7477 ià(
	`¡»q
(
p
[0], "auth") &&…[1] && !p[2])

7479 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7480 
İtiÚs
->
authÇme
 = 
p
[1];

7482 ià(
	`¡»q
(
p
[0], "cipher") &&…[1] && !p[2])

7484 
	`VERIFY_PERMISSION
(
OPT_P_NCP
);

7485 
İtiÚs
->
ch”Çme
 = 
p
[1];

7487 ià(
	`¡»q
(
p
[0], "ncp-ciphers") &&…[1] && !p[2])

7489 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_INSTANCE
);

7490 
İtiÚs
->
nı_ch”s
 = 
p
[1];

7492 ià(
	`¡»q
(
p
[0], "ncp-disable") && !p[1])

7494 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
|
OPT_P_INSTANCE
);

7495 
İtiÚs
->
nı_’abËd
 = 
çl£
;

7497 ià(
	`¡»q
(
p
[0], "prng") &&…[1] && !p[3])

7499 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7500 ià(
	`¡»q
(
p
[1], "none"))

7502 
İtiÚs
->
´ng_hash
 = 
NULL
;

7506 
İtiÚs
->
´ng_hash
 = 
p
[1];

7508 ià(
p
[2])

7510 cÚ¡ 
¦
 = 
	`©oi
(
p
[2]);

7511 ià(
¦
 >ğ
NONCE_SECRET_LEN_MIN
 && sÈ<ğ
NONCE_SECRET_LEN_MAX
)

7513 
İtiÚs
->
´ng_nÚû_£ü‘_Ën
 = 
¦
;

7517 
	`msg
(
msgËv–
, "prng…arameter‚once_secret_len must be between %d‡nd %d",

7518 
NONCE_SECRET_LEN_MIN
, 
NONCE_SECRET_LEN_MAX
);

7519 
”r
;

7523 ià(
	`¡»q
(
p
[0], "no-replay") && !p[1])

7525 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7526 
İtiÚs
->
»¶ay
 = 
çl£
;

7528 ià(
	`¡»q
(
p
[0], "replay-window") && !p[3])

7530 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7531 ià(
p
[1])

7533 
»¶ay_wšdow
;

7535 
»¶ay_wšdow
 = 
	`©oi
(
p
[1]);

7536 ià(!(
MIN_SEQ_BACKTRACK
 <ğ
»¶ay_wšdow
 &&„•Ïy_wšdow <ğ
MAX_SEQ_BACKTRACK
))

7538 
	`msg
(
msgËv–
, "replay-window window size…arameter (%d) must be between %d‡nd %d",

7539 
»¶ay_wšdow
,

7540 
MIN_SEQ_BACKTRACK
,

7541 
MAX_SEQ_BACKTRACK
);

7542 
”r
;

7544 
İtiÚs
->
»¶ay_wšdow
 =„eplay_window;

7546 ià(
p
[2])

7548 
»¶ay_time
;

7550 
»¶ay_time
 = 
	`©oi
(
p
[2]);

7551 ià(!(
MIN_TIME_BACKTRACK
 <ğ
»¶ay_time
 &&„•Ïy_tim<ğ
MAX_TIME_BACKTRACK
))

7553 
	`msg
(
msgËv–
, "replay-windowime window…arameter (%d) must be between %d‡nd %d",

7554 
»¶ay_time
,

7555 
MIN_TIME_BACKTRACK
,

7556 
MAX_TIME_BACKTRACK
);

7557 
”r
;

7559 
İtiÚs
->
»¶ay_time
 =„eplay_time;

7564 
	`msg
(
msgËv–
, "replay-window option is missing window size…arameter");

7565 
”r
;

7568 ià(
	`¡»q
(
p
[0], "mute-replay-warnings") && !p[1])

7570 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7571 
İtiÚs
->
mu‹_»¶ay_w¬nšgs
 = 
Œue
;

7573 ià(
	`¡»q
(
p
[0], "no-iv") && !p[1])

7575 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7576 
İtiÚs
->
u£_iv
 = 
çl£
;

7578 ià(
	`¡»q
(
p
[0], "replay-persist") &&…[1] && !p[2])

7580 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7581 
İtiÚs
->
·ck‘_id_fe
 = 
p
[1];

7583 ià(
	`¡»q
(
p
[0], "test-crypto") && !p[1])

7585 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7586 
İtiÚs
->
‹¡_üy±o
 = 
Œue
;

7588 #iâdeà
ENABLE_CRYPTO_MBEDTLS


7589 ià(
	`¡»q
(
p
[0], "engine") && !p[2])

7591 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7592 ià(
p
[1])

7594 
İtiÚs
->
’gše
 = 
p
[1];

7598 
İtiÚs
->
’gše
 = "auto";

7602 #ifdeà
HAVE_EVP_CIPHER_CTX_SET_KEY_LENGTH


7603 ià(
	`¡»q
(
p
[0], "keysize") &&…[1] && !p[2])

7605 
keysize
;

7607 
	`VERIFY_PERMISSION
(
OPT_P_NCP
);

7608 
keysize
 = 
	`©oi
(
p
[1]) / 8;

7609 ià(
keysize
 < 0 || keysiz> 
MAX_CIPHER_KEY_LENGTH
)

7611 
	`msg
(
msgËv–
, "Bad keysize: %s", 
p
[1]);

7612 
”r
;

7614 
İtiÚs
->
keysize
 = keysize;

7617 #ifdeà
ENABLE_PREDICTION_RESISTANCE


7618 ià(
	`¡»q
(
p
[0], "use-prediction-resistance") && !p[1])

7620 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7621 
İtiÚs
->
u£_´ediùiÚ_»si¡ªû
 = 
Œue
;

7624 ià(
	`¡»q
(
p
[0], "show-tls") && !p[1])

7626 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7627 
İtiÚs
->
show_s_ch”s
 = 
Œue
;

7629 ià(
	`¡»q
(
p
[0], "show-curves") && !p[1])

7631 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7632 
İtiÚs
->
show_curves
 = 
Œue
;

7634 ià(
	`¡»q
(
p
[0], "ecdh-curve") &&…[1] && !p[2])

7636 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7637 
İtiÚs
->
ecdh_curve
 = 
p
[1];

7639 ià(
	`¡»q
(
p
[0], "tls-server") && !p[1])

7641 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7642 
İtiÚs
->
s_£rv”
 = 
Œue
;

7644 ià(
	`¡»q
(
p
[0], "tls-client") && !p[1])

7646 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7647 
İtiÚs
->
s_ş›Á
 = 
Œue
;

7649 ià(
	`¡»q
(
p
[0], "ÿ"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7651 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7652 
İtiÚs
->
ÿ_fe
 = 
p
[1];

7653 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7655 
İtiÚs
->
ÿ_fe_šlše
 = 
p
[2];

7658 #iâdeà
ENABLE_CRYPTO_MBEDTLS


7659 ià(
	`¡»q
(
p
[0], "capath") &&…[1] && !p[2])

7661 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7662 
İtiÚs
->
ÿ_·th
 = 
p
[1];

7665 ià(
	`¡»q
(
p
[0], "dh"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7667 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7668 
İtiÚs
->
dh_fe
 = 
p
[1];

7669 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7671 
İtiÚs
->
dh_fe_šlše
 = 
p
[2];

7674 ià(
	`¡»q
(
p
[0], "û¹"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7676 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7677 
İtiÚs
->
û¹_fe
 = 
p
[1];

7678 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7680 
İtiÚs
->
û¹_fe_šlše
 = 
p
[2];

7683 ià(
	`¡»q
(
p
[0], "exŒa-û¹s"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7685 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7686 
İtiÚs
->
exŒa_û¹s_fe
 = 
p
[1];

7687 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7689 
İtiÚs
->
exŒa_û¹s_fe_šlše
 = 
p
[2];

7692 ià(
	`¡»q
(
p
[0], "verify-hash") &&…[1] && !p[3])

7694 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7696 ià(!
p
[2] || (p[2] && 
	`¡»q
(p[2], "SHA1")))

7698 
İtiÚs
->
v”ify_hash
 = 
	`·r£_hash_fšg”´št
(
p
[1], 
SHA_DIGEST_LENGTH
, 
msgËv–
, &İtiÚs->
gc
);

7699 
İtiÚs
->
v”ify_hash_®go
 = 
MD_SHA1
;

7701 ià(
p
[2] && 
	`¡»q
(p[2], "SHA256"))

7703 
İtiÚs
->
v”ify_hash
 = 
	`·r£_hash_fšg”´št
(
p
[1], 
SHA256_DIGEST_LENGTH
, 
msgËv–
, &İtiÚs->
gc
);

7704 
İtiÚs
->
v”ify_hash_®go
 = 
MD_SHA256
;

7708 
	`msg
(
msgËv–
, "šv®id o¸unsuµÜ‹d hashšg‡lgÜ™hm: %  (Úly SHA1‡nd SHA256‡» v®id)", 
p
[2]);

7709 
”r
;

7712 #ifdeà
ENABLE_CRYPTOAPI


7713 ià(
	`¡»q
(
p
[0], "cryptoapicert") &&…[1] && !p[2])

7715 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7716 
İtiÚs
->
üy±ßpi_û¹
 = 
p
[1];

7719 ià(
	`¡»q
(
p
[0], "key"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7721 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7722 
İtiÚs
->
´iv_key_fe
 = 
p
[1];

7723 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7725 
İtiÚs
->
´iv_key_fe_šlše
 = 
p
[2];

7728 ià(
	`¡»q
(
p
[0], "tls-version-min") &&…[1] && !p[3])

7730 
v”
;

7731 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7732 
v”
 = 
	`s_v”siÚ_·r£
(
p
[1],…[2]);

7733 ià(
v”
 =ğ
TLS_VER_BAD
)

7735 
	`msg
(
msgËv–
, "unknowÀs-v”siÚ-mš…¬am‘”: %s", 
p
[1]);

7736 
”r
;

7738 
İtiÚs
->
s¦_æags
 &=

7739 ~(
SSLF_TLS_VERSION_MIN_MASK
 << 
SSLF_TLS_VERSION_MIN_SHIFT
);

7740 
İtiÚs
->
s¦_æags
 |ğ(
v”
 << 
SSLF_TLS_VERSION_MIN_SHIFT
);

7742 ià(
	`¡»q
(
p
[0], "tls-version-max") &&…[1] && !p[2])

7744 
v”
;

7745 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7746 
v”
 = 
	`s_v”siÚ_·r£
(
p
[1], 
NULL
);

7747 ià(
v”
 =ğ
TLS_VER_BAD
)

7749 
	`msg
(
msgËv–
, "unknowÀs-v”siÚ-max…¬am‘”: %s", 
p
[1]);

7750 
”r
;

7752 
İtiÚs
->
s¦_æags
 &=

7753 ~(
SSLF_TLS_VERSION_MAX_MASK
 << 
SSLF_TLS_VERSION_MAX_SHIFT
);

7754 
İtiÚs
->
s¦_æags
 |ğ(
v”
 << 
SSLF_TLS_VERSION_MAX_SHIFT
);

7756 #iâdeà
ENABLE_CRYPTO_MBEDTLS


7757 ià(
	`¡»q
(
p
[0], "pkcs12"è&&…[1] && ((¡»qÕ[1], 
INLINE_FILE_TAG
) &&…[2]) || !p[2]) && !p[3])

7759 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7760 
İtiÚs
->
pkcs12_fe
 = 
p
[1];

7761 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7763 
İtiÚs
->
pkcs12_fe_šlše
 = 
p
[2];

7767 ià(
	`¡»q
(
p
[0], "askpass") && !p[2])

7769 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7770 ià(
p
[1])

7772 
İtiÚs
->
key_·ss_fe
 = 
p
[1];

7776 
İtiÚs
->
key_·ss_fe
 = "stdin";

7779 ià(
	`¡»q
(
p
[0], "auth-nocache") && !p[1])

7781 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7782 
	`s¦_£t_auth_noÿche
();

7784 ià(
	`¡»q
(
p
[0], "auth-token") &&…[1] && !p[2])

7786 
	`VERIFY_PERMISSION
(
OPT_P_ECHO
);

7787 
	`s¦_£t_auth_tok’
(
p
[1]);

7788 #ifdeà
ENABLE_MANAGEMENT


7789 ià(
mªagem’t
)

7791 
	`mªagem’t_auth_tok’
(
mªagem’t
, 
p
[1]);

7795 ià(
	`¡»q
(
p
[0], "single-session") && !p[1])

7797 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7798 
İtiÚs
->
sšgË_£ssiÚ
 = 
Œue
;

7800 #ifdeà
ENABLE_PUSH_PEER_INFO


7801 ià(
	`¡»q
(
p
[0], "push-peer-info") && !p[1])

7803 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7804 
İtiÚs
->
push_³”_šfo
 = 
Œue
;

7807 ià(
	`¡»q
(
p
[0], "tls-exit") && !p[1])

7809 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7810 
İtiÚs
->
s_ex™
 = 
Œue
;

7812 ià(
	`¡»q
(
p
[0], "tls-cipher") &&…[1] && !p[2])

7814 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7815 
İtiÚs
->
ch”_li¡
 = 
p
[1];

7817 ià(
	`¡»q
(
p
[0], "tls-cert-profile") &&…[1] && !p[2])

7819 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7820 
İtiÚs
->
s_û¹_´ofe
 = 
p
[1];

7822 ià(
	`¡»q
(
p
[0], "tls-ciphersuites") &&…[1] && !p[2])

7824 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7825 
İtiÚs
->
ch”_li¡_s13
 = 
p
[1];

7827 ià(
	`¡»q
(
p
[0], "crl-verify") &&…[1] && ((p[2] && streq(p[2], "dir"))

7828 || (
p
[2] && 
	`¡»q
Õ[1], 
INLINE_FILE_TAG
) ) || !p[2]) && !p[3])

7830 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7831 ià(
p
[2] && 
	`¡»q
(p[2], "dir"))

7833 
İtiÚs
->
s¦_æags
 |ğ
SSLF_CRL_VERIFY_DIR
;

7835 
İtiÚs
->
ül_fe
 = 
p
[1];

7836 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

7838 
İtiÚs
->
ül_fe_šlše
 = 
p
[2];

7841 ià(
	`¡»q
(
p
[0], "tls-verify") &&…[1])

7843 
	`VERIFY_PERMISSION
(
OPT_P_SCRIPT
);

7844 ià(!
	`no_mÜe_thª_n_¬gs
(
msgËv–
, 
p
, 2, 
NM_QUOTE_HINT
))

7846 
”r
;

7848 
	`£t_u£r_süt
(
İtiÚs
, &İtiÚs->
s_v”ify
,

7849 
	`¡ršg_sub¡™u‹
(
p
[1], ',', ' ', &
İtiÚs
->
gc
),

7850 "s-v”ify", 
Œue
);

7852 #iâdeà
ENABLE_CRYPTO_MBEDTLS


7853 ià(
	`¡»q
(
p
[0], "tls-export-cert") &&…[1] && !p[2])

7855 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7856 
İtiÚs
->
s_expÜt_û¹
 = 
p
[1];

7859 #ià
P2MP_SERVER


7860 ià(
	`¡»q
(
p
[0], "compat-names") && ((p[1] && streq(p[1], "no-remapping")) || !p[1]) && !p[2])

7862 ià(
	`¡»q
(
p
[0], "compat-names") && !p[1])

7865 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7866 ià(
İtiÚs
->
v”ify_x509_ty³
 !ğ
VERIFY_X509_NONE
)

7868 
	`msg
(
msgËv–
, "you cannot use --compat-names with --verify-x509-name");

7869 
”r
;

7871 
	`msg
(
M_WARN
, "DEPRECATED OPTION: --compat-names,…lease update your configuration. This will be„emoved in OpenVPN 2.5.");

7872 
	`com·t_æag
(
COMPAT_FLAG_SET
 | 
COMPAT_NAMES
);

7873 #ià
P2MP_SERVER


7874 ià(
p
[1] && 
	`¡»q
(p[1], "no-remapping"))

7876 
	`com·t_æag
(
COMPAT_FLAG_SET
 | 
COMPAT_NO_NAME_REMAPPING
);

7879 ià(
	`¡»q
(
p
[0], "no-name-remapping") && !p[1])

7881 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7882 ià(
İtiÚs
->
v”ify_x509_ty³
 !ğ
VERIFY_X509_NONE
)

7884 
	`msg
(
msgËv–
, "you cannot use --no-name-remapping with --verify-x509-name");

7885 
”r
;

7887 
	`msg
(
M_WARN
, "DEPRECATED OPTION: --no-name-remapping,…lease update your configuration. This will be„emoved in OpenVPN 2.5.");

7888 
	`com·t_æag
(
COMPAT_FLAG_SET
 | 
COMPAT_NAMES
);

7889 
	`com·t_æag
(
COMPAT_FLAG_SET
 | 
COMPAT_NO_NAME_REMAPPING
);

7892 ià(
	`¡»q
(
p
[0], "v”ify-x509-Çme"è&&…[1] && 
	`¡¾’
(p[1]) && !p[3])

7894 
ty³
 = 
VERIFY_X509_SUBJECT_DN
;

7895 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7896 ià(
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

7898 
	`msg
(
msgËv–
, "you cannot use --verify-x509-name with "

7900 
”r
;

7902 ià(
p
[2])

7904 ià(
	`¡»q
(
p
[2], "subject"))

7906 
ty³
 = 
VERIFY_X509_SUBJECT_DN
;

7908 ià(
	`¡»q
(
p
[2], "name"))

7910 
ty³
 = 
VERIFY_X509_SUBJECT_RDN
;

7912 ià(
	`¡»q
(
p
[2], "name-prefix"))

7914 
ty³
 = 
VERIFY_X509_SUBJECT_RDN_PREFIX
;

7918 
	`msg
(
msgËv–
, "unknowÀX.509‚amty³: %s", 
p
[2]);

7919 
”r
;

7922 
İtiÚs
->
v”ify_x509_ty³
 = 
ty³
;

7923 
İtiÚs
->
v”ify_x509_Çme
 = 
p
[1];

7925 ià(
	`¡»q
(
p
[0], "ns-cert-type") &&…[1] && !p[2])

7927 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7928 ià(
	`¡»q
(
p
[1], "server"))

7930 
İtiÚs
->
ns_û¹_ty³
 = 
NS_CERT_CHECK_SERVER
;

7932 ià(
	`¡»q
(
p
[1], "client"))

7934 
İtiÚs
->
ns_û¹_ty³
 = 
NS_CERT_CHECK_CLIENT
;

7938 
	`msg
(
msgËv–
, "--ns-cert-type must be 'client' or 'server'");

7939 
”r
;

7942 ià(
	`¡»q
(
p
[0], "remote-cert-ku"))

7944 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7946 
size_t
 
j
;

7947 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

7949 
	`ssÿnf
(
p
[
j
], "%x", &(
İtiÚs
->
»mÙe_û¹_ku
[j-1]));

7951 ià(
j
 == 1)

7954 
İtiÚs
->
»mÙe_û¹_ku
[0] = 
OPENVPN_KU_REQUIRED
;

7957 ià(
	`¡»q
(
p
[0], "remote-cert-eku") &&…[1] && !p[2])

7959 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7960 
İtiÚs
->
»mÙe_û¹_eku
 = 
p
[1];

7962 ià(
	`¡»q
(
p
[0], "remote-cert-tls") &&…[1] && !p[2])

7964 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

7966 ià(
	`¡»q
(
p
[1], "server"))

7968 
İtiÚs
->
»mÙe_û¹_ku
[0] = 
OPENVPN_KU_REQUIRED
;

7969 
İtiÚs
->
»mÙe_û¹_eku
 = "TLS Web Server Authentication";

7971 ià(
	`¡»q
(
p
[1], "client"))

7973 
İtiÚs
->
»mÙe_û¹_ku
[0] = 
OPENVPN_KU_REQUIRED
;

7974 
İtiÚs
->
»mÙe_û¹_eku
 = "TLS Web Client Authentication";

7978 
	`msg
(
msgËv–
, "--remote-cert-tls must be 'client' or 'server'");

7979 
”r
;

7982 ià(
	`¡»q
(
p
[0], "tls-timeout") &&…[1] && !p[2])

7984 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

7985 
İtiÚs
->
s_timeout
 = 
	`pos™ive_©oi
(
p
[1]);

7987 ià(
	`¡»q
(
p
[0], "reneg-bytes") &&…[1] && !p[2])

7989 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

7990 
İtiÚs
->
»ÃgÙŸ‹_by‹s
 = 
	`pos™ive_©oi
(
p
[1]);

7992 ià(
	`¡»q
(
p
[0], "reneg-pkts") &&…[1] && !p[2])

7994 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

7995 
İtiÚs
->
»ÃgÙŸ‹_·ck‘s
 = 
	`pos™ive_©oi
(
p
[1]);

7997 ià(
	`¡»q
(
p
[0], "reneg-sec") &&…[1] && !p[2])

7999 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

8000 
İtiÚs
->
»ÃgÙŸ‹_£cÚds
 = 
	`pos™ive_©oi
(
p
[1]);

8002 ià(
	`¡»q
(
p
[0], "hand-window") &&…[1] && !p[2])

8004 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

8005 
İtiÚs
->
hªdshake_wšdow
 = 
	`pos™ive_©oi
(
p
[1]);

8007 ià(
	`¡»q
(
p
[0], "tran-window") &&…[1] && !p[2])

8009 
	`VERIFY_PERMISSION
(
OPT_P_TLS_PARMS
);

8010 
İtiÚs
->
Œªs™iÚ_wšdow
 = 
	`pos™ive_©oi
(
p
[1]);

8012 ià(
	`¡»q
(
p
[0], "tls-auth") &&…[1] && !p[3])

8014 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8015 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

8017 
İtiÚs
->
s_auth_fe_šlše
 = 
p
[2];

8019 ià(
p
[2])

8021 
key_dœeùiÚ
;

8023 
key_dœeùiÚ
 = 
	`ascii2keydœeùiÚ
(
msgËv–
, 
p
[2]);

8024 ià(
key_dœeùiÚ
 >= 0)

8026 
İtiÚs
->
key_dœeùiÚ
 = key_direction;

8030 
”r
;

8033 
İtiÚs
->
s_auth_fe
 = 
p
[1];

8035 ià(
	`¡»q
(
p
[0], "tls-crypt") &&…[1] && !p[3])

8037 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8038 ià(
	`¡»q
(
p
[1], 
INLINE_FILE_TAG
) &&…[2])

8040 
İtiÚs
->
s_üy±_šlše
 = 
p
[2];

8042 
İtiÚs
->
s_üy±_fe
 = 
p
[1];

8044 ià(
	`¡»q
(
p
[0], "key-method") &&…[1] && !p[2])

8046 
key_m‘hod
;

8048 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8049 
key_m‘hod
 = 
	`©oi
(
p
[1]);

8050 ià(
key_m‘hod
 < 
KEY_METHOD_MIN
 || key_m‘hod > 
KEY_METHOD_MAX
)

8052 
	`msg
(
msgËv–
, "key_method…arameter (%d) must be >= %d‡nd <= %d",

8053 
key_m‘hod
,

8054 
KEY_METHOD_MIN
,

8055 
KEY_METHOD_MAX
);

8056 
”r
;

8058 
İtiÚs
->
key_m‘hod
 = key_method;

8060 ià(
	`¡»q
(
p
[0], "x509-track") &&…[1] && !p[2])

8062 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8063 
	`x509_Œack_add
(&
İtiÚs
->
x509_Œack
, 
p
[1], 
msgËv–
, &İtiÚs->
gc
);

8065 #ifdeà
ENABLE_X509ALTUSERNAME


8066 ià(
	`¡»q
(
p
[0], "x509-username-field") &&…[1] && !p[2])

8075 *
s
 = 
p
[1];

8077 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8078 ià(
	`¡ºcmp
("ext:", 
s
, 4) != 0)

8080 
size_t
 
i
 = 0;

8081 
s
[
i
] && !
	`isuµ”
(s[i]))

8083 
i
++;

8085 ià(
	`¡¾’
(
s
è=ğ
i
)

8087 (*
s
 = 
	`touµ”
(*s)) != '\0')

8089 
s
++;

8091 
	`msg
(
M_WARN
, "DEPRECATED FEATURE:‡utomatically upcasedhe "

8093 "cÚfigu¿tiÚ", 
p
[1]);

8096 ià(!
	`x509_u£ºame_f›ld_ext_suµÜ‹d
(
s
+4))

8098 
	`msg
(
msgËv–
, "UnsuµÜ‹d x509-u£ºame-f›ldƒx‹nsiÚ: %s", 
s
);

8100 
İtiÚs
->
x509_u£ºame_f›ld
 = 
p
[1];

8104 #ifdeà
ENABLE_PKCS11


8105 ià(
	`¡»q
(
p
[0], "show-pkcs11-ids") && !p[3])

8107 *
´ovid”
 = 
p
[1];

8108 
boŞ
 
û¹_´iv©e
 = (
p
[2] =ğ
NULL
 ? 
çl£
 : ( 
	`©oi
(p[2]) != 0 ));

8110 #ifdeà
DEFAULT_PKCS11_MODULE


8111 ià(!
´ovid”
)

8113 
´ovid”
 = 
DEFAULT_PKCS11_MODULE
;

8115 ià(!
p
[2])

8117 *
’dp
 = 
NULL
;

8118 
i
 = 
	`¡¹Ş
(
´ovid”
, &
’dp
, 10);

8120 ià(*
’dp
 == 0)

8124 
´ovid”
 = 
DEFAULT_PKCS11_MODULE
;

8125 
û¹_´iv©e
 = 
i
;

8129 ià(!
´ovid”
)

8131 
	`msg
(
msgËv–
, "--show-pkcs11-ids„equires‡…rovider…arameter");

8132 
”r
;

8135 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8137 
	`£t_debug_Ëv–
(
İtiÚs
->
v”bos™y
, 
SDL_CONSTRAIN
);

8138 
	`show_pkcs11_ids
(
´ovid”
, 
û¹_´iv©e
);

8139 
	`İ’v²_ex™
(
OPENVPN_EXIT_STATUS_GOOD
);

8141 ià(
	`¡»q
(
p
[0], "pkcs11-providers") &&…[1])

8143 
j
;

8145 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8147 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

8149 
İtiÚs
->
pkcs11_´ovid”s
[
j
-1] = 
p
[j];

8152 ià(
	`¡»q
(
p
[0], "pkcs11-protected-authentication"))

8154 
j
;

8156 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8158 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

8160 
İtiÚs
->
pkcs11_´Ùeùed_auth’tiÿtiÚ
[
j
-1] = 
	`©oi
(
p
[j]) != 0 ? 1 : 0;

8163 ià(
	`¡»q
(
p
[0], "pkcs11-private-mode") &&…[1])

8165 
j
;

8167 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8169 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

8171 
	`ssÿnf
(
p
[
j
], "%x", &(
İtiÚs
->
pkcs11_´iv©e_mode
[j-1]));

8174 ià(
	`¡»q
(
p
[0], "pkcs11-cert-private"))

8176 
j
;

8178 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8180 
j
 = 1; j < 
MAX_PARMS
 && 
p
[j] !ğ
NULL
; ++j)

8182 
İtiÚs
->
pkcs11_û¹_´iv©e
[
j
-1] = 
	`©oi
(
p
[j]) != 0 ? 1 : 0;

8185 ià(
	`¡»q
(
p
[0], "pkcs11-pin-cache") &&…[1] && !p[2])

8187 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8188 
İtiÚs
->
pkcs11_pš_ÿche_³riod
 = 
	`©oi
(
p
[1]);

8190 ià(
	`¡»q
(
p
[0], "pkcs11-id") &&…[1] && !p[2])

8192 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8193 
İtiÚs
->
pkcs11_id
 = 
p
[1];

8195 ià(
	`¡»q
(
p
[0], "pkcs11-id-management") && !p[1])

8197 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8198 
İtiÚs
->
pkcs11_id_mªagem’t
 = 
Œue
;

8201 ià(
	`¡»q
(
p
[0], "rmtun") && !p[1])

8203 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8204 
İtiÚs
->
³rsi¡_cÚfig
 = 
Œue
;

8205 
İtiÚs
->
³rsi¡_mode
 = 0;

8207 ià(
	`¡»q
(
p
[0], "mktun") && !p[1])

8209 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8210 
İtiÚs
->
³rsi¡_cÚfig
 = 
Œue
;

8211 
İtiÚs
->
³rsi¡_mode
 = 1;

8213 ià(
	`¡»q
(
p
[0], "peer-id") &&…[1] && !p[2])

8215 
	`VERIFY_PERMISSION
(
OPT_P_PEER_ID
);

8216 
İtiÚs
->
u£_³”_id
 = 
Œue
;

8217 
İtiÚs
->
³”_id
 = 
	`©oi
(
p
[1]);

8219 #ià
	`defšed
(
ENABLE_CRYPTO_OPENSSL
è&& 
OPENSSL_VERSION_NUMBER
 >= 0x10001000

8220 ià(
	`¡»q
(
p
[0], "keying-material-exporter") &&…[1] &&…[2])

8222 
ekm_Ëngth
 = 
	`pos™ive_©oi
(
p
[2]);

8224 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8226 ià(
	`¡ºcmp
(
p
[1], "EXPORTER", 8))

8228 
	`msg
(
msgËv–
, "Keying materialƒxporter†abel must begin with "

8230 
”r
;

8232 ià(
ekm_Ëngth
 < 16 ||ƒkm_length > 4095)

8234 
	`msg
(
msgËv–
, "Invalid keying materialƒxporter†ength");

8235 
”r
;

8238 
İtiÚs
->
keyšg_m©”Ÿl_expÜ‹r_Ïb–
 = 
p
[1];

8239 
İtiÚs
->
keyšg_m©”Ÿl_expÜ‹r_Ëngth
 = 
ekm_Ëngth
;

8242 ià(
	`¡»q
(
p
[0], "allow-recursive-routing") && !p[1])

8244 
	`VERIFY_PERMISSION
(
OPT_P_GENERAL
);

8245 
İtiÚs
->
®low_»cursive_routšg
 = 
Œue
;

8249 
i
;

8250 
msgËv–
 = 
msgËv–_fc
;

8253 
i
 = 0; 
İtiÚs
->
ignÜe_unknown_İtiÚ
 && options->ignore_unknown_option[i]; i++)

8255 ià(
	`¡»q
(
p
[0], 
İtiÚs
->
ignÜe_unknown_İtiÚ
[
i
]))

8257 
msgËv–
 = 
M_WARN
;

8261 ià(
fe
)

8263 
	`msg
(
msgËv–
, "UÄecognized o±iÚ o¸missšg o¸exŒ¨·¿m‘”(sèš %s:%d: % (%s)", 
fe
, 
lše
, 
p
[0], 
PACKAGE_VERSION
);

8267 
	`msg
(
msgËv–
, "UÄecognized o±iÚ o¸missšg o¸exŒ¨·¿m‘”(s): --% (%s)", 
p
[0], 
PACKAGE_VERSION
);

8270 
”r
:

8271 
	`gc_ä“
(&
gc
);

8272 
	}
}

	@options.h

29 #iâdeà
OPTIONS_H


30 
	#OPTIONS_H


	)

32 
	~"basic.h
"

33 
	~"commÚ.h
"

34 
	~"mtu.h
"

35 
	~"rou‹.h
"

36 
	~"tun.h
"

37 
	~"sock‘.h
"

38 
	~"¶ugš.h
"

39 
	~"mªage.h
"

40 
	~"´oxy.h
"

41 
	~"comp.h
"

42 
	~"pushli¡.h
"

43 
	~"şš©.h
"

44 #ifdeà
ENABLE_CRYPTO


45 
	~"üy±o_back’d.h
"

53 
	#MAX_PARMS
 16

	)

58 
	#OPTION_PARM_SIZE
 256

	)

59 
	#OPTION_LINE_SIZE
 256

	)

61 cÚ¡ 
t™Ë_¡ršg
[];

63 #ià
P2MP


66 
	sİtiÚs_´e_puÎ


68 
boŞ
 
	mtuÁ­_İtiÚs_defšed
;

69 
tuÁ­_İtiÚs
 
	mtuÁ­_İtiÚs
;

71 
boŞ
 
	mrou‹s_defšed
;

72 
rou‹_İtiÚ_li¡
 *
	mrou‹s
;

74 
boŞ
 
	mrou‹s_v6_defšed
;

75 
rou‹_v6_İtiÚ_li¡
 *
	mrou‹s_v6
;

77 
boŞ
 
	mş›Á_Çt_defšed
;

78 
ş›Á_Çt_İtiÚ_li¡
 *
	mş›Á_Çt
;

80 
	mfÜeign_İtiÚ_šdex
;

84 #ià
defšed
(
ENABLE_CRYPTO
è&& !defšed(
ENABLE_CRYPTO_OPENSSL
è&& !defšed(
ENABLE_CRYPTO_MBEDTLS
)

88 
	scÚÃùiÚ_’Œy


90 
	m´Ùo
;

91 
§_çmy_t
 
	maf
;

92 cÚ¡ *
	mloÿl_pÜt
;

93 
boŞ
 
	mloÿl_pÜt_defšed
;

94 cÚ¡ *
	m»mÙe_pÜt
;

95 cÚ¡ *
	mloÿl
;

96 cÚ¡ *
	m»mÙe
;

97 
boŞ
 
	m»mÙe_æßt
;

98 
boŞ
 
	mbšd_defšed
;

99 
boŞ
 
	mbšd_v6_Úly
;

100 
boŞ
 
	mbšd_loÿl
;

101 
	mcÚÃù_»Œy_£cÚds
;

102 
	mcÚÃù_»Œy_£cÚds_max
;

103 
	mcÚÃù_timeout
;

104 
h‰p_´oxy_İtiÚs
 *
	mh‰p_´oxy_İtiÚs
;

105 cÚ¡ *
	msocks_´oxy_£rv”
;

106 cÚ¡ *
	msocks_´oxy_pÜt
;

107 cÚ¡ *
	msocks_´oxy_authfe
;

109 
	mtun_mtu
;

110 
boŞ
 
	mtun_mtu_defšed
;

111 
	mtun_mtu_exŒa
;

112 
boŞ
 
	mtun_mtu_exŒa_defšed
;

113 
	mlšk_mtu
;

114 
boŞ
 
	mlšk_mtu_defšed
;

117 
	mmtu_discov”_ty³
;

119 
	mäagm’t
;

120 
	mmssfix
;

121 
boŞ
 
	mmssfix_deçuÉ
;

123 
	mex¶ic™_ex™_nÙifiÿtiÚ
;

125 
	#CE_DISABLED
 (1<<0)

	)

126 
	#CE_MAN_QUERY_PROXY
 (1<<1)

	)

127 
	#CE_MAN_QUERY_REMOTE_UNDEF
 0

	)

128 
	#CE_MAN_QUERY_REMOTE_QUERY
 1

	)

129 
	#CE_MAN_QUERY_REMOTE_ACCEPT
 2

	)

130 
	#CE_MAN_QUERY_REMOTE_MOD
 3

	)

131 
	#CE_MAN_QUERY_REMOTE_SKIP
 4

	)

132 
	#CE_MAN_QUERY_REMOTE_MASK
 (0x07)

	)

133 
	#CE_MAN_QUERY_REMOTE_SHIFT
 (2)

	)

134 
	mæags
;

137 
	s»mÙe_’Œy


139 cÚ¡ *
	m»mÙe
;

140 cÚ¡ *
	m»mÙe_pÜt
;

141 
	m´Ùo
;

142 
§_çmy_t
 
	maf
;

145 
	#CONNECTION_LIST_SIZE
 64

	)

147 
	scÚÃùiÚ_li¡


149 
	mËn
;

150 
	mcu¼’t
;

151 
cÚÃùiÚ_’Œy
 *
	m¬¿y
[
CONNECTION_LIST_SIZE
];

154 
	s»mÙe_li¡


156 
	mËn
;

157 
»mÙe_’Œy
 *
	m¬¿y
[
CONNECTION_LIST_SIZE
];

160 
	s»mÙe_ho¡_¡Üe


162 
	#RH_HOST_LEN
 80

	)

163 
	mho¡
[
RH_HOST_LEN
];

164 
	#RH_PORT_LEN
 20

	)

165 
	mpÜt
[
RH_PORT_LEN
];

169 
	sİtiÚs


171 
gc_¬’a
 
	mgc
;

172 
boŞ
 
	mgc_owÃd
;

175 cÚ¡ *
	mcÚfig
;

178 
	#MODE_POINT_TO_POINT
 0

	)

179 
	#MODE_SERVER
 1

	)

180 
	mmode
;

183 
boŞ
 
	mfÜw¬d_com·tibË
;

185 cÚ¡ **
	mignÜe_unknown_İtiÚ
;

188 
boŞ
 
	m³rsi¡_cÚfig
;

189 
	m³rsi¡_mode
;

191 #ifdeà
ENABLE_CRYPTO


192 cÚ¡ *
	mkey_·ss_fe
;

193 
boŞ
 
	mshow_ch”s
;

194 
boŞ
 
	mshow_dige¡s
;

195 
boŞ
 
	mshow_’gšes
;

196 
boŞ
 
	mshow_s_ch”s
;

197 
boŞ
 
	mshow_curves
;

198 
boŞ
 
	mg’key
;

202 
	mcÚÃù_»Œy_max
;

203 
cÚÃùiÚ_’Œy
 
	mû
;

204 
cÚÃùiÚ_li¡
 *
	mcÚÃùiÚ_li¡
;

206 
»mÙe_li¡
 *
	m»mÙe_li¡
;

208 
boŞ
 
	mno_advªû
;

210 
	munsucûssful_©‹m±s
;

212 #ià
ENABLE_MANAGEMENT


213 
h‰p_´oxy_İtiÚs
 *
	mh‰p_´oxy_ov”ride
;

216 
»mÙe_ho¡_¡Üe
 *
	mrh_¡Üe
;

218 
boŞ
 
	m»mÙe_¿ndom
;

219 cÚ¡ *
	mchªge
;

220 cÚ¡ *
	mdev
;

221 cÚ¡ *
	mdev_ty³
;

222 cÚ¡ *
	mdev_node
;

223 cÚ¡ *
	mÎaddr
;

224 
	mtİŞogy
;

225 cÚ¡ *
	mifcÚfig_loÿl
;

226 cÚ¡ *
	mifcÚfig_»mÙe_Ãtmask
;

227 cÚ¡ *
	mifcÚfig_v6_loÿl
;

228 
	mifcÚfig_v6_Ãtb™s
;

229 cÚ¡ *
	mifcÚfig_v6_»mÙe
;

230 
boŞ
 
	mifcÚfig_nÛxec
;

231 
boŞ
 
	mifcÚfig_now¬n
;

232 #ifdeà
ENABLE_FEATURE_SHAPER


233 
	msh­”
;

236 
	m´Ùo_fÜû
;

238 #ifdeà
ENABLE_OCC


239 
boŞ
 
	mmtu_‹¡
;

242 #ifdeà
ENABLE_MEMSTATS


243 *
	mmem¡©s_â
;

246 
boŞ
 
	mmlock
;

248 
	mk“·live_pšg
;

249 
	mk“·live_timeout
;

251 
	mšaùiv™y_timeout
;

252 
	mšaùiv™y_mšimum_by‹s
;

254 
	mpšg_£nd_timeout
;

255 
	mpšg_»c_timeout
;

256 
boŞ
 
	mpšg_tim”_»mÙe
;

258 
	#PING_UNDEF
 0

	)

259 
	#PING_EXIT
 1

	)

260 
	#PING_RESTART
 2

	)

261 
	mpšg_»c_timeout_aùiÚ
;

263 
boŞ
 
	m³rsi¡_tun
;

264 
boŞ
 
	m³rsi¡_loÿl_
;

265 
boŞ
 
	m³rsi¡_»mÙe_
;

266 
boŞ
 
	m³rsi¡_key
;

268 #ià
PASSTOS_CAPABILITY


269 
boŞ
 
	m·s¡os
;

272 
	m»sŞve_»Œy_£cÚds
;

273 
boŞ
 
	m»sŞve_š_advªû
;

274 cÚ¡ *
	m_»mÙe_hšt
;

276 
tuÁ­_İtiÚs
 
	mtuÁ­_İtiÚs
;

279 cÚ¡ *
	mu£ºame
;

280 cÚ¡ *
	mgrou²ame
;

281 cÚ¡ *
	mchroÙ_dœ
;

282 cÚ¡ *
	mcd_dœ
;

283 #ifdeà
ENABLE_SELINUX


284 *
	m£lšux_cÚ‹xt
;

286 cÚ¡ *
	mwr™•id
;

287 cÚ¡ *
	mup_süt
;

288 cÚ¡ *
	mdown_süt
;

289 
boŞ
 
	mu£r_süt_u£d
;

290 
boŞ
 
	mdown_´e
;

291 
boŞ
 
	mup_d–ay
;

292 
boŞ
 
	mup_»¡¬t
;

293 
boŞ
 
	md«mÚ
;

295 
	m»m­_sigu¤1
;

298 
	mš‘d
;

300 
boŞ
 
	mlog
;

301 
boŞ
 
	msuµ»ss_time¡amps
;

302 
boŞ
 
	mmachše_»adabË_ouut
;

303 
	mniû
;

304 
	mv”bos™y
;

305 
	mmu‹
;

307 #ifdeà
ENABLE_DEBUG


308 
	mg»mlš
;

311 cÚ¡ *
	m¡©us_fe
;

312 
	m¡©us_fe_v”siÚ
;

313 
	m¡©us_fe_upd©e_äeq
;

316 
boŞ
 
	mç¡_io
;

318 #ifdeà
USE_COMP


319 
com´ess_İtiÚs
 
	mcomp
;

323 
	mrcvbuf
;

324 
	m¢dbuf
;

327 
	mm¬k
;

330 
	msockæags
;

333 cÚ¡ *
	mrou‹_süt
;

334 cÚ¡ *
	mrou‹_´edown_süt
;

335 cÚ¡ *
	mrou‹_deçuÉ_g©eway
;

336 
	mrou‹_deçuÉ_m‘ric
;

337 
boŞ
 
	mrou‹_nÛxec
;

338 
	mrou‹_d–ay
;

339 
	mrou‹_d–ay_wšdow
;

340 
boŞ
 
	mrou‹_d–ay_defšed
;

341 
rou‹_İtiÚ_li¡
 *
	mrou‹s
;

342 
rou‹_v6_İtiÚ_li¡
 *
	mrou‹s_v6
;

343 
boŞ
 
	mrou‹_nİuÎ
;

344 
boŞ
 
	mrou‹_g©eway_vŸ_dhı
;

345 
boŞ
 
	m®low_puÎ_fqdn
;

346 
ş›Á_Çt_İtiÚ_li¡
 *
	mş›Á_Çt
;

348 #ifdeà
ENABLE_OCC


350 
boŞ
 
	mocc
;

353 #ifdeà
ENABLE_MANAGEMENT


354 cÚ¡ *
	mmªagem’t_addr
;

355 cÚ¡ *
	mmªagem’t_pÜt
;

356 cÚ¡ *
	mmªagem’t_u£r_·ss
;

357 
	mmªagem’t_log_hi¡Üy_ÿche
;

358 
	mmªagem’t_echo_bufãr_size
;

359 
	mmªagem’t_¡©e_bufãr_size
;

360 cÚ¡ *
	mmªagem’t_wr™e_³”_šfo_fe
;

362 cÚ¡ *
	mmªagem’t_ş›Á_u£r
;

363 cÚ¡ *
	mmªagem’t_ş›Á_group
;

366 
	mmªagem’t_æags
;

367 cÚ¡ *
	mmªagem’t_û¹ifiÿ‹
;

370 #ifdeà
ENABLE_PLUGIN


371 
¶ugš_İtiÚ_li¡
 *
	m¶ugš_li¡
;

376 #ià
P2MP


378 #ià
P2MP_SERVER


380 cÚ¡ *
	mtmp_dœ
;

381 
boŞ
 
	m£rv”_defšed
;

382 
š_addr_t
 
	m£rv”_ÃtwÜk
;

383 
š_addr_t
 
	m£rv”_Ãtmask
;

384 
boŞ
 
	m£rv”_v6_defšed
;

385 
š6_addr
 
	m£rv”_ÃtwÜk_v6
;

386 
	m£rv”_Ãtb™s_v6
;

388 
	#SF_NOPOOL
 (1<<0)

	)

389 
	#SF_TCP_NODELAY_HELPER
 (1<<1)

	)

390 
	#SF_NO_PUSH_ROUTE_GATEWAY
 (1<<2)

	)

391 
	m£rv”_æags
;

393 
boŞ
 
	m£rv”_bridge_´oxy_dhı
;

395 
boŞ
 
	m£rv”_bridge_defšed
;

396 
š_addr_t
 
	m£rv”_bridge_
;

397 
š_addr_t
 
	m£rv”_bridge_Ãtmask
;

398 
š_addr_t
 
	m£rv”_bridge_poŞ_¡¬t
;

399 
š_addr_t
 
	m£rv”_bridge_poŞ_’d
;

401 
push_li¡
 
	mpush_li¡
;

402 
boŞ
 
	mifcÚfig_poŞ_defšed
;

403 
š_addr_t
 
	mifcÚfig_poŞ_¡¬t
;

404 
š_addr_t
 
	mifcÚfig_poŞ_’d
;

405 
š_addr_t
 
	mifcÚfig_poŞ_Ãtmask
;

406 cÚ¡ *
	mifcÚfig_poŞ_³rsi¡_f’ame
;

407 
	mifcÚfig_poŞ_³rsi¡_»äesh_äeq
;

409 
boŞ
 
	mifcÚfig_v6_poŞ_defšed
;

410 
š6_addr
 
	mifcÚfig_v6_poŞ_ba£
;

411 
	mifcÚfig_v6_poŞ_Ãtb™s
;

413 
	m»®_hash_size
;

414 
	mvœtu®_hash_size
;

415 cÚ¡ *
	mş›Á_cÚÃù_süt
;

416 cÚ¡ *
	mş›Á_discÚÃù_süt
;

417 cÚ¡ *
	mË¬n_add»ss_süt
;

418 cÚ¡ *
	mş›Á_cÚfig_dœ
;

419 
boŞ
 
	mccd_exşusive
;

420 
boŞ
 
	mdi§bË
;

421 
	mn_bÿ¡_buf
;

422 
	mtı_queue_lim™
;

423 
œou‹
 *
	mœou‹s
;

424 
œou‹_v6
 *
	mœou‹s_v6
;

425 
boŞ
 
	mpush_ifcÚfig_defšed
;

426 
š_addr_t
 
	mpush_ifcÚfig_loÿl
;

427 
š_addr_t
 
	mpush_ifcÚfig_»mÙe_Ãtmask
;

428 
š_addr_t
 
	mpush_ifcÚfig_loÿl_®Ÿs
;

429 
boŞ
 
	mpush_ifcÚfig_cÚ¡¿št_defšed
;

430 
š_addr_t
 
	mpush_ifcÚfig_cÚ¡¿št_ÃtwÜk
;

431 
š_addr_t
 
	mpush_ifcÚfig_cÚ¡¿št_Ãtmask
;

432 
boŞ
 
	mpush_ifcÚfig_v6_defšed
;

433 
š6_addr
 
	mpush_ifcÚfig_v6_loÿl
;

434 
	mpush_ifcÚfig_v6_Ãtb™s
;

435 
š6_addr
 
	mpush_ifcÚfig_v6_»mÙe
;

436 
boŞ
 
	mpush_ifcÚfig_v6_blocked
;

437 
boŞ
 
	m’abË_c2c
;

438 
boŞ
 
	mdu¶iÿ‹_ú
;

439 
	mcf_max
;

440 
	mcf_³r
;

441 
	mmax_ş›Ás
;

442 
	mmax_rou‹s_³r_ş›Á
;

443 
	m¡®e_rou‹s_check_š‹rv®
;

444 
	m¡®e_rou‹s_agešg_time
;

446 cÚ¡ *
	mauth_u£r_·ss_v”ify_süt
;

447 
boŞ
 
	mauth_u£r_·ss_v”ify_süt_vŸ_fe
;

448 
boŞ
 
	mauth_tok’_g’”©e
;

449 
	mauth_tok’_liãtime
;

450 #ià
PORT_SHARE


451 *
	mpÜt_sh¬e_ho¡
;

452 *
	mpÜt_sh¬e_pÜt
;

453 cÚ¡ *
	mpÜt_sh¬e_jouº®_dœ
;

457 
boŞ
 
	mş›Á
;

458 
boŞ
 
	mpuÎ
;

459 
	mpush_cÚtšu©iÚ
;

460 
	mpush_İtiÚ_ty³s_found
;

461 cÚ¡ *
	mauth_u£r_·ss_fe
;

462 
İtiÚs_´e_puÎ
 *
	m´e_puÎ
;

464 
	mscheduËd_ex™_š‹rv®
;

466 #ifdeà
ENABLE_CLIENT_CR


467 
¡©ic_ch®Ënge_šfo
 
	msc_šfo
;

471 #ifdeà
ENABLE_CRYPTO


473 cÚ¡ *
	msh¬ed_£ü‘_fe
;

474 cÚ¡ *
	msh¬ed_£ü‘_fe_šlše
;

475 
	mkey_dœeùiÚ
;

476 cÚ¡ *
	mch”Çme
;

477 
boŞ
 
	mnı_’abËd
;

478 cÚ¡ *
	mnı_ch”s
;

479 cÚ¡ *
	mauthÇme
;

480 
	mkeysize
;

481 cÚ¡ *
	m´ng_hash
;

482 
	m´ng_nÚû_£ü‘_Ën
;

483 cÚ¡ *
	m’gše
;

484 
boŞ
 
	m»¶ay
;

485 
boŞ
 
	mmu‹_»¶ay_w¬nšgs
;

486 
	m»¶ay_wšdow
;

487 
	m»¶ay_time
;

488 cÚ¡ *
	m·ck‘_id_fe
;

489 
boŞ
 
	mu£_iv
;

490 
boŞ
 
	m‹¡_üy±o
;

491 #ifdeà
ENABLE_PREDICTION_RESISTANCE


492 
boŞ
 
	mu£_´ediùiÚ_»si¡ªû
;

496 
boŞ
 
	ms_£rv”
;

497 
boŞ
 
	ms_ş›Á
;

498 cÚ¡ *
	mÿ_fe
;

499 cÚ¡ *
	mÿ_·th
;

500 cÚ¡ *
	mdh_fe
;

501 cÚ¡ *
	mû¹_fe
;

502 cÚ¡ *
	mexŒa_û¹s_fe
;

503 cÚ¡ *
	m´iv_key_fe
;

504 cÚ¡ *
	mpkcs12_fe
;

505 cÚ¡ *
	mch”_li¡
;

506 cÚ¡ *
	mch”_li¡_s13
;

507 cÚ¡ *
	ms_û¹_´ofe
;

508 cÚ¡ *
	mecdh_curve
;

509 cÚ¡ *
	ms_v”ify
;

510 
	mv”ify_x509_ty³
;

511 cÚ¡ *
	mv”ify_x509_Çme
;

512 cÚ¡ *
	ms_expÜt_û¹
;

513 cÚ¡ *
	mül_fe
;

515 cÚ¡ *
	mÿ_fe_šlše
;

516 cÚ¡ *
	mû¹_fe_šlše
;

517 cÚ¡ *
	mexŒa_û¹s_fe_šlše
;

518 cÚ¡ *
	mül_fe_šlše
;

519 *
	m´iv_key_fe_šlše
;

520 cÚ¡ *
	mdh_fe_šlše
;

521 cÚ¡ *
	mpkcs12_fe_šlše
;

523 
	mns_û¹_ty³
;

524 
	m»mÙe_û¹_ku
[
MAX_PARMS
];

525 cÚ¡ *
	m»mÙe_û¹_eku
;

526 
ušt8_t
 *
	mv”ify_hash
;

527 
hash_®go_ty³
 
	mv”ify_hash_®go
;

528 
	ms¦_æags
;

530 #ifdeà
ENABLE_PKCS11


531 cÚ¡ *
	mpkcs11_´ovid”s
[
MAX_PARMS
];

532 
	mpkcs11_´iv©e_mode
[
MAX_PARMS
];

533 
boŞ
 
	mpkcs11_´Ùeùed_auth’tiÿtiÚ
[
MAX_PARMS
];

534 
boŞ
 
	mpkcs11_û¹_´iv©e
[
MAX_PARMS
];

535 
	mpkcs11_pš_ÿche_³riod
;

536 cÚ¡ *
	mpkcs11_id
;

537 
boŞ
 
	mpkcs11_id_mªagem’t
;

540 #ifdeà
ENABLE_CRYPTOAPI


541 cÚ¡ *
	müy±ßpi_û¹
;

545 
	mkey_m‘hod
;

548 
	ms_timeout
;

551 
	m»ÃgÙŸ‹_by‹s
;

552 
	m»ÃgÙŸ‹_·ck‘s
;

553 
	m»ÃgÙŸ‹_£cÚds
;

557 
	mhªdshake_wšdow
;

559 #ifdeà
ENABLE_X509ALTUSERNAME


561 *
	mx509_u£ºame_f›ld
;

565 
	mŒªs™iÚ_wšdow
;

568 cÚ¡ *
	ms_auth_fe
;

569 cÚ¡ *
	ms_auth_fe_šlše
;

572 cÚ¡ *
	ms_üy±_fe
;

573 cÚ¡ *
	ms_üy±_šlše
;

576 
boŞ
 
	msšgË_£ssiÚ
;

578 #ifdeà
ENABLE_PUSH_PEER_INFO


579 
boŞ
 
	mpush_³”_šfo
;

582 
boŞ
 
	ms_ex™
;

586 cÚ¡ 
x509_Œack
 *
	mx509_Œack
;

589 
	mfÜeign_İtiÚ_šdex
;

591 #ifdeà
_WIN32


592 
HANDLE
 
	mmsg_chªÃl
;

593 cÚ¡ *
	mex™_ev’t_Çme
;

594 
boŞ
 
	mex™_ev’t_š™Ÿl_¡©e
;

595 
boŞ
 
	mshow_Ãt_up
;

596 
	mrou‹_m‘hod
;

597 
boŞ
 
	mblock_outside_dns
;

600 
boŞ
 
	mu£_³”_id
;

601 
ušt32_t
 
	m³”_id
;

603 #ià
defšed
(
ENABLE_CRYPTO_OPENSSL
è&& 
OPENSSL_VERSION_NUMBER
 >= 0x10001000

605 cÚ¡ *
	mkeyšg_m©”Ÿl_expÜ‹r_Ïb–
;

606 
	mkeyšg_m©”Ÿl_expÜ‹r_Ëngth
;

609 
puÎ_f‹r_li¡
 *
	mpuÎ_f‹r_li¡
;

613 
boŞ
 
	m®low_»cursive_routšg
;

616 
	#¡»q
(
x
, 
y
è(!
	`¡rcmp
((x), (y)))

	)

621 
	#OPT_P_GENERAL
 (1<<0)

	)

622 
	#OPT_P_UP
 (1<<1)

	)

623 
	#OPT_P_ROUTE
 (1<<2)

	)

624 
	#OPT_P_IPWIN32
 (1<<3)

	)

625 
	#OPT_P_SCRIPT
 (1<<4)

	)

626 
	#OPT_P_SETENV
 (1<<5)

	)

627 
	#OPT_P_SHAPER
 (1<<6)

	)

628 
	#OPT_P_TIMER
 (1<<7)

	)

629 
	#OPT_P_PERSIST
 (1<<8)

	)

630 
	#OPT_P_PERSIST_IP
 (1<<9)

	)

631 
	#OPT_P_COMP
 (1<<10è

	)

632 
	#OPT_P_MESSAGES
 (1<<11)

	)

633 
	#OPT_P_NCP
 (1<<12è

	)

634 
	#OPT_P_TLS_PARMS
 (1<<13è

	)

635 
	#OPT_P_MTU
 (1<<14è

	)

636 
	#OPT_P_NICE
 (1<<15)

	)

637 
	#OPT_P_PUSH
 (1<<16)

	)

638 
	#OPT_P_INSTANCE
 (1<<17)

	)

639 
	#OPT_P_CONFIG
 (1<<18)

	)

640 
	#OPT_P_EXPLICIT_NOTIFY
 (1<<19)

	)

641 
	#OPT_P_ECHO
 (1<<20)

	)

642 
	#OPT_P_INHERIT
 (1<<21)

	)

643 
	#OPT_P_ROUTE_EXTRAS
 (1<<22)

	)

644 
	#OPT_P_PULL_MODE
 (1<<23)

	)

645 
	#OPT_P_PLUGIN
 (1<<24)

	)

646 
	#OPT_P_SOCKBUF
 (1<<25)

	)

647 
	#OPT_P_SOCKFLAGS
 (1<<26)

	)

648 
	#OPT_P_CONNECTION
 (1<<27)

	)

649 
	#OPT_P_PEER_ID
 (1<<28)

	)

651 
	#OPT_P_DEFAULT
 (~(
OPT_P_INSTANCE
|
OPT_P_PULL_MODE
))

	)

653 #ià
P2MP


654 
	#PULL_DEFINED
(
İt
è((İt)->
puÎ
)

	)

655 #ià
P2MP_SERVER


656 
	#PUSH_DEFINED
(
İt
è((İt)->
push_li¡
)

	)

660 #iâdeà
PULL_DEFINED


661 
	#PULL_DEFINED
(
İt
è(
çl£
)

	)

664 #iâdeà
PUSH_DEFINED


665 
	#PUSH_DEFINED
(
İt
è(
çl£
)

	)

668 #ifdeà
_WIN32


669 
	#ROUTE_OPTION_FLAGS
(
o
è((o)->
rou‹_m‘hod
 & 
ROUTE_METHOD_MASK
)

	)

671 
	#ROUTE_OPTION_FLAGS
(
o
è(0)

	)

674 #ifdeà
ENABLE_FEATURE_SHAPER


675 
	#SHAPER_DEFINED
(
İt
è((İt)->
sh­”
)

	)

677 
	#SHAPER_DEFINED
(
İt
è(
çl£
)

	)

680 #ifdeà
ENABLE_PLUGIN


681 
	#PLUGIN_OPTION_LIST
(
İt
è((İt)->
¶ugš_li¡
)

	)

683 
	#PLUGIN_OPTION_LIST
(
İt
è(
NULL
)

	)

686 #ifdeà
MANAGEMENT_DEF_AUTH


687 
	#MAN_CLIENT_AUTH_ENABLED
(
İt
è((İt)->
mªagem’t_æags
 & 
MF_CLIENT_AUTH
)

	)

689 
	#MAN_CLIENT_AUTH_ENABLED
(
İt
è(
çl£
)

	)

692 
·r£_¬gv
(
İtiÚs
 *options,

693 cÚ¡ 
¬gc
,

694 *
¬gv
[],

695 cÚ¡ 
msgËv–
,

696 cÚ¡ 
³rmissiÚ_mask
,

697 *
İtiÚ_ty³s_found
,

698 
’v_£t
 *
es
);

700 
nÙnuÎ
(cÚ¡ *
¬g
, cÚ¡ *
desütiÚ
);

702 
u§ge_sm®l
();

704 
show_lib¿ry_v”siÚs
(cÚ¡ 
æags
);

706 #ifdeà
_WIN32


707 
show_wšdows_v”siÚ
(cÚ¡ 
æags
);

711 
š™_İtiÚs
(
İtiÚs
 *
o
, cÚ¡ 
boŞ
 
š™_gc
);

713 
unš™_İtiÚs
(
İtiÚs
 *
o
);

715 
£‹nv_£‰šgs
(
’v_£t
 *
es
, cÚ¡ 
İtiÚs
 *
o
);

717 
show_£‰šgs
(cÚ¡ 
İtiÚs
 *
o
);

719 
boŞ
 
¡ršg_defšed_equ®
(cÚ¡ *
s1
, cÚ¡ *
s2
);

721 #ifdeà
ENABLE_OCC


723 cÚ¡ *
İtiÚs_¡ršg_v”siÚ
(cÚ¡ *
s
, 
gc_¬’a
 *
gc
);

725 *
İtiÚs_¡ršg
(cÚ¡ 
İtiÚs
 *
o
,

726 cÚ¡ 
äame
 *frame,

727 
tuÁ­
 *
‰
,

728 
boŞ
 
»mÙe
,

729 
gc_¬’a
 *
gc
);

731 
boŞ
 
İtiÚs_cmp_equ®_§ã
(*
aùu®
, cÚ¡ *
ex³ùed
, 
size_t
 
aùu®_n
);

733 
İtiÚs_w¬nšg_§ã
(*
aùu®
, cÚ¡ *
ex³ùed
, 
size_t
 
aùu®_n
);

735 
boŞ
 
İtiÚs_cmp_equ®
(*
aùu®
, cÚ¡ *
ex³ùed
);

737 
İtiÚs_w¬nšg
(*
aùu®
, cÚ¡ *
ex³ùed
);

751 *
İtiÚs_¡ršg_exŒaù_İtiÚ
(cÚ¡ *
İtiÚs_¡ršg
,

752 cÚ¡ *
İt_Çme
, 
gc_¬’a
 *
gc
);

755 
İtiÚs_po¡´oûss
(
İtiÚs
 *options);

757 
´e_puÎ_§ve
(
İtiÚs
 *
o
);

759 
´e_puÎ_»¡Üe
(
İtiÚs
 *
o
, 
gc_¬’a
 *
gc
);

761 
boŞ
 
­¶y_push_İtiÚs
(
İtiÚs
 *options,

762 
bufãr
 *
buf
,

763 
³rmissiÚ_mask
,

764 *
İtiÚ_ty³s_found
,

765 
’v_£t
 *
es
);

767 
İtiÚs_d‘ach
(
İtiÚs
 *
o
);

769 
İtiÚs_£rv”_impÜt
(
İtiÚs
 *
o
,

770 cÚ¡ *
f’ame
,

771 
msgËv–
,

772 
³rmissiÚ_mask
,

773 *
İtiÚ_ty³s_found
,

774 
’v_£t
 *
es
);

776 
´e_puÎ_deçuÉ
(
İtiÚs
 *
o
);

778 
rŞ_check_®loc
(
İtiÚs
 *options);

780 
·r£_lše
(cÚ¡ *
lše
,

781 *
p
[],

782 cÚ¡ 
n
,

783 cÚ¡ *
fe
,

784 cÚ¡ 
lše_num
,

785 
msgËv–
,

786 
gc_¬’a
 *
gc
);

792 
·r£_tİŞogy
(cÚ¡ *
¡r
, cÚ¡ 
msgËv–
);

794 cÚ¡ *
´št_tİŞogy
(cÚ¡ 
tİŞogy
);

800 #ià
P2MP


802 
	#AR_NONE
 0

	)

803 
	#AR_INTERACT
 1

	)

804 
	#AR_NOINTERACT
 2

	)

806 
auth_»Œy_g‘
();

808 
boŞ
 
auth_»Œy_£t
(cÚ¡ 
msgËv–
, cÚ¡ *
İtiÚ
);

810 cÚ¡ *
auth_»Œy_´št
();

814 
İtiÚs_¡ršg_impÜt
(
İtiÚs
 *options,

815 cÚ¡ *
cÚfig
,

816 cÚ¡ 
msgËv–
,

817 cÚ¡ 
³rmissiÚ_mask
,

818 *
İtiÚ_ty³s_found
,

819 
’v_£t
 *
es
);

	@otime.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"Ùime.h
"

34 
	~"memdbg.h
"

36 
time_t
 
	gnow
 = 0;

38 #ià
TIME_BACKTRACK_PROTECTION


40 
time_t
 
	gnow_adj
 = 0;

41 
time_t
 
	gnow_u£c
 = 0;

49 
	$upd©e_now
(cÚ¡ 
time_t
 
sy¡em_time
)

51 cÚ¡ 
fÜw¬d_th»shŞd
 = 86400;

52 cÚ¡ 
backw¬d_Œigg”
 = 10;

53 
time_t
 
»®_time
 = 
sy¡em_time
 + 
now_adj
;

55 ià(
»®_time
 > 
now
)

57 cÚ¡ 
time_t
 
ov”shoÙ
 = 
»®_time
 - 
now
 - 1;

58 ià(
ov”shoÙ
 > 
fÜw¬d_th»shŞd
 && 
now_adj
 >= overshoot)

60 
now_adj
 -ğ
ov”shoÙ
;

61 
»®_time
 -ğ
ov”shoÙ
;

63 
now
 = 
»®_time
;

65 ià(
»®_time
 < 
now
 - 
backw¬d_Œigg”
)

67 
now_adj
 +ğ(
now
 - 
»®_time
);

69 
	}
}

72 
	$upd©e_now_u£c
(
timev®
 *
tv
)

74 cÚ¡ 
time_t
 
Ï¡
 = 
now
;

75 
	`upd©e_now
(
tv
->
tv_£c
);

76 ià(
now
 > 
Ï¡
 || (now =ğÏ¡ && 
tv
->
tv_u£c
 > 
now_u£c
))

78 
now_u£c
 = 
tv
->
tv_u£c
;

80 
	}
}

88 
	$tv_¡ršg
(cÚ¡ 
timev®
 *
tv
, 
gc_¬’a
 *
gc
)

90 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

91 
	`buf_´štf
(&
out
, "[%d/%d]",

92 (è
tv
->
tv_£c
,

93 ()
tv
->
tv_u£c
);

94  
	`BSTR
(&
out
);

95 
	}
}

103 
	$tv_¡ršg_abs
(cÚ¡ 
timev®
 *
tv
, 
gc_¬’a
 *
gc
)

105  
	`time_¡ršg
((
time_t
è
tv
->
tv_£c
,

106 (è
tv
->
tv_u£c
,

107 
Œue
,

108 
gc
);

109 
	}
}

114 
	$time_¡ršg
(
time_t
 
t
, 
u£c
, 
boŞ
 
show_u£c
, 
gc_¬’a
 *
gc
)

116 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

117 
timev®
 
tv
;

119 ià(
t
)

121 
tv
.
tv_£c
 = 
t
;

122 
tv
.
tv_u£c
 = 
u£c
;

126 
	`g‘timeofday
(&
tv
, 
NULL
);

129 
t
 = 
tv
.
tv_£c
;

130 
	`buf_´štf
(&
out
, "%s", 
	`ùime
(&
t
));

131 
	`buf_rm
(&
out
, '\n');

133 ià(
show_u£c
 && 
tv
.
tv_u£c
)

135 
	`buf_´štf
(&
out
, " us=%d", ()
tv
.
tv_u£c
);

138  
	`BSTR
(&
out
);

139 
	}
}

148 
äequ’cy_lim™
 *

149 
	$äequ’cy_lim™_š™
(
max
, 
³r
)

151 
äequ’cy_lim™
 *
f
;

153 
	`ASSERT
(
max
 >ğ0 && 
³r
 >= 0);

155 
	`ALLOC_OBJ
(
f
, 
äequ’cy_lim™
);

156 
f
->
max
 = max;

157 
f
->
³r
 =…er;

158 
f
->
n
 = 0;

159 
f
->
»£t
 = 0;

160  
f
;

161 
	}
}

164 
	$äequ’cy_lim™_ä“
(
äequ’cy_lim™
 *
f
)

166 
	`ä“
(
f
);

167 
	}
}

169 
boŞ


170 
	$äequ’cy_lim™_ev’t_®lowed
(
äequ’cy_lim™
 *
f
)

172 ià(
f
->
³r
)

174 
boŞ
 
»t
;

175 ià(
now
 >ğ
f
->
»£t
 + f->
³r
)

177 
f
->
»£t
 = 
now
;

178 
f
->
n
 = 0;

180 
»t
 = (++
f
->
n
 <ğf->
max
);

181  
»t
;

185  
Œue
;

187 
	}
}

189 #ifdeà
TIME_TEST


191 
	$time_‹¡
()

193 
timev®
 
tv
;

194 
time_t
 
t
;

195 
i
;

196 
i
 = 0; i < 10000; ++i)

198 
t
 = 
	`time
(
NULL
);

199 
	`g‘timeofday
(&
tv
, 
NULL
);

201 
	`msg
(
M_INFO
, "t=%u s=%u us=%u",

202 ()
t
,

203 ()
tv
.
tv_£c
,

204 ()
tv
.
tv_u£c
);

207 
	}
}

	@otime.h

24 #iâdeà
OTIME_H


25 
	#OTIME_H


	)

27 
	~"commÚ.h
"

28 
	~"š‹g”.h
"

29 
	~"bufãr.h
"

31 
	säequ’cy_lim™


33 
	mmax
;

34 
	m³r
;

35 
	mn
;

36 
time_t
 
	m»£t
;

39 
äequ’cy_lim™
 *
äequ’cy_lim™_š™
(
max
, 
³r
);

41 
äequ’cy_lim™_ä“
(
äequ’cy_lim™
 *
f
);

43 
boŞ
 
äequ’cy_lim™_ev’t_®lowed
(
äequ’cy_lim™
 *
f
);

46 cÚ¡ *
time_¡ršg
(
time_t
 
t
, 
u£c
, 
boŞ
 
show_u£c
, 
gc_¬’a
 *
gc
);

50 cÚ¡ *
tv_¡ršg
(cÚ¡ 
timev®
 *
tv
, 
gc_¬’a
 *
gc
);

52 cÚ¡ *
tv_¡ršg_abs
(cÚ¡ 
timev®
 *
tv
, 
gc_¬’a
 *
gc
);

54 
time_t
 
now
;

56 
time_‹¡
();

58 #ià
TIME_BACKTRACK_PROTECTION


60 
upd©e_now
(cÚ¡ 
time_t
 
sy¡em_time
);

62 
time_t
 
now_u£c
;

63 
upd©e_now_u£c
(
timev®
 *
tv
);

65 
šlše
 

66 
	$İ’v²_g‘timeofday
(
timev®
 *
tv
, *
tz
)

68 cÚ¡ 
¡©us
 = 
	`g‘timeofday
(
tv
, 
tz
);

69 ià(!
¡©us
)

71 
	`upd©e_now_u£c
(
tv
);

72 
tv
->
tv_£c
 = 
now
;

73 
tv
->
tv_u£c
 = 
now_u£c
;

75  
¡©us
;

76 
	}
}

78 
šlše
 

79 
	$upd©e_time
()

81 #ifdeà
_WIN32


83 
timev®
 
tv
;

84 
	`İ’v²_g‘timeofday
(&
tv
, 
NULL
);

86 
	`upd©e_now
(
	`time
(
NULL
));

88 
	}
}

92 
šlše
 

93 
	$upd©e_time
()

95 #ià
	`defšed
(
_WIN32
)

97 
timev®
 
tv
;

98 ià(!
	`g‘timeofday
(&
tv
, 
NULL
))

100 ià(
tv
.
tv_£c
 !ğ
now
)

102 
now
 = 
tv
.
tv_£c
;

106 cÚ¡ 
time_t
 
»®_time
 = 
	`time
(
NULL
);

107 ià(
»®_time
 !ğ
now
)

109 
now
 = 
»®_time
;

112 
	}
}

114 
šlše
 

115 
	$İ’v²_g‘timeofday
(
timev®
 *
tv
, *
tz
)

117  
	`g‘timeofday
(
tv
, 
tz
);

118 
	}
}

122 
šlše
 
time_t


123 
	$İ’v²_time
(
time_t
 *
t
)

125 
	`upd©e_time
();

126 ià(
t
)

128 *
t
 = 
now
;

130  
now
;

131 
	}
}

133 
šlše
 

134 
	$tv_ş—r
(
timev®
 *
tv
)

136 
tv
->
tv_£c
 = 0;

137 
tv
->
tv_u£c
 = 0;

138 
	}
}

140 
šlše
 
boŞ


141 
	$tv_defšed
(cÚ¡ 
timev®
 *
tv
)

143  
tv
->
tv_£c
 > 0 &&v->
tv_u£c
 > 0;

144 
	}
}

147 
šlše
 

148 
	$tv_subŒaù
(cÚ¡ 
timev®
 *
tv1
, cÚ¡ timev® *
tv2
, cÚ¡ 
max_£cÚds
)

150 cÚ¡ 
max_u£c
 = 
max_£cÚds
 * 1000000;

151 cÚ¡ 
£c_diff
 = 
tv1
->
tv_£c
 - 
tv2
->tv_sec;

153 ià(
£c_diff
 > (()
max_£cÚds
 + 10))

155  
max_u£c
;

157 ià(
£c_diff
 < -(()
max_£cÚds
 + 10))

159  -
max_u£c
;

161  
	`cÚ¡¿š_št
(
£c_diff
 * 1000000 + (
tv1
->
tv_u£c
 - 
tv2
->tv_u£c), -
max_u£c
, max_usec);

162 
	}
}

164 
šlše
 

165 
	$tv_add
(
timev®
 *
de¡
, cÚ¡ timev® *
¤c
)

167 
de¡
->
tv_£c
 +ğ
¤c
->tv_sec;

168 
de¡
->
tv_u£c
 +ğ
¤c
->tv_usec;

169 
de¡
->
tv_£c
 +ğ(de¡->
tv_u£c
 >> 20);

170 
de¡
->
tv_u£c
 &= 0x000FFFFF;

171 ià(
de¡
->
tv_u£c
 >= 1000000)

173 
de¡
->
tv_u£c
 -= 1000000;

174 
de¡
->
tv_£c
 += 1;

176 
	}
}

178 
šlše
 
boŞ


179 
	$tv_É
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
)

181 ià(
t1
->
tv_£c
 < 
t2
->tv_sec)

183  
Œue
;

185 ià(
t1
->
tv_£c
 > 
t2
->tv_sec)

187  
çl£
;

191  
t1
->
tv_u£c
 < 
t2
->tv_usec;

193 
	}
}

195 
šlše
 
boŞ


196 
	$tv_Ë
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
)

198 ià(
t1
->
tv_£c
 < 
t2
->tv_sec)

200  
Œue
;

202 ià(
t1
->
tv_£c
 > 
t2
->tv_sec)

204  
çl£
;

208  
t1
->
tv_u£c
 <ğ
t2
->tv_usec;

210 
	}
}

212 
šlše
 
boŞ


213 
	$tv_ge
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
)

215 ià(
t1
->
tv_£c
 > 
t2
->tv_sec)

217  
Œue
;

219 ià(
t1
->
tv_£c
 < 
t2
->tv_sec)

221  
çl£
;

225  
t1
->
tv_u£c
 >ğ
t2
->tv_usec;

227 
	}
}

229 
šlše
 
boŞ


230 
	$tv_gt
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
)

232 ià(
t1
->
tv_£c
 > 
t2
->tv_sec)

234  
Œue
;

236 ià(
t1
->
tv_£c
 < 
t2
->tv_sec)

238  
çl£
;

242  
t1
->
tv_u£c
 > 
t2
->tv_usec;

244 
	}
}

246 
šlše
 
boŞ


247 
	$tv_eq
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
)

249  
t1
->
tv_£c
 =ğ
t2
->tv_£ø&&1->
tv_u£c
 ==2->tv_usec;

250 
	}
}

252 
šlše
 

253 
	$tv_d–
(
timev®
 *
de¡
, cÚ¡ timev® *
t1
, cÚ¡ timev® *
t2
)

255 
£c
 = 
t2
->
tv_£c
 - 
t1
->tv_sec;

256 
u£c
 = 
t2
->
tv_u£c
 - 
t1
->tv_usec;

258 
u£c
 < 0)

260 
u£c
 += 1000000;

261 
£c
 -= 1;

264 ià(
£c
 < 0)

266 
u£c
 = 
£c
 = 0;

269 
de¡
->
tv_£c
 = 
£c
;

270 
de¡
->
tv_u£c
 = 
u£c
;

271 
	}
}

273 
	#TV_WITHIN_SIGMA_MAX_SEC
 600

	)

274 
	#TV_WITHIN_SIGMA_MAX_USEC
 (
TV_WITHIN_SIGMA_MAX_SEC
 * 1000000)

	)

279 
šlše
 
boŞ


280 
	$tv_w™hš_sigma
(cÚ¡ 
timev®
 *
t1
, cÚ¡ timev® *
t2
, 
sigma
)

282 cÚ¡ 
d–
 = 
	`tv_subŒaù
(
t1
, 
t2
, 
TV_WITHIN_SIGMA_MAX_SEC
);

283  -()
sigma
 <ğ
d–
 && delta <= ()sigma;

284 
	}
}

290 
šlše
 

291 
	$š‹rv®_—¾›¡_wakeup
(
š‹rv®_t
 *
wakeup
, 
time_t
 
©
,ime_ˆ
cu¼’t
)

293 ià(
©
 > 
cu¼’t
)

295 cÚ¡ 
š‹rv®_t
 
d–
 = (š‹rv®_tè(
©
 - 
cu¼’t
);

296 ià(
d–
 < *
wakeup
)

298 *
wakeup
 = 
d–
;

300 ià(*
wakeup
 < 0)

302 *
wakeup
 = 0;

305 
	}
}

	@packet_id.c

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

35 #–ià
defšed
(
_MSC_VER
)

36 
	~"cÚfig-msvc.h
"

39 
	~"sysh—d.h
"

41 #ifdeà
ENABLE_CRYPTO


43 
	~"·ck‘_id.h
"

44 
	~"misc.h
"

45 
	~"š‹g”.h
"

47 
	~"memdbg.h
"

55 
	#SEQ_UNSEEN
 ((
time_t
)0)

	)

56 
	#SEQ_EXPIRED
 ((
time_t
)1)

	)

58 
·ck‘_id_debug_´št
(
msgËv–
,

59 cÚ¡ 
·ck‘_id_»c
 *
p
,

60 cÚ¡ 
·ck‘_id_Ãt
 *
pš
,

61 cÚ¡ *
mes§ge
,

62 
v®ue
);

64 
šlše
 

65 
	$·ck‘_id_debug
(
msgËv–
,

66 cÚ¡ 
·ck‘_id_»c
 *
p
,

67 cÚ¡ 
·ck‘_id_Ãt
 *
pš
,

68 cÚ¡ *
mes§ge
,

69 
v®ue
)

71 #ifdeà
ENABLE_DEBUG


72 ià(
	`uÆik–y
(
	`check_debug_Ëv–
(
msgËv–
)))

74 
	`·ck‘_id_debug_´št
(
msgËv–
, 
p
, 
pš
, 
mes§ge
, 
v®ue
);

77 
	}
}

80 
	$·ck‘_id_š™
(
·ck‘_id
 *
p
, 
£q_backŒack
, 
time_backŒack
, cÚ¡ *
Çme
, 
un™
)

82 
	`dmsg
(
D_PID_DEBUG
, "PID…acket_id_init seq_backtrack=%dime_backtrack=%d",

83 
£q_backŒack
,

84 
time_backŒack
);

86 
	`ASSERT
(
p
);

87 
	`CLEAR
(*
p
);

89 
p
->
»c
.
Çme
 =‚ame;

90 
p
->
»c
.
un™
 = unit;

91 ià(
£q_backŒack
)

93 
	`ASSERT
(
MIN_SEQ_BACKTRACK
 <ğ
£q_backŒack
 && seq_backŒack <ğ
MAX_SEQ_BACKTRACK
);

94 
	`ASSERT
(
MIN_TIME_BACKTRACK
 <ğ
time_backŒack
 &&ime_backŒack <ğ
MAX_TIME_BACKTRACK
);

95 
	`CIRC_LIST_ALLOC
(
p
->
»c
.
£q_li¡
, £q_li¡, 
£q_backŒack
);

96 
p
->
»c
.
£q_backŒack
 = seq_backtrack;

97 
p
->
»c
.
time_backŒack
 =ime_backtrack;

99 
p
->
»c
.
š™Ÿlized
 = 
Œue
;

100 
	}
}

103 
	$·ck‘_id_ä“
(
·ck‘_id
 *
p
)

105 ià(
p
)

107 
	`dmsg
(
D_PID_DEBUG
, "PID…acket_id_free");

108 ià(
p
->
»c
.
£q_li¡
)

110 
	`ä“
(
p
->
»c
.
£q_li¡
);

112 
	`CLEAR
(*
p
);

114 
	}
}

117 
	$·ck‘_id_add
(
·ck‘_id_»c
 *
p
, cÚ¡ 
·ck‘_id_Ãt
 *
pš
)

119 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

120 ià(
p
->
£q_li¡
)

122 
·ck‘_id_ty³
 
diff
;

128 ià(!
	`CIRC_LIST_SIZE
(
p
->
£q_li¡
)

129 || 
pš
->
time
 > 
p
->time

130 || (
pš
->
id
 >ğ(
·ck‘_id_ty³
)
p
->
£q_backŒack


131 && 
pš
->
id
 - (
·ck‘_id_ty³
)
p
->
£q_backŒack
 >…->id))

133 
p
->
time
 = 
pš
->time;

134 
p
->
id
 = 0;

135 ià(
pš
->
id
 > (
·ck‘_id_ty³
)
p
->
£q_backŒack
)

137 
p
->
id
 = 
pš
->id - (
·ck‘_id_ty³
í->
£q_backŒack
;

139 
	`CIRC_LIST_RESET
(
p
->
£q_li¡
);

142 
p
->
id
 < 
pš
->id

143 #ifdeà
PID_SIMULATE_BACKTRACK


144 || (
	`g‘_¿ndom
() % 64) < 31

148 
	`CIRC_LIST_PUSH
(
p
->
£q_li¡
, 
SEQ_UNSEEN
);

149 ++
p
->
id
;

152 
diff
 = 
p
->
id
 - 
pš
->id;

153 ià(
diff
 < (
·ck‘_id_ty³
è
	`CIRC_LIST_SIZE
(
p
->
£q_li¡
)

154 && 
loÿl_now
 > 
SEQ_EXPIRED
)

156 
	`CIRC_LIST_ITEM
(
p
->
£q_li¡
, 
diff
èğ
loÿl_now
;

161 
p
->
time
 = 
pš
->time;

162 
p
->
id
 = 
pš
->id;

164 
	}
}

172 
	$·ck‘_id_»­
(
·ck‘_id_»c
 *
p
)

174 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

175 ià(
p
->
time_backŒack
)

177 
i
;

178 
boŞ
 
expœe
 = 
çl£
;

179 
i
 = 0; i < 
	`CIRC_LIST_SIZE
(
p
->
£q_li¡
); ++i)

181 cÚ¡ 
time_t
 
t
 = 
	`CIRC_LIST_ITEM
(
p
->
£q_li¡
, 
i
);

182 ià(
t
 =ğ
SEQ_EXPIRED
)

186 ià(!
expœe
 && 
t
 && + 
p
->
time_backŒack
 < 
loÿl_now
)

188 
expœe
 = 
Œue
;

190 ià(
expœe
)

192 
	`CIRC_LIST_ITEM
(
p
->
£q_li¡
, 
i
èğ
SEQ_EXPIRED
;

196 
p
->
Ï¡_»­
 = 
loÿl_now
;

197 
	}
}

203 
boŞ


204 
	$·ck‘_id_‹¡
(
·ck‘_id_»c
 *
p
,

205 cÚ¡ 
·ck‘_id_Ãt
 *
pš
)

207 
·ck‘_id_ty³
 
diff
;

209 
	`·ck‘_id_debug
(
D_PID_DEBUG
, 
p
, 
pš
, "PID_TEST", 0);

211 
	`ASSERT
(
p
->
š™Ÿlized
);

213 ià(!
pš
->
id
)

215  
çl£
;

218 ià(
p
->
£q_backŒack
)

226 ià(
pš
->
time
 =ğ
p
->time)

229 ià(
pš
->
id
 > 
p
->id)

231  
Œue
;

235 
diff
 = 
p
->
id
 - 
pš
->id;

238 ià(()
diff
 > 
p
->
max_backŒack_¡©
)

240 
p
->
max_backŒack_¡©
 = ()
diff
;

241 
	`·ck‘_id_debug
(
D_PID_DEBUG_LOW
, 
p
, 
pš
, "PID_ERR„•Ïy-wšdow backŒack occu¼ed",…->
max_backŒack_¡©
);

244 ià(
diff
 >ğ(
·ck‘_id_ty³
è
	`CIRC_LIST_SIZE
(
p
->
£q_li¡
))

246 
	`·ck‘_id_debug
(
D_PID_DEBUG_LOW
, 
p
, 
pš
, "PID_ERR†¬gdiff", 
diff
);

247  
çl£
;

251 cÚ¡ 
time_t
 
v
 = 
	`CIRC_LIST_ITEM
(
p
->
£q_li¡
, 
diff
);

252 ià(
v
 == 0)

254  
Œue
;

259 
	`·ck‘_id_debug
(
D_PID_DEBUG_MEDIUM
, 
p
, 
pš
, "PID_ERR„•Ïy", 
diff
);

260  
çl£
;

264 ià(
pš
->
time
 < 
p
->time)

266 
	`·ck‘_id_debug
(
D_PID_DEBUG_LOW
, 
p
, 
pš
, "PID_ERRime backtrack", 0);

267  
çl£
;

271  
Œue
;

282 ià(
pš
->
time
 =ğ
p
->time)

284  !
p
->
id
 || 
pš
->id ==…->id + 1;

286 ià(
pš
->
time
 < 
p
->time)

288  
çl£
;

292  
pš
->
id
 == 1;

295 
	}
}

302 
boŞ


303 
	$·ck‘_id_»ad
(
·ck‘_id_Ãt
 *
pš
, 
bufãr
 *
buf
, 
boŞ
 
lÚg_fÜm
)

305 
·ck‘_id_ty³
 
Ãt_id
;

306 
Ãt_time_t
 
Ãt_time
;

308 
pš
->
id
 = 0;

309 
pš
->
time
 = 0;

311 ià(!
	`buf_»ad
(
buf
, &
Ãt_id
, (net_id)))

313  
çl£
;

315 
pš
->
id
 = 
	`Áohpid
(
Ãt_id
);

316 ià(
lÚg_fÜm
)

318 ià(!
	`buf_»ad
(
buf
, &
Ãt_time
, (net_time)))

320  
çl£
;

322 
pš
->
time
 = 
	`Áohtime
(
Ãt_time
);

324  
Œue
;

325 
	}
}

327 
boŞ


328 
	$·ck‘_id_£nd_upd©e
(
·ck‘_id_£nd
 *
p
, 
boŞ
 
lÚg_fÜm
)

330 ià(!
p
->
time
)

332 
p
->
time
 = 
now
;

334 ià(
p
->
id
 =ğ
PACKET_ID_MAX
)

339 ià(!
lÚg_fÜm
 || 
now
 <ğ
p
->
time
)

341  
çl£
;

343 
p
->
time
 = 
now
;

344 
p
->
id
 = 0;

346 
p
->
id
++;

347  
Œue
;

348 
	}
}

350 
boŞ


351 
	$·ck‘_id_wr™e
(
·ck‘_id_£nd
 *
p
, 
bufãr
 *
buf
, 
boŞ
 
lÚg_fÜm
,

352 
boŞ
 
´•’d
)

354 ià(!
	`·ck‘_id_£nd_upd©e
(
p
, 
lÚg_fÜm
))

356  
çl£
;

359 cÚ¡ 
·ck‘_id_ty³
 
Ãt_id
 = 
	`htÚpid
(
p
->
id
);

360 cÚ¡ 
Ãt_time_t
 
Ãt_time
 = 
	`htÚtime
(
p
->
time
);

361 ià(
´•’d
)

363 ià(
lÚg_fÜm
)

365 ià(!
	`buf_wr™e_´•’d
(
buf
, &
Ãt_time
, (net_time)))

367  
çl£
;

370 ià(!
	`buf_wr™e_´•’d
(
buf
, &
Ãt_id
, (net_id)))

372  
çl£
;

377 ià(!
	`buf_wr™e
(
buf
, &
Ãt_id
, (net_id)))

379  
çl£
;

381 ià(
lÚg_fÜm
)

383 ià(!
	`buf_wr™e
(
buf
, &
Ãt_time
, (net_time)))

385  
çl£
;

389  
Œue
;

390 
	}
}

393 
	$·ck‘_id_Ãt_´št
(cÚ¡ 
·ck‘_id_Ãt
 *
pš
, 
boŞ
 
´št_time¡amp
, 
gc_¬’a
 *
gc
)

395 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

397 
	`buf_´štf
(&
out
, "[ #" 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
pš
->
id
);

398 ià(
´št_time¡amp
 && 
pš
->
time
)

400 
	`buf_´štf
(&
out
, " /imğ(" 
·ck‘_id_fÜm©
 ") %s",

401 (
·ck‘_id_´št_ty³
)
pš
->
time
,

402 
	`time_¡ršg
(
pš
->
time
, 0, 
çl£
, 
gc
));

405 
	`buf_´štf
(&
out
, " ]");

406  
	`BSTR
(&
out
);

407 
	}
}

411 
	$·ck‘_id_³rsi¡_š™
(
·ck‘_id_³rsi¡
 *
p
)

413 
p
->
f’ame
 = 
NULL
;

414 
p
->
fd
 = -1;

415 
p
->
time
 =…->
time_Ï¡_wr™‹n
 = 0;

416 
p
->
id
 =…->
id_Ï¡_wr™‹n
 = 0;

417 
	}
}

421 
	$·ck‘_id_³rsi¡_şo£
(
·ck‘_id_³rsi¡
 *
p
)

423 ià(
	`·ck‘_id_³rsi¡_’abËd
(
p
))

425 ià(
	`şo£
(
p
->
fd
))

427 
	`msg
(
D_PID_PERSIST
 | 
M_ERRNO
, "Clo£ƒ¼Ü oÀ--»¶ay-³rsi¡ f%s", 
p
->
f’ame
);

429 
	`·ck‘_id_³rsi¡_š™
(
p
);

431 
	}
}

435 
	$·ck‘_id_³rsi¡_lßd
(
·ck‘_id_³rsi¡
 *
p
, cÚ¡ *
f’ame
)

437 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

438 ià(!
	`·ck‘_id_³rsi¡_’abËd
(
p
))

441 
p
->
fd
 = 
	`¶©fÜm_İ’
(
f’ame
,

442 
O_CREAT
 | 
O_RDWR
 | 
O_BINARY
,

443 
S_IRUSR
 | 
S_IWUSR
);

444 ià(
p
->
fd
 == -1)

446 
	`msg
(
D_PID_PERSIST
 | 
M_ERRNO
,

448 
f’ame
);

452 
·ck‘_id_³rsi¡_fe_image
 
image
;

453 
ssize_t
 
n
;

455 #ià
	`defšed
(
HAVE_FLOCK
è&& defšed(
LOCK_EX
è&& defšed(
LOCK_NB
)

456 ià(
	`æock
(
p
->
fd
, 
LOCK_EX
 | 
LOCK_NB
))

458 
	`msg
(
M_ERR
, "CªnÙ obšƒxşusivlock oÀ--»¶ay-³rsi¡ f%s", 
f’ame
);

462 
p
->
f’ame
 = filename;

463 
n
 = 
	`»ad
(
p
->
fd
, &
image
, (image));

464 ià(
n
 =ğ(
image
))

466 
p
->
time
 =…->
time_Ï¡_wr™‹n
 = 
image
.time;

467 
p
->
id
 =…->
id_Ï¡_wr™‹n
 = 
image
.id;

468 
	`dmsg
(
D_PID_PERSIST_DEBUG
, "PID Persist Read from %s: %s",

469 
p
->
f’ame
, 
	`·ck‘_id_³rsi¡_´št
Õ, &
gc
));

471 ià(
n
 == -1)

473 
	`msg
(
D_PID_PERSIST
 | 
M_ERRNO
,

475 
p
->
f’ame
);

479 
	`gc_ä“
(&
gc
);

480 
	}
}

484 
	$·ck‘_id_³rsi¡_§ve
(
·ck‘_id_³rsi¡
 *
p
)

486 ià(
	`·ck‘_id_³rsi¡_’abËd
(
p
è&&…->
time
 && (p->tim!ğp->
time_Ï¡_wr™‹n


487 || 
p
->
id
 !ğp->
id_Ï¡_wr™‹n
))

489 
·ck‘_id_³rsi¡_fe_image
 
image
;

490 
ssize_t
 
n
;

491 
off_t
 
£ek_»t
;

492 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

494 
image
.
time
 = 
p
->time;

495 
image
.
id
 = 
p
->id;

496 
£ek_»t
 = 
	`l£ek
(
p
->
fd
, (
off_t
)0, 
SEEK_SET
);

497 ià(
£ek_»t
 =ğ(
off_t
)0)

499 
n
 = 
	`wr™e
(
p
->
fd
, &
image
, (image));

500 ià(
n
 =ğ(
image
))

502 
p
->
time_Ï¡_wr™‹n
 =…->
time
;

503 
p
->
id_Ï¡_wr™‹n
 =…->
id
;

504 
	`dmsg
(
D_PID_PERSIST_DEBUG
, "PID Persist Writeo %s: %s",

505 
p
->
f’ame
, 
	`·ck‘_id_³rsi¡_´št
Õ, &
gc
));

509 
	`msg
(
D_PID_PERSIST
 | 
M_ERRNO
,

511 
p
->
f’ame
);

516 
	`msg
(
D_PID_PERSIST
 | 
M_ERRNO
,

518 
p
->
f’ame
);

520 
	`gc_ä“
(&
gc
);

522 
	}
}

526 
	$·ck‘_id_³rsi¡_lßd_obj
(cÚ¡ 
·ck‘_id_³rsi¡
 *
p
, 
·ck‘_id
 *
pid
)

528 ià(
p
 && 
pid
 && 
	`·ck‘_id_³rsi¡_’abËd
Õè&&…->
time
)

530 
pid
->
»c
.
time
 = 
p
->time;

531 
pid
->
»c
.
id
 = 
p
->id;

533 
	}
}

536 
	$·ck‘_id_³rsi¡_´št
(cÚ¡ 
·ck‘_id_³rsi¡
 *
p
, 
gc_¬’a
 *
gc
)

538 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

540 
	`buf_´štf
(&
out
, "[");

542 ià(
	`·ck‘_id_³rsi¡_’abËd
(
p
))

544 
	`buf_´štf
(&
out
, " #" 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
p
->
id
);

545 ià(
p
->
time
)

547 
	`buf_´štf
(&
out
, " /imğ(" 
·ck‘_id_fÜm©
 ") %s",

548 (
·ck‘_id_´št_ty³
)
p
->
time
,

549 
	`time_¡ršg
(
p
->
time
, 0, 
çl£
, 
gc
));

553 
	`buf_´štf
(&
out
, " ]");

554  (*)
out
.
d©a
;

555 
	}
}

557 #ifdeà
ENABLE_DEBUG


560 
	$·ck‘_id_debug_´št
(
msgËv–
,

561 cÚ¡ 
·ck‘_id_»c
 *
p
,

562 cÚ¡ 
·ck‘_id_Ãt
 *
pš
,

563 cÚ¡ *
mes§ge
,

564 
v®ue
)

566 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

567 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

568 
timev®
 
tv
;

569 cÚ¡ 
time_t
 
´ev_now
 = 
now
;

570 cÚ¡ 
£q_li¡
 *
¦
 = 
p
->seq_list;

571 
i
;

573 
	`CLEAR
(
tv
);

574 
	`g‘timeofday
(&
tv
, 
NULL
);

576 
	`buf_´štf
(&
out
, "% [%d]", 
mes§ge
, 
v®ue
);

577 
	`buf_´štf
(&
out
, " [%s-%d] [", 
p
->
Çme
,…->
un™
);

578 
i
 = 0; 
¦
 !ğ
NULL
 && i < sl->
x_size
; ++i)

580 
c
;

581 
time_t
 
v
;

582 
diff
;

584 
v
 = 
	`CIRC_LIST_ITEM
(
¦
, 
i
);

585 ià(
v
 =ğ
SEQ_UNSEEN
)

587 
c
 = '_';

589 ià(
v
 =ğ
SEQ_EXPIRED
)

591 
c
 = 'E';

595 
diff
 = (è
´ev_now
 - 
v
;

596 ià(
diff
 < 0)

598 
c
 = 'N';

600 ià(
diff
 < 10)

602 
c
 = '0' + 
diff
;

606 
c
 = '>';

609 
	`buf_´štf
(&
out
, "%c", 
c
);

611 
	`buf_´štf
(&
out
, "] " 
time_fÜm©
 ":" 
·ck‘_id_fÜm©
, (
time_ty³
)
p
->
time
, (
·ck‘_id_´št_ty³
í->
id
);

612 ià(
pš
)

614 
	`buf_´štf
(&
out
, " " 
time_fÜm©
 ":" 
·ck‘_id_fÜm©
, (
time_ty³
)
pš
->
time
, (
·ck‘_id_´št_ty³
íš->
id
);

617 
	`buf_´štf
(&
out
, "=" 
time_fÜm©
 "[%d]",

618 (
time_ty³
)
´ev_now
,

619 ()(
´ev_now
 - 
tv
.
tv_£c
));

621 
	`buf_´štf
(&
out
, "„=[%d,%d,%d,%d,%d]",

622 ()(
p
->
Ï¡_»­
 - 
tv
.
tv_£c
),

623 
p
->
£q_backŒack
,

624 
p
->
time_backŒack
,

625 
p
->
max_backŒack_¡©
,

626 ()
p
->
š™Ÿlized
);

627 ià(
¦
 !ğ
NULL
)

629 
	`buf_´štf
(&
out
, " sl=[%d,%d,%d,%d]",

630 
¦
->
x_h—d
,

631 
¦
->
x_size
,

632 
¦
->
x_ÿp
,

633 
¦
->
x_sizeof
);

637 
	`msg
(
msgËv–
, "%s", 
	`BSTR
(&
out
));

638 
	`gc_ä“
(&
gc
);

639 
	}
}

643 #ifdeà
PID_TEST


646 
	$·ck‘_id_š‹¿ùive_‹¡
()

648 
·ck‘_id
 
pid
;

649 
·ck‘_id_Ãt
 
pš
;

650 
boŞ
 
lÚg_fÜm
;

651 
boŞ
 
couÁ
 = 0;

652 
boŞ
 
‹¡
;

654 cÚ¡ 
£q_backŒack
 = 10;

655 cÚ¡ 
time_backŒack
 = 10;

657 
	`·ck‘_id_š™
(&
pid
, 
£q_backŒack
, 
time_backŒack
);

659 
Œue
)

661 
buf
[80];

662 ià(!
	`fg‘s
(
buf
, (buf), 
¡dš
))

666 
	`upd©e_time
();

667 ià(
	`ssÿnf
(
buf
, "%lu,%u", &
pš
.
time
, &pš.
id
) == 2)

669 
	`·ck‘_id_»­_‹¡
(&
pid
.
»c
);

670 
‹¡
 = 
	`·ck‘_id_‹¡
(&
pid
.
»c
, &
pš
);

671 
	`´štf
("·ck‘_id_‹¡ (" 
time_fÜm©
 ", " 
·ck‘_id_fÜm©
 ")„eturned %d\n",

672 (
time_ty³
)
pš
.
time
,

673 (
·ck‘_id_´št_ty³
)
pš
.
id
,

674 
‹¡
);

675 ià(
‹¡
)

677 
	`·ck‘_id_add
(&
pid
.
»c
, &
pš
);

682 
lÚg_fÜm
 = (
couÁ
 < 20);

683 
	`·ck‘_id_®loc_outgošg
(&
pid
.
£nd
, &
pš
, 
lÚg_fÜm
);

684 
	`´štf
("(" 
time_fÜm©
 "(" 
·ck‘_id_fÜm©
 "), %d)\n",

685 (
time_ty³
)
pš
.
time
,

686 (
·ck‘_id_´št_ty³
)
pš
.
id
,

687 
lÚg_fÜm
);

688 ià(
pid
.
£nd
.
id
 == 10)

690 
pid
.
£nd
.
id
 = 0xFFFFFFF8;

692 ++
couÁ
;

695 
	`·ck‘_id_ä“
(&
pid
);

696 
	}
}

	@packet_id.h

30 #ifdeà
ENABLE_CRYPTO


32 #iâdeà
PACKET_ID_H


33 
	#PACKET_ID_H


	)

35 
	~"cœc_li¡.h
"

36 
	~"bufãr.h
"

37 
	~"”rÜ.h
"

38 
	~"Ùime.h
"

51 
ušt32_t
 
	t·ck‘_id_ty³
;

52 
	#PACKET_ID_MAX
 
UINT32_MAX


	)

53 
ušt32_t
 
	tÃt_time_t
;

60 
	#PACKET_ID_WRAP_TRIGGER
 0xFF000000

	)

63 
	#htÚpid
(
x
è
	`htÚl
(x)

	)

66 
	#Áohpid
(
x
è
	`Áohl
(x)

	)

69 
	#htÚtime
(
x
è
	`htÚl
((
Ãt_time_t
)x)

	)

72 
	#Áohtime
(
x
è((
time_t
)
	`Áohl
(x))

	)

82 
ušt8_t
 
	t·ck‘_id_ty³
;

83 
ušt16_t
 
	tÃt_time_t
;

85 
	#PACKET_ID_WRAP_TRIGGER
 0x80

	)

87 
	#htÚpid
(
x
è(x)

	)

88 
	#Áohpid
(
x
è(x)

	)

89 
	#htÚtime
(
x
è
	`htÚs
((
Ãt_time_t
)x)

	)

90 
	#Áohtime
(
x
è((
time_t
)
	`Áohs
(x))

	)

97 
	#·ck‘_id_fÜm©
 "%u"

	)

98 
	t·ck‘_id_´št_ty³
;

105 
	#MIN_SEQ_BACKTRACK
 0

	)

106 
	#MAX_SEQ_BACKTRACK
 65536

	)

107 
	#DEFAULT_SEQ_BACKTRACK
 64

	)

114 
	#MIN_TIME_BACKTRACK
 0

	)

115 
	#MAX_TIME_BACKTRACK
 600

	)

116 
	#DEFAULT_TIME_BACKTRACK
 15

	)

125 
	#SEQ_REAP_INTERVAL
 5

	)

127 
CIRC_LIST
(
£q_li¡
, 
time_t
);

134 
	s·ck‘_id_»c


136 
time_t
 
	mÏ¡_»­
;

137 
time_t
 
	mtime
;

138 
·ck‘_id_ty³
 
	mid
;

139 
	m£q_backŒack
;

140 
	mtime_backŒack
;

141 
	mmax_backŒack_¡©
;

142 
boŞ
 
	mš™Ÿlized
;

143 
£q_li¡
 *
	m£q_li¡
;

144 cÚ¡ *
	mÇme
;

145 
	mun™
;

152 
	s·ck‘_id_³rsi¡


154 cÚ¡ *
	mf’ame
;

155 
	mfd
;

156 
time_t
 
	mtime
;

157 
·ck‘_id_ty³
 
	mid
;

158 
time_t
 
	mtime_Ï¡_wr™‹n
;

159 
·ck‘_id_ty³
 
	mid_Ï¡_wr™‹n
;

162 
	s·ck‘_id_³rsi¡_fe_image


164 
time_t
 
	mtime
;

165 
·ck‘_id_ty³
 
	mid
;

172 
	s·ck‘_id_£nd


174 
·ck‘_id_ty³
 
	mid
;

175 
time_t
 
	mtime
;

201 
	s·ck‘_id_Ãt


203 
·ck‘_id_ty³
 
	mid
;

204 
time_t
 
	mtime
;

207 
	s·ck‘_id


209 
·ck‘_id_£nd
 
	m£nd
;

210 
·ck‘_id_»c
 
	m»c
;

213 
·ck‘_id_š™
(
·ck‘_id
 *
p
, 
£q_backŒack
, 
time_backŒack
, cÚ¡ *
Çme
, 
un™
);

215 
·ck‘_id_ä“
(
·ck‘_id
 *
p
);

218 
boŞ
 
·ck‘_id_‹¡
(
·ck‘_id_»c
 *
p
,

219 cÚ¡ 
·ck‘_id_Ãt
 *
pš
);

222 
·ck‘_id_add
(
·ck‘_id_»c
 *
p
,

223 cÚ¡ 
·ck‘_id_Ãt
 *
pš
);

226 
·ck‘_id_»­
(
·ck‘_id_»c
 *
p
);

233 
·ck‘_id_³rsi¡_š™
(
·ck‘_id_³rsi¡
 *
p
);

236 
·ck‘_id_³rsi¡_şo£
(
·ck‘_id_³rsi¡
 *
p
);

239 
·ck‘_id_³rsi¡_lßd
(
·ck‘_id_³rsi¡
 *
p
, cÚ¡ *
f’ame
);

242 
·ck‘_id_³rsi¡_§ve
(
·ck‘_id_³rsi¡
 *
p
);

245 
·ck‘_id_³rsi¡_lßd_obj
(cÚ¡ 
·ck‘_id_³rsi¡
 *
p
, 
·ck‘_id
 *
pid
);

248 cÚ¡ *
·ck‘_id_³rsi¡_´št
(cÚ¡ 
·ck‘_id_³rsi¡
 *
p
, 
gc_¬’a
 *
gc
);

255 
boŞ
 
·ck‘_id_»ad
(
·ck‘_id_Ãt
 *
pš
, 
bufãr
 *
buf
, boŞ 
lÚg_fÜm
);

267 
boŞ
 
·ck‘_id_wr™e
(
·ck‘_id_£nd
 *
p
, 
bufãr
 *
buf
,

268 
boŞ
 
lÚg_fÜm
, boŞ 
´•’d
);

275 
šlše
 
boŞ


276 
	$·ck‘_id_š™Ÿlized
(cÚ¡ 
·ck‘_id
 *
pid
)

278  
pid
->
»c
.
š™Ÿlized
;

279 
	}
}

282 
šlše
 
boŞ


283 
	$·ck‘_id_³rsi¡_’abËd
(cÚ¡ 
·ck‘_id_³rsi¡
 *
p
)

285  
p
->
fd
 >= 0;

286 
	}
}

289 
šlše
 

290 
	$·ck‘_id_³rsi¡_§ve_obj
(
·ck‘_id_³rsi¡
 *
p
, cÚ¡ 
·ck‘_id
 *
pid
)

292 ià(
	`·ck‘_id_³rsi¡_’abËd
(
p
è&& 
pid
->
»c
.
time
)

294 
p
->
time
 = 
pid
->
»c
.time;

295 
p
->
id
 = 
pid
->
»c
.id;

297 
	}
}

299 cÚ¡ *
·ck‘_id_Ãt_´št
(cÚ¡ 
·ck‘_id_Ãt
 *
pš
, 
boŞ
 
´št_time¡amp
, 
gc_¬’a
 *
gc
);

301 #ifdeà
PID_TEST


302 
·ck‘_id_š‹¿ùive_‹¡
();

306 
šlše
 

307 
	$·ck‘_id_size
(
boŞ
 
lÚg_fÜm
)

309  (
·ck‘_id_ty³
è+ (
lÚg_fÜm
 ? (
Ãt_time_t
) : 0);

310 
	}
}

312 
šlše
 
boŞ


313 
	$·ck‘_id_şo£_to_w¿µšg
(cÚ¡ 
·ck‘_id_£nd
 *
p
)

315  
p
->
id
 >ğ
PACKET_ID_WRAP_TRIGGER
;

316 
	}
}

318 
šlše
 
boŞ


319 
	$check_time¡amp_d–
(
time_t
 
»mÙe
, 
max_d–
)

321 
abs
;

322 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

324 ià(
loÿl_now
 >ğ
»mÙe
)

326 
abs
 = 
loÿl_now
 - 
»mÙe
;

330 
abs
 = 
»mÙe
 - 
loÿl_now
;

332  
abs
 <ğ
max_d–
;

333 
	}
}

335 
šlše
 

336 
	$·ck‘_id_»­_‹¡
(
·ck‘_id_»c
 *
p
)

338 ià(
p
->
Ï¡_»­
 + 
SEQ_REAP_INTERVAL
 <ğ
now
)

340 
	`·ck‘_id_»­
(
p
);

342 
	}
}

	@perf.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"³rf.h
"

34 #ifdeà
ENABLE_PERFORMANCE_METRICS


36 
	~"”rÜ.h
"

37 
	~"Ùime.h
"

39 
	~"memdbg.h
"

41 cÚ¡ *
	gm‘ric_Çmes
[] = {

64 
	s³rf


66 
	#PS_INITIAL
 0

	)

67 
	#PS_METER_RUNNING
 1

	)

68 
	#PS_METER_INTERRUPTED
 2

	)

69 
	m¡©e
;

71 
timev®
 
	m¡¬t
;

72 
	msoçr
;

73 
	msum
;

74 
	mmax
;

75 
	mcouÁ
;

78 
	s³rf_£t


80 
	m¡ack_Ën
;

81 
	m¡ack
[
STACK_N
];

82 
³rf
 
	m³rf
[
PERF_N
];

85 
³rf_£t
 
	g³rf_£t
;

87 
³rf_´št_¡©e
(
Ëv
);

89 
šlše
 

90 
	$g‘_¡ack_šdex
(
sd–
)

92 cÚ¡ 
sšdex
 = 
³rf_£t
.
¡ack_Ën
 + 
sd–
;

93 ià(
sšdex
 >ğ0 && sšdex < 
STACK_N
)

95  
sšdex
;

101 
	}
}

104 
	$g‘_³rf_šdex
(
sd–
)

106 cÚ¡ 
sšdex
 = 
	`g‘_¡ack_šdex
(
sd–
);

107 ià(
sšdex
 >= 0)

109 cÚ¡ 
pšdex
 = 
³rf_£t
.
¡ack
[
sšdex
];

110 ià(
pšdex
 >ğ0 &&…šdex < 
PERF_N
)

112  
pšdex
;

123 
	}
}

125 
³rf
 *

126 
	$g‘_³rf
(
sd–
)

128 cÚ¡ 
pšdex
 = 
	`g‘_³rf_šdex
(
sd–
);

129 ià(
pšdex
 >= 0)

131  &
³rf_£t
.
³rf
[
pšdex
];

135  
NULL
;

137 
	}
}

140 
	$push_³rf_šdex
(
pšdex
)

142 cÚ¡ 
sšdex
 = 
	`g‘_¡ack_šdex
(0);

143 cÚ¡ 
ÃwËn
 = 
	`g‘_¡ack_šdex
(1);

144 ià(
sšdex
 >ğ0 && 
ÃwËn
 >= 0

145 && 
pšdex
 >ğ0 &&…šdex < 
PERF_N
)

147 
i
;

148 
i
 = 0; i < 
sšdex
; ++i)

150 ià(
³rf_£t
.
¡ack
[
i
] =ğ
pšdex
)

152 
	`³rf_´št_¡©e
(
M_INFO
);

153 
	`msg
(
M_FATAL
, "PERF:…ush_perf_index %s failed",

154 
m‘ric_Çmes
 [
pšdex
]);

158 
³rf_£t
.
¡ack
[
sšdex
] = 
pšdex
;

159 
³rf_£t
.
¡ack_Ën
 = 
ÃwËn
;

163 
	`msg
(
M_FATAL
, "PERF:…ush_perf_index: stack…ushƒrror");

165 
	}
}

168 
	$pİ_³rf_šdex
()

170 cÚ¡ 
ÃwËn
 = 
	`g‘_¡ack_šdex
(-1);

171 ià(
ÃwËn
 >= 0)

173 
³rf_£t
.
¡ack_Ën
 = 
ÃwËn
;

177 
	`msg
(
M_FATAL
, "PERF:…op_perf_index: stack…opƒrror");

179 
	}
}

182 
	$¡©e_mu¡_be
(cÚ¡ 
³rf
 *
p
, cÚ¡ 
wª‹d
)

184 ià(
p
->
¡©e
 !ğ
wª‹d
)

186 
	`msg
(
M_FATAL
, "PERF: bad state‡ctual=%d wanted=%d",

187 
p
->
¡©e
,

188 
wª‹d
);

190 
	}
}

193 
	$upd©e_soçr
(
³rf
 *
p
)

195 
timev®
 
cu¼’t
;

196 
	`ASSERT
(!
	`g‘timeofday
(&
cu¼’t
, 
NULL
));

197 
p
->
soçr
 +ğ(è
	`tv_subŒaù
(&
cu¼’t
, &p->
¡¬t
, 600) / 1000000.0;

198 
	`tv_ş—r
(&
p
->
¡¬t
);

199 
	}
}

202 
	$³rf_¡¬t
(
³rf
 *
p
)

204 
	`¡©e_mu¡_be
(
p
, 
PS_INITIAL
);

205 
	`ASSERT
(!
	`g‘timeofday
(&
p
->
¡¬t
, 
NULL
));

206 
p
->
soçr
 = 0.0;

207 
p
->
¡©e
 = 
PS_METER_RUNNING
;

208 
	}
}

211 
	$³rf_¡İ
(
³rf
 *
p
)

213 
	`¡©e_mu¡_be
(
p
, 
PS_METER_RUNNING
);

214 
	`upd©e_soçr
(
p
);

215 
p
->
sum
 +ğp->
soçr
;

216 ià(
p
->
soçr
 >…->
max
)

218 
p
->
max
 =…->
soçr
;

220 
p
->
couÁ
 += 1.0;

221 
p
->
soçr
 = 0.0;

222 
p
->
¡©e
 = 
PS_INITIAL
;

223 
	}
}

226 
	$³rf_š‹¼u±
(
³rf
 *
p
)

228 
	`¡©e_mu¡_be
(
p
, 
PS_METER_RUNNING
);

229 
	`upd©e_soçr
(
p
);

230 
p
->
¡©e
 = 
PS_METER_INTERRUPTED
;

231 
	}
}

234 
	$³rf_»sume
(
³rf
 *
p
)

236 
	`¡©e_mu¡_be
(
p
, 
PS_METER_INTERRUPTED
);

237 
	`ASSERT
(!
	`g‘timeofday
(&
p
->
¡¬t
, 
NULL
));

238 
p
->
¡©e
 = 
PS_METER_RUNNING
;

239 
	}
}

242 
	$³rf_push
(
ty³
)

244 
³rf
 *
´ev
;

245 
³rf
 *
cur
;

247 
	`ASSERT
(
	`SIZE
(
m‘ric_Çmes
è=ğ
PERF_N
);

248 
	`push_³rf_šdex
(
ty³
);

250 
´ev
 = 
	`g‘_³rf
(-2);

251 
cur
 = 
	`g‘_³rf
(-1);

253 
	`ASSERT
(
cur
);

255 ià(
´ev
)

257 
	`³rf_š‹¼u±
(
´ev
);

259 
	`³rf_¡¬t
(
cur
);

260 
	}
}

263 
	$³rf_pİ
()

265 
³rf
 *
´ev
;

266 
³rf
 *
cur
;

268 
´ev
 = 
	`g‘_³rf
(-2);

269 
cur
 = 
	`g‘_³rf
(-1);

271 
	`ASSERT
(
cur
);

272 
	`³rf_¡İ
(
cur
);

274 ià(
´ev
)

276 
	`³rf_»sume
(
´ev
);

279 
	`pİ_³rf_šdex
();

280 
	}
}

283 
	$³rf_ouut_»suÉs
()

285 
i
;

286 
	`msg
(
M_INFO
, "LATENCY PROFILE (mean‡nd max‡re in milliseconds)");

287 
i
 = 0; i < 
PERF_N
; ++i)

289 
³rf
 *
p
 = &
³rf_£t
.³rf[
i
];

290 ià(
p
->
couÁ
 > 0.0)

292 cÚ¡ 
m—n
 = 
p
->
sum
 /…->
couÁ
;

293 
	`msg
(
M_INFO
, "% n=%.0àm—n=%.3àmax=%.3f", 
m‘ric_Çmes
[
i
], 
p
->
couÁ
, 
m—n
*1000.0,…->
max
*1000.0);

296 
	}
}

299 
	$³rf_´št_¡©e
(
Ëv
)

301 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

302 
i
;

303 
	`msg
(
Ëv
, "PERF STATE");

304 
	`msg
(
Ëv
, "Stack:");

305 
i
 = 0; i < 
³rf_£t
.
¡ack_Ën
; ++i)

307 cÚ¡ 
j
 = 
³rf_£t
.
¡ack
[
i
];

308 cÚ¡ 
³rf
 *
p
 = &
³rf_£t
.³rf[
j
];

309 
	`msg
(
Ëv
, "[%d] %s state=%d start=%s sofar=%f sum=%f max=%f count=%f",

310 
i
,

311 
m‘ric_Çmes
[
j
],

312 
p
->
¡©e
,

313 
	`tv_¡ršg
(&
p
->
¡¬t
, &
gc
),

314 
p
->
soçr
,

315 
p
->
sum
,

316 
p
->
max
,

317 
p
->
couÁ
);

319 
	`gc_ä“
(&
gc
);

320 
	}
}

323 #ifdeà
_MSC_VER


325 
	$dummy
()

327 
	}
}

	@perf.h

30 #iâdeà
PERF_H


31 
	#PERF_H


	)

38 
	#PERF_BIO_READ_PLAINTEXT
 0

	)

39 
	#PERF_BIO_WRITE_PLAINTEXT
 1

	)

40 
	#PERF_BIO_READ_CIPHERTEXT
 2

	)

41 
	#PERF_BIO_WRITE_CIPHERTEXT
 3

	)

42 
	#PERF_TLS_MULTI_PROCESS
 4

	)

43 
	#PERF_IO_WAIT
 5

	)

44 
	#PERF_EVENT_LOOP
 6

	)

45 
	#PERF_MULTI_CREATE_INSTANCE
 7

	)

46 
	#PERF_MULTI_CLOSE_INSTANCE
 8

	)

47 
	#PERF_MULTI_SHOW_STATS
 9

	)

48 
	#PERF_MULTI_BCAST
 10

	)

49 
	#PERF_MULTI_MCAST
 11

	)

50 
	#PERF_SCRIPT
 12

	)

51 
	#PERF_READ_IN_LINK
 13

	)

52 
	#PERF_PROC_IN_LINK
 14

	)

53 
	#PERF_READ_IN_TUN
 15

	)

54 
	#PERF_PROC_IN_TUN
 16

	)

55 
	#PERF_PROC_OUT_LINK
 17

	)

56 
	#PERF_PROC_OUT_TUN
 18

	)

57 
	#PERF_PROC_OUT_TUN_MTCP
 19

	)

58 
	#PERF_N
 20

	)

60 #ifdeà
ENABLE_PERFORMANCE_METRICS


62 
	~"basic.h
"

67 
	#STACK_N
 64

	)

69 
³rf_push
(
ty³
);

71 
³rf_pİ
();

73 
³rf_ouut_»suÉs
();

77 
šlše
 

78 
	$³rf_push
(
ty³
)

80 
	}
}

81 
šlše
 

82 
	$³rf_pİ
()

84 
	}
}

85 
šlše
 

86 
	$³rf_ouut_»suÉs
()

88 
	}
}

	@pf-inline.h

24 #ià
defšed
(
ENABLE_PF
è&& !defšed(
PF_INLINE_H
)

25 
	#PF_INLINE_H


	)

31 
	#PCT_SRC
 1

	)

32 
	#PCT_DEST
 2

	)

33 
šlše
 
boŞ


34 
	$pf_c2c_‹¡
(cÚ¡ 
cÚ‹xt
 *
¤c
, cÚ¡ cÚ‹xˆ*
de¡
, cÚ¡ *
´efix
)

36 
boŞ
 
	`pf_ú_‹¡
(
pf_£t
 *
pfs
, cÚ¡ 
s_muÉi
 *
tm
, cÚ¡ 
ty³
, cÚ¡ *
´efix
);

38  (!
¤c
->
c2
.
pf
.
’abËd
 || 
	`pf_ú_‹¡
(¤c->c2.pf.
pfs
, 
de¡
->c2.
s_muÉi
, 
PCT_DEST
, 
´efix
))

39 && (!
de¡
->
c2
.
pf
.
’abËd
 || 
	`pf_ú_‹¡
(de¡->c2.pf.
pfs
, 
¤c
->c2.
s_muÉi
, 
PCT_SRC
, 
´efix
));

40 
	}
}

42 
šlše
 
boŞ


43 
	$pf_addr_‹¡
(cÚ¡ 
cÚ‹xt
 *
¤c
, cÚ¡ 
mrou‹_addr
 *
de¡
, cÚ¡ *
´efix
)

45 
boŞ
 
	`pf_addr_‹¡_dowÜk
(cÚ¡ 
cÚ‹xt
 *
¤c
, cÚ¡ 
mrou‹_addr
 *
de¡
, cÚ¡ *
´efix
);

47 ià(
¤c
->
c2
.
pf
.
’abËd
)

49  
	`pf_addr_‹¡_dowÜk
(
¤c
, 
de¡
, 
´efix
);

53  
Œue
;

55 
	}
}

57 
šlše
 
boŞ


58 
	$pf_kl_‹¡
(cÚ¡ 
pf_£t
 *
pfs
)

60  
pfs
->
kl
;

61 
	}
}

	@pf.c

26 #ifdeà
HAVE_CONFIG_H


27 
	~"cÚfig.h
"

28 #–ià
defšed
(
_MSC_VER
)

29 
	~"cÚfig-msvc.h
"

32 
	~"sysh—d.h
"

34 #ià
defšed
(
ENABLE_PF
)

36 
	~"š™.h
"

37 
	~"memdbg.h
"

38 
	~"s¦_v”ify.h
"

40 
	~"pf-šlše.h
"

43 
	$pf_de¡roy
(
pf_£t
 *
pfs
)

45 ià(
pfs
)

47 ià(
pfs
->
ús
.
hash_bË
)

49 
	`hash_ä“
(
pfs
->
ús
.
hash_bË
);

53 
pf_ú_–em
 *
l
 = 
pfs
->
ús
.
li¡
;

54 
l
)

56 
pf_ú_–em
 *
Ãxt
 = 
l
->next;

57 
	`ä“
(
l
->
ruË
.
ú
);

58 
	`ä“
(
l
);

59 
l
 = 
Ãxt
;

63 
pf_subÃt
 *
l
 = 
pfs
->
¢s
.
li¡
;

64 
l
)

66 
pf_subÃt
 *
Ãxt
 = 
l
->next;

67 
	`ä“
(
l
);

68 
l
 = 
Ãxt
;

71 
	`ä“
(
pfs
);

73 
	}
}

75 
boŞ


76 
	$add_ş›Á
(cÚ¡ *
lše
, cÚ¡ *
´efix
, cÚ¡ 
lše_num
, 
pf_ú_–em
 ***
Ãxt
, cÚ¡ 
boŞ
 
exşude
)

78 
pf_ú_–em
 *
e
;

79 
	`ALLOC_OBJ_CLEAR
(
e
, 
pf_ú_–em
);

80 
e
->
ruË
.
exşude
 =ƒxclude;

81 
e
->
ruË
.
ú
 = 
	`¡ršg_®loc
(
lše
, 
NULL
);

82 **
Ãxt
 = 
e
;

83 *
Ãxt
 = &
e
->next;

84  
Œue
;

85 
	}
}

87 
boŞ


88 
	$add_subÃt
(cÚ¡ *
lše
, cÚ¡ *
´efix
, cÚ¡ 
lše_num
, 
pf_subÃt
 ***
Ãxt
, cÚ¡ 
boŞ
 
exşude
)

90 
š_addr
 
ÃtwÜk
;

91 
š_addr_t
 
Ãtmask
 = 0;

93 ià(
	`¡rcmp
(
lše
, "unknown"))

95 
Ãtb™s
 = 32;

96 *
div
 = 
	`¡rchr
(
lše
, '/');

98 ià(
div
)

100 *
div
++ = '\0';

101 ià(
	`ssÿnf
(
div
, "%d", &
Ãtb™s
) != 1)

103 
	`msg
(
D_PF_INFO
, "PF: %s/%d: bad '/n' subÃˆ¥ecif›r: '%s'", 
´efix
, 
lše_num
, 
div
);

104  
çl£
;

106 ià(
Ãtb™s
 < 0 ||‚etbits > 32)

108 
	`msg
(
D_PF_INFO
, "PF: %s/%d: bad '/n' subÃˆ¥ecif›r: mu¡ bb‘w“À0‡nd 32: '%s'", 
´efix
, 
lše_num
, 
div
);

109  
çl£
;

113 ià(
	`İ’v²_š‘_©Ú
(
lše
, &
ÃtwÜk
è!ğ
OIA_IP
)

115 
	`msg
(
D_PF_INFO
, "PF: %s/%d: bad‚‘wÜk‡dd»ss: '%s'", 
´efix
, 
lše_num
, 
lše
);

116  
çl£
;

118 
Ãtmask
 = 
	`Ãtb™s_to_Ãtmask
(
Ãtb™s
);

119 ià((
ÃtwÜk
.
s_addr
 & 
	`htÚl
(
Ãtmask
)) !=‚etwork.s_addr)

121 
ÃtwÜk
.
s_addr
 &ğ
	`htÚl
(
Ãtmask
);

122 
	`msg
(
M_WARN
, "WARNING: PF: %s/%d: incÜ»ù subÃˆ%s/%d chªgedØ%s/%d", 
´efix
, 
lše_num
, 
lše
, 
Ãtb™s
, 
	`š‘_Áß
(
ÃtwÜk
),‚etbits);

128 
ÃtwÜk
.
s_addr
 = 
	`htÚl
(0);

129 
Ãtmask
 = 
IPV4_NETMASK_HOST
;

133 
pf_subÃt
 *
e
;

134 
	`ALLOC_OBJ_CLEAR
(
e
, 
pf_subÃt
);

135 
e
->
ruË
.
exşude
 =ƒxclude;

136 
e
->
ruË
.
ÃtwÜk
 = 
	`Áohl
Ò‘wÜk.
s_addr
);

137 
e
->
ruË
.
Ãtmask
 =‚etmask;

138 **
Ãxt
 = 
e
;

139 *
Ãxt
 = &
e
->next;

140  
Œue
;

142 
	}
}

144 
ušt32_t


145 
	$ú_hash_funùiÚ
(cÚ¡ *
key
, 
ušt32_t
 
iv
)

147  
	`hash_func
((
ušt8_t
 *)
key
, 
	`¡¾’
((*)keyè+ 1, 
iv
);

148 
	}
}

150 
boŞ


151 
	$ú_com·»_funùiÚ
(cÚ¡ *
key1
, cÚ¡ *
key2
)

153  !
	`¡rcmp
((cÚ¡ *)
key1
, (cÚ¡ *)
key2
);

154 
	}
}

156 
boŞ


157 
	$g’hash
(
pf_ú_£t
 *
ús
, cÚ¡ *
´efix
, cÚ¡ 
n_ş›Ás
)

159 
pf_ú_–em
 *
e
;

160 
boŞ
 
¡©us
 = 
Œue
;

161 
n_buck‘s
 = 
n_ş›Ás
;

163 ià(
n_buck‘s
 < 16)

165 
n_buck‘s
 = 16;

167 
ús
->
hash_bË
 = 
	`hash_š™
(
n_buck‘s
, 0, 
ú_hash_funùiÚ
, 
ú_com·»_funùiÚ
);

168 
e
 = 
ús
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

170 ià(!
	`hash_add
(
ús
->
hash_bË
, 
e
->
ruË
.
ú
, &e->ruË, 
çl£
))

172 
	`msg
(
D_PF_INFO
, "PF: %s: du¶iÿ‹ commÚ‚amš [ş›Ás] seùiÚ: '%s'", 
´efix
, 
e
->
ruË
.
ú
);

173 
¡©us
 = 
çl£
;

177  
¡©us
;

178 
	}
}

180 
pf_£t
 *

181 
	$pf_š™
(cÚ¡ 
bufãr_li¡
 *
bl
, cÚ¡ *
´efix
, cÚ¡ 
boŞ
 
®low_kl
)

183 
	#MODE_UNDEF
 0

	)

184 
	#MODE_CLIENTS
 1

	)

185 
	#MODE_SUBNETS
 2

	)

186 
mode
 = 
MODE_UNDEF
;

187 
lše_num
 = 0;

188 
n_ş›Ás
 = 0;

189 
n_subÃts
 = 0;

190 
n_”rÜs
 = 0;

191 
pf_£t
 *
pfs
 = 
NULL
;

192 
lše
[
PF_MAX_LINE_LEN
];

194 
	`ALLOC_OBJ_CLEAR
(
pfs
, 
pf_£t
);

195 ià(
bl
)

197 
pf_ú_–em
 **
ş
 = &
pfs
->
ús
.
li¡
;

198 
pf_subÃt
 **
¦
 = &
pfs
->
¢s
.
li¡
;

199 
bufãr_’Œy
 *
be
;

201 
be
 = 
bl
->
h—d
; b!ğ
NULL
; bğbe->
Ãxt
)

203 ++
lše_num
;

204 
	`¡ºıyÁ
(
lše
, 
	`BSTR
(&
be
->
buf
), (line));

205 
	`rm_Œašg_ch¬s
(
lše
, "\r\n\t ");

206 ià(
lše
[0] == '\0' ||†ine[0] == '#')

209 ià(
lše
[0] == '+' ||†ine[0] == '-')

211 
boŞ
 
exşude
 = (
lše
[0] == '-');

213 ià(
lše
[1] =='\0')

215 
	`msg
(
D_PF_INFO
, "PF: %s/%d:‚Ød©¨aá” +/-: '%s'", 
´efix
, 
lše_num
, 
lše
);

216 ++
n_”rÜs
;

218 ià(
mode
 =ğ
MODE_CLIENTS
)

220 ià(
	`add_ş›Á
(&
lše
[1], 
´efix
, 
lše_num
, &
ş
, 
exşude
))

222 ++
n_ş›Ás
;

226 ++
n_”rÜs
;

229 ià(
mode
 =ğ
MODE_SUBNETS
)

231 ià(
	`add_subÃt
(&
lše
[1], 
´efix
, 
lše_num
, &
¦
, 
exşude
))

233 ++
n_subÃts
;

237 ++
n_”rÜs
;

240 ià(
mode
 =ğ
MODE_UNDEF
)

245 
	`ASSERT
(0);

248 ià(
lše
[0] == '[')

250 ià(!
	`¡rÿ£cmp
(
lše
, "[clients‡ccept]"))

252 
mode
 = 
MODE_CLIENTS
;

253 
pfs
->
ús
.
deçuÉ_®low
 = 
Œue
;

255 ià(!
	`¡rÿ£cmp
(
lše
, "[clients drop]"))

257 
mode
 = 
MODE_CLIENTS
;

258 
pfs
->
ús
.
deçuÉ_®low
 = 
çl£
;

260 ià(!
	`¡rÿ£cmp
(
lše
, "[subnets‡ccept]"))

262 
mode
 = 
MODE_SUBNETS
;

263 
pfs
->
¢s
.
deçuÉ_®low
 = 
Œue
;

265 ià(!
	`¡rÿ£cmp
(
lše
, "[subnets drop]"))

267 
mode
 = 
MODE_SUBNETS
;

268 
pfs
->
¢s
.
deçuÉ_®low
 = 
çl£
;

270 ià(!
	`¡rÿ£cmp
(
lše
, "[end]"))

272 
dÚe
;

274 ià(
®low_kl
 && !
	`¡rÿ£cmp
(
lše
, "[kill]"))

276 
kl
;

280 
mode
 = 
MODE_UNDEF
;

281 
	`msg
(
D_PF_INFO
, "PF: %s/%d unknowÀg: '%s'", 
´efix
, 
lše_num
, 
lše
);

282 ++
n_”rÜs
;

287 
	`msg
(
D_PF_INFO
, "PF: %s/%d†šmu¡ begš w™h '+', '-', o¸'[' : '%s'", 
´efix
, 
lše_num
, 
lše
);

288 ++
n_”rÜs
;

291 ++
n_”rÜs
;

292 
	`msg
(
D_PF_INFO
, "PF: %s: missšg [’d]", 
´efix
);

296 
	`msg
(
D_PF_INFO
, "PF: %s: cªnÙ o³n", 
´efix
);

297 ++
n_”rÜs
;

300 
dÚe
:

301 ià(
bl
)

303 ià(!
n_”rÜs
)

305 ià(!
	`g’hash
(&
pfs
->
ús
, 
´efix
, 
n_ş›Ás
))

307 ++
n_”rÜs
;

310 ià(
n_”rÜs
)

312 
	`msg
(
D_PF_INFO
, "PF: % »jeùed dutØ%dƒ¼Ü(s)", 
´efix
, 
n_”rÜs
);

315 ià(
n_”rÜs
)

317 
	`pf_de¡roy
(
pfs
);

318 
pfs
 = 
NULL
;

320  
pfs
;

322 
kl
:

323 
	`pf_de¡roy
(
pfs
);

324 
	`ALLOC_OBJ_CLEAR
(
pfs
, 
pf_£t
);

325 
pfs
->
kl
 = 
Œue
;

326  
pfs
;

327 
	}
}

329 #ifdeà
PLUGIN_PF


330 
pf_£t
 *

331 
	$pf_š™_äom_fe
(cÚ¡ *
â
)

333 
bufãr_li¡
 *
bl
 = 
	`bufãr_li¡_fe
(
â
, 
PF_MAX_LINE_LEN
);

334 ià(
bl
)

336 
pf_£t
 *
pfs
 = 
	`pf_š™
(
bl
, 
â
, 
Œue
);

337 
	`bufãr_li¡_ä“
(
bl
);

338  
pfs
;

342 
	`msg
(
D_PF_INFO
|
M_ERRNO
, "PF: %s: cªnÙ o³n", 
â
);

343  
NULL
;

345 
	}
}

348 #ifdeà
ENABLE_DEBUG


351 
	$drİ_acû±
(cÚ¡ 
boŞ
 
acû±
)

353  
acû±
 ? "ACCEPT" : "DROP";

354 
	}
}

357 
	$pù_Çme
(cÚ¡ 
ty³
)

359 
ty³
)

361 
PCT_SRC
:

364 
PCT_DEST
:

370 
	}
}

373 
	$pf_ú_‹¡_´št
(cÚ¡ *
´efix
,

374 cÚ¡ 
ty³
,

375 cÚ¡ *
´efix2
,

376 cÚ¡ *
ú
,

377 cÚ¡ 
boŞ
 
®low
,

378 cÚ¡ 
pf_ú
 *
ruË
)

380 ià(
ruË
)

382 
	`dmsg
(
D_PF_DEBUG
, "PF: %s/%s/%s %s %s„ule=[%s %s]",

383 
´efix
, 
´efix2
, 
	`pù_Çme
(
ty³
),

384 
ú
, 
	`drİ_acû±
(
®low
),

385 
ruË
->
ú
, 
	`drİ_acû±
(!ruË->
exşude
));

389 
	`dmsg
(
D_PF_DEBUG
, "PF: %s/%s/%s %s %s",

390 
´efix
, 
´efix2
, 
	`pù_Çme
(
ty³
),

391 
ú
, 
	`drİ_acû±
(
®low
));

393 
	}
}

396 
	$pf_addr_‹¡_´št
(cÚ¡ *
´efix
,

397 cÚ¡ *
´efix2
,

398 cÚ¡ 
cÚ‹xt
 *
¤c
,

399 cÚ¡ 
mrou‹_addr
 *
de¡
,

400 cÚ¡ 
boŞ
 
®low
,

401 cÚ¡ 
v4_subÃt
 *
ruË
)

403 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

404 ià(
ruË
)

406 
	`dmsg
(
D_PF_DEBUG
, "PF: %s/%s %s %s %s„ule=[%s/%s %s]",

407 
´efix
,

408 
´efix2
,

409 
	`s_commÚ_Çme
(
¤c
->
c2
.
s_muÉi
, 
çl£
),

410 
	`mrou‹_addr_´št_ex
(
de¡
, 
MAPF_SHOW_ARP
, &
gc
),

411 
	`drİ_acû±
(
®low
),

412 
	`´št_š_addr_t
(
ruË
->
ÃtwÜk
, 0, &
gc
),

413 
	`´št_š_addr_t
(
ruË
->
Ãtmask
, 0, &
gc
),

414 
	`drİ_acû±
(!
ruË
->
exşude
));

418 
	`dmsg
(
D_PF_DEBUG
, "PF: %s/%s %s %s %s",

419 
´efix
,

420 
´efix2
,

421 
	`s_commÚ_Çme
(
¤c
->
c2
.
s_muÉi
, 
çl£
),

422 
	`mrou‹_addr_´št_ex
(
de¡
, 
MAPF_SHOW_ARP
, &
gc
),

423 
	`drİ_acû±
(
®low
));

425 
	`gc_ä“
(&
gc
);

426 
	}
}

430 
šlše
 
pf_ú
 *

431 
	$lookup_ú_ruË
(
hash
 *
h
, cÚ¡ *
ú
, cÚ¡ 
ušt32_t
 
ú_hash
)

433 
hash_–em’t
 *
he
 = 
	`hash_lookup_ç¡
(
h
, 
	`hash_buck‘
(h, 
ú_hash
), 
ú
, cn_hash);

434 ià(
he
)

436  (
pf_ú
 *è
he
->
v®ue
;

440  
NULL
;

442 
	}
}

444 
boŞ


445 
	$pf_ú_‹¡
(
pf_£t
 *
pfs
, cÚ¡ 
s_muÉi
 *
tm
, cÚ¡ 
ty³
, cÚ¡ *
´efix
)

447 ià(
pfs
 && !pfs->
kl
)

449 cÚ¡ *
ú
;

450 
ušt32_t
 
ú_hash
;

451 ià(
	`s_commÚ_Çme_hash
(
tm
, &
ú
, &
ú_hash
))

453 cÚ¡ 
pf_ú
 *
ruË
 = 
	`lookup_ú_ruË
(
pfs
->
ús
.
hash_bË
, 
ú
, 
ú_hash
);

454 ià(
ruË
)

456 #ifdeà
ENABLE_DEBUG


457 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

459 
	`pf_ú_‹¡_´št
("PF_CN_MATCH", 
ty³
, 
´efix
, 
ú
, !
ruË
->
exşude
,„ule);

462 ià(!
ruË
->
exşude
)

464  
Œue
;

468  
çl£
;

473 #ifdeà
ENABLE_DEBUG


474 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

476 
	`pf_ú_‹¡_´št
("PF_CN_DEFAULT", 
ty³
, 
´efix
, 
ú
, 
pfs
->
ús
.
deçuÉ_®low
, 
NULL
);

479 ià(
pfs
->
ús
.
deçuÉ_®low
)

481  
Œue
;

485  
çl£
;

490 #ifdeà
ENABLE_DEBUG


491 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

493 
	`pf_ú_‹¡_´št
("PF_CN_FAULT", 
ty³
, 
´efix
, 
	`s_commÚ_Çme
(
tm
, 
çl£
), f®£, 
NULL
);

496  
çl£
;

497 
	}
}

499 
boŞ


500 
	$pf_addr_‹¡_dowÜk
(cÚ¡ 
cÚ‹xt
 *
¤c
, cÚ¡ 
mrou‹_addr
 *
de¡
, cÚ¡ *
´efix
)

502 
pf_£t
 *
pfs
 = 
¤c
->
c2
.
pf
.pfs;

503 ià(
pfs
 && !pfs->
kl
)

505 cÚ¡ 
š_addr_t
 
addr
 = 
	`š_addr_t_äom_mrou‹_addr
(
de¡
);

506 cÚ¡ 
pf_subÃt
 *
£
 = 
pfs
->
¢s
.
li¡
;

507 
£
)

509 ià((
addr
 & 
£
->
ruË
.
Ãtmask
è=ğ£->ruË.
ÃtwÜk
)

511 #ifdeà
ENABLE_DEBUG


512 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

514 
	`pf_addr_‹¡_´št
("PF_ADDR_MATCH", 
´efix
, 
¤c
, 
de¡
, !
£
->
ruË
.
exşude
, &se->rule);

517  !
£
->
ruË
.
exşude
;

519 
£
 = se->
Ãxt
;

521 #ifdeà
ENABLE_DEBUG


522 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

524 
	`pf_addr_‹¡_´št
("PF_ADDR_DEFAULT", 
´efix
, 
¤c
, 
de¡
, 
pfs
->
¢s
.
deçuÉ_®low
, 
NULL
);

527  
pfs
->
¢s
.
deçuÉ_®low
;

531 #ifdeà
ENABLE_DEBUG


532 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

534 
	`pf_addr_‹¡_´št
("PF_ADDR_FAULT", 
´efix
, 
¤c
, 
de¡
, 
çl£
, 
NULL
);

537  
çl£
;

539 
	}
}

541 #ifdeà
PLUGIN_PF


543 
	$pf_check_»lßd
(
cÚ‹xt
 *
c
)

545 cÚ¡ 
¦ow_wakeup
 = 15;

546 cÚ¡ 
ç¡_wakeup
 = 1;

547 cÚ¡ 
wakeup_Œªs™iÚ
 = 60;

548 
boŞ
 
»lßded
 = 
çl£
;

550 ià(
c
->
c2
.
pf
.
’abËd


551 && 
c
->
c2
.
pf
.
f’ame


552 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
pf
.
»lßd
, &c->c2.
timev®
, 
ETT_DEFAULT
))

554 
¶©fÜm_¡©_t
 
s
;

555 ià(!
	`¶©fÜm_¡©
(
c
->
c2
.
pf
.
f’ame
, &
s
))

557 ià(
s
.
¡_mtime
 > 
c
->
c2
.
pf
.
fe_Ï¡_mod
)

559 
pf_£t
 *
pfs
 = 
	`pf_š™_äom_fe
(
c
->
c2
.
pf
.
f’ame
);

560 ià(
pfs
)

562 ià(
c
->
c2
.
pf
.
pfs
)

564 
	`pf_de¡roy
(
c
->
c2
.
pf
.
pfs
);

566 
c
->
c2
.
pf
.
pfs
 =…fs;

567 
»lßded
 = 
Œue
;

568 ià(
	`pf_kl_‹¡
(
pfs
))

570 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

571 
c
->
sig
->
sigÇl_‹xt
 = "pf-kill";

574 
c
->
c2
.
pf
.
fe_Ï¡_mod
 = 
s
.
¡_mtime
;

578 
wakeup
 = 
¦ow_wakeup
;

579 ià(!
c
->
c2
.
pf
.
pfs
 && c->c2.pf.
n_check_»lßd
 < 
wakeup_Œªs™iÚ
)

581 
wakeup
 = 
ç¡_wakeup
;

583 
	`ev’t_timeout_š™
(&
c
->
c2
.
pf
.
»lßd
, 
wakeup
, 
now
);

584 
	`»£t_cßr£_tim”s
(
c
);

585 
c
->
c2
.
pf
.
n_check_»lßd
++;

588 #ifdeà
ENABLE_DEBUG


589 ià(
»lßded
 && 
	`check_debug_Ëv–
(
D_PF_DEBUG
))

591 
	`pf_cÚ‹xt_´št
(&
c
->
c2
.
pf
, "pf_check_»lßd", 
D_PF_DEBUG
);

594 
	}
}

597 #ifdeà
MANAGEMENT_PF


598 
boŞ


599 
	$pf_lßd_äom_bufãr_li¡
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr_li¡
 *
cÚfig
)

601 
pf_£t
 *
pfs
 = 
	`pf_š™
(
cÚfig
, "[SERVER-PF]", 
çl£
);

602 ià(
pfs
)

604 ià(
c
->
c2
.
pf
.
pfs
)

606 
	`pf_de¡roy
(
c
->
c2
.
pf
.
pfs
);

608 
c
->
c2
.
pf
.
pfs
 =…fs;

609  
Œue
;

613  
çl£
;

615 
	}
}

619 
	$pf_š™_cÚ‹xt
(
cÚ‹xt
 *
c
)

621 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

622 #ifdeà
PLUGIN_PF


623 ià(
	`¶ugš_defšed
(
c
->
¶ugšs
, 
OPENVPN_PLUGIN_ENABLE_PF
))

625 cÚ¡ *
pf_fe
 = 
	`ü—‹_‹mp_fe
(
c
->
İtiÚs
.
tmp_dœ
, "pf", &
gc
);

626 ià(
pf_fe
)

628 
	`£‹nv_¡r
(
c
->
c2
.
es
, "pf_fe", 
pf_fe
);

630 ià(
	`¶ugš_ÿÎ
(
c
->
¶ugšs
, 
OPENVPN_PLUGIN_ENABLE_PF
, 
NULL
, NULL, c->
c2
.
es
è=ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

632 
	`ev’t_timeout_š™
(&
c
->
c2
.
pf
.
»lßd
, 1, 
now
);

633 
c
->
c2
.
pf
.
f’ame
 = 
	`¡ršg_®loc
(
pf_fe
, &c->c2.
gc
);

634 
c
->
c2
.
pf
.
’abËd
 = 
Œue
;

635 #ifdeà
ENABLE_DEBUG


636 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

638 
	`pf_cÚ‹xt_´št
(&
c
->
c2
.
pf
, "pf_š™_cÚ‹xt#1", 
D_PF_DEBUG
);

644 
	`msg
(
M_WARN
, "WARNING: OPENVPN_PLUGIN_ENABLE_PF disabled");

649 #ifdeà
MANAGEMENT_PF


650 ià(!
c
->
c2
.
pf
.
’abËd
 && 
	`mªagem’t_’abË_pf
(
mªagem’t
))

652 
c
->
c2
.
pf
.
’abËd
 = 
Œue
;

653 #ifdeà
ENABLE_DEBUG


654 ià(
	`check_debug_Ëv–
(
D_PF_DEBUG
))

656 
	`pf_cÚ‹xt_´št
(&
c
->
c2
.
pf
, "pf_š™_cÚ‹xt#2", 
D_PF_DEBUG
);

661 
	`gc_ä“
(&
gc
);

662 
	}
}

665 
	$pf_de¡roy_cÚ‹xt
(
pf_cÚ‹xt
 *
pfc
)

667 #ifdeà
PLUGIN_PF


668 ià(
pfc
->
f’ame
)

670 
	`¶©fÜm_uÆšk
(
pfc
->
f’ame
);

673 ià(
pfc
->
pfs
)

675 
	`pf_de¡roy
(
pfc
->
pfs
);

677 
	}
}

679 #ifdeà
ENABLE_DEBUG


682 
	$pf_subÃt_£t_´št
(cÚ¡ 
pf_subÃt_£t
 *
s
, cÚ¡ 
Ëv
)

684 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

685 ià(
s
)

687 
pf_subÃt
 *
e
;

689 
	`msg
(
Ëv
, " ----- struct…f_subnet_set -----");

690 
	`msg
(
Ëv
, " deçuÉ_®low=%s", 
	`drİ_acû±
(
s
->
deçuÉ_®low
));

692 
e
 = 
s
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

694 
	`msg
(
Ëv
, " %s/%s %s",

695 
	`´št_š_addr_t
(
e
->
ruË
.
ÃtwÜk
, 0, &
gc
),

696 
	`´št_š_addr_t
(
e
->
ruË
.
Ãtmask
, 0, &
gc
),

697 
	`drİ_acû±
(!
e
->
ruË
.
exşude
));

700 
	`gc_ä“
(&
gc
);

701 
	}
}

704 
	$pf_ú_£t_´št
(cÚ¡ 
pf_ú_£t
 *
s
, cÚ¡ 
Ëv
)

706 ià(
s
)

708 
hash_™”©Ü
 
hi
;

709 
hash_–em’t
 *
he
;

711 
	`msg
(
Ëv
, " ----- struct…f_cn_set -----");

712 
	`msg
(
Ëv
, " deçuÉ_®low=%s", 
	`drİ_acû±
(
s
->
deçuÉ_®low
));

714 ià(
s
->
hash_bË
)

716 
	`hash_™”©Ü_š™
(
s
->
hash_bË
, &
hi
);

717 (
he
 = 
	`hash_™”©Ü_Ãxt
(&
hi
)))

719 
pf_ú
 *
e
 = (pf_ú *)
he
->
v®ue
;

720 
	`msg
(
Ëv
, " %s %s",

721 
e
->
ú
,

722 
	`drİ_acû±
(!
e
->
exşude
));

725 
	`msg
(
Ëv
, " ----------");

728 
pf_ú_–em
 *
û
;

729 
û
 = 
s
->
li¡
; c!ğ
NULL
; cğû->
Ãxt
)

731 
pf_ú
 *
e
 = 
	`lookup_ú_ruË
(
s
->
hash_bË
, 
û
->
ruË
.
ú
, 
	`ú_hash_funùiÚ
(ce->rule.cn, 0));

732 ià(
e
)

734 
	`msg
(
Ëv
, " %s %s",

735 
e
->
ú
,

736 
	`drİ_acû±
(!
e
->
exşude
));

740 
	`msg
(
Ëv
, " % LOOKUP FAILED", 
û
->
ruË
.
ú
);

746 
	}
}

749 
	$pf_£t_´št
(cÚ¡ 
pf_£t
 *
pfs
, cÚ¡ 
Ëv
)

751 ià(
pfs
)

753 
	`msg
(
Ëv
, " ----- struct…f_set -----");

754 
	`msg
(
Ëv
, " kl=%d", 
pfs
->
kl
);

755 
	`pf_subÃt_£t_´št
(&
pfs
->
¢s
, 
Ëv
);

756 
	`pf_ú_£t_´št
(&
pfs
->
ús
, 
Ëv
);

758 
	}
}

761 
	$pf_cÚ‹xt_´št
(cÚ¡ 
pf_cÚ‹xt
 *
pfc
, cÚ¡ *
´efix
, cÚ¡ 
Ëv
)

763 
	`msg
(
Ëv
, "----- % : sŒuù…f_cÚ‹xˆ-----", 
´efix
);

764 ià(
pfc
)

766 
	`msg
(
Ëv
, "’abËd=%d", 
pfc
->
’abËd
);

767 #ifdeà
PLUGIN_PF


768 
	`msg
(
Ëv
, "f’ame='%s'", 
	`Å
(
pfc
->
f’ame
));

769 
	`msg
(
Ëv
, "fe_Ï¡_mod=%u", ()
pfc
->
fe_Ï¡_mod
);

770 
	`msg
(
Ëv
, "n_check_»lßd=%u", 
pfc
->
n_check_»lßd
);

771 
	`msg
(
Ëv
, "»lßd=[%d,%u,%u]", 
pfc
->
»lßd
.
defšed
,…fc->»lßd.
n
, (ífc->»lßd.
Ï¡
);

773 
	`pf_£t_´št
(
pfc
->
pfs
, 
Ëv
);

775 
	`msg
(
Ëv
, "--------------------");

776 
	}
}

	@pf.h

26 #ià
defšed
(
ENABLE_PF
è&& !defšed(
OPENVPN_PF_H
)

27 
	#OPENVPN_PF_H


	)

29 
	~"li¡.h
"

30 
	~"mrou‹.h
"

32 
	#PF_MAX_LINE_LEN
 256

	)

34 
	gcÚ‹xt
;

36 
	sv4_subÃt
 {

37 
boŞ
 
	mexşude
;

38 
š_addr_t
 
	mÃtwÜk
;

39 
š_addr_t
 
	mÃtmask
;

42 
	spf_subÃt
 {

43 
pf_subÃt
 *
	mÃxt
;

44 
v4_subÃt
 
	mruË
;

47 
	spf_subÃt_£t
 {

48 
boŞ
 
	mdeçuÉ_®low
;

49 
pf_subÃt
 *
	mli¡
;

52 
	spf_ú
 {

53 
boŞ
 
	mexşude
;

54 *
	mú
;

57 
	spf_ú_–em
 {

58 
pf_ú_–em
 *
	mÃxt
;

59 
pf_ú
 
	mruË
;

62 
	spf_ú_£t
 {

63 
boŞ
 
	mdeçuÉ_®low
;

64 
pf_ú_–em
 *
	mli¡
;

65 
hash
 *
	mhash_bË
;

68 
	spf_£t
 {

69 
boŞ
 
	mkl
;

70 
pf_subÃt_£t
 
	m¢s
;

71 
pf_ú_£t
 
	mús
;

74 
	spf_cÚ‹xt
 {

75 
boŞ
 
	m’abËd
;

76 
pf_£t
 *
	mpfs
;

77 #ifdeà
PLUGIN_PF


78 *
	mf’ame
;

79 
time_t
 
	mfe_Ï¡_mod
;

80 
	mn_check_»lßd
;

81 
ev’t_timeout
 
	m»lßd
;

85 
pf_š™_cÚ‹xt
(
cÚ‹xt
 *
c
);

87 
pf_de¡roy_cÚ‹xt
(
pf_cÚ‹xt
 *
pfc
);

89 #ifdeà
PLUGIN_PF


90 
pf_check_»lßd
(
cÚ‹xt
 *
c
);

94 #ifdeà
MANAGEMENT_PF


95 
boŞ
 
pf_lßd_äom_bufãr_li¡
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr_li¡
 *
cÚfig
);

99 #ifdeà
ENABLE_DEBUG


100 
pf_cÚ‹xt_´št
(cÚ¡ 
pf_cÚ‹xt
 *
pfc
, cÚ¡ *
´efix
, cÚ¡ 
Ëv
);

	@ping-inline.h

24 #iâdeà
PING_INLINE_H


25 
	#PING_INLINE_H


	)

31 
šlše
 

32 
	$check_pšg_»¡¬t
(
cÚ‹xt
 *
c
)

34 
	`check_pšg_»¡¬t_dowÜk
(
cÚ‹xt
 *
c
);

36 ià(
c
->
İtiÚs
.
pšg_»c_timeout


37 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
pšg_»c_š‹rv®
,

38 &
c
->
c2
.
timev®
,

39 (!
c
->
İtiÚs
.
pšg_tim”_»mÙe


40 || 
	`lšk_sock‘_aùu®_defšed
(&
c
->
c1
.
lšk_sock‘_addr
.
aùu®
))

41 ? 
ETT_DEFAULT
 : 15))

43 
	`check_pšg_»¡¬t_dowÜk
(
c
);

45 
	}
}

50 
šlše
 

51 
	$check_pšg_£nd
(
cÚ‹xt
 *
c
)

53 
	`check_pšg_£nd_dowÜk
(
cÚ‹xt
 *
c
);

55 ià(
c
->
İtiÚs
.
pšg_£nd_timeout


56 && 
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
pšg_£nd_š‹rv®
,

57 &
c
->
c2
.
timev®
,

58 !
	`TO_LINK_DEF
(
c
è? 
ETT_DEFAULT
 : 1))

60 
	`check_pšg_£nd_dowÜk
(
c
);

62 
	}
}

	@ping.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"pšg.h
"

34 
	~"memdbg.h
"

36 
	~"pšg-šlše.h
"

45 cÚ¡ 
ušt8_t
 
	gpšg_¡ršg
[] = {

55 
	$check_pšg_»¡¬t_dowÜk
(
cÚ‹xt
 *
c
)

57 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

58 
c
->
İtiÚs
.
pšg_»c_timeout_aùiÚ
)

60 
PING_EXIT
:

61 
	`msg
(
M_INFO
, "%sInactivityimeout (--ping-exit),ƒxiting",

62 
	`fÜm©_commÚ_Çme
(
c
, &
gc
));

63 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

64 
c
->
sig
->
sigÇl_‹xt
 = "ping-exit";

67 
PING_RESTART
:

68 
	`msg
(
M_INFO
, "%sInactivityimeout (--ping-restart),„estarting",

69 
	`fÜm©_commÚ_Çme
(
c
, &
gc
));

70 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

71 
c
->
sig
->
sigÇl_‹xt
 = "ping-restart";

75 
	`ASSERT
(0);

77 
	`gc_ä“
(&
gc
);

78 
	}
}

84 
	$check_pšg_£nd_dowÜk
(
cÚ‹xt
 *
c
)

86 
c
->
c2
.
buf
 = c->c2.
bufãrs
->
aux_buf
;

87 
	`ASSERT
(
	`buf_š™
(&
c
->
c2
.
buf
, 
	`FRAME_HEADROOM
(&c->c2.
äame
)));

88 
	`ASSERT
(
	`buf_§ã
(&
c
->
c2
.
buf
, 
	`MAX_RW_SIZE_TUN
(&c->c2.
äame
)));

89 
	`ASSERT
(
	`buf_wr™e
(&
c
->
c2
.
buf
, 
pšg_¡ršg
, (ping_string)));

95 
	`’üy±_sign
(
c
, 
Œue
);

97 
c
->
c2
.
buf
.
Ën
 = 0;

98 
	`dmsg
(
D_PING
, "SENT PING");

99 
	}
}

	@ping.h

24 #iâdeà
PING_H


25 
	#PING_H


	)

27 
	~"š™.h
"

28 
	~"fÜw¬d.h
"

33 
	#PRE_PULL_INITIAL_PING_RESTART
 120

	)

35 cÚ¡ 
ušt8_t
 
pšg_¡ršg
[];

38 
	#PING_STRING_SIZE
 16

	)

40 
šlše
 
boŞ


41 
	$is_pšg_msg
(cÚ¡ 
bufãr
 *
buf
)

43  
	`buf_¡ršg_m©ch
(
buf
, 
pšg_¡ršg
, 
PING_STRING_SIZE
);

44 
	}
}

	@pkcs11.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
defšed
(
ENABLE_PKCS11
)

34 
	~<pkcs11-h–³r-1.0/pkcs11h-û¹ifiÿ‹.h
>

35 
	~"basic.h
"

36 
	~"”rÜ.h
"

37 
	~"mªage.h
"

38 
	~"ba£64.h
"

39 
	~"pkcs11.h
"

40 
	~"misc.h
"

41 
	~"Ùime.h
"

42 
	~"cÚsŞe.h
"

43 
	~"pkcs11_back’d.h
"

46 
time_t


47 
	$__mytime
()

49  
	`İ’v²_time
(
NULL
);

50 
	}
}

52 #ià!
defšed
(
_WIN32
)

55 
	$__myg‘timeofday
(
timev®
 *
tv
)

57  
	`g‘timeofday
(
tv
, 
NULL
);

58 
	}
}

63 
	$__my¦“p
(cÚ¡ 
u£c
)

65 #ià
	`defšed
(
_WIN32
)

66 
	`SË•
(
u£c
/1000);

68 
	`u¦“p
(
u£c
);

70 
	}
}

73 
pkcs11h_’gše_sy¡em_t
 
	gs_pkcs11h_sys_’gše
 = {

74 
m®loc
,

75 
ä“
,

76 
__mytime
,

77 
__my¦“p
,

78 #ià
defšed
(
_WIN32
)

79 
NULL


81 
__myg‘timeofday


87 
	$_pkcs11_msg_pkcs112İ’v²
(

88 cÚ¡ 
æags


91 
İ’v²_æags
;

93 
æags
)

95 
PKCS11H_LOG_DEBUG2
:

96 
İ’v²_æags
 = 
D_PKCS11_DEBUG
;

99 
PKCS11H_LOG_DEBUG1
:

100 
İ’v²_æags
 = 
D_SHOW_PKCS11
;

103 
PKCS11H_LOG_INFO
:

104 
İ’v²_æags
 = 
M_INFO
;

107 
PKCS11H_LOG_WARN
:

108 
İ’v²_æags
 = 
M_WARN
;

111 
PKCS11H_LOG_ERROR
:

112 
İ’v²_æags
 = 
M_FATAL
;

116 
İ’v²_æags
 = 
M_FATAL
;

120 #ià
	`defšed
(
ENABLE_PKCS11_FORCE_DEBUG
)

121 
İ’v²_æags
 = 
M_INFO
;

124  
İ’v²_æags
;

125 
	}
}

129 
	$_pkcs11_msg_İ’v²2pkcs11
(

130 cÚ¡ 
æags


133 
pkcs11_æags
;

135 ià((
æags
 & 
D_PKCS11_DEBUG
) != 0)

137 
pkcs11_æags
 = 
PKCS11H_LOG_DEBUG2
;

139 ià((
æags
 & 
D_SHOW_PKCS11
) != 0)

141 
pkcs11_æags
 = 
PKCS11H_LOG_DEBUG1
;

143 ià((
æags
 & 
M_INFO
) != 0)

145 
pkcs11_æags
 = 
PKCS11H_LOG_INFO
;

147 ià((
æags
 & 
M_WARN
) != 0)

149 
pkcs11_æags
 = 
PKCS11H_LOG_WARN
;

151 ià((
æags
 & 
M_FATAL
) != 0)

153 
pkcs11_æags
 = 
PKCS11H_LOG_ERROR
;

157 
pkcs11_æags
 = 
PKCS11H_LOG_ERROR
;

160 #ià
	`defšed
(
ENABLE_PKCS11_FORCE_DEBUG
)

161 
pkcs11_æags
 = 
PKCS11H_LOG_DEBUG2
;

164  
pkcs11_æags
;

165 
	}
}

169 
	$_pkcs11_İ’v²_log
(

170 *cÚ¡ 
glob®_d©a
,

171 
æags
,

172 cÚ¡ *cÚ¡ 
szFÜm©
,

173 
va_li¡
 
¬gs


176 
Bufãr
[10*1024];

178 ()
glob®_d©a
;

180 
	`v¢´štf
(
Bufãr
, (Bufãr), 
szFÜm©
, 
¬gs
);

181 
Bufãr
[(Buffer)-1] = 0;

183 
	`msg
(
	`_pkcs11_msg_pkcs112İ’v²
(
æags
), "%s", 
Bufãr
);

184 
	}
}

187 
PKCS11H_BOOL


188 
	$_pkcs11_İ’v²_tok’_´om±
(

189 *cÚ¡ 
glob®_d©a
,

190 *cÚ¡ 
u£r_d©a
,

191 cÚ¡ 
pkcs11h_tok’_id_t
 
tok’
,

192 cÚ¡ 
»Œy


195 
u£r_·ss
 
tok’_»¥
;

197 ()
glob®_d©a
;

198 ()
u£r_d©a
;

199 ()
»Œy
;

201 
	`ASSERT
(
tok’
!=
NULL
);

203 
	`CLEAR
(
tok’_»¥
);

204 
tok’_»¥
.
defšed
 = 
çl£
;

205 
tok’_»¥
.
noÿche
 = 
Œue
;

206 
	`İ’v²_¢´štf
(

207 
tok’_»¥
.
u£ºame
,

208 (
tok’_»¥
.
u£ºame
),

210 
tok’
->
Ïb–


214 !
	`g‘_u£r_·ss
(

215 &
tok’_»¥
,

216 
NULL
,

218 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_OK
|
GET_USER_PASS_NOFATAL


222  
çl£
;

226  
	`¡rcmp
(
tok’_»¥
.
·sswÜd
, "ok") == 0;

228 
	}
}

231 
PKCS11H_BOOL


232 
	$_pkcs11_İ’v²_pš_´om±
(

233 *cÚ¡ 
glob®_d©a
,

234 *cÚ¡ 
u£r_d©a
,

235 cÚ¡ 
pkcs11h_tok’_id_t
 
tok’
,

236 cÚ¡ 
»Œy
,

237 *cÚ¡ 
pš
,

238 cÚ¡ 
size_t
 
pš_max


241 
u£r_·ss
 
tok’_·ss
;

242 
´om±
[1024];

244 ()
glob®_d©a
;

245 ()
u£r_d©a
;

246 ()
»Œy
;

248 
	`ASSERT
(
tok’
!=
NULL
);

250 
	`İ’v²_¢´štf
(
´om±
, Õrom±), "% tok’", 
tok’
->
Ïb–
);

252 
tok’_·ss
.
defšed
 = 
çl£
;

253 
tok’_·ss
.
noÿche
 = 
Œue
;

256 !
	`g‘_u£r_·ss
(

257 &
tok’_·ss
,

258 
NULL
,

259 
´om±
,

260 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_PASSWORD_ONLY
|
GET_USER_PASS_NOFATAL


264  
çl£
;

268 
	`¡ºıyÁ
(
pš
, 
tok’_·ss
.
·sswÜd
, 
pš_max
);

269 
	`purge_u£r_·ss
(&
tok’_·ss
, 
Œue
);

271 ià(
	`¡¾’
(
pš
) == 0)

273  
çl£
;

277  
Œue
;

280 
	}
}

282 
boŞ


283 
	$pkcs11_š™Ÿlize
(

284 cÚ¡ 
boŞ
 
´Ùeùed_auth
,

285 cÚ¡ 
nPINCacheP”iod


288 
CK_RV
 
rv
 = 
CKR_FUNCTION_FAILED
;

290 
	`dmsg
(

291 
D_PKCS11_DEBUG
,

295 ià((
rv
 = 
	`pkcs11h_’gše_£tSy¡em
(&
s_pkcs11h_sys_’gše
)è!ğ
CKR_OK
)

297 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ in™Ÿlizsy¡emƒngš%ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

298 
ş—nup
;

301 ià((
rv
 = 
	`pkcs11h_š™Ÿlize
()è!ğ
CKR_OK
)

303 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ in™Ÿliz%ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

304 
ş—nup
;

307 ià((
rv
 = 
	`pkcs11h_£tLogHook
(
_pkcs11_İ’v²_log
, 
NULL
)è!ğ
CKR_OK
)

309 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ hook %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

310 
ş—nup
;

313 
	`pkcs11h_£tLogLev–
(
	`_pkcs11_msg_İ’v²2pkcs11
(
	`g‘_debug_Ëv–
()));

315 ià((
rv
 = 
	`pkcs11h_£tFÜkMode
(
TRUE
)è!ğ
CKR_OK
)

317 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ fÜk mod%ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

318 
ş—nup
;

321 ià((
rv
 = 
	`pkcs11h_£tTok’Prom±Hook
(
_pkcs11_İ’v²_tok’_´om±
, 
NULL
)è!ğ
CKR_OK
)

323 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ hook %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

324 
ş—nup
;

327 ià((
rv
 = 
	`pkcs11h_£tPINProm±Hook
(
_pkcs11_İ’v²_pš_´om±
, 
NULL
)è!ğ
CKR_OK
)

329 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ hook %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

330 
ş—nup
;

333 ià((
rv
 = 
	`pkcs11h_£tPrÙeùedAuth’tiÿtiÚ
(
´Ùeùed_auth
)è!ğ
CKR_OK
)

335 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘…rÙeùed‡uth’tiÿtiÚ mod%ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

336 
ş—nup
;

339 ià((
rv
 = 
	`pkcs11h_£tPINCacheP”iod
(
nPINCacheP”iod
)è!ğ
CKR_OK
)

341 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ Pÿch³riod %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

342 
ş—nup
;

345 
rv
 = 
CKR_OK
;

347 
ş—nup
:

348 
	`dmsg
(

349 
D_PKCS11_DEBUG
,

351 
rv
,

352 
	`pkcs11h_g‘Mes§ge
(
rv
)

355  
rv
 =ğ
CKR_OK
;

356 
	}
}

359 
	$pkcs11_‹rmš©e
()

361 
	`dmsg
(

362 
D_PKCS11_DEBUG
,

366 
	`pkcs11h_‹rmš©e
();

368 
	`dmsg
(

369 
D_PKCS11_DEBUG
,

372 
	}
}

374 
boŞ


375 
	$pkcs11_addProvid”
(

376 cÚ¡ *cÚ¡ 
´ovid”
,

377 cÚ¡ 
boŞ
 
´Ùeùed_auth
,

378 cÚ¡ 
´iv©e_mode
,

379 cÚ¡ 
boŞ
 
û¹_´iv©e


382 
CK_RV
 
rv
 = 
CKR_OK
;

384 
	`ASSERT
(
´ovid”
!=
NULL
);

386 
	`dmsg
(

387 
D_PKCS11_DEBUG
,

389 
´ovid”
,

390 
´iv©e_mode


393 
	`msg
(

394 
M_INFO
,

396 
´ovid”


400 (
rv
 = 
	`pkcs11h_addProvid”
(

401 
´ovid”
,

402 
´ovid”
,

403 
´Ùeùed_auth
,

404 
´iv©e_mode
,

405 
PKCS11H_SLOTEVENT_METHOD_AUTO
,

407 
û¹_´iv©e


408 )è!ğ
CKR_OK


411 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ in™Ÿliz´ovid” '%s' %ld-'%s'", 
´ovid”
, 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

414 
	`dmsg
(

415 
D_PKCS11_DEBUG
,

417 
rv
,

418 
	`pkcs11h_g‘Mes§ge
(
rv
)

421  
rv
 =ğ
CKR_OK
;

422 
	}
}

425 
	$pkcs11_logout
()

427  
	`pkcs11h_logout
(è=ğ
CKR_OK
;

428 
	}
}

431 
	$pkcs11_mªagem’t_id_couÁ
()

433 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
id_li¡
 = 
NULL
;

434 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
t
 = 
NULL
;

435 
CK_RV
 
rv
 = 
CKR_OK
;

436 
couÁ
 = 0;

438 
	`dmsg
(

439 
D_PKCS11_DEBUG
,

444 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_’umC”tifiÿ‹Ids
(

445 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

446 
NULL
,

447 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

448 
NULL
,

449 &
id_li¡


450 )è!ğ
CKR_OK


453 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹†i¡ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

454 
ş—nup
;

457 
couÁ
 = 0, 
t
 = 
id_li¡
; !ğ
NULL
; =->
Ãxt
)

459 
couÁ
++;

462 
ş—nup
:

464 ià(
id_li¡
 !ğ
NULL
)

466 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹IdLi¡
(
id_li¡
);

467 
id_li¡
 = 
NULL
;

470 
	`dmsg
(

471 
D_PKCS11_DEBUG
,

473 
couÁ


476  
couÁ
;

477 
	}
}

479 
boŞ


480 
	$pkcs11_mªagem’t_id_g‘
(

481 cÚ¡ 
šdex
,

482 **
id
,

483 **
ba£64


486 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
id_li¡
 = 
NULL
;

487 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
’Œy
 = 
NULL
;

489 
pkcs11h_û¹ifiÿ‹_id_t
 
û¹ifiÿ‹_id
 = 
NULL
;

491 
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
 = 
NULL
;

492 
CK_RV
 
rv
 = 
CKR_OK
;

493 *
û¹ifiÿ‹_blob
 = 
NULL
;

494 
size_t
 
û¹ifiÿ‹_blob_size
 = 0;

495 
size_t
 
max
;

496 *
š‹º®_id
 = 
NULL
;

497 *
š‹º®_ba£64
 = 
NULL
;

498 
couÁ
 = 0;

499 
boŞ
 
sucûss
 = 
çl£
;

501 
	`ASSERT
(
id
!=
NULL
);

502 
	`ASSERT
(
ba£64
!=
NULL
);

504 
	`dmsg
(

505 
D_PKCS11_DEBUG
,

507 
šdex


510 *
id
 = 
NULL
;

511 *
ba£64
 = 
NULL
;

514 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_’umC”tifiÿ‹Ids
(

515 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

516 
NULL
,

517 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

518 
NULL
,

519 &
id_li¡


520 )è!ğ
CKR_OK


523 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹†i¡ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

524 
ş—nup
;

527 
’Œy
 = 
id_li¡
;

528 
couÁ
 = 0;

529 
’Œy
 !ğ
NULL
 && 
couÁ
 !ğ
šdex
)

531 
couÁ
++;

532 
’Œy
 =ƒÁry->
Ãxt
;

535 ià(
’Œy
 =ğ
NULL
)

537 
	`dmsg
(

538 
D_PKCS11_DEBUG
,

540 
šdex


542 
ş—nup
;

546 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_£rŸlizeC”tifiÿ‹Id
(

547 
NULL
,

548 &
max
,

549 
’Œy
->
û¹ifiÿ‹_id


550 )è!ğ
CKR_OK


553 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ s”Ÿlizû¹ifiÿ‹ id %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

554 
ş—nup
;

557 ià((
š‹º®_id
 = (*)
	`m®loc
(
max
)è=ğ
NULL
)

559 
	`msg
(
M_FATAL
, "PKCS#11: Cannot‡llocate memory");

560 
ş—nup
;

564 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_£rŸlizeC”tifiÿ‹Id
(

565 
š‹º®_id
,

566 &
max
,

567 
’Œy
->
û¹ifiÿ‹_id


568 )è!ğ
CKR_OK


571 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ s”Ÿlizû¹ifiÿ‹ id %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

572 
ş—nup
;

576 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_ü—‹
(

577 
’Œy
->
û¹ifiÿ‹_id
,

578 
NULL
,

579 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

580 
PKCS11H_PIN_CACHE_INFINITE
,

581 &
û¹ifiÿ‹


582 )è!ğ
CKR_OK


585 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

586 
ş—nup
;

590 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_g‘C”tifiÿ‹Blob
(

591 
û¹ifiÿ‹
,

592 
NULL
,

593 &
û¹ifiÿ‹_blob_size


594 )è!ğ
CKR_OK


597 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹ blob %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

598 
ş—nup
;

601 ià((
û¹ifiÿ‹_blob
 = (*)
	`m®loc
(
û¹ifiÿ‹_blob_size
)è=ğ
NULL
)

603 
	`msg
(
M_FATAL
, "PKCS#11: Cannot‡llocate memory");

604 
ş—nup
;

608 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_g‘C”tifiÿ‹Blob
(

609 
û¹ifiÿ‹
,

610 
û¹ifiÿ‹_blob
,

611 &
û¹ifiÿ‹_blob_size


612 )è!ğ
CKR_OK


615 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹ blob %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

616 
ş—nup
;

619 ià(
	`İ’v²_ba£64_’code
(
û¹ifiÿ‹_blob
, 
û¹ifiÿ‹_blob_size
, &
š‹º®_ba£64
) == -1)

621 
	`msg
(
M_WARN
, "PKCS#11: Cannotƒncode certificate");

622 
ş—nup
;

625 *
id
 = 
š‹º®_id
;

626 
š‹º®_id
 = 
NULL
;

627 *
ba£64
 = 
š‹º®_ba£64
;

628 
š‹º®_ba£64
 = 
NULL
;

629 
sucûss
 = 
Œue
;

631 
ş—nup
:

633 ià(
id_li¡
 !ğ
NULL
)

635 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹IdLi¡
(
id_li¡
);

636 
id_li¡
 = 
NULL
;

639 ià(
š‹º®_id
 !ğ
NULL
)

641 
	`ä“
(
š‹º®_id
);

642 
š‹º®_id
 = 
NULL
;

645 ià(
š‹º®_ba£64
 !ğ
NULL
)

647 
	`ä“
(
š‹º®_ba£64
);

648 
š‹º®_ba£64
 = 
NULL
;

651 ià(
û¹ifiÿ‹_blob
 !ğ
NULL
)

653 
	`ä“
(
û¹ifiÿ‹_blob
);

654 
û¹ifiÿ‹_blob
 = 
NULL
;

657 
	`dmsg
(

658 
D_PKCS11_DEBUG
,

660 
sucûss
 ? 1 : 0,

661 *
id


664  
sucûss
;

665 
	}
}

668 
	$s_ùx_u£_pkcs11
(

669 
s_roÙ_ùx
 *cÚ¡ 
s¦_ùx
,

670 
boŞ
 
pkcs11_id_mªagem’t
,

671 cÚ¡ *cÚ¡ 
pkcs11_id


674 
pkcs11h_û¹ifiÿ‹_id_t
 
û¹ifiÿ‹_id
 = 
NULL
;

675 
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
 = 
NULL
;

676 
CK_RV
 
rv
 = 
CKR_OK
;

678 
boŞ
 
ok
 = 
çl£
;

680 
	`ASSERT
(
s¦_ùx
!=
NULL
);

681 
	`ASSERT
(
pkcs11_id_mªagem’t
 || 
pkcs11_id
!=
NULL
);

683 
	`dmsg
(

684 
D_PKCS11_DEBUG
,

686 (*)
s¦_ùx
,

687 
pkcs11_id_mªagem’t
 ? 1 : 0,

688 
pkcs11_id


691 ià(
pkcs11_id_mªagem’t
)

693 
u£r_·ss
 
id_»¥
;

695 
	`CLEAR
(
id_»¥
);

697 
id_»¥
.
defšed
 = 
çl£
;

698 
id_»¥
.
noÿche
 = 
Œue
;

699 
	`İ’v²_¢´štf
(

700 
id_»¥
.
u£ºame
,

701 (
id_»¥
.
u£ºame
),

706 !
	`g‘_u£r_·ss
(

707 &
id_»¥
,

708 
NULL
,

710 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_NEED_STR
|
GET_USER_PASS_NOFATAL


714 
ş—nup
;

718 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_de£rŸlizeC”tifiÿ‹Id
(

719 &
û¹ifiÿ‹_id
,

720 
id_»¥
.
·sswÜd


721 )è!ğ
CKR_OK


724 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ de£rŸlizid %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

725 
ş—nup
;

731 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_de£rŸlizeC”tifiÿ‹Id
(

732 &
û¹ifiÿ‹_id
,

733 
pkcs11_id


734 )è!ğ
CKR_OK


737 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ de£rŸlizid %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

738 
ş—nup
;

743 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_ü—‹
(

744 
û¹ifiÿ‹_id
,

745 
NULL
,

746 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

747 
PKCS11H_PIN_CACHE_INFINITE
,

748 &
û¹ifiÿ‹


749 )è!ğ
CKR_OK


752 
	`msg
(
M_WARN
, "PKCS#11: CªnÙ g‘ c”tifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

753 
ş—nup
;

757 (
	`pkcs11_š™_s_£ssiÚ
(

758 
û¹ifiÿ‹
,

759 
s¦_ùx


764 
û¹ifiÿ‹
 = 
NULL
;

765 
ş—nup
;

769 
û¹ifiÿ‹
 = 
NULL
;

770 
ok
 = 
Œue
;

772 
ş—nup
:

773 ià(
û¹ifiÿ‹
 !ğ
NULL
)

775 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹
(
û¹ifiÿ‹
);

776 
û¹ifiÿ‹
 = 
NULL
;

779 ià(
û¹ifiÿ‹_id
 !ğ
NULL
)

781 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹Id
(
û¹ifiÿ‹_id
);

782 
û¹ifiÿ‹_id
 = 
NULL
;

785 
	`dmsg
(

786 
D_PKCS11_DEBUG
,

788 
ok
 ? 1 : 0,

789 
rv


792  
ok
 ? 1 : 0;

793 
	}
}

796 
PKCS11H_BOOL


797 
	$_pkcs11_İ’v²_show_pkcs11_ids_pš_´om±
(

798 *cÚ¡ 
glob®_d©a
,

799 *cÚ¡ 
u£r_d©a
,

800 cÚ¡ 
pkcs11h_tok’_id_t
 
tok’
,

801 cÚ¡ 
»Œy
,

802 *cÚ¡ 
pš
,

803 cÚ¡ 
size_t
 
pš_max


806 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

807 
bufãr
 
·ss_´om±
 = 
	`®loc_buf_gc
(128, &
gc
);

809 ()
glob®_d©a
;

810 ()
u£r_d©a
;

811 ()
»Œy
;

813 
	`ASSERT
(
tok’
!=
NULL
);

815 
	`buf_´štf
(&
·ss_´om±
, "PËa£ƒÁ” '%s'ok’ PIN o¸'ÿnûl': ", 
tok’
->
di¥Ïy
);

816 ià(!
	`qu”y_u£r_SINGLE
(
	`BSTR
(&
·ss_´om±
), 
	`BLEN
(&pass_prompt),

817 
pš
, 
pš_max
, 
çl£
))

819 
	`msg
(
M_FATAL
, "Could‚ot„etrievehe PIN");

822 
	`gc_ä“
(&
gc
);

824 ià(!
	`¡rcmp
(
pš
, "cancel"))

826  
FALSE
;

830  
TRUE
;

832 
	}
}

835 
	$show_pkcs11_ids
(

836 cÚ¡ *cÚ¡ 
´ovid”
,

837 
boŞ
 
û¹_´iv©e


840 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

841 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
u£r_û¹ifiÿ‹s
 = 
NULL
;

842 
pkcs11h_û¹ifiÿ‹_id_li¡_t
 
cu¼’t
 = 
NULL
;

843 
CK_RV
 
rv
 = 
CKR_FUNCTION_FAILED
;

845 ià((
rv
 = 
	`pkcs11h_š™Ÿlize
()è!ğ
CKR_OK
)

847 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ in™Ÿliz%ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

848 
ş—nup
;

851 ià((
rv
 = 
	`pkcs11h_£tLogHook
(
_pkcs11_İ’v²_log
, 
NULL
)è!ğ
CKR_OK
)

853 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ hook %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

854 
ş—nup
;

857 
	`pkcs11h_£tLogLev–
(
	`_pkcs11_msg_İ’v²2pkcs11
(
	`g‘_debug_Ëv–
()));

859 ià((
rv
 = 
	`pkcs11h_£tPrÙeùedAuth’tiÿtiÚ
(
TRUE
)è!ğ
CKR_OK
)

861 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘…rÙeùed‡uth’tiÿtiÚ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

862 
ş—nup
;

865 ià((
rv
 = 
	`pkcs11h_£tPINProm±Hook
(
_pkcs11_İ’v²_show_pkcs11_ids_pš_´om±
, 
NULL
)è!ğ
CKR_OK
)

867 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s‘ PIN hook %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

868 
ş—nup
;

872 (
rv
 = 
	`pkcs11h_addProvid”
(

873 
´ovid”
,

874 
´ovid”
,

875 
TRUE
,

877 
FALSE
,

879 
û¹_´iv©e
 ? 
TRUE
 : 
FALSE


880 )è!ğ
CKR_OK


883 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ‡dd…rovid” '%s' %ld-'%s'", 
´ovid”
, 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

884 
ş—nup
;

888 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_’umC”tifiÿ‹Ids
(

889 
PKCS11H_ENUM_METHOD_CACHE_EXIST
,

890 
NULL
,

891 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

892 
NULL
,

893 &
u£r_û¹ifiÿ‹s


894 )è!ğ
CKR_OK


897 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙƒnum”©û¹ifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

898 
ş—nup
;

901 
	`msg
(

902 
M_INFO
|
M_NOPREFIX
|
M_NOLF
,

910 
cu¼’t
 = 
u£r_û¹ifiÿ‹s
; cu¼’ˆ!ğ
NULL
; cu¼’ˆğcu¼’t->
Ãxt
)

912 
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
 = 
NULL
;

913 *
dn
 = 
NULL
;

914 
£rŸl
[1024] = {0};

915 *
£r
 = 
NULL
;

916 
size_t
 
£r_Ën
 = 0;

919 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_£rŸlizeC”tifiÿ‹Id
(

920 
NULL
,

921 &
£r_Ën
,

922 
cu¼’t
->
û¹ifiÿ‹_id


923 )è!ğ
CKR_OK


926 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s”Ÿlizû¹ifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

927 
ş—nup1
;

931 
rv
 =ğ
CKR_OK


932 && (
£r
 = (*)
	`m®loc
(
£r_Ën
)è=ğ
NULL


935 
	`msg
(
M_FATAL
, "PKCS#11: Cannot‡llocate memory");

936 
ş—nup1
;

940 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_£rŸlizeC”tifiÿ‹Id
(

941 
£r
,

942 &
£r_Ën
,

943 
cu¼’t
->
û¹ifiÿ‹_id


944 )è!ğ
CKR_OK


947 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ s”Ÿlizû¹ifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

948 
ş—nup1
;

952 (
rv
 = 
	`pkcs11h_û¹ifiÿ‹_ü—‹
(

953 
cu¼’t
->
û¹ifiÿ‹_id
,

954 
NULL
,

955 
PKCS11H_PROMPT_MASK_ALLOW_ALL
,

956 
PKCS11H_PIN_CACHE_INFINITE
,

957 &
û¹ifiÿ‹


961 
	`msg
(
M_FATAL
, "PKCS#11: CªnÙ c»©û¹ifiÿ‹ %ld-'%s'", 
rv
, 
	`pkcs11h_g‘Mes§ge
(rv));

962 
ş—nup1
;

966 (
dn
 = 
	`pkcs11_û¹ifiÿ‹_dn
(

967 
û¹ifiÿ‹
,

968 &
gc


969 )è=ğ
NULL


972 
ş—nup1
;

976 (
	`pkcs11_û¹ifiÿ‹_£rŸl
(

977 
û¹ifiÿ‹
,

978 
£rŸl
,

979 (
£rŸl
)

983 
ş—nup1
;

986 
	`msg
(

987 
M_INFO
|
M_NOPREFIX
|
M_NOLF
,

995 
dn
,

996 
£rŸl
,

997 
£r


1000 
ş—nup1
:

1002 ià(
û¹ifiÿ‹
 !ğ
NULL
)

1004 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹
(
û¹ifiÿ‹
);

1005 
û¹ifiÿ‹
 = 
NULL
;

1008 ià(
£r
 !ğ
NULL
)

1010 
	`ä“
(
£r
);

1011 
£r
 = 
NULL
;

1015 
ş—nup
:

1016 ià(
u£r_û¹ifiÿ‹s
 !ğ
NULL
)

1018 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹IdLi¡
(
u£r_û¹ifiÿ‹s
);

1019 
u£r_û¹ifiÿ‹s
 = 
NULL
;

1022 
	`pkcs11h_‹rmš©e
();

1023 
	`gc_ä“
(&
gc
);

1024 
	}
}

1027 #ifdeà
_MSC_VER


1029 
	$dummy
()

1031 
	}
}

	@pkcs11.h

24 #iâdeà
OPENVPN_PKCS11_H


25 
	#OPENVPN_PKCS11_H


	)

27 #ià
defšed
(
ENABLE_PKCS11
)

29 
	~"s¦_commÚ.h
"

31 
boŞ


32 
pkcs11_š™Ÿlize
(

33 cÚ¡ 
boŞ
 
fPrÙeùedAuth’tiÿtiÚ
,

34 cÚ¡ 
nPINCacheP”iod


38 
pkcs11_‹rmš©e
();

40 
boŞ


41 
pkcs11_addProvid”
(

42 cÚ¡ *cÚ¡ 
´ovid”
,

43 cÚ¡ 
boŞ
 
fPrÙeùedAuth’tiÿtiÚ
,

44 cÚ¡ 
´iv©e_mode
,

45 cÚ¡ 
boŞ
 
fC”tIsPriv©e


49 
pkcs11_logout
();

52 
pkcs11_mªagem’t_id_couÁ
();

54 
boŞ


55 
pkcs11_mªagem’t_id_g‘
(

56 cÚ¡ 
šdex
,

57 **
id
,

58 **
ba£64


62 
s_ùx_u£_pkcs11
(

63 
s_roÙ_ùx
 *cÚ¡ 
s¦_ùx
,

64 
boŞ
 
pkcs11_id_mªagem’t
,

65 cÚ¡ *cÚ¡ 
pkcs11_id


69 
show_pkcs11_ids
(

70 cÚ¡ *cÚ¡ 
´ovid”
,

71 
boŞ
 
û¹_´iv©e


	@pkcs11_backend.h

29 #iâdeà
PKCS11_BACKEND_H_


30 
	#PKCS11_BACKEND_H_


	)

32 
	~"sysh—d.h
"

34 #ià
defšed
(
ENABLE_PKCS11
)

36 
	~"s¦_commÚ.h
"

38 
	~<pkcs11-h–³r-1.0/pkcs11h-û¹ifiÿ‹.h
>

48 *
pkcs11_û¹ifiÿ‹_dn
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
, 
gc_¬’a
 *
gc
);

59 
pkcs11_û¹ifiÿ‹_£rŸl
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
, *
£rŸl
,

60 
size_t
 
£rŸl_Ën
);

70 
pkcs11_š™_s_£ssiÚ
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
,

71 
s_roÙ_ùx
 *cÚ¡ 
s¦_ùx
);

	@pkcs11_mbedtls.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_PKCS11
è&& defšed(
ENABLE_CRYPTO_MBEDTLS
)

39 
	~"”¾ev–.h
"

40 
	~"pkcs11_back’d.h
"

41 
	~"s¦_v”ify_back’d.h
"

42 
	~<mbeds/pkcs11.h
>

43 
	~<mbeds/x509.h
>

46 
	$pkcs11_š™_s_£ssiÚ
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
,

47 
s_roÙ_ùx
 *cÚ¡ 
s¦_ùx
)

49 
»t
 = 1;

51 
	`ASSERT
(
NULL
 !ğ
s¦_ùx
);

53 
	`ALLOC_OBJ_CLEAR
(
s¦_ùx
->
üt_chaš
, 
mbeds_x509_üt
);

54 ià(
	`mbeds_pkcs11_x509_û¹_bšd
(
s¦_ùx
->
üt_chaš
, 
û¹ifiÿ‹
))

56 
	`msg
(
M_FATAL
, "PKCS#11: Cannot„etrieve mbed TLS certificate object");

57 
ş—nup
;

60 
	`ALLOC_OBJ_CLEAR
(
s¦_ùx
->
´iv_key_pkcs11
, 
mbeds_pkcs11_cÚ‹xt
);

61 ià(
	`mbeds_pkcs11_´iv_key_bšd
(
s¦_ùx
->
´iv_key_pkcs11
, 
û¹ifiÿ‹
))

63 
	`msg
(
M_FATAL
, "PKCS#11: Cannot initialize mbed TLS…rivate key object");

64 
ş—nup
;

67 
	`ALLOC_OBJ_CLEAR
(
s¦_ùx
->
´iv_key
, 
mbeds_pk_cÚ‹xt
);

68 ià(!
	`mbed_ok
(
	`mbeds_pk_£tup_r§_®t
(
s¦_ùx
->
´iv_key
,

69 
s¦_ùx
->
´iv_key_pkcs11
, 
mbeds_s¦_pkcs11_deüy±
,

70 
mbeds_s¦_pkcs11_sign
, 
mbeds_s¦_pkcs11_key_Ën
)))

72 
ş—nup
;

75 
»t
 = 0;

77 
ş—nup
:

78  
»t
;

79 
	}
}

82 
	$pkcs11_û¹ifiÿ‹_dn
(
pkcs11h_û¹ifiÿ‹_t
 
û¹
, 
gc_¬’a
 *
gc
)

84 *
»t
 = 
NULL
;

85 
mbeds_x509_üt
 
mbed_üt
 = {0};

87 ià(
	`mbeds_pkcs11_x509_û¹_bšd
(&
mbed_üt
, 
û¹
))

89 
	`msg
(
M_FATAL
, "PKCS#11: Cannot„etrieve mbed TLS certificate object");

90 
ş—nup
;

93 ià(!(
»t
 = 
	`x509_g‘_subjeù
(&
mbed_üt
, 
gc
)))

95 
	`msg
(
M_FATAL
, "PKCS#11: mbed TLS cannot…arse subject");

96 
ş—nup
;

99 
ş—nup
:

100 
	`mbeds_x509_üt_ä“
(&
mbed_üt
);

102  
»t
;

103 
	}
}

106 
	$pkcs11_û¹ifiÿ‹_£rŸl
(
pkcs11h_û¹ifiÿ‹_t
 
û¹
, *
£rŸl
,

107 
size_t
 
£rŸl_Ën
)

109 
»t
 = 1;

111 
mbeds_x509_üt
 
mbed_üt
 = {0};

113 ià(
	`mbeds_pkcs11_x509_û¹_bšd
(&
mbed_üt
, 
û¹
))

115 
	`msg
(
M_FATAL
, "PKCS#11: Cannot„etrieve mbed TLS certificate object");

116 
ş—nup
;

119 ià(-1 =ğ
	`mbeds_x509_£rŸl_g‘s
(
£rŸl
, 
£rŸl_Ën
, &
mbed_üt
.serial))

121 
	`msg
(
M_FATAL
, "PKCS#11: mbed TLS cannot…arse serial");

122 
ş—nup
;

125 
»t
 = 0;

127 
ş—nup
:

128 
	`mbeds_x509_üt_ä“
(&
mbed_üt
);

130  
»t
;

131 
	}
}

	@pkcs11_openssl.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_PKCS11
è&& defšed(
ENABLE_CRYPTO_OPENSSL
)

39 
	~"”¾ev–.h
"

40 
	~"pkcs11_back’d.h
"

41 
	~"s¦_v”ify.h
"

42 
	~<pkcs11-h–³r-1.0/pkcs11h-İ’s¦.h
>

45 
	$pkcs11_š™_s_£ssiÚ
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
,

46 
s_roÙ_ùx
 *cÚ¡ 
s¦_ùx
)

48 
»t
 = 1;

50 
X509
 *
x509
 = 
NULL
;

51 
EVP_PKEY
 *
evp
 = 
NULL
;

52 
pkcs11h_İ’s¦_£ssiÚ_t
 
İ’s¦_£ssiÚ
 = 
NULL
;

54 ià((
İ’s¦_£ssiÚ
 = 
	`pkcs11h_İ’s¦_ü—‹SessiÚ
(
û¹ifiÿ‹
)è=ğ
NULL
)

56 
	`msg
(
M_WARN
, "PKCS#11: Cannot initialize openssl session");

57 
ş—nup
;

63 
û¹ifiÿ‹
 = 
NULL
;

65 ià((
evp
 = 
	`pkcs11h_İ’s¦_£ssiÚ_g‘EVP
(
İ’s¦_£ssiÚ
)è=ğ
NULL
)

67 
	`msg
(
M_WARN
, "PKCS#11: Unable getƒvp object");

68 
ş—nup
;

71 ià((
x509
 = 
	`pkcs11h_İ’s¦_£ssiÚ_g‘X509
(
İ’s¦_£ssiÚ
)è=ğ
NULL
)

73 
	`msg
(
M_WARN
, "PKCS#11: Unable get certificate object");

74 
ş—nup
;

77 ià(!
	`SSL_CTX_u£_Priv©eKey
(
s¦_ùx
->
ùx
, 
evp
))

79 
	`msg
(
M_WARN
, "PKCS#11: Cannot set…rivate key for openssl");

80 
ş—nup
;

83 ià(!
	`SSL_CTX_u£_û¹ifiÿ‹
(
s¦_ùx
->
ùx
, 
x509
))

85 
	`msg
(
M_WARN
, "PKCS#11: Cannot set certificate for openssl");

86 
ş—nup
;

88 
»t
 = 0;

90 
ş—nup
:

95 ià(
û¹ifiÿ‹
 !ğ
NULL
)

97 
	`pkcs11h_û¹ifiÿ‹_ä“C”tifiÿ‹
(
û¹ifiÿ‹
);

98 
û¹ifiÿ‹
 = 
NULL
;

105 ià(
x509
 !ğ
NULL
)

107 
	`X509_ä“
(
x509
);

108 
x509
 = 
NULL
;

111 ià(
evp
 !ğ
NULL
)

113 
	`EVP_PKEY_ä“
(
evp
);

114 
evp
 = 
NULL
;

117 ià(
İ’s¦_£ssiÚ
 !ğ
NULL
)

119 
	`pkcs11h_İ’s¦_ä“SessiÚ
(
İ’s¦_£ssiÚ
);

120 
İ’s¦_£ssiÚ
 = 
NULL
;

122  
»t
;

123 
	}
}

126 
	$pkcs11_û¹ifiÿ‹_dn
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
, 
gc_¬’a
 *
gc
)

128 
X509
 *
x509
 = 
NULL
;

130 *
dn
 = 
NULL
;

132 ià((
x509
 = 
	`pkcs11h_İ’s¦_g‘X509
(
û¹ifiÿ‹
)è=ğ
NULL
)

134 
	`msg
(
M_FATAL
, "PKCS#11: Cannot get X509");

135 
ş—nup
;

138 
dn
 = 
	`x509_g‘_subjeù
(
x509
, 
gc
);

140 
ş—nup
:

141 ià(
x509
 !ğ
NULL
)

143 
	`X509_ä“
(
x509
);

144 
x509
 = 
NULL
;

147  
dn
;

148 
	}
}

151 
	$pkcs11_û¹ifiÿ‹_£rŸl
(
pkcs11h_û¹ifiÿ‹_t
 
û¹ifiÿ‹
, *
£rŸl
,

152 
size_t
 
£rŸl_Ën
)

154 
X509
 *
x509
 = 
NULL
;

155 
BIO
 *
bio
 = 
NULL
;

156 
»t
 = 1;

157 
n
;

159 ià((
x509
 = 
	`pkcs11h_İ’s¦_g‘X509
(
û¹ifiÿ‹
)è=ğ
NULL
)

161 
	`msg
(
M_FATAL
, "PKCS#11: Cannot get X509");

162 
ş—nup
;

165 ià((
bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
())è=ğ
NULL
)

167 
	`msg
(
M_FATAL
, "PKCS#11: Cannot create BIO");

168 
ş—nup
;

171 
	`i2a_ASN1_INTEGER
(
bio
, 
	`X509_g‘_£rŸlNumb”
(
x509
));

172 
n
 = 
	`BIO_»ad
(
bio
, 
£rŸl
, 
£rŸl_Ën
-1);

174 ià(
n
<0)

176 
£rŸl
[0] = '\x0';

180 
£rŸl
[
n
] = 0;

183 
»t
 = 0;

185 
ş—nup
:

187 ià(
x509
 !ğ
NULL
)

189 
	`X509_ä“
(
x509
);

190 
x509
 = 
NULL
;

192  
»t
;

193 
	}
}

	@platform.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"bufãr.h
"

33 
	~"”rÜ.h
"

34 
	~"wš32.h
"

36 
	~"memdbg.h
"

38 
	~"¶©fÜm.h
"

43 
	$¶©fÜm_chroÙ
(cÚ¡ *
·th
)

45 ià(
·th
)

47 #ifdeà
HAVE_CHROOT


48 cÚ¡ *
tİ
 = "/";

49 ià(
	`chroÙ
(
·th
))

51 
	`msg
(
M_ERR
, "chroÙØ'%s' faed", 
·th
);

53 ià(
	`¶©fÜm_chdœ
(
tİ
))

55 
	`msg
(
M_ERR
, "cdØ'%s' faed", 
tİ
);

57 
	`msg
(
M_INFO
, "chroÙØ'%s'‡nd cdØ'%s' sucûeded", 
·th
, 
tİ
);

59 
	`msg
(
M_FATAL
, "SÜry buˆI cª'ˆchroÙØ'%s' beÿu£hi İ”©šg sy¡em dÛ¢'ˆ­³¬ØsuµÜˆthchroÙ(èsy¡em c®l", 
·th
);

62 
	}
}

66 
boŞ


67 
	$¶©fÜm_u£r_g‘
(cÚ¡ *
u£ºame
, 
¶©fÜm_¡©e_u£r
 *
¡©e
)

69 
boŞ
 
»t
 = 
çl£
;

70 
	`CLEAR
(*
¡©e
);

71 ià(
u£ºame
)

73 #ià
	`defšed
(
HAVE_GETPWNAM
è&& defšed(
HAVE_SETUID
)

74 
¡©e
->
pw
 = 
	`g‘pwÇm
(
u£ºame
);

75 ià(!
¡©e
->
pw
)

77 
	`msg
(
M_ERR
, "çedØfšd UID fÜ u£¸%s", 
u£ºame
);

79 
¡©e
->
u£ºame
 = username;

80 
»t
 = 
Œue
;

82 
	`msg
(
M_FATAL
, "ÿÂÙ g‘ UID fÜ u£¸% --…ÏtfÜm†ack g‘pwÇme(èÜ s‘uid(èsy¡em c®ls", 
u£ºame
);

85  
»t
;

86 
	}
}

89 
	$¶©fÜm_u£r_£t
(cÚ¡ 
¶©fÜm_¡©e_u£r
 *
¡©e
)

91 #ià
	`defšed
(
HAVE_GETPWNAM
è&& defšed(
HAVE_SETUID
)

92 ià(
¡©e
->
u£ºame
 && s‹->
pw
)

94 ià(
	`£tuid
(
¡©e
->
pw
->
pw_uid
))

96 
	`msg
(
M_ERR
, "£tuid('%s'èçed", 
¡©e
->
u£ºame
);

98 
	`msg
(
M_INFO
, "UID s‘Ø%s", 
¡©e
->
u£ºame
);

101 
	}
}

105 
boŞ


106 
	$¶©fÜm_group_g‘
(cÚ¡ *
grou²ame
, 
¶©fÜm_¡©e_group
 *
¡©e
)

108 
boŞ
 
»t
 = 
çl£
;

109 
	`CLEAR
(*
¡©e
);

110 ià(
grou²ame
)

112 #ià
	`defšed
(
HAVE_GETGRNAM
è&& defšed(
HAVE_SETGID
)

113 
¡©e
->
gr
 = 
	`g‘gºam
(
grou²ame
);

114 ià(!
¡©e
->
gr
)

116 
	`msg
(
M_ERR
, "çedØfšd GID fÜ grou°%s", 
grou²ame
);

118 
¡©e
->
grou²ame
 = groupname;

119 
»t
 = 
Œue
;

121 
	`msg
(
M_FATAL
, "ÿÂÙ g‘ GID fÜ grou°% --…ÏtfÜm†ack g‘gºam(èÜ s‘gid(èsy¡em c®ls", 
grou²ame
);

124  
»t
;

125 
	}
}

128 
	$¶©fÜm_group_£t
(cÚ¡ 
¶©fÜm_¡©e_group
 *
¡©e
)

130 #ià
	`defšed
(
HAVE_GETGRNAM
è&& defšed(
HAVE_SETGID
)

131 ià(
¡©e
->
grou²ame
 && s‹->
gr
)

133 ià(
	`£tgid
(
¡©e
->
gr
->
gr_gid
))

135 
	`msg
(
M_ERR
, "£tgid('%s'èçed", 
¡©e
->
grou²ame
);

137 
	`msg
(
M_INFO
, "GID s‘Ø%s", 
¡©e
->
grou²ame
);

138 #ifdeà
HAVE_SETGROUPS


140 
gid_t
 
gr_li¡
[1];

141 
gr_li¡
[0] = 
¡©e
->
gr
->
gr_gid
;

142 ià(
	`£tgroups
(1, 
gr_li¡
))

144 
	`msg
(
M_ERR
, "£tgroups('%s'èçed", 
¡©e
->
grou²ame
);

150 
	}
}

154 
	$¶©fÜm_niû
(
niûv®
)

156 ià(
niûv®
)

158 #ifdeà
HAVE_NICE


159 
”ºo
 = 0;

160 ià(
	`niû
(
niûv®
è< 0 && 
”ºo
 != 0)

162 
	`msg
(
M_WARN
 | 
M_ERRNO
, "WARNING:‚iû %d faed", 
niûv®
);

166 
	`msg
(
M_INFO
, "niû %d sucûeded", 
niûv®
);

169 
	`msg
(
M_WARN
, "WARNING:‚iû %d faed (funùiÚ‚Ù im¶em’‹d)", 
niûv®
);

172 
	}
}

176 
	$¶©fÜm_g‘pid
()

178 #ifdeà
_WIN32


179  (è
	`G‘Cu¼’tProûssId
();

181 #ifdeà
HAVE_GETPID


182  (è
	`g‘pid
();

187 
	}
}

191 
	$¶©fÜm_mlock®l
(
boŞ
 
´št_msg
)

193 #ifdeà
HAVE_MLOCKALL


194 ià(
	`mlock®l
(
MCL_CURRENT
 | 
MCL_FUTURE
))

196 
	`msg
(
M_WARN
 | 
M_ERRNO
, "WARNING: mlockall call failed");

198 ià(
´št_msg
)

200 
	`msg
(
M_INFO
, "mlockall call succeeded");

203 
	`msg
(
M_WARN
, "WARNING: mlockall call failed (function‚ot implemented)");

205 
	}
}

211 
	$¶©fÜm_chdœ
(cÚ¡ *
dœ
)

213 #ifdeà
HAVE_CHDIR


214 #ifdeà
_WIN32


215 
»s
;

216 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

217 
»s
 = 
	`_wchdœ
(
	`wide_¡ršg
(
dœ
, &
gc
));

218 
	`gc_ä“
(&
gc
);

219  
»s
;

221  
	`chdœ
(
dœ
);

226 
	}
}

231 
boŞ


232 
	$¶©fÜm_sy¡em_ok
(
¡©
)

234 #ifdeà
_WIN32


235  
¡©
 == 0;

237  
¡©
 !ğ-1 && 
	`WIFEXITED
(¡©è&& 
	`WEXITSTATUS
(stat) == 0;

239 
	}
}

242 
	$¶©fÜm_acûss
(cÚ¡ *
·th
, 
mode
)

244 #ifdeà
_WIN32


245 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

246 
»t
 = 
	`_wacûss
(
	`wide_¡ršg
(
·th
, &
gc
), 
mode
 & ~
X_OK
);

247 
	`gc_ä“
(&
gc
);

248  
»t
;

250  
	`acûss
(
·th
, 
mode
);

252 
	}
}

258 
	$¶©fÜm_¦“p_mli£cÚds
(
n
)

260 #ifdeà
_WIN32


261 
	`SË•
(
n
);

263 
timev®
 
tv
;

264 
tv
.
tv_£c
 = 
n
 / 1000;

265 
tv
.
tv_u£c
 = (
n
 % 1000) * 1000;

266 
	`£Ëù
(0, 
NULL
, NULL, NULL, &
tv
);

268 
	}
}

274 
	$¶©fÜm_¦“p_uÁ_sigÇl
()

276 #ifdeà
_WIN32


277 
	`ASSERT
(0);

279 
	`£Ëù
(0, 
NULL
, NULL, NULL, NULL);

281 
	}
}

284 
boŞ


285 
	$¶©fÜm_uÆšk
(cÚ¡ *
f’ame
)

287 #ià
	`defšed
(
_WIN32
)

288 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

289 
BOOL
 
»t
 = 
	`D–‘eFeW
(
	`wide_¡ršg
(
f’ame
, &
gc
));

290 
	`gc_ä“
(&
gc
);

291  (
»t
 != 0);

292 #–ià
	`defšed
(
HAVE_UNLINK
)

293  (
	`uÆšk
(
f’ame
) == 0);

295  
çl£
;

297 
	}
}

299 
FILE
 *

300 
	$¶©fÜm_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
)

302 #ifdeà
_WIN32


303 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

304 
FILE
 *
f
 = 
	`_wfİ’
(
	`wide_¡ršg
(
·th
, &
gc
), wide_¡ršg(
mode
, &gc));

305 
	`gc_ä“
(&
gc
);

306  
f
;

308  
	`fİ’
(
·th
, 
mode
);

310 
	}
}

313 
	$¶©fÜm_İ’
(cÚ¡ *
·th
, 
æags
, 
mode
)

315 #ifdeà
_WIN32


316 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

317 
fd
 = 
	`_wİ’
(
	`wide_¡ršg
(
·th
, &
gc
), 
æags
, 
mode
);

318 
	`gc_ä“
(&
gc
);

319  
fd
;

321  
	`İ’
(
·th
, 
æags
, 
mode
);

323 
	}
}

326 
	$¶©fÜm_¡©
(cÚ¡ *
·th
, 
¶©fÜm_¡©_t
 *
buf
)

328 #ifdeà
_WIN32


329 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

330 
»s
 = 
	`_w¡©
(
	`wide_¡ršg
(
·th
, &
gc
), 
buf
);

331 
	`gc_ä“
(&
gc
);

332  
»s
;

334  
	`¡©
(
·th
, 
buf
);

336 
	}
}

	@platform.h

24 #iâdeà
PLATFORM_H


25 
	#PLATFORM_H


	)

27 #ifdeà
HAVE_SYS_TYPES_H


28 
	~<sys/ty³s.h
>

31 #ifdeà
HAVE_SYS_STAT_H


32 
	~<sys/¡©.h
>

35 #ifdeà
HAVE_UNISTD_H


36 
	~<uni¡d.h
>

39 #ifdeà
HAVE_PWD_H


40 
	~<pwd.h
>

43 #ifdeà
HAVE_GRP_H


44 
	~<g½.h
>

47 #ifdeà
HAVE_STDIO_H


48 
	~<¡dio.h
>

51 
	~"basic.h
"

55 
	s¶©fÜm_¡©e_u£r
 {

56 #ià
defšed
(
HAVE_GETPWNAM
è&& defšed(
HAVE_SETUID
)

57 cÚ¡ *
	mu£ºame
;

58 
·sswd
 *
	mpw
;

60 
	mdummy
;

66 
	s¶©fÜm_¡©e_group
 {

67 #ià
defšed
(
HAVE_GETGRNAM
è&& defšed(
HAVE_SETGID
)

68 cÚ¡ *
	mgrou²ame
;

69 
group
 *
	mgr
;

71 
	mdummy
;

75 
boŞ
 
¶©fÜm_u£r_g‘
(cÚ¡ *
u£ºame
, 
¶©fÜm_¡©e_u£r
 *
¡©e
);

77 
¶©fÜm_u£r_£t
(cÚ¡ 
¶©fÜm_¡©e_u£r
 *
¡©e
);

79 
boŞ
 
¶©fÜm_group_g‘
(cÚ¡ *
grou²ame
, 
¶©fÜm_¡©e_group
 *
¡©e
);

81 
¶©fÜm_group_£t
(cÚ¡ 
¶©fÜm_¡©e_group
 *
¡©e
);

87 
šlše
 

88 
	$¶©fÜm_¡©e_u£r_uid
(cÚ¡ 
¶©fÜm_¡©e_u£r
 *
s
)

90 #ià
	`defšed
(
HAVE_GETPWNAM
è&& defšed(
HAVE_SETUID
)

91 ià(
s
->
pw
)

93  
s
->
pw
->
pw_uid
;

97 
	}
}

99 
šlše
 

100 
	$¶©fÜm_¡©e_group_gid
(cÚ¡ 
¶©fÜm_¡©e_group
 *
s
)

102 #ià
	`defšed
(
HAVE_GETGRNAM
è&& defšed(
HAVE_SETGID
)

103 ià(
s
->
gr
)

105  
s
->
gr
->
gr_gid
;

109 
	}
}

111 
¶©fÜm_chroÙ
(cÚ¡ *
·th
);

113 
¶©fÜm_niû
(
niûv®
);

115 
¶©fÜm_g‘pid
();

117 
¶©fÜm_mlock®l
(
boŞ
 
´št_msg
);

119 
¶©fÜm_chdœ
(cÚ¡ *
dœ
);

122 
boŞ
 
¶©fÜm_sy¡em_ok
(
¡©
);

124 
¶©fÜm_acûss
(cÚ¡ *
·th
, 
mode
);

126 
¶©fÜm_¦“p_mli£cÚds
(
n
);

128 
¶©fÜm_¦“p_uÁ_sigÇl
();

131 
boŞ
 
¶©fÜm_uÆšk
(cÚ¡ *
f’ame
);

133 
¶©fÜm_pu‹nv
(*
¡ršg
);

135 
FILE
 *
¶©fÜm_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
);

137 
¶©fÜm_İ’
(cÚ¡ *
·th
, 
æags
, 
mode
);

139 #ifdeà
_WIN32


140 
_¡©
 
	t¶©fÜm_¡©_t
;

142 
¡©
 
	t¶©fÜm_¡©_t
;

144 
¶©fÜm_¡©
(cÚ¡ *
·th
, 
¶©fÜm_¡©_t
 *
buf
);

	@plugin.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

29 #ifdeà
HAVE_CONFIG_VERSION_H


30 
	~"cÚfig-v”siÚ.h
"

33 
	~"sysh—d.h
"

35 #ifdeà
ENABLE_PLUGIN


37 #ifdeà
HAVE_DLFCN_H


38 
	~<dlfú.h
>

41 
	~"bufãr.h
"

42 
	~"”rÜ.h
"

43 
	~"misc.h
"

44 
	~"¶ugš.h
"

45 
	~"s¦_back’d.h
"

46 
	~"ba£64.h
"

47 
	~"wš32.h
"

48 
	~"memdbg.h
"

50 
	#PLUGIN_SYMBOL_REQUIRED
 (1<<0)

	)

53 
¶ugš_commÚ
 *
	g¡©ic_¶ugš_commÚ
 = 
NULL
;

56 
	$¶ugš_show_¡ršg_¬¿y
(
msgËv–
, cÚ¡ *
Çme
, cÚ¡ *
¬¿y
[])

58 
i
;

59 
i
 = 0; 
¬¿y
[i]; ++i)

61 ià(
	`’v_§ã_to_´št
(
¬¿y
[
i
]))

63 
	`msg
(
msgËv–
, "%s[%d] = '%s'", 
Çme
, 
i
, 
¬¿y
[i]);

66 
	}
}

69 
	$¶ugš_show_¬gs_’v
(
msgËv–
, cÚ¡ *
¬gv
[], cÚ¡ *
’vp
[])

71 ià(
	`check_debug_Ëv–
(
msgËv–
))

73 
	`¶ugš_show_¡ršg_¬¿y
(
msgËv–
, "ARGV", 
¬gv
);

74 
	`¶ugš_show_¡ršg_¬¿y
(
msgËv–
, "ENVP", 
’vp
);

76 
	}
}

79 
	$¶ugš_ty³_Çme
(cÚ¡ 
ty³
)

81 
ty³
)

83 
OPENVPN_PLUGIN_UP
:

86 
OPENVPN_PLUGIN_DOWN
:

89 
OPENVPN_PLUGIN_ROUTE_UP
:

92 
OPENVPN_PLUGIN_IPCHANGE
:

95 
OPENVPN_PLUGIN_TLS_VERIFY
:

98 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
:

101 
OPENVPN_PLUGIN_CLIENT_CONNECT
:

104 
OPENVPN_PLUGIN_CLIENT_CONNECT_V2
:

107 
OPENVPN_PLUGIN_CLIENT_DISCONNECT
:

110 
OPENVPN_PLUGIN_LEARN_ADDRESS
:

113 
OPENVPN_PLUGIN_TLS_FINAL
:

116 
OPENVPN_PLUGIN_ENABLE_PF
:

119 
OPENVPN_PLUGIN_ROUTE_PREDOWN
:

125 
	}
}

128 
	$¶ugš_mask_¡ršg
(cÚ¡ 
ty³_mask
, 
gc_¬’a
 *
gc
)

130 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

131 
boŞ
 
fœ¡
 = 
Œue
;

132 
i
;

134 
i
 = 0; i < 
OPENVPN_PLUGIN_N
; ++i)

136 ià(
	`OPENVPN_PLUGIN_MASK
(
i
è& 
ty³_mask
)

138 ià(!
fœ¡
)

140 
	`buf_´štf
(&
out
, "|");

142 
	`buf_´štf
(&
out
, "%s", 
	`¶ugš_ty³_Çme
(
i
));

143 
fœ¡
 = 
çl£
;

146  
	`BSTR
(&
out
);

147 
	}
}

149 
šlše
 

150 
	$¶ugš_suµÜ‹d_ty³s
()

152  ((1<<
OPENVPN_PLUGIN_N
)-1);

153 
	}
}

155 
¶ugš_İtiÚ_li¡
 *

156 
	$¶ugš_İtiÚ_li¡_Ãw
(
gc_¬’a
 *
gc
)

158 
¶ugš_İtiÚ_li¡
 *
»t
;

159 
	`ALLOC_OBJ_CLEAR_GC
(
»t
, 
¶ugš_İtiÚ_li¡
, 
gc
);

160  
»t
;

161 
	}
}

163 
boŞ


164 
	$¶ugš_İtiÚ_li¡_add
(
¶ugš_İtiÚ_li¡
 *
li¡
, **
p
, 
gc_¬’a
 *
gc
)

166 ià(
li¡
->
n
 < 
MAX_PLUGINS
)

168 
¶ugš_İtiÚ
 *
o
 = &
li¡
->
¶ugšs
[li¡->
n
++];

169 
o
->
¬gv
 = 
	`make_ex‹nded_¬g_¬¿y
(
p
, 
gc
);

170 ià(
o
->
¬gv
[0])

172 
o
->
so_·thÇme
 = o->
¬gv
[0];

174  
Œue
;

178  
çl£
;

180 
	}
}

182 #iâdeà
ENABLE_SMALL


184 
	$¶ugš_İtiÚ_li¡_´št
(cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
, 
msgËv–
)

186 
i
;

187 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

189 
i
 = 0; i < 
li¡
->
n
; ++i)

191 cÚ¡ 
¶ugš_İtiÚ
 *
o
 = &
li¡
->
¶ugšs
[
i
];

192 
	`msg
(
msgËv–
, "…lugš[%d] % '%s'", 
i
, 
o
->
so_·thÇme
, 
	`´št_¬gv
(o->
¬gv
, &
gc
, 
PA_BRACKET
));

195 
	`gc_ä“
(&
gc
);

196 
	}
}

199 #iâdeà
_WIN32


202 
	$libdl_»sŞve_symbŞ
(*
hªdË
, **
de¡
, cÚ¡ *
symbŞ
, cÚ¡ *
¶ugš_Çme
, cÚ¡ 
æags
)

204 *
de¡
 = 
	`dlsym
(
hªdË
, 
symbŞ
);

205 ià((
æags
 & 
PLUGIN_SYMBOL_REQUIRED
è&& !*
de¡
)

207 
	`msg
(
M_FATAL
, "PLUGIN: could‚Ù fšd„equœed symbŞ '%s' iÀ¶ugš sh¬ed objeù %s: %s", 
symbŞ
, 
¶ugš_Çme
, 
	`dË¼Ü
());

209 
	}
}

214 
	$dÎ_»sŞve_symbŞ
(
HMODULE
 
moduË
, **
de¡
, cÚ¡ *
symbŞ
, cÚ¡ *
¶ugš_Çme
, cÚ¡ 
æags
)

216 *
de¡
 = 
	`G‘ProcAdd»ss
(
moduË
, 
symbŞ
);

217 ià((
æags
 & 
PLUGIN_SYMBOL_REQUIRED
è&& !*
de¡
)

219 
	`msg
(
M_FATAL
, "PLUGIN: could‚Ù fšd„equœed symbŞ '%s' iÀ¶ugš DLL %s", 
symbŞ
, 
¶ugš_Çme
);

221 
	}
}

226 
	$¶ugš_š™_™em
(
¶ugš
 *
p
, cÚ¡ 
¶ugš_İtiÚ
 *
o
)

228 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

229 
boŞ
 
»l
 = 
çl£
;

231 
p
->
so_·thÇme
 = 
o
->so_pathname;

232 
p
->
¶ugš_ty³_mask
 = 
	`¶ugš_suµÜ‹d_ty³s
();

234 #iâdeà
_WIN32


236 
p
->
hªdË
 = 
NULL
;

253 ià(!
	`absŞu‹_·thÇme
(
p
->
so_·thÇme
)

254 && 
p
->
so_·thÇme
[0] != '.')

256 
fuÎ
[
PATH_MAX
];

258 
	`İ’v²_¢´štf
(
fuÎ
, (fuÎ), "%s/%s", 
PLUGIN_LIBDIR
, 
p
->
so_·thÇme
);

259 
p
->
hªdË
 = 
	`dlİ’
(
fuÎ
, 
RTLD_NOW
);

263 
»l
 = !
	`absŞu‹_·thÇme
(
p
->
so_·thÇme
);

264 
p
->
hªdË
 = 
	`dlİ’
Õ->
so_·thÇme
, 
RTLD_NOW
);

266 ià(!
p
->
hªdË
)

268 
	`msg
(
M_ERR
, "PLUGIN_INIT: could‚Ù†ßd…lugš sh¬ed objeù %s: %s", 
p
->
so_·thÇme
, 
	`dË¼Ü
());

271 
	#PLUGIN_SYM
(
v¬
, 
Çme
, 
æags
è
	`libdl_»sŞve_symbŞ
(
p
->
hªdË
, (*)&p->v¬,‚ame,…->
so_·thÇme
, fÏgs)

	)

275 
»l
 = !
	`absŞu‹_·thÇme
(
p
->
so_·thÇme
);

276 
p
->
moduË
 = 
	`LßdLib¿ryW
(
	`wide_¡ršg
Õ->
so_·thÇme
, &
gc
));

277 ià(!
p
->
moduË
)

279 
	`msg
(
M_ERR
, "PLUGIN_INIT: could‚Ù†ßd…lugš DLL: %s", 
p
->
so_·thÇme
);

282 
	#PLUGIN_SYM
(
v¬
, 
Çme
, 
æags
è
	`dÎ_»sŞve_symbŞ
(
p
->
moduË
, (*)&p->v¬,‚ame,…->
so_·thÇme
, fÏgs)

	)

286 
	`PLUGIN_SYM
(
İ’1
, "openvpn_plugin_open_v1", 0);

287 
	`PLUGIN_SYM
(
İ’2
, "openvpn_plugin_open_v2", 0);

288 
	`PLUGIN_SYM
(
İ’3
, "openvpn_plugin_open_v3", 0);

289 
	`PLUGIN_SYM
(
func1
, "openvpn_plugin_func_v1", 0);

290 
	`PLUGIN_SYM
(
func2
, "openvpn_plugin_func_v2", 0);

291 
	`PLUGIN_SYM
(
func3
, "openvpn_plugin_func_v3", 0);

292 
	`PLUGIN_SYM
(
şo£
, "İ’v²_¶ugš_şo£_v1", 
PLUGIN_SYMBOL_REQUIRED
);

293 
	`PLUGIN_SYM
(
abÜt
, "openvpn_plugin_abort_v1", 0);

294 
	`PLUGIN_SYM
(
ş›Á_cÚ¡ruùÜ
, "openvpn_plugin_client_constructor_v1", 0);

295 
	`PLUGIN_SYM
(
ş›Á_de¡ruùÜ
, "openvpn_plugin_client_destructor_v1", 0);

296 
	`PLUGIN_SYM
(
mš_v”siÚ_»quœed
, "openvpn_plugin_min_version_required_v1", 0);

297 
	`PLUGIN_SYM
(
š™Ÿliz©iÚ_pošt
, "openvpn_plugin_select_initialization_point_v1", 0);

299 ià(!
p
->
İ’1
 && !p->
İ’2
 && !p->
İ’3
)

301 
	`msg
(
M_FATAL
, "PLUGIN: symbŞ o³nv²_¶ugš_İ’_vX i undefšed iÀ¶ugš: %s", 
p
->
so_·thÇme
);

304 ià(!
p
->
func1
 && !p->
func2
 && !p->
func3
)

306 
	`msg
(
M_FATAL
, "PLUGIN: symbŞ o³nv²_¶ugš_func_vX i undefšed iÀ¶ugš: %s", 
p
->
so_·thÇme
);

312 ià(
p
->
mš_v”siÚ_»quœed
)

314 cÚ¡ 
¶ugš_Ãeds_v”siÚ
 = (*
p
->
mš_v”siÚ_»quœed
)();

315 ià(
¶ugš_Ãeds_v”siÚ
 > 
OPENVPN_PLUGIN_VERSION
)

317 
	`msg
(
M_FATAL
, "PLUGIN_INIT:…lugin‚eeds interface version %d, buthis version of OpenVPN only supports version %d: %s",

318 
¶ugš_Ãeds_v”siÚ
,

319 
OPENVPN_PLUGIN_VERSION
,

320 
p
->
so_·thÇme
);

324 ià(
p
->
š™Ÿliz©iÚ_pošt
)

326 
p
->
»que¡ed_š™Ÿliz©iÚ_pošt
 = (*p->
š™Ÿliz©iÚ_pošt
)();

330 
p
->
»que¡ed_š™Ÿliz©iÚ_pošt
 = 
OPENVPN_PLUGIN_INIT_PRE_DAEMON
;

333 ià(
»l
)

335 
	`msg
(
M_WARN
, "WARNING:…lugš '%s' s³cif›d by‡„–©iv·thÇm-- usšg‡ÀabsŞu‹…©hÇmwould bmÜ£cu»", 
p
->
so_·thÇme
);

338 
p
->
š™Ÿlized
 = 
Œue
;

340 
	`gc_ä“
(&
gc
);

341 
	}
}

344 
	$¶ugš_vlog
(
İ’v²_¶ugš_log_æags_t
 
æags
, cÚ¡ *
Çme
, cÚ¡ *
fÜm©
, 
va_li¡
 
¬gli¡
)

346 
msg_æags
 = 0;

348 ià(!
fÜm©
)

353 ià(!
Çme
 ||‚ame[0] == '\0')

355 
	`msg
(
D_PLUGIN_DEBUG
, "PLUGIN: suppressed†og message from…lugin with unknown‚ame");

359 ià(
æags
 & 
PLOG_ERR
)

361 
msg_æags
 = 
M_INFO
 | 
M_NONFATAL
;

363 ià(
æags
 & 
PLOG_WARN
)

365 
msg_æags
 = 
M_INFO
 | 
M_WARN
;

367 ià(
æags
 & 
PLOG_NOTE
)

369 
msg_æags
 = 
M_INFO
;

371 ià(
æags
 & 
PLOG_DEBUG
)

373 
msg_æags
 = 
D_PLUGIN_DEBUG
;

376 ià(
æags
 & 
PLOG_ERRNO
)

378 
msg_æags
 |ğ
M_ERRNO
;

380 ià(
æags
 & 
PLOG_NOMUTE
)

382 
msg_æags
 |ğ
M_NOMUTE
;

385 ià(
	`msg_‹¡
(
msg_æags
))

387 
gc_¬’a
 
gc
;

388 *
msg_fmt
;

391 
msg_æags
 |ğ
M_NOIPREFIX
;

393 
	`gc_š™
(&
gc
);

394 
msg_fmt
 = 
	`gc_m®loc
(
ERR_BUF_SIZE
, 
çl£
, &
gc
);

395 
	`İ’v²_¢´štf
(
msg_fmt
, 
ERR_BUF_SIZE
, "PLUGIN %s: %s", 
Çme
, 
fÜm©
);

396 
	`x_msg_va
(
msg_æags
, 
msg_fmt
, 
¬gli¡
);

398 
	`gc_ä“
(&
gc
);

400 
	}
}

403 
	$¶ugš_log
(
İ’v²_¶ugš_log_æags_t
 
æags
, cÚ¡ *
Çme
, cÚ¡ *
fÜm©
, ...)

405 
va_li¡
 
¬gli¡
;

406 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

407 
	`¶ugš_vlog
(
æags
, 
Çme
, 
fÜm©
, 
¬gli¡
);

408 
	`va_’d
(
¬gli¡
);

409 
	}
}

411 
İ’v²_¶ugš_ÿÎbacks
 
	gÿÎbacks
 = {

412 
¶ugš_log
,

413 
¶ugš_vlog
,

414 
£cu»_memz”o
,

415 
İ’v²_ba£64_’code
,

416 
İ’v²_ba£64_decode
,

424 #iâdeà
CONFIGURE_GIT_REVISION


425 
	#_OPENVPN_PATCH_LEVEL
 
OPENVPN_VERSION_PATCH


	)

427 
	#_OPENVPN_PATCH_LEVEL
 "g™:" 
CONFIGURE_GIT_REVISION
 
CONFIGURE_GIT_FLAGS


	)

431 
	$¶ugš_İ’_™em
(
¶ugš
 *
p
,

432 cÚ¡ 
¶ugš_İtiÚ
 *
o
,

433 
İ’v²_¶ugš_¡ršg_li¡
 **
»i¡
,

434 cÚ¡ **
’vp
,

435 cÚ¡ 
š™_pošt
)

437 
	`ASSERT
(
p
->
š™Ÿlized
);

440 ià(
»i¡
)

442 *
»i¡
 = 
NULL
;

445 ià(!
p
->
¶ugš_hªdË
 && 
š™_pošt
 =ğp->
»que¡ed_š™Ÿliz©iÚ_pošt
)

447 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

449 
	`dmsg
(
D_PLUGIN_DEBUG
, "PLUGIN_INIT: PRE");

450 
	`¶ugš_show_¬gs_’v
(
D_PLUGIN_DEBUG
, 
o
->
¬gv
, 
’vp
);

455 ià(
p
->
İ’3
)

457 
İ’v²_¶ugš_¬gs_İ’_š
 
¬gs
 = { 
p
->
¶ugš_ty³_mask
,

458 (cÚ¡ **cÚ¡è
o
->
¬gv
,

459 (cÚ¡ **cÚ¡è
’vp
,

460 &
ÿÎbacks
,

461 
SSLAPI
,

462 
PACKAGE_VERSION
,

463 
OPENVPN_VERSION_MAJOR
,

464 
OPENVPN_VERSION_MINOR
,

465 
_OPENVPN_PATCH_LEVEL
};

466 
İ’v²_¶ugš_¬gs_İ’_»tuº
 
»rgs
;

468 
	`CLEAR
(
»rgs
);

469 
»rgs
.
»tuº_li¡
 = 
»i¡
;

470 ià((*
p
->
İ’3
)(
OPENVPN_PLUGINv3_STRUCTVER
, &
¬gs
, &
»rgs
è=ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

472 
p
->
¶ugš_ty³_mask
 = 
»rgs
.
ty³_mask
;

473 
p
->
¶ugš_hªdË
 = 
»rgs
.
hªdË
;

477 
p
->
¶ugš_hªdË
 = 
NULL
;

480 ià(
p
->
İ’2
)

482 
p
->
¶ugš_hªdË
 = (*p->
İ’2
)(&p->
¶ugš_ty³_mask
, 
o
->
¬gv
, 
’vp
, 
»i¡
);

484 ià(
p
->
İ’1
)

486 
p
->
¶ugš_hªdË
 = (*p->
İ’1
)(&p->
¶ugš_ty³_mask
, 
o
->
¬gv
, 
’vp
);

490 
	`ASSERT
(0);

493 
	`msg
(
D_PLUGIN
, "PLUGIN_INIT: POST %s '%s' intercepted=%s %s",

494 
p
->
so_·thÇme
,

495 
	`´št_¬gv
(
o
->
¬gv
, &
gc
, 
PA_BRACKET
),

496 
	`¶ugš_mask_¡ršg
(
p
->
¶ugš_ty³_mask
, &
gc
),

497 (
»i¡
 && *retlist) ? "[RETLIST]" : "");

499 ià((
p
->
¶ugš_ty³_mask
 | 
	`¶ugš_suµÜ‹d_ty³s
()) !=…lugin_supported_types())

501 
	`msg
(
M_FATAL
, "PLUGIN_INIT:…lugin %sƒxpressed interest in unsupported…luginypes: [want=0x%08x, have=0x%08x]",

502 
p
->
so_·thÇme
,

503 
p
->
¶ugš_ty³_mask
,

504 
	`¶ugš_suµÜ‹d_ty³s
());

507 ià(
p
->
¶ugš_hªdË
 =ğ
NULL
)

509 
	`msg
(
M_FATAL
, "PLUGIN_INIT:…lugin initialization function failed: %s",

510 
p
->
so_·thÇme
);

513 
	`gc_ä“
(&
gc
);

515 
	}
}

518 
¶ugš_ÿÎ_™em
(cÚ¡ 
¶ugš
 *
p
,

519 *
³r_ş›Á_cÚ‹xt
,

520 cÚ¡ 
ty³
,

521 cÚ¡ 
¬gv
 *
av
,

522 
İ’v²_¶ugš_¡ršg_li¡
 **
»i¡
,

523 cÚ¡ **
’vp


524 #ifdeà
ENABLE_CRYPTO


525 , 
û¹d•th
,

526 
İ’v²_x509_û¹_t
 *
cu¼’t_û¹


530 
	g¡©us
 = 
OPENVPN_PLUGIN_FUNC_SUCCESS
;

533 ià(
	g»i¡
)

535 *
	g»i¡
 = 
NULL
;

538 ià(
	gp
->
	g¶ugš_hªdË
 && (p->
	g¶ugš_ty³_mask
 & 
OPENVPN_PLUGIN_MASK
(
ty³
)))

540 
gc_¬’a
 
	ggc
 = 
gc_Ãw
();

541 
¬gv
 
	ga
 = 
¬gv_š£¹_h—d
(
av
, 
p
->
so_·thÇme
);

543 
dmsg
(
D_PLUGIN_DEBUG
, "PLUGIN_CALL: PREy³=%s", 
¶ugš_ty³_Çme
(
ty³
));

544 
¶ugš_show_¬gs_’v
(
D_PLUGIN_DEBUG
, (cÚ¡ **)
a
.
¬gv
, 
’vp
);

549 ià(
	gp
->
	gfunc3
)

551 
İ’v²_¶ugš_¬gs_func_š
 
	g¬gs
 = { 
ty³
,

552 (cÚ¡ **cÚ¡è
a
.
¬gv
,

553 (cÚ¡ **cÚ¡è
’vp
,

554 
p
->
¶ugš_hªdË
,

555 
³r_ş›Á_cÚ‹xt
,

556 #ifdeà
ENABLE_CRYPTO


557 (
cu¼’t_û¹
 ? 
û¹d•th
 : -1),

558 
cu¼’t_û¹


561 
NULL


565 
İ’v²_¶ugš_¬gs_func_»tuº
 
	g»rgs
;

567 
CLEAR
(
»rgs
);

568 
	g»rgs
.
	g»tuº_li¡
 = 
»i¡
;

569 
	g¡©us
 = (*
p
->
func3
)(
OPENVPN_PLUGINv3_STRUCTVER
, &
	g¬gs
, &
	g»rgs
);

571 ià(
	gp
->
	gfunc2
)

573 
	g¡©us
 = (*
p
->
func2
)Õ->
¶ugš_hªdË
, 
	gty³
, (cÚ¡ **)
	ga
.
	g¬gv
, 
	g’vp
, 
	g³r_ş›Á_cÚ‹xt
, 
	g»i¡
);

575 ià(
	gp
->
	gfunc1
)

577 
	g¡©us
 = (*
p
->
func1
)Õ->
¶ugš_hªdË
, 
	gty³
, (cÚ¡ **)
	ga
.
	g¬gv
, 
	g’vp
);

581 
ASSERT
(0);

584 
msg
(
D_PLUGIN
, "PLUGIN_CALL: POST %s/%s status=%d",

585 
p
->
so_·thÇme
,

586 
¶ugš_ty³_Çme
(
ty³
),

587 
¡©us
);

589 ià(
	g¡©us
 =ğ
OPENVPN_PLUGIN_FUNC_ERROR
)

591 
msg
(
M_WARN
, "PLUGIN_CALL:…lugin function %s failed with status %d: %s",

592 
¶ugš_ty³_Çme
(
ty³
),

593 
¡©us
,

594 
p
->
so_·thÇme
);

597 
¬gv_»£t
(&
a
);

598 
gc_ä“
(&
gc
);

600  
	g¡©us
;

604 
	$¶ugš_şo£_™em
(
¶ugš
 *
p
)

606 ià(
p
->
š™Ÿlized
)

608 
	`msg
(
D_PLUGIN
, "PLUGIN_CLOSE: %s", 
p
->
so_·thÇme
);

613 ià(
p
->
¶ugš_hªdË
)

615 (*
p
->
şo£
)Õ->
¶ugš_hªdË
);

618 #iâdeà
_WIN32


619 ià(
	`dlşo£
(
p
->
hªdË
))

621 
	`msg
(
M_WARN
, "PLUGIN_CLOSE: dlşo£(èçed oÀ¶ugš: %s", 
p
->
so_·thÇme
);

623 #–ià
	`defšed
(
_WIN32
)

624 ià(!
	`F»eLib¿ry
(
p
->
moduË
))

626 
	`msg
(
M_WARN
, "PLUGIN_CLOSE: F»eLib¿ry(èçed oÀ¶ugš: %s", 
p
->
so_·thÇme
);

630 
p
->
š™Ÿlized
 = 
çl£
;

632 
	}
}

635 
	$¶ugš_abÜt_™em
(cÚ¡ 
¶ugš
 *
p
)

640 ià(
p
->
abÜt
)

642 (*
p
->
abÜt
)Õ->
¶ugš_hªdË
);

644 
	}
}

647 
	$¶ugš_³r_ş›Á_š™
(cÚ¡ 
¶ugš_commÚ
 *
pc
,

648 
¶ugš_³r_ş›Á
 *
şi
,

649 cÚ¡ 
š™_pošt
)

651 cÚ¡ 
n
 = 
pc
->n;

652 
i
;

654 
i
 = 0; i < 
n
; ++i)

656 cÚ¡ 
¶ugš
 *
p
 = &
pc
->
¶ugšs
[
i
];

657 ià(
p
->
¶ugš_hªdË


658 && (
š™_pošt
 < 0 || in™_pošˆ=ğ
p
->
»que¡ed_š™Ÿliz©iÚ_pošt
)

659 && 
p
->
ş›Á_cÚ¡ruùÜ
)

661 
şi
->
³r_ş›Á_cÚ‹xt
[
i
] = (*
p
->
ş›Á_cÚ¡ruùÜ
)Õ->
¶ugš_hªdË
);

664 
	}
}

667 
	$¶ugš_³r_ş›Á_de¡roy
(cÚ¡ 
¶ugš_commÚ
 *
pc
, 
¶ugš_³r_ş›Á
 *
şi
)

669 cÚ¡ 
n
 = 
pc
->n;

670 
i
;

672 
i
 = 0; i < 
n
; ++i)

674 cÚ¡ 
¶ugš
 *
p
 = &
pc
->
¶ugšs
[
i
];

675 *
cc
 = 
şi
->
³r_ş›Á_cÚ‹xt
[
i
];

677 ià(
p
->
ş›Á_de¡ruùÜ
 && 
cc
)

679 (*
p
->
ş›Á_de¡ruùÜ
)Õ->
¶ugš_hªdË
, 
cc
);

682 
	`CLEAR
(*
şi
);

683 
	}
}

685 
¶ugš_li¡
 *

686 
	$¶ugš_li¡_šh”™
(cÚ¡ 
¶ugš_li¡
 *
¤c
)

688 
¶ugš_li¡
 *
¶
;

689 
	`ALLOC_OBJ_CLEAR
(
¶
, 
¶ugš_li¡
);

690 
¶
->
commÚ
 = 
¤c
->common;

691 
	`ASSERT
(
¶
->
commÚ
);

692 
	`¶ugš_³r_ş›Á_š™
(
¶
->
commÚ
, &¶->
³r_ş›Á
, -1);

693  
¶
;

694 
	}
}

696 
¶ugš_commÚ
 *

697 
	$¶ugš_commÚ_š™
(cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
)

699 
i
;

700 
¶ugš_commÚ
 *
pc
;

702 
	`ALLOC_OBJ_CLEAR
(
pc
, 
¶ugš_commÚ
);

704 
i
 = 0; i < 
li¡
->
n
; ++i)

706 
	`¶ugš_š™_™em
(&
pc
->
¶ugšs
[
i
],

707 &
li¡
->
¶ugšs
[
i
]);

708 
pc
->
n
 = 
i
 + 1;

711 
¡©ic_¶ugš_commÚ
 = 
pc
;

712  
pc
;

713 
	}
}

716 
	$¶ugš_commÚ_İ’
(
¶ugš_commÚ
 *
pc
,

717 cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
,

718 
¶ugš_»tuº
 *
´
,

719 cÚ¡ 
’v_£t
 *
es
,

720 cÚ¡ 
š™_pošt
)

722 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

723 
i
;

724 cÚ¡ **
’vp
;

726 
’vp
 = 
	`make_’v_¬¿y
(
es
, 
çl£
, &
gc
);

728 ià(
´
)

730 
	`¶ugš_»tuº_š™
(
´
);

733 
i
 = 0; i < 
pc
->
n
; ++i)

735 
	`¶ugš_İ’_™em
(&
pc
->
¶ugšs
[
i
],

736 &
li¡
->
¶ugšs
[
i
],

737 
´
 ? &´->
li¡
[
i
] : 
NULL
,

738 
’vp
,

739 
š™_pošt
);

742 ià(
´
)

744 
´
->
n
 = 
i
;

747 
	`gc_ä“
(&
gc
);

748 
	}
}

751 
	$¶ugš_commÚ_şo£
(
¶ugš_commÚ
 *
pc
)

753 
¡©ic_¶ugš_commÚ
 = 
NULL
;

754 ià(
pc
)

756 
i
;

758 
i
 = 0; i < 
pc
->
n
; ++i)

760 
	`¶ugš_şo£_™em
(&
pc
->
¶ugšs
[
i
]);

762 
	`ä“
(
pc
);

764 
	}
}

766 
¶ugš_li¡
 *

767 
	$¶ugš_li¡_š™
(cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
)

769 
¶ugš_li¡
 *
¶
;

770 
	`ALLOC_OBJ_CLEAR
(
¶
, 
¶ugš_li¡
);

771 
¶
->
commÚ
 = 
	`¶ugš_commÚ_š™
(
li¡
);

772 
¶
->
commÚ_owÃd
 = 
Œue
;

773  
¶
;

774 
	}
}

777 
	$¶ugš_li¡_İ’
(
¶ugš_li¡
 *
¶
,

778 cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
,

779 
¶ugš_»tuº
 *
´
,

780 cÚ¡ 
’v_£t
 *
es
,

781 cÚ¡ 
š™_pošt
)

783 
	`¶ugš_commÚ_İ’
(
¶
->
commÚ
, 
li¡
, 
´
, 
es
, 
š™_pošt
);

784 
	`¶ugš_³r_ş›Á_š™
(
¶
->
commÚ
, &¶->
³r_ş›Á
, 
š™_pošt
);

785 
	}
}

788 
¶ugš_ÿÎ_s¦
(cÚ¡ 
¶ugš_li¡
 *
¶
,

789 cÚ¡ 
ty³
,

790 cÚ¡ 
¬gv
 *
av
,

791 
¶ugš_»tuº
 *
´
,

792 
’v_£t
 *
es


793 #ifdeà
ENABLE_CRYPTO


794 , 
û¹d•th
,

795 
İ’v²_x509_û¹_t
 *
cu¼’t_û¹


799 ià(
	g´
)

801 
¶ugš_»tuº_š™
(
´
);

804 ià(
¶ugš_defšed
(
¶
, 
ty³
))

806 
gc_¬’a
 
	ggc
 = 
gc_Ãw
();

807 
	gi
;

808 cÚ¡ **
	g’vp
;

809 cÚ¡ 
	gn
 = 
¶ugš_n
(
¶
);

810 
boŞ
 
	gsucûss
 = 
çl£
;

811 
boŞ
 
	g”rÜ
 = 
çl£
;

812 
boŞ
 
	gdeã¼ed
 = 
çl£
;

814 
£‹nv_d–
(
es
, "script_type");

815 
	g’vp
 = 
make_’v_¬¿y
(
es
, 
çl£
, &
gc
);

817 
	gi
 = 0; i < 
	gn
; ++i)

819 cÚ¡ 
	g¡©us
 = 
¶ugš_ÿÎ_™em
(&
¶
->
commÚ
->
¶ugšs
[
i
],

820 
¶
->
³r_ş›Á
.
³r_ş›Á_cÚ‹xt
[
i
],

821 
ty³
,

822 
av
,

823 
´
 ? &´->
li¡
[
i
] : 
NULL
,

824 
’vp


825 #ifdeà
ENABLE_CRYPTO


826 ,
û¹d•th
,

827 
cu¼’t_û¹


830 
	g¡©us
)

832 
	gOPENVPN_PLUGIN_FUNC_SUCCESS
:

833 
sucûss
 = 
Œue
;

836 
	gOPENVPN_PLUGIN_FUNC_DEFERRED
:

837 
deã¼ed
 = 
Œue
;

841 
”rÜ
 = 
Œue
;

846 ià(
	g´
)

848 
	g´
->
	gn
 = 
i
;

851 
gc_ä“
(&
gc
);

853 ià(
	gty³
 =ğ
OPENVPN_PLUGIN_ENABLE_PF
 && 
sucûss
)

855  
OPENVPN_PLUGIN_FUNC_SUCCESS
;

857 ià(
	g”rÜ
)

859  
	gOPENVPN_PLUGIN_FUNC_ERROR
;

861 ià(
	gdeã¼ed
)

863  
	gOPENVPN_PLUGIN_FUNC_DEFERRED
;

867  
	gOPENVPN_PLUGIN_FUNC_SUCCESS
;

871 
	$¶ugš_li¡_şo£
(
¶ugš_li¡
 *
¶
)

873 ià(
¶
)

875 ià(
¶
->
commÚ
)

877 
	`¶ugš_³r_ş›Á_de¡roy
(
¶
->
commÚ
, &¶->
³r_ş›Á
);

879 ià(
¶
->
commÚ_owÃd
)

881 
	`¶ugš_commÚ_şo£
(
¶
->
commÚ
);

885 
	`ä“
(
¶
);

887 
	}
}

890 
	$¶ugš_abÜt
()

892 
¶ugš_commÚ
 *
pc
 = 
¡©ic_¶ugš_commÚ
;

893 
¡©ic_¶ugš_commÚ
 = 
NULL
;

894 ià(
pc
)

896 
i
;

898 
i
 = 0; i < 
pc
->
n
; ++i)

900 
	`¶ugš_abÜt_™em
(&
pc
->
¶ugšs
[
i
]);

903 
	}
}

905 
boŞ


906 
	$¶ugš_defšed
(cÚ¡ 
¶ugš_li¡
 *
¶
, cÚ¡ 
ty³
)

908 
boŞ
 
»t
 = 
çl£
;

910 ià(
¶
)

912 cÚ¡ 
¶ugš_commÚ
 *
pc
 = 
¶
->
commÚ
;

914 ià(
pc
)

916 
i
;

917 cÚ¡ 
mask
 = 
	`OPENVPN_PLUGIN_MASK
(
ty³
);

918 
i
 = 0; i < 
pc
->
n
; ++i)

920 ià(
pc
->
¶ugšs
[
i
].
¶ugš_ty³_mask
 & 
mask
)

922 
»t
 = 
Œue
;

928  
»t
;

929 
	}
}

936 
	$İ’v²_¶ugš_¡ršg_li¡_™em_ä“
(
İ’v²_¶ugš_¡ršg_li¡
 *
l
)

938 ià(
l
)

940 
	`ä“
(
l
->
Çme
);

941 
	`¡ršg_ş—r
(
l
->
v®ue
);

942 
	`ä“
(
l
->
v®ue
);

943 
	`ä“
(
l
);

945 
	}
}

948 
	$İ’v²_¶ugš_¡ršg_li¡_ä“
(
İ’v²_¶ugš_¡ršg_li¡
 *
l
)

950 
İ’v²_¶ugš_¡ršg_li¡
 *
Ãxt
;

951 
l
)

953 
Ãxt
 = 
l
->next;

954 
	`İ’v²_¶ugš_¡ršg_li¡_™em_ä“
(
l
);

955 
l
 = 
Ãxt
;

957 
	}
}

959 
İ’v²_¶ugš_¡ršg_li¡
 *

960 
	$İ’v²_¶ugš_¡ršg_li¡_fšd
(
İ’v²_¶ugš_¡ršg_li¡
 *
l
, cÚ¡ *
Çme
)

962 
l
)

964 ià(!
	`¡rcmp
(
l
->
Çme
,‚ame))

966  
l
;

968 
l
 =†->
Ãxt
;

970  
NULL
;

971 
	}
}

974 
	$¶ugš_»tuº_g‘_cŞumn
(cÚ¡ 
¶ugš_»tuº
 *
¤c
,

975 
¶ugš_»tuº
 *
de¡
,

976 cÚ¡ *
cŞÇme
)

978 
i
;

980 
de¡
->
n
 = 0;

981 
i
 = 0; i < 
¤c
->
n
; ++i)

983 
de¡
->
li¡
[
i
] = 
	`İ’v²_¶ugš_¡ršg_li¡_fšd
(
¤c
->li¡[i], 
cŞÇme
);

985 
de¡
->
n
 = 
i
;

986 
	}
}

989 
	$¶ugš_»tuº_ä“
(
¶ugš_»tuº
 *
´
)

991 
i
;

992 
i
 = 0; i < 
´
->
n
; ++i)

994 
	`İ’v²_¶ugš_¡ršg_li¡_ä“
(
´
->
li¡
[
i
]);

996 
´
->
n
 = 0;

997 
	}
}

999 #ifdeà
ENABLE_DEBUG


1001 
	$¶ugš_»tuº_´št
(cÚ¡ 
msgËv–
, cÚ¡ *
´efix
, cÚ¡ 
¶ugš_»tuº
 *
´
)

1003 
i
;

1004 
	`msg
(
msgËv–
, "PLUGIN_RETURN_PRINT %s", 
´efix
);

1005 
i
 = 0; i < 
´
->
n
; ++i)

1007 
İ’v²_¶ugš_¡ršg_li¡
 *
l
 = 
´
->
li¡
[
i
];

1008 
couÁ
 = 0;

1010 
	`msg
(
msgËv–
, "PLUGIN #%d (%s)", 
i
, 
´efix
);

1011 
l
)

1013 
	`msg
(
msgËv–
, "[%d] '%s' -> '%s'\n",

1014 ++
couÁ
,

1015 
l
->
Çme
,

1016 
l
->
v®ue
);

1017 
l
 =†->
Ãxt
;

1020 
	}
}

1025 
	$dummy
()

1027 
	}
}

	@plugin.h

28 #iâdeà
OPENVPN_PLUGIN_H


29 
	#OPENVPN_PLUGIN_H


	)

31 #ifdeà
ENABLE_CRYPTO_OPENSSL


32 
	~"s¦_v”ify_İ’s¦.h
"

34 #ifdeà
ENABLE_CRYPTO_MBEDTLS


35 
	~"s¦_v”ify_mbeds.h
"

37 
	~"İ’v²-¶ugš.h
"

39 #ifdeà
ENABLE_PLUGIN


41 
	~"misc.h
"

43 
	#MAX_PLUGINS
 16

	)

45 
	s¶ugš_İtiÚ
 {

46 cÚ¡ *
	mso_·thÇme
;

47 cÚ¡ **
	m¬gv
;

50 
	s¶ugš_İtiÚ_li¡
 {

51 
	mn
;

52 
¶ugš_İtiÚ
 
	m¶ugšs
[
MAX_PLUGINS
];

55 
	s¶ugš
 {

56 
boŞ
 
	mš™Ÿlized
;

57 cÚ¡ *
	mso_·thÇme
;

58 
	m¶ugš_ty³_mask
;

59 
	m»que¡ed_š™Ÿliz©iÚ_pošt
;

61 #iâdeà
_WIN32


62 *
	mhªdË
;

64 
HMODULE
 
	mmoduË
;

67 
İ’v²_¶ugš_İ’_v1
 
	mİ’1
;

68 
İ’v²_¶ugš_İ’_v2
 
	mİ’2
;

69 
İ’v²_¶ugš_İ’_v3
 
	mİ’3
;

70 
İ’v²_¶ugš_func_v1
 
	mfunc1
;

71 
İ’v²_¶ugš_func_v2
 
	mfunc2
;

72 
İ’v²_¶ugš_func_v3
 
	mfunc3
;

73 
İ’v²_¶ugš_şo£_v1
 
	mşo£
;

74 
İ’v²_¶ugš_abÜt_v1
 
	mabÜt
;

75 
İ’v²_¶ugš_ş›Á_cÚ¡ruùÜ_v1
 
	mş›Á_cÚ¡ruùÜ
;

76 
İ’v²_¶ugš_ş›Á_de¡ruùÜ_v1
 
	mş›Á_de¡ruùÜ
;

77 
İ’v²_¶ugš_mš_v”siÚ_»quœed_v1
 
	mmš_v”siÚ_»quœed
;

78 
İ’v²_¶ugš_£Ëù_š™Ÿliz©iÚ_pošt_v1
 
	mš™Ÿliz©iÚ_pošt
;

80 
İ’v²_¶ugš_hªdË_t
 
	m¶ugš_hªdË
;

83 
	s¶ugš_³r_ş›Á


85 *
	m³r_ş›Á_cÚ‹xt
[
MAX_PLUGINS
];

88 
	s¶ugš_commÚ


90 
	mn
;

91 
¶ugš
 
	m¶ugšs
[
MAX_PLUGINS
];

94 
	s¶ugš_li¡


96 
¶ugš_³r_ş›Á
 
	m³r_ş›Á
;

97 
¶ugš_commÚ
 *
	mcommÚ
;

98 
boŞ
 
	mcommÚ_owÃd
;

101 
	s¶ugš_»tuº


103 
	mn
;

104 
İ’v²_¶ugš_¡ršg_li¡
 *
	mli¡
[
MAX_PLUGINS
];

107 
¶ugš_İtiÚ_li¡
 *
¶ugš_İtiÚ_li¡_Ãw
(
gc_¬’a
 *
gc
);

109 
boŞ
 
¶ugš_İtiÚ_li¡_add
(
¶ugš_İtiÚ_li¡
 *
li¡
, **
p
, 
gc_¬’a
 *
gc
);

111 #iâdeà
ENABLE_SMALL


112 
¶ugš_İtiÚ_li¡_´št
(cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
, 
msgËv–
);

116 
¶ugš_li¡
 *
¶ugš_li¡_š™
(cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
);

118 
¶ugš_li¡_İ’
(
¶ugš_li¡
 *
¶
,

119 cÚ¡ 
¶ugš_İtiÚ_li¡
 *
li¡
,

120 
¶ugš_»tuº
 *
´
,

121 cÚ¡ 
’v_£t
 *
es
,

122 cÚ¡ 
š™_pošt
);

124 
¶ugš_li¡
 *
¶ugš_li¡_šh”™
(cÚ¡ ¶ugš_li¡ *
¤c
);

126 
¶ugš_ÿÎ_s¦
(cÚ¡ 
¶ugš_li¡
 *
¶
,

127 cÚ¡ 
ty³
,

128 cÚ¡ 
¬gv
 *
av
,

129 
¶ugš_»tuº
 *
´
,

130 
’v_£t
 *
es


131 #ifdeà
ENABLE_CRYPTO


132 , 
cu¼’t_û¹_d•th
,

133 
İ’v²_x509_û¹_t
 *
cu¼’t_û¹


137 
¶ugš_li¡_şo£
(
¶ugš_li¡
 *
¶
);

139 
boŞ
 
¶ugš_defšed
(cÚ¡ 
¶ugš_li¡
 *
¶
, cÚ¡ 
ty³
);

141 
¶ugš_»tuº_g‘_cŞumn
(cÚ¡ 
¶ugš_»tuº
 *
¤c
,

142 
¶ugš_»tuº
 *
de¡
,

143 cÚ¡ *
cŞÇme
);

145 
¶ugš_»tuº_ä“
(
¶ugš_»tuº
 *
´
);

147 #ifdeà
ENABLE_DEBUG


148 
¶ugš_»tuº_´št
(cÚ¡ 
msgËv–
, cÚ¡ *
´efix
, cÚ¡ 
¶ugš_»tuº
 *
´
);

152 
šlše
 

153 
	$¶ugš_n
(cÚ¡ 
¶ugš_li¡
 *
¶
)

155 ià(
¶
 &&…l->
commÚ
)

157  
¶
->
commÚ
->
n
;

163 
	}
}

165 
šlše
 
boŞ


166 
	$¶ugš_»tuº_defšed
(cÚ¡ 
¶ugš_»tuº
 *
´
)

168  
´
->
n
 >= 0;

169 
	}
}

171 
šlše
 

172 
	$¶ugš_»tuº_š™
(
¶ugš_»tuº
 *
´
)

174 
´
->
n
 = 0;

175 
	}
}

178 
	s¶ugš_li¡
 { 
	mdummy
; };

179 
	s¶ugš_»tuº
 { 
	mdummy
; };

181 
šlše
 
boŞ


182 
	$¶ugš_defšed
(cÚ¡ 
¶ugš_li¡
 *
¶
, cÚ¡ 
ty³
)

184  
çl£
;

185 
	}
}

187 
šlše
 

188 
¶ugš_ÿÎ_s¦
(cÚ¡ 
¶ugš_li¡
 *
¶
,

189 cÚ¡ 
ty³
,

190 cÚ¡ 
¬gv
 *
av
,

191 
¶ugš_»tuº
 *
´
,

192 
’v_£t
 *
es


193 #ifdeà
ENABLE_CRYPTO


194 , 
cu¼’t_û¹_d•th
,

195 
İ’v²_x509_û¹_t
 *
cu¼’t_û¹


204 
šlše
 

205 
	$¶ugš_ÿÎ
(cÚ¡ 
¶ugš_li¡
 *
¶
,

206 cÚ¡ 
ty³
,

207 cÚ¡ 
¬gv
 *
av
,

208 
¶ugš_»tuº
 *
´
,

209 
’v_£t
 *
es
)

211  
	`¶ugš_ÿÎ_s¦
(
¶
, 
ty³
, 
av
, 
´
, 
es


212 #ifdeà
ENABLE_CRYPTO


213 , -1, 
NULL


216 
	}
}

	@pool.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"poŞ.h
"

33 
	~"bufãr.h
"

34 
	~"”rÜ.h
"

35 
	~"sock‘.h
"

36 
	~"Ùime.h
"

38 
	~"memdbg.h
"

40 #ià
P2MP


43 
	$ifcÚfig_poŞ_’Œy_ä“
(
ifcÚfig_poŞ_’Œy
 *
e
, 
boŞ
 
h¬d
)

45 
e
->
š_u£
 = 
çl£
;

46 ià(
h¬d
 && 
e
->
commÚ_Çme
)

48 
	`ä“
(
e
->
commÚ_Çme
);

49 
e
->
commÚ_Çme
 = 
NULL
;

51 ià(
h¬d
)

53 
e
->
Ï¡_»Ëa£
 = 0;

57 
e
->
Ï¡_»Ëa£
 = 
now
;

59 
	}
}

62 
	$ifcÚfig_poŞ_fšd
(
ifcÚfig_poŞ
 *
poŞ
, cÚ¡ *
commÚ_Çme
)

64 
i
;

65 
time_t
 
—¾›¡_»Ëa£
 = 0;

66 
´evious_u§ge
 = -1;

67 
Ãw_u§ge
 = -1;

69 
i
 = 0; i < 
poŞ
->
size
; ++i)

71 
ifcÚfig_poŞ_’Œy
 *
e
 = &
poŞ
->
li¡
[
i
];

72 ià(!
e
->
š_u£
)

77 ià(
poŞ
->
du¶iÿ‹_ú
)

79 
Ãw_u§ge
 = 
i
;

87 ià((
Ãw_u§ge
 =ğ-1 || 
e
->
Ï¡_»Ëa£
 < 
—¾›¡_»Ëa£
è&& !e->
fixed
)

89 
—¾›¡_»Ëa£
 = 
e
->
Ï¡_»Ëa£
;

90 
Ãw_u§ge
 = 
i
;

97 ià(
´evious_u§ge
 < 0

98 && 
commÚ_Çme


99 && 
e
->
commÚ_Çme


100 && !
	`¡rcmp
(
commÚ_Çme
, 
e
->common_name))

102 
´evious_u§ge
 = 
i
;

108 ià(
´evious_u§ge
 >= 0)

110  
´evious_u§ge
;

113 ià(
Ãw_u§ge
 >= 0)

115  
Ãw_u§ge
;

119 
	}
}

124 
boŞ


125 
	$ifcÚfig_poŞ_v”ify_¿nge
(cÚ¡ 
msgËv–
, cÚ¡ 
š_addr_t
 
¡¬t
, cÚ¡ in_addr_ˆ
’d
)

127 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

128 
boŞ
 
»t
 = 
Œue
;

130 ià(
¡¬t
 > 
’d
)

132 
	`msg
(
msgËv–
, "--ifconfig-pool start IP [%s] is greaterhanƒnd IP [%s]",

133 
	`´št_š_addr_t
(
¡¬t
, 0, &
gc
),

134 
	`´št_š_addr_t
(
’d
, 0, &
gc
));

135 
»t
 = 
çl£
;

137 ià(
’d
 - 
¡¬t
 >ğ
IFCONFIG_POOL_MAX
)

139 
	`msg
(
msgËv–
, "--ifconfig-pool‡ddress„ange isoo†arge [%s -> %s]. Current maximum is %d‡ddresses,‡s defined by IFCONFIG_POOL_MAX variable.",

140 
	`´št_š_addr_t
(
¡¬t
, 0, &
gc
),

141 
	`´št_š_addr_t
(
’d
, 0, &
gc
),

142 
IFCONFIG_POOL_MAX
);

143 
»t
 = 
çl£
;

145 
	`gc_ä“
(&
gc
);

146  
»t
;

147 
	}
}

149 
ifcÚfig_poŞ
 *

150 
	$ifcÚfig_poŞ_š™
(
ty³
, 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
,

151 cÚ¡ 
boŞ
 
du¶iÿ‹_ú
,

152 cÚ¡ 
boŞ
 
v6_poŞ
, cÚ¡ 
š6_addr
 
v6_ba£
,

153 cÚ¡ 
v6_Ãtb™s
 )

155 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

156 
ifcÚfig_poŞ
 *
poŞ
 = 
NULL
;

158 
	`ASSERT
(
¡¬t
 <ğ
’d
 &&ƒnd - s¹ < 
IFCONFIG_POOL_MAX
);

159 
	`ALLOC_OBJ_CLEAR
(
poŞ
, 
ifcÚfig_poŞ
);

161 
poŞ
->
ty³
 =ype;

162 
poŞ
->
du¶iÿ‹_ú
 = duplicate_cn;

164 
ty³
)

166 
IFCONFIG_POOL_30NET
:

167 
poŞ
->
ba£
 = 
¡¬t
 & ~3;

168 
poŞ
->
size
 = (((
’d
 | 3è+ 1è-…oŞ->
ba£
) >> 2;

171 
IFCONFIG_POOL_INDIV
:

172 
poŞ
->
ba£
 = 
¡¬t
;

173 
poŞ
->
size
 = 
’d
 - 
¡¬t
 + 1;

177 
	`ASSERT
(0);

181 
poŞ
->
v6
 = 
v6_poŞ
;

183 ià(
poŞ
->
v6
)

185 
poŞ
->
ba£_v6
 = 
v6_ba£
;

186 
poŞ
->
size_v6
 = 
v6_Ãtb™s
>96 ? ( 1<<(128-ipv6_netbits) )

187 : 
IFCONFIG_POOL_MAX
;

189 
	`msg
Ğ
D_IFCONFIG_POOL
, "IFCONFIG POOL IPv6: (IPv4) size=%d, size_ipv6=%d,‚etbits=%d, base_ipv6=%s",

190 
poŞ
->
size
,…oŞ->
size_v6
, 
v6_Ãtb™s
,

191 
	`´št_š6_addr
Ğ
poŞ
->
ba£_v6
, 0, &
gc
 ));

197 
	`ASSERT
Ğ
poŞ
->
size
 <…oŞ->
size_v6
 );

200 
	`ALLOC_ARRAY_CLEAR
(
poŞ
->
li¡
, 
ifcÚfig_poŞ_’Œy
,…oŞ->
size
);

202 
	`msg
(
D_IFCONFIG_POOL
, "IFCONFIG POOL: base=%s size=%d, ipv6=%d",

203 
	`´št_š_addr_t
(
poŞ
->
ba£
, 0, &
gc
),

204 
poŞ
->
size
,…oŞ->
v6
 );

206 
	`gc_ä“
(&
gc
);

207  
poŞ
;

208 
	}
}

211 
	$ifcÚfig_poŞ_ä“
(
ifcÚfig_poŞ
 *
poŞ
)

213 ià(
poŞ
)

215 
i
;

216 
i
 = 0; i < 
poŞ
->
size
; ++i)

218 
	`ifcÚfig_poŞ_’Œy_ä“
(&
poŞ
->
li¡
[
i
], 
Œue
);

220 
	`ä“
(
poŞ
->
li¡
);

221 
	`ä“
(
poŞ
);

223 
	}
}

225 
ifcÚfig_poŞ_hªdË


226 
	$ifcÚfig_poŞ_acquœe
(
ifcÚfig_poŞ
 *
poŞ
, 
š_addr_t
 *
loÿl
, in_addr_ˆ*
»mÙe
, 
š6_addr
 *
»mÙe_v6
, cÚ¡ *
commÚ_Çme
)

228 
i
;

230 
i
 = 
	`ifcÚfig_poŞ_fšd
(
poŞ
, 
commÚ_Çme
);

231 ià(
i
 >= 0)

233 
ifcÚfig_poŞ_’Œy
 *
e
 = &
poŞ
->
li¡
[
i
];

234 
	`ASSERT
(!
e
->
š_u£
);

235 
	`ifcÚfig_poŞ_’Œy_ä“
(
e
, 
Œue
);

236 
e
->
š_u£
 = 
Œue
;

237 ià(
commÚ_Çme
)

239 
e
->
commÚ_Çme
 = 
	`¡ršg_®loc
(commÚ_Çme, 
NULL
);

242 
poŞ
->
ty³
)

244 
IFCONFIG_POOL_30NET
:

246 
š_addr_t
 
b
 = 
poŞ
->
ba£
 + (
i
 << 2);

247 *
loÿl
 = 
b
 + 1;

248 *
»mÙe
 = 
b
 + 2;

252 
IFCONFIG_POOL_INDIV
:

254 
š_addr_t
 
b
 = 
poŞ
->
ba£
 + 
i
;

255 *
loÿl
 = 0;

256 *
»mÙe
 = 
b
;

261 
	`ASSERT
(0);

265 ià(
poŞ
->
v6
 && 
»mÙe_v6
)

267 *
»mÙe_v6
 = 
	`add_š6_addr
Ğ
poŞ
->
ba£_v6
, 
i
 );

270  
i
;

271 
	}
}

273 
boŞ


274 
	$ifcÚfig_poŞ_»Ëa£
(
ifcÚfig_poŞ
 *
poŞ
, 
ifcÚfig_poŞ_hªdË
 
hªd
, cÚ¡ 
boŞ
 
h¬d
)

276 
boŞ
 
»t
 = 
çl£
;

277 ià(
poŞ
 && 
hªd
 >ğ0 && hªd <…oŞ->
size
)

279 
	`ifcÚfig_poŞ_’Œy_ä“
(&
poŞ
->
li¡
[
hªd
], 
h¬d
);

280 
»t
 = 
Œue
;

282  
»t
;

283 
	}
}

289 
ifcÚfig_poŞ_hªdË


290 
	$ifcÚfig_poŞ__ba£_to_hªdË
(cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
, cÚ¡ 
š_addr_t
 
addr
)

292 
ifcÚfig_poŞ_hªdË
 
»t
 = -1;

294 
poŞ
->
ty³
)

296 
IFCONFIG_POOL_30NET
:

298 
»t
 = (
addr
 - 
poŞ
->
ba£
) >> 2;

302 
IFCONFIG_POOL_INDIV
:

304 
»t
 = (
addr
 - 
poŞ
->
ba£
);

309 
	`ASSERT
(0);

312 ià(
»t
 < 0 ||„‘ >ğ
poŞ
->
size
)

314 
»t
 = -1;

317  
»t
;

318 
	}
}

320 
š_addr_t


321 
	$ifcÚfig_poŞ_hªdË_to__ba£
(cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
, 
ifcÚfig_poŞ_hªdË
 
hªd
)

323 
š_addr_t
 
»t
 = 0;

325 ià(
hªd
 >ğ0 && hªd < 
poŞ
->
size
)

327 
poŞ
->
ty³
)

329 
IFCONFIG_POOL_30NET
:

331 
»t
 = 
poŞ
->
ba£
 + (
hªd
 << 2);

335 
IFCONFIG_POOL_INDIV
:

337 
»t
 = 
poŞ
->
ba£
 + 
hªd
;

342 
	`ASSERT
(0);

346  
»t
;

347 
	}
}

349 
š6_addr


350 
	$ifcÚfig_poŞ_hªdË_to_v6_ba£
(cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
, 
ifcÚfig_poŞ_hªdË
 
hªd
)

352 
š6_addr
 
»t
 = 
š6addr_ªy
;

355 ià(
hªd
 >ğ0 && hªd < 
poŞ
->
size_v6
)

357 
»t
 = 
	`add_š6_addr
Ğ
poŞ
->
ba£_v6
, 
hªd
 );

359  
»t
;

360 
	}
}

363 
	$ifcÚfig_poŞ_£t
(
ifcÚfig_poŞ
 *
poŞ
, cÚ¡ *
ú
, cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
boŞ
 
fixed
)

365 
ifcÚfig_poŞ_hªdË
 
h
 = 
	`ifcÚfig_poŞ__ba£_to_hªdË
(
poŞ
, 
addr
);

366 ià(
h
 >= 0)

368 
ifcÚfig_poŞ_’Œy
 *
e
 = &
poŞ
->
li¡
[
h
];

369 
	`ifcÚfig_poŞ_’Œy_ä“
(
e
, 
Œue
);

370 
e
->
š_u£
 = 
çl£
;

371 
e
->
commÚ_Çme
 = 
	`¡ršg_®loc
(
ú
, 
NULL
);

372 
e
->
Ï¡_»Ëa£
 = 
now
;

373 
e
->
fixed
 = fixed;

375 
	}
}

378 
	$ifcÚfig_poŞ_li¡
(cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
, 
¡©us_ouut
 *
out
)

380 ià(
poŞ
 && 
out
)

382 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

383 
i
;

385 
i
 = 0; i < 
poŞ
->
size
; ++i)

387 cÚ¡ 
ifcÚfig_poŞ_’Œy
 *
e
 = &
poŞ
->
li¡
[
i
];

388 ià(
e
->
commÚ_Çme
)

390 cÚ¡ 
š_addr_t
 

 = 
	`ifcÚfig_poŞ_hªdË_to__ba£
(
poŞ
, 
i
);

391 ià(
poŞ
->
v6
)

393 
š6_addr
 
6
 = 
	`ifcÚfig_poŞ_hªdË_to_v6_ba£
(
poŞ
, 
i
);

394 
	`¡©us_´štf
(
out
, "%s,%s,%s",

395 
e
->
commÚ_Çme
,

396 
	`´št_š_addr_t
(

, 0, &
gc
),

397 
	`´št_š6_addr
(
6
, 0, &
gc
));

401 
	`¡©us_´štf
(
out
, "%s,%s",

402 
e
->
commÚ_Çme
,

403 
	`´št_š_addr_t
(

, 0, &
gc
));

407 
	`gc_ä“
(&
gc
);

409 
	}
}

412 
	$ifcÚfig_poŞ_msg
(cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
, 
msgËv–
)

414 
¡©us_ouut
 *
so
 = 
	`¡©us_İ’
(
NULL
, 0, 
msgËv–
, NULL, 0);

415 
	`ASSERT
(
so
);

416 
	`¡©us_´štf
(
so
, "IFCONFIG POOL LIST");

417 
	`ifcÚfig_poŞ_li¡
(
poŞ
, 
so
);

418 
	`¡©us_şo£
(
so
);

419 
	}
}

425 
ifcÚfig_poŞ_³rsi¡
 *

426 
	$ifcÚfig_poŞ_³rsi¡_š™
(cÚ¡ *
f’ame
, 
»äesh_äeq
)

428 
ifcÚfig_poŞ_³rsi¡
 *
»t
;

430 
	`ASSERT
(
f’ame
);

432 
	`ALLOC_OBJ_CLEAR
(
»t
, 
ifcÚfig_poŞ_³rsi¡
);

433 ià(
»äesh_äeq
 > 0)

435 
»t
->
fixed
 = 
çl£
;

436 
»t
->
fe
 = 
	`¡©us_İ’
(
f’ame
, 
»äesh_äeq
, -1, 
NULL
, 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
);

440 
»t
->
fixed
 = 
Œue
;

441 
»t
->
fe
 = 
	`¡©us_İ’
(
f’ame
, 0, -1, 
NULL
, 
STATUS_OUTPUT_READ
);

443  
»t
;

444 
	}
}

447 
	$ifcÚfig_poŞ_³rsi¡_şo£
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
)

449 ià(
³rsi¡
)

451 ià(
³rsi¡
->
fe
)

453 
	`¡©us_şo£
(
³rsi¡
->
fe
);

455 
	`ä“
(
³rsi¡
);

457 
	}
}

459 
boŞ


460 
	$ifcÚfig_poŞ_wr™e_Œigg”
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
)

462 ià(
³rsi¡
->
fe
)

464  
	`¡©us_Œigg”
(
³rsi¡
->
fe
);

468  
çl£
;

470 
	}
}

473 
	$ifcÚfig_poŞ_»ad
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
, 
ifcÚfig_poŞ
 *
poŞ
)

475 cÚ¡ 
buf_size
 = 128;

477 
	`upd©e_time
();

478 ià(
³rsi¡
 &&…”si¡->
fe
 && 
poŞ
)

480 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

481 
bufãr
 
š
 = 
	`®loc_buf_gc
(256, &
gc
);

482 *
ú_buf
;

483 *
_buf
;

484 
lše
 = 0;

486 
	`ALLOC_ARRAY_CLEAR_GC
(
ú_buf
, , 
buf_size
, &
gc
);

487 
	`ALLOC_ARRAY_CLEAR_GC
(
_buf
, , 
buf_size
, &
gc
);

489 
Œue
)

491 
	`ASSERT
(
	`buf_š™
(&
š
, 0));

492 ià(!
	`¡©us_»ad
(
³rsi¡
->
fe
, &
š
))

496 ++
lše
;

497 ià(
	`BLEN
(&
š
))

499 
c
 = *
	`BSTR
(&
š
);

500 ià(
c
 == '#' || c == ';')

504 
	`msg
Ğ
M_INFO
, "ifconfig_pool_read(), in='%s', TODO: IPv6",

505 
	`BSTR
(&
š
) );

507 ià(
	`buf_·r£
(&
š
, ',', 
ú_buf
, 
buf_size
)

508 && 
	`buf_·r£
(&
š
, ',', 
_buf
, 
buf_size
))

510 
boŞ
 
sucûeded
;

511 cÚ¡ 
š_addr_t
 
addr
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
_buf
, 0, &
sucûeded
, 
NULL
);

512 ià(
sucûeded
)

514 
	`msg
Ğ
M_INFO
, "succeeded -> ifconfig_pool_set()");

515 
	`ifcÚfig_poŞ_£t
(
poŞ
, 
ú_buf
, 
addr
, 
³rsi¡
->
fixed
);

521 
	`ifcÚfig_poŞ_msg
(
poŞ
, 
D_IFCONFIG_POOL
);

523 
	`gc_ä“
(&
gc
);

525 
	}
}

528 
	$ifcÚfig_poŞ_wr™e
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
, cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
)

530 ià(
³rsi¡
 &&…”si¡->
fe
 && (
	`¡©us_rw_æags
Õ”si¡->feè& 
STATUS_OUTPUT_WRITE
è&& 
poŞ
)

532 
	`¡©us_»£t
(
³rsi¡
->
fe
);

533 
	`ifcÚfig_poŞ_li¡
(
poŞ
, 
³rsi¡
->
fe
);

534 
	`¡©us_æush
(
³rsi¡
->
fe
);

536 
	}
}

542 #ifdeà
IFCONFIG_POOL_TEST


544 
	#DUP_CN


	)

547 
	$ifcÚfig_poŞ_‹¡
(
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
)

549 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

550 
ifcÚfig_poŞ
 *
p
 = 
	`ifcÚfig_poŞ_š™
(
IFCONFIG_POOL_30NET
, 
¡¬t
, 
’d
);

552 
ifcÚfig_poŞ_hªdË
 
¬¿y
[256];

553 
i
;

555 
	`CLEAR
(
¬¿y
);

557 
	`msg
(
M_INFO
 | 
M_NOPREFIX
, "************ 1");

558 
i
 = 0; i < (è
	`SIZE
(
¬¿y
); ++i)

560 *
ú
;

561 
ifcÚfig_poŞ_hªdË
 
h
;

562 
š_addr_t
 
loÿl
, 
»mÙe
;

563 
buf
[256];

564 
	`İ’v²_¢´štf
(
buf
, (buf), "commÚ-Çme-%d", 
i
);

565 #ifdeà
DUP_CN


566 
ú
 = 
NULL
;

568 
ú
 = 
buf
;

570 
h
 = 
	`ifcÚfig_poŞ_acquœe
(
p
, &
loÿl
, &
»mÙe
, 
NULL
, 
ú
);

571 ià(
h
 < 0)

575 
	`msg
(
M_INFO
 | 
M_NOPREFIX
, "IFCONFIG_POOL TEST…ass 1:†=%s„=%s cn=%s",

576 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

577 
	`´št_š_addr_t
(
»mÙe
, 0, &
gc
),

578 
ú
);

579 
¬¿y
[
i
] = 
h
;

583 
	`msg
(
M_INFO
 | 
M_NOPREFIX
, "************* 2");

584 
i
 = (è
	`SIZE
(
¬¿y
) / 16; i < () SIZE(array) / 8; ++i)

586 
	`msg
(
M_INFO
, "A‰em±Ø»Ëa£ %d cn=%s", 
¬¿y
[
i
], 
p
->
li¡
[i].
commÚ_Çme
);

587 ià(!
	`ifcÚfig_poŞ_»Ëa£
(
p
, 
¬¿y
[
i
]))

591 
	`msg
(
M_INFO
, "Succeeded");

594 
	`CLEAR
(
¬¿y
);

596 
	`msg
(
M_INFO
 | 
M_NOPREFIX
, "**************** 3");

597 
i
 = 0; i < (è
	`SIZE
(
¬¿y
); ++i)

599 *
ú
;

600 
ifcÚfig_poŞ_hªdË
 
h
;

601 
š_addr_t
 
loÿl
, 
»mÙe
;

602 
buf
[256];

603 
	`¢´štf
(
buf
, (buf), "commÚ-Çme-%d", 
i
+24);

604 #ifdeà
DUP_CN


605 
ú
 = 
NULL
;

607 
ú
 = 
buf
;

609 
h
 = 
	`ifcÚfig_poŞ_acquœe
(
p
, &
loÿl
, &
»mÙe
, 
NULL
, 
ú
);

610 ià(
h
 < 0)

614 
	`msg
(
M_INFO
 | 
M_NOPREFIX
, "IFCONFIG_POOL TEST…ass 3:†=%s„=%s cn=%s",

615 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

616 
	`´št_š_addr_t
(
»mÙe
, 0, &
gc
),

617 
ú
);

618 
¬¿y
[
i
] = 
h
;

622 
	`ifcÚfig_poŞ_ä“
(
p
);

623 
	`gc_ä“
(&
gc
);

624 
	}
}

	@pool.h

24 #iâdeà
POOL_H


25 
	#POOL_H


	)

27 #ià
P2MP


31 
	~"basic.h
"

32 
	~"¡©us.h
"

34 
	#IFCONFIG_POOL_MAX
 65536

	)

35 
	#IFCONFIG_POOL_MIN_NETBITS
 16

	)

37 
	#IFCONFIG_POOL_30NET
 0

	)

38 
	#IFCONFIG_POOL_INDIV
 1

	)

40 
	sifcÚfig_poŞ_’Œy


42 
boŞ
 
	mš_u£
;

43 *
	mcommÚ_Çme
;

44 
time_t
 
	mÏ¡_»Ëa£
;

45 
boŞ
 
	mfixed
;

48 
	sifcÚfig_poŞ


50 
š_addr_t
 
	mba£
;

51 
	msize
;

52 
	mty³
;

53 
boŞ
 
	mdu¶iÿ‹_ú
;

54 
boŞ
 
	mv6
;

55 
š6_addr
 
	mba£_v6
;

56 
	msize_v6
;

57 
ifcÚfig_poŞ_’Œy
 *
	mli¡
;

60 
	sifcÚfig_poŞ_³rsi¡


62 
¡©us_ouut
 *
	mfe
;

63 
boŞ
 
	mfixed
;

66 
	tifcÚfig_poŞ_hªdË
;

68 
ifcÚfig_poŞ
 *
ifcÚfig_poŞ_š™
(
ty³
, 
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
, cÚ¡ 
boŞ
 
du¶iÿ‹_ú
, cÚ¡ boŞ 
v6_poŞ
, cÚ¡ 
š6_addr
 
v6_ba£
, cÚ¡ 
v6_Ãtb™s
 );

70 
ifcÚfig_poŞ_ä“
(
ifcÚfig_poŞ
 *
poŞ
);

72 
boŞ
 
ifcÚfig_poŞ_v”ify_¿nge
(cÚ¡ 
msgËv–
, cÚ¡ 
š_addr_t
 
¡¬t
, cÚ¡ in_addr_ˆ
’d
);

74 
ifcÚfig_poŞ_hªdË
 
ifcÚfig_poŞ_acquœe
(
ifcÚfig_poŞ
 *
poŞ
, 
š_addr_t
 *
loÿl
, in_addr_ˆ*
»mÙe
, 
š6_addr
 *
»mÙe_v6
, cÚ¡ *
commÚ_Çme
);

76 
boŞ
 
ifcÚfig_poŞ_»Ëa£
(
ifcÚfig_poŞ
 *
poŞ
, 
ifcÚfig_poŞ_hªdË
 
hªd
, cÚ¡ boŞ 
h¬d
);

78 
ifcÚfig_poŞ_³rsi¡
 *
ifcÚfig_poŞ_³rsi¡_š™
(cÚ¡ *
f’ame
, 
»äesh_äeq
);

80 
ifcÚfig_poŞ_³rsi¡_şo£
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
);

82 
boŞ
 
ifcÚfig_poŞ_wr™e_Œigg”
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
);

84 
ifcÚfig_poŞ_»ad
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
, 
ifcÚfig_poŞ
 *
poŞ
);

86 
ifcÚfig_poŞ_wr™e
(
ifcÚfig_poŞ_³rsi¡
 *
³rsi¡
, cÚ¡ 
ifcÚfig_poŞ
 *
poŞ
);

88 #ifdeà
IFCONFIG_POOL_TEST


89 
ifcÚfig_poŞ_‹¡
(
š_addr_t
 
¡¬t
, in_addr_ˆ
’d
);

	@proto.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"´Ùo.h
"

33 
	~"”rÜ.h
"

35 
	~"memdbg.h
"

42 
boŞ


43 
	$is_v_X
Ğ
tuÂ–_ty³
, 
bufãr
 *
buf
, 
_v”
 )

45 
off£t
;

46 cÚ¡ 
İ’v²_hdr
 *
ih
;

48 
	`v”ify_®ign_4
(
buf
);

49 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TUN
)

51 ià(
	`BLEN
(
buf
è< (è(
İ’v²_hdr
))

53  
çl£
;

55 
off£t
 = 0;

57 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TAP
)

59 cÚ¡ 
İ’v²_‘hhdr
 *
eh
;

60 ià(
	`BLEN
(
buf
è< ()((
İ’v²_‘hhdr
)

61 + (
İ’v²_hdr
)))

63  
çl£
;

65 
eh
 = (cÚ¡ 
İ’v²_‘hhdr
 *è
	`BPTR
(
buf
);

66 ià(
	`Áohs
(
eh
->
´Ùo
è!ğ(
_v”
 =ğ6 ? 
OPENVPN_ETH_P_IPV6
 : 
OPENVPN_ETH_P_IPV4
))

68  
çl£
;

70 
off£t
 = (
İ’v²_‘hhdr
);

74  
çl£
;

77 
ih
 = (cÚ¡ 
İ’v²_hdr
 *è(
	`BPTR
(
buf
è+ 
off£t
);

80 ià(
	`OPENVPN_IPH_GET_VER
(
ih
->
v”siÚ_Ën
è=ğ
_v”
)

82  
	`buf_advªû
(
buf
, 
off£t
);

86  
çl£
;

88 
	}
}

90 
boŞ


91 
	$is_v4
(
tuÂ–_ty³
, 
bufãr
 *
buf
)

93  
	`is_v_X
Ğ
tuÂ–_ty³
, 
buf
, 4 );

94 
	}
}

95 
boŞ


96 
	$is_v6
(
tuÂ–_ty³
, 
bufãr
 *
buf
)

98  
	`is_v_X
Ğ
tuÂ–_ty³
, 
buf
, 6 );

99 
	}
}

101 #ifdeà
PACKET_TRUNCATION_CHECK


104 
	$v4_·ck‘_size_v”ify
(cÚ¡ 
ušt8_t
 *
d©a
,

105 cÚ¡ 
size
,

106 cÚ¡ 
tuÂ–_ty³
,

107 cÚ¡ *
´efix
,

108 
couÁ”_ty³
 *
”rÜs
)

110 ià(
size
 > 0)

112 
bufãr
 
buf
;

114 
	`buf_£t_»ad
(&
buf
, 
d©a
, 
size
);

116 ià(
	`is_v4
(
tuÂ–_ty³
, &
buf
))

118 cÚ¡ 
İ’v²_hdr
 *
p
;

119 
hËn
;

120 
tÙËn
;

121 cÚ¡ *
msg¡r
 = "PACKET SIZE INFO";

122 
msgËv–
 = 
D_PACKET_TRUNC_DEBUG
;

124 ià(
	`BLEN
(&
buf
è< (è(
İ’v²_hdr
))

129 
	`v”ify_®ign_4
(&
buf
);

130 
p
 = (
İ’v²_hdr
 *è
	`BPTR
(&
buf
);

132 
hËn
 = 
	`OPENVPN_IPH_GET_LEN
(
p
->
v”siÚ_Ën
);

133 
tÙËn
 = 
	`Áohs
(
p
->
tÙ_Ën
);

135 ià(
	`BLEN
(&
buf
è!ğ
tÙËn
)

137 
msg¡r
 = "PACKET TRUNCATION ERROR";

138 
msgËv–
 = 
D_PACKET_TRUNC_ERR
;

139 ià(
”rÜs
)

141 ++(*
”rÜs
);

145 
	`msg
(
msgËv–
, "% %s: size=%dÙËn=%d hËn=%dƒ¼couÁ=" 
couÁ”_fÜm©
,

146 
msg¡r
,

147 
´efix
,

148 
	`BLEN
(&
buf
),

149 
tÙËn
,

150 
hËn
,

151 
”rÜs
 ? *”rÜ : (
couÁ”_ty³
)0);

154 
	}
}

	@proto.h

24 #iâdeà
PROTO_H


25 
	#PROTO_H


	)

27 
	~"commÚ.h
"

28 
	~"bufãr.h
"

30 #´agm¨
·ck
(1)

35 
	#DEV_TYPE_UNDEF
 0

	)

36 
	#DEV_TYPE_NULL
 1

	)

37 
	#DEV_TYPE_TUN
 2

	)

38 
	#DEV_TYPE_TAP
 3

	)

42 
	#TOP_UNDEF
 0

	)

43 
	#TOP_NET30
 1

	)

44 
	#TOP_P2P
 2

	)

45 
	#TOP_SUBNET
 3

	)

54 
	#OPENVPN_ETH_ALEN
 6

	)

55 
	sİ’v²_‘hhdr


57 
ušt8_t
 
	mde¡
[
OPENVPN_ETH_ALEN
];

58 
ušt8_t
 
	msourû
[
OPENVPN_ETH_ALEN
];

60 
	#OPENVPN_ETH_P_IPV4
 0x0800

	)

61 
	#OPENVPN_ETH_P_IPV6
 0x86DD

	)

62 
	#OPENVPN_ETH_P_ARP
 0x0806

	)

63 
ušt16_t
 
	m´Ùo
;

66 
	sİ’v²_¬p
 {

67 
	#ARP_MAC_ADDR_TYPE
 0x0001

	)

68 
ušt16_t
 
	mmac_addr_ty³
;

70 
ušt16_t
 
	m´Ùo_addr_ty³
;

71 
ušt8_t
 
	mmac_addr_size
;

72 
ušt8_t
 
	m´Ùo_addr_size
;

74 
	#ARP_REQUEST
 0x0001

	)

75 
	#ARP_REPLY
 0x0002

	)

76 
ušt16_t
 
	m¬p_commªd
;

78 
ušt8_t
 
	mmac_¤c
[
OPENVPN_ETH_ALEN
];

79 
š_addr_t
 
	m_¤c
;

80 
ušt8_t
 
	mmac_de¡
[
OPENVPN_ETH_ALEN
];

81 
š_addr_t
 
	m_de¡
;

84 
	sİ’v²_hdr
 {

85 
	#OPENVPN_IPH_GET_VER
(
v
è(((vè>> 4è& 0x0F)

	)

86 
	#OPENVPN_IPH_GET_LEN
(
v
è(((vè& 0x0Fè<< 2)

	)

87 
ušt8_t
 
	mv”siÚ_Ën
;

89 
ušt8_t
 
	mtos
;

90 
ušt16_t
 
	mtÙ_Ën
;

91 
ušt16_t
 
	mid
;

93 
	#OPENVPN_IP_OFFMASK
 0x1fff

	)

94 
ušt16_t
 
	mäag_off
;

96 
ušt8_t
 
	m‰l
;

98 
	#OPENVPN_IPPROTO_IGMP
 2

	)

99 
	#OPENVPN_IPPROTO_TCP
 6

	)

100 
	#OPENVPN_IPPROTO_UDP
 17

	)

101 
ušt8_t
 
	m´ÙocŞ
;

103 
ušt16_t
 
	mcheck
;

104 
ušt32_t
 
	m§ddr
;

105 
ušt32_t
 
	mdaddr
;

112 
	sİ’v²_v6hdr
 {

113 
ušt8_t
 
	mv”siÚ_´io
;

114 
ušt8_t
 
	mæow_lbl
[3];

115 
ušt16_t
 
	m·ylßd_Ën
;

116 
ušt8_t
 
	mÃxthdr
;

117 
ušt8_t
 
	mhİ_lim™
;

119 
š6_addr
 
	m§ddr
;

120 
š6_addr
 
	mdaddr
;

127 
	sİ’v²_udphdr
 {

128 
ušt16_t
 
	msourû
;

129 
ušt16_t
 
	mde¡
;

130 
ušt16_t
 
	mËn
;

131 
ušt16_t
 
	mcheck
;

137 
	sİ’v²_tıhdr
 {

138 
ušt16_t
 
	msourû
;

139 
ušt16_t
 
	mde¡
;

140 
ušt32_t
 
	m£q
;

141 
ušt32_t
 
	mack_£q
;

143 
	#OPENVPN_TCPH_GET_DOFF
(
d
è(((dè& 0xF0è>> 2)

	)

144 
ušt8_t
 
	mdoff_»s
;

146 
	#OPENVPN_TCPH_FIN_MASK
 (1<<0)

	)

147 
	#OPENVPN_TCPH_SYN_MASK
 (1<<1)

	)

148 
	#OPENVPN_TCPH_RST_MASK
 (1<<2)

	)

149 
	#OPENVPN_TCPH_PSH_MASK
 (1<<3)

	)

150 
	#OPENVPN_TCPH_ACK_MASK
 (1<<4)

	)

151 
	#OPENVPN_TCPH_URG_MASK
 (1<<5)

	)

152 
	#OPENVPN_TCPH_ECE_MASK
 (1<<6)

	)

153 
	#OPENVPN_TCPH_CWR_MASK
 (1<<7)

	)

154 
ušt8_t
 
	mæags
;

156 
ušt16_t
 
	mwšdow
;

157 
ušt16_t
 
	mcheck
;

158 
ušt16_t
 
	murg_±r
;

161 
	#OPENVPN_TCPOPT_EOL
 0

	)

162 
	#OPENVPN_TCPOPT_NOP
 1

	)

163 
	#OPENVPN_TCPOPT_MAXSEG
 2

	)

164 
	#OPENVPN_TCPOLEN_MAXSEG
 4

	)

166 
	s_tı_udp_hdr
 {

167 
İ’v²_hdr
 
	m
;

169 
İ’v²_tıhdr
 
	mtı
;

170 
İ’v²_udphdr
 
	mudp
;

171 } 
	mu
;

174 #´agm¨
·ck
()

184 
	#ADJUST_CHECKSUM
(
acc
, 
cksum
) { \

185 
_acc
 = 
acc
; \

186 
_acc
 +ğ(
cksum
); \

187 ià(
_acc
 < 0) { \

188 
_acc
 = -_acc; \

189 
_acc
 = (_acc >> 16) + (_acc & 0xffff); \

190 
_acc
 += _acc >> 16; \

191 (
cksum
èğ(
ušt16_t
è~
_acc
; \

193 
_acc
 = (_acc >> 16) + (_acc & 0xffff); \

194 
_acc
 += _acc >> 16; \

195 (
cksum
èğ(
ušt16_t
è
_acc
; \

197 }

	)

199 
	#ADD_CHECKSUM_32
(
acc
, 
u32
) { \

200 
acc
 +ğ(
u32
) & 0xffff; \

201 
acc
 +ğ(
u32
) >> 16; \

202 }

	)

204 
	#SUB_CHECKSUM_32
(
acc
, 
u32
) { \

205 
acc
 -ğ(
u32
) & 0xffff; \

206 
acc
 -ğ(
u32
) >> 16; \

207 }

	)

217 
	#MTU_TO_MSS
(
mtu
è(mtu - (
İ’v²_hdr
) \

218 - (
İ’v²_tıhdr
))

	)

224 
šlše
 

225 
	$g‘_tun__v”
(
tuÂ–_ty³
, 
bufãr
 *
buf
, *
_hdr_off£t
)

227 
_v”
 = -1;

230 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TUN
)

232 *
_hdr_off£t
 = 0;

233 ià(
	`lik–y
(
	`BLEN
(
buf
è>ğ(è(
İ’v²_hdr
)))

235 
_v”
 = 
	`OPENVPN_IPH_GET_VER
(*
	`BPTR
(
buf
));

238 ià(
tuÂ–_ty³
 =ğ
DEV_TYPE_TAP
)

240 *
_hdr_off£t
 = ()((
İ’v²_‘hhdr
));

242 ià(
	`lik–y
(
	`BLEN
(
buf
è>ğ*
_hdr_off£t
))

244 cÚ¡ 
İ’v²_‘hhdr
 *
eh
 = (cÚ¡ İ’v²_‘hhd¸*è
	`BPTR
(
buf
);

245 
ušt16_t
 
´Ùo
 = 
	`Áohs
(
eh
->proto);

246 ià(
´Ùo
 =ğ
OPENVPN_ETH_P_IPV6
)

248 
_v”
 = 6;

250 ià(
´Ùo
 =ğ
OPENVPN_ETH_P_IPV4
)

252 
_v”
 = 4;

257  
_v”
;

258 
	}
}

264 
boŞ
 
is_v4
(
tuÂ–_ty³
, 
bufãr
 *
buf
);

266 
boŞ
 
is_v6
(
tuÂ–_ty³
, 
bufãr
 *
buf
);

268 #ifdeà
PACKET_TRUNCATION_CHECK


269 
v4_·ck‘_size_v”ify
(cÚ¡ 
ušt8_t
 *
d©a
,

270 cÚ¡ 
size
,

271 cÚ¡ 
tuÂ–_ty³
,

273 *
´efix
,

274 
couÁ”_ty³
 *
”rÜs
);

	@proxy.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"commÚ.h
"

33 
	~"misc.h
"

34 
	~"üy±o.h
"

35 
	~"wš32.h
"

36 
	~"sock‘.h
"

37 
	~"fdmisc.h
"

38 
	~"´oxy.h
"

39 
	~"ba£64.h
"

40 
	~"h‰pdige¡.h
"

41 
	~"Álm.h
"

42 
	~"memdbg.h
"

43 
	~"fÜw¬d.h
"

45 
	#UP_TYPE_PROXY
 "HTTP Proxy"

	)

47 
h‰p_´oxy_İtiÚs
 *

48 
	$š™_h‰p_´oxy_İtiÚs_Úû
(
h‰p_´oxy_İtiÚs
 **
hpo
,

49 
gc_¬’a
 *
gc
)

51 ià(!*
hpo
)

53 
	`ALLOC_OBJ_CLEAR_GC
(*
hpo
, 
h‰p_´oxy_İtiÚs
, 
gc
);

55 (*
hpo
)->
h‰p_v”siÚ
 = "1.0";

57  *
hpo
;

58 
	}
}

62 
u£r_·ss
 
	g¡©ic_´oxy_u£r_·ss
;

64 
boŞ


65 
	$»cv_lše
(
sock‘_desütÜ_t
 
sd
,

66 *
buf
,

67 
Ën
,

68 cÚ¡ 
timeout_£c
,

69 cÚ¡ 
boŞ
 
v”bo£
,

70 
bufãr
 *
lookah—d
,

71 vŞ©*
sigÇl_»ûived
)

73 
bufãr
 
Ï
;

74 
Ï¡c
 = 0;

76 
	`CLEAR
(
Ï
);

77 ià(
lookah—d
)

79 
Ï
 = *
lookah—d
;

82 
Œue
)

84 
¡©us
;

85 
ssize_t
 
size
;

86 
fd_£t
 
»ads
;

87 
timev®
 
tv
;

88 
ušt8_t
 
c
;

90 ià(
	`buf_defšed
(&
Ï
))

92 
	`ASSERT
(
	`buf_š™
(&
Ï
, 0));

95 
	`FD_ZERO
(&
»ads
);

96 
	`İ’v²_fd_£t
(
sd
, &
»ads
);

97 
tv
.
tv_£c
 = 
timeout_£c
;

98 
tv
.
tv_u£c
 = 0;

100 
¡©us
 = 
	`£Ëù
(
sd
 + 1, &
»ads
, 
NULL
, NULL, &
tv
);

102 
	`g‘_sigÇl
(
sigÇl_»ûived
);

103 ià(*
sigÇl_»ûived
)

105 
”rÜ
;

109 ià(
¡©us
 == 0)

111 ià(
v”bo£
)

113 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCP…ort„eadimeoutƒxpired");

115 
”rÜ
;

119 ià(
¡©us
 < 0)

121 ià(
v”bo£
)

123 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCP…ort„ead failed on select()");

125 
”rÜ
;

129 
size
 = 
	`»cv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

132 ià(
size
 != 1)

134 ià(
v”bo£
)

136 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_line: TCP…ort„ead failed on„ecv()");

138 
”rÜ
;

142 ià(
	`i¥ršt
(
c
))

144 
	`msg
(
M_INFO
, "PROXY:„—d '%c' (%d)", 
c
, ()c);

148 
	`msg
(
M_INFO
, "PROXY:„—d (%d)", ()
c
);

153 ià(
Ën
 > 1)

155 *
buf
++ = 
c
;

156 --
Ën
;

160 ià(
	`buf_defšed
(&
Ï
))

162 
	`buf_wr™e_u8
(&
Ï
, 
c
);

163 ià(!
	`i¥ršt
(
c
è&& !
	`is¥aû
(c))

165 ià(
v”bo£
)

167 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "»cv_lše: NÚ-ASCII ch¬aù” (%dè»ad oÀ»cv()", ()
c
);

169 *
lookah—d
 = 
Ï
;

170  
çl£
;

175 ià(
Ï¡c
 =ğ'\r' && 
c
 == '\n')

180 
Ï¡c
 = 
c
;

184 ià(
Ën
 > 0)

186 *
buf
++ = '\0';

189  
Œue
;

191 
”rÜ
:

192  
çl£
;

193 
	}
}

195 
boŞ


196 
	$£nd_lše
(
sock‘_desütÜ_t
 
sd
,

197 cÚ¡ *
buf
)

199 cÚ¡ 
ssize_t
 
size
 = 
	`£nd
(
sd
, 
buf
, 
	`¡¾’
(buf), 
MSG_NOSIGNAL
);

200 ià(
size
 !ğ(
ssize_t
è
	`¡¾’
(
buf
))

202 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "send_line: TCP…ort write failed on send()");

203  
çl£
;

205  
Œue
;

206 
	}
}

208 
boŞ


209 
	$£nd_lše_ülf
(
sock‘_desütÜ_t
 
sd
,

210 cÚ¡ *
¤c
)

212 
boŞ
 
»t
;

214 
bufãr
 
buf
 = 
	`®loc_buf
(
	`¡¾’
(
¤c
) + 3);

215 
	`ASSERT
(
	`buf_wr™e
(&
buf
, 
¤c
, 
	`¡¾’
(src)));

216 
	`ASSERT
(
	`buf_wr™e
(&
buf
, "\r\n", 3));

217 
»t
 = 
	`£nd_lše
(
sd
, 
	`BSTR
(&
buf
));

218 
	`ä“_buf
(&
buf
);

219  
»t
;

220 
	}
}

222 
boŞ


223 
	$£nd_ülf
(
sock‘_desütÜ_t
 
sd
)

225  
	`£nd_lše_ülf
(
sd
, "");

226 
	}
}

228 
ušt8_t
 *

229 
	$make_ba£64_¡ršg2
(cÚ¡ 
ušt8_t
 *
¡r
, 
¤c_Ën
, 
gc_¬’a
 *
gc
)

231 
ušt8_t
 *
»t
 = 
NULL
;

232 *
b64out
 = 
NULL
;

233 
	`ASSERT
(
	`İ’v²_ba£64_’code
((cÚ¡ *)
¡r
, 
¤c_Ën
, &
b64out
) >= 0);

234 
»t
 = (
ušt8_t
 *è
	`¡ršg_®loc
(
b64out
, 
gc
);

235 
	`ä“
(
b64out
);

236  
»t
;

237 
	}
}

239 
ušt8_t
 *

240 
	$make_ba£64_¡ršg
(cÚ¡ 
ušt8_t
 *
¡r
, 
gc_¬’a
 *
gc
)

242  
	`make_ba£64_¡ršg2
(
¡r
, 
	`¡¾’
((cÚ¡ *)¡r), 
gc
);

243 
	}
}

246 
	$u£ºame_·sswÜd_as_ba£64
(cÚ¡ 
h‰p_´oxy_šfo
 *
p
,

247 
gc_¬’a
 *
gc
)

249 
bufãr
 
out
 = 
	`®loc_buf_gc
(
	`¡¾’
(
p
->
up
.
u£ºame
è+ sŒËnÕ->up.
·sswÜd
è+ 2, 
gc
);

250 
	`ASSERT
(
	`¡¾’
(
p
->
up
.
u£ºame
) > 0);

251 
	`buf_´štf
(&
out
, "%s:%s", 
p
->
up
.
u£ºame
,…->up.
·sswÜd
);

252  (cÚ¡ *)
	`make_ba£64_¡ršg
((cÚ¡ 
ušt8_t
 *)
	`BSTR
(&
out
), 
gc
);

253 
	}
}

256 
	$ş—r_u£r_·ss_h‰p
()

258 
	`purge_u£r_·ss
(&
¡©ic_´oxy_u£r_·ss
, 
Œue
);

259 
	}
}

262 
	$g‘_u£r_·ss_h‰p
(
h‰p_´oxy_šfo
 *
p
, cÚ¡ 
boŞ
 
fÜû
)

268 ià(
fÜû
)

270 
	`ş—r_u£r_·ss_h‰p
();

273 ià(!
¡©ic_´oxy_u£r_·ss
.
defšed
)

275 
æags
 = 
GET_USER_PASS_MANAGEMENT
;

276 ià(
p
->
qu”›d_üeds
)

278 
æags
 |ğ
GET_USER_PASS_PREVIOUS_CREDS_FAILED
;

280 ià(
p
->
İtiÚs
.
šlše_üeds
)

282 
æags
 |ğ
GET_USER_PASS_INLINE_CREDS
;

284 
	`g‘_u£r_·ss
(&
¡©ic_´oxy_u£r_·ss
,

285 
p
->
İtiÚs
.
auth_fe
,

286 
UP_TYPE_PROXY
,

287 
æags
);

288 
p
->
qu”›d_üeds
 = 
Œue
;

289 
p
->
up
 = 
¡©ic_´oxy_u£r_·ss
;

291 
	}
}

296 
	$dump_»sidu®
(
sock‘_desütÜ_t
 
sd
,

297 
timeout
,

298 vŞ©*
sigÇl_»ûived
)

300 
buf
[256];

301 
Œue
)

303 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
timeout
, 
Œue
, 
NULL
, 
sigÇl_»ûived
))

307 
	`chomp
(
buf
);

308 
	`msg
(
D_PROXY
, "PROXY HEADER: '%s'", 
buf
);

310 
	}
}

318 
	$g‘_´oxy_auth’tiÿ‹
(
sock‘_desütÜ_t
 
sd
,

319 
timeout
,

320 **
d©a
,

321 
gc_¬’a
 *
gc
,

322 vŞ©*
sigÇl_»ûived
)

324 
buf
[256];

325 
»t
 = 
HTTP_AUTH_NONE
;

326 
Œue
)

328 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
timeout
, 
Œue
, 
NULL
, 
sigÇl_»ûived
))

330 
	`ä“
(*
d©a
);

331 *
d©a
 = 
NULL
;

332  
HTTP_AUTH_NONE
;

334 
	`chomp
(
buf
);

335 ià(!
	`¡¾’
(
buf
))

337  
»t
;

339 ià(
»t
 =ğ
HTTP_AUTH_NONE
 && !
	`¡ºcmp
(
buf
, "Proxy-Authenticate: ", 20))

341 ià(!
	`¡ºcmp
(
buf
+20, "Basic ", 6))

343 
	`msg
(
D_PROXY
, "PROXY AUTH BASIC: '%s'", 
buf
);

344 *
d©a
 = 
	`¡ršg_®loc
(
buf
+26, 
gc
);

345 
»t
 = 
HTTP_AUTH_BASIC
;

347 #ià
PROXY_DIGEST_AUTH


348 ià(!
	`¡ºcmp
(
buf
+20, "Digest ", 7))

350 
	`msg
(
D_PROXY
, "PROXY AUTH DIGEST: '%s'", 
buf
);

351 *
d©a
 = 
	`¡ršg_®loc
(
buf
+27, 
gc
);

352 
»t
 = 
HTTP_AUTH_DIGEST
;

355 #ià
NTLM


356 ià(!
	`¡ºcmp
(
buf
+20, "NTLM", 4))

358 
	`msg
(
D_PROXY
, "PROXY AUTH HTLM: '%s'", 
buf
);

359 *
d©a
 = 
NULL
;

360 
»t
 = 
HTTP_AUTH_NTLM
;

365 
	}
}

368 
	$¡Üe_´oxy_auth’tiÿ‹
(
h‰p_´oxy_šfo
 *
p
, *
d©a
)

370 ià(
p
->
´oxy_auth’tiÿ‹
)

372 
	`ä“
(
p
->
´oxy_auth’tiÿ‹
);

374 
p
->
´oxy_auth’tiÿ‹
 = 
d©a
;

375 
	}
}

381 
boŞ


382 
	$g‘_key_v®ue
(cÚ¡ *
¡r
,

383 *
key
,

384 *
v®ue
,

385 
max_key_Ën
,

386 
max_v®ue_Ën
,

387 cÚ¡ **
’d±r
)

389 
c
;

390 
boŞ
 
¡¬ts_w™h_quÙe
 = 
çl£
;

391 
boŞ
 
esÿ³
 = 
çl£
;

393 
c
 = 
max_key_Ën
-1; (*
¡r
 && (*str != '=') && c--); )

395 *
key
++ = *
¡r
++;

397 *
key
 = '\0';

399 ià('=' !ğ*
¡r
++)

402  
çl£
;

405 ià('\"' =ğ*
¡r
)

408 
¡r
++;

409 
¡¬ts_w™h_quÙe
 = 
Œue
;

412 
c
 = 
max_v®ue_Ën
-1; *
¡r
 && c--; str++)

414 *
¡r
)

417 ià(!
esÿ³
)

420 
esÿ³
 = 
Œue
;

421 *
v®ue
++ = '\\';

428 ià(!
¡¬ts_w™h_quÙe
)

432 
c
 = 0;

440 
c
 = 0;

444 ià(!
esÿ³
 && 
¡¬ts_w™h_quÙe
)

447 
c
 = 0;

452 
esÿ³
 = 
çl£
;

453 *
v®ue
++ = *
¡r
;

455 *
v®ue
 = '\0';

457 *
’d±r
 = 
¡r
;

459  
Œue
;

460 
	}
}

463 
	$g‘_·_v¬
(cÚ¡ *
key
, cÚ¡ *
·
, 
gc_¬’a
 *
gc
)

465 
k
[64];

466 
v
[256];

467 cÚ¡ *
cÚ‹Á
 = 
·
;

469 
Œue
)

471 cÚ¡ 
¡©us
 = 
	`g‘_key_v®ue
(
cÚ‹Á
, 
k
, 
v
, (k), (v), &content);

472 ià(
¡©us
)

474 ià(!
	`¡rcmp
(
key
, 
k
))

476  
	`¡ršg_®loc
(
v
, 
gc
);

481  
NULL
;

485 ià(*
cÚ‹Á
 == ',')

487 ++
cÚ‹Á
;

489 *
cÚ‹Á
 && 
	`is¥aû
(*content))

491 ++
cÚ‹Á
;

494 
	}
}

496 
h‰p_´oxy_šfo
 *

497 
	$h‰p_´oxy_Ãw
(cÚ¡ 
h‰p_´oxy_İtiÚs
 *
o
)

499 
h‰p_´oxy_šfo
 *
p
;

501 ià(!
o
 || !o->
£rv”
)

503 
	`msg
(
M_FATAL
, "HTTP_PROXY: server‚ot specified");

506 
	`ASSERT
Ğ
o
->
pÜt
);

508 
	`ALLOC_OBJ_CLEAR
(
p
, 
h‰p_´oxy_šfo
);

509 
p
->
İtiÚs
 = *
o
;

512 
p
->
auth_m‘hod
 = 
HTTP_AUTH_NONE
;

513 ià(
o
->
auth_m‘hod_¡ršg
)

515 ià(!
	`¡rcmp
(
o
->
auth_m‘hod_¡ršg
, "none"))

517 
p
->
auth_m‘hod
 = 
HTTP_AUTH_NONE
;

519 ià(!
	`¡rcmp
(
o
->
auth_m‘hod_¡ršg
, "basic"))

521 
p
->
auth_m‘hod
 = 
HTTP_AUTH_BASIC
;

523 #ià
NTLM


524 ià(!
	`¡rcmp
(
o
->
auth_m‘hod_¡ršg
, "ntlm"))

526 
p
->
auth_m‘hod
 = 
HTTP_AUTH_NTLM
;

528 ià(!
	`¡rcmp
(
o
->
auth_m‘hod_¡ršg
, "ntlm2"))

530 
p
->
auth_m‘hod
 = 
HTTP_AUTH_NTLM2
;

535 
	`msg
(
M_FATAL
, "ERROR: unknown HTTP‡uthentication method: '%s'",

536 
o
->
auth_m‘hod_¡ršg
);

541 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_BASIC
 ||…->auth_m‘hod =ğ
HTTP_AUTH_NTLM
 ||…->auth_m‘hod =ğ
HTTP_AUTH_NTLM2
)

543 
	`g‘_u£r_·ss_h‰p
(
p
, 
Œue
);

546 #ià!
NTLM


547 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_NTLM
 ||…->auth_m‘hod =ğ
HTTP_AUTH_NTLM2
)

549 
	`msg
(
M_FATAL
, "SÜry,hi v”siÚ oà" 
PACKAGE_NAME
 " was built without NTLM Proxy support.");

553 
p
->
defšed
 = 
Œue
;

554  
p
;

555 
	}
}

558 
	$h‰p_´oxy_şo£
(
h‰p_´oxy_šfo
 *
hp
)

560 
	`ä“
(
hp
);

561 
	}
}

563 
boŞ


564 
	$add_´oxy_h—d”s
(
h‰p_´oxy_šfo
 *
p
,

565 
sock‘_desütÜ_t
 
sd
,

566 cÚ¡ *
ho¡
,

567 cÚ¡ *
pÜt


570 
buf
[512];

571 
i
;

572 
boŞ
 
ho¡_h—d”_£Á
 = 
çl£
;

579 
i
 = 0; i < 
MAX_CUSTOM_HTTP_HEADER
 && 
p
->
İtiÚs
.
cu¡om_h—d”s
[i].
Çme
; i++)

581 ià(
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
cÚ‹Á
)

583 
	`İ’v²_¢´štf
(
buf
, (buf), "%s: %s",

584 
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
Çme
,

585 
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
cÚ‹Á
);

586 ià(!
	`¡rÿ£cmp
(
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
Çme
, "Host"))

588 
ho¡_h—d”_£Á
 = 
Œue
;

593 
	`İ’v²_¢´štf
(
buf
, (buf), "%s",

594 
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
Çme
);

595 ià(!
	`¡ºÿ£cmp
(
p
->
İtiÚs
.
cu¡om_h—d”s
[
i
].
Çme
, "Host:", 5))

597 
ho¡_h—d”_£Á
 = 
Œue
;

601 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

602 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

604  
çl£
;

608 ià(!
ho¡_h—d”_£Á
)

610 
	`İ’v²_¢´štf
(
buf
, (buf), "Ho¡: %s", 
ho¡
);

611 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

612 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

614  
çl£
;

619 ià(
p
->
İtiÚs
.
u£r_ag’t
)

621 
	`İ’v²_¢´štf
(
buf
, (buf), "User-Agent: %s",

622 
p
->
İtiÚs
.
u£r_ag’t
);

623 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

624 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

626  
çl£
;

630  
Œue
;

631 
	}
}

634 
boŞ


635 
	$e¡ablish_h‰p_´oxy_·s¡hru
(
h‰p_´oxy_šfo
 *
p
,

636 
sock‘_desütÜ_t
 
sd
,

637 cÚ¡ *
ho¡
,

638 cÚ¡ *
pÜt
,

639 
ev’t_timeout
 *
£rv”_pŞl_timeout
,

640 
bufãr
 *
lookah—d
,

641 vŞ©*
sigÇl_»ûived
)

643 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

644 
buf
[512];

645 
buf2
[129];

646 
g‘
[80];

647 
¡©us
;

648 
Å¬ms
;

649 
boŞ
 
»t
 = 
çl£
;

650 
boŞ
 
´oûs£d
 = 
çl£
;

653 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_BASIC


654 || 
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_DIGEST


655 || 
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_NTLM
)

657 
	`g‘_u£r_·ss_h‰p
(
p
, 
çl£
);

661 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_DIGEST
 &&…->
´oxy_auth’tiÿ‹
)

663 
Å¬ms
 = 1;

664 
¡©us
 = 407;

669 
	`İ’v²_¢´štf
(
buf
, (buf), "CONNECT %s:%s HTTP/%s",

670 
ho¡
,

671 
pÜt
,

672 
p
->
İtiÚs
.
h‰p_v”siÚ
);

674 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

677 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

679 
”rÜ
;

682 ià(!
	`add_´oxy_h—d”s
(
p
, 
sd
, 
ho¡
, 
pÜt
))

684 
”rÜ
;

688 
p
->
auth_m‘hod
)

690 
HTTP_AUTH_NONE
:

693 
HTTP_AUTH_BASIC
:

694 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-Authorization: Basic %s",

695 
	`u£ºame_·sswÜd_as_ba£64
(
p
, &
gc
));

696 
	`msg
(
D_PROXY
, "Attempting Basic Proxy-Authorization");

697 
	`dmsg
(
D_SHOW_KEYS
, "S’dØHTTP…roxy: '%s'", 
buf
);

698 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

700 
”rÜ
;

704 #ià
NTLM


705 
HTTP_AUTH_NTLM
:

706 
HTTP_AUTH_NTLM2
:

708 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-Connection: Keep-Alive");

709 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

711 
”rÜ
;

714 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-Authorization: NTLM %s",

715 
	`Álm_pha£_1
(
p
, &
gc
));

716 
	`msg
(
D_PROXY
, "Attempting NTLM Proxy-Authorization…hase 1");

717 
	`dmsg
(
D_SHOW_KEYS
, "S’dØHTTP…roxy: '%s'", 
buf
);

718 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

720 
”rÜ
;

726 
	`ASSERT
(0);

730 ià(!
	`£nd_ülf
(
sd
))

732 
”rÜ
;

736 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
Œue
, 
NULL
, 
sigÇl_»ûived
))

738 
”rÜ
;

742 
	`chomp
(
buf
);

744 
	`msg
(
D_PROXY
, "HTTP…roxy„‘uºed: '%s'", 
buf
);

747 
Å¬ms
 = 
	`ssÿnf
(
buf
, "%* %d", &
¡©us
);

752 
Å¬ms
 >ğ1 && 
¡©us
 == 407)

754 
	`msg
(
D_PROXY
, "Proxy„equires‡uthentication");

756 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_BASIC
 && !
´oûs£d
)

758 
´oûs£d
 = 
Œue
;

760 ià((
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_NTLM
 ||…->auth_m‘hod =ğ
HTTP_AUTH_NTLM2
è&& !
´oûs£d
)

762 #ià
NTLM


765 
Œue
)

767 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
Œue
, 
NULL
, 
sigÇl_»ûived
))

769 
”rÜ
;

771 
	`chomp
(
buf
);

772 
	`msg
(
D_PROXY
, "HTTP…roxy„‘uºed: '%s'", 
buf
);

774 
	`İ’v²_¢´štf
(
g‘
,  g‘, "%%* NTLM %%%ds", (è(
buf2
) - 1);

775 
Å¬ms
 = 
	`ssÿnf
(
buf
, 
g‘
, 
buf2
);

776 
buf2
[128] = 0;

779 ià(
Å¬ms
 == 1)

782 
	`msg
(
D_PROXY
, "auth sŒšg: '%s'", 
buf2
);

787 
	`msg
(
D_PROXY
, "Received NTLM Proxy-Authorization…hase 2„esponse");

790 
	`»cv_lše
(
sd
, 
NULL
, 0, 2, 
Œue
, NULL, 
sigÇl_»ûived
))

797 
	`İ’v²_¢´štf
(
buf
, (buf), "CONNECT %s:%s HTTP/%s",

798 
ho¡
,

799 
pÜt
,

800 
p
->
İtiÚs
.
h‰p_v”siÚ
);

802 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

805 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

807 
”rÜ
;

811 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-Connection: Keep-Alive");

812 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

814 
”rÜ
;

818 ià(!
	`add_´oxy_h—d”s
(
p
, 
sd
, 
ho¡
, 
pÜt
))

820 
”rÜ
;

823 
	`msg
(
D_PROXY
, "Attempting NTLM Proxy-Authorization…hase 3");

825 cÚ¡ *
Å3
 = 
	`Álm_pha£_3
(
p
, 
buf2
, &
gc
);

826 ià(!
Å3
)

828 
	`msg
(
D_PROXY
, "NTLM Proxy-Authorization…hase 3 failed:„eceived corrupted data from…roxy server");

829 
”rÜ
;

831 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-AuthÜiz©iÚ: NTLM %s", 
Å3
);

834 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

835 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

837 
”rÜ
;

841 ià(!
	`£nd_ülf
(
sd
))

843 
”rÜ
;

847 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
Œue
, 
NULL
, 
sigÇl_»ûived
))

849 
”rÜ
;

853 
	`chomp
(
buf
);

855 
	`msg
(
D_PROXY
, "HTTP…roxy„‘uºed: '%s'", 
buf
);

858 
Å¬ms
 = 
	`ssÿnf
(
buf
, "%* %d", &
¡©us
);

859 
´oûs£d
 = 
Œue
;

862 #ià
PROXY_DIGEST_AUTH


863 ià(
p
->
auth_m‘hod
 =ğ
HTTP_AUTH_DIGEST
 && !
´oûs£d
)

865 *
·
 = 
p
->
´oxy_auth’tiÿ‹
;

866 cÚ¡ 
m‘hod
 = 
p
->
auth_m‘hod
;

867 
	`ASSERT
(
·
);

869 ià(
m‘hod
 =ğ
HTTP_AUTH_DIGEST
)

871 cÚ¡ *
h‰p_m‘hod
 = "CONNECT";

872 cÚ¡ *
nÚû_couÁ
 = "00000001";

873 cÚ¡ *
qİ
 = "auth";

874 cÚ¡ *
u£ºame
 = 
p
->
up
.username;

875 cÚ¡ *
·sswÜd
 = 
p
->
up
.password;

876 *
İaque_kv
 = "";

877 
uri
[128];

878 
ušt8_t
 
úÚû_¿w
[8];

879 
ušt8_t
 *
úÚû
;

880 
HASHHEX
 
£ssiÚ_key
;

881 
HASHHEX
 
»¥Ú£
;

883 cÚ¡ *
»®m
 = 
	`g‘_·_v¬
("»®m", 
·
, &
gc
);

884 cÚ¡ *
nÚû
 = 
	`g‘_·_v¬
("nÚû", 
·
, &
gc
);

885 cÚ¡ *
®gÜ
 = 
	`g‘_·_v¬
("®gÜ™hm", 
·
, &
gc
);

886 cÚ¡ *
İaque
 = 
	`g‘_·_v¬
("İaque", 
·
, &
gc
);

888 iàĞ!
»®m
 || !
nÚû
 )

890 
	`msg
(
D_LINK_ERRORS
, "HTTP…roxy: digest‡uth failed, malformed„esponse "

892 
”rÜ
;

896 
	`ASSERT
(
	`¿nd_by‹s
(
úÚû_¿w
, (cnonce_raw)));

897 
úÚû
 = 
	`make_ba£64_¡ršg2
(
úÚû_¿w
, (úÚû_¿w), &
gc
);

901 
	`İ’v²_¢´štf
(
uri
, (uri), "%s:%s",

902 
ho¡
,

903 
pÜt
);

905 ià(
İaque
)

907 cÚ¡ 
Ën
 = 
	`¡¾’
(
İaque
)+16;

908 
İaque_kv
 = 
	`gc_m®loc
(
Ën
, 
çl£
, &
gc
);

909 
	`İ’v²_¢´štf
(
İaque_kv
, 
Ën
, ", o·que=\"%s\"", 
İaque
);

912 
	`Dige¡C®cHA1
(
®gÜ
,

913 
u£ºame
,

914 
»®m
,

915 
·sswÜd
,

916 
nÚû
,

917 (*)
úÚû
,

918 
£ssiÚ_key
);

919 
	`Dige¡C®cRe¥Ú£
(
£ssiÚ_key
,

920 
nÚû
,

921 
nÚû_couÁ
,

922 (*)
úÚû
,

923 
qİ
,

924 
h‰p_m‘hod
,

925 
uri
,

926 
NULL
,

927 
»¥Ú£
);

930 
	`İ’v²_¢´štf
(
buf
, (buf), "%s %s HTTP/%s",

931 
h‰p_m‘hod
,

932 
uri
,

933 
p
->
İtiÚs
.
h‰p_v”siÚ
);

935 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

938 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

940 
”rÜ
;

944 ià(!
	`add_´oxy_h—d”s
(
p
, 
sd
, 
ho¡
, 
pÜt
))

946 
”rÜ
;

950 
	`İ’v²_¢´štf
(
buf
, (buf), "Proxy-Authorization: Digest username=\"%s\",„ealm=\"%s\",‚once=\"%s\", uri=\"%s\", qop=%s,‚c=%s, cnonce=\"%s\",„esponse=\"%s\"%s",

951 
u£ºame
,

952 
»®m
,

953 
nÚû
,

954 
uri
,

955 
qİ
,

956 
nÚû_couÁ
,

957 
úÚû
,

958 
»¥Ú£
,

959 
İaque_kv


961 
	`msg
(
D_PROXY
, "S’dØHTTP…roxy: '%s'", 
buf
);

962 ià(!
	`£nd_lše_ülf
(
sd
, 
buf
))

964 
”rÜ
;

966 ià(!
	`£nd_ülf
(
sd
))

968 
”rÜ
;

972 ià(!
	`»cv_lše
(
sd
, 
buf
, (buf), 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
Œue
, 
NULL
, 
sigÇl_»ûived
))

974 
”rÜ
;

978 
	`chomp
(
buf
);

980 
	`msg
(
D_PROXY
, "HTTP…roxy„‘uºed: '%s'", 
buf
);

983 
Å¬ms
 = 
	`ssÿnf
(
buf
, "%* %d", &
¡©us
);

984 
´oûs£d
 = 
Œue
;

988 
	`msg
(
D_PROXY
, "HTTP…roxy: digest method‚ot supported");

989 
”rÜ
;

993 ià(
p
->
İtiÚs
.
auth_»Œy
)

996 *
·
 = 
NULL
;

997 cÚ¡ 
m‘hod
 = 
	`g‘_´oxy_auth’tiÿ‹
(
sd
,

998 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
),

999 &
·
,

1000 
NULL
,

1001 
sigÇl_»ûived
);

1002 ià(
m‘hod
 !ğ
HTTP_AUTH_NONE
)

1004 ià(
·
)

1006 
	`msg
(
D_PROXY
, "HTTP…roxy‡uth’tiÿ‹ '%s'", 
·
);

1008 ià(
p
->
İtiÚs
.
auth_»Œy
 =ğ
PAR_NCT
 && 
m‘hod
 =ğ
HTTP_AUTH_BASIC
)

1010 
	`msg
(
D_PROXY
, "HTTP…roxy: support for basic‡uth‡nd other cleartext…roxy‡uth methods is disabled");

1011 
	`ä“
(
·
);

1012 
”rÜ
;

1014 
p
->
auth_m‘hod
 = 
m‘hod
;

1015 
	`¡Üe_´oxy_auth’tiÿ‹
(
p
, 
·
);

1016 
»t
 = 
Œue
;

1017 
dÚe
;

1021 
	`msg
(
D_PROXY
, "HTTP…roxy: do‚ot„ecognizehe‡uthentication method„equired by…roxy");

1022 
	`ä“
(
·
);

1023 
”rÜ
;

1028 ià(!
´oûs£d
)

1030 
	`msg
(
D_PROXY
, "HTTP…roxy:‚o support for…roxy‡uthentication method");

1032 
”rÜ
;

1036 ià(
p
->
İtiÚs
.
auth_»Œy
)

1038 
	`ş—r_u£r_·ss_h‰p
();

1040 
	`¡Üe_´oxy_auth’tiÿ‹
(
p
, 
NULL
);

1044 ià(
Å¬ms
 < 1 || 
¡©us
 != 200)

1046 
	`msg
(
D_LINK_ERRORS
, "HTTP…roxy„eturned bad status");

1049 
	`dump_»sidu®
(
sd
, 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
sigÇl_»ûived
);

1051 
”rÜ
;

1057 ià(!
	`»cv_lše
(
sd
, 
NULL
, 0, 
	`g‘_£rv”_pŞl_»maššg_time
(
£rv”_pŞl_timeout
), 
Œue
, NULL, 
sigÇl_»ûived
))

1059 
”rÜ
;

1066 
	`»cv_lše
(
sd
, 
NULL
, 0, 2, 
çl£
, 
lookah—d
, 
sigÇl_»ûived
))

1071 
p
->
qu”›d_üeds
 = 
çl£
;

1074 ià(
lookah—d
 && 
	`BLEN
(lookahead))

1076 
	`msg
(
M_INFO
, "HTTP PROXY:†ookah—d: %s", 
	`fÜm©_hex
(
	`BPTR
(
lookah—d
), 
	`BLEN
(lookahead), 0));

1080 
dÚe
:

1081 
	`gc_ä“
(&
gc
);

1082  
»t
;

1084 
”rÜ
:

1085 ià(!*
sigÇl_»ûived
)

1087 *
sigÇl_»ûived
 = 
SIGUSR1
;

1089 
	`gc_ä“
(&
gc
);

1090  
»t
;

1091 
	}
}

	@proxy.h

24 #iâdeà
PROXY_H


25 
	#PROXY_H


	)

27 
	~"bufãr.h
"

28 
	~"misc.h
"

31 
	#HTTP_AUTH_NONE
 0

	)

32 
	#HTTP_AUTH_BASIC
 1

	)

33 
	#HTTP_AUTH_DIGEST
 2

	)

34 
	#HTTP_AUTH_NTLM
 3

	)

35 
	#HTTP_AUTH_NTLM2
 4

	)

36 
	#HTTP_AUTH_N
 5

	)

38 
	sh‰p_cu¡om_h—d”
 {

39 cÚ¡ *
	mÇme
;

40 cÚ¡ *
	mcÚ‹Á
;

43 
	#MAX_CUSTOM_HTTP_HEADER
 10

	)

44 
	sh‰p_´oxy_İtiÚs
 {

45 cÚ¡ *
	m£rv”
;

46 cÚ¡ *
	mpÜt
;

48 
	#PAR_NO
 0

	)

49 
	#PAR_ALL
 1

	)

50 
	#PAR_NCT
 2

	)

51 
	mauth_»Œy
;

53 cÚ¡ *
	mauth_m‘hod_¡ršg
;

54 cÚ¡ *
	mauth_fe
;

55 cÚ¡ *
	mh‰p_v”siÚ
;

56 cÚ¡ *
	mu£r_ag’t
;

57 
h‰p_cu¡om_h—d”
 
	mcu¡om_h—d”s
[
MAX_CUSTOM_HTTP_HEADER
];

58 
boŞ
 
	mšlše_üeds
;

61 
	sh‰p_´oxy_İtiÚs_sim¶e
 {

62 cÚ¡ *
	m£rv”
;

63 cÚ¡ *
	mpÜt
;

64 
	mauth_»Œy
;

67 
	sh‰p_´oxy_šfo
 {

68 
boŞ
 
	mdefšed
;

69 
	mauth_m‘hod
;

70 
h‰p_´oxy_İtiÚs
 
	mİtiÚs
;

71 
u£r_·ss
 
	mup
;

72 *
	m´oxy_auth’tiÿ‹
;

73 
boŞ
 
	mqu”›d_üeds
;

76 
h‰p_´oxy_İtiÚs
 *
š™_h‰p_´oxy_İtiÚs_Úû
(h‰p_´oxy_İtiÚ **
hpo
,

77 
gc_¬’a
 *
gc
);

79 
h‰p_´oxy_šfo
 *
h‰p_´oxy_Ãw
(cÚ¡ 
h‰p_´oxy_İtiÚs
 *
o
);

81 
h‰p_´oxy_şo£
(
h‰p_´oxy_šfo
 *
hp
);

83 
boŞ
 
e¡ablish_h‰p_´oxy_·s¡hru
(
h‰p_´oxy_šfo
 *
p
,

84 
sock‘_desütÜ_t
 
sd
,

85 cÚ¡ *
ho¡
,

86 cÚ¡ *
pÜt
,

87 
ev’t_timeout
 *
£rv”_pŞl_timeout
,

88 
bufãr
 *
lookah—d
,

89 vŞ©*
sigÇl_»ûived
);

91 
ušt8_t
 *
make_ba£64_¡ršg2
(cÚ¡ ušt8_ˆ*
¡r
, 
¡r_Ën
, 
gc_¬’a
 *
gc
);

93 
ušt8_t
 *
make_ba£64_¡ršg
(cÚ¡ ušt8_ˆ*
¡r
, 
gc_¬’a
 *
gc
);

	@ps.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
PORT_SHARE


34 
	~"ev’t.h
"

35 
	~"sock‘.h
"

36 
	~"fdmisc.h
"

37 
	~"üy±o.h
"

38 
	~"ps.h
"

40 
	~"memdbg.h
"

42 
pÜt_sh¬e
 *
	gpÜt_sh¬e
 = 
NULL
;

45 
	#PROXY_CONNECTION_BUFFER_SIZE
 1500

	)

48 
	#COMMAND_REDIRECT
 10

	)

49 
	#COMMAND_EXIT
 11

	)

52 
	#RESPONSE_INIT_SUCCEEDED
 20

	)

53 
	#RESPONSE_INIT_FAILED
 21

	)

59 
	#IOSTAT_EAGAIN_ON_READ
 0

	)

60 
	#IOSTAT_EAGAIN_ON_WRITE
 1

	)

61 
	#IOSTAT_READ_ERROR
 2

	)

62 
	#IOSTAT_WRITE_ERROR
 3

	)

63 
	#IOSTAT_GOOD
 4

	)

69 
	s´oxy_cÚÃùiÚ
 {

70 
boŞ
 
	mdefšed
;

71 
´oxy_cÚÃùiÚ
 *
	mÃxt
;

72 
´oxy_cÚÃùiÚ
 *
	mcouÁ”·¹
;

73 
bufãr
 
	mbuf
;

74 
boŞ
 
	mbufãr_š™Ÿl
;

75 
	mrwæags
;

76 
	msd
;

77 *
	mjâ
;

82 
	$h—dc
(cÚ¡ 
bufãr
 *
buf
)

84 
foo
[16];

85 
	`¡ºıy
(
foo
, 
	`BSTR
(
buf
), 15);

86 
foo
[15] = 0;

87  
foo
;

88 
	}
}

91 
šlše
 

92 
	$şo£_sock‘_if_defšed
(cÚ¡ 
sock‘_desütÜ_t
 
sd
)

94 ià(
	`sock‘_defšed
(
sd
))

96 
	`İ’v²_şo£_sock‘
(
sd
);

98 
	}
}

111 
	$şo£_fds_exû±
(
k“p
)

113 
sock‘_desütÜ_t
 
i
;

114 
	`şo£log
();

115 
i
 = 3; i <= 100; ++i)

117 ià(
i
 !ğ
k“p
)

119 
	`İ’v²_şo£_sock‘
(
i
);

122 
	}
}

129 
	$£t_sigÇls
()

131 
	`sigÇl
(
SIGTERM
, 
SIG_DFL
);

133 
	`sigÇl
(
SIGINT
, 
SIG_IGN
);

134 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

135 
	`sigÇl
(
SIGUSR1
, 
SIG_IGN
);

136 
	`sigÇl
(
SIGUSR2
, 
SIG_IGN
);

137 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

138 
	}
}

145 
	$»cv_cÚŒŞ
(cÚ¡ 
sock‘_desütÜ_t
 
fd
)

147 
c
;

148 cÚ¡ 
ssize_t
 
size
 = 
	`»ad
(
fd
, &
c
, (c));

149 ià(
size
 =ğ(
c
))

151  
c
;

157 
	}
}

160 
	$£nd_cÚŒŞ
(cÚ¡ 
sock‘_desütÜ_t
 
fd
, 
code
)

162 
c
 = (è
code
;

163 cÚ¡ 
ssize_t
 
size
 = 
	`wr™e
(
fd
, &
c
, (c));

164 ià(
size
 =ğ(
c
))

166  (è
size
;

172 
	}
}

175 
	$cmsg_size
()

177  
	`CMSG_SPACE
((
sock‘_desütÜ_t
));

178 
	}
}

188 
	$pÜt_sh¬e_£ndmsg
(cÚ¡ 
sock‘_desütÜ_t
 
sd
,

189 cÚ¡ 
commªd
,

190 cÚ¡ 
bufãr
 *
h—d
,

191 cÚ¡ 
sock‘_desütÜ_t
 
sd_£nd
)

193 ià(
	`sock‘_defšed
(
sd
))

195 
msghdr
 
mesg
;

196 
cmsghdr
 *
h
;

197 
iovec
 
iov
[2];

198 
sock‘_desütÜ_t
 
sd_nuÎ
[2] = { 
SOCKET_UNDEFINED
, SOCKET_UNDEFINED };

199 
cmd
;

200 
ssize_t
 
¡©us
;

202 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE: sendmsg sd=%d†en=%d",

203 ()
sd_£nd
,

204 
h—d
 ? 
	`BLEN
(head) : -1);

206 
	`CLEAR
(
mesg
);

208 
cmd
 = 
commªd
;

210 
iov
[0].
iov_ba£
 = &
cmd
;

211 
iov
[0].
iov_Ën
 = (
cmd
);

212 
mesg
.
msg_iovËn
 = 1;

214 ià(
h—d
)

216 
iov
[1].
iov_ba£
 = 
	`BPTR
(
h—d
);

217 
iov
[1].
iov_Ën
 = 
	`BLEN
(
h—d
);

218 
mesg
.
msg_iovËn
 = 2;

221 
mesg
.
msg_iov
 = 
iov
;

223 
mesg
.
msg_cÚŒŞËn
 = 
	`cmsg_size
();

224 
mesg
.
msg_cÚŒŞ
 = (*è
	`m®loc
(mesg.
msg_cÚŒŞËn
);

225 
	`check_m®loc_»tuº
(
mesg
.
msg_cÚŒŞ
);

226 
mesg
.
msg_æags
 = 0;

228 
h
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

229 
h
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

230 
h
->
cmsg_ty³
 = 
SCM_RIGHTS
;

231 
h
->
cmsg_Ën
 = 
	`CMSG_LEN
((
sock‘_desütÜ_t
));

233 ià(
	`sock‘_defšed
(
sd_£nd
))

235 
	`memıy
(
	`CMSG_DATA
(
h
), &
sd_£nd
, (sd_send));

239 
	`sock‘·œ
(
PF_UNIX
, 
SOCK_DGRAM
, 0, 
sd_nuÎ
);

240 
	`memıy
(
	`CMSG_DATA
(
h
), &
sd_nuÎ
[0], (sd_null[0]));

243 
¡©us
 = 
	`£ndmsg
(
sd
, &
mesg
, 
MSG_NOSIGNAL
);

244 ià(
¡©us
 == -1)

246 
	`msg
(
M_WARN
|
M_ERRNO
, "PORT SHARE: sendmsg failed -- unableo communicate with background…rocess (%d,%d,%d,%d)",

247 
sd
, 
sd_£nd
, 
sd_nuÎ
[0], sd_null[1]

251 
	`şo£_sock‘_if_defšed
(
sd_nuÎ
[0]);

252 
	`şo£_sock‘_if_defšed
(
sd_nuÎ
[1]);

253 
	`ä“
(
mesg
.
msg_cÚŒŞ
);

255 
	}
}

258 
	$´oxy_’Œy_şo£_sd
(
´oxy_cÚÃùiÚ
 *
pc
, 
ev’t_£t
 *
es
)

260 ià(
pc
->
defšed
 && 
	`sock‘_defšed
Õc->
sd
))

262 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: d–‘sd=%d", ()
pc
->
sd
);

263 ià(
es
)

265 
	`ev’t_d–
(
es
, 
pc
->
sd
);

267 
	`İ’v²_şo£_sock‘
(
pc
->
sd
);

268 
pc
->
sd
 = 
SOCKET_UNDEFINED
;

270 
	}
}

276 
	$´oxy_’Œy_m¬k_fÜ_şo£
(
´oxy_cÚÃùiÚ
 *
pc
, 
ev’t_£t
 *
es
)

278 ià(
pc
->
defšed
)

280 
´oxy_cÚÃùiÚ
 *
ı
 = 
pc
->
couÁ”·¹
;

281 
	`´oxy_’Œy_şo£_sd
(
pc
, 
es
);

282 
	`ä“_buf
(&
pc
->
buf
);

283 
pc
->
bufãr_š™Ÿl
 = 
çl£
;

284 
pc
->
rwæags
 = 0;

285 
pc
->
defšed
 = 
çl£
;

286 ià(
pc
->
jâ
)

288 
	`uÆšk
(
pc
->
jâ
);

289 
	`ä“
(
pc
->
jâ
);

290 
pc
->
jâ
 = 
NULL
;

292 ià(
ı
 && cp->
defšed
 && cp->
couÁ”·¹
 =ğ
pc
)

294 
	`´oxy_’Œy_m¬k_fÜ_şo£
(
ı
, 
es
);

297 
	}
}

304 
	$´oxy_li¡_hou£k“pšg
(
´oxy_cÚÃùiÚ
 **
li¡
)

306 ià(
li¡
)

308 
´oxy_cÚÃùiÚ
 *
´ev
 = 
NULL
;

309 
´oxy_cÚÃùiÚ
 *
pc
 = *
li¡
;

311 
pc
)

313 
´oxy_cÚÃùiÚ
 *
Ãxt
 = 
pc
->next;

314 ià(!
pc
->
defšed
)

316 
	`ä“
(
pc
);

317 ià(
´ev
)

319 
´ev
->
Ãxt
 =‚ext;

323 *
li¡
 = 
Ãxt
;

328 
´ev
 = 
pc
;

330 
pc
 = 
Ãxt
;

333 
	}
}

340 
	$jouº®_add
(cÚ¡ *
jouº®_dœ
, 
´oxy_cÚÃùiÚ
 *
pc
, ´oxy_cÚÃùiÚ *
ı
)

342 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

343 
İ’v²_sockaddr
 
äom
, 
to
;

344 
sockËn_t
 
¦’
, 
dËn
;

345 
âËn
;

346 *
jâ
;

347 
fd
;

349 
¦’
 = (
äom
.
addr
.
§
);

350 
dËn
 = (
to
.
addr
.
§
);

351 ià(!
	`g‘³”Çme
(
pc
->
sd
, (
sockaddr
 *è&
äom
.
addr
.
§
, &
¦’
)

352 && !
	`g‘sockÇme
(
ı
->
sd
, (
sockaddr
 *è&
to
.
addr
.
§
, &
dËn
))

354 cÚ¡ *
f
 = 
	`´št_İ’v²_sockaddr
(&
äom
, &
gc
);

355 cÚ¡ *
t
 = 
	`´št_İ’v²_sockaddr
(&
to
, &
gc
);

356 
âËn
 = 
	`¡¾’
(
jouº®_dœ
è+ sŒËn(
t
) + 2;

357 
jâ
 = (*è
	`m®loc
(
âËn
);

358 
	`check_m®loc_»tuº
(
jâ
);

359 
	`İ’v²_¢´štf
(
jâ
, 
âËn
, "%s/%s", 
jouº®_dœ
, 
t
);

360 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: cl›Á origš % -> %s", 
jâ
, 
f
);

361 
fd
 = 
	`¶©fÜm_İ’
(
jâ
, 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
, 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
);

362 ià(
fd
 != -1)

364 ià(
	`wr™e
(
fd
, 
f
, 
	`¡¾’
(f)) != strlen(f))

366 
	`msg
(
M_WARN
, "PORT SHARE: wr™šgØjouº® f(%sèçed", 
jâ
);

368 
	`şo£
(
fd
);

369 
ı
->
jâ
 = jfn;

373 
	`msg
(
M_WARN
|
M_ERRNO
, "PORT SHARE: uÇbËØwr™jouº® fš %s", 
jâ
);

374 
	`ä“
(
jâ
);

377 
	`gc_ä“
(&
gc
);

378 
	}
}

384 
	$´oxy_li¡_şo£
(
´oxy_cÚÃùiÚ
 **
li¡
)

386 ià(
li¡
)

388 
´oxy_cÚÃùiÚ
 *
pc
 = *
li¡
;

389 
pc
)

391 
	`´oxy_’Œy_m¬k_fÜ_şo£
(
pc
, 
NULL
);

392 
pc
 =…c->
Ãxt
;

394 
	`´oxy_li¡_hou£k“pšg
(
li¡
);

396 
	}
}

398 
šlše
 

399 
	$´oxy_cÚÃùiÚ_io_»queue
(
´oxy_cÚÃùiÚ
 *
pc
, cÚ¡ 
rwæags_Ãw
, 
ev’t_£t
 *
es
)

401 ià(
	`sock‘_defšed
(
pc
->
sd
è&&…c->
rwæags
 !ğ
rwæags_Ãw
)

404 
	`ev’t_ùl
(
es
, 
pc
->
sd
, 
rwæags_Ãw
, (*)pc);

405 
pc
->
rwæags
 = 
rwæags_Ãw
;

407 
	}
}

416 
boŞ


417 
	$´oxy_’Œy_Ãw
(
´oxy_cÚÃùiÚ
 **
li¡
,

418 
ev’t_£t
 *
es
,

419 cÚ¡ 
sockaddr_š
 
£rv”_addr
,

420 cÚ¡ 
sock‘_desütÜ_t
 
sd_ş›Á
,

421 
bufãr
 *
š™Ÿl_d©a
,

422 cÚ¡ *
jouº®_dœ
)

424 
sock‘_desütÜ_t
 
sd_£rv”
;

425 
¡©us
;

426 
´oxy_cÚÃùiÚ
 *
pc
;

427 
´oxy_cÚÃùiÚ
 *
ı
;

430 ià((
sd_£rv”
 = 
	`sock‘
(
PF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) < 0)

432 
	`msg
(
M_WARN
|
M_ERRNO
, "PORT SHARE PROXY: cannot create socket");

433  
çl£
;

435 
¡©us
 = 
	`İ’v²_cÚÃù
(
sd_£rv”
,(cÚ¡ 
sockaddr
 *è&
£rv”_addr
, 5, 
NULL
);

436 ià(
¡©us
)

438 
	`msg
(
M_WARN
, "PORT SHARE PROXY: connecto…ort-share server failed");

439 
	`İ’v²_şo£_sock‘
(
sd_£rv”
);

440  
çl£
;

442 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: connecto…ort-share server succeeded");

444 
	`£t_nÚblock
(
sd_ş›Á
);

445 
	`£t_nÚblock
(
sd_£rv”
);

448 
	`ALLOC_OBJ_CLEAR
(
pc
, 
´oxy_cÚÃùiÚ
);

449 
	`ALLOC_OBJ_CLEAR
(
ı
, 
´oxy_cÚÃùiÚ
);

452 
pc
->
defšed
 = 
Œue
;

453 
pc
->
Ãxt
 = 
ı
;

454 
pc
->
couÁ”·¹
 = 
ı
;

455 
pc
->
buf
 = *
š™Ÿl_d©a
;

456 
pc
->
bufãr_š™Ÿl
 = 
Œue
;

457 
pc
->
rwæags
 = 
EVENT_UNDEF
;

458 
pc
->
sd
 = 
sd_ş›Á
;

461 
ı
->
defšed
 = 
Œue
;

462 
ı
->
Ãxt
 = *
li¡
;

463 
ı
->
couÁ”·¹
 = 
pc
;

464 
ı
->
buf
 = 
	`®loc_buf
(
PROXY_CONNECTION_BUFFER_SIZE
);

465 
ı
->
bufãr_š™Ÿl
 = 
çl£
;

466 
ı
->
rwæags
 = 
EVENT_UNDEF
;

467 
ı
->
sd
 = 
sd_£rv”
;

470 *
li¡
 = 
pc
;

473 ià(
jouº®_dœ
)

475 
	`jouº®_add
(
jouº®_dœ
, 
pc
, 
ı
);

478 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: NEW CONNECTION [c=%d s=%d]", ()
sd_ş›Á
, ()
sd_£rv”
);

481 
	`´oxy_cÚÃùiÚ_io_»queue
(
pc
, 
EVENT_READ
, 
es
);

482 
	`´oxy_cÚÃùiÚ_io_»queue
(
ı
, 
EVENT_READ
|
EVENT_WRITE
, 
es
);

484  
Œue
;

485 
	}
}

493 
boŞ


494 
	$cÚŒŞ_mes§ge_äom_·»Á
(cÚ¡ 
sock‘_desütÜ_t
 
sd_cÚŒŞ
,

495 
´oxy_cÚÃùiÚ
 **
li¡
,

496 
ev’t_£t
 *
es
,

497 cÚ¡ 
sockaddr_š
 
£rv”_addr
,

498 cÚ¡ 
max_š™Ÿl_buf
,

499 cÚ¡ *
jouº®_dœ
)

503 
bufãr
 
buf
 = 
	`®loc_buf
(
max_š™Ÿl_buf
);

505 
msghdr
 
mesg
;

506 
cmsghdr
 *
h
;

507 
iovec
 
iov
[2];

508 
commªd
 = 0;

509 
ssize_t
 
¡©us
;

510 
»t
 = 
Œue
;

512 
	`CLEAR
(
mesg
);

514 
iov
[0].
iov_ba£
 = &
commªd
;

515 
iov
[0].
iov_Ën
 = (
commªd
);

516 
iov
[1].
iov_ba£
 = 
	`BPTR
(&
buf
);

517 
iov
[1].
iov_Ën
 = 
	`BCAP
(&
buf
);

518 
mesg
.
msg_iov
 = 
iov
;

519 
mesg
.
msg_iovËn
 = 2;

521 
mesg
.
msg_cÚŒŞËn
 = 
	`cmsg_size
();

522 
mesg
.
msg_cÚŒŞ
 = (*è
	`m®loc
(mesg.
msg_cÚŒŞËn
);

523 
	`check_m®loc_»tuº
(
mesg
.
msg_cÚŒŞ
);

524 
mesg
.
msg_æags
 = 0;

526 
h
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

527 
h
->
cmsg_Ën
 = 
	`CMSG_LEN
((
sock‘_desütÜ_t
));

528 
h
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

529 
h
->
cmsg_ty³
 = 
SCM_RIGHTS
;

530 cÚ¡ 
sock‘_desütÜ_t
 
sock‘_undefšed
 = 
SOCKET_UNDEFINED
;

531 
	`memıy
(
	`CMSG_DATA
(
h
), &
sock‘_undefšed
, (socket_undefined));

533 
¡©us
 = 
	`»cvmsg
(
sd_cÚŒŞ
, &
mesg
, 
MSG_NOSIGNAL
);

534 ià(
¡©us
 != -1)

536 ià(
h
 =ğ
NULL


537 || 
h
->
cmsg_Ën
 !ğ
	`CMSG_LEN
((
sock‘_desütÜ_t
))

538 || 
h
->
cmsg_Ëv–
 !ğ
SOL_SOCKET


539 || 
h
->
cmsg_ty³
 !ğ
SCM_RIGHTS
)

541 
	`msg
(
M_WARN
, "PORT SHARE PROXY:„eceived unknown message");

545 
sock‘_desütÜ_t
 
»ûived_fd
;

546 
	`memıy
(&
»ûived_fd
, 
	`CMSG_DATA
(
h
), (received_fd));

547 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: RECEIVED sd=%d", ()
»ûived_fd
);

549 ià(
¡©us
 >ğ2 && 
commªd
 =ğ
COMMAND_REDIRECT
)

551 
buf
.
Ën
 = 
¡©us
 - 1;

552 ià(
	`´oxy_’Œy_Ãw
(
li¡
,

553 
es
,

554 
£rv”_addr
,

555 
»ûived_fd
,

556 &
buf
,

557 
jouº®_dœ
))

559 
	`CLEAR
(
buf
);

563 
	`İ’v²_şo£_sock‘
(
»ûived_fd
);

566 ià(
¡©us
 >ğ1 && 
commªd
 =ğ
COMMAND_EXIT
)

568 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: RECEIVED COMMAND_EXIT");

569 
	`İ’v²_şo£_sock‘
(
»ûived_fd
);

570 
»t
 = 
çl£
;

574 
	`ä“
(
mesg
.
msg_cÚŒŞ
);

575 
	`ä“_buf
(&
buf
);

576  
»t
;

577 
	}
}

580 
	$´oxy_cÚÃùiÚ_io_»cv
(
´oxy_cÚÃùiÚ
 *
pc
)

583 cÚ¡ 
¡©us
 = 
	`»cv
(
pc
->
sd
, 
	`BPTR
(&pc->
buf
), 
	`BCAP
(&pc->buf), 
MSG_NOSIGNAL
);

584 ià(
¡©us
 < 0)

586  (
”ºo
 =ğ
EAGAIN
è? 
IOSTAT_EAGAIN_ON_READ
 : 
IOSTAT_READ_ERROR
;

590 ià(!
¡©us
)

592  
IOSTAT_READ_ERROR
;

594 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:„—d[%d] %d", ()
pc
->
sd
, 
¡©us
);

595 
pc
->
buf
.
Ën
 = 
¡©us
;

597  
IOSTAT_GOOD
;

598 
	}
}

601 
	$´oxy_cÚÃùiÚ_io_£nd
(
´oxy_cÚÃùiÚ
 *
pc
, *
by‹s_£Á
)

603 cÚ¡ 
sock‘_desütÜ_t
 
sd
 = 
pc
->
couÁ”·¹
->sd;

604 cÚ¡ 
¡©us
 = 
	`£nd
(
sd
, 
	`BPTR
(&
pc
->
buf
), 
	`BLEN
(&pc->buf), 
MSG_NOSIGNAL
);

606 ià(
¡©us
 < 0)

608 cÚ¡ 
e
 = 
”ºo
;

609  (
e
 =ğ
EAGAIN
è? 
IOSTAT_EAGAIN_ON_WRITE
 : 
IOSTAT_WRITE_ERROR
;

613 *
by‹s_£Á
 +ğ
¡©us
;

614 ià(
¡©us
 !ğ
pc
->
buf
.
Ën
)

616 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:…¬tŸÈwr™e[%d],r›d=%d gÙ=%d", ()
sd
, 
pc
->
buf
.
Ën
, 
¡©us
);

617 
	`buf_advªû
(&
pc
->
buf
, 
¡©us
);

618  
IOSTAT_EAGAIN_ON_WRITE
;

622 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY: wrÙe[%d] %d", ()
sd
, 
¡©us
);

623 
pc
->
buf
.
Ën
 = 0;

624 
pc
->
buf
.
off£t
 = 0;

629 ià(
pc
->
bufãr_š™Ÿl
)

631 
	`ä“_buf
(&
pc
->
buf
);

632 
pc
->
buf
 = 
	`®loc_buf
(
PROXY_CONNECTION_BUFFER_SIZE
);

633 
pc
->
bufãr_š™Ÿl
 = 
çl£
;

635  
IOSTAT_GOOD
;

636 
	}
}

643 
	$´oxy_cÚÃùiÚ_io_xãr
(
´oxy_cÚÃùiÚ
 *
pc
, cÚ¡ 
max_Œªsãr
)

645 
Œªsã¼ed
 = 0;

646 
Œªsã¼ed
 < 
max_Œªsãr
)

648 ià(!
	`BLEN
(&
pc
->
buf
))

650 cÚ¡ 
¡©us
 = 
	`´oxy_cÚÃùiÚ_io_»cv
(
pc
);

651 ià(
¡©us
 !ğ
IOSTAT_GOOD
)

653  
¡©us
;

657 ià(
	`BLEN
(&
pc
->
buf
))

659 cÚ¡ 
¡©us
 = 
	`´oxy_cÚÃùiÚ_io_£nd
(
pc
, &
Œªsã¼ed
);

660 ià(
¡©us
 !ğ
IOSTAT_GOOD
)

662  
¡©us
;

666  
IOSTAT_EAGAIN_ON_READ
;

667 
	}
}

672 
boŞ


673 
	$´oxy_cÚÃùiÚ_io_¡©us
(cÚ¡ 
¡©us
, *
rwæags_pc
, *
rwæags_ı
)

675 
¡©us
)

677 
IOSTAT_EAGAIN_ON_READ
:

678 *
rwæags_pc
 |ğ
EVENT_READ
;

679 *
rwæags_ı
 &ğ~
EVENT_WRITE
;

680  
Œue
;

682 
IOSTAT_EAGAIN_ON_WRITE
:

683 *
rwæags_pc
 &ğ~
EVENT_READ
;

684 *
rwæags_ı
 |ğ
EVENT_WRITE
;

685  
Œue
;

687 
IOSTAT_READ_ERROR
:

688  
çl£
;

690 
IOSTAT_WRITE_ERROR
:

691  
çl£
;

694 
	`msg
(
M_FATAL
, "PORT SHARE PROXY: uÃx³ùed stus=%d", 
¡©us
);

696  
çl£
;

697 
	}
}

704 
	$´oxy_cÚÃùiÚ_io_di¥©ch
(
´oxy_cÚÃùiÚ
 *
pc
,

705 cÚ¡ 
rwæags
,

706 
ev’t_£t
 *
es
)

708 cÚ¡ 
max_Œªsãr_³r_™”©iÚ
 = 10000;

709 
´oxy_cÚÃùiÚ
 *
ı
 = 
pc
->
couÁ”·¹
;

710 
rwæags_pc
 = 
pc
->
rwæags
;

711 
rwæags_ı
 = 
ı
->
rwæags
;

713 
	`ASSERT
(
pc
->
defšed
 && 
ı
->defšed && cp->
couÁ”·¹
 ==…c);

715 ià(
rwæags
 & 
EVENT_READ
)

717 cÚ¡ 
¡©us
 = 
	`´oxy_cÚÃùiÚ_io_xãr
(
pc
, 
max_Œªsãr_³r_™”©iÚ
);

718 ià(!
	`´oxy_cÚÃùiÚ_io_¡©us
(
¡©us
, &
rwæags_pc
, &
rwæags_ı
))

720 
bad
;

723 ià(
rwæags
 & 
EVENT_WRITE
)

725 cÚ¡ 
¡©us
 = 
	`´oxy_cÚÃùiÚ_io_xãr
(
ı
, 
max_Œªsãr_³r_™”©iÚ
);

726 ià(!
	`´oxy_cÚÃùiÚ_io_¡©us
(
¡©us
, &
rwæags_ı
, &
rwæags_pc
))

728 
bad
;

731 
	`´oxy_cÚÃùiÚ_io_»queue
(
pc
, 
rwæags_pc
, 
es
);

732 
	`´oxy_cÚÃùiÚ_io_»queue
(
ı
, 
rwæags_ı
, 
es
);

734  
Œue
;

736 
bad
:

737 
	`´oxy_’Œy_m¬k_fÜ_şo£
(
pc
, 
es
);

738  
çl£
;

739 
	}
}

745 
	$pÜt_sh¬e_´oxy
(cÚ¡ 
sockaddr_š
 
ho¡addr
,

746 cÚ¡ 
sock‘_desütÜ_t
 
sd_cÚŒŞ
,

747 cÚ¡ 
max_š™Ÿl_buf
,

748 cÚ¡ *
jouº®_dœ
)

750 ià(
	`£nd_cÚŒŞ
(
sd_cÚŒŞ
, 
RESPONSE_INIT_SUCCEEDED
) >= 0)

752 *
sd_cÚŒŞ_m¬k”
 = (*)1;

753 
maxev’ts
 = 256;

754 
ev’t_£t
 *
es
;

755 
ev’t_£t_»tuº
 
e¤
[64];

756 
´oxy_cÚÃùiÚ
 *
li¡
 = 
NULL
;

757 
time_t
 
Ï¡_hou£k“pšg
 = 0;

759 
	`msg
(
D_PS_PROXY
, "PORT SHARE PROXY:…roxy starting");

761 
es
 = 
	`ev’t_£t_š™
(&
maxev’ts
, 0);

762 
	`ev’t_ùl
(
es
, 
sd_cÚŒŞ
, 
EVENT_READ
, 
sd_cÚŒŞ_m¬k”
);

763 
Œue
)

765 
n_ev’ts
;

766 
timev®
 
tv
;

767 
time_t
 
cu¼’t
;

769 
tv
.
tv_£c
 = 10;

770 
tv
.
tv_u£c
 = 0;

771 
n_ev’ts
 = 
	`ev’t_wa™
(
es
, &
tv
, 
e¤
, 
	`SIZE
(esr));

773 
cu¼’t
 = 
	`time
(
NULL
);

774 ià(
n_ev’ts
 > 0)

776 
i
;

777 
i
 = 0; i < 
n_ev’ts
; ++i)

779 cÚ¡ 
ev’t_£t_»tuº
 *
e
 = &
e¤
[
i
];

780 ià(
e
->
¬g
 =ğ
sd_cÚŒŞ_m¬k”
)

782 ià(!
	`cÚŒŞ_mes§ge_äom_·»Á
(
sd_cÚŒŞ
, &
li¡
, 
es
, 
ho¡addr
, 
max_š™Ÿl_buf
, 
jouº®_dœ
))

784 
dÚe
;

789 
´oxy_cÚÃùiÚ
 *
pc
 = (´oxy_cÚÃùiÚ *)
e
->
¬g
;

790 ià(
pc
->
defšed
)

792 
	`´oxy_cÚÃùiÚ_io_di¥©ch
(
pc
, 
e
->
rwæags
, 
es
);

797 ià(
n_ev’ts
 < 0)

799 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE PROXY:ƒvent_wait failed");

801 ià(
cu¼’t
 > 
Ï¡_hou£k“pšg
)

803 
	`´oxy_li¡_hou£k“pšg
(&
li¡
);

804 
Ï¡_hou£k“pšg
 = 
cu¼’t
;

808 
dÚe
:

809 
	`´oxy_li¡_şo£
(&
li¡
);

810 
	`ev’t_ä“
(
es
);

812 
	`msg
(
M_INFO
, "PORT SHARE PROXY:…roxyƒxiting");

813 
	}
}

819 
pÜt_sh¬e
 *

820 
	$pÜt_sh¬e_İ’
(cÚ¡ *
ho¡
,

821 cÚ¡ *
pÜt
,

822 cÚ¡ 
max_š™Ÿl_buf
,

823 cÚ¡ *
jouº®_dœ
)

825 
pid_t
 
pid
;

826 
sock‘_desütÜ_t
 
fd
[2];

827 
sockaddr_š
 
ho¡addr
;

828 
pÜt_sh¬e
 *
ps
;

829 
¡©us
;

830 
addršfo
 *
ai
;

832 
	`ALLOC_OBJ_CLEAR
(
ps
, 
pÜt_sh¬e
);

833 
ps
->
fÜeground_fd
 = -1;

834 
ps
->
background_pid
 = -1;

840 
¡©us
 = 
	`İ’v²_g‘addršfo
(
GETADDR_RESOLVE
|
GETADDR_FATAL
,

841 
ho¡
, 
pÜt
, 0, 
NULL
, 
AF_INET
, &
ai
);

842 
	`ASSERT
(
¡©us
==0);

843 
ho¡addr
 = *((
sockaddr_š
 *è
ai
->
ai_addr
);

844 
	`ä“addršfo
(
ai
);

850 ià(
	`sock‘·œ
(
PF_UNIX
, 
SOCK_DGRAM
, 0, 
fd
) == -1)

852 
	`msg
(
M_WARN
, "PORT SHARE: socketpair call failed");

853 
”rÜ
;

859 
pid
 = 
	`fÜk
();

861 ià(
pid
)

863 
¡©us
;

869 
ps
->
background_pid
 = 
pid
;

872 
	`İ’v²_şo£_sock‘
(
fd
[1]);

875 
	`£t_şÛxec
(
fd
[0]);

878 
¡©us
 = 
	`»cv_cÚŒŞ
(
fd
[0]);

879 ià(
¡©us
 =ğ
RESPONSE_INIT_SUCCEEDED
)

883 
	`£t_nÚblock
(
fd
[0]);

885 
ps
->
fÜeground_fd
 = 
fd
[0];

886  
ps
;

890 
	`msg
(
M_ERR
, "PORT SHARE: uÃx³ùed in™„ecv_cÚŒŞ stus=%d", 
¡©us
);

900 
	`£t_sigÇls
();

903 
	`msg_fÜked
();

905 #ifdeà
ENABLE_MANAGEMENT


907 
mªagem’t
 = 
NULL
;

911 
	`şo£_fds_exû±
(
fd
[1]);

914 
	`£t_nÚblock
(
fd
[1]);

917 
	`´ng_š™
(
NULL
, 0);

920 
	`pÜt_sh¬e_´oxy
(
ho¡addr
, 
fd
[1], 
max_š™Ÿl_buf
, 
jouº®_dœ
);

922 
	`İ’v²_şo£_sock‘
(
fd
[1]);

924 
	`ex™
(0);

925  
NULL
;

928 
”rÜ
:

929 
	`pÜt_sh¬e_şo£
(
ps
);

930  
NULL
;

931 
	}
}

934 
	$pÜt_sh¬e_şo£
(
pÜt_sh¬e
 *
ps
)

936 ià(
ps
)

938 ià(
ps
->
fÜeground_fd
 >= 0)

941 
	`pÜt_sh¬e_£ndmsg
(
ps
->
fÜeground_fd
, 
COMMAND_EXIT
, 
NULL
, 
SOCKET_UNDEFINED
);

944 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE: waiting for background…rocessoƒxit");

945 ià(
ps
->
background_pid
 > 0)

947 
	`wa™pid
(
ps
->
background_pid
, 
NULL
, 0);

949 
	`dmsg
(
D_PS_PROXY_DEBUG
, "PORT SHARE: background…rocessƒxited");

951 
	`İ’v²_şo£_sock‘
(
ps
->
fÜeground_fd
);

952 
ps
->
fÜeground_fd
 = -1;

955 
	`ä“
(
ps
);

957 
	}
}

960 
	$pÜt_sh¬e_abÜt
(
pÜt_sh¬e
 *
ps
)

962 ià(
ps
)

965 ià(
ps
->
fÜeground_fd
 >= 0)

967 
	`£nd_cÚŒŞ
(
ps
->
fÜeground_fd
, 
COMMAND_EXIT
);

968 
	`İ’v²_şo£_sock‘
(
ps
->
fÜeground_fd
);

969 
ps
->
fÜeground_fd
 = -1;

972 
	}
}

979 
boŞ


980 
	$is_İ’v²_´ÙocŞ
(cÚ¡ 
bufãr
 *
buf
)

982 cÚ¡ *
p
 = (cÚ¡ *è
	`BSTR
(
buf
);

983 cÚ¡ 
Ën
 = 
	`BLEN
(
buf
);

984 ià(
Ën
 >= 3)

986  
p
[0] == 0

987 && 
p
[1] >= 14

988 && 
p
[2] =ğ(
P_CONTROL_HARD_RESET_CLIENT_V2
<<
P_OPCODE_SHIFT
);

990 ià(
Ën
 >= 2)

992  
p
[0] == 0 &&…[1] >= 14;

996  
Œue
;

998 
	}
}

1006 
	$pÜt_sh¬e_»dœeù
(
pÜt_sh¬e
 *
ps
, cÚ¡ 
bufãr
 *
h—d
, 
sock‘_desütÜ_t
 
sd
)

1008 ià(
ps
)

1010 
	`pÜt_sh¬e_£ndmsg
(
ps
->
fÜeground_fd
, 
COMMAND_REDIRECT
, 
h—d
, 
sd
);

1012 
	}
}

	@ps.h

24 #iâdeà
PS_H


25 
	#PS_H


	)

27 #ià
PORT_SHARE


29 
	~"basic.h
"

30 
	~"bufãr.h
"

31 
	~"s¦.h
"

33 (*
	tpo¡_fÜk_ş—nup_func_t
)(*
	t¬g
);

35 
	spÜt_sh¬e
 {

37 
sock‘_desütÜ_t
 
fÜeground_fd
;

40 
pid_t
 
background_pid
;

43 
pÜt_sh¬e
 *port_share;

45 
pÜt_sh¬e
 *
	`pÜt_sh¬e_İ’
(cÚ¡ *
ho¡
,

46 cÚ¡ *
pÜt
,

47 cÚ¡ 
max_š™Ÿl_buf
,

48 cÚ¡ *
jouº®_dœ
);

50 
	`pÜt_sh¬e_şo£
(
pÜt_sh¬e
 *
ps
);

52 
	`pÜt_sh¬e_abÜt
(
pÜt_sh¬e
 *
ps
);

54 
boŞ
 
	`is_İ’v²_´ÙocŞ
(cÚ¡ 
bufãr
 *
buf
);

56 
	`pÜt_sh¬e_»dœeù
(
pÜt_sh¬e
 *
ps
, cÚ¡ 
bufãr
 *
h—d
, 
sock‘_desütÜ_t
 
sd
);

	@push.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"push.h
"

33 
	~"İtiÚs.h
"

34 
	~"s¦.h
"

35 
	~"s¦_v”ify.h
"

36 
	~"mªage.h
"

38 
	~"memdbg.h
"

40 #ià
P2MP


42 
	gpush_»¶y_cmd
[] = "PUSH_REPLY";

51 
	$»ûive_auth_çed
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *buffer)

53 
	`msg
(
M_VERB0
, "AUTH: Reûived cÚŒŞ mes§ge: %s", 
	`BSTR
(
bufãr
));

54 
c
->
İtiÚs
.
no_advªû
 = 
Œue
;

56 ià(
c
->
İtiÚs
.
puÎ
)

63 ià(
	`s¦_ş—n_auth_tok’
())

65 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

66 
c
->
sig
->
sigÇl_‹xt
 = "auth-failure (auth-token)";

70 
	`auth_»Œy_g‘
())

72 
AR_NONE
:

73 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

76 
AR_INTERACT
:

77 
	`s¦_purge_auth
(
çl£
);

79 
AR_NOINTERACT
:

80 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

84 
	`ASSERT
(0);

86 
c
->
sig
->
sigÇl_‹xt
 = "auth-failure";

88 #ifdeà
ENABLE_MANAGEMENT


89 ià(
mªagem’t
)

91 cÚ¡ *
»asÚ
 = 
NULL
;

92 
bufãr
 
buf
 = *buffer;

93 ià(
	`buf_¡ršg_com·»_advªû
(&
buf
, "AUTH_FAILED,"è&& 
	`BLEN
(&buf))

95 
»asÚ
 = 
	`BSTR
(&
buf
);

97 
	`mªagem’t_auth_çu»
(
mªagem’t
, 
UP_TYPE_AUTH
, 
»asÚ
);

104 #ifdeà
ENABLE_CLIENT_CR


105 
bufãr
 
buf
 = *buffer;

106 ià(
	`buf_¡ršg_m©ch_h—d_¡r
(&
buf
, "AUTH_FAILED,CRV1:"è&& 
	`BLEN
(&buf))

108 
	`buf_advªû
(&
buf
, 12);

109 
	`s¦_put_auth_ch®Ënge
(
	`BSTR
(&
buf
));

114 
	}
}

120 
	$£rv”_pushed_sigÇl
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *bufãr, cÚ¡ 
boŞ
 
»¡¬t
, cÚ¡ 
adv
)

122 ià(
c
->
İtiÚs
.
puÎ
)

124 
bufãr
 
buf
 = *buffer;

125 cÚ¡ *
m
 = "";

126 ià(
	`buf_advªû
(&
buf
, 
adv
è&& 
	`buf_»ad_u8
(&bufè=ğ',' && 
	`BLEN
(&buf))

128 
m
 = 
	`BSTR
(&
buf
);

134 
boŞ
 
purge
 = 
Œue
;

136 ià(
m
[0] == '[')

138 
i
;

139 
i
 = 1; 
m
[i] != '\0' && m[i] != ']'; ++i)

141 ià(
m
[
i
] == 'P')

143 
purge
 = 
çl£
;

145 ià(
m
[
i
] == 'N')

148 
c
->
İtiÚs
.
no_advªû
 = 
çl£
;

152 ià(
purge
)

154 
	`s¦_purge_auth
(
Œue
);

158 ià(
»¡¬t
)

160 
	`msg
(
D_STREAM_ERRORS
, "CÚÃùiÚ„e£ˆcommªd wa pushed by s”v” ('%s')", 
m
);

161 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

162 
c
->
sig
->
sigÇl_‹xt
 = "server-pushed-connection-reset";

166 
	`msg
(
D_STREAM_ERRORS
, "H®ˆcommªd wa pushed by s”v” ('%s')", 
m
);

167 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

168 
c
->
sig
->
sigÇl_‹xt
 = "server-pushed-halt";

170 #ifdeà
ENABLE_MANAGEMENT


171 ià(
mªagem’t
)

173 
	`mªagem’t_nÙify
(
mªagem’t
, "šfo", 
c
->
sig
->
sigÇl_‹xt
, 
m
);

177 
	}
}

179 #ià
P2MP_SERVER


194 
boŞ
 
	$push_İtiÚ_fmt
(
gc_¬’a
 *
gc
, 
push_li¡
 *push_list,

195 
msgËv–
, cÚ¡ *
fmt
, ...)

196 #ifdeà
__GNUC__


197 #ià
__USE_MINGW_ANSI_STDIO


198 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 4, 5)))

200 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 4, 5)))

209 
	$£nd_auth_çed
(
cÚ‹xt
 *
c
, cÚ¡ *
ş›Á_»asÚ
)

211 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

212 cÚ¡ 
auth_çed
[] = "AUTH_FAILED";

213 
size_t
 
Ën
;

215 
	`scheduË_ex™
(
c
, c->
İtiÚs
.
scheduËd_ex™_š‹rv®
, 
SIGTERM
);

217 
Ën
 = (
ş›Á_»asÚ
 ? 
	`¡¾’
(ş›Á_»asÚ)+1 : 0è+ (
auth_çed
);

218 ià(
Ën
 > 
PUSH_BUNDLE_SIZE
)

220 
Ën
 = 
PUSH_BUNDLE_SIZE
;

224 
bufãr
 
buf
 = 
	`®loc_buf_gc
(
Ën
, &
gc
);

225 
	`buf_´štf
(&
buf
, 
auth_çed
);

226 ià(
ş›Á_»asÚ
)

228 
	`buf_´štf
(&
buf
, ",%s", 
ş›Á_»asÚ
);

230 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, 
	`BSTR
(&
buf
), 
D_PUSH
);

233 
	`gc_ä“
(&
gc
);

234 
	}
}

240 
	$£nd_»¡¬t
(
cÚ‹xt
 *
c
, cÚ¡ *
kl_msg
)

242 
	`scheduË_ex™
(
c
, c->
İtiÚs
.
scheduËd_ex™_š‹rv®
, 
SIGTERM
);

243 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, 
kl_msg
 ? kl_msg : "RESTART", 
D_PUSH
);

244 
	}
}

253 
	$šcomšg_push_mes§ge
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *buffer)

255 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

256 
İtiÚ_ty³s_found
 = 0;

257 
¡©us
;

259 
	`msg
(
D_PUSH
, "PUSH: Reûived cÚŒŞ mes§ge: '%s'", 
	`§n™ize_cÚŒŞ_mes§ge
(
	`BSTR
(
bufãr
), &
gc
));

261 
¡©us
 = 
	`´oûss_šcomšg_push_msg
(
c
,

262 
bufãr
,

263 
c
->
İtiÚs
.
puÎ
,

264 
	`puÎ_³rmissiÚ_mask
(
c
),

265 &
İtiÚ_ty³s_found
);

267 ià(
¡©us
 =ğ
PUSH_MSG_ERROR
)

269 
	`msg
(
D_PUSH_ERRORS
, "WARNING: Reûived bad…ush/puÎ mes§ge: %s", 
	`§n™ize_cÚŒŞ_mes§ge
(
	`BSTR
(
bufãr
), &
gc
));

271 ià(
¡©us
 =ğ
PUSH_MSG_REPLY
 || stu =ğ
PUSH_MSG_CONTINUATION
)

273 
c
->
İtiÚs
.
push_İtiÚ_ty³s_found
 |ğ
İtiÚ_ty³s_found
;

276 ià(
¡©us
 =ğ
PUSH_MSG_REPLY
)

278 ià(!
	`do_up
(
c
, 
Œue
, c->
İtiÚs
.
push_İtiÚ_ty³s_found
))

280 
	`msg
(
D_PUSH_ERRORS
, "Failedo openun/tap interface");

281 
”rÜ
;

284 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
push_»que¡_š‹rv®
);

286 ià(
¡©us
 =ğ
PUSH_MSG_REQUEST
)

288 ià(
c
->
İtiÚs
.
mode
 =ğ
MODE_SERVER
)

290 
s_£ssiÚ
 *
£ssiÚ
 = &
c
->
c2
.
s_muÉi
->£ssiÚ[
TM_ACTIVE
];

292 ià(!
£ssiÚ
->
key
[
KS_PRIMARY
].
üy±o_İtiÚs
.
key_ùx_bi
.
š™Ÿlized


293 && !
	`s_£ssiÚ_upd©e_üy±o_·¿ms
(
£ssiÚ
, &
c
->
İtiÚs
,

294 &
c
->
c2
.
äame
))

296 
	`msg
(
D_TLS_ERRORS
, "TLS Error: initializing data channel failed");

297 
”rÜ
;

302 
ş—nup
;

303 
”rÜ
:

304 
	`»gi¡”_sigÇl
(
c
, 
SIGUSR1
, "process-push-msg-failed");

305 
ş—nup
:

306 
	`gc_ä“
(&
gc
);

307 
	}
}

309 
boŞ


310 
	$£nd_push_»que¡
(
cÚ‹xt
 *
c
)

312 cÚ¡ 
max_push_»que¡s
 = 
c
->
İtiÚs
.
hªdshake_wšdow
 / 
PUSH_REQUEST_INTERVAL
;

313 ià(++
c
->
c2
.
n_£Á_push_»que¡s
 <ğ
max_push_»que¡s
)

315  
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, "PUSH_REQUEST", 
D_PUSH
);

319 
	`msg
(
D_STREAM_ERRORS
, "NØ»¶y from s”v”‡á” s’dšg %d…ush„eque¡s", 
max_push_»que¡s
);

320 
c
->
sig
->
sigÇl_»ûived
 = 
SIGUSR1
;

321 
c
->
sig
->
sigÇl_‹xt
 = "no-push-reply";

322  
çl£
;

324 
	}
}

326 #ià
P2MP_SERVER


337 
boŞ


338 
	$´•¬e_push_»¶y
(
cÚ‹xt
 *
c
, 
gc_¬’a
 *
gc
,

339 
push_li¡
 *push_list)

341 cÚ¡ *
İt¡r
 = 
NULL
;

342 
s_muÉi
 *s_muÉ˜ğ
c
->
c2
.tls_multi;

343 cÚ¡ *cÚ¡ 
³”_šfo
 = 
s_muÉi
->peer_info;

344 
İtiÚs
 *
o
 = &
c
->options;

347 ià(
c
->
c2
.
push_ifcÚfig_v6_defšed
 && !
o
->
push_ifcÚfig_v6_blocked
)

349 
	`push_İtiÚ_fmt
(
gc
, 
push_li¡
, 
M_USAGE
, "ifconfig-ipv6 %s/%d %s",

350 
	`´št_š6_addr
(
c
->
c2
.
push_ifcÚfig_v6_loÿl
, 0, 
gc
),

351 
c
->
c2
.
push_ifcÚfig_v6_Ãtb™s
,

352 
	`´št_š6_addr
(
c
->
c2
.
push_ifcÚfig_v6_»mÙe
,

353 0, 
gc
));

357 ià(
c
->
c2
.
push_ifcÚfig_defšed
 && c->c2.
push_ifcÚfig_loÿl


358 && 
c
->
c2
.
push_ifcÚfig_»mÙe_Ãtmask
)

360 
š_addr_t
 
ifcÚfig_loÿl
 = 
c
->
c2
.
push_ifcÚfig_loÿl
;

361 ià(
c
->
c2
.
push_ifcÚfig_loÿl_®Ÿs
)

363 
ifcÚfig_loÿl
 = 
c
->
c2
.
push_ifcÚfig_loÿl_®Ÿs
;

365 
	`push_İtiÚ_fmt
(
gc
, 
push_li¡
, 
M_USAGE
, "ifconfig %s %s",

366 
	`´št_š_addr_t
(
ifcÚfig_loÿl
, 0, 
gc
),

367 
	`´št_š_addr_t
(
c
->
c2
.
push_ifcÚfig_»mÙe_Ãtmask
,

368 0, 
gc
));

372 
İt¡r
 = 
³”_šfo
 ? 
	`¡r¡r
Õ“r_šfo, "IV_PROTO="è: 
NULL
;

373 ià(
İt¡r
)

375 
´Ùo
 = 0;

376 
r
 = 
	`ssÿnf
(
İt¡r
, "IV_PROTO=%d", &
´Ùo
);

377 ià((
r
 =ğ1è&& (
´Ùo
 >= 2))

379 
	`push_İtiÚ_fmt
(
gc
, 
push_li¡
, 
M_USAGE
, "peer-id %d",

380 
s_muÉi
->
³”_id
);

381 
s_muÉi
->
u£_³”_id
 = 
Œue
;

386 ià(
	`s_³”_šfo_nı_v”
(
³”_šfo
è>ğ2 && 
o
->
nı_’abËd
)

392 cÚ¡ 
s_£ssiÚ
 *
£ssiÚ
 = &
s_muÉi
->£ssiÚ[
TM_ACTIVE
];

393 ià(
£ssiÚ
->
key
[
KS_PRIMARY
].
üy±o_İtiÚs
.
key_ùx_bi
.
š™Ÿlized
)

395 
	`msg
Ğ
M_INFO
, "PUSH: client wantso‚egotiate cipher (NCP), but "

398 
o
->
ch”Çme
 );

404 *
push_ch”
 = 
	`¡ršg_®loc
(
o
->
nı_ch”s
, &o->
gc
);

405 
o
->
ch”Çme
 = 
	`¡¹ok
(
push_ch”
, ":");

407 
	`push_İtiÚ_fmt
(
gc
, 
push_li¡
, 
M_USAGE
, "ch” %s", 
o
->
ch”Çme
);

409 ià(
o
->
nı_’abËd
)

411 
	`s_poÜ_mªs_nı
(
o
, 
s_muÉi
->
»mÙe_ch”Çme
);

417 ià(
çl£
 =ğ
s_muÉi
->
auth_tok’_£Á
 && 
NULL
 !ğs_muÉi->
auth_tok’
)

419 
	`push_İtiÚ_fmt
(
gc
, 
push_li¡
, 
M_USAGE
,

420 "auth-tok’ %s", 
s_muÉi
->
auth_tok’
);

421 
s_muÉi
->
auth_tok’_£Á
 = 
Œue
;

423  
Œue
;

424 
	}
}

426 
boŞ


427 
	$£nd_push_İtiÚs
(
cÚ‹xt
 *
c
, 
bufãr
 *
buf
,

428 
push_li¡
 *push_li¡, 
§ã_ÿp
,

429 
boŞ
 *
push_£Á
, boŞ *
muÉi_push
)

431 
push_’Œy
 *
e
 = 
push_li¡
->
h—d
;

433 
e
)

435 ià(
e
->
’abË
)

437 cÚ¡ 
l
 = 
	`¡¾’
(
e
->
İtiÚ
);

438 ià(
	`BLEN
(
buf
è+ 
l
 >ğ
§ã_ÿp
)

440 
	`buf_´štf
(
buf
, ",push-continuation 2");

442 cÚ¡ 
boŞ
 
¡©us
 = 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, 
	`BSTR
(
buf
), 
D_PUSH
);

443 ià(!
¡©us
)

445  
çl£
;

447 *
push_£Á
 = 
Œue
;

448 *
muÉi_push
 = 
Œue
;

449 
	`buf_»£t_Ën
(
buf
);

450 
	`buf_´štf
(
buf
, "%s", 
push_»¶y_cmd
);

453 ià(
	`BLEN
(
buf
è+ 
l
 >ğ
§ã_ÿp
)

455 
	`msg
(
M_WARN
, "--push option isoo†ong");

456  
çl£
;

458 
	`buf_´štf
(
buf
, ",%s", 
e
->
İtiÚ
);

460 
e
 =ƒ->
Ãxt
;

462  
Œue
;

463 
	}
}

465 
boŞ


466 
	$£nd_push_»¶y
(
cÚ‹xt
 *
c
, 
push_li¡
 *
³r_ş›Á_push_li¡
)

468 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

469 
bufãr
 
buf
 = 
	`®loc_buf_gc
(
PUSH_BUNDLE_SIZE
, &
gc
);

470 
boŞ
 
muÉi_push
 = 
çl£
;

471 cÚ¡ 
exŒa
 = 84;

472 cÚ¡ 
§ã_ÿp
 = 
	`BCAP
(&
buf
è- 
exŒa
;

473 
boŞ
 
push_£Á
 = 
çl£
;

475 
	`buf_´štf
(&
buf
, "%s", 
push_»¶y_cmd
);

478 ià(!
	`£nd_push_İtiÚs
(
c
, &
buf
, &c->
İtiÚs
.
push_li¡
, 
§ã_ÿp
,

479 &
push_£Á
, &
muÉi_push
))

481 
ç
;

485 ià(!
	`£nd_push_İtiÚs
(
c
, &
buf
, 
³r_ş›Á_push_li¡
, 
§ã_ÿp
,

486 &
push_£Á
, &
muÉi_push
))

488 
ç
;

491 ià(
muÉi_push
)

493 
	`buf_´štf
(&
buf
, ",push-continuation 1");

496 ià(
	`BLEN
(&
buf
è> (
push_»¶y_cmd
)-1)

498 cÚ¡ 
boŞ
 
¡©us
 = 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, 
	`BSTR
(&
buf
), 
D_PUSH
);

499 ià(!
¡©us
)

501 
ç
;

503 
push_£Á
 = 
Œue
;

509 ià(!
push_£Á
)

511 
boŞ
 
¡©us
 = 
çl£
;

513 
	`buf_»£t_Ën
(&
buf
);

514 
	`buf_´štf
(&
buf
, "%s", 
push_»¶y_cmd
);

515 
¡©us
 = 
	`£nd_cÚŒŞ_chªÃl_¡ršg
(
c
, 
	`BSTR
(&
buf
), 
D_PUSH
);

516 ià(!
¡©us
)

518 
ç
;

522 
	`gc_ä“
(&
gc
);

523  
Œue
;

525 
ç
:

526 
	`gc_ä“
(&
gc
);

527  
çl£
;

528 
	}
}

531 
	$push_İtiÚ_ex
(
gc_¬’a
 *
gc
, 
push_li¡
 *push_list,

532 cÚ¡ *
İt
, 
boŞ
 
’abË
, 
msgËv–
)

534 ià(!
	`¡ršg_şass
(
İt
, 
CC_ANY
, 
CC_COMMA
))

536 
	`msg
(
msgËv–
, "PUSH OPTION FAILED (Ëg® comm¨(','èš sŒšg): '%s'", 
İt
);

540 
push_’Œy
 *
e
;

541 
	`ALLOC_OBJ_CLEAR_GC
(
e
, 
push_’Œy
, 
gc
);

542 
e
->
’abË
 = 
Œue
;

543 
e
->
İtiÚ
 = 
İt
;

544 ià(
push_li¡
->
h—d
)

546 
	`ASSERT
(
push_li¡
->

);

547 
push_li¡
->

->
Ãxt
 = 
e
;

548 
push_li¡
->

 = 
e
;

552 
	`ASSERT
(!
push_li¡
->

);

553 
push_li¡
->
h—d
 = 
e
;

554 
push_li¡
->

 = 
e
;

557 
	}
}

560 
	$push_İtiÚ
(
İtiÚs
 *
o
, cÚ¡ *
İt
, 
msgËv–
)

562 
	`push_İtiÚ_ex
(&
o
->
gc
, &o->
push_li¡
, 
İt
, 
Œue
, 
msgËv–
);

563 
	}
}

566 
	$şÚe_push_li¡
(
İtiÚs
 *
o
)

568 ià(
o
->
push_li¡
.
h—d
)

570 cÚ¡ 
push_’Œy
 *
e
 = 
o
->
push_li¡
.
h—d
;

571 
	`push_»£t
(
o
);

572 
e
)

574 
	`push_İtiÚ_ex
(&
o
->
gc
, &o->
push_li¡
,

575 
	`¡ršg_®loc
(
e
->
İtiÚ
, &
o
->
gc
), 
Œue
, 
M_FATAL
);

576 
e
 =ƒ->
Ãxt
;

579 
	}
}

582 
	$push_İtiÚs
(
İtiÚs
 *
o
, **
p
, 
msgËv–
, 
gc_¬’a
 *
gc
)

584 cÚ¡ **
¬gv
 = 
	`make_ex‹nded_¬g_¬¿y
(
p
, 
gc
);

585 *
İt
 = 
	`´št_¬gv
(
¬gv
, 
gc
, 0);

586 
	`push_İtiÚ
(
o
, 
İt
, 
msgËv–
);

587 
	}
}

589 
boŞ


590 
	$push_İtiÚ_fmt
(
gc_¬’a
 *
gc
, 
push_li¡
 *push_list,

591 
msgËv–
, cÚ¡ *
fÜm©
, ...)

593 
va_li¡
 
¬gli¡
;

594 
tmp
[256] = {0};

595 
Ën
;

596 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

597 
Ën
 = 
	`v¢´štf
(
tmp
, Ñmp), 
fÜm©
, 
¬gli¡
);

598 
	`va_’d
(
¬gli¡
);

599 ià(
Ën
 > (
tmp
)-1)

601  
çl£
;

603 
	`push_İtiÚ_ex
(
gc
, 
push_li¡
, 
	`¡ršg_®loc
(
tmp
, gc), 
Œue
, 
msgËv–
);

604  
Œue
;

605 
	}
}

608 
	$push_»£t
(
İtiÚs
 *
o
)

610 
	`CLEAR
(
o
->
push_li¡
);

611 
	}
}

614 
	$push_»move_İtiÚ
(
İtiÚs
 *
o
, cÚ¡ *
p
)

616 
	`msg
(
D_PUSH_DEBUG
, "PUSH_REMOVE s—rchšg fÜ: '%s'", 
p
);

619 ià(
	`¡»q
Ğ
p
, "ifconfig-ipv6" ))

621 
o
->
push_ifcÚfig_v6_blocked
 = 
Œue
;

625 ià(
o
 && o->
push_li¡
.
h—d
)

627 
push_’Œy
 *
e
 = 
o
->
push_li¡
.
h—d
;

630 
e
)

632 ià(
e
->
’abË


633 && 
	`¡ºcmp
Ğ
e
->
İtiÚ
, 
p
, 
	`¡¾’
(p) ) == 0)

635 
	`msg
(
D_PUSH_DEBUG
, "PUSH_REMOVE„emovšg: '%s'", 
e
->
İtiÚ
);

636 
e
->
’abË
 = 
çl£
;

639 
e
 =ƒ->
Ãxt
;

642 
	}
}

645 #ià
P2MP_SERVER


647 
	$´oûss_šcomšg_push_»que¡
(
cÚ‹xt
 *
c
)

649 
»t
 = 
PUSH_MSG_ERROR
;

651 #ifdeà
ENABLE_ASYNC_PUSH


652 
c
->
c2
.
push_»que¡_»ûived
 = 
Œue
;

654 ià(
	`s_auth’tiÿtiÚ_¡©us
(
c
->
c2
.
s_muÉi
, 0è=ğ
TLS_AUTHENTICATION_FAILED
 || c->c2.
cÚ‹xt_auth
 =ğ
CAS_FAILED
)

656 cÚ¡ *
ş›Á_»asÚ
 = 
	`s_ş›Á_»asÚ
(
c
->
c2
.
s_muÉi
);

657 
	`£nd_auth_çed
(
c
, 
ş›Á_»asÚ
);

658 
»t
 = 
PUSH_MSG_AUTH_FAILURE
;

660 ià(!
c
->
c2
.
push_»¶y_deã¼ed
 && c->c2.
cÚ‹xt_auth
 =ğ
CAS_SUCCEEDED
)

662 
time_t
 
now
;

664 
	`İ’v²_time
(&
now
);

665 ià(
c
->
c2
.
£Á_push_»¶y_expœy
 > 
now
)

667 
»t
 = 
PUSH_MSG_ALREADY_REPLIED
;

672 
push_li¡
…ush_list;

673 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

675 
	`CLEAR
(
push_li¡
);

676 ià(
	`´•¬e_push_»¶y
(
c
, &
gc
, &
push_li¡
)

677 && 
	`£nd_push_»¶y
(
c
, &
push_li¡
))

679 
»t
 = 
PUSH_MSG_REQUEST
;

680 
c
->
c2
.
£Á_push_»¶y_expœy
 = 
now
 + 30;

682 
	`gc_ä“
(&
gc
);

687 
»t
 = 
PUSH_MSG_REQUEST_DEFERRED
;

690  
»t
;

691 
	}
}

695 
	$push_upd©e_dige¡
(
md_ùx_t
 *
ùx
, 
bufãr
 *
buf
, cÚ¡ 
İtiÚs
 *
İt
)

697 
lše
[
OPTION_PARM_SIZE
];

698 
	`buf_·r£
(
buf
, ',', 
lše
, (line)))

701 ià(
	`¡½»fix
(
lše
, "peer-id "))

706 ià(
	`¡½»fix
(
lše
, "ch” "è&& !
İt
->
û
.
tun_mtu_defšed
)

710 
	`md_ùx_upd©e
(
ùx
, (cÚ¡ 
ušt8_t
 *è
lše
, 
	`¡¾’
(line)+1);

712 
	}
}

715 
	$´oûss_šcomšg_push_msg
(
cÚ‹xt
 *
c
,

716 cÚ¡ 
bufãr
 *buffer,

717 
boŞ
 
hÚÜ_»ûived_İtiÚs
,

718 
³rmissiÚ_mask
,

719 *
İtiÚ_ty³s_found
)

721 
»t
 = 
PUSH_MSG_ERROR
;

722 
bufãr
 
buf
 = *buffer;

724 #ià
P2MP_SERVER


725 ià(
	`buf_¡ršg_com·»_advªû
(&
buf
, "PUSH_REQUEST"))

727 
»t
 = 
	`´oûss_šcomšg_push_»que¡
(
c
);

732 ià(
hÚÜ_»ûived_İtiÚs
 && 
	`buf_¡ršg_com·»_advªû
(&
buf
, "PUSH_REPLY"))

734 cÚ¡ 
ušt8_t
 
ch
 = 
	`buf_»ad_u8
(&
buf
);

735 ià(
ch
 == ',')

737 
bufãr
 
buf_Üig
 = 
buf
;

738 ià(!
c
->
c2
.
puÎed_İtiÚs_dige¡_š™_dÚe
)

740 
c
->
c2
.
puÎed_İtiÚs_¡©e
 = 
	`md_ùx_Ãw
();

741 
	`md_ùx_š™
(
c
->
c2
.
puÎed_İtiÚs_¡©e
, 
	`md_kt_g‘
("SHA256"));

742 
c
->
c2
.
puÎed_İtiÚs_dige¡_š™_dÚe
 = 
Œue
;

744 ià(!
c
->
c2
.
did_´e_puÎ_»¡Üe
)

746 
	`´e_puÎ_»¡Üe
(&
c
->
İtiÚs
, &c->
c2
.
gc
);

747 
c
->
c2
.
did_´e_puÎ_»¡Üe
 = 
Œue
;

749 ià(
	`­¶y_push_İtiÚs
(&
c
->
İtiÚs
,

750 &
buf
,

751 
³rmissiÚ_mask
,

752 
İtiÚ_ty³s_found
,

753 
c
->
c2
.
es
))

755 
	`push_upd©e_dige¡
(
c
->
c2
.
puÎed_İtiÚs_¡©e
, &
buf_Üig
,

756 &
c
->
İtiÚs
);

757 
c
->
İtiÚs
.
push_cÚtšu©iÚ
)

761 
	`md_ùx_fš®
(
c
->
c2
.
puÎed_İtiÚs_¡©e
, c->c2.
puÎed_İtiÚs_dige¡
.
dige¡
);

762 
	`md_ùx_ş—nup
(
c
->
c2
.
puÎed_İtiÚs_¡©e
);

763 
	`md_ùx_ä“
(
c
->
c2
.
puÎed_İtiÚs_¡©e
);

764 
c
->
c2
.
puÎed_İtiÚs_¡©e
 = 
NULL
;

765 
c
->
c2
.
puÎed_İtiÚs_dige¡_š™_dÚe
 = 
çl£
;

766 
»t
 = 
PUSH_MSG_REPLY
;

770 
»t
 = 
PUSH_MSG_CONTINUATION
;

775 ià(
ch
 == '\0')

777 
»t
 = 
PUSH_MSG_REPLY
;

781  
»t
;

782 
	}
}

784 #ià
P2MP_SERVER


790 
	$»move_œou‹s_äom_push_rou‹_li¡
(
İtiÚs
 *
o
)

792 ià(
o
 && o->
push_li¡
.
h—d
 && o->
œou‹s
)

794 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

795 
push_’Œy
 *
e
 = 
o
->
push_li¡
.
h—d
;

798 
e
)

800 *
p
[
MAX_PARMS
];

801 
boŞ
 
’abË
 = 
Œue
;

804 
	`CLEAR
(
p
);

805 ià(
e
->
’abË


806 && 
	`·r£_lše
(
e
->
İtiÚ
, 
p
, 
	`SIZE
Õ), "[PUSH_ROUTE_REMOVE]", 1, 
D_ROUTE_DEBUG
, &
gc
))

809 ià(
p
[0] && !
	`¡rcmp
(p[0], "route") && !p[3])

812 
boŞ
 
¡©us1
, 
¡©us2
;

813 cÚ¡ 
š_addr_t
 
ÃtwÜk
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
p
[1], 0, &
¡©us1
, 
NULL
);

814 cÚ¡ 
š_addr_t
 
Ãtmask
 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
p
[2] ?…[2] : "255.255.255.255", 0, &
¡©us2
, 
NULL
);

817 ià(
¡©us1
 && 
¡©us2
)

819 cÚ¡ 
œou‹
 *
œ
;

822 
œ
 = 
o
->
œou‹s
; i¸!ğ
NULL
; i¸ğœ->
Ãxt
)

824 ià(
ÃtwÜk
 =ğ
œ
->ÃtwÜk && 
Ãtmask
 =ğ
	`Ãtb™s_to_Ãtmask
(œ->
Ãtb™s
 >= 0 ? ir->netbits : 32))

826 
’abË
 = 
çl£
;

834 
e
->
’abË
 =ƒnable;

835 ià(!
’abË
)

837 
	`msg
(
D_PUSH
, "REMOVE PUSH ROUTE: '%s'", 
e
->
İtiÚ
);

841 
e
 =ƒ->
Ãxt
;

844 
	`gc_ä“
(&
gc
);

846 
	}
}

	@push.h

24 #iâdeà
PUSH_H


25 
	#PUSH_H


	)

27 #ià
P2MP


29 
	~"fÜw¬d.h
"

31 
	#PUSH_MSG_ERROR
 0

	)

32 
	#PUSH_MSG_REQUEST
 1

	)

33 
	#PUSH_MSG_REPLY
 2

	)

34 
	#PUSH_MSG_REQUEST_DEFERRED
 3

	)

35 
	#PUSH_MSG_AUTH_FAILURE
 4

	)

36 
	#PUSH_MSG_CONTINUATION
 5

	)

37 
	#PUSH_MSG_ALREADY_REPLIED
 6

	)

39 
´oûss_šcomšg_push_»que¡
(
cÚ‹xt
 *
c
);

41 
´oûss_šcomšg_push_msg
(
cÚ‹xt
 *
c
,

42 cÚ¡ 
bufãr
 *buffer,

43 
boŞ
 
hÚÜ_»ûived_İtiÚs
,

44 
³rmissiÚ_mask
,

45 *
İtiÚ_ty³s_found
);

47 
boŞ
 
£nd_push_»que¡
(
cÚ‹xt
 *
c
);

49 
»ûive_auth_çed
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *buffer);

51 
£rv”_pushed_sigÇl
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *bufãr, cÚ¡ 
boŞ
 
»¡¬t
, cÚ¡ 
adv
);

53 
šcomšg_push_mes§ge
(
cÚ‹xt
 *
c
, cÚ¡ 
bufãr
 *buffer);

55 #ià
P2MP_SERVER


56 
şÚe_push_li¡
(
İtiÚs
 *
o
);

58 
push_İtiÚ
(
İtiÚs
 *
o
, cÚ¡ *
İt
, 
msgËv–
);

60 
push_İtiÚs
(
İtiÚs
 *
o
, **
p
, 
msgËv–
, 
gc_¬’a
 *
gc
);

62 
push_»£t
(
İtiÚs
 *
o
);

64 
push_»move_İtiÚ
(
İtiÚs
 *
o
, cÚ¡ *
p
);

66 
»move_œou‹s_äom_push_rou‹_li¡
(
İtiÚs
 *
o
);

68 
£nd_auth_çed
(
cÚ‹xt
 *
c
, cÚ¡ *
ş›Á_»asÚ
);

70 
£nd_»¡¬t
(
cÚ‹xt
 *
c
, cÚ¡ *
kl_msg
);

	@pushlist.h

24 #ià!
defšed
(
PUSHLIST_H
è&& 
P2MP
 && 
P2MP_SERVER


25 
	#PUSHLIST_H


	)

29 
	spush_’Œy
 {

30 
push_’Œy
 *
	mÃxt
;

31 
boŞ
 
	m’abË
;

32 cÚ¡ *
	mİtiÚ
;

35 
	spush_li¡
 {

36 
push_’Œy
 *
	mh—d
;

37 
push_’Œy
 *
	m
;

	@reliable.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ifdeà
ENABLE_CRYPTO


39 
	~"bufãr.h
"

40 
	~"”rÜ.h
"

41 
	~"commÚ.h
"

42 
	~"»lŸbË.h
"

44 
	~"memdbg.h
"

49 
šlše
 
boŞ


50 
	$»lŸbË_pid_š_¿nge1
(cÚ¡ 
·ck‘_id_ty³
 
‹¡
,

51 cÚ¡ 
·ck‘_id_ty³
 
ba£
,

52 cÚ¡ 
ex‹Á
)

54 ià(
‹¡
 >ğ
ba£
)

56 ià(
‹¡
 - 
ba£
 < 
ex‹Á
)

58  
Œue
;

63 ià((
‹¡
+0x80000000uè- (
ba£
+0x80000000uè< 
ex‹Á
)

65  
Œue
;

69  
çl£
;

70 
	}
}

75 
šlše
 
boŞ


76 
	$»lŸbË_pid_š_¿nge2
(cÚ¡ 
·ck‘_id_ty³
 
‹¡
,

77 cÚ¡ 
·ck‘_id_ty³
 
ba£
,

78 cÚ¡ 
ex‹Á
)

80 ià(
ba£
 + 
ex‹Á
 >= base)

82 ià(
‹¡
 < 
ba£
 + 
ex‹Á
)

84  
Œue
;

89 ià((
‹¡
+0x80000000uè< (
ba£
+0x80000000uè+ 
ex‹Á
)

91  
Œue
;

95  
çl£
;

96 
	}
}

101 
šlše
 
boŞ


102 
	$»lŸbË_pid_mš
(cÚ¡ 
·ck‘_id_ty³
 
p1
,

103 cÚ¡ 
·ck‘_id_ty³
 
p2
)

105  !
	`»lŸbË_pid_š_¿nge1
(
p1
, 
p2
, 0x80000000u);

106 
	}
}

109 
šlše
 
boŞ


110 
	$»lŸbË_ack_·ck‘_id_´e£Á
(
»lŸbË_ack
 *
ack
, 
·ck‘_id_ty³
 
pid
)

112 
i
;

113 
i
 = 0; i < 
ack
->
Ën
; ++i)

115 ià(
ack
->
·ck‘_id
[
i
] =ğ
pid
)

117  
Œue
;

120  
çl£
;

121 
	}
}

124 
boŞ


125 
	$»lŸbË_ack_»ad_·ck‘_id
(
bufãr
 *
buf
, 
·ck‘_id_ty³
 *
pid
)

127 
·ck‘_id_ty³
 
Ãt_pid
;

129 ià(
	`buf_»ad
(
buf
, &
Ãt_pid
, (net_pid)))

131 *
pid
 = 
	`Áohpid
(
Ãt_pid
);

132 
	`dmsg
(
D_REL_DEBUG
, "ACK„—d ID " 
·ck‘_id_fÜm©
 " (buf->len=%d)",

133 (
·ck‘_id_´št_ty³
)*
pid
, 
buf
->
Ën
);

134  
Œue
;

137 
	`dmsg
(
D_REL_LOW
, "ACK„—d ID FAILED (buf->Ën=%d)", 
buf
->
Ën
);

138  
çl£
;

139 
	}
}

142 
boŞ


143 
	$»lŸbË_ack_acknowËdge_·ck‘_id
(
»lŸbË_ack
 *
ack
, 
·ck‘_id_ty³
 
pid
)

145 ià(!
	`»lŸbË_ack_·ck‘_id_´e£Á
(
ack
, 
pid
è&&‡ck->
Ën
 < 
RELIABLE_ACK_SIZE
)

147 
ack
->
·ck‘_id
[ack->
Ën
++] = 
pid
;

148 
	`dmsg
(
D_REL_DEBUG
, "ACK‡cknowËdgID " 
·ck‘_id_fÜm©
 " (ack->len=%d)",

149 (
·ck‘_id_´št_ty³
)
pid
, 
ack
->
Ën
);

150  
Œue
;

153 
	`dmsg
(
D_REL_LOW
, "ACK‡cknowËdgID " 
·ck‘_id_fÜm©
 " FAILED (ack->len=%d)",

154 (
·ck‘_id_´št_ty³
)
pid
, 
ack
->
Ën
);

155  
çl£
;

156 
	}
}

159 
boŞ


160 
	$»lŸbË_ack_»ad
(
»lŸbË_ack
 *
ack
,

161 
bufãr
 *
buf
, cÚ¡ 
£ssiÚ_id
 *
sid
)

163 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

164 
i
;

165 
ušt8_t
 
couÁ
;

166 
·ck‘_id_ty³
 
Ãt_pid
;

167 
·ck‘_id_ty³
 
pid
;

168 
£ssiÚ_id
 
£ssiÚ_id_»mÙe
;

170 ià(!
	`buf_»ad
(
buf
, &
couÁ
, (count)))

172 
”rÜ
;

174 
i
 = 0; i < 
couÁ
; ++i)

176 ià(!
	`buf_»ad
(
buf
, &
Ãt_pid
, (net_pid)))

178 
”rÜ
;

180 ià(
ack
->
Ën
 >ğ
RELIABLE_ACK_SIZE
)

182 
”rÜ
;

184 
pid
 = 
	`Áohpid
(
Ãt_pid
);

185 
ack
->
·ck‘_id
[ack->
Ën
++] = 
pid
;

187 ià(
couÁ
)

189 ià(!
	`£ssiÚ_id_»ad
(&
£ssiÚ_id_»mÙe
, 
buf
))

191 
”rÜ
;

193 ià(!
	`£ssiÚ_id_defšed
(&
£ssiÚ_id_»mÙe
)

194 || !
	`£ssiÚ_id_equ®
(&
£ssiÚ_id_»mÙe
, 
sid
))

196 
	`dmsg
(
D_REL_LOW
,

198 
	`£ssiÚ_id_´št
(
sid
, &
gc
), sessiÚ_id_´št(&
£ssiÚ_id_»mÙe
, &gc));

199 
”rÜ
;

202 
	`gc_ä“
(&
gc
);

203  
Œue
;

205 
”rÜ
:

206 
	`gc_ä“
(&
gc
);

207  
çl£
;

208 
	}
}

210 
	#ACK_SIZE
(
n
è((
ušt8_t
è+ (Òè? 
SID_SIZE
 : 0è+ (
·ck‘_id_ty³
è* (n))

	)

214 
boŞ


215 
	$»lŸbË_ack_wr™e
(
»lŸbË_ack
 *
ack
,

216 
bufãr
 *
buf
,

217 cÚ¡ 
£ssiÚ_id
 *
sid
, 
max
, 
boŞ
 
´•’d
)

219 
i
, 
j
;

220 
ušt8_t
 
n
;

221 
bufãr
 
sub
;

223 
n
 = 
ack
->
Ën
;

224 ià(
n
 > 
max
)

226 
n
 = 
max
;

228 
sub
 = 
	`buf_sub
(
buf
, 
	`ACK_SIZE
(
n
), 
´•’d
);

229 ià(!
	`BDEF
(&
sub
))

231 
”rÜ
;

233 
	`ASSERT
(
	`buf_wr™e
(&
sub
, &
n
, (n)));

234 
i
 = 0; i < 
n
; ++i)

236 
·ck‘_id_ty³
 
pid
 = 
ack
->
·ck‘_id
[
i
];

237 
·ck‘_id_ty³
 
Ãt_pid
 = 
	`htÚpid
(
pid
);

238 
	`ASSERT
(
	`buf_wr™e
(&
sub
, &
Ãt_pid
, (net_pid)));

239 
	`dmsg
(
D_REL_DEBUG
, "ACK wr™ID " 
·ck‘_id_fÜm©
 " (ack->Ën=%d,‚=%d)", (
·ck‘_id_´št_ty³
)
pid
, 
ack
->
Ën
, 
n
);

241 ià(
n
)

243 
	`ASSERT
(
	`£ssiÚ_id_defšed
(
sid
));

244 
	`ASSERT
(
	`£ssiÚ_id_wr™e
(
sid
, &
sub
));

245 
i
 = 0, 
j
 = 
n
; j < 
ack
->
Ën
; )

247 
ack
->
·ck‘_id
[
i
++] =‡ck->·ck‘_id[
j
++];

249 
ack
->
Ën
 = 
i
;

252  
Œue
;

254 
”rÜ
:

255  
çl£
;

256 
	}
}

260 
	$»lŸbË_ack_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
max
)

262 
	`äame_add_to_exŒa_äame
(
äame
, 
	`ACK_SIZE
(
max
));

263 
	}
}

267 
	$»lŸbË_ack_´št
(
bufãr
 *
buf
, 
boŞ
 
v”bo£
, 
gc_¬’a
 *
gc
)

269 
i
;

270 
ušt8_t
 
n_ack
;

271 
£ssiÚ_id
 
sid_ack
;

272 
·ck‘_id_ty³
 
pid
;

273 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

275 
	`buf_´štf
(&
out
, "[");

276 ià(!
	`buf_»ad
(
buf
, &
n_ack
, (n_ack)))

278 
dÚe
;

280 
i
 = 0; i < 
n_ack
; ++i)

282 ià(!
	`buf_»ad
(
buf
, &
pid
, (pid)))

284 
dÚe
;

286 
pid
 = 
	`Áohpid
(pid);

287 
	`buf_´štf
(&
out
, " " 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
pid
);

289 ià(
n_ack
)

291 ià(!
	`£ssiÚ_id_»ad
(&
sid_ack
, 
buf
))

293 
dÚe
;

295 ià(
v”bo£
)

297 
	`buf_´štf
(&
out
, " sid=%s", 
	`£ssiÚ_id_´št
(&
sid_ack
, 
gc
));

301 
dÚe
:

302 
	`buf_´štf
(&
out
, " ]");

303  
	`BSTR
(&
out
);

304 
	}
}

311 
	$»lŸbË_š™
(
»lŸbË
 *
»l
, 
buf_size
, 
off£t
, 
¬¿y_size
, 
boŞ
 
hŞd
)

313 
i
;

315 
	`CLEAR
(*
»l
);

316 
	`ASSERT
(
¬¿y_size
 > 0 &&‡¼ay_siz<ğ
RELIABLE_CAPACITY
);

317 
»l
->
hŞd
 = hold;

318 
»l
->
size
 = 
¬¿y_size
;

319 
»l
->
off£t
 = offset;

320 
i
 = 0; i < 
»l
->
size
; ++i)

322 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

323 
e
->
buf
 = 
	`®loc_buf
(
buf_size
);

324 
	`ASSERT
(
	`buf_š™
(&
e
->
buf
, 
off£t
));

326 
	}
}

329 
	$»lŸbË_ä“
(
»lŸbË
 *
»l
)

331 
i
;

332 
i
 = 0; i < 
»l
->
size
; ++i)

334 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

335 
	`ä“_buf
(&
e
->
buf
);

337 
	}
}

340 
boŞ


341 
	$»lŸbË_em±y
(cÚ¡ 
»lŸbË
 *
»l
)

343 
i
;

344 
i
 = 0; i < 
»l
->
size
; ++i)

346 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

347 ià(
e
->
aùive
)

349  
çl£
;

352  
Œue
;

353 
	}
}

357 
	$»lŸbË_£nd_purge
(
»lŸbË
 *
»l
, 
»lŸbË_ack
 *
ack
)

359 
i
, 
j
;

360 
i
 = 0; i < 
ack
->
Ën
; ++i)

362 
·ck‘_id_ty³
 
pid
 = 
ack
->
·ck‘_id
[
i
];

363 
j
 = 0; j < 
»l
->
size
; ++j)

365 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
j
];

366 ià(
e
->
aùive
 &&ƒ->
·ck‘_id
 =ğ
pid
)

368 
	`dmsg
(
D_REL_DEBUG
,

369 "ACK„eûived fÜ…id " 
·ck‘_id_fÜm©
 ", deleting from send buffer",

370 (
·ck‘_id_´št_ty³
)
pid
);

374 ià(
e
->
Ãxt_Œy
)

376 cÚ¡ 
š‹rv®_t
 
wake
 = 
e
->
Ãxt_Œy
 - 
now
;

377 
	`msg
(
M_INFO
, "ACK " 
·ck‘_id_fÜm©
 ", wake=%d", 
pid
, 
wake
);

381 
e
->
aùive
 = 
çl£
;

386 
	}
}

390 
	$»lŸbË_´št_ids
(cÚ¡ 
»lŸbË
 *
»l
, 
gc_¬’a
 *
gc
)

392 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

393 
i
;

395 
	`buf_´štf
(&
out
, "[" 
·ck‘_id_fÜm©
 "]", (
·ck‘_id_´št_ty³
)
»l
->
·ck‘_id
);

396 
i
 = 0; i < 
»l
->
size
; ++i)

398 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

399 ià(
e
->
aùive
)

401 
	`buf_´štf
(&
out
, " " 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
e
->
·ck‘_id
);

404  
	`BSTR
(&
out
);

405 
	}
}

408 
boŞ


409 
	$»lŸbË_ÿn_g‘
(cÚ¡ 
»lŸbË
 *
»l
)

411 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

412 
i
;

413 
i
 = 0; i < 
»l
->
size
; ++i)

415 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

416 ià(!
e
->
aùive
)

418  
Œue
;

421 
	`dmsg
(
D_REL_LOW
, "ACK‚Øä“„eûivbufã¸avaabË: %s", 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

422 
	`gc_ä“
(&
gc
);

423  
çl£
;

424 
	}
}

427 
boŞ


428 
	$»lŸbË_nÙ_»¶ay
(cÚ¡ 
»lŸbË
 *
»l
, 
·ck‘_id_ty³
 
id
)

430 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

431 
i
;

432 ià(
	`»lŸbË_pid_mš
(
id
, 
»l
->
·ck‘_id
))

434 
bad
;

436 
i
 = 0; i < 
»l
->
size
; ++i)

438 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

439 ià(
e
->
aùive
 &&ƒ->
·ck‘_id
 =ğ
id
)

441 
bad
;

444 
	`gc_ä“
(&
gc
);

445  
Œue
;

447 
bad
:

448 
	`dmsg
(
D_REL_DEBUG
, "ACK " 
·ck‘_id_fÜm©
 " i ¨»¶ay: %s", (
·ck‘_id_´št_ty³
)
id
, 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

449 
	`gc_ä“
(&
gc
);

450  
çl£
;

451 
	}
}

454 
boŞ


455 
	$»lŸbË_wÚt_b»ak_£qu’tŸl™y
(cÚ¡ 
»lŸbË
 *
»l
, 
·ck‘_id_ty³
 
id
)

457 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

459 cÚ¡ 
»t
 = 
	`»lŸbË_pid_š_¿nge2
(
id
, 
»l
->
·ck‘_id
,„–->
size
);

461 ià(!
»t
)

463 
	`dmsg
(
D_REL_LOW
, "ACK " 
·ck‘_id_fÜm©
 " breaks sequentiality: %s",

464 (
·ck‘_id_´št_ty³
)
id
, 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

467 
	`dmsg
(
D_REL_DEBUG
, "ACK RWBS„–->size=%d„–->·ck‘_id=%08x id=%08x„‘=%d\n", 
»l
->
size
,„–->
·ck‘_id
, 
id
, 
»t
);

469 
	`gc_ä“
(&
gc
);

470  
»t
;

471 
	}
}

474 
bufãr
 *

475 
	$»lŸbË_g‘_buf
(
»lŸbË
 *
»l
)

477 
i
;

478 
i
 = 0; i < 
»l
->
size
; ++i)

480 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

481 ià(!
e
->
aùive
)

483 
	`ASSERT
(
	`buf_š™
(&
e
->
buf
, 
»l
->
off£t
));

484  &
e
->
buf
;

487  
NULL
;

488 
	}
}

491 
bufãr
 *

492 
	$»lŸbË_g‘_buf_ouut_£qu’ûd
(
»lŸbË
 *
»l
)

494 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

495 
i
;

496 
·ck‘_id_ty³
 
mš_id
 = 0;

497 
boŞ
 
mš_id_defšed
 = 
çl£
;

498 
bufãr
 *
»t
 = 
NULL
;

501 
i
 = 0; i < 
»l
->
size
; ++i)

503 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

504 ià(
e
->
aùive
)

506 ià(!
mš_id_defšed
 || 
	`»lŸbË_pid_mš
(
e
->
·ck‘_id
, 
mš_id
))

508 
mš_id_defšed
 = 
Œue
;

509 
mš_id
 = 
e
->
·ck‘_id
;

514 ià(!
mš_id_defšed
 || 
	`»lŸbË_pid_š_¿nge1
(
»l
->
·ck‘_id
, 
mš_id
,„–->
size
))

516 
»t
 = 
	`»lŸbË_g‘_buf
(
»l
);

520 
	`dmsg
(
D_REL_LOW
, "ACK ouuˆ£qu’û brok’: %s", 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

522 
	`gc_ä“
(&
gc
);

523  
»t
;

524 
	}
}

527 
bufãr
 *

528 
	$»lŸbË_g‘_buf_£qu’ûd
(
»lŸbË
 *
»l
)

530 
i
;

531 
i
 = 0; i < 
»l
->
size
; ++i)

533 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

534 ià(
e
->
aùive
 &&ƒ->
·ck‘_id
 =ğ
»l
->packet_id)

536  &
e
->
buf
;

539  
NULL
;

540 
	}
}

543 
boŞ


544 
	$»lŸbË_ÿn_£nd
(cÚ¡ 
»lŸbË
 *
»l
)

546 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

547 
i
;

548 
n_aùive
 = 0, 
n_cu¼’t
 = 0;

549 
i
 = 0; i < 
»l
->
size
; ++i)

551 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

552 ià(
e
->
aùive
)

554 ++
n_aùive
;

555 ià(
now
 >ğ
e
->
Ãxt_Œy
)

557 ++
n_cu¼’t
;

561 
	`dmsg
(
D_REL_DEBUG
, "ACK„eliable_can_send‡ctive=%d current=%d : %s",

562 
n_aùive
,

563 
n_cu¼’t
,

564 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

566 
	`gc_ä“
(&
gc
);

567  
n_cu¼’t
 > 0 && !
»l
->
hŞd
;

568 
	}
}

570 #ifdeà
EXPONENTIAL_BACKOFF


572 
time_t


573 
	$»lŸbË_unique_»Œy
(
»lŸbË
 *
»l
, 
time_t
 
»Œy
)

575 
i
;

576 
Œue
)

578 
i
 = 0; i < 
»l
->
size
; ++i)

580 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

581 ià(
e
->
aùive
 &&ƒ->
Ãxt_Œy
 =ğ
»Œy
)

583 
agaš
;

587 
agaš
:

588 ++
»Œy
;

590  
»Œy
;

591 
	}
}

595 
bufãr
 *

596 
	$»lŸbË_£nd
(
»lŸbË
 *
»l
, *
İcode
)

598 
i
;

599 
»lŸbË_’Œy
 *
be¡
 = 
NULL
;

600 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

602 
i
 = 0; i < 
»l
->
size
; ++i)

604 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

605 ià(
e
->
aùive
 && 
loÿl_now
 >ğe->
Ãxt_Œy
)

607 ià(!
be¡
 || 
	`»lŸbË_pid_mš
(
e
->
·ck‘_id
, best->packet_id))

609 
be¡
 = 
e
;

613 ià(
be¡
)

615 #ifdeà
EXPONENTIAL_BACKOFF


617 
be¡
->
Ãxt_Œy
 = 
	`»lŸbË_unique_»Œy
(
»l
, 
loÿl_now
 + be¡->
timeout
);

618 
be¡
->
timeout
 *= 2;

621 
be¡
->
Ãxt_Œy
 = 
loÿl_now
 + be¡->
timeout
;

623 *
İcode
 = 
be¡
->opcode;

624 
	`dmsg
(
D_REL_DEBUG
, "ACK„–ŸbË_£nd ID " 
·ck‘_id_fÜm©
 " (size=%do=%d)",

625 (
·ck‘_id_´št_ty³
)
be¡
->
·ck‘_id
, be¡->
buf
.
Ën
,

626 ()(
be¡
->
Ãxt_Œy
 - 
loÿl_now
));

627  &
be¡
->
buf
;

629  
NULL
;

630 
	}
}

634 
	$»lŸbË_scheduË_now
(
»lŸbË
 *
»l
)

636 
i
;

637 
	`dmsg
(
D_REL_DEBUG
, "ACK„eliable_schedule_now");

638 
»l
->
hŞd
 = 
çl£
;

639 
i
 = 0; i < 
»l
->
size
; ++i)

641 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

642 ià(
e
->
aùive
)

644 
e
->
Ãxt_Œy
 = 
now
;

645 
e
->
timeout
 = 
»l
->
š™Ÿl_timeout
;

648 
	}
}

652 
š‹rv®_t


653 
	$»lŸbË_£nd_timeout
(cÚ¡ 
»lŸbË
 *
»l
)

655 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

656 
š‹rv®_t
 
»t
 = 
BIG_TIMEOUT
;

657 
i
;

658 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

660 
i
 = 0; i < 
»l
->
size
; ++i)

662 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

663 ià(
e
->
aùive
)

665 ià(
e
->
Ãxt_Œy
 <ğ
loÿl_now
)

667 
»t
 = 0;

672 
»t
 = 
	`mš_št
Ô‘, 
e
->
Ãxt_Œy
 - 
loÿl_now
);

677 
	`dmsg
(
D_REL_DEBUG
, "ACK„eliable_send_timeout %d %s",

678 (è
»t
,

679 
	`»lŸbË_´št_ids
(
»l
, &
gc
));

681 
	`gc_ä“
(&
gc
);

682  
»t
;

683 
	}
}

690 
	$»lŸbË_m¬k_aùive_šcomšg
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
,

691 
·ck‘_id_ty³
 
pid
, 
İcode
)

693 
i
;

694 
i
 = 0; i < 
»l
->
size
; ++i)

696 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

697 ià(
buf
 =ğ&
e
->buf)

699 
e
->
aùive
 = 
Œue
;

702 
e
->
·ck‘_id
 = 
pid
;

705 
	`ASSERT
(!
	`»lŸbË_pid_mš
(
pid
, 
»l
->
·ck‘_id
));

707 
e
->
İcode
 = opcode;

708 
e
->
Ãxt_Œy
 = 0;

709 
e
->
timeout
 = 0;

710 
	`dmsg
(
D_REL_DEBUG
, "ACK m¬k‡ùivšcomšg ID " 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
e
->
·ck‘_id
);

714 
	`ASSERT
(0);

715 
	}
}

722 
	$»lŸbË_m¬k_aùive_outgošg
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
, 
İcode
)

724 
i
;

725 
i
 = 0; i < 
»l
->
size
; ++i)

727 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

728 ià(
buf
 =ğ&
e
->buf)

732 
·ck‘_id_ty³
 
Ãt_pid
;

733 
e
->
·ck‘_id
 = 
»l
->packet_id++;

734 
Ãt_pid
 = 
	`htÚpid
(
e
->
·ck‘_id
);

735 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
Ãt_pid
, (net_pid)));

736 
e
->
aùive
 = 
Œue
;

737 
e
->
İcode
 = opcode;

738 
e
->
Ãxt_Œy
 = 0;

739 
e
->
timeout
 = 
»l
->
š™Ÿl_timeout
;

740 
	`dmsg
(
D_REL_DEBUG
, "ACK m¬k‡ùivoutgošg ID " 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
e
->
·ck‘_id
);

744 
	`ASSERT
(0);

745 
	}
}

749 
	$»lŸbË_m¬k_d–‘ed
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
, 
boŞ
 
šc_pid
)

751 
i
;

752 
i
 = 0; i < 
»l
->
size
; ++i)

754 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

755 ià(
buf
 =ğ&
e
->buf)

757 
e
->
aùive
 = 
çl£
;

758 ià(
šc_pid
)

760 
»l
->
·ck‘_id
 = 
e
->packet_id + 1;

765 
	`ASSERT
(0);

766 
	}
}

771 
	$»lŸbË_ack_debug_´št
(cÚ¡ 
»lŸbË_ack
 *
ack
, *
desc
)

773 
i
;

775 
	`´štf
("********* sŒuù„–ŸbË_ack %s\n", 
desc
);

776 
i
 = 0; i < 
ack
->
Ën
; ++i)

778 
	`´štf
(" %d: " 
·ck‘_id_fÜm©
 "\n", 
i
, (
·ck‘_id_´št_ty³
è
ack
->
·ck‘_id
[i]);

780 
	}
}

783 
	$»lŸbË_debug_´št
(cÚ¡ 
»lŸbË
 *
»l
, *
desc
)

785 
i
;

786 
	`upd©e_time
();

788 
	`´štf
("********* sŒuù„–ŸbË %s\n", 
desc
);

789 
	`´štf
(" in™Ÿl_timeout=%d\n", ()
»l
->
š™Ÿl_timeout
);

790 
	`´štf
("…ack‘_id=" 
·ck‘_id_fÜm©
 "\n", 
»l
->
·ck‘_id
);

791 
	`´štf
("‚ow=" 
time_fÜm©
 "\n", 
now
);

792 
i
 = 0; i < 
»l
->
size
; ++i)

794 cÚ¡ 
»lŸbË_’Œy
 *
e
 = &
»l
->
¬¿y
[
i
];

795 ià(
e
->
aùive
)

797 
	`´štf
(" %d:…ack‘_id=" 
·ck‘_id_fÜm©
 "†’=%d", 
i
, 
e
->
·ck‘_id
,ƒ->
buf
.
Ën
);

798 
	`´štf
("‚ext_Œy=" 
time_fÜm©
, 
e
->
Ãxt_Œy
);

799 
	`´štf
("\n");

802 
	}
}

808 
	$dummy
()

810 
	}
}

	@reliable.h

31 #ifdeà
ENABLE_CRYPTO


33 #iâdeà
RELIABLE_H


34 
	#RELIABLE_H


	)

36 
	~"basic.h
"

37 
	~"bufãr.h
"

38 
	~"·ck‘_id.h
"

39 
	~"£ssiÚ_id.h
"

40 
	~"mtu.h
"

46 
	#EXPONENTIAL_BACKOFF


	)

48 
	#RELIABLE_ACK_SIZE
 8

	)

53 
	#RELIABLE_CAPACITY
 8

	)

61 
	s»lŸbË_ack


63 
	mËn
;

64 
·ck‘_id_ty³
 
	m·ck‘_id
[
RELIABLE_ACK_SIZE
];

71 
	s»lŸbË_’Œy


73 
boŞ
 
	maùive
;

74 
š‹rv®_t
 
	mtimeout
;

75 
time_t
 
	mÃxt_Œy
;

76 
·ck‘_id_ty³
 
	m·ck‘_id
;

77 
	mİcode
;

78 
bufãr
 
	mbuf
;

85 
	s»lŸbË


87 
	msize
;

88 
š‹rv®_t
 
	mš™Ÿl_timeout
;

89 
·ck‘_id_ty³
 
	m·ck‘_id
;

90 
	moff£t
;

91 
boŞ
 
	mhŞd
;

92 
»lŸbË_’Œy
 
	m¬¿y
[
RELIABLE_CAPACITY
];

118 
boŞ
 
»lŸbË_ack_»ad
(
»lŸbË_ack
 *
ack
,

119 
bufãr
 *
buf
, cÚ¡ 
£ssiÚ_id
 *
sid
);

128 
»lŸbË_£nd_purge
(
»lŸbË
 *
»l
, 
»lŸbË_ack
 *
ack
);

147 
šlše
 
boŞ


148 
	$»lŸbË_ack_em±y
(
»lŸbË_ack
 *
ack
)

150  !
ack
->
Ën
;

151 
	}
}

171 
boŞ
 
»lŸbË_ack_wr™e
(
»lŸbË_ack
 *
ack
,

172 
bufãr
 *
buf
,

173 cÚ¡ 
£ssiÚ_id
 *
sid
, 
max
, 
boŞ
 
´•’d
);

194 
»lŸbË_š™
(
»lŸbË
 *
»l
, 
buf_size
, 
off£t
, 
¬¿y_size
, 
boŞ
 
hŞd
);

201 
»lŸbË_ä“
(
»lŸbË
 *
»l
);

204 
»lŸbË_ack_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
max
);

223 
boŞ
 
»lŸbË_ÿn_g‘
(cÚ¡ 
»lŸbË
 *
»l
);

236 
boŞ
 
»lŸbË_nÙ_»¶ay
(cÚ¡ 
»lŸbË
 *
»l
, 
·ck‘_id_ty³
 
id
);

260 
boŞ
 
»lŸbË_wÚt_b»ak_£qu’tŸl™y
(cÚ¡ 
»lŸbË
 *
»l
, 
·ck‘_id_ty³
 
id
);

272 
boŞ
 
»lŸbË_ack_»ad_·ck‘_id
(
bufãr
 *
buf
, 
·ck‘_id_ty³
 *
pid
);

285 
bufãr
 *
»lŸbË_g‘_buf
(
»lŸbË
 *
»l
);

296 
»lŸbË_m¬k_aùive_šcomšg
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
,

297 
·ck‘_id_ty³
 
pid
, 
İcode
);

312 
boŞ
 
»lŸbË_ack_acknowËdge_·ck‘_id
(
»lŸbË_ack
 *
ack
, 
·ck‘_id_ty³
 
pid
);

331 
bufãr
 *
»lŸbË_g‘_buf_£qu’ûd
(
»lŸbË
 *
»l
);

341 
»lŸbË_m¬k_d–‘ed
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
, 
boŞ
 
šc_pid
);

362 
bufãr
 *
»lŸbË_g‘_buf_ouut_£qu’ûd
(
»lŸbË
 *
»l
);

375 
»lŸbË_m¬k_aùive_outgošg
(
»lŸbË
 *
»l
, 
bufãr
 *
buf
, 
İcode
);

396 
boŞ
 
»lŸbË_ÿn_£nd
(cÚ¡ 
»lŸbË
 *
»l
);

415 
bufãr
 *
»lŸbË_£nd
(
»lŸbË
 *
»l
, *
İcode
);

434 
boŞ
 
»lŸbË_em±y
(cÚ¡ 
»lŸbË
 *
»l
);

447 
š‹rv®_t
 
»lŸbË_£nd_timeout
(cÚ¡ 
»lŸbË
 *
»l
);

456 
»lŸbË_scheduË_now
(
»lŸbË
 *
»l
);

458 
»lŸbË_debug_´št
(cÚ¡ 
»lŸbË
 *
»l
, *
desc
);

461 
šlše
 

462 
	$»lŸbË_£t_timeout
(
»lŸbË
 *
»l
, 
š‹rv®_t
 
timeout
)

464 
»l
->
š™Ÿl_timeout
 = 
timeout
;

465 
	}
}

468 cÚ¡ *
»lŸbË_ack_´št
(
bufãr
 *
buf
, 
boŞ
 
v”bo£
, 
gc_¬’a
 *
gc
);

470 
»lŸbË_ack_debug_´št
(cÚ¡ 
»lŸbË_ack
 *
ack
, *
desc
);

	@route.c

28 #ifdeà
HAVE_CONFIG_H


29 
	~"cÚfig.h
"

30 #–ià
defšed
(
_MSC_VER
)

31 
	~"cÚfig-msvc.h
"

34 
	~"sysh—d.h
"

36 
	~"commÚ.h
"

37 
	~"”rÜ.h
"

38 
	~"rou‹.h
"

39 
	~"misc.h
"

40 
	~"sock‘.h
"

41 
	~"mªage.h
"

42 
	~"wš32.h
"

43 
	~"İtiÚs.h
"

45 
	~"memdbg.h
"

47 #ià
defšed
(
TARGET_LINUX
è|| defšed(
TARGET_ANDROID
)

48 
	~<lšux/¹Ãšk.h
>

51 #ifdeà
_WIN32


52 
	~"İ’v²-msg.h
"

54 
	#METRIC_NOT_USED
 ((
DWORD
)-1)

	)

55 
boŞ
 
add_rou‹_£rviû
(cÚ¡ 
rou‹_v4
 *, cÚ¡ 
tuÁ­
 *);

57 
boŞ
 
d–_rou‹_£rviû
(cÚ¡ 
rou‹_v4
 *, cÚ¡ 
tuÁ­
 *);

59 
boŞ
 
add_rou‹_v6_£rviû
(cÚ¡ 
rou‹_v6
 *, cÚ¡ 
tuÁ­
 *);

61 
boŞ
 
d–_rou‹_v6_£rviû
(cÚ¡ 
rou‹_v6
 *, cÚ¡ 
tuÁ­
 *);

65 
d–‘e_rou‹
(
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
, cÚ¡ 
’v_£t
 *
es
);

67 
g‘_by·ss_add»s£s
(
rou‹_by·ss
 *
rb
, cÚ¡ 
æags
);

69 #ifdeà
ENABLE_DEBUG


72 
	$´št_by·ss_add»s£s
(cÚ¡ 
rou‹_by·ss
 *
rb
)

74 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

75 
i
;

76 
i
 = 0; i < 
rb
->
n_by·ss
; ++i)

78 
	`msg
(
D_ROUTE
, "ROUTE: bypass_host_route[%d]=%s",

79 
i
,

80 
	`´št_š_addr_t
(
rb
->
by·ss
[
i
], 0, &
gc
));

82 
	`gc_ä“
(&
gc
);

83 
	}
}

87 
boŞ


88 
	$add_by·ss_add»ss
(
rou‹_by·ss
 *
rb
, cÚ¡ 
š_addr_t
 
a
)

90 
i
;

91 
i
 = 0; i < 
rb
->
n_by·ss
; ++i)

93 ià(
a
 =ğ
rb
->
by·ss
[
i
])

95  
Œue
;

98 ià(
rb
->
n_by·ss
 < 
N_ROUTE_BYPASS
)

100 
rb
->
by·ss
[rb->
n_by·ss
++] = 
a
;

101  
Œue
;

105  
çl£
;

107 
	}
}

109 
rou‹_İtiÚ_li¡
 *

110 
	$Ãw_rou‹_İtiÚ_li¡
(
gc_¬’a
 *
a
)

112 
rou‹_İtiÚ_li¡
 *
»t
;

113 
	`ALLOC_OBJ_CLEAR_GC
(
»t
, 
rou‹_İtiÚ_li¡
, 
a
);

114 
»t
->
gc
 = 
a
;

115  
»t
;

116 
	}
}

118 
rou‹_v6_İtiÚ_li¡
 *

119 
	$Ãw_rou‹_v6_İtiÚ_li¡
(
gc_¬’a
 *
a
)

121 
rou‹_v6_İtiÚ_li¡
 *
»t
;

122 
	`ALLOC_OBJ_CLEAR_GC
(
»t
, 
rou‹_v6_İtiÚ_li¡
, 
a
);

123 
»t
->
gc
 = 
a
;

124  
»t
;

125 
	}
}

134 
rou‹_İtiÚ_li¡
 *

135 
	$şÚe_rou‹_İtiÚ_li¡
(cÚ¡ 
rou‹_İtiÚ_li¡
 *
¤c
, 
gc_¬’a
 *
a
)

137 
rou‹_İtiÚ_li¡
 *
»t
;

138 
	`ALLOC_OBJ_GC
(
»t
, 
rou‹_İtiÚ_li¡
, 
a
);

139 *
»t
 = *
¤c
;

140  
»t
;

141 
	}
}

143 
rou‹_v6_İtiÚ_li¡
 *

144 
	$şÚe_rou‹_v6_İtiÚ_li¡
(cÚ¡ 
rou‹_v6_İtiÚ_li¡
 *
¤c
, 
gc_¬’a
 *
a
)

146 
rou‹_v6_İtiÚ_li¡
 *
»t
;

147 
	`ALLOC_OBJ_GC
(
»t
, 
rou‹_v6_İtiÚ_li¡
, 
a
);

148 *
»t
 = *
¤c
;

149  
»t
;

150 
	}
}

153 
	$cİy_rou‹_İtiÚ_li¡
(
rou‹_İtiÚ_li¡
 *
de¡
, cÚ¡ rou‹_İtiÚ_li¡ *
¤c
, 
gc_¬’a
 *
a
)

155 *
de¡
 = *
¤c
;

156 
de¡
->
gc
 = 
a
;

157 
	}
}

160 
	$cİy_rou‹_v6_İtiÚ_li¡
(
rou‹_v6_İtiÚ_li¡
 *
de¡
,

161 cÚ¡ 
rou‹_v6_İtiÚ_li¡
 *
¤c
,

162 
gc_¬’a
 *
a
)

164 *
de¡
 = *
¤c
;

165 
de¡
->
gc
 = 
a
;

166 
	}
}

169 
	$rou‹_¡ršg
(cÚ¡ 
rou‹_v4
 *
r
, 
gc_¬’a
 *
gc
)

171 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

172 
	`buf_´štf
(&
out
, "ROUTE‚etwork %s‚etmask %s gateway %s",

173 
	`´št_š_addr_t
(
r
->
ÃtwÜk
, 0, 
gc
),

174 
	`´št_š_addr_t
(
r
->
Ãtmask
, 0, 
gc
),

175 
	`´št_š_addr_t
(
r
->
g©eway
, 0, 
gc
)

177 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

179 
	`buf_´štf
(&
out
, " m‘riø%d", 
r
->
m‘ric
);

181  
	`BSTR
(&
out
);

182 
	}
}

184 
boŞ


185 
	$is_rou‹_·rm_defšed
(cÚ¡ *
·rm
)

187 ià(!
·rm
)

189  
çl£
;

191 ià(!
	`¡rcmp
(
·rm
, "default"))

193  
çl£
;

195  
Œue
;

196 
	}
}

199 
	$£‹nv_rou‹_addr
(
’v_£t
 *
es
, cÚ¡ *
key
, cÚ¡ 
š_addr_t
 
addr
, 
i
)

201 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

202 
bufãr
 
Çme
 = 
	`®loc_buf_gc
(256, &
gc
);

203 ià(
i
 >= 0)

205 
	`buf_´štf
(&
Çme
, "rou‹_%s_%d", 
key
, 
i
);

209 
	`buf_´štf
(&
Çme
, "rou‹_%s", 
key
);

211 
	`£‹nv_¡r
(
es
, 
	`BSTR
(&
Çme
), 
	`´št_š_addr_t
(
addr
, 0, &
gc
));

212 
	`gc_ä“
(&
gc
);

213 
	}
}

215 
boŞ


216 
	$g‘_¥ecŸl_addr
(cÚ¡ 
rou‹_li¡
 *
¾
,

217 cÚ¡ *
¡ršg
,

218 
š_addr_t
 *
out
,

219 
boŞ
 *
¡©us
)

221 ià(
¡©us
)

223 *
¡©us
 = 
Œue
;

225 ià(!
	`¡rcmp
(
¡ršg
, "vpn_gateway"))

227 ià(
¾
)

229 ià(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_ENDPOINT
)

231 *
out
 = 
¾
->
¥ec
.
»mÙe_’dpošt
;

235 
	`msg
(
M_INFO
, 
PACKAGE_NAME
 " ROUTE: vpn_gateway undefined");

236 ià(
¡©us
)

238 *
¡©us
 = 
çl£
;

242  
Œue
;

244 ià(!
	`¡rcmp
(
¡ršg
, "net_gateway"))

246 ià(
¾
)

248 ià(
¾
->
rgi
.
æags
 & 
RGI_ADDR_DEFINED
)

250 *
out
 = 
¾
->
rgi
.
g©eway
.
addr
;

254 
	`msg
(
M_INFO
, 
PACKAGE_NAME
 " ROUTE:‚et_gateway undefined -- unableo get default gateway from system");

255 ià(
¡©us
)

257 *
¡©us
 = 
çl£
;

261  
Œue
;

263 ià(!
	`¡rcmp
(
¡ršg
, "remote_host"))

265 ià(
¾
)

267 ià(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_HOST
)

269 *
out
 = 
¾
->
¥ec
.
»mÙe_ho¡
;

273 
	`msg
(
M_INFO
, 
PACKAGE_NAME
 " ROUTE:„emote_host undefined");

274 ià(
¡©us
)

276 *
¡©us
 = 
çl£
;

280  
Œue
;

282  
çl£
;

283 
	}
}

285 
boŞ


286 
	$is_¥ecŸl_addr
(cÚ¡ *
addr_¡r
)

288 ià(
addr_¡r
)

290  
	`g‘_¥ecŸl_addr
(
NULL
, 
addr_¡r
, NULL, NULL);

294  
çl£
;

296 
	}
}

298 
boŞ


299 
	$š™_rou‹
(
rou‹_v4
 *
r
,

300 
addršfo
 **
ÃtwÜk_li¡
,

301 cÚ¡ 
rou‹_İtiÚ
 *
ro
,

302 cÚ¡ 
rou‹_li¡
 *
¾
)

304 cÚ¡ 
š_addr_t
 
deçuÉ_Ãtmask
 = 
IPV4_NETMASK_HOST
;

305 
boŞ
 
¡©us
;

306 
»t
;

307 
š_addr
 
¥ecŸl
;

309 
	`CLEAR
(*
r
);

310 
r
->
İtiÚ
 = 
ro
;

314 ià(!
	`is_rou‹_·rm_defšed
(
ro
->
ÃtwÜk
))

316 
ç
;

323 ià(
	`g‘_¥ecŸl_addr
(
¾
, 
ro
->
ÃtwÜk
, (
š_addr_t
 *è&
¥ecŸl
.
s_addr
, &
¡©us
))

325 
¥ecŸl
.
s_addr
 = 
	`htÚl
(special.s_addr);

326 
»t
 = 
	`İ’v²_g‘addršfo
(0, 
	`š‘_Áß
(
¥ecŸl
), 
NULL
, 0, NULL,

327 
AF_INET
, 
ÃtwÜk_li¡
);

331 
»t
 = 
	`İ’v²_g‘addršfo
(
GETADDR_RESOLVE
 | 
GETADDR_WARN_ON_SIGNAL
,

332 
ro
->
ÃtwÜk
, 
NULL
, 0, NULL, 
AF_INET
, 
ÃtwÜk_li¡
);

335 
¡©us
 = (
»t
 == 0);

337 ià(!
¡©us
)

339 
ç
;

344 ià(
	`is_rou‹_·rm_defšed
(
ro
->
Ãtmask
))

346 
r
->
Ãtmask
 = 
	`g‘addr
(

347 
GETADDR_HOST_ORDER


348 | 
GETADDR_WARN_ON_SIGNAL
,

349 
ro
->
Ãtmask
,

351 &
¡©us
,

352 
NULL
);

353 ià(!
¡©us
)

355 
ç
;

360 
r
->
Ãtmask
 = 
deçuÉ_Ãtmask
;

365 ià(
	`is_rou‹_·rm_defšed
(
ro
->
g©eway
))

367 ià(!
	`g‘_¥ecŸl_addr
(
¾
, 
ro
->
g©eway
, &
r
->g©eway, &
¡©us
))

369 
r
->
g©eway
 = 
	`g‘addr
(

370 
GETADDR_RESOLVE


371 | 
GETADDR_HOST_ORDER


372 | 
GETADDR_WARN_ON_SIGNAL
,

373 
ro
->
g©eway
,

375 &
¡©us
,

376 
NULL
);

378 ià(!
¡©us
)

380 
ç
;

385 ià(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_ENDPOINT
)

387 
r
->
g©eway
 = 
¾
->
¥ec
.
»mÙe_’dpošt
;

391 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE: " PACKAGE_NAME "‚eeds‡ gateway…arameter for‡ --route option‡nd‚o default was specified byƒither --route-gateway or --ifconfig options");

392 
ç
;

398 
r
->
m‘ric
 = 0;

399 ià(
	`is_rou‹_·rm_defšed
(
ro
->
m‘ric
))

401 
r
->
m‘ric
 = 
	`©oi
(
ro
->metric);

402 ià(
r
->
m‘ric
 < 0)

404 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE:„oute metric for‚etwork %s (%s) must be >= 0",

405 
ro
->
ÃtwÜk
,

406 
ro
->
m‘ric
);

407 
ç
;

409 
r
->
æags
 |ğ
RT_METRIC_DEFINED
;

411 ià(
¾
->
¥ec
.
æags
 & 
RTSA_DEFAULT_METRIC
)

413 
r
->
m‘ric
 = 
¾
->
¥ec
.
deçuÉ_m‘ric
;

414 
r
->
æags
 |ğ
RT_METRIC_DEFINED
;

417 
r
->
æags
 |ğ
RT_DEFINED
;

419  
Œue
;

421 
ç
:

422 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedo…arse/resolve„oute for host/network: %s",

423 
ro
->
ÃtwÜk
);

424  
çl£
;

425 
	}
}

427 
boŞ


428 
	$š™_rou‹_v6
(
rou‹_v6
 *
r6
,

429 cÚ¡ 
rou‹_v6_İtiÚ
 *
r6o
,

430 cÚ¡ 
rou‹_v6_li¡
 *
¾6
 )

432 
	`CLEAR
(*
r6
);

434 ià(!
	`g‘_v6_addr
Ğ
r6o
->
´efix
, &
r6
->
ÃtwÜk
, &r6->
Ãtb™s
, 
M_WARN
 ))

436 
ç
;

440 ià(
	`is_rou‹_·rm_defšed
(
r6o
->
g©eway
))

442 ià(
	`š‘_±Ú
Ğ
AF_INET6
, 
r6o
->
g©eway
, &
r6
->gateway ) != 1)

444 
	`msg
Ğ
M_WARN
, 
PACKAGE_NAME
 "ROUTE6: cªnÙ…¬£ g©eway s³ø'%s'", 
r6o
->
g©eway
 );

447 ià(
¾6
->
¥ec_æags
 & 
RTSA_REMOTE_ENDPOINT
)

449 
r6
->
g©eway
 = 
¾6
->
»mÙe_’dpošt_v6
;

453 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE6: " PACKAGE_NAME "‚eeds‡ gateway…arameter for‡ --route-ipv6 option‡nd‚o default was specified byƒither --route-ipv6-gateway or --ifconfig-ipv6 options");

454 
ç
;

459 
r6
->
m‘ric
 = -1;

460 ià(
	`is_rou‹_·rm_defšed
(
r6o
->
m‘ric
))

462 
r6
->
m‘ric
 = 
	`©oi
(
r6o
->metric);

463 ià(
r6
->
m‘ric
 < 0)

465 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE:„oute metric for‚etwork %s (%s) must be >= 0",

466 
r6o
->
´efix
,

467 
r6o
->
m‘ric
);

468 
ç
;

470 
r6
->
æags
 |ğ
RT_METRIC_DEFINED
;

472 ià(
¾6
->
¥ec_æags
 & 
RTSA_DEFAULT_METRIC
)

474 
r6
->
m‘ric
 = 
¾6
->
deçuÉ_m‘ric
;

475 
r6
->
æags
 |ğ
RT_METRIC_DEFINED
;

478 
r6
->
æags
 |ğ
RT_DEFINED
;

480  
Œue
;

482 
ç
:

483 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedo…arse/resolve„oute for host/network: %s",

484 
r6o
->
´efix
);

485  
çl£
;

486 
	}
}

489 
	$add_rou‹_to_İtiÚ_li¡
(
rou‹_İtiÚ_li¡
 *
l
,

490 cÚ¡ *
ÃtwÜk
,

491 cÚ¡ *
Ãtmask
,

492 cÚ¡ *
g©eway
,

493 cÚ¡ *
m‘ric
)

495 
rou‹_İtiÚ
 *
ro
;

496 
	`ALLOC_OBJ_GC
(
ro
, 
rou‹_İtiÚ
, 
l
->
gc
);

497 
ro
->
ÃtwÜk
 =‚etwork;

498 
ro
->
Ãtmask
 =‚etmask;

499 
ro
->
g©eway
 = gateway;

500 
ro
->
m‘ric
 = metric;

501 
ro
->
Ãxt
 = 
l
->
rou‹s
;

502 
l
->
rou‹s
 = 
ro
;

504 
	}
}

507 
	$add_rou‹_v6_to_İtiÚ_li¡
(
rou‹_v6_İtiÚ_li¡
 *
l
,

508 cÚ¡ *
´efix
,

509 cÚ¡ *
g©eway
,

510 cÚ¡ *
m‘ric
)

512 
rou‹_v6_İtiÚ
 *
ro
;

513 
	`ALLOC_OBJ_GC
(
ro
, 
rou‹_v6_İtiÚ
, 
l
->
gc
);

514 
ro
->
´efix
 =…refix;

515 
ro
->
g©eway
 = gateway;

516 
ro
->
m‘ric
 = metric;

517 
ro
->
Ãxt
 = 
l
->
rou‹s_v6
;

518 
l
->
rou‹s_v6
 = 
ro
;

519 
	}
}

522 
	$ş—r_rou‹_li¡
(
rou‹_li¡
 *
¾
)

524 
	`gc_ä“
(&
¾
->
gc
);

525 
	`CLEAR
(*
¾
);

526 
	}
}

529 
	$ş—r_rou‹_v6_li¡
(
rou‹_v6_li¡
 *
¾6
)

531 
	`gc_ä“
(&
¾6
->
gc
);

532 
	`CLEAR
(*
¾6
);

533 
	}
}

536 
	$rou‹_li¡_add_v²_g©eway
(
rou‹_li¡
 *
¾
,

537 
’v_£t
 *
es
,

538 cÚ¡ 
š_addr_t
 
addr
)

540 
	`ASSERT
(
¾
);

541 
¾
->
¥ec
.
»mÙe_’dpošt
 = 
addr
;

542 
¾
->
¥ec
.
æags
 |ğ
RTSA_REMOTE_ENDPOINT
;

543 
	`£‹nv_rou‹_addr
(
es
, "v²_g©eway", 
¾
->
¥ec
.
»mÙe_’dpošt
, -1);

544 
	}
}

547 
	$add_block_loÿl_™em
(
rou‹_li¡
 *
¾
,

548 cÚ¡ 
rou‹_g©eway_add»ss
 *
g©eway
,

549 
š_addr_t
 
rg‘
)

551 cÚ¡ 
rgi_Ãeded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

552 ià((
¾
->
rgi
.
æags
 & 
rgi_Ãeded
) ==„gi_needed

553 && 
¾
->
rgi
.
g©eway
.
Ãtmask
 < 0xFFFFFFFF)

555 
rou‹_v4
 *
r1
, *
r2
;

556 
l2
;

558 
	`ALLOC_OBJ_GC
(
r1
, 
rou‹_v4
, &
¾
->
gc
);

559 
	`ALLOC_OBJ_GC
(
r2
, 
rou‹_v4
, &
¾
->
gc
);

562 
l2
 = ((~
g©eway
->
Ãtmask
)+1)>>1;

563 
r1
->
æags
 = 
RT_DEFINED
;

564 
r1
->
g©eway
 = 
rg‘
;

565 
r1
->
ÃtwÜk
 = 
g©eway
->
addr
 & g©eway->
Ãtmask
;

566 
r1
->
Ãtmask
 = ~(
l2
-1);

567 
r1
->
Ãxt
 = 
¾
->
rou‹s
;

568 
¾
->
rou‹s
 = 
r1
;

570 *
r2
 = *
r1
;

571 
r2
->
ÃtwÜk
 +ğ
l2
;

572 
r2
->
Ãxt
 = 
¾
->
rou‹s
;

573 
¾
->
rou‹s
 = 
r2
;

575 
	}
}

578 
	$add_block_loÿl
(
rou‹_li¡
 *
¾
)

580 cÚ¡ 
rgi_Ãeded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

581 ià((
¾
->
æags
 & 
RG_BLOCK_LOCAL
)

582 && (
¾
->
rgi
.
æags
 & 
rgi_Ãeded
) ==„gi_needed

583 && (
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_ENDPOINT
)

584 && 
¾
->
¥ec
.
»mÙe_ho¡_loÿl
 !ğ
TLA_LOCAL
)

586 
size_t
 
i
;

588 #iâdeà
TARGET_ANDROID


590 
	`add_by·ss_add»ss
(&
¾
->
¥ec
.
by·ss
,„l->
rgi
.
g©eway
.
addr
);

594 
	`add_block_loÿl_™em
(
¾
, &¾->
rgi
.
g©eway
,„l->
¥ec
.
»mÙe_’dpošt
);

597 
i
 = 0; i < 
¾
->
rgi
.
n_addrs
; ++i)

599 cÚ¡ 
rou‹_g©eway_add»ss
 *
gwa
 = &
¾
->
rgi
.
addrs
[
i
];

601 ià(!((
¾
->
rgi
.
g©eway
.
addr
 &„l->rgi.g©eway.
Ãtmask
è=ğ(
gwa
->addr & gwa->netmask)

602 && 
¾
->
rgi
.
g©eway
.
Ãtmask
 =ğ
gwa
->netmask))

604 
	`add_block_loÿl_™em
(
¾
, 
gwa
,„l->
¥ec
.
»mÙe_’dpošt
);

608 
	}
}

610 
boŞ


611 
	$š™_rou‹_li¡
(
rou‹_li¡
 *
¾
,

612 cÚ¡ 
rou‹_İtiÚ_li¡
 *
İt
,

613 cÚ¡ *
»mÙe_’dpošt
,

614 
deçuÉ_m‘ric
,

615 
š_addr_t
 
»mÙe_ho¡
,

616 
’v_£t
 *
es
)

618 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

619 
boŞ
 
»t
 = 
Œue
;

621 
	`ş—r_rou‹_li¡
(
¾
);

623 
¾
->
æags
 = 
İt
->flags;

625 ià(
»mÙe_ho¡
)

627 
¾
->
¥ec
.
»mÙe_ho¡
 =„emote_host;

628 
¾
->
¥ec
.
æags
 |ğ
RTSA_REMOTE_HOST
;

631 ià(
deçuÉ_m‘ric
)

633 
¾
->
¥ec
.
deçuÉ_m‘ric
 = default_metric;

634 
¾
->
¥ec
.
æags
 |ğ
RTSA_DEFAULT_METRIC
;

637 
	`g‘_deçuÉ_g©eway
(&
¾
->
rgi
);

638 ià(
¾
->
rgi
.
æags
 & 
RGI_ADDR_DEFINED
)

640 
	`£‹nv_rou‹_addr
(
es
, "Ãt_g©eway", 
¾
->
rgi
.
g©eway
.
addr
, -1);

641 #ià
	`defšed
(
ENABLE_DEBUG
è&& !defšed(
ENABLE_SMALL
)

642 
	`´št_deçuÉ_g©eway
(
D_ROUTE
, &
¾
->
rgi
, 
NULL
);

647 
	`dmsg
(
D_ROUTE
, "ROUTE: default_gateway=UNDEF");

650 ià(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_HOST
)

652 
¾
->
¥ec
.
»mÙe_ho¡_loÿl
 = 
	`‹¡_loÿl_addr
(
»mÙe_ho¡
, &¾->
rgi
);

655 ià(
	`is_rou‹_·rm_defšed
(
»mÙe_’dpošt
))

657 
boŞ
 
defšed
 = 
çl£
;

658 
¾
->
¥ec
.
»mÙe_’dpošt
 = 
	`g‘addr
(

659 
GETADDR_RESOLVE


660 | 
GETADDR_HOST_ORDER


661 | 
GETADDR_WARN_ON_SIGNAL
,

662 
»mÙe_’dpošt
,

664 &
defšed
,

665 
NULL
);

667 ià(
defšed
)

669 
	`£‹nv_rou‹_addr
(
es
, "v²_g©eway", 
¾
->
¥ec
.
»mÙe_’dpošt
, -1);

670 
¾
->
¥ec
.
æags
 |ğ
RTSA_REMOTE_ENDPOINT
;

674 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE: failedo…arse/resolve default gateway: %s",

675 
»mÙe_’dpošt
);

676 
»t
 = 
çl£
;

680 ià(
¾
->
æags
 & 
RG_ENABLE
)

682 
	`add_block_loÿl
(
¾
);

683 
	`g‘_by·ss_add»s£s
(&
¾
->
¥ec
.
by·ss
,„l->
æags
);

684 #ifdeà
ENABLE_DEBUG


685 
	`´št_by·ss_add»s£s
(&
¾
->
¥ec
.
by·ss
);

691 
rou‹_İtiÚ
 *
ro
;

692 
ro
 = 
İt
->
rou‹s
;„o;„Øğro->
Ãxt
)

694 
addršfo
 *
Ãi¡
 = 
NULL
;

695 
rou‹_v4
 
r
;

697 ià(!
	`š™_rou‹
(&
r
, &
Ãi¡
, 
ro
, 
¾
))

699 
»t
 = 
çl£
;

703 
addršfo
 *
cu»Ë
;

704 
cu»Ë
 = 
Ãi¡
; cu»Ë; cu»Ë = cu»Ë->
ai_Ãxt
)

706 
rou‹_v4
 *
Ãw
;

707 
	`ALLOC_OBJ_GC
(
Ãw
, 
rou‹_v4
, &
¾
->
gc
);

708 *
Ãw
 = 
r
;

709 
Ãw
->
ÃtwÜk
 = 
	`Áohl
(((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->
sš_addr
.
s_addr
);

710 
Ãw
->
Ãxt
 = 
¾
->
rou‹s
;

711 
¾
->
rou‹s
 = 
Ãw
;

714 ià(
Ãi¡
)

716 
	`gc_add¥ecŸl
(
Ãi¡
, &
gc_ä“addršfo_ÿÎback
, &
gc
);

721 
	`gc_ä“
(&
gc
);

722  
»t
;

723 
	}
}

729 
boŞ


730 
	$rou‹_v6_m©ch_ho¡
ĞcÚ¡ 
rou‹_v6
 *
r6
,

731 cÚ¡ 
š6_addr
 *
ho¡
 )

733 
b™s
 = 
r6
->
Ãtb™s
;

734 
i
;

735 
mask
;

737 ià(
b™s
>128)

739  
çl£
;

742 
i
 = 0; 
b™s
 >= 8; i++, bits -= 8)

744 ià(
r6
->
ÃtwÜk
.
s6_addr
[
i
] !ğ
ho¡
->s6_addr[i])

746  
çl£
;

750 ià(
b™s
 == 0)

752  
Œue
;

755 
mask
 = 0xfà<< (8-
b™s
);

757 iàĞ(
r6
->
ÃtwÜk
.
s6_addr
[
i
] & 
mask
è=ğ(
ho¡
->s6_addr[i] & mask ))

759  
Œue
;

762  
çl£
;

763 
	}
}

765 
boŞ


766 
	$š™_rou‹_v6_li¡
(
rou‹_v6_li¡
 *
¾6
,

767 cÚ¡ 
rou‹_v6_İtiÚ_li¡
 *
İt6
,

768 cÚ¡ *
»mÙe_’dpošt
,

769 
deçuÉ_m‘ric
,

770 cÚ¡ 
š6_addr
 *
»mÙe_ho¡_v6
,

771 
’v_£t
 *
es
)

773 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

774 
boŞ
 
»t
 = 
Œue
;

775 
boŞ
 
Ãed_»mÙe_v6_rou‹
;

777 
	`ş—r_rou‹_v6_li¡
(
¾6
);

779 
¾6
->
æags
 = 
İt6
->flags;

781 ià(
»mÙe_ho¡_v6
)

783 
¾6
->
»mÙe_ho¡_v6
 = *remote_host_ipv6;

784 
¾6
->
¥ec_æags
 |ğ
RTSA_REMOTE_HOST
;

787 ià(
deçuÉ_m‘ric
 >= 0)

789 
¾6
->
deçuÉ_m‘ric
 = default_metric;

790 
¾6
->
¥ec_æags
 |ğ
RTSA_DEFAULT_METRIC
;

793 
	`msg
(
D_ROUTE
, "GDG6:„emote_host_ipv6=%s",

794 
»mÙe_ho¡_v6
 ? 
	`´št_š6_addr
(*»mÙe_ho¡_v6, 0, &
gc
) : "n/a" );

796 
	`g‘_deçuÉ_g©eway_v6
(&
¾6
->
rgi6
, 
»mÙe_ho¡_v6
);

797 ià(
¾6
->
rgi6
.
æags
 & 
RGI_ADDR_DEFINED
)

799 
	`£‹nv_¡r
(
es
, "Ãt_g©eway_v6", 
	`´št_š6_addr
(
¾6
->
rgi6
.
g©eway
.
addr_v6
, 0, &
gc
));

800 #ià
	`defšed
(
ENABLE_DEBUG
è&& !defšed(
ENABLE_SMALL
)

801 
	`´št_deçuÉ_g©eway
(
D_ROUTE
, 
NULL
, &
¾6
->
rgi6
);

806 
	`dmsg
(
D_ROUTE
, "ROUTE6: default_gateway=UNDEF");

809 ià(
	`is_rou‹_·rm_defšed
Ğ
»mÙe_’dpošt
 ))

811 ià(
	`š‘_±Ú
Ğ
AF_INET6
, 
»mÙe_’dpošt
,

812 &
¾6
->
»mÙe_’dpošt_v6
) == 1)

814 
¾6
->
¥ec_æags
 |ğ
RTSA_REMOTE_ENDPOINT
;

818 
	`msg
(
M_WARN
, 
PACKAGE_NAME
 " ROUTE: faedØ·r£/»sŞvVPNƒndpošt: %s", 
»mÙe_’dpošt
);

819 
»t
 = 
çl£
;

826 
Ãed_»mÙe_v6_rou‹
 = 
çl£
;

829 
rou‹_v6_İtiÚ
 *
ro6
;

830 
ro6
 = 
İt6
->
rou‹s_v6
;„o6;„o6 =„o6->
Ãxt
)

832 
rou‹_v6
 *
r6
;

833 
	`ALLOC_OBJ_GC
(
r6
, 
rou‹_v6
, &
¾6
->
gc
);

834 ià(!
	`š™_rou‹_v6
(
r6
, 
ro6
, 
¾6
))

836 
»t
 = 
çl£
;

840 
r6
->
Ãxt
 = 
¾6
->
rou‹s_v6
;

841 
¾6
->
rou‹s_v6
 = 
r6
;

843 #iâdeà
TARGET_ANDROID


848 ià(
»mÙe_ho¡_v6


849 && 
	`rou‹_v6_m©ch_ho¡
Ğ
r6
, 
»mÙe_ho¡_v6
 ) )

851 
Ãed_»mÙe_v6_rou‹
 = 
Œue
;

852 
	`msg
(
D_ROUTE
, "ROUTE6: %s/%d overlaps IPv6„emote %s,‡dding host„outeo VPNƒndpoint",

853 
	`´št_š6_addr
(
r6
->
ÃtwÜk
, 0, &
gc
),„6->
Ãtb™s
,

854 
	`´št_š6_addr
(*
»mÙe_ho¡_v6
, 0, &
gc
));

862 ià(
Ãed_»mÙe_v6_rou‹
)

864 iàĞ(
¾6
->
rgi6
.
æags
 & (
RGI_ADDR_DEFINED
|
RGI_IFACE_DEFINED
) ) ==

865 (
RGI_ADDR_DEFINED
|
RGI_IFACE_DEFINED
) )

867 
rou‹_v6
 *
r6
;

868 
	`ALLOC_OBJ_CLEAR_GC
(
r6
, 
rou‹_v6
, &
¾6
->
gc
);

870 
r6
->
ÃtwÜk
 = *
»mÙe_ho¡_v6
;

871 
r6
->
Ãtb™s
 = 128;

872 ià(!(
¾6
->
rgi6
.
æags
 & 
RGI_ON_LINK
) )

874 
r6
->
g©eway
 = 
¾6
->
rgi6
.g©eway.
addr_v6
;

876 
r6
->
m‘ric
 = 1;

877 #ifdeà
_WIN32


878 
r6
->
ad­‹r_šdex
 = 
¾6
->
rgi6
.adapter_index;

880 
r6
->
içû
 = 
¾6
->
rgi6
.iface;

882 
r6
->
æags
 = 
RT_DEFINED
 | 
RT_METRIC_DEFINED
;

884 
r6
->
Ãxt
 = 
¾6
->
rou‹s_v6
;

885 
¾6
->
rou‹s_v6
 = 
r6
;

889 
	`msg
(
M_WARN
, "ROUTE6: IPv6„oute overlaps with IPv6„emote‡ddress, but could‚ot determine IPv6 gateway‡ddress + interface,ƒxpect failure\n" );

893 
	`gc_ä“
(&
gc
);

894  
»t
;

895 
	}
}

898 
	$add_rou‹3
(
š_addr_t
 
ÃtwÜk
,

899 
š_addr_t
 
Ãtmask
,

900 
š_addr_t
 
g©eway
,

901 cÚ¡ 
tuÁ­
 *
‰
,

902 
æags
,

903 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

904 cÚ¡ 
’v_£t
 *
es
)

906 
rou‹_v4
 
r
;

907 
	`CLEAR
(
r
);

908 
r
.
æags
 = 
RT_DEFINED
;

909 
r
.
ÃtwÜk
 =‚etwork;

910 
r
.
Ãtmask
 =‚etmask;

911 
r
.
g©eway
 = gateway;

912 
	`add_rou‹
(&
r
, 
‰
, 
æags
, 
rgi
, 
es
);

913 
	}
}

916 
	$d–_rou‹3
(
š_addr_t
 
ÃtwÜk
,

917 
š_addr_t
 
Ãtmask
,

918 
š_addr_t
 
g©eway
,

919 cÚ¡ 
tuÁ­
 *
‰
,

920 
æags
,

921 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

922 cÚ¡ 
’v_£t
 *
es
)

924 
rou‹_v4
 
r
;

925 
	`CLEAR
(
r
);

926 
r
.
æags
 = 
RT_DEFINED
|
RT_ADDED
;

927 
r
.
ÃtwÜk
 =‚etwork;

928 
r
.
Ãtmask
 =‚etmask;

929 
r
.
g©eway
 = gateway;

930 
	`d–‘e_rou‹
(&
r
, 
‰
, 
æags
, 
rgi
, 
es
);

931 
	}
}

934 
	$add_by·ss_rou‹s
(
rou‹_by·ss
 *
rb
,

935 
š_addr_t
 
g©eway
,

936 cÚ¡ 
tuÁ­
 *
‰
,

937 
æags
,

938 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

939 cÚ¡ 
’v_£t
 *
es
)

941 
i
;

942 
i
 = 0; i < 
rb
->
n_by·ss
; ++i)

944 ià(
rb
->
by·ss
[
i
])

946 
	`add_rou‹3
(
rb
->
by·ss
[
i
],

947 
IPV4_NETMASK_HOST
,

948 
g©eway
,

949 
‰
,

950 
æags
 | 
ROUTE_REF_GW
,

951 
rgi
,

952 
es
);

955 
	}
}

958 
	$d–_by·ss_rou‹s
(
rou‹_by·ss
 *
rb
,

959 
š_addr_t
 
g©eway
,

960 cÚ¡ 
tuÁ­
 *
‰
,

961 
æags
,

962 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

963 cÚ¡ 
’v_£t
 *
es
)

965 
i
;

966 
i
 = 0; i < 
rb
->
n_by·ss
; ++i)

968 ià(
rb
->
by·ss
[
i
])

970 
	`d–_rou‹3
(
rb
->
by·ss
[
i
],

971 
IPV4_NETMASK_HOST
,

972 
g©eway
,

973 
‰
,

974 
æags
 | 
ROUTE_REF_GW
,

975 
rgi
,

976 
es
);

979 
	}
}

982 
	$»dœeù_deçuÉ_rou‹_to_v²
(
rou‹_li¡
 *
¾
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

984 cÚ¡ 
”r
[] = "NOTE: unableo„edirect default gateway --";

986 ià(
¾
 &&„l->
æags
 & 
RG_ENABLE
)

988 
boŞ
 
loÿl
 = 
¾
->
æags
 & 
RG_LOCAL
;

990 ià(!(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_ENDPOINT
è&& (¾->æag & 
RG_REROUTE_GW
))

992 
	`msg
(
M_WARN
, "% VPN g©eway…¬am‘” (--rou‹-g©eway o¸--ifcÚfigèi missšg", 
”r
);

999 ià(!(
¾
->
rgi
.
æags
 & 
RGI_ADDR_DEFINED
è&& !
loÿl


1000 && (
¾
->
¥ec
.
»mÙe_ho¡
 !ğ
IPV4_INVALID_ADDR
))

1002 
	`msg
(
M_WARN
, "% CªnÙ„—d cu¼’ˆdeçuÉ g©eway from sy¡em", 
”r
);

1004 ià(!(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_HOST
))

1006 
	`msg
(
M_WARN
, "% CªnÙ obš cu¼’ˆ»mÙho¡‡dd»ss", 
”r
);

1010 #iâdeà
TARGET_ANDROID


1011 ià(
¾
->
æags
 & 
RG_AUTO_LOCAL
)

1013 cÚ¡ 
a
 = 
¾
->
¥ec
.
»mÙe_ho¡_loÿl
;

1014 ià(
a
 =ğ
TLA_NONLOCAL
)

1016 
	`dmsg
(
D_ROUTE
, "ROUTE„emote_host is NOT LOCAL");

1017 
loÿl
 = 
çl£
;

1019 ià(
a
 =ğ
TLA_LOCAL
)

1021 
	`dmsg
(
D_ROUTE
, "ROUTE„emote_host is LOCAL");

1022 
loÿl
 = 
Œue
;

1025 ià(!
loÿl
)

1030 ià(
¾
->
¥ec
.
»mÙe_ho¡
 !ğ
IPV4_INVALID_ADDR
)

1032 
	`add_rou‹3
(
¾
->
¥ec
.
»mÙe_ho¡
,

1033 
IPV4_NETMASK_HOST
,

1034 
¾
->
rgi
.
g©eway
.
addr
,

1035 
‰
,

1036 
æags
 | 
ROUTE_REF_GW
,

1037 &
¾
->
rgi
,

1038 
es
);

1039 
¾
->
iæags
 |ğ
RL_DID_LOCAL
;

1043 
	`dmsg
(
D_ROUTE
, "ROUTE„emote_host…rotocol differs fromunneled");

1049 
	`add_by·ss_rou‹s
(&
¾
->
¥ec
.
by·ss
,„l->
rgi
.
g©eway
.
addr
, 
‰
, 
æags
, &¾->rgi, 
es
);

1051 ià(
¾
->
æags
 & 
RG_REROUTE_GW
)

1053 ià(
¾
->
æags
 & 
RG_DEF1
)

1056 
	`add_rou‹3
(0x00000000,

1058 
¾
->
¥ec
.
»mÙe_’dpošt
,

1059 
‰
,

1060 
æags
,

1061 &
¾
->
rgi
,

1062 
es
);

1065 
	`add_rou‹3
(0x80000000,

1067 
¾
->
¥ec
.
»mÙe_’dpošt
,

1068 
‰
,

1069 
æags
,

1070 &
¾
->
rgi
,

1071 
es
);

1076 ià(
¾
->
rgi
.
æags
 & 
RGI_ADDR_DEFINED
)

1079 
	`d–_rou‹3
(0, 0, 
¾
->
rgi
.
g©eway
.
addr
, 
‰
,

1080 
æags
 | 
ROUTE_REF_GW
, &
¾
->
rgi
, 
es
);

1084 
	`add_rou‹3
(0,

1086 
¾
->
¥ec
.
»mÙe_’dpošt
,

1087 
‰
,

1088 
æags
,

1089 &
¾
->
rgi
,

1090 
es
);

1095 
¾
->
iæags
 |ğ
RL_DID_REDIRECT_DEFAULT_GATEWAY
;

1098 
	}
}

1101 
	$undo_»dœeù_deçuÉ_rou‹_to_v²
(
rou‹_li¡
 *
¾
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

1103 ià(
¾
 &&„l->
iæags
 & 
RL_DID_REDIRECT_DEFAULT_GATEWAY
)

1106 ià(
¾
->
iæags
 & 
RL_DID_LOCAL
)

1108 
	`d–_rou‹3
(
¾
->
¥ec
.
»mÙe_ho¡
,

1109 
IPV4_NETMASK_HOST
,

1110 
¾
->
rgi
.
g©eway
.
addr
,

1111 
‰
,

1112 
æags
 | 
ROUTE_REF_GW
,

1113 &
¾
->
rgi
,

1114 
es
);

1115 
¾
->
iæags
 &ğ~
RL_DID_LOCAL
;

1119 
	`d–_by·ss_rou‹s
(&
¾
->
¥ec
.
by·ss
,„l->
rgi
.
g©eway
.
addr
, 
‰
, 
æags
, &¾->rgi, 
es
);

1121 ià(
¾
->
æags
 & 
RG_REROUTE_GW
)

1123 ià(
¾
->
æags
 & 
RG_DEF1
)

1126 
	`d–_rou‹3
(0x00000000,

1128 
¾
->
¥ec
.
»mÙe_’dpošt
,

1129 
‰
,

1130 
æags
,

1131 &
¾
->
rgi
,

1132 
es
);

1135 
	`d–_rou‹3
(0x80000000,

1137 
¾
->
¥ec
.
»mÙe_’dpošt
,

1138 
‰
,

1139 
æags
,

1140 &
¾
->
rgi
,

1141 
es
);

1146 
	`d–_rou‹3
(0,

1148 
¾
->
¥ec
.
»mÙe_’dpošt
,

1149 
‰
,

1150 
æags
,

1151 &
¾
->
rgi
,

1152 
es
);

1154 ià(
¾
->
rgi
.
æags
 & 
RGI_ADDR_DEFINED
)

1156 
	`add_rou‹3
(0, 0, 
¾
->
rgi
.
g©eway
.
addr
, 
‰
,

1157 
æags
 | 
ROUTE_REF_GW
, &
¾
->
rgi
, 
es
);

1162 
¾
->
iæags
 &ğ~
RL_DID_REDIRECT_DEFAULT_GATEWAY
;

1164 
	}
}

1167 
	$add_rou‹s
(
rou‹_li¡
 *
¾
, 
rou‹_v6_li¡
 *
¾6
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

1169 
	`»dœeù_deçuÉ_rou‹_to_v²
(
¾
, 
‰
, 
æags
, 
es
);

1170 ià(
¾
 && !Ôl->
iæags
 & 
RL_ROUTES_ADDED
) )

1172 
rou‹_v4
 *
r
;

1174 #ifdeà
ENABLE_MANAGEMENT


1175 ià(
mªagem’t
 && 
¾
->
rou‹s
)

1177 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

1178 
OPENVPN_STATE_ADD_ROUTES
,

1179 
NULL
,

1180 
NULL
,

1181 
NULL
,

1182 
NULL
,

1183 
NULL
);

1187 
r
 = 
¾
->
rou‹s
;„;„ =„->
Ãxt
)

1189 
	`check_subÃt_cÚæiù
(
r
->
ÃtwÜk
,„->
Ãtmask
, "route");

1190 ià(
æags
 & 
ROUTE_DELETE_FIRST
)

1192 
	`d–‘e_rou‹
(
r
, 
‰
, 
æags
, &
¾
->
rgi
, 
es
);

1194 
	`add_rou‹
(
r
, 
‰
, 
æags
, &
¾
->
rgi
, 
es
);

1196 
¾
->
iæags
 |ğ
RL_ROUTES_ADDED
;

1198 ià(
¾6
 && !Ôl6->
iæags
 & 
RL_ROUTES_ADDED
) )

1200 
rou‹_v6
 *
r
;

1202 ià(!
‰
->
did_ifcÚfig_v6_£tup
)

1204 
	`msg
(
M_INFO
, "WARNING: OpenVPN was configuredo‡dd‡n IPv6 "

1207 "ç o¸may‚Ù wÜk‡ ex³ùed.", 
‰
->
aùu®_Çme
);

1210 
r
 = 
¾6
->
rou‹s_v6
;„;„ =„->
Ãxt
)

1212 ià(
æags
 & 
ROUTE_DELETE_FIRST
)

1214 
	`d–‘e_rou‹_v6
(
r
, 
‰
, 
æags
, 
es
);

1216 
	`add_rou‹_v6
(
r
, 
‰
, 
æags
, 
es
);

1218 
¾6
->
iæags
 |ğ
RL_ROUTES_ADDED
;

1220 
	}
}

1223 
	$d–‘e_rou‹s
(
rou‹_li¡
 *
¾
, 
rou‹_v6_li¡
 *
¾6
,

1224 cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

1226 ià(
¾
 &&„l->
iæags
 & 
RL_ROUTES_ADDED
)

1228 
rou‹_v4
 *
r
;

1229 
r
 = 
¾
->
rou‹s
;„;„ =„->
Ãxt
)

1231 
	`d–‘e_rou‹
(
r
, 
‰
, 
æags
, &
¾
->
rgi
, 
es
);

1233 
¾
->
iæags
 &ğ~
RL_ROUTES_ADDED
;

1236 
	`undo_»dœeù_deçuÉ_rou‹_to_v²
(
¾
, 
‰
, 
æags
, 
es
);

1238 ià(
¾
)

1240 
	`ş—r_rou‹_li¡
(
¾
);

1243 ià(
¾6
 && (¾6->
iæags
 & 
RL_ROUTES_ADDED
) )

1245 
rou‹_v6
 *
r6
;

1246 
r6
 = 
¾6
->
rou‹s_v6
;„6;„6 =„6->
Ãxt
)

1248 
	`d–‘e_rou‹_v6
(
r6
, 
‰
, 
æags
, 
es
);

1250 
¾6
->
iæags
 &ğ~
RL_ROUTES_ADDED
;

1253 ià(
¾6
)

1255 
	`ş—r_rou‹_v6_li¡
(
¾6
);

1257 
	}
}

1259 #iâdeà
ENABLE_SMALL


1262 
	$show_İt
(cÚ¡ *
İtiÚ
)

1264 ià(!
İtiÚ
)

1270  
İtiÚ
;

1272 
	}
}

1275 
	$´št_rou‹_İtiÚ
(cÚ¡ 
rou‹_İtiÚ
 *
ro
, 
Ëv–
)

1277 
	`msg
(
Ëv–
, "„oute %s/%s/%s/%s",

1278 
	`show_İt
(
ro
->
ÃtwÜk
),

1279 
	`show_İt
(
ro
->
Ãtmask
),

1280 
	`show_İt
(
ro
->
g©eway
),

1281 
	`show_İt
(
ro
->
m‘ric
));

1282 
	}
}

1285 
	$´št_rou‹_İtiÚs
(cÚ¡ 
rou‹_İtiÚ_li¡
 *
rŞ
,

1286 
Ëv–
)

1288 
rou‹_İtiÚ
 *
ro
;

1289 ià(
rŞ
->
æags
 & 
RG_ENABLE
)

1291 
	`msg
(
Ëv–
, " [redirect_default_gateway†ocal=%d]",

1292 (
rŞ
->
æags
 & 
RG_LOCAL
) != 0);

1294 
ro
 = 
rŞ
->
rou‹s
;„o;„Øğro->
Ãxt
)

1296 
	`´št_rou‹_İtiÚ
(
ro
, 
Ëv–
);

1298 
	}
}

1301 
	$´št_deçuÉ_g©eway
(cÚ¡ 
msgËv–
,

1302 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

1303 cÚ¡ 
rou‹_v6_g©eway_šfo
 *
rgi6
)

1305 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1306 ià(
rgi
 && (rgi->
æags
 & 
RGI_ADDR_DEFINED
))

1308 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

1309 
	`buf_´štf
(&
out
, "ROUTE_GATEWAY");

1310 ià(
rgi
->
æags
 & 
RGI_ON_LINK
)

1312 
	`buf_´štf
(&
out
, " ON_LINK");

1316 
	`buf_´štf
(&
out
, " %s", 
	`´št_š_addr_t
(
rgi
->
g©eway
.
addr
, 0, &
gc
));

1318 ià(
rgi
->
æags
 & 
RGI_NETMASK_DEFINED
)

1320 
	`buf_´štf
(&
out
, "/%s", 
	`´št_š_addr_t
(
rgi
->
g©eway
.
Ãtmask
, 0, &
gc
));

1322 #ifdeà
_WIN32


1323 ià(
rgi
->
æags
 & 
RGI_IFACE_DEFINED
)

1325 
	`buf_´štf
(&
out
, " I=%u", ()
rgi
->
ad­‹r_šdex
);

1328 ià(
rgi
->
æags
 & 
RGI_IFACE_DEFINED
)

1330 
	`buf_´štf
(&
out
, " IFACE=%s", 
rgi
->
içû
);

1333 ià(
rgi
->
æags
 & 
RGI_HWADDR_DEFINED
)

1335 
	`buf_´štf
(&
out
, " HWADDR=%s", 
	`fÜm©_hex_ex
(
rgi
->
hwaddr
, 6, 0, 1, ":", &
gc
));

1337 
	`msg
(
msgËv–
, "%s", 
	`BSTR
(&
out
));

1340 ià(
rgi6
 && (rgi6->
æags
 & 
RGI_ADDR_DEFINED
))

1342 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

1343 
	`buf_´štf
(&
out
, "ROUTE6_GATEWAY");

1344 
	`buf_´štf
(&
out
, " %s", 
	`´št_š6_addr
(
rgi6
->
g©eway
.
addr_v6
, 0, &
gc
));

1345 ià(
rgi6
->
æags
 & 
RGI_ON_LINK
)

1347 
	`buf_´štf
(&
out
, " ON_LINK");

1349 ià(
rgi6
->
æags
 & 
RGI_NETMASK_DEFINED
)

1351 
	`buf_´štf
(&
out
, "/%d", 
rgi6
->
g©eway
.
Ãtb™s_v6
);

1353 #ifdeà
_WIN32


1354 ià(
rgi6
->
æags
 & 
RGI_IFACE_DEFINED
)

1356 
	`buf_´štf
(&
out
, " I=%u", ()
rgi6
->
ad­‹r_šdex
);

1359 ià(
rgi6
->
æags
 & 
RGI_IFACE_DEFINED
)

1361 
	`buf_´štf
(&
out
, " IFACE=%s", 
rgi6
->
içû
);

1364 ià(
rgi6
->
æags
 & 
RGI_HWADDR_DEFINED
)

1366 
	`buf_´štf
(&
out
, " HWADDR=%s", 
	`fÜm©_hex_ex
(
rgi6
->
hwaddr
, 6, 0, 1, ":", &
gc
));

1368 
	`msg
(
msgËv–
, "%s", 
	`BSTR
(&
out
));

1370 
	`gc_ä“
(&
gc
);

1371 
	}
}

1376 
	$´št_rou‹
(cÚ¡ 
rou‹_v4
 *
r
, 
Ëv–
)

1378 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1379 ià(
r
->
æags
 & 
RT_DEFINED
)

1381 
	`msg
(
Ëv–
, "%s", 
	`rou‹_¡ršg
(
r
, &
gc
));

1383 
	`gc_ä“
(&
gc
);

1384 
	}
}

1387 
	$´št_rou‹s
(cÚ¡ 
rou‹_li¡
 *
¾
, 
Ëv–
)

1389 
rou‹_v4
 *
r
;

1390 
r
 = 
¾
->
rou‹s
;„;„ =„->
Ãxt
)

1392 
	`´št_rou‹
(
r
, 
Ëv–
);

1394 
	}
}

1397 
	$£‹nv_rou‹
(
’v_£t
 *
es
, cÚ¡ 
rou‹_v4
 *
r
, 
i
)

1399 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1400 ià(
r
->
æags
 & 
RT_DEFINED
)

1402 
	`£‹nv_rou‹_addr
(
es
, "ÃtwÜk", 
r
->
ÃtwÜk
, 
i
);

1403 
	`£‹nv_rou‹_addr
(
es
, "Ãtmask", 
r
->
Ãtmask
, 
i
);

1404 
	`£‹nv_rou‹_addr
(
es
, "g©eway", 
r
->
g©eway
, 
i
);

1406 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1408 
bufãr
 
Çme
 = 
	`®loc_buf_gc
(256, &
gc
);

1409 
	`buf_´štf
(&
Çme
, "rou‹_m‘ric_%d", 
i
);

1410 
	`£‹nv_št
(
es
, 
	`BSTR
(&
Çme
), 
r
->
m‘ric
);

1413 
	`gc_ä“
(&
gc
);

1414 
	}
}

1417 
	$£‹nv_rou‹s
(
’v_£t
 *
es
, cÚ¡ 
rou‹_li¡
 *
¾
)

1419 
i
 = 1;

1420 
rou‹_v4
 *
r
;

1421 
r
 = 
¾
->
rou‹s
;„;„ =„->
Ãxt
)

1423 
	`£‹nv_rou‹
(
es
, 
r
, 
i
++);

1425 
	}
}

1428 
	$£‹nv_rou‹_v6
(
’v_£t
 *
es
, cÚ¡ 
rou‹_v6
 *
r6
, 
i
)

1430 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1431 ià(
r6
->
æags
 & 
RT_DEFINED
)

1433 
bufãr
 
Çme1
 = 
	`®loc_buf_gc
Ğ256, &
gc
 );

1434 
bufãr
 
v®
 = 
	`®loc_buf_gc
Ğ256, &
gc
 );

1435 
bufãr
 
Çme2
 = 
	`®loc_buf_gc
Ğ256, &
gc
 );

1437 
	`buf_´štf
Ğ&
Çme1
, "rou‹_v6_ÃtwÜk_%d", 
i
 );

1438 
	`buf_´štf
Ğ&
v®
, "%s/%d", 
	`´št_š6_addr
Ğ
r6
->
ÃtwÜk
, 0, &
gc
 ),

1439 
r6
->
Ãtb™s
 );

1440 
	`£‹nv_¡r
Ğ
es
, 
	`BSTR
(&
Çme1
), BSTR(&
v®
) );

1442 
	`buf_´štf
Ğ&
Çme2
, "rou‹_v6_g©eway_%d", 
i
 );

1443 
	`£‹nv_¡r
Ğ
es
, 
	`BSTR
(&
Çme2
), 
	`´št_š6_addr
Ğ
r6
->
g©eway
, 0, &
gc
 ));

1445 
	`gc_ä“
(&
gc
);

1446 
	}
}

1448 
	$£‹nv_rou‹s_v6
(
’v_£t
 *
es
, cÚ¡ 
rou‹_v6_li¡
 *
¾6
)

1450 
i
 = 1;

1451 
rou‹_v6
 *
r6
;

1452 
r6
 = 
¾6
->
rou‹s_v6
;„6;„6 =„6->
Ãxt
)

1454 
	`£‹nv_rou‹_v6
(
es
, 
r6
, 
i
++);

1456 
	}
}

1477 
	#LR_NOMATCH
 0

	)

1478 
	#LR_MATCH
 1

	)

1479 
	#LR_ERROR
 2

	)

1482 
	$loÿl_rou‹
(
š_addr_t
 
ÃtwÜk
,

1483 
š_addr_t
 
Ãtmask
,

1484 
š_addr_t
 
g©eway
,

1485 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
)

1488 cÚ¡ 
rgi_Ãeded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
|
RGI_IFACE_DEFINED
);

1489 ià(
rgi


1490 && (
rgi
->
æags
 & 
rgi_Ãeded
) ==„gi_needed

1491 && 
g©eway
 =ğ
rgi
->g©eway.
addr


1492 && 
Ãtmask
 == 0xFFFFFFFF)

1494 ià(((
ÃtwÜk
 ^ 
rgi
->
g©eway
.
addr
è&„gi->g©eway.
Ãtmask
) == 0)

1496  
LR_MATCH
;

1501 
size_t
 
i
;

1502 
i
 = 0; i < 
rgi
->
n_addrs
; ++i)

1504 cÚ¡ 
rou‹_g©eway_add»ss
 *
gwa
 = &
rgi
->
addrs
[
i
];

1505 ià(((
ÃtwÜk
 ^ 
gwa
->
addr
è& gwa->
Ãtmask
) == 0)

1507  
LR_MATCH
;

1512  
LR_NOMATCH
;

1513 
	}
}

1517 
šlše
 
boŞ


1518 
	$is_Ú_lšk
(cÚ¡ 
is_loÿl_rou‹
, cÚ¡ 
æags
, cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
)

1520  
rgi
 && (
is_loÿl_rou‹
 =ğ
LR_MATCH
 || ((
æags
 & 
ROUTE_REF_GW
è&& (rgi->æag & 
RGI_ON_LINK
)));

1521 
	}
}

1524 
	$add_rou‹
(
rou‹_v4
 *
r
,

1525 cÚ¡ 
tuÁ­
 *
‰
,

1526 
æags
,

1527 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

1528 cÚ¡ 
’v_£t
 *
es
)

1530 
gc_¬’a
 
gc
;

1531 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1532 cÚ¡ *
ÃtwÜk
;

1533 #ià!
	`defšed
(
ENABLE_IPROUTE
è&& !defšed(
TARGET_AIX
)

1534 cÚ¡ *
Ãtmask
;

1536 cÚ¡ *
g©eway
;

1537 
boŞ
 
¡©us
 = 
çl£
;

1538 
is_loÿl_rou‹
;

1540 ià(!(
r
->
æags
 & 
RT_DEFINED
))

1545 
	`gc_š™
(&
gc
);

1547 
ÃtwÜk
 = 
	`´št_š_addr_t
(
r
->ÃtwÜk, 0, &
gc
);

1548 #ià!
	`defšed
(
ENABLE_IPROUTE
è&& !defšed(
TARGET_AIX
)

1549 
Ãtmask
 = 
	`´št_š_addr_t
(
r
->Ãtmask, 0, &
gc
);

1551 
g©eway
 = 
	`´št_š_addr_t
(
r
->g©eway, 0, &
gc
);

1553 
is_loÿl_rou‹
 = 
	`loÿl_rou‹
(
r
->
ÃtwÜk
,„->
Ãtmask
,„->
g©eway
, 
rgi
);

1554 ià(
is_loÿl_rou‹
 =ğ
LR_ERROR
)

1556 
dÚe
;

1559 #ià
	`defšed
(
TARGET_LINUX
)

1560 #ifdeà
ENABLE_IPROUTE


1561 
	`¬gv_´štf
(&
¬gv
, "%s„oute‡dd %s/%d",

1562 
rou‹_·th
,

1563 
ÃtwÜk
,

1564 
	`Ãtmask_to_Ãtb™s2
(
r
->
Ãtmask
));

1566 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1568 
	`¬gv_´štf_ÿt
(&
¬gv
, "m‘riø%d", 
r
->
m‘ric
);

1571 ià(
	`is_Ú_lšk
(
is_loÿl_rou‹
, 
æags
, 
rgi
))

1573 
	`¬gv_´štf_ÿt
(&
¬gv
, "dev %s", 
rgi
->
içû
);

1577 
	`¬gv_´štf_ÿt
(&
¬gv
, "vŸ %s", 
g©eway
);

1580 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -net %s‚etmask %s",

1581 
ROUTE_PATH
,

1582 
ÃtwÜk
,

1583 
Ãtmask
);

1584 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1586 
	`¬gv_´štf_ÿt
(&
¬gv
, "m‘riø%d", 
r
->
m‘ric
);

1588 ià(
	`is_Ú_lšk
(
is_loÿl_rou‹
, 
æags
, 
rgi
))

1590 
	`¬gv_´štf_ÿt
(&
¬gv
, "dev %s", 
rgi
->
içû
);

1594 
	`¬gv_´štf_ÿt
(&
¬gv
, "gw %s", 
g©eway
);

1598 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1599 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Linux„oute‡dd command failed");

1601 #–ià
	`defšed
 (
TARGET_ANDROID
)

1602 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, &
gc
);

1604 ià(
rgi
)

1606 
	`buf_´štf
(&
out
, "% % % dev %s", 
ÃtwÜk
, 
Ãtmask
, 
g©eway
, 
rgi
->
içû
);

1610 
	`buf_´štf
(&
out
, "% % %s", 
ÃtwÜk
, 
Ãtmask
, 
g©eway
);

1612 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "ROUTE", 
	`buf_b±r
(&
out
));

1614 #–ià
	`defšed
 (
_WIN32
)

1616 
DWORD
 
ai
 = 
TUN_ADAPTER_INDEX_INVALID
;

1617 
	`¬gv_´štf
(&
¬gv
, "%s%sc ADD %s MASK %s %s",

1618 
	`g‘_wš_sys_·th
(),

1619 
WIN_ROUTE_PATH_SUFFIX
,

1620 
ÃtwÜk
,

1621 
Ãtmask
,

1622 
g©eway
);

1623 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1625 
	`¬gv_´štf_ÿt
(&
¬gv
, "METRIC %d", 
r
->
m‘ric
);

1627 ià(
	`is_Ú_lšk
(
is_loÿl_rou‹
, 
æags
, 
rgi
))

1629 
ai
 = 
rgi
->
ad­‹r_šdex
;

1630 
	`¬gv_´štf_ÿt
(&
¬gv
, "IF %u", ()
ai
);

1633 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1635 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_SERVICE
)

1637 
¡©us
 = 
	`add_rou‹_£rviû
(
r
, 
‰
);

1638 
	`msg
(
D_ROUTE
, "Rou‹‡dd™iÚ vŸ s”viû %s", 
¡©us
 ? "succeeded" : "failed");

1640 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_IPAPI
)

1642 
¡©us
 = 
	`add_rou‹_­i
(
r
, 
‰
, 
ai
);

1643 
	`msg
(
D_ROUTE
, "Rou‹‡dd™iÚ vŸ IPAPI %s", 
¡©us
 ? "succeeded" : "failed");

1645 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_EXE
)

1647 
	`Ãtcmd_£m­hÜe_lock
();

1648 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute‡dd command failed");

1649 
	`Ãtcmd_£m­hÜe_»Ëa£
();

1651 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_ADAPTIVE
)

1653 
¡©us
 = 
	`add_rou‹_­i
(
r
, 
‰
, 
ai
);

1654 
	`msg
(
D_ROUTE
, "Rou‹‡dd™iÚ vŸ IPAPI % [ad­tive]", 
¡©us
 ? "succeeded" : "failed");

1655 ià(!
¡©us
)

1657 
	`msg
(
D_ROUTE
, "Route‡ddition fallbacko„oute.exe");

1658 
	`Ãtcmd_£m­hÜe_lock
();

1659 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute‡dd command failed [adaptive]");

1660 
	`Ãtcmd_£m­hÜe_»Ëa£
();

1665 
	`ASSERT
(0);

1669 #–ià
	`defšed
 (
TARGET_SOLARIS
)

1673 
	`¬gv_´štf
(&
¬gv
, "%s‡dd",

1674 
ROUTE_PATH
);

1676 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s -netmask %s %s",

1677 
ÃtwÜk
,

1678 
Ãtmask
,

1679 
g©eway
);

1688 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1690 
	`¬gv_´štf_ÿt
(&
¬gv
, "%d", 
r
->
m‘ric
);

1693 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1694 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Solaris„oute‡dd command failed");

1696 #–ià
	`defšed
(
TARGET_FREEBSD
)

1698 
	`¬gv_´štf
(&
¬gv
, "%s‡dd",

1699 
ROUTE_PATH
);

1702 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1704 
	`¬gv_´štf_ÿt
(&
¬gv
, "-¹ˆ%d", 
r
->
m‘ric
);

1708 
	`¬gv_´štf_ÿt
(&
¬gv
, "-net %s %s %s",

1709 
ÃtwÜk
,

1710 
g©eway
,

1711 
Ãtmask
);

1715 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1716 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: FreeBSD„oute‡dd command failed");

1718 #–ià
	`defšed
(
TARGET_DRAGONFLY
)

1720 
	`¬gv_´štf
(&
¬gv
, "%s‡dd",

1721 
ROUTE_PATH
);

1724 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1726 
	`¬gv_´štf_ÿt
(&
¬gv
, "-¹ˆ%d", 
r
->
m‘ric
);

1730 
	`¬gv_´štf_ÿt
(&
¬gv
, "-net %s %s %s",

1731 
ÃtwÜk
,

1732 
g©eway
,

1733 
Ãtmask
);

1737 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1738 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: DragonFly„oute‡dd command failed");

1740 #–ià
	`defšed
(
TARGET_DARWIN
)

1742 
	`¬gv_´štf
(&
¬gv
, "%s‡dd",

1743 
ROUTE_PATH
);

1746 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1748 
	`¬gv_´štf_ÿt
(&
¬gv
, "-¹ˆ%d", 
r
->
m‘ric
);

1752 ià(
	`is_Ú_lšk
(
is_loÿl_rou‹
, 
æags
, 
rgi
))

1756 
	`¬gv_´štf_ÿt
(&
¬gv
, "-cloning -net %s -netmask %s -interface %s",

1757 
ÃtwÜk
,

1758 
Ãtmask
,

1759 
rgi
->
içû
);

1763 
	`¬gv_´štf_ÿt
(&
¬gv
, "-net %s %s %s",

1764 
ÃtwÜk
,

1765 
g©eway
,

1766 
Ãtmask
);

1769 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1770 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OS X„oute‡dd command failed");

1772 #–ià
	`defšed
(
TARGET_OPENBSD
è|| defšed(
TARGET_NETBSD
)

1774 
	`¬gv_´štf
(&
¬gv
, "%s‡dd",

1775 
ROUTE_PATH
);

1778 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

1780 
	`¬gv_´štf_ÿt
(&
¬gv
, "-¹ˆ%d", 
r
->
m‘ric
);

1784 
	`¬gv_´štf_ÿt
(&
¬gv
, "-net %s %s -netmask %s",

1785 
ÃtwÜk
,

1786 
g©eway
,

1787 
Ãtmask
);

1791 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1792 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OpenBSD/NetBSD„oute‡dd command failed");

1794 #–ià
	`defšed
(
TARGET_AIX
)

1797 
Ãtb™s
 = 
	`Ãtmask_to_Ãtb™s2
(
r
->
Ãtmask
);

1798 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -net %s/%d %s",

1799 
ROUTE_PATH
,

1800 
ÃtwÜk
, 
Ãtb™s
, 
g©eway
);

1801 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1802 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: AIX„oute‡dd command failed");

1806 
	`msg
(
M_FATAL
, "Sorry, but I don't know howo do 'route' commands onhis operating system. Try…utting your„outes in‡ --route-up script");

1809 
dÚe
:

1810 ià(
¡©us
)

1812 
r
->
æags
 |ğ
RT_ADDED
;

1816 
r
->
æags
 &ğ~
RT_ADDED
;

1818 
	`¬gv_»£t
(&
¬gv
);

1819 
	`gc_ä“
(&
gc
);

1820 
	}
}

1824 
	$rou‹_v6_ş—r_ho¡_b™s
Ğ
rou‹_v6
 *
r6
 )

1830 
by‹
 = 15;

1831 
b™s_to_ş—r
 = 128 - 
r6
->
Ãtb™s
;

1833 
by‹
 >ğ0 && 
b™s_to_ş—r
 > 0)

1835 ià(
b™s_to_ş—r
 >= 8)

1837 
r6
->
ÃtwÜk
.
s6_addr
[
by‹
--] = 0; 
b™s_to_ş—r
 -= 8;

1841 
r6
->
ÃtwÜk
.
s6_addr
[
by‹
--] &ğ(0xfà<< 
b™s_to_ş—r
); bits_to_clear = 0;

1844 
	}
}

1847 
	$add_rou‹_v6
(
rou‹_v6
 *
r6
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

1849 
gc_¬’a
 
gc
;

1850 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1852 cÚ¡ *
ÃtwÜk
;

1853 cÚ¡ *
g©eway
;

1854 
boŞ
 
¡©us
 = 
çl£
;

1855 cÚ¡ *
deviû
 = 
‰
->
aùu®_Çme
;

1857 
boŞ
 
g©eway_Ãeded
 = 
çl£
;

1859 ià(!(
r6
->
æags
 & 
RT_DEFINED
) )

1864 #iâdeà
_WIN32


1865 ià(
r6
->
içû
 !ğ
NULL
)

1867 
deviû
 = 
r6
->
içû
;

1868 ià(!
	`IN6_IS_ADDR_UNSPECIFIED
(&
r6
->
g©eway
) )

1870 
g©eway_Ãeded
 = 
Œue
;

1875 
	`gc_š™
(&
gc
);

1877 
	`rou‹_v6_ş—r_ho¡_b™s
(
r6
);

1879 
ÃtwÜk
 = 
	`´št_š6_addr
Ğ
r6
->ÃtwÜk, 0, &
gc
);

1880 
g©eway
 = 
	`´št_š6_addr
Ğ
r6
->g©eway, 0, &
gc
);

1882 #ià
	`defšed
(
TARGET_DARWIN
) \

1883 || 
	`defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
) \

1884 || 
	`defšed
(
TARGET_OPENBSD
è|| defšed(
TARGET_NETBSD
)

1890 ià(
r6
->
içû
 !ğ
NULL
 && 
g©eway_Ãeded


1891 && 
	`IN6_IS_ADDR_LINKLOCAL
(&
r6
->
g©eway
) )

1893 
Ën
 = 
	`¡¾’
(
g©eway
è+ 1 + sŒËn(
r6
->
içû
)+1;

1894 *
tmp
 = 
	`gc_m®loc
Ğ
Ën
, 
Œue
, &
gc
 );

1895 
	`¢´štf
Ğ
tmp
, 
Ën
, "%s%%%s", 
g©eway
, 
r6
->
içû
 );

1896 
g©eway
 = 
tmp
;

1900 
	`msg
Ğ
M_INFO
, "add_route_ipv6(%s/%d -> %s metric %d) dev %s",

1901 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
,„6->
m‘ric
, 
deviû
 );

1914 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP


1915 && !Ğ(
r6
->
æags
 & 
RT_METRIC_DEFINED
è&&„6->
m‘ric
 == 0 ) )

1917 
g©eway_Ãeded
 = 
Œue
;

1920 #ià
	`defšed
(
TARGET_LINUX
)

1921 #ifdeà
ENABLE_IPROUTE


1922 
	`¬gv_´štf
(&
¬gv
, "%s -6„oute‡dd %s/%d dev %s",

1923 
rou‹_·th
,

1924 
ÃtwÜk
,

1925 
r6
->
Ãtb™s
,

1926 
deviû
);

1927 ià(
g©eway_Ãeded
)

1929 
	`¬gv_´štf_ÿt
(&
¬gv
, "vŸ %s", 
g©eway
);

1931 iàĞ(
r6
->
æags
 & 
RT_METRIC_DEFINED
è&&„6->
m‘ric
 > 0)

1933 
	`¬gv_´štf_ÿt
(&
¬gv
, " m‘riø%d", 
r6
->
m‘ric
);

1937 
	`¬gv_´štf
(&
¬gv
, "%s -A inet6‡dd %s/%d dev %s",

1938 
ROUTE_PATH
,

1939 
ÃtwÜk
,

1940 
r6
->
Ãtb™s
,

1941 
deviû
);

1942 ià(
g©eway_Ãeded
)

1944 
	`¬gv_´štf_ÿt
(&
¬gv
, "gw %s", 
g©eway
);

1946 iàĞ(
r6
->
æags
 & 
RT_METRIC_DEFINED
è&&„6->
m‘ric
 > 0)

1948 
	`¬gv_´štf_ÿt
(&
¬gv
, " m‘riø%d", 
r6
->
m‘ric
);

1951 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

1952 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Linux„oute -6/-A inet6‡dd command failed");

1954 #–ià
	`defšed
 (
TARGET_ANDROID
)

1955 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, &
gc
);

1957 
	`buf_´štf
(&
out
, "%s/%d %s", 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
deviû
);

1959 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "ROUTE6", 
	`buf_b±r
(&
out
));

1961 #–ià
	`defšed
 (
_WIN32
)

1963 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

1965 
¡©us
 = 
	`add_rou‹_v6_£rviû
(
r6
, 
‰
);

1969 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, &
gc
);

1970 ià(
r6
->
ad­‹r_šdex
)

1972 
	`buf_´štf
(&
out
, "š‹rçû=%lu", 
r6
->
ad­‹r_šdex
 );

1973 
g©eway_Ãeded
 = 
Œue
;

1977 
	`buf_´štf
(&
out
, "š‹rçû=%lu", 
‰
->
ad­‹r_šdex
 );

1979 
deviû
 = 
	`buf_b±r
(&
out
);

1982 
	`¬gv_´štf
(&
¬gv
, "%s%sc interface ipv6‡dd„oute %s/%d %s",

1983 
	`g‘_wš_sys_·th
(),

1984 
NETSH_PATH_SUFFIX
,

1985 
ÃtwÜk
,

1986 
r6
->
Ãtb™s
,

1987 
deviû
);

1994 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 && !
g©eway_Ãeded
)

1996 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " %s", "fe80::8" );

1998 ià(!
	`IN6_IS_ADDR_UNSPECIFIED
(&
r6
->
g©eway
) )

2000 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " %s", 
g©eway
 );

2004 ià(
r6
->
æags
 & 
RT_METRIC_DEFINED
)

2006 
	`¬gv_´štf_ÿt
(&
¬gv
, " METRIC %d", 
r
->
m‘ric
);

2013 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " store=active" );

2015 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2017 
	`Ãtcmd_£m­hÜe_lock
();

2018 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute‡dd ipv6 command failed");

2019 
	`Ãtcmd_£m­hÜe_»Ëa£
();

2022 #–ià
	`defšed
 (
TARGET_SOLARIS
)

2035 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s/%d %s",

2036 
ROUTE_PATH
,

2037 
ÃtwÜk
,

2038 
r6
->
Ãtb™s
,

2039 
g©eway
 );

2042 ià(!
r6
->
içû
)

2044 
	`¬gv_´štf_ÿt
(&
¬gv
, "0");

2047 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2048 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Solaris„oute‡dd -inet6 command failed");

2050 #–ià
	`defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
)

2052 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s/%d",

2053 
ROUTE_PATH
,

2054 
ÃtwÜk
,

2055 
r6
->
Ãtb™s
);

2057 ià(
g©eway_Ãeded
)

2059 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
g©eway
);

2063 
	`¬gv_´štf_ÿt
(&
¬gv
, "-içû %s", 
deviû
);

2066 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2067 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: *BSD„oute‡dd -inet6 command failed");

2069 #–ià
	`defšed
(
TARGET_DARWIN
)

2071 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s -prefixlen %d",

2072 
ROUTE_PATH
,

2073 
ÃtwÜk
, 
r6
->
Ãtb™s
 );

2075 ià(
g©eway_Ãeded
)

2077 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
g©eway
);

2081 
	`¬gv_´štf_ÿt
(&
¬gv
, "-içû %s", 
deviû
);

2084 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2085 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: MacOS X„oute‡dd -inet6 command failed");

2087 #–ià
	`defšed
(
TARGET_OPENBSD
)

2089 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s -prefixlen %d %s",

2090 
ROUTE_PATH
,

2091 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
 );

2093 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2094 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OpenBSD„oute‡dd -inet6 command failed");

2096 #–ià
	`defšed
(
TARGET_NETBSD
)

2098 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s/%d %s",

2099 
ROUTE_PATH
,

2100 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
 );

2102 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2103 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: NetBSD„oute‡dd -inet6 command failed");

2105 #–ià
	`defšed
(
TARGET_AIX
)

2107 
	`¬gv_´štf
(&
¬gv
, "%s‡dd -inet6 %s/%d %s",

2108 
ROUTE_PATH
,

2109 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
);

2110 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2111 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: AIX„oute‡dd command failed");

2114 
	`msg
(
M_FATAL
, "Sorry, but I don't know howo do 'route ipv6' commands onhis operating system. Try…utting your„outes in‡ --route-up script");

2117 ià(
¡©us
)

2119 
r6
->
æags
 |ğ
RT_ADDED
;

2123 
r6
->
æags
 &ğ~
RT_ADDED
;

2125 
	`¬gv_»£t
(&
¬gv
);

2126 
	`gc_ä“
(&
gc
);

2127 
	}
}

2130 
	$d–‘e_rou‹
(
rou‹_v4
 *
r
,

2131 cÚ¡ 
tuÁ­
 *
‰
,

2132 
æags
,

2133 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

2134 cÚ¡ 
’v_£t
 *
es
)

2136 
gc_¬’a
 
gc
;

2137 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2138 cÚ¡ *
ÃtwÜk
;

2139 #ià!
	`defšed
(
ENABLE_IPROUTE
è&& !defšed(
TARGET_AIX
)

2140 cÚ¡ *
Ãtmask
;

2142 #ià!
	`defšed
(
TARGET_LINUX
è&& !defšed(
TARGET_ANDROID
)

2143 cÚ¡ *
g©eway
;

2145 
is_loÿl_rou‹
;

2147 ià((
r
->
æags
 & (
RT_DEFINED
|
RT_ADDED
)) != (RT_DEFINED|RT_ADDED))

2152 
	`gc_š™
(&
gc
);

2154 
ÃtwÜk
 = 
	`´št_š_addr_t
(
r
->ÃtwÜk, 0, &
gc
);

2155 #ià!
	`defšed
(
ENABLE_IPROUTE
è&& !defšed(
TARGET_AIX
)

2156 
Ãtmask
 = 
	`´št_š_addr_t
(
r
->Ãtmask, 0, &
gc
);

2158 #ià!
	`defšed
(
TARGET_LINUX
è&& !defšed(
TARGET_ANDROID
)

2159 
g©eway
 = 
	`´št_š_addr_t
(
r
->g©eway, 0, &
gc
);

2162 
is_loÿl_rou‹
 = 
	`loÿl_rou‹
(
r
->
ÃtwÜk
,„->
Ãtmask
,„->
g©eway
, 
rgi
);

2163 ià(
is_loÿl_rou‹
 =ğ
LR_ERROR
)

2165 
dÚe
;

2168 #ià
	`defšed
(
TARGET_LINUX
)

2169 #ifdeà
ENABLE_IPROUTE


2170 
	`¬gv_´štf
(&
¬gv
, "%s„oute del %s/%d",

2171 
rou‹_·th
,

2172 
ÃtwÜk
,

2173 
	`Ãtmask_to_Ãtb™s2
(
r
->
Ãtmask
));

2175 
	`¬gv_´štf
(&
¬gv
, "%s del -net %s‚etmask %s",

2176 
ROUTE_PATH
,

2177 
ÃtwÜk
,

2178 
Ãtmask
);

2180 ià(
r
->
æags
 & 
RT_METRIC_DEFINED
)

2182 
	`¬gv_´štf_ÿt
(&
¬gv
, "m‘riø%d", 
r
->
m‘ric
);

2184 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2185 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Linux„oute delete command failed");

2187 #–ià
	`defšed
 (
_WIN32
)

2189 
	`¬gv_´štf
(&
¬gv
, "%s%sc DELETE %s MASK %s %s",

2190 
	`g‘_wš_sys_·th
(),

2191 
WIN_ROUTE_PATH_SUFFIX
,

2192 
ÃtwÜk
,

2193 
Ãtmask
,

2194 
g©eway
);

2196 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2198 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_SERVICE
)

2200 cÚ¡ 
boŞ
 
¡©us
 = 
	`d–_rou‹_£rviû
(
r
, 
‰
);

2201 
	`msg
(
D_ROUTE
, "Rou‹ d–‘iÚ vŸ s”viû %s", 
¡©us
 ? "succeeded" : "failed");

2203 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_IPAPI
)

2205 cÚ¡ 
boŞ
 
¡©us
 = 
	`d–_rou‹_­i
(
r
, 
‰
);

2206 
	`msg
(
D_ROUTE
, "Rou‹ d–‘iÚ vŸ IPAPI %s", 
¡©us
 ? "succeeded" : "failed");

2208 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_EXE
)

2210 
	`Ãtcmd_£m­hÜe_lock
();

2211 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute delete command failed");

2212 
	`Ãtcmd_£m­hÜe_»Ëa£
();

2214 ià((
æags
 & 
ROUTE_METHOD_MASK
è=ğ
ROUTE_METHOD_ADAPTIVE
)

2216 cÚ¡ 
boŞ
 
¡©us
 = 
	`d–_rou‹_­i
(
r
, 
‰
);

2217 
	`msg
(
D_ROUTE
, "Rou‹ d–‘iÚ vŸ IPAPI % [ad­tive]", 
¡©us
 ? "succeeded" : "failed");

2218 ià(!
¡©us
)

2220 
	`msg
(
D_ROUTE
, "Route deletion fallbacko„oute.exe");

2221 
	`Ãtcmd_£m­hÜe_lock
();

2222 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute delete command failed [adaptive]");

2223 
	`Ãtcmd_£m­hÜe_»Ëa£
();

2228 
	`ASSERT
(0);

2231 #–ià
	`defšed
 (
TARGET_SOLARIS
)

2233 
	`¬gv_´štf
(&
¬gv
, "%s delete %s -netmask %s %s",

2234 
ROUTE_PATH
,

2235 
ÃtwÜk
,

2236 
Ãtmask
,

2237 
g©eway
);

2239 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2240 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Solaris„oute delete command failed");

2242 #–ià
	`defšed
(
TARGET_FREEBSD
)

2244 
	`¬gv_´štf
(&
¬gv
, "%s delete -net %s %s %s",

2245 
ROUTE_PATH
,

2246 
ÃtwÜk
,

2247 
g©eway
,

2248 
Ãtmask
);

2250 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2251 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: FreeBSD„oute delete command failed");

2253 #–ià
	`defšed
(
TARGET_DRAGONFLY
)

2255 
	`¬gv_´štf
(&
¬gv
, "%s delete -net %s %s %s",

2256 
ROUTE_PATH
,

2257 
ÃtwÜk
,

2258 
g©eway
,

2259 
Ãtmask
);

2261 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2262 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: DragonFly„oute delete command failed");

2264 #–ià
	`defšed
(
TARGET_DARWIN
)

2266 ià(
	`is_Ú_lšk
(
is_loÿl_rou‹
, 
æags
, 
rgi
))

2268 
	`¬gv_´štf
(&
¬gv
, "%s delete -cloning -net %s -netmask %s -interface %s",

2269 
ROUTE_PATH
,

2270 
ÃtwÜk
,

2271 
Ãtmask
,

2272 
rgi
->
içû
);

2276 
	`¬gv_´štf
(&
¬gv
, "%s delete -net %s %s %s",

2277 
ROUTE_PATH
,

2278 
ÃtwÜk
,

2279 
g©eway
,

2280 
Ãtmask
);

2283 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2284 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OS X„oute delete command failed");

2286 #–ià
	`defšed
(
TARGET_OPENBSD
è|| defšed(
TARGET_NETBSD
)

2288 
	`¬gv_´štf
(&
¬gv
, "%s delete -net %s %s -netmask %s",

2289 
ROUTE_PATH
,

2290 
ÃtwÜk
,

2291 
g©eway
,

2292 
Ãtmask
);

2294 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2295 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OpenBSD/NetBSD„oute delete command failed");

2297 #–ià
	`defšed
(
TARGET_ANDROID
)

2298 
	`msg
(
M_NONFATAL
, "Sorry, deleting„outes on Android is‚ot…ossible. The VpnService API‡llows„outeso be set on connect only.");

2300 #–ià
	`defšed
(
TARGET_AIX
)

2303 
Ãtb™s
 = 
	`Ãtmask_to_Ãtb™s2
(
r
->
Ãtmask
);

2304 
	`¬gv_´štf
(&
¬gv
, "%s delete -net %s/%d %s",

2305 
ROUTE_PATH
,

2306 
ÃtwÜk
, 
Ãtb™s
, 
g©eway
);

2307 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2308 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: AIX„oute delete command failed");

2312 
	`msg
(
M_FATAL
, "Sorry, but I don't know howo do 'route' commands onhis operating system. Try…utting your„outes in‡ --route-up script");

2315 
dÚe
:

2316 
r
->
æags
 &ğ~
RT_ADDED
;

2317 
	`¬gv_»£t
(&
¬gv
);

2318 
	`gc_ä“
(&
gc
);

2319 
	}
}

2322 
	$d–‘e_rou‹_v6
(cÚ¡ 
rou‹_v6
 *
r6
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
)

2324 
gc_¬’a
 
gc
;

2325 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2326 cÚ¡ *
ÃtwÜk
;

2327 cÚ¡ *
g©eway
;

2328 cÚ¡ *
deviû
 = 
‰
->
aùu®_Çme
;

2329 
boŞ
 
g©eway_Ãeded
 = 
çl£
;

2331 ià((
r6
->
æags
 & (
RT_DEFINED
|
RT_ADDED
)) != (RT_DEFINED|RT_ADDED))

2336 #iâdeà
_WIN32


2337 ià(
r6
->
içû
 !ğ
NULL
)

2339 
deviû
 = 
r6
->
içû
;

2340 
g©eway_Ãeded
 = 
Œue
;

2344 
	`gc_š™
(&
gc
);

2346 
ÃtwÜk
 = 
	`´št_š6_addr
Ğ
r6
->ÃtwÜk, 0, &
gc
);

2347 
g©eway
 = 
	`´št_š6_addr
Ğ
r6
->g©eway, 0, &
gc
);

2349 #ià
	`defšed
(
TARGET_DARWIN
) \

2350 || 
	`defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
) \

2351 || 
	`defšed
(
TARGET_OPENBSD
è|| defšed(
TARGET_NETBSD
)

2357 ià(
r6
->
içû
 !ğ
NULL
 && 
g©eway_Ãeded


2358 && 
	`IN6_IS_ADDR_LINKLOCAL
(&
r6
->
g©eway
) )

2360 
Ën
 = 
	`¡¾’
(
g©eway
è+ 1 + sŒËn(
r6
->
içû
)+1;

2361 *
tmp
 = 
	`gc_m®loc
Ğ
Ën
, 
Œue
, &
gc
 );

2362 
	`¢´štf
Ğ
tmp
, 
Ën
, "%s%%%s", 
g©eway
, 
r6
->
içû
 );

2363 
g©eway
 = 
tmp
;

2367 
	`msg
Ğ
M_INFO
, "d–‘e_rou‹_v6(%s/%d)", 
ÃtwÜk
, 
r6
->
Ãtb™s
 );

2372 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP


2373 && !Ğ(
r6
->
æags
 & 
RT_METRIC_DEFINED
è&&„6->
m‘ric
 == 0 ) )

2375 
g©eway_Ãeded
 = 
Œue
;

2379 #ià
	`defšed
(
TARGET_LINUX
)

2380 #ifdeà
ENABLE_IPROUTE


2381 
	`¬gv_´štf
(&
¬gv
, "%s -6„oute del %s/%d dev %s",

2382 
rou‹_·th
,

2383 
ÃtwÜk
,

2384 
r6
->
Ãtb™s
,

2385 
deviû
);

2386 ià(
g©eway_Ãeded
)

2388 
	`¬gv_´štf_ÿt
(&
¬gv
, "vŸ %s", 
g©eway
);

2391 
	`¬gv_´štf
(&
¬gv
, "%s -A inet6 del %s/%d dev %s",

2392 
ROUTE_PATH
,

2393 
ÃtwÜk
,

2394 
r6
->
Ãtb™s
,

2395 
deviû
);

2396 ià(
g©eway_Ãeded
)

2398 
	`¬gv_´štf_ÿt
(&
¬gv
, "gw %s", 
g©eway
);

2400 iàĞ(
r6
->
æags
 & 
RT_METRIC_DEFINED
è&&„6->
m‘ric
 > 0)

2402 
	`¬gv_´štf_ÿt
(&
¬gv
, " m‘riø%d", 
r6
->
m‘ric
);

2405 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2406 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Linux„oute -6/-A inet6 del command failed");

2408 #–ià
	`defšed
 (
_WIN32
)

2410 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

2412 
	`d–_rou‹_v6_£rviû
(
r6
, 
‰
);

2416 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, &
gc
);

2417 ià(
r6
->
ad­‹r_šdex
)

2419 
	`buf_´štf
(&
out
, "š‹rçû=%lu", 
r6
->
ad­‹r_šdex
 );

2420 
g©eway_Ãeded
 = 
Œue
;

2424 
	`buf_´štf
(&
out
, "š‹rçû=%lu", 
‰
->
ad­‹r_šdex
 );

2426 
deviû
 = 
	`buf_b±r
(&
out
);

2429 
	`¬gv_´štf
(&
¬gv
, "%s%sc interface ipv6 delete„oute %s/%d %s",

2430 
	`g‘_wš_sys_·th
(),

2431 
NETSH_PATH_SUFFIX
,

2432 
ÃtwÜk
,

2433 
r6
->
Ãtb™s
,

2434 
deviû
);

2442 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 && !
g©eway_Ãeded
)

2444 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " %s", "fe80::8" );

2446 ià(!
	`IN6_IS_ADDR_UNSPECIFIED
(&
r6
->
g©eway
) )

2448 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " %s", 
g©eway
 );

2452 ià(
r6
->
æags
 & 
RT_METRIC_DEFINED
)

2454 
	`¬gv_´štf_ÿt
(&
¬gv
, "METRIC %d", 
r
->
m‘ric
);

2462 
	`¬gv_´štf_ÿt
Ğ&
¬gv
, " store=active" );

2464 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2466 
	`Ãtcmd_£m­hÜe_lock
();

2467 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Windows„oute delete ipv6 command failed");

2468 
	`Ãtcmd_£m­hÜe_»Ëa£
();

2471 #–ià
	`defšed
 (
TARGET_SOLARIS
)

2475 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s/%d %s",

2476 
ROUTE_PATH
,

2477 
ÃtwÜk
,

2478 
r6
->
Ãtb™s
,

2479 
g©eway
 );

2481 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2482 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: Solaris„oute delete -inet6 command failed");

2484 #–ià
	`defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
)

2486 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s/%d",

2487 
ROUTE_PATH
,

2488 
ÃtwÜk
,

2489 
r6
->
Ãtb™s
 );

2491 ià(
g©eway_Ãeded
)

2493 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
g©eway
);

2497 
	`¬gv_´štf_ÿt
(&
¬gv
, "-içû %s", 
deviû
);

2500 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2501 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: *BSD„oute delete -inet6 command failed");

2503 #–ià
	`defšed
(
TARGET_DARWIN
)

2505 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s -prefixlen %d",

2506 
ROUTE_PATH
,

2507 
ÃtwÜk
, 
r6
->
Ãtb™s
 );

2509 ià(
g©eway_Ãeded
)

2511 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
g©eway
);

2515 
	`¬gv_´štf_ÿt
(&
¬gv
, "-içû %s", 
deviû
);

2518 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2519 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: MacOS X„oute delete -inet6 command failed");

2521 #–ià
	`defšed
(
TARGET_OPENBSD
)

2523 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s -prefixlen %d %s",

2524 
ROUTE_PATH
,

2525 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
 );

2527 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2528 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: OpenBSD„oute delete -inet6 command failed");

2530 #–ià
	`defšed
(
TARGET_NETBSD
)

2532 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s/%d %s",

2533 
ROUTE_PATH
,

2534 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
 );

2536 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2537 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: NetBSD„oute delete -inet6 command failed");

2539 #–ià
	`defšed
(
TARGET_AIX
)

2541 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s/%d %s",

2542 
ROUTE_PATH
,

2543 
ÃtwÜk
, 
r6
->
Ãtb™s
, 
g©eway
);

2544 
	`¬gv_msg
(
D_ROUTE
, &
¬gv
);

2545 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "ERROR: AIX„oute‡dd command failed");

2548 
	`msg
(
M_FATAL
, "Sorry, but I don't know howo do 'route ipv6' commands onhis operating system. Try…utting your„outes in‡ --route-down script");

2551 
	`¬gv_»£t
(&
¬gv
);

2552 
	`gc_ä“
(&
gc
);

2553 
	}
}

2560 #ià
defšed
(
_WIN32
)

2562 cÚ¡ 
MIB_IPFORWARDTABLE
 *

2563 
	$g‘_wšdows_routšg_bË
(
gc_¬’a
 *
gc
)

2565 
ULONG
 
size
 = 0;

2566 
PMIB_IPFORWARDTABLE
 
¹
 = 
NULL
;

2567 
DWORD
 
¡©us
;

2569 
¡©us
 = 
	`G‘IpFÜw¬dTabË
(
NULL
, &
size
, 
TRUE
);

2570 ià(
¡©us
 =ğ
ERROR_INSUFFICIENT_BUFFER
)

2572 
¹
 = (
PMIB_IPFORWARDTABLE
è
	`gc_m®loc
(
size
, 
çl£
, 
gc
);

2573 
¡©us
 = 
	`G‘IpFÜw¬dTabË
(
¹
, &
size
, 
TRUE
);

2574 ià(
¡©us
 !ğ
NO_ERROR
)

2576 
	`msg
(
D_ROUTE
, "NOTE: GetIpForwardTable„eturnedƒrror: %s (code=%u)",

2577 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
),

2578 ()
¡©us
);

2579 
¹
 = 
NULL
;

2582  
¹
;

2583 
	}
}

2586 
	$‹¡_rou‹
(cÚ¡ 
IP_ADAPTER_INFO
 *
ad­‹rs
,

2587 cÚ¡ 
š_addr_t
 
g©eway
,

2588 
DWORD
 *
šdex
)

2590 
couÁ
 = 0;

2591 
DWORD
 
i
 = 
	`ad­‹r_šdex_of_
(
ad­‹rs
, 
g©eway
, &
couÁ
, 
NULL
);

2592 ià(
šdex
)

2594 *
šdex
 = 
i
;

2596  
couÁ
;

2597 
	}
}

2600 
	$‹¡_rou‹_h–³r
(
boŞ
 *
»t
,

2601 *
couÁ
,

2602 *
good
,

2603 *
ambig
,

2604 cÚ¡ 
IP_ADAPTER_INFO
 *
ad­‹rs
,

2605 cÚ¡ 
š_addr_t
 
g©eway
)

2607 
c
;

2609 ++*
couÁ
;

2610 
c
 = 
	`‹¡_rou‹
(
ad­‹rs
, 
g©eway
, 
NULL
);

2611 ià(
c
 == 0)

2613 *
»t
 = 
çl£
;

2617 ++*
good
;

2619 ià(
c
 > 1)

2621 ++*
ambig
;

2623 
	}
}

2628 
boŞ


2629 
	$‹¡_rou‹s
(cÚ¡ 
rou‹_li¡
 *
¾
, cÚ¡ 
tuÁ­
 *
‰
)

2631 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2632 cÚ¡ 
IP_ADAPTER_INFO
 *
ad­‹rs
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

2633 
boŞ
 
»t
 = 
çl£
;

2634 
couÁ
 = 0;

2635 
good
 = 0;

2636 
ambig
 = 0;

2637 
Ën
 = -1;

2638 
boŞ
 
ad­‹r_up
 = 
çl£
;

2640 ià(
	`is_ad­‹r_up
(
‰
, 
ad­‹rs
))

2642 
»t
 = 
Œue
;

2643 
ad­‹r_up
 = 
Œue
;

2645 ià(
¾
)

2647 
rou‹_v4
 *
r
;

2648 
r
 = 
¾
->
rou‹s
, 
Ën
 = 0;„;„ =„->
Ãxt
, ++len)

2650 
	`‹¡_rou‹_h–³r
(&
»t
, &
couÁ
, &
good
, &
ambig
, 
ad­‹rs
, 
r
->
g©eway
);

2653 ià((
¾
->
æags
 & 
RG_ENABLE
è&& (¾->
¥ec
.æag & 
RTSA_REMOTE_ENDPOINT
))

2655 
	`‹¡_rou‹_h–³r
(&
»t
, &
couÁ
, &
good
, &
ambig
, 
ad­‹rs
, 
¾
->
¥ec
.
»mÙe_’dpošt
);

2660 
	`msg
(
D_ROUTE
, "TEST ROUTES: %d/%d succeeded†en=%d„et=%d‡=%d u/d=%s",

2661 
good
,

2662 
couÁ
,

2663 
Ën
,

2664 ()
»t
,

2665 
ambig
,

2666 
ad­‹r_up
 ? "up" : "down");

2668 
	`gc_ä“
(&
gc
);

2669  
»t
;

2670 
	}
}

2672 cÚ¡ 
MIB_IPFORWARDROW
 *

2673 
	$g‘_deçuÉ_g©eway_row
(cÚ¡ 
MIB_IPFORWARDTABLE
 *
rou‹s
)

2675 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2676 
DWORD
 
lowe¡_m‘ric
 = 
MAXDWORD
;

2677 cÚ¡ 
MIB_IPFORWARDROW
 *
»t
 = 
NULL
;

2678 
i
;

2679 
be¡
 = -1;

2681 ià(
rou‹s
)

2683 
i
 = 0; i < 
rou‹s
->
dwNumEÁr›s
; ++i)

2685 cÚ¡ 
MIB_IPFORWARDROW
 *
row
 = &
rou‹s
->
bË
[
i
];

2686 cÚ¡ 
š_addr_t
 
Ãt
 = 
	`Áohl
(
row
->
dwFÜw¬dDe¡
);

2687 cÚ¡ 
š_addr_t
 
mask
 = 
	`Áohl
(
row
->
dwFÜw¬dMask
);

2688 cÚ¡ 
DWORD
 
šdex
 = 
row
->
dwFÜw¬dIfIndex
;

2689 cÚ¡ 
DWORD
 
m‘ric
 = 
row
->
dwFÜw¬dM‘ric1
;

2691 
	`dmsg
(
D_ROUTE_DEBUG
, "GDGR:„oute[%d] %s/%s i=%d m=%d",

2692 
i
,

2693 
	`´št_š_addr_t
((
š_addr_t
è
Ãt
, 0, &
gc
),

2694 
	`´št_š_addr_t
((
š_addr_t
è
mask
, 0, &
gc
),

2695 ()
šdex
,

2696 ()
m‘ric
);

2698 ià(!
Ãt
 && !
mask
 && 
m‘ric
 < 
lowe¡_m‘ric
)

2700 
»t
 = 
row
;

2701 
lowe¡_m‘ric
 = 
m‘ric
;

2702 
be¡
 = 
i
;

2707 
	`dmsg
(
D_ROUTE_DEBUG
, "GDGR: be¡=%d†m=%u", 
be¡
, ()
lowe¡_m‘ric
);

2709 
	`gc_ä“
(&
gc
);

2710  
»t
;

2711 
	}
}

2714 
	$g‘_deçuÉ_g©eway
(
rou‹_g©eway_šfo
 *
rgi
)

2716 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2718 cÚ¡ 
IP_ADAPTER_INFO
 *
ad­‹rs
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

2719 cÚ¡ 
MIB_IPFORWARDTABLE
 *
rou‹s
 = 
	`g‘_wšdows_routšg_bË
(&
gc
);

2720 cÚ¡ 
MIB_IPFORWARDROW
 *
row
 = 
	`g‘_deçuÉ_g©eway_row
(
rou‹s
);

2721 
DWORD
 
a_šdex
;

2722 cÚ¡ 
IP_ADAPTER_INFO
 *
ai
;

2724 
	`CLEAR
(*
rgi
);

2726 ià(
row
)

2728 
rgi
->
g©eway
.
addr
 = 
	`Áohl
(
row
->
dwFÜw¬dNextHİ
);

2729 ià(
rgi
->
g©eway
.
addr
)

2731 
rgi
->
æags
 |ğ
RGI_ADDR_DEFINED
;

2732 
a_šdex
 = 
	`ad­‹r_šdex_of_
(
ad­‹rs
, 
rgi
->
g©eway
.
addr
, 
NULL
, &rgi->g©eway.
Ãtmask
);

2733 ià(
a_šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

2735 
rgi
->
ad­‹r_šdex
 = 
a_šdex
;

2736 
rgi
->
æags
 |ğ(
RGI_IFACE_DEFINED
|
RGI_NETMASK_DEFINED
);

2737 
ai
 = 
	`g‘_ad­‹r
(
ad­‹rs
, 
a_šdex
);

2738 ià(
ai
)

2740 
	`memıy
(
rgi
->
hwaddr
, 
ai
->
Add»ss
, 6);

2741 
rgi
->
æags
 |ğ
RGI_HWADDR_DEFINED
;

2747 
	`gc_ä“
(&
gc
);

2748 
	}
}

2750 
DWORD


2751 
	$wšdows_rou‹_fšd_if_šdex
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

2753 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2754 
DWORD
 
»t
 = 
TUN_ADAPTER_INDEX_INVALID
;

2755 
couÁ
 = 0;

2756 cÚ¡ 
IP_ADAPTER_INFO
 *
ad­‹rs
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

2757 cÚ¡ 
IP_ADAPTER_INFO
 *
tun_ad­‹r
 = 
	`g‘_tun_ad­‹r
(
‰
, 
ad­‹rs
);

2758 
boŞ
 
Ú_tun
 = 
çl£
;

2761 ià(
	`is__š_ad­‹r_subÃt
(
tun_ad­‹r
, 
r
->
g©eway
, 
NULL
))

2763 
»t
 = 
tun_ad­‹r
->
Index
;

2764 
couÁ
 = 1;

2765 
Ú_tun
 = 
Œue
;

2769 
couÁ
 = 
	`‹¡_rou‹
(
ad­‹rs
, 
r
->
g©eway
, &
»t
);

2772 ià(
couÁ
 == 0)

2774 
	`msg
(
M_WARN
, "Warning:„oute gateway is‚ot„eachable on‡ny‡ctive‚etwork‡dapters: %s",

2775 
	`´št_š_addr_t
(
r
->
g©eway
, 0, &
gc
));

2776 
»t
 = 
TUN_ADAPTER_INDEX_INVALID
;

2778 ià(
couÁ
 > 1)

2780 
	`msg
(
M_WARN
, "Warning:„oute gateway is‡mbiguous: %s (%d matches)",

2781 
	`´št_š_addr_t
(
r
->
g©eway
, 0, &
gc
),

2782 
couÁ
);

2785 
	`dmsg
(
D_ROUTE_DEBUG
, "DEBUG:„oute find if: on_tun=%d count=%d index=%d",

2786 
Ú_tun
,

2787 
couÁ
,

2788 ()
»t
);

2790 
	`gc_ä“
(&
gc
);

2791  
»t
;

2792 
	}
}

2800 
	$g‘_deçuÉ_g©eway_v6
(
rou‹_v6_g©eway_šfo
 *
rgi6
,

2801 cÚ¡ 
š6_addr
 *
de¡
)

2803 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2804 
MIB_IPFORWARD_ROW2
 
Be¡Rou‹
;

2805 
SOCKADDR_INET
 
De¡š©iÚAdd»ss
, 
Be¡SourûAdd»ss
;

2806 
DWORD
 
Be¡IfIndex
;

2807 
DWORD
 
¡©us
;

2808 
NET_LUID
 
IÁ”çûLuid
;

2810 
	`CLEAR
(*
rgi6
);

2811 
	`CLEAR
(
IÁ”çûLuid
);

2812 
	`CLEAR
(
De¡š©iÚAdd»ss
);

2814 
De¡š©iÚAdd»ss
.
si_çmy
 = 
AF_INET6
;

2815 ià(
de¡
)

2817 
De¡š©iÚAdd»ss
.
Ipv6
.
sš6_addr
 = *
de¡
;

2820 
¡©us
 = 
	`G‘Be¡IÁ”çûEx
Ğ&
De¡š©iÚAdd»ss
, &
Be¡IfIndex
 );

2822 ià(
¡©us
 !ğ
NO_ERROR
)

2824 
	`msg
(
D_ROUTE
, "NOTE: GetBestInterfaceEx„eturnedƒrror: %s (code=%u)",

2825 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

2826 ()
¡©us
);

2827 
dÚe
;

2830 
	`msg
Ğ
D_ROUTE
, "G‘Be¡IÁ”çûEx(è»tuºed if=%d", (è
Be¡IfIndex
 );

2832 
¡©us
 = 
	`G‘Be¡Rou‹2
Ğ&
IÁ”çûLuid
, 
Be¡IfIndex
, 
NULL
,

2833 &
De¡š©iÚAdd»ss
, 0,

2834 &
Be¡Rou‹
, &
Be¡SourûAdd»ss
 );

2836 ià(
¡©us
 !ğ
NO_ERROR
)

2838 
	`msg
(
D_ROUTE
, "NOTE: GetIpForwardEntry2„eturnedƒrror: %s (code=%u)",

2839 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

2840 ()
¡©us
);

2841 
dÚe
;

2844 
	`msg
Ğ
D_ROUTE
, "GDG6: II=%lu DP=%s/%d NH=%s",

2845 
Be¡Rou‹
.
IÁ”çûIndex
,

2846 
	`´št_š6_addr
Ğ
Be¡Rou‹
.
De¡š©iÚP»fix
.
P»fix
.
Ipv6
.
sš6_addr
, 0, &
gc
),

2847 
Be¡Rou‹
.
De¡š©iÚP»fix
.
P»fixL’gth
,

2848 
	`´št_š6_addr
Ğ
Be¡Rou‹
.
NextHİ
.
Ipv6
.
sš6_addr
, 0, &
gc
) );

2849 
	`msg
Ğ
D_ROUTE
, "GDG6: Metric=%d, Loopback=%d, AA=%d, I=%d",

2850 (è
Be¡Rou‹
.
M‘ric
,

2851 (è
Be¡Rou‹
.
Loİback
,

2852 (è
Be¡Rou‹
.
AutocÚfigu»Add»ss
,

2853 (è
Be¡Rou‹
.
ImmÜl
 );

2855 
rgi6
->
g©eway
.
addr_v6
 = 
Be¡Rou‹
.
NextHİ
.
Ipv6
.
sš6_addr
;

2856 
rgi6
->
ad­‹r_šdex
 = 
Be¡Rou‹
.
IÁ”çûIndex
;

2857 
rgi6
->
æags
 |ğ
RGI_ADDR_DEFINED
 | 
RGI_IFACE_DEFINED
;

2860 ià(
	`IN6_IS_ADDR_UNSPECIFIED
(&
Be¡Rou‹
.
NextHİ
.
Ipv6
.
sš6_addr
) )

2862 
rgi6
->
æags
 |ğ
RGI_ON_LINK
;

2865 
dÚe
:

2866 
	`gc_ä“
(&
gc
);

2867 
	}
}

2869 
boŞ


2870 
	$add_rou‹_­i
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
, 
DWORD
 
ad­‹r_šdex
)

2872 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2873 
boŞ
 
»t
 = 
çl£
;

2874 
DWORD
 
¡©us
;

2875 cÚ¡ 
DWORD
 
if_šdex
 = (
ad­‹r_šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
è? 
	`wšdows_rou‹_fšd_if_šdex
(
r
, 
‰
) :‡dapter_index;

2877 ià(
if_šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

2879 
MIB_IPFORWARDROW
 
ä
;

2880 
	`CLEAR
(
ä
);

2881 
ä
.
dwFÜw¬dDe¡
 = 
	`htÚl
(
r
->
ÃtwÜk
);

2882 
ä
.
dwFÜw¬dMask
 = 
	`htÚl
(
r
->
Ãtmask
);

2883 
ä
.
dwFÜw¬dPŞicy
 = 0;

2884 
ä
.
dwFÜw¬dNextHİ
 = 
	`htÚl
(
r
->
g©eway
);

2885 
ä
.
dwFÜw¬dIfIndex
 = 
if_šdex
;

2886 
ä
.
dwFÜw¬dTy³
 = 4;

2887 
ä
.
dwFÜw¬dPrÙo
 = 3;

2888 
ä
.
dwFÜw¬dAge
 = 0;

2889 
ä
.
dwFÜw¬dNextHİAS
 = 0;

2890 
ä
.
dwFÜw¬dM‘ric1
 = (
r
->
æags
 & 
RT_METRIC_DEFINED
è?„->
m‘ric
 : 1;

2891 
ä
.
dwFÜw¬dM‘ric2
 = 
METRIC_NOT_USED
;

2892 
ä
.
dwFÜw¬dM‘ric3
 = 
METRIC_NOT_USED
;

2893 
ä
.
dwFÜw¬dM‘ric4
 = 
METRIC_NOT_USED
;

2894 
ä
.
dwFÜw¬dM‘ric5
 = 
METRIC_NOT_USED
;

2896 ià((
r
->
ÃtwÜk
 &„->
Ãtmask
) !=„->network)

2898 
	`msg
(
M_WARN
, "Warning:‡ddress %s is‚ot‡‚etwork‡ddress in„elationo‚etmask %s",

2899 
	`´št_š_addr_t
(
r
->
ÃtwÜk
, 0, &
gc
),

2900 
	`´št_š_addr_t
(
r
->
Ãtmask
, 0, &
gc
));

2903 
¡©us
 = 
	`C»©eIpFÜw¬dEÁry
(&
ä
);

2905 ià(
¡©us
 =ğ
NO_ERROR
)

2907 
»t
 = 
Œue
;

2912 cÚ¡ 
fÜw¬d_m‘ric_lim™
 = 2048;

2914 ; 
ä
.
dwFÜw¬dM‘ric1
 <ğ
fÜw¬d_m‘ric_lim™
; ++fr.dwForwardMetric1)

2918 
ä
.
dwFÜw¬dTy³
 = 4; fr.dwForwardType >= 3; --fr.dwForwardType)

2920 
¡©us
 = 
	`C»©eIpFÜw¬dEÁry
(&
ä
);

2921 ià(
¡©us
 =ğ
NO_ERROR
)

2923 
	`msg
(
D_ROUTE
, "ROUTE: CreateIpForwardEntry succeeded with dwForwardMetric1=%u‡nd dwForwardType=%u",

2924 ()
ä
.
dwFÜw¬dM‘ric1
,

2925 ()
ä
.
dwFÜw¬dTy³
);

2926 
»t
 = 
Œue
;

2927 
doubËb»ak
;

2929 ià(
¡©us
 !ğ
ERROR_BAD_ARGUMENTS
)

2931 
doubËb»ak
;

2936 
doubËb»ak
:

2937 ià(
¡©us
 !ğ
NO_ERROR
)

2939 
	`msg
(
M_WARN
, "ROUTE:„oute‡ddition failed using CreateIpForwardEntry: %s [status=%u if_index=%u]",

2940 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

2941 ()
¡©us
,

2942 ()
if_šdex
);

2947 
	`gc_ä“
(&
gc
);

2948  
»t
;

2949 
	}
}

2951 
boŞ


2952 
	$d–_rou‹_­i
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

2954 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2955 
boŞ
 
»t
 = 
çl£
;

2956 
DWORD
 
¡©us
;

2957 cÚ¡ 
DWORD
 
if_šdex
 = 
	`wšdows_rou‹_fšd_if_šdex
(
r
, 
‰
);

2959 ià(
if_šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

2961 
MIB_IPFORWARDROW
 
ä
;

2962 
	`CLEAR
(
ä
);

2964 
ä
.
dwFÜw¬dDe¡
 = 
	`htÚl
(
r
->
ÃtwÜk
);

2965 
ä
.
dwFÜw¬dMask
 = 
	`htÚl
(
r
->
Ãtmask
);

2966 
ä
.
dwFÜw¬dPŞicy
 = 0;

2967 
ä
.
dwFÜw¬dNextHİ
 = 
	`htÚl
(
r
->
g©eway
);

2968 
ä
.
dwFÜw¬dIfIndex
 = 
if_šdex
;

2970 
¡©us
 = 
	`D–‘eIpFÜw¬dEÁry
(&
ä
);

2972 ià(
¡©us
 =ğ
NO_ERROR
)

2974 
»t
 = 
Œue
;

2978 
	`msg
(
M_WARN
, "ROUTE:„oute deletion failed using DeleteIpForwardEntry: %s",

2979 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

2983 
	`gc_ä“
(&
gc
);

2984  
»t
;

2985 
	}
}

2987 
boŞ


2988 
	$do_rou‹_£rviû
(cÚ¡ 
boŞ
 
add
, cÚ¡ 
rou‹_mes§ge_t
 *
¹
, cÚ¡ 
size_t
 
size
, 
HANDLE
 
pe
)

2990 
DWORD
 
Ën
;

2991 
boŞ
 
»t
 = 
çl£
;

2992 
ack_mes§ge_t
 
ack
;

2993 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2995 ià(!
	`Wr™eFe
(
pe
, 
¹
, 
size
, &
Ën
, 
NULL
)

2996 || !
	`R—dFe
(
pe
, &
ack
, ×ck), &
Ën
, 
NULL
))

2998 
	`msg
(
M_WARN
, "ROUTE: could‚otalko service: %s [%lu]",

2999 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

3000 
out
;

3003 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

3005 
	`msg
(
M_WARN
, "ROUTE:„oute %s failed using service: %s [status=%u if_index=%d]",

3006 (
add
 ? "add™iÚ" : "d–‘iÚ"), 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),

3007 
ack
.
”rÜ_numb”
, 
¹
->
içû
.
šdex
);

3008 
out
;

3011 
»t
 = 
Œue
;

3013 
out
:

3014 
	`gc_ä“
(&
gc
);

3015  
»t
;

3016 
	}
}

3018 
boŞ


3019 
	$do_rou‹_v4_£rviû
(cÚ¡ 
boŞ
 
add
, cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3021 
DWORD
 
if_šdex
 = 
	`wšdows_rou‹_fšd_if_šdex
(
r
, 
‰
);

3022 ià(
if_šdex
 == ~0)

3024  
çl£
;

3027 
rou‹_mes§ge_t
 
msg
 = {

3028 .
h—d”
 = {

3029 (
add
 ? 
msg_add_rou‹
 : 
msg_d–_rou‹
),

3030 (
rou‹_mes§ge_t
),

3033 .
çmy
 = 
AF_INET
,

3034 .
´efix
.
v4
.
s_addr
 = 
	`htÚl
(
r
->
ÃtwÜk
),

3035 .
g©eway
.
v4
.
s_addr
 = 
	`htÚl
(
r
->gateway),

3036 .
içû
 = { .
šdex
 = 
if_šdex
, .
Çme
 = "" },

3037 .
m‘ric
 = (
r
->
æags
 & 
RT_METRIC_DEFINED
 ?„->metric : -1)

3040 
	`Ãtmask_to_Ãtb™s
(
r
->
ÃtwÜk
,„->
Ãtmask
, &
msg
.
´efix_Ën
);

3041 ià(
msg
.
´efix_Ën
 == -1)

3043 
msg
.
´efix_Ën
 = 32;

3046  
	`do_rou‹_£rviû
(
add
, &
msg
, (msg), 
‰
->
İtiÚs
.
msg_chªÃl
);

3047 
	}
}

3049 
boŞ


3050 
	$do_rou‹_v6_£rviû
(cÚ¡ 
boŞ
 
add
, cÚ¡ 
rou‹_v6
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3052 
boŞ
 
¡©us
;

3053 
rou‹_mes§ge_t
 
msg
 = {

3054 .
h—d”
 = {

3055 (
add
 ? 
msg_add_rou‹
 : 
msg_d–_rou‹
),

3056 (
rou‹_mes§ge_t
),

3059 .
çmy
 = 
AF_INET6
,

3060 .
´efix
.
v6
 = 
r
->
ÃtwÜk
,

3061 .
´efix_Ën
 = 
r
->
Ãtb™s
,

3062 .
g©eway
.
v6
 = 
r
->gateway,

3063 .
içû
 = { .
šdex
 = 
‰
->
ad­‹r_šdex
, .
Çme
 = "" },

3064 .
m‘ric
 = ( (
r
->
æags
 & 
RT_METRIC_DEFINED
) ?„->metric : -1)

3067 ià(
r
->
ad­‹r_šdex
)

3069 
msg
.
içû
.
šdex
 = 
r
->
ad­‹r_šdex
;

3076 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN


3077 && 
msg
.
içû
.
šdex
 =ğ
‰
->
ad­‹r_šdex
 )

3079 
	`š‘_±Ú
(
AF_INET6
, "ã80::8", &
msg
.
g©eway
.
v6
);

3082 ià(
msg
.
içû
.
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

3084 
	`¡ºıy
(
msg
.
içû
.
Çme
, 
‰
->
aùu®_Çme
, (msg.iface.name));

3085 
msg
.
içû
.
Çme
[(msg.iface.name) - 1] = '\0';

3088 
¡©us
 = 
	`do_rou‹_£rviû
(
add
, &
msg
, (msg), 
‰
->
İtiÚs
.
msg_chªÃl
);

3089 
	`msg
(
D_ROUTE
, "IPv6„oute %s via service %s",

3090 
add
 ? "addition" : "deletion",

3091 
¡©us
 ? "succeeded" : "failed");

3092  
¡©us
;

3093 
	}
}

3095 
boŞ


3096 
	$add_rou‹_£rviû
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3098  
	`do_rou‹_v4_£rviû
(
Œue
, 
r
, 
‰
);

3099 
	}
}

3101 
boŞ


3102 
	$d–_rou‹_£rviû
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3104  
	`do_rou‹_v4_£rviû
(
çl£
, 
r
, 
‰
);

3105 
	}
}

3107 
boŞ


3108 
	$add_rou‹_v6_£rviû
(cÚ¡ 
rou‹_v6
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3110  
	`do_rou‹_v6_£rviû
(
Œue
, 
r
, 
‰
);

3111 
	}
}

3113 
boŞ


3114 
	$d–_rou‹_v6_£rviû
(cÚ¡ 
rou‹_v6
 *
r
, cÚ¡ 
tuÁ­
 *
‰
)

3116  
	`do_rou‹_v6_£rviû
(
çl£
, 
r
, 
‰
);

3117 
	}
}

3120 
	$fÜm©_rou‹_’Œy
(cÚ¡ 
MIB_IPFORWARDROW
 *
r
, 
gc_¬’a
 *
gc
)

3122 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

3123 
	`buf_´štf
(&
out
, "%s %s %s…=%d i=%d=%d…r=%d‡=%d h=%d m=%d/%d/%d/%d/%d",

3124 
	`´št_š_addr_t
(
r
->
dwFÜw¬dDe¡
, 
IA_NET_ORDER
, 
gc
),

3125 
	`´št_š_addr_t
(
r
->
dwFÜw¬dMask
, 
IA_NET_ORDER
, 
gc
),

3126 
	`´št_š_addr_t
(
r
->
dwFÜw¬dNextHİ
, 
IA_NET_ORDER
, 
gc
),

3127 ()
r
->
dwFÜw¬dPŞicy
,

3128 ()
r
->
dwFÜw¬dIfIndex
,

3129 ()
r
->
dwFÜw¬dTy³
,

3130 ()
r
->
dwFÜw¬dPrÙo
,

3131 ()
r
->
dwFÜw¬dAge
,

3132 ()
r
->
dwFÜw¬dNextHİAS
,

3133 ()
r
->
dwFÜw¬dM‘ric1
,

3134 ()
r
->
dwFÜw¬dM‘ric2
,

3135 ()
r
->
dwFÜw¬dM‘ric3
,

3136 ()
r
->
dwFÜw¬dM‘ric4
,

3137 ()
r
->
dwFÜw¬dM‘ric5
);

3138  
	`BSTR
(&
out
);

3139 
	}
}

3145 
	$show_rou‹s
(
msgËv
)

3147 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3148 
i
;

3150 cÚ¡ 
MIB_IPFORWARDTABLE
 *
¹
 = 
	`g‘_wšdows_routšg_bË
(&
gc
);

3152 
	`msg
(
msgËv
, "SYSTEM ROUTING TABLE");

3153 ià(
¹
)

3155 
i
 = 0; i < 
¹
->
dwNumEÁr›s
; ++i)

3157 
	`msg
(
msgËv
, "%s", 
	`fÜm©_rou‹_’Œy
(&
¹
->
bË
[
i
], &
gc
));

3160 
	`gc_ä“
(&
gc
);

3161 
	}
}

3163 #–ià
defšed
(
TARGET_LINUX
è|| defšed(
TARGET_ANDROID
)

3166 
	$g‘_deçuÉ_g©eway
(
rou‹_g©eway_šfo
 *
rgi
)

3168 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3169 
sd
 = -1;

3170 
be¡_Çme
[16];

3171 
be¡_Çme
[0] = 0;

3173 
	`CLEAR
(*
rgi
);

3175 #iâdeà
TARGET_ANDROID


3178 
FILE
 *
å
 = 
	`fİ’
("/proc/net/route", "r");

3179 ià(
å
)

3181 
lše
[256];

3182 
couÁ
 = 0;

3183 
lowe¡_m‘ric
 = 
UINT_MAX
;

3184 
š_addr_t
 
be¡_gw
 = 0;

3185 
boŞ
 
found
 = 
çl£
;

3186 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
)

3188 ià(
couÁ
)

3190 
Ãt_x
 = 0;

3191 
mask_x
 = 0;

3192 
gw_x
 = 0;

3193 
m‘ric
 = 0;

3194 
æags
 = 0;

3195 
Çme
[16];

3196 
Çme
[0] = 0;

3197 cÚ¡ 
Å
 = 
	`ssÿnf
(
lše
, "%15s\t%x\t%x\t%x\t%*s\t%*s\t%d\t%x",

3198 
Çme
,

3199 &
Ãt_x
,

3200 &
gw_x
,

3201 &
æags
,

3202 &
m‘ric
,

3203 &
mask_x
);

3204 ià(
Å
 =ğ6 && (
æags
 & 
IFF_UP
))

3206 cÚ¡ 
š_addr_t
 
Ãt
 = 
	`Áohl
(
Ãt_x
);

3207 cÚ¡ 
š_addr_t
 
mask
 = 
	`Áohl
(
mask_x
);

3208 cÚ¡ 
š_addr_t
 
gw
 = 
	`Áohl
(
gw_x
);

3210 ià(!
Ãt
 && !
mask
 && 
m‘ric
 < 
lowe¡_m‘ric
)

3212 
found
 = 
Œue
;

3213 
be¡_gw
 = 
gw
;

3214 
	`¡rıy
(
be¡_Çme
, 
Çme
);

3215 
lowe¡_m‘ric
 = 
m‘ric
;

3219 ++
couÁ
;

3221 
	`fşo£
(
å
);

3223 ià(
found
)

3225 
rgi
->
g©eway
.
addr
 = 
be¡_gw
;

3226 
rgi
->
æags
 |ğ
RGI_ADDR_DEFINED
;

3227 ià(!
rgi
->
g©eway
.
addr
 && 
be¡_Çme
[0])

3229 
rgi
->
æags
 |ğ
RGI_ON_LINK
;

3243 
rgi
->
g©eway
.
addr
 = 127 << 24 | 'd' << 16 | 'g' << 8 | 'w';

3244 
rgi
->
æags
 |ğ
RGI_ADDR_DEFINED
;

3245 
	`¡rıy
(
be¡_Çme
, "android-gw");

3249 ià(
rgi
->
æags
 & 
RGI_ADDR_DEFINED
)

3251 
iäeq
 *
iä
, *
iãnd
;

3252 
š_addr_t
 
addr
, 
Ãtmask
;

3253 
iäeq
 ifreq;

3254 
ifcÚf
 
ifc
;

3255 
iäeq
 
ifs
[20];

3257 ià((
sd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) < 0)

3259 
	`msg
(
M_WARN
, "GDG: socket() failed");

3260 
dÚe
;

3262 
ifc
.
ifc_Ën
 = (
ifs
);

3263 
ifc
.
ifc_»q
 = 
ifs
;

3264 ià(
	`ioùl
(
sd
, 
SIOCGIFCONF
, &
ifc
) < 0)

3266 
	`msg
(
M_WARN
, "GDG: ioctl(SIOCGIFCONF) failed");

3267 
dÚe
;

3271 
iãnd
 = 
ifs
 + (
ifc
.
ifc_Ën
 / (
iäeq
));

3272 
iä
 = 
ifc
.
ifc_»q
; iä < 
iãnd
; ifr++)

3274 ià(
iä
->
iä_addr
.
§_çmy
 =ğ
AF_INET
)

3277 
addr
 = 
	`Áohl
(((
sockaddr_š
 *è&
iä
->
iä_addr
)->
sš_addr
.
s_addr
);

3280 
	`¡ºıyÁ
(
iäeq
.
iä_Çme
, 
iä
->ifr_name, (ifreq.ifr_name));

3283 ià(
	`ioùl
(
sd
, 
SIOCGIFFLAGS
, &
iäeq
) < 0)

3287 ià(!(
iäeq
.
iä_æags
 & 
IFF_UP
))

3292 ià(
rgi
->
æags
 & 
RGI_ON_LINK
)

3296 ià(
	`¡rcmp
(
iäeq
.
iä_Çme
, 
be¡_Çme
))

3302 ià((
iäeq
.
iä_æags
 & 
IFF_POINTOPOINT
è&& 
	`ioùl
(
sd
, 
SIOCGIFDSTADDR
, &ifreq) >= 0)

3304 
rgi
->
g©eway
.
addr
 = 
	`Áohl
(((
sockaddr_š
 *è&
iäeq
.
iä_addr
)->
sš_addr
.
s_addr
);

3305 ià(
rgi
->
g©eway
.
addr
)

3307 
rgi
->
æags
 &ğ~
RGI_ON_LINK
;

3315 ià(
	`ioùl
(
sd
, 
SIOCGIFNETMASK
, &
iäeq
) < 0)

3319 
Ãtmask
 = 
	`Áohl
(((
sockaddr_š
 *è&
iäeq
.
iä_addr
)->
sš_addr
.
s_addr
);

3322 ià(((
rgi
->
g©eway
.
addr
 ^‡ddrè& 
Ãtmask
) != 0)

3328 
rgi
->
g©eway
.
Ãtmask
 =‚etmask;

3329 
rgi
->
æags
 |ğ
RGI_NETMASK_DEFINED
;

3333 
	`¡ºıyÁ
(
rgi
->
içû
, 
iäeq
.
iä_Çme
, (rgi->iface));

3334 
rgi
->
æags
 |ğ
RGI_IFACE_DEFINED
;

3337 
	`mem£t
(&
iäeq
.
iä_hwaddr
, 0, (
sockaddr
));

3338 ià(
	`ioùl
(
sd
, 
SIOCGIFHWADDR
, &
iäeq
) < 0)

3340 
	`msg
(
M_WARN
, "GDG: SIOCGIFHWADDR(%sèçed", 
iäeq
.
iä_Çme
);

3341 
dÚe
;

3343 
	`memıy
(
rgi
->
hwaddr
, &
iäeq
.
iä_hwaddr
.
§_d©a
, 6);

3344 
rgi
->
æags
 |ğ
RGI_HWADDR_DEFINED
;

3351 
dÚe
:

3352 ià(
sd
 >= 0)

3354 
	`şo£
(
sd
);

3356 
	`gc_ä“
(&
gc
);

3357 
	}
}

3364 
	s¹»q
 {

3365 
Æmsghdr
 
	mnh
;

3366 
¹msg
 
	m¹m
;

3367 
	m©Œbuf
[512];

3371 
	$g‘_deçuÉ_g©eway_v6
(
rou‹_v6_g©eway_šfo
 *
rgi6
,

3372 cÚ¡ 
š6_addr
 *
de¡
)

3374 
Æs
 = -1;

3375 
¹»q
„treq;

3376 
¹©Œ
 *
¹a
;

3378 
¹buf
[2000];

3379 
ssize_t
 
ssize
;

3381 
	`CLEAR
(*
rgi6
);

3383 
Æs
 = 
	`sock‘
Ğ
PF_NETLINK
, 
SOCK_RAW
, 
NETLINK_ROUTE
 );

3384 ià(
Æs
 < 0)

3386 
	`msg
(
M_WARN
|
M_ERRNO
, "GDG6: sock‘(èçed" ); 
dÚe
;

3393 
	`CLEAR
(
¹»q
);

3394 
¹»q
.
nh
.
Æmsg_ty³
 = 
RTM_GETROUTE
;

3395 
¹»q
.
nh
.
Æmsg_æags
 = 
NLM_F_REQUEST
;

3396 
¹»q
.
¹m
.
¹m_çmy
 = 
AF_INET6
;

3397 
¹»q
.
¹m
.
¹m_¤c_Ën
 = 0;

3398 
¹»q
.
¹m
.
¹m_d¡_Ën
 = 128;

3399 
¹»q
.
¹m
.
¹m_bË
 = 
RT_TABLE_MAIN
;

3400 
¹»q
.
¹m
.
¹m_´ÙocŞ
 = 
RTPROT_UNSPEC
;

3401 
¹»q
.
nh
.
Æmsg_Ën
 = 
	`NLMSG_SPACE
(ÔŒeq.
¹m
));

3404 
¹a
 = (
¹©Œ
 *)(((*è&
¹»q
)+
	`NLMSG_ALIGN
ÔŒeq.
nh
.
Æmsg_Ën
));

3405 
¹a
->
¹a_ty³
 = 
RTA_DST
;

3406 
¹a
->
¹a_Ën
 = 
	`RTA_LENGTH
(16);

3407 
¹»q
.
nh
.
Æmsg_Ën
 = 
	`NLMSG_ALIGN
(rtreq.nh.nlmsg_len)

3408 +
	`RTA_LENGTH
(16);

3410 ià(
de¡
 =ğ
NULL
)

3412 
	`mem£t
Ğ
	`RTA_DATA
(
¹a
), 0, 16 );

3416 
	`memıy
Ğ
	`RTA_DATA
(
¹a
), (*)
de¡
, 16 );

3420 ià(
	`£nd
Ğ
Æs
, &
¹»q
,„Œeq.
nh
.
Æmsg_Ën
, 0 ) < 0)

3422 
	`msg
(
M_WARN
|
M_ERRNO
, "GDG6: s’d(èçed" ); 
dÚe
;

3425 
ssize
 = 
	`»cv
(
Æs
, 
¹buf
, Ôtbuf), 
MSG_TRUNC
);

3427 ià(
ssize
 < 0)

3429 
	`msg
(
M_WARN
|
M_ERRNO
, "GDG6:„ecv(èçed" ); 
dÚe
;

3432 ià(
ssize
 > (
¹buf
))

3434 
	`msg
(
M_WARN
, "g‘_deçuÉ_g©eway_v6:„‘uºed mes§gtoØbig fÜ bufã¸(%d>%d)", ()
ssize
, ()(
¹buf
) );

3435 
dÚe
;

3438 
Æmsghdr
 *
nh
;

3440 
nh
 = (
Æmsghdr
 *)
¹buf
;

3441 
	`NLMSG_OK
(
nh
, 
ssize
);

3442 
nh
 = 
	`NLMSG_NEXT
Òh, 
ssize
))

3444 
¹msg
 *
¹m
;

3445 
©ŒËn
;

3447 ià(
nh
->
Æmsg_ty³
 =ğ
NLMSG_DONE
)

3452 ià(
nh
->
Æmsg_ty³
 =ğ
NLMSG_ERROR
)

3454 
Æmsg”r
 *
Ã
 = (Æmsg”¸*)
	`NLMSG_DATA
(
nh
);

3458 ià(
Ã
->
”rÜ
 !ğ-
ENETUNREACH
)

3460 
	`msg
(
M_WARN
, "GDG6: NLMSG_ERROR:ƒrror %s\n",

3461 
	`¡»¼Ü
(-
Ã
->
”rÜ
));

3466 ià(
nh
->
Æmsg_ty³
 !ğ
RTM_NEWROUTE
)

3469 
	`msg
(
M_WARN
, "GDG6: uÃx³ùed msg_ty³ %d", 
nh
->
Æmsg_ty³
 );

3473 
¹m
 = (
¹msg
 *)
	`NLMSG_DATA
(
nh
);

3474 
©ŒËn
 = 
	`RTM_PAYLOAD
(
nh
);

3479 ià(
¹m
->
¹m_çmy
 !ğ
AF_INET6


3480 || 
¹m
->
¹m_bË
 !ğ
RT_TABLE_MAIN
)

3485 
¹a
 = 
	`RTM_RTA
(
¹m
);

3486 
	`RTA_OK
(
¹a
, 
©ŒËn
);

3487 
¹a
 = 
	`RTA_NEXT
Ô, 
©ŒËn
))

3489 ià(
¹a
->
¹a_ty³
 =ğ
RTA_GATEWAY
)

3491 ià(
	`RTA_PAYLOAD
(
¹a
è!ğ(
š6_addr
) )

3493 
	`msg
(
M_WARN
, "GDG6: RTA_GW size mismatch"); ;

3495 
rgi6
->
g©eway
.
addr_v6
 = *(
š6_addr
 *è
	`RTA_DATA
(
¹a
);

3496 
rgi6
->
æags
 |ğ
RGI_ADDR_DEFINED
;

3498 ià(
¹a
->
¹a_ty³
 =ğ
RTA_OIF
)

3500 
iâame
[
IF_NAMESIZE
+1];

3501 
oif
;

3502 ià(
	`RTA_PAYLOAD
(
¹a
è!ğ(
oif
) )

3504 
	`msg
(
M_WARN
, "GDG6: oif size mismatch"); ;

3507 
	`memıy
(&
oif
, 
	`RTA_DATA
(
¹a
), (oif));

3508 
	`if_šdextÚame
(
oif
,
iâame
);

3509 
	`¡ºıy
Ğ
rgi6
->
içû
, 
iâame
, (rgi6->iface)-1 );

3510 
rgi6
->
æags
 |ğ
RGI_IFACE_DEFINED
;

3516 iàĞĞ
rgi6
->
æags
 & (
RGI_IFACE_DEFINED
|
RGI_ADDR_DEFINED
) ) ==

3517 
RGI_IFACE_DEFINED
)

3519 
rgi6
->
æags
 |ğ(
RGI_ADDR_DEFINED
 | 
RGI_ON_LINK
);

3520 ià(
de¡
)

3522 
rgi6
->
g©eway
.
addr_v6
 = *
de¡
;

3526 
dÚe
:

3527 ià(
Æs
 >= 0)

3529 
	`şo£
(
Æs
);

3531 
	}
}

3533 #–ià
defšed
(
TARGET_DARWIN
è|| defšed(
TARGET_SOLARIS
) \

3534 || 
defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
) \

3535 || 
defšed
(
TARGET_OPENBSD
è|| 
	$defšed
(
TARGET_NETBSD
)

3537 
	~<sys/ty³s.h
>

3538 
	~<sys/sock‘.h
>

3539 
	~<Ãtš‘/š.h
>

3540 
	~<Ãt/rou‹.h
>

3541 
	~<Ãt/if_dl.h
>

3543 
	s¹msg
 {

3544 
¹_msghdr
 
m_¹m
;

3545 
m_¥aû
[512];

3560 #ià
	`defšed
(
TARGET_DARWIN
)

3561 
	#ROUNDUP
(
a
) \

3562 ((
a
è> 0 ? (1 + ((×è- 1è| ((
ušt32_t
è- 1))è: (ušt32_t))

	)

3564 
	#ROUNDUP
(
a
) \

3565 ((
a
è> 0 ? (1 + ((×è- 1è| ((è- 1))è: ())

	)

3568 #ià
	`defšed
(
TARGET_SOLARIS
)

3569 
	#NEXTADDR
(
w
, 
u
) \

3570 ià(
¹m_addrs
 & (
w
)) { \

3571 
l
 = 
	`ROUNDUP
((
u
)); 
	`memmove
(
ı
, &(u),†); cp +=†; \

3572 
	}

	)
}

3574 
	#ADVANCE
(
x
, 
n
è(x +ğ
	`ROUNDUP
((
sockaddr_š
)))

	)

3576 
	#NEXTADDR
(
w
, 
u
) \

3577 ià(
¹m_addrs
 & (
w
)) { \

3578 
l
 = 
	`ROUNDUP
Ğ((
sockaddr
 *)&(
u
))->
§_Ën
); 
	`memmove
(
ı
, &(u),†); cp +=†; \

3579 }

	)

3581 
	#ADVANCE
(
x
, 
n
è(x +ğ
	`ROUNDUP
(Ò)->
§_Ën
))

	)

3584 
	#max
(
a
,
b
è(×è> (bè? (aè: (b))

	)

3587 
	$g‘_deçuÉ_g©eway
(
rou‹_g©eway_šfo
 *
rgi
)

3589 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3590 
¹msg
 
m_¹msg
;

3591 
sockfd
 = -1;

3592 
£q
, 
l
, 
pid
, 
¹m_addrs
;

3593 
i
;

3594 
sockaddr
 
so_d¡
, 
so_mask
;

3595 *
ı
 = 
m_¹msg
.
m_¥aû
;

3596 
sockaddr
 *
g©e
 = 
NULL
, *
iå
 = NULL, *
§
;

3597 
¹_msghdr
 *
¹m_aux
;

3599 
	#¹m
 
m_¹msg
.
m_¹m


	)

3601 
	`CLEAR
(*
rgi
);

3604 
pid
 = 
	`g‘pid
();

3605 
£q
 = 0;

3606 
¹m_addrs
 = 
RTA_DST
 | 
RTA_NETMASK
 | 
RTA_IFP
;

3608 
	`bz”o
(&
m_¹msg
, (m_rtmsg));

3609 
	`bz”o
(&
so_d¡
, (so_dst));

3610 
	`bz”o
(&
so_mask
, (so_mask));

3611 
	`bz”o
(&
¹m
, (
¹_msghdr
));

3613 
¹m
.
¹m_ty³
 = 
RTM_GET
;

3614 
¹m
.
¹m_æags
 = 
RTF_UP
 | 
RTF_GATEWAY
;

3615 
¹m
.
¹m_v”siÚ
 = 
RTM_VERSION
;

3616 
¹m
.
¹m_£q
 = ++
£q
;

3617 #ifdeà
TARGET_OPENBSD


3618 
¹m
.
¹m_bËid
 = 
	`g‘¹abË
();

3620 
¹m
.
¹m_addrs
 =„tm_addrs;

3622 
so_d¡
.
§_çmy
 = 
AF_INET
;

3623 
so_mask
.
§_çmy
 = 
AF_INET
;

3625 #iâdeà
TARGET_SOLARIS


3626 
so_d¡
.
§_Ën
 = (
sockaddr_š
);

3627 
so_mask
.
§_Ën
 = (
sockaddr_š
);

3630 
	`NEXTADDR
(
RTA_DST
, 
so_d¡
);

3631 
	`NEXTADDR
(
RTA_NETMASK
, 
so_mask
);

3633 
¹m
.
¹m_msgËn
 = 
l
 = 
ı
 - (*)&
m_¹msg
;

3636 
sockfd
 = 
	`sock‘
(
PF_ROUTE
, 
SOCK_RAW
, 0);

3637 ià(
sockfd
 < 0)

3639 
	`msg
(
M_WARN
, "GDG: socket #1 failed");

3640 
dÚe
;

3642 ià(
	`wr™e
(
sockfd
, (*)&
m_¹msg
, 
l
) < 0)

3644 
	`msg
(
M_WARN
, "GDG:…roblem writingo„outing socket");

3645 
dÚe
;

3649 
l
 = 
	`»ad
(
sockfd
, (*)&
m_¹msg
, (m_rtmsg));

3650 } 
l
 > 0 && (
¹m
.
¹m_£q
 !ğ
£q
 ||„tm.
¹m_pid
 !ğ
pid
));

3651 
	`şo£
(
sockfd
);

3652 
sockfd
 = -1;

3655 
¹m_aux
 = &
¹m
;

3656 
ı
 = ((*)(
¹m_aux
 + 1));

3657 ià(
¹m_aux
->
¹m_addrs
)

3659 
i
 = 1; i; i <<= 1)

3661 ià(
i
 & 
¹m_aux
->
¹m_addrs
)

3663 
§
 = (
sockaddr
 *)
ı
;

3664 ià(
i
 =ğ
RTA_GATEWAY
)

3666 
g©e
 = 
§
;

3668 ià(
i
 =ğ
RTA_IFP
)

3670 
iå
 = 
§
;

3672 
	`ADVANCE
(
ı
, 
§
);

3678 
dÚe
;

3682 ià(
g©e
 !ğ
NULL
)

3685 
rgi
->
g©eway
.
addr
 = 
	`Áohl
(((
sockaddr_š
 *)
g©e
)->
sš_addr
.
s_addr
);

3686 ià(
rgi
->
g©eway
.
addr
)

3688 
rgi
->
æags
 |ğ
RGI_ADDR_DEFINED
;

3691 ià(
iå
)

3694 cÚ¡ 
sockaddr_dl
 *
adl
 = (sockaddr_dÈ*è
iå
;

3695 ià(
adl
->
sdl_Æ’
 &&‡dl->sdl_Æ’ < (
rgi
->
içû
))

3697 
	`memıy
(
rgi
->
içû
, 
adl
->
sdl_d©a
,‡dl->
sdl_Æ’
);

3698 
rgi
->
içû
[
adl
->
sdl_Æ’
] = '\0';

3699 
rgi
->
æags
 |ğ
RGI_IFACE_DEFINED
;

3705 ià(
rgi
->
æags
 & 
RGI_IFACE_DEFINED
)

3707 
iäeq
 
iä
;

3709 
sockfd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

3710 ià(
sockfd
 < 0)

3712 
	`msg
(
M_WARN
, "GDG: socket #2 failed");

3713 
dÚe
;

3716 
	`CLEAR
(
iä
);

3717 
iä
.
iä_addr
.
§_çmy
 = 
AF_INET
;

3718 
	`¡ºıyÁ
(
iä
.
iä_Çme
, 
rgi
->
içû
, 
IFNAMSIZ
);

3720 ià(
	`ioùl
(
sockfd
, 
SIOCGIFNETMASK
, (*)&
iä
) < 0)

3722 
	`msg
(
M_WARN
, "GDG: ioctl #1 failed");

3723 
dÚe
;

3725 
	`şo£
(
sockfd
);

3726 
sockfd
 = -1;

3728 
rgi
->
g©eway
.
Ãtmask
 = 
	`Áohl
(((
sockaddr_š
 *)&
iä
.
iä_addr
)->
sš_addr
.
s_addr
);

3729 
rgi
->
æags
 |ğ
RGI_NETMASK_DEFINED
;

3733 ià(
rgi
->
æags
 & 
RGI_IFACE_DEFINED
)

3735 
ifcÚf
 
ifc
;

3736 
iäeq
 *
iä
;

3737 cÚ¡ 
bufsize
 = 4096;

3738 *
bufãr
;

3740 
bufãr
 = (*è
	`gc_m®loc
(
bufsize
, 
Œue
, &
gc
);

3741 
sockfd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0);

3742 ià(
sockfd
 < 0)

3744 
	`msg
(
M_WARN
, "GDG: socket #3 failed");

3745 
dÚe
;

3748 
ifc
.
ifc_Ën
 = 
bufsize
;

3749 
ifc
.
ifc_buf
 = 
bufãr
;

3751 ià(
	`ioùl
(
sockfd
, 
SIOCGIFCONF
, (*)&
ifc
) < 0)

3753 
	`msg
(
M_WARN
, "GDG: ioctl #2 failed");

3754 
dÚe
;

3756 
	`şo£
(
sockfd
);

3757 
sockfd
 = -1;

3759 
ı
 = 
bufãr
; c°<ğbufã¸+ 
ifc
.
ifc_Ën
 - (
iäeq
); )

3761 
iä
 = (
iäeq
 *)
ı
;

3762 #ià
	`defšed
(
TARGET_SOLARIS
)

3763 cÚ¡ 
size_t
 
Ën
 = (
iä
->
iä_Çme
è+ (iä->
iä_addr
);

3765 cÚ¡ 
size_t
 
Ën
 = (
iä
->
iä_Çme
è+ 
	`max
((iä->
iä_addr
), iä->iä_addr.
§_Ën
);

3768 ià(!
iä
->
iä_addr
.
§_çmy
)

3772 ià(!
	`¡ºcmp
(
iä
->
iä_Çme
, 
rgi
->
içû
, 
IFNAMSIZ
))

3774 ià(
iä
->
iä_addr
.
§_çmy
 =ğ
AF_LINK
)

3776 
sockaddr_dl
 *
sdl
 = (sockaddr_dÈ*)&
iä
->
iä_addr
;

3777 
	`memıy
(
rgi
->
hwaddr
, 
	`LLADDR
(
sdl
), 6);

3778 
rgi
->
æags
 |ğ
RGI_HWADDR_DEFINED
;

3781 
ı
 +ğ
Ën
;

3785 
dÚe
:

3786 ià(
sockfd
 >= 0)

3788 
	`şo£
(
sockfd
);

3790 
	`gc_ä“
(&
gc
);

3791 
	}
}

3800 #ià
defšed
(
TARGET_SOLARIS
)

3801 #undeà
ADVANCE


3802 
	#ADVANCE
(
x
, 
n
è(x +ğ
	`ROUNDUP
((
sockaddr_š6
)))

	)

3806 
	$g‘_deçuÉ_g©eway_v6
(
rou‹_v6_g©eway_šfo
 *
rgi6
,

3807 cÚ¡ 
š6_addr
 *
de¡
)

3810 
¹msg
 
m_¹msg
;

3811 
sockfd
 = -1;

3812 
£q
, 
l
, 
pid
, 
¹m_addrs
;

3813 
i
;

3814 
sockaddr_š6
 
so_d¡
, 
so_mask
;

3815 *
ı
 = 
m_¹msg
.
m_¥aû
;

3816 
sockaddr
 *
g©e
 = 
NULL
, *
iå
 = NULL, *
§
;

3817 
¹_msghdr
 *
¹m_aux
;

3819 
	`CLEAR
(*
rgi6
);

3822 
pid
 = 
	`g‘pid
();

3823 
£q
 = 0;

3824 
¹m_addrs
 = 
RTA_DST
 | 
RTA_NETMASK
 | 
RTA_IFP
;

3826 
	`bz”o
(&
m_¹msg
, (m_rtmsg));

3827 
	`bz”o
(&
so_d¡
, (so_dst));

3828 
	`bz”o
(&
so_mask
, (so_mask));

3829 
	`bz”o
(&
¹m
, (
¹_msghdr
));

3831 
¹m
.
¹m_ty³
 = 
RTM_GET
;

3832 
¹m
.
¹m_æags
 = 
RTF_UP
;

3833 
¹m
.
¹m_v”siÚ
 = 
RTM_VERSION
;

3834 
¹m
.
¹m_£q
 = ++
£q
;

3835 #ifdeà
TARGET_OPENBSD


3836 
¹m
.
¹m_bËid
 = 
	`g‘¹abË
();

3839 
so_d¡
.
sš6_çmy
 = 
AF_INET6
;

3840 
so_mask
.
sš6_çmy
 = 
AF_INET6
;

3842 ià(
de¡
 !ğ
NULL


3843 && !
	`IN6_IS_ADDR_UNSPECIFIED
(
de¡
) )

3845 
so_d¡
.
sš6_addr
 = *
de¡
;

3847 
¹m_addrs
 &ğ~
RTA_NETMASK
;

3850 
¹m
.
¹m_addrs
 =„tm_addrs;

3852 #iâdeà
TARGET_SOLARIS


3853 
so_d¡
.
sš6_Ën
 = (
sockaddr_š6
);

3854 
so_mask
.
sš6_Ën
 = (
sockaddr_š6
);

3857 
	`NEXTADDR
(
RTA_DST
, 
so_d¡
);

3858 
	`NEXTADDR
(
RTA_NETMASK
, 
so_mask
);

3860 
¹m
.
¹m_msgËn
 = 
l
 = 
ı
 - (*)&
m_¹msg
;

3863 
sockfd
 = 
	`sock‘
(
PF_ROUTE
, 
SOCK_RAW
, 0);

3864 ià(
sockfd
 < 0)

3866 
	`msg
(
M_WARN
, "GDG6: socket #1 failed");

3867 
dÚe
;

3869 ià(
	`wr™e
(
sockfd
, (*)&
m_¹msg
, 
l
) < 0)

3871 
	`msg
(
M_WARN
, "GDG6:…roblem writingo„outing socket");

3872 
dÚe
;

3877 
l
 = 
	`»ad
(
sockfd
, (*)&
m_¹msg
, (m_rtmsg));

3879 
l
 > 0 && (
¹m
.
¹m_£q
 !ğ
£q
 ||„tm.
¹m_pid
 !ğ
pid
));

3881 
	`şo£
(
sockfd
);

3882 
sockfd
 = -1;

3885 
¹m_aux
 = &
¹m
;

3886 
ı
 = ((*)(
¹m_aux
 + 1));

3887 ià(
¹m_aux
->
¹m_addrs
)

3889 
i
 = 1; i; i <<= 1)

3891 ià(
i
 & 
¹m_aux
->
¹m_addrs
)

3893 
§
 = (
sockaddr
 *)
ı
;

3894 ià(
i
 =ğ
RTA_GATEWAY
)

3896 
g©e
 = 
§
;

3898 ià(
i
 =ğ
RTA_IFP
)

3900 
iå
 = 
§
;

3902 
	`ADVANCE
(
ı
, 
§
);

3908 
dÚe
;

3912 ià(
g©e
 !ğ
NULL
)

3914 
sockaddr_š6
 *
s6
 = (sockaddr_š6 *)
g©e
;

3915 
š6_addr
 
gw
 = 
s6
->
sš6_addr
;

3917 #iâdeà
TARGET_SOLARIS


3922 ià(
g©e
->
§_Ën
 =ğ(
sockaddr_š6
)

3923 && 
	`IN6_IS_ADDR_LINKLOCAL
(&
gw
) )

3925 
gw
.
s6_addr
[2] = gw.s6_addr[3] = 0;

3928 ià(
g©e
->
§_Ën
 !ğ(
sockaddr_š6
)

3929 || 
	`IN6_IS_ADDR_UNSPECIFIED
(&
gw
) )

3931 
rgi6
->
æags
 |ğ
RGI_ON_LINK
;

3936 
rgi6
->
g©eway
.
addr_v6
 = 
gw
;

3937 
rgi6
->
æags
 |ğ
RGI_ADDR_DEFINED
;

3939 ià(
iå
)

3942 cÚ¡ 
sockaddr_dl
 *
adl
 = (sockaddr_dÈ*è
iå
;

3943 ià(
adl
->
sdl_Æ’
 &&‡dl->sdl_Æ’ < (
rgi6
->
içû
))

3945 
	`memıy
(
rgi6
->
içû
, 
adl
->
sdl_d©a
,‡dl->
sdl_Æ’
);

3946 
rgi6
->
æags
 |ğ
RGI_IFACE_DEFINED
;

3951 
dÚe
:

3952 ià(
sockfd
 >= 0)

3954 
	`şo£
(
sockfd
);

3956 
	}
}

3958 #undeà
max


3987 
	$g‘_deçuÉ_g©eway
(
rou‹_g©eway_šfo
 *
rgi
)

3989 
	`CLEAR
(*
rgi
);

3990 
	}
}

3992 
	$g‘_deçuÉ_g©eway_v6
(
rou‹_v6_g©eway_šfo
 *
rgi6
,

3993 cÚ¡ 
š6_addr
 *
de¡
)

3995 
	`msg
(
D_ROUTE
, "no support for get_default_gateway_ipv6() onhis system");

3996 
	`CLEAR
(*
rgi6
);

3997 
	}
}

4001 
boŞ


4002 
	$Ãtmask_to_Ãtb™s
(cÚ¡ 
š_addr_t
 
ÃtwÜk
, cÚ¡ in_addr_ˆ
Ãtmask
, *
Ãtb™s
)

4004 
i
;

4005 cÚ¡ 
add¾’
 = (
š_addr_t
) * 8;

4007 ià((
ÃtwÜk
 & 
Ãtmask
) ==‚etwork)

4009 
i
 = 0; i <ğ
add¾’
; ++i)

4011 
š_addr_t
 
mask
 = 
	`Ãtb™s_to_Ãtmask
(
i
);

4012 ià(
mask
 =ğ
Ãtmask
)

4014 ià(
i
 =ğ
add¾’
)

4016 *
Ãtb™s
 = -1;

4020 *
Ãtb™s
 = 
i
;

4022  
Œue
;

4026  
çl£
;

4027 
	}
}

4033 
	$Ãtmask_to_Ãtb™s2
(
š_addr_t
 
Ãtmask
)

4035 
i
;

4036 cÚ¡ 
add¾’
 = (
š_addr_t
) * 8;

4038 
i
 = 0; i <ğ
add¾’
; ++i)

4040 
š_addr_t
 
mask
 = 
	`Ãtb™s_to_Ãtmask
(
i
);

4041 ià(
mask
 =ğ
Ãtmask
)

4043  
i
;

4047 
	}
}

4056 #ià
defšed
(
_WIN32
)

4059 
	$add_ho¡_rou‹_if_nÚloÿl
(
rou‹_by·ss
 *
rb
, cÚ¡ 
š_addr_t
 
addr
)

4061 ià(
	`‹¡_loÿl_addr
(
addr
, 
NULL
è=ğ
TLA_NONLOCAL
 &&‡dd¸!ğ0 &&‡dd¸!ğ
IPV4_NETMASK_HOST
)

4063 
	`add_by·ss_add»ss
(
rb
, 
addr
);

4065 
	}
}

4068 
	$add_ho¡_rou‹_¬¿y
(
rou‹_by·ss
 *
rb
, cÚ¡ 
IP_ADDR_STRING
 *
li¡
)

4070 
li¡
)

4072 
boŞ
 
sucûed
 = 
çl£
;

4073 cÚ¡ 
š_addr_t
 

 = 
	`g‘addr
(
GETADDR_HOST_ORDER
, 
li¡
->
IpAdd»ss
.
SŒšg
, 0, &
sucûed
, 
NULL
);

4074 ià(
sucûed
)

4076 
	`add_ho¡_rou‹_if_nÚloÿl
(
rb
, 

);

4078 
li¡
 = i¶i¡->
Next
;

4080 
	}
}

4083 
	$g‘_by·ss_add»s£s
(
rou‹_by·ss
 *
rb
, cÚ¡ 
æags
)

4085 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4089 cÚ¡ 
MIB_IPFORWARDTABLE
 *
rou‹s
 = 
	`g‘_wšdows_routšg_bË
(&
gc
);

4092 cÚ¡ 
MIB_IPFORWARDROW
 *
row
 = 
	`g‘_deçuÉ_g©eway_row
(
rou‹s
);

4094 ià(
row
)

4097 cÚ¡ 
IP_ADAPTER_INFO
 *
dgi
 = 
	`g‘_ad­‹r_šfo
(
row
->
dwFÜw¬dIfIndex
, &
gc
);

4100 cÚ¡ 
IP_PER_ADAPTER_INFO
 *
·i
 = 
	`g‘_³r_ad­‹r_šfo
(
row
->
dwFÜw¬dIfIndex
, &
gc
);

4103 ià((
æags
 & 
RG_BYPASS_DHCP
è&& 
dgi
 && dgi->
DhıEÇbËd
)

4105 
	`add_ho¡_rou‹_¬¿y
(
rb
, &
dgi
->
DhıS”v”
);

4109 ià((
æags
 & 
RG_BYPASS_DNS
è&& 
·i
)

4111 
	`add_ho¡_rou‹_¬¿y
(
rb
, &
·i
->
DnsS”v”Li¡
);

4115 
	`gc_ä“
(&
gc
);

4116 
	}
}

4121 
	$g‘_by·ss_add»s£s
(
rou‹_by·ss
 *
rb
, cÚ¡ 
æags
)

4123 
	}
}

4136 #ià
defšed
(
_WIN32
)

4139 
	$‹¡_loÿl_addr
(cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
)

4141 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4142 cÚ¡ 
š_addr_t
 
nÚloÿl_Ãtmask
 = 0x80000000L;

4143 
»t
 = 
TLA_NONLOCAL
;

4146 cÚ¡ 
MIB_IPFORWARDTABLE
 *
¹
 = 
	`g‘_wšdows_routšg_bË
(&
gc
);

4147 ià(
¹
)

4149 
i
;

4150 
i
 = 0; i < 
¹
->
dwNumEÁr›s
; ++i)

4152 cÚ¡ 
MIB_IPFORWARDROW
 *
row
 = &
¹
->
bË
[
i
];

4153 cÚ¡ 
š_addr_t
 
Ãt
 = 
	`Áohl
(
row
->
dwFÜw¬dDe¡
);

4154 cÚ¡ 
š_addr_t
 
mask
 = 
	`Áohl
(
row
->
dwFÜw¬dMask
);

4155 ià(
mask
 > 
nÚloÿl_Ãtmask
 && (
addr
 & maskè=ğ
Ãt
)

4157 
»t
 = 
TLA_LOCAL
;

4163 
	`gc_ä“
(&
gc
);

4164  
»t
;

4165 
	}
}

4170 
	$‹¡_loÿl_addr
(cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
)

4172 ià(
rgi
)

4174 ià(
	`loÿl_rou‹
(
addr
, 0xFFFFFFFF, 
rgi
->
g©eway
.addr,„gi))

4176  
TLA_LOCAL
;

4180  
TLA_NONLOCAL
;

4183  
TLA_NOT_IMPLEMENTED
;

4184 
	}
}

	@route.h

28 #iâdeà
ROUTE_H


29 
	#ROUTE_H


	)

31 
	~"basic.h
"

32 
	~"tun.h
"

33 
	~"misc.h
"

35 #ifdeà
_WIN32


39 
	#ROUTE_METHOD_ADAPTIVE
 0

	)

40 
	#ROUTE_METHOD_IPAPI
 1

	)

41 
	#ROUTE_METHOD_EXE
 2

	)

42 
	#ROUTE_METHOD_SERVICE
 3

	)

43 
	#ROUTE_METHOD_MASK
 3

	)

49 
	#ROUTE_DELETE_FIRST
 (1<<2)

	)

50 
	#ROUTE_REF_GW
 (1<<3)

	)

52 
	srou‹_by·ss


54 
	#N_ROUTE_BYPASS
 8

	)

55 
	mn_by·ss
;

56 
š_addr_t
 
	mby·ss
[
N_ROUTE_BYPASS
];

59 
	srou‹_¥ecŸl_addr


62 
	#RTSA_REMOTE_ENDPOINT
 (1<<0)

	)

63 
	#RTSA_REMOTE_HOST
 (1<<1)

	)

64 
	#RTSA_DEFAULT_METRIC
 (1<<2)

	)

65 
	mæags
;

67 
š_addr_t
 
	m»mÙe_’dpošt
;

68 
š_addr_t
 
	m»mÙe_ho¡
;

69 
	m»mÙe_ho¡_loÿl
;

70 
rou‹_by·ss
 
	mby·ss
;

71 
	mdeçuÉ_m‘ric
;

74 
	srou‹_İtiÚ
 {

75 
rou‹_İtiÚ
 *
	mÃxt
;

76 cÚ¡ *
	mÃtwÜk
;

77 cÚ¡ *
	mÃtmask
;

78 cÚ¡ *
	mg©eway
;

79 cÚ¡ *
	mm‘ric
;

83 
	#RG_ENABLE
 (1<<0)

	)

84 
	#RG_LOCAL
 (1<<1)

	)

85 
	#RG_DEF1
 (1<<2)

	)

86 
	#RG_BYPASS_DHCP
 (1<<3)

	)

87 
	#RG_BYPASS_DNS
 (1<<4)

	)

88 
	#RG_REROUTE_GW
 (1<<5)

	)

89 
	#RG_AUTO_LOCAL
 (1<<6)

	)

90 
	#RG_BLOCK_LOCAL
 (1<<7)

	)

92 
	srou‹_İtiÚ_li¡
 {

93 
	mæags
;

94 
rou‹_İtiÚ
 *
	mrou‹s
;

95 
gc_¬’a
 *
	mgc
;

98 
	srou‹_v6_İtiÚ
 {

99 
rou‹_v6_İtiÚ
 *
	mÃxt
;

100 cÚ¡ *
	m´efix
;

101 cÚ¡ *
	mg©eway
;

102 cÚ¡ *
	mm‘ric
;

105 
	srou‹_v6_İtiÚ_li¡
 {

106 
	mæags
;

107 
rou‹_v6_İtiÚ
 *
	mrou‹s_v6
;

108 
gc_¬’a
 *
	mgc
;

111 
	srou‹_v4
 {

112 
	#RT_DEFINED
 (1<<0)

	)

113 
	#RT_ADDED
 (1<<1)

	)

114 
	#RT_METRIC_DEFINED
 (1<<2)

	)

115 
rou‹_v4
 *
	mÃxt
;

116 
	mæags
;

117 cÚ¡ 
rou‹_İtiÚ
 *
	mİtiÚ
;

118 
š_addr_t
 
	mÃtwÜk
;

119 
š_addr_t
 
	mÃtmask
;

120 
š_addr_t
 
	mg©eway
;

121 
	mm‘ric
;

124 
	srou‹_v6
 {

125 
rou‹_v6
 *
	mÃxt
;

126 
	mæags
;

127 
š6_addr
 
	mÃtwÜk
;

128 
	mÃtb™s
;

129 
š6_addr
 
	mg©eway
;

130 
	mm‘ric
;

132 #ifdeà
_WIN32


133 
DWORD
 
	mad­‹r_šdex
;

135 *
	miçû
;

140 
	srou‹_g©eway_add»ss
 {

141 
š_addr_t
 
	maddr
;

142 
š_addr_t
 
	mÃtmask
;

145 
	srou‹_g©eway_šfo
 {

146 
	#RGI_ADDR_DEFINED
 (1<<0è

	)

147 
	#RGI_NETMASK_DEFINED
 (1<<1è

	)

148 
	#RGI_HWADDR_DEFINED
 (1<<2è

	)

149 
	#RGI_IFACE_DEFINED
 (1<<3è

	)

150 
	#RGI_OVERFLOW
 (1<<4è

	)

151 
	#RGI_ON_LINK
 (1<<5)

	)

152 
	mæags
;

155 #ifdeà
_WIN32


156 
DWORD
 
	mad­‹r_šdex
;

158 
	miçû
[16];

162 
ušt8_t
 
	mhwaddr
[6];

165 
rou‹_g©eway_add»ss
 
	mg©eway
;

168 
	#RGI_N_ADDRESSES
 8

	)

169 
	mn_addrs
;

170 
rou‹_g©eway_add»ss
 
	maddrs
[
RGI_N_ADDRESSES
];

173 
	srou‹_v6_g©eway_add»ss
 {

174 
š6_addr
 
	maddr_v6
;

175 
	mÃtb™s_v6
;

178 
	srou‹_v6_g©eway_šfo
 {

180 
	mæags
;

183 #ifdeà
_WIN32


184 
DWORD
 
	mad­‹r_šdex
;

186 
	miçû
[16];

190 
ušt8_t
 
	mhwaddr
[6];

193 
rou‹_v6_g©eway_add»ss
 
	mg©eway
;

196 
	#RGI_N_ADDRESSES
 8

	)

197 
	mn_addrs
;

198 
rou‹_v6_g©eway_add»ss
 
	maddrs
[
RGI_N_ADDRESSES
];

201 
	srou‹_li¡
 {

202 
	#RL_DID_REDIRECT_DEFAULT_GATEWAY
 (1<<0)

	)

203 
	#RL_DID_LOCAL
 (1<<1)

	)

204 
	#RL_ROUTES_ADDED
 (1<<2)

	)

205 
	miæags
;

207 
rou‹_¥ecŸl_addr
 
	m¥ec
;

208 
rou‹_g©eway_šfo
 
	mrgi
;

209 
	mæags
;

210 
rou‹_v4
 *
	mrou‹s
;

211 
gc_¬’a
 
	mgc
;

214 
	srou‹_v6_li¡
 {

215 
	miæags
;

217 
	m¥ec_æags
;

218 
š6_addr
 
	m»mÙe_’dpošt_v6
;

219 
š6_addr
 
	m»mÙe_ho¡_v6
;

220 
	mdeçuÉ_m‘ric
;

222 
rou‹_v6_g©eway_šfo
 
	mrgi6
;

223 
	mæags
;

224 
rou‹_v6
 *
	mrou‹s_v6
;

225 
gc_¬’a
 
	mgc
;

228 #ià
P2MP


230 
	sœou‹
 {

231 
š_addr_t
 
	mÃtwÜk
;

232 
	mÃtb™s
;

233 
œou‹
 *
	mÃxt
;

236 
	sœou‹_v6
 {

237 
š6_addr
 
	mÃtwÜk
;

238 
	mÃtb™s
;

239 
œou‹_v6
 *
	mÃxt
;

243 
rou‹_İtiÚ_li¡
 *
Ãw_rou‹_İtiÚ_li¡
(
gc_¬’a
 *
a
);

245 
rou‹_v6_İtiÚ_li¡
 *
Ãw_rou‹_v6_İtiÚ_li¡
(
gc_¬’a
 *
a
);

247 
rou‹_İtiÚ_li¡
 *
şÚe_rou‹_İtiÚ_li¡
(cÚ¡ rou‹_İtiÚ_li¡ *
¤c
, 
gc_¬’a
 *
a
);

249 
rou‹_v6_İtiÚ_li¡
 *
şÚe_rou‹_v6_İtiÚ_li¡
(cÚ¡ rou‹_v6_İtiÚ_li¡ *
¤c
, 
gc_¬’a
 *
a
);

251 
cİy_rou‹_İtiÚ_li¡
(
rou‹_İtiÚ_li¡
 *
de¡
, cÚ¡ rou‹_İtiÚ_li¡ *
¤c
, 
gc_¬’a
 *
a
);

253 
cİy_rou‹_v6_İtiÚ_li¡
(
rou‹_v6_İtiÚ_li¡
 *
de¡
,

254 cÚ¡ 
rou‹_v6_İtiÚ_li¡
 *
¤c
,

255 
gc_¬’a
 *
a
);

257 
rou‹_v6_ş—r_ho¡_b™s
Ğ
rou‹_v6
 *
r6
 );

259 
add_rou‹_v6
(
rou‹_v6
 *
r
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
);

261 
d–‘e_rou‹_v6
(cÚ¡ 
rou‹_v6
 *
r
, cÚ¡ 
tuÁ­
 *
‰
, 
æags
, cÚ¡ 
’v_£t
 *
es
);

263 
add_rou‹
(
rou‹_v4
 *
r
,

264 cÚ¡ 
tuÁ­
 *
‰
,

265 
æags
,

266 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

267 cÚ¡ 
’v_£t
 *
es
);

269 
add_rou‹_to_İtiÚ_li¡
(
rou‹_İtiÚ_li¡
 *
l
,

270 cÚ¡ *
ÃtwÜk
,

271 cÚ¡ *
Ãtmask
,

272 cÚ¡ *
g©eway
,

273 cÚ¡ *
m‘ric
);

275 
add_rou‹_v6_to_İtiÚ_li¡
(
rou‹_v6_İtiÚ_li¡
 *
l
,

276 cÚ¡ *
´efix
,

277 cÚ¡ *
g©eway
,

278 cÚ¡ *
m‘ric
);

280 
boŞ
 
š™_rou‹_li¡
(
rou‹_li¡
 *
¾
,

281 cÚ¡ 
rou‹_İtiÚ_li¡
 *
İt
,

282 cÚ¡ *
»mÙe_’dpošt
,

283 
deçuÉ_m‘ric
,

284 
š_addr_t
 
»mÙe_ho¡
,

285 
’v_£t
 *
es
);

287 
boŞ
 
š™_rou‹_v6_li¡
(
rou‹_v6_li¡
 *
¾6
,

288 cÚ¡ 
rou‹_v6_İtiÚ_li¡
 *
İt6
,

289 cÚ¡ *
»mÙe_’dpošt
,

290 
deçuÉ_m‘ric
,

291 cÚ¡ 
š6_addr
 *
»mÙe_ho¡
,

292 
’v_£t
 *
es
);

294 
rou‹_li¡_add_v²_g©eway
(
rou‹_li¡
 *
¾
,

295 
’v_£t
 *
es
,

296 cÚ¡ 
š_addr_t
 
addr
);

298 
add_rou‹s
(
rou‹_li¡
 *
¾
,

299 
rou‹_v6_li¡
 *
¾6
,

300 cÚ¡ 
tuÁ­
 *
‰
,

301 
æags
,

302 cÚ¡ 
’v_£t
 *
es
);

304 
d–‘e_rou‹s
(
rou‹_li¡
 *
¾
,

305 
rou‹_v6_li¡
 *
¾6
,

306 cÚ¡ 
tuÁ­
 *
‰
,

307 
æags
,

308 cÚ¡ 
’v_£t
 *
es
);

310 
£‹nv_rou‹s
(
’v_£t
 *
es
, cÚ¡ 
rou‹_li¡
 *
¾
);

312 
£‹nv_rou‹s_v6
(
’v_£t
 *
es
, cÚ¡ 
rou‹_v6_li¡
 *
¾6
);

316 
boŞ
 
is_¥ecŸl_addr
(cÚ¡ *
addr_¡r
);

318 
g‘_deçuÉ_g©eway
(
rou‹_g©eway_šfo
 *
rgi
);

320 
g‘_deçuÉ_g©eway_v6
(
rou‹_v6_g©eway_šfo
 *
rgi
,

321 cÚ¡ 
š6_addr
 *
de¡
);

323 
´št_deçuÉ_g©eway
(cÚ¡ 
msgËv–
,

324 cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
,

325 cÚ¡ 
rou‹_v6_g©eway_šfo
 *
rgi6
);

333 
	#TLA_NOT_IMPLEMENTED
 0

	)

334 
	#TLA_NONLOCAL
 1

	)

335 
	#TLA_LOCAL
 2

	)

336 
‹¡_loÿl_addr
(cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
rou‹_g©eway_šfo
 *
rgi
);

338 #iâdeà
ENABLE_SMALL


339 
´št_rou‹_İtiÚs
(cÚ¡ 
rou‹_İtiÚ_li¡
 *
rŞ
,

340 
Ëv–
);

344 
´št_rou‹s
(cÚ¡ 
rou‹_li¡
 *
¾
, 
Ëv–
);

346 #ifdeà
_WIN32


348 
show_rou‹s
(
msgËv
);

350 
boŞ
 
‹¡_rou‹s
(cÚ¡ 
rou‹_li¡
 *
¾
, cÚ¡ 
tuÁ­
 *
‰
);

352 
boŞ
 
add_rou‹_­i
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
, 
DWORD
 
ad­‹r_šdex
);

354 
boŞ
 
d–_rou‹_­i
(cÚ¡ 
rou‹_v4
 *
r
, cÚ¡ 
tuÁ­
 *
‰
);

357 
šlše
 
boŞ


358 
	$‹¡_rou‹s
(cÚ¡ 
rou‹_li¡
 *
¾
, cÚ¡ 
tuÁ­
 *
‰
)

360  
Œue
;

361 
	}
}

364 
boŞ
 
Ãtmask_to_Ãtb™s
(cÚ¡ 
š_addr_t
 
ÃtwÜk
, cÚ¡ in_addr_ˆ
Ãtmask
, *
Ãtb™s
);

366 
Ãtmask_to_Ãtb™s2
(
š_addr_t
 
Ãtmask
);

368 
šlše
 
š_addr_t


369 
	$Ãtb™s_to_Ãtmask
(cÚ¡ 
Ãtb™s
)

371 cÚ¡ 
add¾’
 = (
š_addr_t
) * 8;

372 
š_addr_t
 
mask
 = 0;

373 ià(
Ãtb™s
 > 0 &&‚‘b™ <ğ
add¾’
)

375 
mask
 = 
IPV4_NETMASK_HOST
 << (
add¾’
-
Ãtb™s
);

377  
mask
;

378 
	}
}

380 
šlše
 
boŞ


381 
	$rou‹_li¡_v²_g©eway_Ãeded
(cÚ¡ 
rou‹_li¡
 *
¾
)

383 ià(!
¾
)

385  
çl£
;

389  !(
¾
->
¥ec
.
æags
 & 
RTSA_REMOTE_ENDPOINT
);

391 
	}
}

393 
šlše
 

394 
	$rou‹_did_»dœeù_deçuÉ_g©eway
(cÚ¡ 
rou‹_li¡
 *
¾
)

396  
¾
 && 
	`BOOL_CAST
Ôl->
iæags
 & 
RL_DID_REDIRECT_DEFAULT_GATEWAY
);

397 
	}
}

	@schedule.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ià
P2MP_SERVER


34 
	~"bufãr.h
"

35 
	~"misc.h
"

36 
	~"üy±o.h
"

37 
	~"scheduË.h
"

39 
	~"memdbg.h
"

41 #ifdeà
SCHEDULE_TEST


43 
	s¡©us


45 
	m¤u
;

46 
	mšs
;

47 
	mcŞl
;

48 
	ml¡•s
;

51 
¡©us
 
	gz
;

55 #ifdeà
ENABLE_DEBUG


57 
	$scheduË_’Œy_debug_šfo
(cÚ¡ *
ÿÎ”
, cÚ¡ 
scheduË_’Œy
 *
e
)

59 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

60 ià(
e
)

62 
	`dmsg
(
D_SCHEDULER
, "SCHEDULE: %s wakeup=[%s]…ri=%u",

63 
ÿÎ”
,

64 
	`tv_¡ršg_abs
(&
e
->
tv
, &
gc
),

65 
e
->
´i
);

69 
	`dmsg
(
D_SCHEDULER
, "SCHEDULE: %s NULL",

70 
ÿÎ”
);

72 
	`gc_ä“
(&
gc
);

73 
	}
}

76 
šlše
 

77 
	$scheduË_£t_´i
(
scheduË_’Œy
 *
e
)

79 
e
->
´i
 = 
	`¿ndom
();

80 ià(
e
->
´i
 < 1)

82 
e
->
´i
 = 1;

84 
	}
}

91 
šlše
 

92 
	$scheduË_’Œy_com·»
(cÚ¡ 
scheduË_’Œy
 *
e1
,

93 cÚ¡ 
scheduË_’Œy
 *
e2
)

95 ià(
e1
->
tv
.
tv_£c
 < 
e2
->tv.tv_sec)

99 ià(
e1
->
tv
.
tv_£c
 > 
e2
->tv.tv_sec)

105 ià(
e1
->
tv
.
tv_u£c
 < 
e2
->tv.tv_usec)

109 ià(
e1
->
tv
.
tv_u£c
 > 
e2
->tv.tv_usec)

115 ià(
e1
->
´i
 < 
e2
->pri)

119 ià(
e1
->
´i
 > 
e2
->pri)

129 
	}
}

134 
šlše
 

135 
	$scheduË_d‘ach_·»Á
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

137 ià(
e
)

139 ià(
e
->
·»Á
)

141 ià(
e
->
·»Á
->
É
 ==ƒ)

143 
e
->
·»Á
->
É
 = 
NULL
;

145 ià(
e
->
·»Á
->
gt
 ==ƒ)

147 
e
->
·»Á
->
gt
 = 
NULL
;

152 
	`ASSERT
(0);

154 
e
->
·»Á
 = 
NULL
;

158 ià(
s
->
roÙ
 =ğ
e
)

160 
s
->
roÙ
 = 
NULL
;

164 
	}
}

178 
	$scheduË_rÙ©e_up
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

180 ià(
e
 &&ƒ->
·»Á
)

182 
scheduË_’Œy
 *
É
 = 
e
->lt;

183 
scheduË_’Œy
 *
gt
 = 
e
->gt;

184 
scheduË_’Œy
 *
p
 = 
e
->
·»Á
;

185 
scheduË_’Œy
 *
gp
 = 
p
->
·»Á
;

187 ià(
gp
)

189 ià(
gp
->
gt
 =ğ
p
)

191 
gp
->
gt
 = 
e
;

193 ià(
gp
->
É
 =ğ
p
)

195 
gp
->
É
 = 
e
;

199 
	`ASSERT
(0);

204 
s
->
roÙ
 = 
e
;

208 
e
->
·»Á
 = 
gp
;

211 
p
->
·»Á
 = 
e
;

215 ià(
p
->
gt
 =ğ
e
)

217 
e
->
É
 = 
p
;

218 
p
->
gt
 = 
É
;

219 ià(
É
)

221 
É
->
·»Á
 = 
p
;

224 ià(
p
->
É
 =ğ
e
)

226 
e
->
gt
 = 
p
;

227 
p
->
É
 = 
gt
;

228 ià(
gt
)

230 
gt
->
·»Á
 = 
p
;

236 
	`ASSERT
(0);

239 #ifdeà
SCHEDULE_TEST


240 ++
z
.
¤u
;

243 
	}
}

252 
	$scheduË_»move_node
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

254 
e
->
É
 ||ƒ->
gt
)

256 ià(
e
->
É
)

258 ià(
e
->
gt
)

260 ià(
e
->
É
->
´i
 <ƒ->
gt
->pri)

262 
	`scheduË_rÙ©e_up
(
s
, 
e
->
É
);

266 
	`scheduË_rÙ©e_up
(
s
, 
e
->
gt
);

271 
	`scheduË_rÙ©e_up
(
s
, 
e
->
É
);

274 ià(
e
->
gt
)

276 
	`scheduË_rÙ©e_up
(
s
, 
e
->
gt
);

280 
	`scheduË_d‘ach_·»Á
(
s
, 
e
);

281 
e
->
´i
 = 0;

282 
	}
}

289 
	$scheduË_š£¹
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

291 
scheduË_’Œy
 *
c
 = 
s
->
roÙ
;

292 
Œue
)

294 cÚ¡ 
comp
 = 
	`scheduË_’Œy_com·»
(
e
, 
c
);

296 #ifdeà
SCHEDULE_TEST


297 ++
z
.
šs
;

300 ià(
comp
 == -1)

302 ià(
c
->
É
)

304 
c
 = c->
É
;

309 
c
->
É
 = 
e
;

310 
e
->
·»Á
 = 
c
;

314 ià(
comp
 == 1)

316 ià(
c
->
gt
)

318 
c
 = c->
gt
;

323 
c
->
gt
 = 
e
;

324 
e
->
·»Á
 = 
c
;

332 #ifdeà
SCHEDULE_TEST


333 ++
z
.
cŞl
;

335 
	`scheduË_£t_´i
(
e
);

337 
c
 = 
s
->
roÙ
;

341 
	}
}

348 
	$scheduË_add_modify
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

350 #ifdeà
ENABLE_DEBUG


351 ià(
	`check_debug_Ëv–
(
D_SCHEDULER
))

353 
	`scheduË_’Œy_debug_šfo
("scheduË_add_modify", 
e
);

358 ià(
	`IN_TREE
(
e
))

360 
	`scheduË_»move_node
(
s
, 
e
);

364 
	`scheduË_£t_´i
(
e
);

366 ià(
s
->
roÙ
)

368 
	`scheduË_š£¹
(
s
, 
e
);

372 
s
->
roÙ
 = 
e
;

378 
e
->
·»Á
 &&ƒ->·»Á->
´i
 >ƒ->pri)

380 
	`scheduË_rÙ©e_up
(
s
, 
e
);

382 
	}
}

387 
scheduË_’Œy
 *

388 
	$scheduË_fšd_Ëa¡
(
scheduË_’Œy
 *
e
)

390 ià(
e
)

392 
e
->
É
)

394 #ifdeà
SCHEDULE_TEST


395 ++
z
.
l¡•s
;

397 
e
 =ƒ->
É
;

401 #ifdeà
ENABLE_DEBUG


402 ià(
	`check_debug_Ëv–
(
D_SCHEDULER
))

404 
	`scheduË_’Œy_debug_šfo
("scheduË_fšd_Ëa¡", 
e
);

408  
e
;

409 
	}
}

415 
scheduË
 *

416 
	$scheduË_š™
()

418 
scheduË
 *
s
;

420 
	`ALLOC_OBJ_CLEAR
(
s
, 
scheduË
);

421  
s
;

422 
	}
}

425 
	$scheduË_ä“
(
scheduË
 *
s
)

427 
	`ä“
(
s
);

428 
	}
}

431 
	$scheduË_»move_’Œy
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
)

433 
s
->
—¾›¡_wakeup
 = 
NULL
;

434 
	`scheduË_»move_node
(
s
, 
e
);

435 
	}
}

441 #ifdeà
SCHEDULE_TEST


443 
šlše
 
scheduË_’Œy
 *

444 
	$scheduË_fšd_—¾›¡_wakeup
(
scheduË
 *
s
)

446  
	`scheduË_fšd_Ëa¡
(
s
->
roÙ
);

447 
	}
}

454 
	$scheduË_debug_’Œy
(cÚ¡ 
scheduË_’Œy
 *
e
,

455 
d•th
,

456 *
couÁ
,

457 
timev®
 *
Ëa¡
,

458 cÚ¡ 
timev®
 *
mš
,

459 cÚ¡ 
timev®
 *
max
)

461 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

462 
maxd•th
 = 
d•th
;

463 ià(
e
)

465 
d
;

467 
	`ASSERT
(
e
 !ğe->
É
);

468 
	`ASSERT
(
e
 !ğe->
gt
);

469 
	`ASSERT
(
e
 !ğe->
·»Á
);

470 
	`ASSERT
(!
e
->
·»Á
 ||ƒ->·»Á !ğe->
É
);

471 
	`ASSERT
(!
e
->
·»Á
 ||ƒ->·»Á !ğe->
gt
);

472 
	`ASSERT
(!
e
->
É
 ||ƒ->É !ğe->
gt
);

474 ià(
e
->
É
)

476 
	`ASSERT
(
e
->
É
->
·»Á
 ==ƒ);

477 
	`ASSERT
(
	`scheduË_’Œy_com·»
(
e
->
É
,ƒ) == -1);

478 
	`ASSERT
(
e
->
É
->
´i
 >=ƒ->pri);

481 ià(
e
->
gt
)

483 
	`ASSERT
(
e
->
gt
->
·»Á
 ==ƒ);

484 
	`ASSERT
(
	`scheduË_’Œy_com·»
(
e
->
gt
,ƒ));

485 
	`ASSERT
(
e
->
gt
->
´i
 >=ƒ->pri);

488 
	`ASSERT
(
	`tv_Ë
(
mš
, &
e
->
tv
));

489 
	`ASSERT
(
	`tv_Ë
(&
e
->
tv
, 
max
));

491 ià(
couÁ
)

493 ++(*
couÁ
);

496 ià(
Ëa¡
 && 
	`tv_É
(&
e
->
tv
,†east))

498 *
Ëa¡
 = 
e
->
tv
;

501 
d
 = 
	`scheduË_debug_’Œy
(
e
->
É
, 
d•th
+1, 
couÁ
, 
Ëa¡
, 
mš
, &e->
tv
);

502 ià(
d
 > 
maxd•th
)

504 
maxd•th
 = 
d
;

507 
d
 = 
	`scheduË_debug_’Œy
(
e
->
gt
, 
d•th
+1, 
couÁ
, 
Ëa¡
, &e->
tv
, 
max
);

508 ià(
d
 > 
maxd•th
)

510 
maxd•th
 = 
d
;

513 
	`gc_ä“
(&
gc
);

514  
maxd•th
;

515 
	}
}

518 
	$scheduË_debug
(
scheduË
 *
s
, *
couÁ
, 
timev®
 *
Ëa¡
)

520 
timev®
 
mš
;

521 
timev®
 
max
;

523 
mš
.
tv_£c
 = 0;

524 
mš
.
tv_u£c
 = 0;

525 
max
.
tv_£c
 = 0x7FFFFFFF;

526 
max
.
tv_u£c
 = 0x7FFFFFFF;

528 ià(
s
->
roÙ
)

530 
	`ASSERT
(
s
->
roÙ
->
·»Á
 =ğ
NULL
);

532  
	`scheduË_debug_’Œy
(
s
->
roÙ
, 0, 
couÁ
, 
Ëa¡
, &
mš
, &
max
);

533 
	}
}

538 
	$tv_¿ndomize
(
timev®
 *
tv
)

540 
tv
->
tv_£c
 +ğ
	`¿ndom
() % 100;

541 
tv
->
tv_u£c
 = 
	`¿ndom
() % 100;

542 
	}
}

547 
	$tv_¿ndomize
(
timev®
 *
tv
)

549 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

550 
choiû
 = 
	`g‘_¿ndom
();

551 ià((
choiû
 & 0xFF) == 0)

553 
tv
->
tv_u£c
 +ğ((
choiû
 >> 8) & 0xFF);

557 
	`´ng_by‹s
((
ušt8_t
 *)
tv
, (
timev®
));

559 
	`gc_ä“
(&
gc
);

560 
	}
}

565 
	$scheduË_v”ify
(
scheduË
 *
s
)

567 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

568 
timev®
 
Ëa¡
;

569 
couÁ
;

570 
maxËv
;

571 
scheduË_’Œy
 *
e
;

572 cÚ¡ 
¡©us
 
zz
 = 
z
;

574 
Ëa¡
.
tv_£c
 =†—¡.
tv_u£c
 = 0x7FFFFFFF;

576 
couÁ
 = 0;

578 
maxËv
 = 
	`scheduË_debug
(
s
, &
couÁ
, &
Ëa¡
);

580 
e
 = 
	`scheduË_fšd_—¾›¡_wakeup
(
s
);

582 ià(
e
)

584 
	`´štf
("Verification Phase count=%d maxlev=%d sru=%d ins=%d coll=%d†s=%d†=%s",

585 
couÁ
,

586 
maxËv
,

587 
zz
.
¤u
,

588 
zz
.
šs
,

589 
zz
.
cŞl
,

590 
zz
.
l¡•s
,

591 
	`tv_¡ršg
(&
e
->
tv
, &
gc
));

593 ià(!
	`tv_eq
(&
Ëa¡
, &
e
->
tv
))

595 
	`´štf
(" [COMPUTED DIFFERENT MIN VALUES!]");

598 
	`´štf
("\n");

601 
	`CLEAR
(
z
);

602 
	`gc_ä“
(&
gc
);

603 
	}
}

606 
	$scheduË_¿ndomize_¬¿y
(
scheduË_’Œy
 **
¬¿y
, 
size
)

608 
i
;

609 
i
 = 0; i < 
size
; ++i)

611 cÚ¡ 
¤c
 = 
	`g‘_¿ndom
(è% 
size
;

612 
scheduË_’Œy
 *
tmp
 = 
¬¿y
 [
i
];

613 ià(
i
 !ğ
¤c
)

615 
¬¿y
 [
i
] =‡¼ay [
¤c
];

616 
¬¿y
 [
¤c
] = 
tmp
;

619 
	}
}

622 
	$scheduË_´št_wÜk
(
scheduË_’Œy
 *
e
, 
šd’t
)

624 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

625 
i
;

626 
i
 = 0; i < 
šd’t
; ++i)

628 
	`´štf
(" ");

630 ià(
e
)

632 
	`´štf
("% [%u]ƒ=" 
±r_fÜm©
 ",…="…tr_format "†t="…tr_format " gt="…tr_format "\n",

633 
	`tv_¡ršg
(&
e
->
tv
, &
gc
),

634 
e
->
´i
,

635 (
±r_ty³
)
e
,

636 (
±r_ty³
)
e
->
·»Á
,

637 (
±r_ty³
)
e
->
É
,

638 (
±r_ty³
)
e
->
gt
);

639 
	`scheduË_´št_wÜk
(
e
->
É
, 
šd’t
+1);

640 
	`scheduË_´št_wÜk
(
e
->
gt
, 
šd’t
+1);

644 
	`´štf
("NULL\n");

646 
	`gc_ä“
(&
gc
);

647 
	}
}

650 
	$scheduË_´št
(
scheduË
 *
s
)

652 
	`´štf
("*************************\n");

653 
	`scheduË_´št_wÜk
(
s
->
roÙ
, 0);

654 
	}
}

657 
	$scheduË_‹¡
()

659 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

660 
n
 = 1000;

661 
n_mod
 = 25;

663 
i
, 
j
;

664 
scheduË_’Œy
 **
¬¿y
;

665 
scheduË
 *
s
 = 
	`scheduË_š™
();

666 
scheduË_’Œy
 *
e
;

668 
	`CLEAR
(
z
);

669 
	`ALLOC_ARRAY
(
¬¿y
, 
scheduË_’Œy
 *, 
n
);

671 
	`´štf
("Creation/Insertion Phase\n");

673 
i
 = 0; i < 
n
; ++i)

675 
	`ALLOC_OBJ_CLEAR
(
¬¿y
[
i
], 
scheduË_’Œy
);

676 
	`tv_¿ndomize
(&
¬¿y
[
i
]->
tv
);

679 
	`scheduË_add_modify
(
s
, 
¬¿y
[
i
]);

682 
	`scheduË_¿ndomize_¬¿y
(
¬¿y
, 
n
);

685 
	`scheduË_v”ify
(
s
);

687 
j
 = 1; j <ğ
n_mod
; ++j)

689 
	`´štf
("ModifiÿtiÚ Pha£ Pas %d\n", 
j
);

691 
i
 = 0; i < 
n
; ++i)

693 
e
 = 
	`scheduË_fšd_—¾›¡_wakeup
(
s
);

695 
	`tv_¿ndomize
(&
e
->
tv
);

697 
	`scheduË_add_modify
(
s
, 
e
);

701 
	`scheduË_v”ify
(
s
);

707 (
e
 = 
	`scheduË_fšd_—¾›¡_wakeup
(
s
)))

709 
	`scheduË_»move_node
(
s
, 
e
);

712 
	`scheduË_v”ify
(
s
);

714 
	`´štf
("S->ROOT i %s\n", 
s
->
roÙ
 ? "NOT NULL" : "NULL");

716 
i
 = 0; i < 
n
; ++i)

718 
	`ä“
(
¬¿y
[
i
]);

720 
	`ä“
(
¬¿y
);

721 
	`ä“
(
s
);

722 
	`gc_ä“
(&
gc
);

723 
	}
}

	@schedule.h

24 #iâdeà
SCHEDULE_H


25 
	#SCHEDULE_H


	)

38 #ià
P2MP_SERVER


43 
	~"Ùime.h
"

44 
	~"”rÜ.h
"

46 
	sscheduË_’Œy


48 
timev®
 
	mtv
;

49 
	m´i
;

50 
scheduË_’Œy
 *
	m·»Á
;

51 
scheduË_’Œy
 *
	mÉ
;

52 
scheduË_’Œy
 *
	mgt
;

55 
	sscheduË


57 
scheduË_’Œy
 *
	m—¾›¡_wakeup
;

58 
scheduË_’Œy
 *
	mroÙ
;

63 
scheduË
 *
scheduË_š™
();

65 
scheduË_ä“
(
scheduË
 *
s
);

67 
scheduË_»move_’Œy
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
);

69 #ifdeà
SCHEDULE_TEST


70 
scheduË_‹¡
();

77 
	#IN_TREE
(
e
è(Ó)->
´i
)

	)

79 
scheduË_’Œy
 *
scheduË_fšd_Ëa¡
(scheduË_’Œy *
e
);

81 
scheduË_add_modify
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
);

83 
scheduË_»move_node
(
scheduË
 *
s
, 
scheduË_’Œy
 *
e
);

99 
šlše
 

100 
	$scheduË_add_’Œy
(
scheduË
 *
s
,

101 
scheduË_’Œy
 *
e
,

102 cÚ¡ 
timev®
 *
tv
,

103 
sigma
)

105 ià(!
	`IN_TREE
(
e
è|| !
sigma
 || !
	`tv_w™hš_sigma
(
tv
, &e->tv, sigma))

107 
e
->
tv
 = *tv;

108 
	`scheduË_add_modify
(
s
, 
e
);

109 
s
->
—¾›¡_wakeup
 = 
NULL
;

111 
	}
}

119 
šlše
 
scheduË_’Œy
 *

120 
	$scheduË_g‘_—¾›¡_wakeup
(
scheduË
 *
s
,

121 
timev®
 *
wakeup
)

123 
scheduË_’Œy
 *
»t
;

126 ià(!
s
->
—¾›¡_wakeup
)

128 
s
->
—¾›¡_wakeup
 = 
	`scheduË_fšd_Ëa¡
(s->
roÙ
);

130 
»t
 = 
s
->
—¾›¡_wakeup
;

131 ià(
»t
)

133 *
wakeup
 = 
»t
->
tv
;

136  
»t
;

137 
	}
}

	@session_id.c

33 #ifdeà
HAVE_CONFIG_H


34 
	~"cÚfig.h
"

35 #–ià
defšed
(
_MSC_VER
)

36 
	~"cÚfig-msvc.h
"

39 
	~"sysh—d.h
"

41 #ifdeà
ENABLE_CRYPTO


43 
	~"”rÜ.h
"

44 
	~"commÚ.h
"

45 
	~"üy±o.h
"

46 
	~"£ssiÚ_id.h
"

48 
	~"memdbg.h
"

50 cÚ¡ 
£ssiÚ_id
 
	gx_£ssiÚ_id_z”o
;

53 
	$£ssiÚ_id_¿ndom
(
£ssiÚ_id
 *
sid
)

55 
	`´ng_by‹s
(
sid
->
id
, 
SID_SIZE
);

56 
	}
}

59 
	$£ssiÚ_id_´št
(cÚ¡ 
£ssiÚ_id
 *
sid
, 
gc_¬’a
 *
gc
)

61  
	`fÜm©_hex
(
sid
->
id
, 
SID_SIZE
, 0, 
gc
);

62 
	}
}

66 
	$dummy
()

68 
	}
}

	@session_id.h

32 #ifdeà
ENABLE_CRYPTO


34 #iâdeà
SESSION_ID_H


35 
	#SESSION_ID_H


	)

37 
	~"basic.h
"

38 
	~"bufãr.h
"

40 
	s£ssiÚ_id


42 
ušt8_t
 
	mid
[8];

45 cÚ¡ 
£ssiÚ_id
 
x_£ssiÚ_id_z”o
;

47 
	#SID_SIZE
 ((
x_£ssiÚ_id_z”o
.
id
))

	)

49 
šlše
 
boŞ


50 
	$£ssiÚ_id_equ®
(cÚ¡ 
£ssiÚ_id
 *
sid1
,

51 cÚ¡ 
£ssiÚ_id
 *
sid2
)

53  !
	`memcmp
(
sid1
->
id
, 
sid2
->id, 
SID_SIZE
);

54 
	}
}

56 
šlše
 
boŞ


57 
	$£ssiÚ_id_defšed
(cÚ¡ 
£ssiÚ_id
 *
sid1
)

59  
	`memcmp
(
sid1
->
id
, &
x_£ssiÚ_id_z”o
.id, 
SID_SIZE
) != 0;

60 
	}
}

62 
šlše
 
boŞ


63 
	$£ssiÚ_id_»ad
(
£ssiÚ_id
 *
sid
, 
bufãr
 *
buf
)

65  
	`buf_»ad
(
buf
, 
sid
->
id
, 
SID_SIZE
);

66 
	}
}

68 
šlše
 
boŞ


69 
	$£ssiÚ_id_wr™e_´•’d
(cÚ¡ 
£ssiÚ_id
 *
sid
, 
bufãr
 *
buf
)

71  
	`buf_wr™e_´•’d
(
buf
, 
sid
->
id
, 
SID_SIZE
);

72 
	}
}

74 
šlše
 
boŞ


75 
	$£ssiÚ_id_wr™e
(cÚ¡ 
£ssiÚ_id
 *
sid
, 
bufãr
 *
buf
)

77  
	`buf_wr™e
(
buf
, 
sid
->
id
, 
SID_SIZE
);

78 
	}
}

80 
£ssiÚ_id_¿ndom
(
£ssiÚ_id
 *
sid
);

82 cÚ¡ *
£ssiÚ_id_´št
(cÚ¡ 
£ssiÚ_id
 *
sid
, 
gc_¬’a
 *
gc
);

	@shaper.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

31 
	~"sh­”.h
"

32 
	~"memdbg.h
"

34 #ifdeà
ENABLE_FEATURE_SHAPER


40 
boŞ


41 
	$sh­”_soÚe¡_ev’t
(
timev®
 *
tv
, 
d–ay
)

43 
boŞ
 
»t
 = 
çl£
;

44 ià(
d–ay
 < 1000000)

46 ià(
tv
->
tv_£c
)

48 
tv
->
tv_£c
 = 0;

49 
tv
->
tv_u£c
 = 
d–ay
;

50 
»t
 = 
Œue
;

52 ià(
d–ay
 < 
tv
->
tv_u£c
)

54 
tv
->
tv_u£c
 = 
d–ay
;

55 
»t
 = 
Œue
;

60 cÚ¡ 
£c
 = 
d–ay
 / 1000000;

61 cÚ¡ 
u£c
 = 
d–ay
 % 1000000;

63 ià(
£c
 < 
tv
->
tv_£c
)

65 
tv
->
tv_£c
 = 
£c
;

66 
tv
->
tv_u£c
 = 
u£c
;

67 
»t
 = 
Œue
;

69 ià(
£c
 =ğ
tv
->
tv_£c
)

71 ià(
u£c
 < 
tv
->
tv_u£c
)

73 
tv
->
tv_u£c
 = 
u£c
;

74 
»t
 = 
Œue
;

78 #ifdeà
SHAPER_DEBUG


79 
	`dmsg
(
D_SHAPER_DEBUG
, "SHAPER shaper_soonest_event sec=%d usec=%d„et=%d",

80 ()
tv
->
tv_£c
, (év->
tv_u£c
, ()
»t
);

82  
»t
;

83 
	}
}

86 
	$sh­”_»£t_wakeup
(
sh­”
 *
s
)

88 
	`CLEAR
(
s
->
wakeup
);

89 
	}
}

92 
	$sh­”_msg
(
sh­”
 *
s
)

94 
	`msg
(
M_INFO
, "Output Traffic Shaping initialized‡t %d bytes…er second",

95 
s
->
by‹s_³r_£cÚd
);

96 
	}
}

100 
	$dummy
()

102 
	}
}

	@shaper.h

24 #iâdeà
SHAPER_H


25 
	#SHAPER_H


	)

29 #ifdeà
ENABLE_FEATURE_SHAPER


31 
	~"basic.h
"

32 
	~"š‹g”.h
"

33 
	~"misc.h
"

34 
	~"”rÜ.h
"

35 
	~"š‹rv®.h
"

42 
	#SHAPER_MIN
 100

	)

43 
	#SHAPER_MAX
 100000000

	)

45 
	#SHAPER_MAX_TIMEOUT
 10

	)

47 
	#SHAPER_USE_FP


	)

49 
	ssh­”


51 
	mby‹s_³r_£cÚd
;

52 
timev®
 
	mwakeup
;

54 #ifdeà
SHAPER_USE_FP


55 
	mçùÜ
;

57 
	mçùÜ
;

61 
sh­”_msg
(
sh­”
 *
s
);

63 
sh­”_»£t_wakeup
(
sh­”
 *
s
);

69 
boŞ
 
sh­”_soÚe¡_ev’t
(
timev®
 *
tv
, 
d–ay
);

75 
šlše
 

76 
	$sh­”_»£t
(
sh­”
 *
s
, 
by‹s_³r_£cÚd
)

78 
s
->
by‹s_³r_£cÚd
 = 
	`cÚ¡¿š_št
(by‹s_³r_£cÚd, 
SHAPER_MIN
, 
SHAPER_MAX
);

80 #ifdeà
SHAPER_USE_FP


81 
s
->
çùÜ
 = 1000000.0 / ()s->
by‹s_³r_£cÚd
;

83 
s
->
çùÜ
 = 1000000 / s->
by‹s_³r_£cÚd
;

85 
	}
}

87 
šlše
 

88 
	$sh­”_š™
(
sh­”
 *
s
, 
by‹s_³r_£cÚd
)

90 
	`sh­”_»£t
(
s
, 
by‹s_³r_£cÚd
);

91 
	`sh­”_»£t_wakeup
(
s
);

92 
	}
}

94 
šlše
 

95 
	$sh­”_cu¼’t_bªdwidth
(
sh­”
 *
s
)

97  
s
->
by‹s_³r_£cÚd
;

98 
	}
}

104 
šlše
 

105 
	$sh­”_d–ay
(
sh­”
 *
s
)

107 
timev®
 
tv
;

108 
d–ay
 = 0;

110 ià(
	`tv_defšed
(&
s
->
wakeup
))

112 
	`ASSERT
(!
	`İ’v²_g‘timeofday
(&
tv
, 
NULL
));

113 
d–ay
 = 
	`tv_subŒaù
(&
s
->
wakeup
, &
tv
, 
SHAPER_MAX_TIMEOUT
);

114 #ifdeà
SHAPER_DEBUG


115 
	`dmsg
(
D_SHAPER_DEBUG
, "SHAPER sh­”_d–ay d–ay=%d", 
d–ay
);

119  
d–ay
 > 0 ? delay : 0;

120 
	}
}

129 
šlše
 

130 
	$sh­”_wrÙe_by‹s
(
sh­”
 *
s
, 
nby‹s
)

132 
timev®
 
tv
;

135 
tv
.
tv_£c
 = 0;

136 #ifdeà
SHAPER_USE_FP


137 
tv
.
tv_u£c
 = 
	`mš_št
(()(()
	`max_št
(
nby‹s
, 100è* 
s
->
çùÜ
), (
SHAPER_MAX_TIMEOUT
*1000000));

139 
tv
.
tv_u£c
 = 
s
->
by‹s_³r_£cÚd


140 ? 
	`mš_št
(
	`max_št
(
nby‹s
, 100è* 
s
->
çùÜ
, (
SHAPER_MAX_TIMEOUT
*1000000))

144 ià(
tv
.
tv_u£c
)

146 
	`ASSERT
(!
	`İ’v²_g‘timeofday
(&
s
->
wakeup
, 
NULL
));

147 
	`tv_add
(&
s
->
wakeup
, &
tv
);

149 #ifdeà
SHAPER_DEBUG


150 
	`dmsg
(
D_SHAPER_DEBUG
, "SHAPER shaper_wrote_bytes bytes=%d delay=%d sec=%d usec=%d",

151 
nby‹s
,

152 ()
tv
.
tv_u£c
,

153 ()
s
->
wakeup
.
tv_£c
,

154 ()
s
->
wakeup
.
tv_u£c
);

157 
	}
}

165 
šlše
 
boŞ


166 
	$sh­”_chªge_pù
(
sh­”
 *
s
, 
pù
)

168 cÚ¡ 
Üig_bªdwidth
 = 
s
->
by‹s_³r_£cÚd
;

169 cÚ¡ 
Ãw_bªdwidth
 = 
Üig_bªdwidth
 + (Üig_bªdwidth * 
pù
 / 100);

170 
	`ASSERT
(
s
->
by‹s_³r_£cÚd
);

171 
	`sh­”_»£t
(
s
, 
Ãw_bªdwidth
);

172  
s
->
by‹s_³r_£cÚd
 !ğ
Üig_bªdwidth
;

173 
	}
}

	@sig.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"bufãr.h
"

33 
	~"”rÜ.h
"

34 
	~"wš32.h
"

35 
	~"š™.h
"

36 
	~"¡©us.h
"

37 
	~"sig.h
"

38 
	~"occ.h
"

39 
	~"mªage.h
"

40 
	~"İ’v².h
"

42 
	~"memdbg.h
"

46 
sigÇl_šfo
 
	gsigšfo_¡©ic
;

48 
	ssigÇme
 {

49 
	mv®ue
;

50 cÚ¡ *
	muµ”
;

51 cÚ¡ *
	mlow”
;

54 cÚ¡ 
sigÇme
 
	gsigÇmes
[] = {

55 { 
SIGINT
, "SIGINT", "sigint"},

56 { 
SIGTERM
, "SIGTERM", "sigterm" },

57 { 
SIGHUP
, "SIGHUP", "sighup" },

58 { 
SIGUSR1
, "SIGUSR1", "sigusr1" },

59 { 
SIGUSR2
, "SIGUSR2", "sigusr2" }

63 
	$·r£_sigÇl
(cÚ¡ *
sigÇme
)

65 
i
;

66 
i
 = 0; i < ()
	`SIZE
(
sigÇmes
); ++i)

68 ià(!
	`¡rcmp
(
sigÇme
, 
sigÇmes
[
i
].
uµ”
))

70  
sigÇmes
[
i
].
v®ue
;

74 
	}
}

77 
	$sigÇl_Çme
(cÚ¡ 
sig
, cÚ¡ 
boŞ
 
uµ”
)

79 
i
;

80 
i
 = 0; i < ()
	`SIZE
(
sigÇmes
); ++i)

82 ià(
sig
 =ğ
sigÇmes
[
i
].
v®ue
)

84  
uµ”
 ? 
sigÇmes
[
i
].uµ” : sigÇmes[i].
low”
;

88 
	}
}

91 
	$sigÇl_desütiÚ
(cÚ¡ 
signum
, cÚ¡ *
sig‹xt
)

93 ià(
sig‹xt
)

95  
sig‹xt
;

99  
	`sigÇl_Çme
(
signum
, 
çl£
);

101 
	}
}

104 
	$throw_sigÇl
(cÚ¡ 
signum
)

106 
sigšfo_¡©ic
.
sigÇl_»ûived
 = 
signum
;

107 
sigšfo_¡©ic
.
sourû
 = 
SIG_SOURCE_HARD
;

108 
	}
}

111 
	$throw_sigÇl_soá
(cÚ¡ 
signum
, cÚ¡ *
sigÇl_‹xt
)

113 
sigšfo_¡©ic
.
sigÇl_»ûived
 = 
signum
;

114 
sigšfo_¡©ic
.
sourû
 = 
SIG_SOURCE_SOFT
;

115 
sigšfo_¡©ic
.
sigÇl_‹xt
 = signal_text;

116 
	}
}

119 
	$sigÇl_»£t
(
sigÇl_šfo
 *
si
)

121 ià(
si
)

123 
si
->
sigÇl_»ûived
 = 0;

124 
si
->
sigÇl_‹xt
 = 
NULL
;

125 
si
->
sourû
 = 
SIG_SOURCE_SOFT
;

127 
	}
}

130 
	$´št_sigÇl
(cÚ¡ 
sigÇl_šfo
 *
si
, cÚ¡ *
t™Ë
, 
msgËv–
)

132 ià(
si
)

134 cÚ¡ *
ty³
 = (
si
->
sigÇl_‹xt
 ? si->signal_text : "");

135 cÚ¡ *
t
 = (
t™Ë
 ?itle : "process");

136 cÚ¡ *
hs
 = 
NULL
;

137 
si
->
sourû
)

139 
SIG_SOURCE_SOFT
:

140 
hs
 = "soft";

143 
SIG_SOURCE_HARD
:

144 
hs
 = "hard";

147 
SIG_SOURCE_CONNECTION_FAILED
:

148 
hs
 = "connection failed(soft)";

152 
	`ASSERT
(0);

155 
si
->
sigÇl_»ûived
)

157 
SIGINT
:

158 
SIGTERM
:

159 
	`msg
(
msgËv–
, "%s[%s,%s]„eceived, %sƒxiting",

160 
	`sigÇl_Çme
(
si
->
sigÇl_»ûived
, 
Œue
), 
hs
, 
ty³
, 
t
);

163 
SIGHUP
:

164 
SIGUSR1
:

165 
	`msg
(
msgËv–
, "%s[%s,%s]„eceived, %s„estarting",

166 
	`sigÇl_Çme
(
si
->
sigÇl_»ûived
, 
Œue
), 
hs
, 
ty³
, 
t
);

170 
	`msg
(
msgËv–
, "UnknowÀsigÇÈ%d [%s,%s]„eûived by %s", 
si
->
sigÇl_»ûived
, 
hs
, 
ty³
, 
t
);

176 
	`msg
(
msgËv–
, "Unknown signal„eceived");

178 
	}
}

184 
	$sigÇl_»¡¬t_¡©us
(cÚ¡ 
sigÇl_šfo
 *
si
)

186 #ifdeà
ENABLE_MANAGEMENT


187 ià(
mªagem’t
)

189 
¡©e
 = -1;

190 
si
->
sigÇl_»ûived
)

192 
SIGINT
:

193 
SIGTERM
:

194 
¡©e
 = 
OPENVPN_STATE_EXITING
;

197 
SIGHUP
:

198 
SIGUSR1
:

199 
¡©e
 = 
OPENVPN_STATE_RECONNECTING
;

203 ià(
¡©e
 >= 0)

205 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

206 
¡©e
,

207 
si
->
sigÇl_‹xt
 ? si->sigÇl_‹xˆ: 
	`sigÇl_Çme
(si->
sigÇl_»ûived
, 
Œue
),

208 
NULL
,

209 
NULL
,

210 
NULL
,

211 
NULL
);

215 
	}
}

217 #ifdeà
HAVE_SIGNAL_H


221 
	$sigÇl_hªdËr
(cÚ¡ 
signum
)

223 
	`throw_sigÇl
(
signum
);

224 
	`sigÇl
(
signum
, 
sigÇl_hªdËr
);

225 
	}
}

231 #ifdeà
HAVE_SIGNAL_H


232 
	#SM_UNDEF
 0

	)

233 
	#SM_PRE_INIT
 1

	)

234 
	#SM_POST_INIT
 2

	)

235 
	gsigÇl_mode
;

239 
	$´e_š™_sigÇl_ÿtch
()

241 #iâdeà
_WIN32


242 #ifdeà
HAVE_SIGNAL_H


243 
sigÇl_mode
 = 
SM_PRE_INIT
;

244 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

245 
	`sigÇl
(
SIGTERM
, 
sigÇl_hªdËr
);

246 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

247 
	`sigÇl
(
SIGUSR1
, 
SIG_IGN
);

248 
	`sigÇl
(
SIGUSR2
, 
SIG_IGN
);

249 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

252 
	}
}

255 
	$po¡_š™_sigÇl_ÿtch
()

257 #iâdeà
_WIN32


258 #ifdeà
HAVE_SIGNAL_H


259 
sigÇl_mode
 = 
SM_POST_INIT
;

260 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

261 
	`sigÇl
(
SIGTERM
, 
sigÇl_hªdËr
);

262 
	`sigÇl
(
SIGHUP
, 
sigÇl_hªdËr
);

263 
	`sigÇl
(
SIGUSR1
, 
sigÇl_hªdËr
);

264 
	`sigÇl
(
SIGUSR2
, 
sigÇl_hªdËr
);

265 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

268 
	}
}

272 
	$»¡Üe_sigÇl_¡©e
()

274 #ifdeà
HAVE_SIGNAL_H


275 ià(
sigÇl_mode
 =ğ
SM_PRE_INIT
)

277 
	`´e_š™_sigÇl_ÿtch
();

279 ià(
sigÇl_mode
 =ğ
SM_POST_INIT
)

281 
	`po¡_š™_sigÇl_ÿtch
();

284 
	}
}

292 
	$´št_¡©us
(cÚ¡ 
cÚ‹xt
 *
c
, 
¡©us_ouut
 *
so
)

294 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

296 
	`¡©us_»£t
(
so
);

298 
	`¡©us_´štf
(
so
, "OpenVPN STATISTICS");

299 
	`¡©us_´štf
(
so
, "Upd©ed,%s", 
	`time_¡ršg
(0, 0, 
çl£
, &
gc
));

300 
	`¡©us_´štf
(
so
, "TUN/TAP„—d by‹s," 
couÁ”_fÜm©
, 
c
->
c2
.
tun_»ad_by‹s
);

301 
	`¡©us_´štf
(
so
, "TUN/TAP wr™by‹s," 
couÁ”_fÜm©
, 
c
->
c2
.
tun_wr™e_by‹s
);

302 
	`¡©us_´štf
(
so
, "TCP/UDP„—d by‹s," 
couÁ”_fÜm©
, 
c
->
c2
.
lšk_»ad_by‹s
);

303 
	`¡©us_´štf
(
so
, "TCP/UDP wr™by‹s," 
couÁ”_fÜm©
, 
c
->
c2
.
lšk_wr™e_by‹s
);

304 
	`¡©us_´štf
(
so
, "Auth„—d by‹s," 
couÁ”_fÜm©
, 
c
->
c2
.
lšk_»ad_by‹s_auth
);

305 #ifdeà
USE_COMP


306 ià(
c
->
c2
.
comp_cÚ‹xt
)

308 
	`comp_´št_¡©s
(
c
->
c2
.
comp_cÚ‹xt
, 
so
);

311 #ifdeà
PACKET_TRUNCATION_CHECK


312 
	`¡©us_´štf
(
so
, "TUN„—drunÿtiÚs," 
couÁ”_fÜm©
, 
c
->
c2
.
n_Œunc_tun_»ad
);

313 
	`¡©us_´štf
(
so
, "TUN wr™ŒunÿtiÚs," 
couÁ”_fÜm©
, 
c
->
c2
.
n_Œunc_tun_wr™e
);

314 
	`¡©us_´štf
(
so
, "P»-’üy±runÿtiÚs," 
couÁ”_fÜm©
, 
c
->
c2
.
n_Œunc_´e_’üy±
);

315 
	`¡©us_´štf
(
so
, "Po¡-deüy±runÿtiÚs," 
couÁ”_fÜm©
, 
c
->
c2
.
n_Œunc_po¡_deüy±
);

317 #ifdeà
_WIN32


318 ià(
	`tuÁ­_defšed
(
c
->
c1
.
tuÁ­
))

320 
	`¡©us_´štf
(
so
, "TAP-WIN32 driver status,\"%s\"",

321 
	`p_wš_g‘šfo
(
c
->
c1
.
tuÁ­
, &
gc
));

325 
	`¡©us_´štf
(
so
, "END");

326 
	`¡©us_æush
(
so
);

327 
	`gc_ä“
(&
gc
);

328 
	}
}

330 #ifdeà
ENABLE_OCC


337 
	$´oûss_ex¶ic™_ex™_nÙifiÿtiÚ_š™
(
cÚ‹xt
 *
c
)

339 
	`msg
(
M_INFO
, "SIGTERM„eceived, sendingƒxit‚otificationo…eer");

340 
	`ev’t_timeout_š™
(&
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
, 1, 0);

341 
	`»£t_cßr£_tim”s
(
c
);

342 
	`sigÇl_»£t
(
c
->
sig
);

343 
	`h®t_nÚ_edge_Œigg”ed_sigÇls
();

344 
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
 = 
now
;

345 
	}
}

348 
	$´oûss_ex¶ic™_ex™_nÙifiÿtiÚ_tim”_wakeup
(
cÚ‹xt
 *
c
)

350 ià(
	`ev’t_timeout_Œigg”
(&
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
,

351 &
c
->
c2
.
timev®
,

352 
ETT_DEFAULT
))

354 
	`ASSERT
(
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
 && c->
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
);

355 ià(
now
 >ğ
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
 + c->
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ
)

357 
	`ev’t_timeout_ş—r
(&
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
);

358 
c
->
sig
->
sigÇl_»ûived
 = 
SIGTERM
;

359 
c
->
sig
->
sigÇl_‹xt
 = "exit-with-notification";

363 
c
->
c2
.
occ_İ
 = 
OCC_EXIT
;

366 
	}
}

374 
	$»m­_sigÇl
(
cÚ‹xt
 *
c
)

376 ià(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 && c->
İtiÚs
.
»m­_sigu¤1
)

378 
c
->
sig
->
sigÇl_»ûived
 = c->
İtiÚs
.
»m­_sigu¤1
;

380 
	}
}

383 
	$´oûss_sigu¤2
(cÚ¡ 
cÚ‹xt
 *
c
)

385 
¡©us_ouut
 *
so
 = 
	`¡©us_İ’
(
NULL
, 0, 
M_INFO
, NULL, 0);

386 
	`´št_¡©us
(
c
, 
so
);

387 
	`¡©us_şo£
(
so
);

388 
	`sigÇl_»£t
(
c
->
sig
);

389 
	}
}

391 
boŞ


392 
	$´oûss_sig‹rm
(
cÚ‹xt
 *
c
)

394 
boŞ
 
»t
 = 
Œue
;

395 #ifdeà
ENABLE_OCC


396 ià(
c
->
İtiÚs
.
û
.
ex¶ic™_ex™_nÙifiÿtiÚ


397 && !
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_time_wa™
)

399 
	`´oûss_ex¶ic™_ex™_nÙifiÿtiÚ_š™
(
c
);

400 
»t
 = 
çl£
;

403  
»t
;

404 
	}
}

411 
boŞ


412 
	$ignÜe_»¡¬t_sigÇls
(
cÚ‹xt
 *
c
)

414 
boŞ
 
»t
 = 
çl£
;

415 #ifdeà
ENABLE_OCC


416 iàĞ(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR1
 || c->sig->sigÇl_»ûived =ğ
SIGHUP
)

417 && 
	`ev’t_timeout_defšed
(&
c
->
c2
.
ex¶ic™_ex™_nÙifiÿtiÚ_š‹rv®
) )

419 ià(
c
->
sig
->
sourû
 =ğ
SIG_SOURCE_HARD
)

421 
	`msg
(
M_INFO
, "Ignoring %s„eceived duringƒxit‚otification",

422 
	`sigÇl_Çme
(
c
->
sig
->
sigÇl_»ûived
, 
Œue
));

423 
	`sigÇl_»£t
(
c
->
sig
);

424 
»t
 = 
Œue
;

428 
	`msg
(
M_INFO
, "Converting soft %s„eceived duringƒxit‚otificationo SIGTERM",

429 
	`sigÇl_Çme
(
c
->
sig
->
sigÇl_»ûived
, 
Œue
));

430 
	`»gi¡”_sigÇl
(
c
, 
SIGTERM
, "exit-with-notification");

431 
»t
 = 
çl£
;

435  
»t
;

436 
	}
}

438 
boŞ


439 
	$´oûss_sigÇl
(
cÚ‹xt
 *
c
)

441 
boŞ
 
»t
 = 
Œue
;

443 ià(
	`ignÜe_»¡¬t_sigÇls
(
c
))

445 
»t
 = 
çl£
;

447 ià(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGTERM
 || c->sig->sigÇl_»ûived =ğ
SIGINT
)

449 
»t
 = 
	`´oûss_sig‹rm
(
c
);

451 ià(
c
->
sig
->
sigÇl_»ûived
 =ğ
SIGUSR2
)

453 
	`´oûss_sigu¤2
(
c
);

454 
»t
 = 
çl£
;

456  
»t
;

457 
	}
}

460 
	$»gi¡”_sigÇl
(
cÚ‹xt
 *
c
, 
sig
, cÚ¡ *
‹xt
)

462 ià(
c
->
sig
->
sigÇl_»ûived
 !ğ
SIGTERM
)

464 
c
->
sig
->
sigÇl_»ûived
 = sig;

466 
c
->
sig
->
sigÇl_‹xt
 = 
‹xt
;

467 
	}
}

	@sig.h

24 #iâdeà
SIG_H


25 
	#SIG_H


	)

27 
	~"¡©us.h
"

28 
	~"wš32.h
"

32 
	#SIG_SOURCE_SOFT
 0

	)

33 
	#SIG_SOURCE_HARD
 1

	)

37 
	#SIG_SOURCE_CONNECTION_FAILED
 2

	)

43 
	ssigÇl_šfo


45 vŞ©
	msigÇl_»ûived
;

46 vŞ©
	msourû
;

47 cÚ¡ *
	msigÇl_‹xt
;

50 
	#IS_SIG
(
c
è((c)->
sig
->
sigÇl_»ûived
)

	)

52 
	gcÚ‹xt
;

54 
sigÇl_šfo
 
sigšfo_¡©ic
;

56 
·r£_sigÇl
(cÚ¡ *
sigÇme
);

58 cÚ¡ *
sigÇl_Çme
(cÚ¡ 
sig
, cÚ¡ 
boŞ
 
uµ”
);

60 cÚ¡ *
sigÇl_desütiÚ
(cÚ¡ 
signum
, cÚ¡ *
sig‹xt
);

62 
throw_sigÇl
(cÚ¡ 
signum
);

64 
throw_sigÇl_soá
(cÚ¡ 
signum
, cÚ¡ *
sigÇl_‹xt
);

66 
´e_š™_sigÇl_ÿtch
();

68 
po¡_š™_sigÇl_ÿtch
();

70 
»¡Üe_sigÇl_¡©e
();

72 
´št_sigÇl
(cÚ¡ 
sigÇl_šfo
 *
si
, cÚ¡ *
t™Ë
, 
msgËv–
);

74 
´št_¡©us
(cÚ¡ 
cÚ‹xt
 *
c
, 
¡©us_ouut
 *
so
);

76 
»m­_sigÇl
(
cÚ‹xt
 *
c
);

78 
sigÇl_»¡¬t_¡©us
(cÚ¡ 
sigÇl_šfo
 *
si
);

80 
boŞ
 
´oûss_sigÇl
(
cÚ‹xt
 *
c
);

82 
»gi¡”_sigÇl
(
cÚ‹xt
 *
c
, 
sig
, cÚ¡ *
‹xt
);

84 #ifdeà
ENABLE_OCC


85 
´oûss_ex¶ic™_ex™_nÙifiÿtiÚ_tim”_wakeup
(
cÚ‹xt
 *
c
);

89 #ifdeà
_WIN32


91 
šlše
 

92 
	$g‘_sigÇl
(vŞ©*
sig
)

94 *
sig
 = 
	`wš32_sigÇl_g‘
(&
wš32_sigÇl
);

95 
	}
}

97 
šlše
 

98 
	$h®t_nÚ_edge_Œigg”ed_sigÇls
()

100 
	`wš32_sigÇl_şo£
(&
wš32_sigÇl
);

101 
	}
}

105 
šlše
 

106 
	$g‘_sigÇl
(vŞ©*
sig
)

108 cÚ¡ 
i
 = 
sigšfo_¡©ic
.
sigÇl_»ûived
;

109 ià(
i
)

111 *
sig
 = 
i
;

113 
	}
}

115 
šlše
 

116 
	$h®t_nÚ_edge_Œigg”ed_sigÇls
()

118 
	}
}

	@socket.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"sock‘.h
"

33 
	~"fdmisc.h
"

34 
	~"misc.h
"

35 
	~"g»mlš.h
"

36 
	~"¶ugš.h
"

37 
	~"ps.h
"

38 
	~"mªage.h
"

39 
	~"misc.h
"

40 
	~"mªage.h
"

41 
	~"İ’v².h
"

42 
	~"fÜw¬d.h
"

44 
	~"memdbg.h
"

46 cÚ¡ 
	g´Ùo_ov”h—d
[] = {

48 
IPv4_UDP_HEADER_SIZE
,

49 
IPv4_TCP_HEADER_SIZE
,

50 
IPv4_TCP_HEADER_SIZE
,

51 
IPv6_UDP_HEADER_SIZE
,

52 
IPv6_TCP_HEADER_SIZE
,

53 
IPv6_TCP_HEADER_SIZE
,

54 
IPv6_TCP_HEADER_SIZE
,

61 
	$sf2gaf
(cÚ¡ 
g‘addr_æags
,

62 cÚ¡ 
sockæags
)

64 ià(
sockæags
 & 
SF_HOST_RANDOMIZE
)

66  
g‘addr_æags
 | 
GETADDR_RANDOMIZE
;

70  
g‘addr_æags
;

72 
	}
}

78 
	$g‘_addr_g’”ic
(
§_çmy_t
 
af
, 
æags
, cÚ¡ *
ho¡Çme
,

79 *
ÃtwÜk
, *
Ãtb™s
,

80 
»sŞve_»Œy_£cÚds
, vŞ©*
sigÇl_»ûived
,

81 
msgËv–
)

83 *
’dp
, *
£p
, *
v¬_ho¡
 = 
NULL
;

84 
addršfo
 *
ai
 = 
NULL
;

85 
b™s
;

86 
ušt8_t
 
max_b™s
;

87 
»t
 = -1;

89 ià(!
ho¡Çme
)

91 
	`msg
(
M_NONFATAL
, "Can't„esolve‚ull hostname!");

92 
out
;

96 
af
)

98 
AF_INET
:

99 
b™s
 = 0;

100 
max_b™s
 = (
š_addr_t
) * 8;

102 
AF_INET6
:

103 
b™s
 = 64;

104 
max_b™s
 = (
š6_addr
) * 8;

107 
	`msg
(
M_WARN
,

109 
ho¡Çme
, 
af
);

110 
out
;

118 
v¬_ho¡
 = 
	`¡rdup
(
ho¡Çme
);

119 ià(!
v¬_ho¡
)

121 
	`msg
(
M_NONFATAL
 | 
M_ERRNO
,

123 
out
;

127 
£p
 = 
	`¡rchr
(
v¬_ho¡
 , '/');

128 ià(
£p
)

130 
b™s
 = 
	`¡¹oul
(
£p
 + 1, &
’dp
, 10);

131 ià((*
’dp
 !ğ'\0'è|| (
b™s
 > 
max_b™s
))

133 
	`msg
(
msgËv–
, "IP…»fix '%s': inv®id '/b™s' s³ø(%s)", 
ho¡Çme
,

134 
£p
 + 1);

135 
out
;

137 *
£p
 = '\0';

140 
»t
 = 
	`İ’v²_g‘addršfo
(
æags
 & ~
GETADDR_HOST_ORDER
, 
v¬_ho¡
, 
NULL
,

141 
»sŞve_»Œy_£cÚds
, 
sigÇl_»ûived
, 
af
, &
ai
);

142 ià((
»t
 =ğ0è&& 
ÃtwÜk
)

144 
š6_addr
 *
6
;

145 
š_addr_t
 *
4
;

147 
af
)

149 
AF_INET
:

150 
4
 = 
ÃtwÜk
;

151 *
4
 = ((
sockaddr_š
 *)
ai
->
ai_addr
)->
sš_addr
.
s_addr
;

153 ià(
æags
 & 
GETADDR_HOST_ORDER
)

155 *
4
 = 
	`Áohl
(*ip4);

158 
AF_INET6
:

159 
6
 = 
ÃtwÜk
;

160 *
6
 = ((
sockaddr_š6
 *)
ai
->
ai_addr
)->
sš6_addr
;

164 
	`msg
(
M_WARN
,

165 "UnsuµÜ‹d AF famy fÜ % (%d)", 
v¬_ho¡
, 
af
);

166 
out
;

170 ià(
Ãtb™s
)

172 *
Ãtb™s
 = 
b™s
;

176 ià(
£p
)

178 *
£p
 = '/';

180 
out
:

181 
	`ä“addršfo
(
ai
);

182 
	`ä“
(
v¬_ho¡
);

184  
»t
;

185 
	}
}

187 
š_addr_t


188 
	$g‘addr
(
æags
,

189 cÚ¡ *
ho¡Çme
,

190 
»sŞve_»Œy_£cÚds
,

191 
boŞ
 *
sucûeded
,

192 vŞ©*
sigÇl_»ûived
)

194 
š_addr_t
 
addr
;

195 
¡©us
;

197 
¡©us
 = 
	`g‘_addr_g’”ic
(
AF_INET
, 
æags
, 
ho¡Çme
, &
addr
, 
NULL
,

198 
»sŞve_»Œy_£cÚds
, 
sigÇl_»ûived
,

199 
M_WARN
);

200 ià(
¡©us
==0)

202 ià(
sucûeded
)

204 *
sucûeded
 = 
Œue
;

206  
addr
;

210 ià(
sucûeded
)

212 *
sucûeded
 = 
çl£
;

216 
	}
}

218 
boŞ


219 
	$g‘_v6_addr
(cÚ¡ *
ho¡Çme
, 
š6_addr
 *
ÃtwÜk
,

220 *
Ãtb™s
, 
msgËv–
)

222 ià(
	`g‘_addr_g’”ic
(
AF_INET6
, 
GETADDR_RESOLVE
, 
ho¡Çme
, 
ÃtwÜk
, 
Ãtb™s
,

223 0, 
NULL
, 
msgËv–
) < 0)

225  
çl£
;

228  
Œue
;

229 
	}
}

231 
šlše
 
boŞ


232 
	$¡»qnuÎ
(cÚ¡ *
a
, cÚ¡ *
b
)

234 ià(
a
 =ğ
NULL
 && 
b
 == NULL)

236  
Œue
;

238 ià(
a
 =ğ
NULL
 || 
b
 == NULL)

240  
çl£
;

244  
	`¡»q
(
a
, 
b
);

246 
	}
}

253 
	$g‘_ÿched_dns_’Œy
(
ÿched_dns_’Œy
 *
dns_ÿche
,

254 cÚ¡ *
ho¡Çme
,

255 cÚ¡ *
£rvÇme
,

256 
ai_çmy
,

257 
»sŞve_æags
,

258 
addršfo
 **
ai
)

260 
ÿched_dns_’Œy
 *
ph
;

261 
æags
;

264 
æags
 = 
»sŞve_æags
 & 
GETADDR_CACHE_MASK
;

266 
ph
 = 
dns_ÿche
;…h;…h =…h->
Ãxt
)

268 ià(
	`¡»qnuÎ
(
ph
->
ho¡Çme
, hostname)

269 && 
	`¡»qnuÎ
(
ph
->
£rvÇme
, servname)

270 && 
ph
->
ai_çmy
 ==‡i_family

271 && 
ph
->
æags
 == flags)

273 *
ai
 = 
ph
->ai;

278 
	}
}

282 
	$do_´”esŞve_ho¡
(
cÚ‹xt
 *
c
,

283 cÚ¡ *
ho¡Çme
,

284 cÚ¡ *
£rvÇme
,

285 cÚ¡ 
af
,

286 cÚ¡ 
æags
)

288 
addršfo
 *
ai
;

289 
¡©us
;

291 ià(
	`g‘_ÿched_dns_’Œy
(
c
->
c1
.
dns_ÿche
,

292 
ho¡Çme
,

293 
£rvÇme
,

294 
af
,

295 
æags
,

296 &
ai
) == 0)

302 
¡©us
 = 
	`İ’v²_g‘addršfo
(
æags
, 
ho¡Çme
, 
£rvÇme
,

303 
c
->
İtiÚs
.
»sŞve_»Œy_£cÚds
, 
NULL
,

304 
af
, &
ai
);

305 ià(
¡©us
 == 0)

307 
ÿched_dns_’Œy
 *
ph
;

309 
	`ALLOC_OBJ_CLEAR_GC
(
ph
, 
ÿched_dns_’Œy
, &
c
->
gc
);

310 
ph
->
ai
 =‡i;

311 
ph
->
ho¡Çme
 = hostname;

312 
ph
->
£rvÇme
 = servname;

313 
ph
->
æags
 = fÏg & 
GETADDR_CACHE_MASK
;

315 ià(!
c
->
c1
.
dns_ÿche
)

317 
c
->
c1
.
dns_ÿche
 = 
ph
;

321 
ÿched_dns_’Œy
 *
´ev
 = 
c
->
c1
.
dns_ÿche
;

322 
´ev
->
Ãxt
)

324 
´ev
 =…»v->
Ãxt
;

326 
´ev
->
Ãxt
 = 
ph
;

329 
	`gc_add¥ecŸl
(
ai
, &
gc_ä“addršfo_ÿÎback
, &
c
->
gc
);

332  
¡©us
;

333 
	}
}

336 
	$do_´”esŞve
(
cÚ‹xt
 *
c
)

338 
i
;

339 
cÚÃùiÚ_li¡
 *
l
 = 
c
->
İtiÚs
.connection_list;

340 cÚ¡ 
´”esŞve_æags
 = 
GETADDR_RESOLVE


341 |
GETADDR_UPDATE_MANAGEMENT_STATE


342 |
GETADDR_MENTION_RESOLVE_RETRY


343 |
GETADDR_FATAL
;

346 
i
 = 0; i < 
l
->
Ën
; ++i)

348 
¡©us
;

349 cÚ¡ *
»mÙe
;

350 
æags
 = 
´”esŞve_æags
;

352 
cÚÃùiÚ_’Œy
 *
û
 = 
c
->
İtiÚs
.
cÚÃùiÚ_li¡
->
¬¿y
[
i
];

354 ià(
	`´Ùo_is_dg¿m
(
û
->
´Ùo
))

356 
æags
 |ğ
GETADDR_DATAGRAM
;

359 ià(
c
->
İtiÚs
.
sockæags
 & 
SF_HOST_RANDOMIZE
)

361 
æags
 |ğ
GETADDR_RANDOMIZE
;

364 ià(
c
->
İtiÚs
.
_»mÙe_hšt
)

366 
»mÙe
 = 
c
->
İtiÚs
.
_»mÙe_hšt
;

370 
»mÙe
 = 
û
->remote;

374 ià(!
û
->
h‰p_´oxy_İtiÚs
)

376 
¡©us
 = 
	`do_´”esŞve_ho¡
(
c
, 
»mÙe
, 
û
->
»mÙe_pÜt
, ce->
af
, 
æags
);

377 ià(
¡©us
 != 0)

379 
”r
;

384 ià(
û
->
h‰p_´oxy_İtiÚs
)

386 
¡©us
 = 
	`do_´”esŞve_ho¡
(
c
,

387 
û
->
h‰p_´oxy_İtiÚs
->
£rv”
,

388 
û
->
h‰p_´oxy_İtiÚs
->
pÜt
,

389 
û
->
af
,

390 
´”esŞve_æags
);

392 ià(
¡©us
 != 0)

394 
”r
;

398 ià(
û
->
socks_´oxy_£rv”
)

400 
¡©us
 = 
	`do_´”esŞve_ho¡
(
c
,

401 
û
->
socks_´oxy_£rv”
,

402 
û
->
socks_´oxy_pÜt
,

403 
û
->
af
,

404 
æags
);

405 ià(
¡©us
 != 0)

407 
”r
;

411 ià(
û
->
bšd_loÿl
)

413 
æags
 |ğ
GETADDR_PASSIVE
;

414 
æags
 &ğ~
GETADDR_RANDOMIZE
;

415 
¡©us
 = 
	`do_´”esŞve_ho¡
(
c
, 
û
->
loÿl
, ce->
loÿl_pÜt
, ce->
af
, 
æags
);

416 ià(
¡©us
 != 0)

418 
”r
;

426 
”r
:

427 
	`throw_sigÇl_soá
(
SIGHUP
, "Preresolving failed");

428 
	}
}

435 
	$İ’v²_g‘addršfo
(
æags
,

436 cÚ¡ *
ho¡Çme
,

437 cÚ¡ *
£rvÇme
,

438 
»sŞve_»Œy_£cÚds
,

439 vŞ©*
sigÇl_»ûived
,

440 
ai_çmy
,

441 
addršfo
 **
»s
)

443 
addršfo
 
hšts
;

444 
¡©us
;

445 
sig»c
 = 0;

446 
msgËv–
 = (
æags
 & 
GETADDR_FATAL
è? 
M_FATAL
 : 
D_RESOLVE_ERRORS
;

447 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

448 cÚ¡ *
´št_ho¡Çme
;

449 cÚ¡ *
´št_£rvÇme
;

451 
	`ASSERT
(
»s
);

453 
	`ASSERT
(
ho¡Çme
 || 
£rvÇme
);

454 
	`ASSERT
(!(
æags
 & 
GETADDR_HOST_ORDER
));

456 ià(
£rvÇme
)

458 
´št_£rvÇme
 = 
£rvÇme
;

462 
´št_£rvÇme
 = "";

465 ià(
æags
 & 
GETADDR_MSG_VIRT_OUT
)

467 
msgËv–
 |ğ
M_MSG_VIRT_OUT
;

470 ià((
æags
 & (
GETADDR_FATAL_ON_SIGNAL
|
GETADDR_WARN_ON_SIGNAL
))

471 && !
sigÇl_»ûived
)

473 
sigÇl_»ûived
 = &
sig»c
;

477 
	`CLEAR
(
hšts
);

478 
hšts
.
ai_çmy
 =‡i_family;

479 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

481 ià(
æags
 & 
GETADDR_PASSIVE
)

483 
hšts
.
ai_æags
 |ğ
AI_PASSIVE
;

486 ià(
æags
 & 
GETADDR_DATAGRAM
)

488 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

492 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

495 
¡©us
 = 
	`g‘addršfo
(
ho¡Çme
, 
£rvÇme
, &
hšts
, 
»s
);

497 ià(
¡©us
 != 0)

499 cÚ¡ 
ç_wa™_š‹rv®
 = 5;

501 
»sŞve_»Œ›s
 = (
æags
 & 
GETADDR_TRY_ONCE
) ? 1 :

502 ((
»sŞve_»Œy_£cÚds
 + 4)/ 
ç_wa™_š‹rv®
);

503 cÚ¡ *
fmt
;

504 
Ëv–
 = 0;

506 ià(
ho¡Çme
 && (
æags
 & 
GETADDR_RANDOMIZE
))

508 
ho¡Çme
 = 
	`ho¡Çme_¿ndomize
(ho¡Çme, &
gc
);

511 ià(
ho¡Çme
)

513 
´št_ho¡Çme
 = 
ho¡Çme
;

517 
´št_ho¡Çme
 = "undefined";

520 
fmt
 = "RESOLVE: Cannot„esolve host‡ddress: %s:%s (%s)";

521 ià((
æags
 & 
GETADDR_MENTION_RESOLVE_RETRY
)

522 && !
»sŞve_»Œy_£cÚds
)

524 
fmt
 = "RESOLVE: Cannot„esolve host‡ddress: %s:%s (%s) (I would have„etriedhis‚ame query if you had specifiedhe --resolv-retry option.)";

527 ià(!(
æags
 & 
GETADDR_RESOLVE
è|| 
¡©us
 =ğ
EAI_FAIL
)

529 
	`msg
(
msgËv–
, "RESOLVE: Cannot…arse IP‡ddress: %s:%s (%s)",

530 
´št_ho¡Çme
,
´št_£rvÇme
, 
	`gai_¡»¼Ü
(
¡©us
));

531 
dÚe
;

534 #ifdeà
ENABLE_MANAGEMENT


535 ià(
æags
 & 
GETADDR_UPDATE_MANAGEMENT_STATE
)

537 ià(
mªagem’t
)

539 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

540 
OPENVPN_STATE_RESOLVE
,

541 
NULL
,

542 
NULL
,

543 
NULL
,

544 
NULL
,

545 
NULL
);

553 
Œue
)

555 #iâdeà
_WIN32


556 
	`»s_š™
();

559 
hšts
.
ai_æags
 &ğ~
AI_NUMERICHOST
;

560 
	`dmsg
(
D_SOCKET_DEBUG
, "GETADDRINFO flags=0x%04x‡i_family=%d‡i_socktype=%d",

561 
æags
, 
hšts
.
ai_çmy
, hšts.
ai_sockty³
);

562 
¡©us
 = 
	`g‘addršfo
(
ho¡Çme
, 
£rvÇme
, &
hšts
, 
»s
);

564 ià(
sigÇl_»ûived
)

566 
	`g‘_sigÇl
(
sigÇl_»ûived
);

567 ià(*
sigÇl_»ûived
)

569 ià(*
sigÇl_»ûived
 =ğ
SIGUSR1
)

571 
	`msg
(
Ëv–
, "RESOLVE: Ignored SIGUSR1 signal„eceived during DNS„esolution‡ttempt");

572 *
sigÇl_»ûived
 = 0;

577 ià(0 =ğ
¡©us
)

579 
	`ASSERT
(
»s
);

580 
	`ä“addršfo
(*
»s
);

581 *
»s
 = 
NULL
;

582 
¡©us
 = 
EAI_AGAIN
;

583 
”ºo
 = 
EINTR
;

585 
dÚe
;

591 ià(0 =ğ
¡©us
)

598 
Ëv–
 = 
msgËv–
;

599 ià(
»sŞve_»Œ›s
 > 0)

601 
Ëv–
 = 
D_RESOLVE_ERRORS
;

604 
	`msg
(
Ëv–
,

605 
fmt
,

606 
´št_ho¡Çme
,

607 
´št_£rvÇme
,

608 
	`gai_¡»¼Ü
(
¡©us
));

610 ià(--
»sŞve_»Œ›s
 <= 0)

612 
dÚe
;

615 
	`mªagem’t_¦“p
(
ç_wa™_š‹rv®
);

618 
	`ASSERT
(
»s
);

630 ià(
æags
 & 
GETADDR_RANDOMIZE
)

632 
	`msg
(
M_WARN
, "WARNING: ignoring --remote-random-hostname becausehe hostname is‡n IP‡ddress");

636 
dÚe
:

637 ià(
sigÇl_»ûived
 && *signal_received)

639 
Ëv–
 = 0;

640 ià(
æags
 & 
GETADDR_FATAL_ON_SIGNAL
)

642 
Ëv–
 = 
M_FATAL
;

644 ià(
æags
 & 
GETADDR_WARN_ON_SIGNAL
)

646 
Ëv–
 = 
M_WARN
;

648 
	`msg
(
Ëv–
, "RESOLVE: signal„eceived during DNS„esolution‡ttempt");

651 
	`gc_ä“
(&
gc
);

652  
¡©us
;

653 
	}
}

660 
	$İ’v²_š‘_©Ú
(cÚ¡ *
dÙ‹d_quad
, 
š_addr
 *
addr
)

662 
a
, 
b
, 
c
, 
d
;

664 
	`CLEAR
(*
addr
);

665 ià(
	`ssÿnf
(
dÙ‹d_quad
, "%u.%u.%u.%u", &
a
, &
b
, &
c
, &
d
) == 4)

667 ià(
a
 < 256 && 
b
 < 256 && 
c
 < 256 && 
d
 < 256)

669 
addr
->
s_addr
 = 
	`htÚl
(
a
<<24 | 
b
<<16 | 
c
<<8 | 
d
);

670  
OIA_IP
;

673 ià(
	`¡ršg_şass
(
dÙ‹d_quad
, 
CC_DIGIT
|
CC_DOT
, 0))

675  
OIA_ERROR
;

679  
OIA_HOSTNAME
;

681 
	}
}

683 
boŞ


684 
	$_addr_dÙ‹d_quad_§ã
(cÚ¡ *
dÙ‹d_quad
)

687 ià(!
dÙ‹d_quad
)

689  
çl£
;

693 ià(
	`¡¾’
(
dÙ‹d_quad
) > 15)

695  
çl£
;

701 
Âum
 = 0;

702 cÚ¡ *
p
 = 
dÙ‹d_quad
;

703 
c
;

705 (
c
 = *
p
++))

707 ià(
c
 >= '0' && c <= '9')

709 ++
Âum
;

710 ià(
Âum
 > 3)

712  
çl£
;

715 ià(
c
 == '.')

717 
Âum
 = 0;

721  
çl£
;

728 
š_addr
 
a
;

729  
	`İ’v²_š‘_©Ú
(
dÙ‹d_quad
, &
a
è=ğ
OIA_IP
;

731 
	}
}

733 
boŞ


734 
	$v6_addr_§ã
(cÚ¡ *
v6_‹xt_addr
)

737 ià(!
v6_‹xt_addr
)

739  
çl£
;

743 ià(
	`¡¾’
(
v6_‹xt_addr
è> 
INET6_ADDRSTRLEN
)

745  
çl£
;

750 
š6_addr
 
a6
;

751  
	`š‘_±Ú
Ğ
AF_INET6
, 
v6_‹xt_addr
, &
a6
 ) == 1;

753 
	}
}

755 
boŞ


756 
	$dns_addr_§ã
(cÚ¡ *
addr
)

758 ià(
addr
)

760 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
(
addr
);

761  
Ën
 > 0 &&†’ <ğ255 && 
	`¡ršg_şass
(
addr
, 
CC_ALNUM
|
CC_DASH
|
CC_DOT
, 0);

765  
çl£
;

767 
	}
}

769 
boŞ


770 
	$_Ü_dns_addr_§ã
(cÚ¡ *
addr
, cÚ¡ 
boŞ
 
®low_fqdn
)

772 ià(
	`_addr_dÙ‹d_quad_§ã
(
addr
))

774  
Œue
;

776 ià(
®low_fqdn
)

778  
	`dns_addr_§ã
(
addr
);

782  
çl£
;

784 
	}
}

786 
boŞ


787 
	$mac_addr_§ã
(cÚ¡ *
mac_addr
)

790 ià(!
mac_addr
)

792  
çl£
;

796 ià(
	`¡¾’
(
mac_addr
) > 17)

798  
çl£
;

804 
Âum
 = 0;

805 cÚ¡ *
p
 = 
mac_addr
;

806 
c
;

808 (
c
 = *
p
++))

810 iàĞ(
c
 >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F') )

812 ++
Âum
;

813 ià(
Âum
 > 2)

815  
çl£
;

818 ià(
c
 == ':')

820 
Âum
 = 0;

824  
çl£
;

830  
Œue
;

831 
	}
}

834 
	$sock‘_g‘_¢dbuf
(
sd
)

836 #ià
	`defšed
(
HAVE_GETSOCKOPT
è&& defšed(
SOL_SOCKET
è&& defšed(
SO_SNDBUF
)

837 
v®
;

838 
sockËn_t
 
Ën
;

840 
Ën
 = (
v®
);

841 ià(
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*è&
v®
, &
Ën
) == 0

842 && 
Ën
 =ğ(
v®
))

844  
v®
;

848 
	}
}

851 
	$sock‘_£t_¢dbuf
(
sd
, 
size
)

853 #ià
	`defšed
(
HAVE_SETSOCKOPT
è&& defšed(
SOL_SOCKET
è&& defšed(
SO_SNDBUF
)

854 ià(
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*è&
size
, (size)) != 0)

856 
	`msg
(
M_WARN
, "NOTE: s‘sockİˆSO_SNDBUF=%d faed", 
size
);

859 
	}
}

862 
	$sock‘_g‘_rcvbuf
(
sd
)

864 #ià
	`defšed
(
HAVE_GETSOCKOPT
è&& defšed(
SOL_SOCKET
è&& defšed(
SO_RCVBUF
)

865 
v®
;

866 
sockËn_t
 
Ën
;

868 
Ën
 = (
v®
);

869 ià(
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*è&
v®
, &
Ën
) == 0

870 && 
Ën
 =ğ(
v®
))

872  
v®
;

876 
	}
}

878 
boŞ


879 
	$sock‘_£t_rcvbuf
(
sd
, 
size
)

881 #ià
	`defšed
(
HAVE_SETSOCKOPT
è&& defšed(
SOL_SOCKET
è&& defšed(
SO_RCVBUF
)

882 ià(
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*è&
size
, (size)) != 0)

884 
	`msg
(
M_WARN
, "NOTE: s‘sockİˆSO_RCVBUF=%d faed", 
size
);

885  
çl£
;

887  
Œue
;

889 
	}
}

892 
	$sock‘_£t_bufãrs
(
fd
, cÚ¡ 
sock‘_bufãr_size
 *
sbs
)

894 ià(
sbs
)

896 cÚ¡ 
¢dbuf_Şd
 = 
	`sock‘_g‘_¢dbuf
(
fd
);

897 cÚ¡ 
rcvbuf_Şd
 = 
	`sock‘_g‘_rcvbuf
(
fd
);

899 ià(
sbs
->
¢dbuf
)

901 
	`sock‘_£t_¢dbuf
(
fd
, 
sbs
->
¢dbuf
);

904 ià(
sbs
->
rcvbuf
)

906 
	`sock‘_£t_rcvbuf
(
fd
, 
sbs
->
rcvbuf
);

909 
	`msg
(
D_OSBUF
, "Socket Buffers: R=[%d->%d] S=[%d->%d]",

910 
rcvbuf_Şd
,

911 
	`sock‘_g‘_rcvbuf
(
fd
),

912 
¢dbuf_Şd
,

913 
	`sock‘_g‘_¢dbuf
(
fd
));

915 
	}
}

921 
boŞ


922 
	$sock‘_£t_tı_nod–ay
(
sd
, 
¡©e
)

924 #ià
	`defšed
(
_WIN32
è|| (defšed(
HAVE_SETSOCKOPT
è&& defšed(
IPPROTO_TCP
è&& defšed(
TCP_NODELAY
))

925 ià(
	`£tsockİt
(
sd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*è&
¡©e
, (state)) != 0)

927 
	`msg
(
M_WARN
, "NOTE: s‘sockİˆTCP_NODELAY=%d faed", 
¡©e
);

928  
çl£
;

932 
	`dmsg
(
D_OSBUF
, "Sock‘ fÏgs: TCP_NODELAY=%d sucûeded", 
¡©e
);

933  
Œue
;

936 
	`msg
(
M_WARN
, "NOTE: s‘sockİˆTCP_NODELAY=%d faed (NØk”ÃÈsuµÜt)", 
¡©e
);

937  
çl£
;

939 
	}
}

941 
šlše
 

942 
	$sock‘_£t_m¬k
(
sd
, 
m¬k
)

944 #ià
	`defšed
(
TARGET_LINUX
è&& 
HAVE_DECL_SO_MARK


945 ià(
m¬k
 && 
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_MARK
, (*) &mark, (mark)) != 0)

947 
	`msg
(
M_WARN
, "NOTE: s‘sockİˆSO_MARK=%d faed", 
m¬k
);

950 
	}
}

952 
boŞ


953 
	$sock‘_£t_æags
(
sd
, 
sockæags
)

955 ià(
sockæags
 & 
SF_TCP_NODELAY
)

957  
	`sock‘_£t_tı_nod–ay
(
sd
, 1);

961  
Œue
;

963 
	}
}

965 
boŞ


966 
	$lšk_sock‘_upd©e_æags
(
lšk_sock‘
 *
ls
, 
sockæags
)

968 ià(
ls
 && 
	`sock‘_defšed
Ös->
sd
))

970  
	`sock‘_£t_æags
(
ls
->
sd
,†s->
sockæags
 = sockflags);

974  
çl£
;

976 
	}
}

979 
	$lšk_sock‘_upd©e_bufãr_sizes
(
lšk_sock‘
 *
ls
, 
rcvbuf
, 
¢dbuf
)

981 ià(
ls
 && 
	`sock‘_defšed
Ös->
sd
))

983 
ls
->
sock‘_bufãr_sizes
.
¢dbuf
 = sndbuf;

984 
ls
->
sock‘_bufãr_sizes
.
rcvbuf
 =„cvbuf;

985 
	`sock‘_£t_bufãrs
(
ls
->
sd
, &ls->
sock‘_bufãr_sizes
);

987 
	}
}

994 
sock‘_desütÜ_t


995 
	$ü—‹_sock‘_tı
(
addršfo
 *addrinfo)

997 
sock‘_desütÜ_t
 
sd
;

999 
	`ASSERT
(
addršfo
);

1000 
	`ASSERT
(
addršfo
->
ai_sockty³
 =ğ
SOCK_STREAM
);

1002 ià((
sd
 = 
	`sock‘
(
addršfo
->
ai_çmy
,‡ddršfo->
ai_sockty³
,‡ddršfo->
ai_´ÙocŞ
)) < 0)

1004 
	`msg
(
M_ERR
, "Cannot create TCP socket");

1007 #iâdeà
_WIN32


1010 
Ú
 = 1;

1011 ià(
	`£tsockİt
(
sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

1012 (*è&
Ú
, (on)) < 0)

1014 
	`msg
(
M_ERR
, "TCP: Cannot setsockopt SO_REUSEADDR on TCP socket");

1021 
	`£t_şÛxec
(
sd
);

1023  
sd
;

1024 
	}
}

1026 
sock‘_desütÜ_t


1027 
	$ü—‹_sock‘_udp
(
addršfo
 *addršfo, cÚ¡ 
æags
)

1029 
sock‘_desütÜ_t
 
sd
;

1031 
	`ASSERT
(
addršfo
);

1032 
	`ASSERT
(
addršfo
->
ai_sockty³
 =ğ
SOCK_DGRAM
);

1034 ià((
sd
 = 
	`sock‘
(
addršfo
->
ai_çmy
,‡ddršfo->
ai_sockty³
,‡ddršfo->
ai_´ÙocŞ
)) < 0)

1036 
	`msg
(
M_ERR
, "UDP: Cannot create UDP/UDP6 socket");

1038 #ià
ENABLE_IP_PKTINFO


1039 ià(
æags
 & 
SF_USE_IP_PKTINFO
)

1041 
·d
 = 1;

1042 ià(
addršfo
->
ai_çmy
 =ğ
AF_INET
)

1044 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

1045 ià(
	`£tsockİt
(
sd
, 
SOL_IP
, 
IP_PKTINFO
,

1046 (*)&
·d
, (pad)) < 0)

1048 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IP_PKTINFO");

1050 #–ià
	`defšed
(
IP_RECVDSTADDR
)

1051 ià(
	`£tsockİt
(
sd
, 
IPPROTO_IP
, 
IP_RECVDSTADDR
,

1052 (*)&
·d
, (pad)) < 0)

1054 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IP_RECVDSTADDR");

1057 #”rÜ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
w™hout
 
IP_PKTINFO
 
xÜ
 
	`IP_RECVDSTADDR
 (
fix
 
sysh—d
.
h
)

1060 ià(
addršfo
->
ai_çmy
 =ğ
AF_INET6
)

1062 #iâdeà
IPV6_RECVPKTINFO


1063 ià(
	`£tsockİt
(
sd
, 
IPPROTO_IPV6
, 
IPV6_PKTINFO
,

1064 (*)&
·d
, (pad)) < 0)

1066 ià(
	`£tsockİt
(
sd
, 
IPPROTO_IPV6
, 
IPV6_RECVPKTINFO
,

1067 (*)&
·d
, (pad)) < 0)

1069 { 
	`msg
(
M_ERR
, "UDP: failed setsockopt for IPV6_RECVPKTINFO");}

1076 
	`£t_şÛxec
(
sd
);

1078  
sd
;

1079 
	}
}

1082 
	$bšd_loÿl
(
lšk_sock‘
 *
sock
, cÚ¡ 
§_çmy_t
 
ai_çmy
)

1085 ià(
sock
->
bšd_loÿl
)

1087 ià(
sock
->
socks_´oxy
 && sock->
šfo
.
´Ùo
 =ğ
PROTO_UDP
)

1089 
	`sock‘_bšd
(
sock
->
ù¾_sd
, sock->
šfo
.
l§
->
bšd_loÿl
,

1090 
ai_çmy
, "SOCKS", 
çl£
);

1094 
	`sock‘_bšd
(
sock
->
sd
, sock->
šfo
.
l§
->
bšd_loÿl
,

1095 
ai_çmy
,

1096 "TCP/UDP", 
sock
->
šfo
.
bšd_v6_Úly
);

1099 
	}
}

1102 
	$ü—‹_sock‘
(
lšk_sock‘
 *
sock
, 
addršfo
 *
addr
)

1104 ià(
addr
->
ai_´ÙocŞ
 =ğ
IPPROTO_UDP
 ||‡ddr->
ai_sockty³
 =ğ
SOCK_DGRAM
)

1106 
sock
->
sd
 = 
	`ü—‹_sock‘_udp
(
addr
, sock->
sockæags
);

1107 
sock
->
sockæags
 |ğ
SF_GETADDRINFO_DGRAM
;

1111 ià(
sock
->
socks_´oxy
)

1116 
addršfo
 
addršfo_tmp
 = *
addr
;

1117 
addršfo_tmp
.
ai_sockty³
 = 
SOCK_STREAM
;

1118 
addršfo_tmp
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

1119 
sock
->
ù¾_sd
 = 
	`ü—‹_sock‘_tı
(&
addršfo_tmp
);

1122 ià(
addr
->
ai_´ÙocŞ
 =ğ
IPPROTO_TCP
 ||‡ddr->
ai_sockty³
 =ğ
SOCK_STREAM
)

1124 
sock
->
sd
 = 
	`ü—‹_sock‘_tı
(
addr
);

1128 
	`ASSERT
(0);

1131 
	`sock‘_£t_bufãrs
(
sock
->
sd
, &sock->
sock‘_bufãr_sizes
);

1134 
	`sock‘_£t_m¬k
(
sock
->
sd
, sock->
m¬k
);

1136 
	`bšd_loÿl
(
sock
, 
addr
->
ai_çmy
);

1137 
	}
}

1139 #ifdeà
TARGET_ANDROID


1141 
	$´Ùeù_fd_nÚloÿl
(
fd
, cÚ¡ 
sockaddr
 *
addr
)

1146 ià(
	`addr_loÿl
(
addr
))

1148 
	`msg
(
D_SOCKET_DEBUG
, "Add»s i loÿl,‚Ù…rÙeùšg sock‘ fd %d", 
fd
);

1152 
	`msg
(
D_SOCKET_DEBUG
, "PrÙeùšg sock‘ fd %d", 
fd
);

1153 
mªagem’t
->
cÚÃùiÚ
.
fdto£nd
 = 
fd
;

1154 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "PROTECTFD", 
__func__
);

1155 
	}
}

1162 
	$sock‘_do_li¡’
(
sock‘_desütÜ_t
 
sd
,

1163 cÚ¡ 
addršfo
 *
loÿl
,

1164 
boŞ
 
do_li¡’
,

1165 
boŞ
 
do_£t_nÚblock
)

1167 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1168 ià(
do_li¡’
)

1170 
	`ASSERT
(
loÿl
);

1171 
	`msg
(
M_INFO
, "Listening for incoming TCP connection on %s",

1172 
	`´št_sockaddr
(
loÿl
->
ai_addr
, &
gc
));

1173 ià(
	`li¡’
(
sd
, 1))

1175 
	`msg
(
M_ERR
, "TCP:†isten() failed");

1180 ià(
do_£t_nÚblock
)

1182 
	`£t_nÚblock
(
sd
);

1185 
	`gc_ä“
(&
gc
);

1186 
	}
}

1188 
sock‘_desütÜ_t


1189 
	$sock‘_do_acû±
(
sock‘_desütÜ_t
 
sd
,

1190 
lšk_sock‘_aùu®
 *
aù
,

1191 cÚ¡ 
boŞ
 
nowa™
)

1197 
sockËn_t
 
»mÙe_Ën_af
 = 
	`af_addr_size
(
aù
->
de¡
.
addr
.
§
.
§_çmy
);

1198 
sockËn_t
 
»mÙe_Ën
 = (
aù
->
de¡
.
addr
);

1199 
sock‘_desütÜ_t
 
Ãw_sd
 = 
SOCKET_UNDEFINED
;

1201 
	`CLEAR
(*
aù
);

1203 #ifdeà
HAVE_GETPEERNAME


1204 ià(
nowa™
)

1206 
Ãw_sd
 = 
	`g‘³”Çme
(
sd
, &
aù
->
de¡
.
addr
.
§
, &
»mÙe_Ën
);

1208 ià(!
	`sock‘_defšed
(
Ãw_sd
))

1210 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP: getpeername() failed");

1214 
Ãw_sd
 = 
sd
;

1218 ià(
nowa™
)

1220 
	`msg
(
M_WARN
, "TCP:his OS does‚ot…rovidehe getpeername() function");

1225 
Ãw_sd
 = 
	`acû±
(
sd
, &
aù
->
de¡
.
addr
.
§
, &
»mÙe_Ën
);

1230 
foo
 = 0;

1231 ++
foo
;

1232 ià(
foo
 & 1)

1234 
Ãw_sd
 = -1;

1239 ià(!
	`sock‘_defšed
(
Ãw_sd
))

1241 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP:‡cû±(%dèçed", ()
sd
);

1244 ià(
»mÙe_Ën_af
 && 
»mÙe_Ën
 !=„emote_len_af)

1246 
	`msg
(
D_LINK_ERRORS
, "TCP: Reûived sŒªgšcomšg cÚÃùiÚ w™h unknowÀadd»s Ëngth=%d", 
»mÙe_Ën
);

1247 
	`İ’v²_şo£_sock‘
(
Ãw_sd
);

1248 
Ãw_sd
 = 
SOCKET_UNDEFINED
;

1254 
	`£t_şÛxec
(
sd
);

1256  
Ãw_sd
;

1257 
	}
}

1260 
	$tı_cÚÃùiÚ_e¡ablished
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
)

1262 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1263 
	`msg
(
M_INFO
, "TCP connectionƒstablished with %s",

1264 
	`´št_lšk_sock‘_aùu®
(
aù
, &
gc
));

1265 
	`gc_ä“
(&
gc
);

1266 
	}
}

1268 
sock‘_desütÜ_t


1269 
	$sock‘_li¡’_acû±
(
sock‘_desütÜ_t
 
sd
,

1270 
lšk_sock‘_aùu®
 *
aù
,

1271 cÚ¡ *
»mÙe_dyÇmic
,

1272 cÚ¡ 
addršfo
 *
loÿl
,

1273 
boŞ
 
do_li¡’
,

1274 
boŞ
 
nowa™
,

1275 vŞ©*
sigÇl_»ûived
)

1277 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1279 
İ’v²_sockaddr
 
»mÙe_v”ify
 = 
aù
->
de¡
;

1280 
sock‘_desütÜ_t
 
Ãw_sd
 = 
SOCKET_UNDEFINED
;

1282 
	`CLEAR
(*
aù
);

1283 
	`sock‘_do_li¡’
(
sd
, 
loÿl
, 
do_li¡’
, 
Œue
);

1285 
Œue
)

1287 
¡©us
;

1288 
fd_£t
 
»ads
;

1289 
timev®
 
tv
;

1291 
	`FD_ZERO
(&
»ads
);

1292 
	`İ’v²_fd_£t
(
sd
, &
»ads
);

1293 
tv
.
tv_£c
 = 0;

1294 
tv
.
tv_u£c
 = 0;

1296 
¡©us
 = 
	`£Ëù
(
sd
 + 1, &
»ads
, 
NULL
, NULL, &
tv
);

1298 
	`g‘_sigÇl
(
sigÇl_»ûived
);

1299 ià(*
sigÇl_»ûived
)

1301 
	`gc_ä“
(&
gc
);

1302  
sd
;

1305 ià(
¡©us
 < 0)

1307 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "TCP: select() failed");

1310 ià(
¡©us
 <= 0)

1312 
	`mªagem’t_¦“p
(1);

1316 
Ãw_sd
 = 
	`sock‘_do_acû±
(
sd
, 
aù
, 
nowa™
);

1318 ià(
	`sock‘_defšed
(
Ãw_sd
))

1320 
addršfo
 *
ai
 = 
NULL
;

1321 ià(
»mÙe_dyÇmic
)

1323 
	`İ’v²_g‘addršfo
(0, 
»mÙe_dyÇmic
, 
NULL
, 1, NULL,

1324 
»mÙe_v”ify
.
addr
.
§
.
§_çmy
, &
ai
);

1327 ià(
ai
 && !
	`add¾i¡_m©ch
(&
»mÙe_v”ify
,‡i))

1329 
	`msg
(
M_WARN
,

1331 
	`´št_lšk_sock‘_aùu®
(
aù
, &
gc
));

1332 ià(
	`İ’v²_şo£_sock‘
(
Ãw_sd
))

1334 
	`msg
(
M_ERR
, "TCP: close socket failed (new_sd)");

1336 
	`ä“addršfo
(
ai
);

1340 ià(
ai
)

1342 
	`ä“addršfo
(
ai
);

1347 
	`mªagem’t_¦“p
(1);

1350 ià(!
nowa™
 && 
	`İ’v²_şo£_sock‘
(
sd
))

1352 
	`msg
(
M_ERR
, "TCP: close socket failed (sd)");

1355 
	`tı_cÚÃùiÚ_e¡ablished
(
aù
);

1357 
	`gc_ä“
(&
gc
);

1358  
Ãw_sd
;

1359 
	}
}

1364 #ifdeà
_WIN32


1365 #iâdeà
IPV6_V6ONLY


1366 
	#IPV6_V6ONLY
 27

	)

1370 
	$sock‘_bšd
(
sock‘_desütÜ_t
 
sd
,

1371 
addršfo
 *
loÿl
,

1372 
ai_çmy
,

1373 cÚ¡ *
´efix
,

1374 
boŞ
 
v6Úly
)

1376 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1385 
addršfo
 *
cur
;

1387 
	`ASSERT
(
loÿl
);

1391 
cur
 = 
loÿl
; cur; cu¸ğcur->
ai_Ãxt
)

1393 ià(
cur
->
ai_çmy
 ==‡i_family)

1398 ià(!
cur
)

1400 
	`msg
(
M_FATAL
, "%s: Socket bind failed: Addro bind has‚o %s„ecord",

1401 
´efix
, 
	`addr_çmy_Çme
(
ai_çmy
));

1404 ià(
ai_çmy
 =ğ
AF_INET6
)

1406 
v6Úly
 = 
v6Úly
 ? 1 : 0;

1408 
	`msg
(
M_INFO
, "£tsockİt(IPV6_V6ONLY=%d)", 
v6Úly
);

1409 ià(
	`£tsockİt
(
sd
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, (*è&
v6Úly
, (v6only)))

1411 
	`msg
(
M_NONFATAL
|
M_ERRNO
, "S‘tšg IPV6_V6ONLY=%d faed", 
v6Úly
);

1414 ià(
	`bšd
(
sd
, 
cur
->
ai_addr
, cur->
ai_add¾’
))

1416 
	`msg
(
M_FATAL
 | 
M_ERRNO
, "%s: Socket bind failed on†ocal‡ddress %s",

1417 
´efix
,

1418 
	`´št_sockaddr_ex
(
loÿl
->
ai_addr
, ":", 
PS_SHOW_PORT
, &
gc
));

1420 
	`gc_ä“
(&
gc
);

1421 
	}
}

1424 
	$İ’v²_cÚÃù
(
sock‘_desütÜ_t
 
sd
,

1425 cÚ¡ 
sockaddr
 *
»mÙe
,

1426 
cÚÃù_timeout
,

1427 vŞ©*
sigÇl_»ûived
)

1429 
¡©us
 = 0;

1431 #ifdeà
TARGET_ANDROID


1432 
	`´Ùeù_fd_nÚloÿl
(
sd
, 
»mÙe
);

1435 #ifdeà
CONNECT_NONBLOCK


1436 
	`£t_nÚblock
(
sd
);

1437 
¡©us
 = 
	`cÚÃù
(
sd
, 
»mÙe
, 
	`af_addr_size
ÔemÙe->
§_çmy
));

1438 ià(
¡©us
)

1440 
¡©us
 = 
	`İ’v²_”ºo
();

1443 #ifdeà
_WIN32


1444 
¡©us
 =ğ
WSAEWOULDBLOCK


1446 
¡©us
 =ğ
EINPROGRESS


1450 
Œue
)

1452 #ià
POLL


1453 
pŞlfd
 
fds
[1];

1454 
fds
[0].
fd
 = 
sd
;

1455 
fds
[0].
ev’ts
 = 
POLLOUT
;

1456 
¡©us
 = 
	`pŞl
(
fds
, 1, 0);

1458 
fd_£t
 
wr™es
;

1459 
timev®
 
tv
;

1461 
	`FD_ZERO
(&
wr™es
);

1462 
	`İ’v²_fd_£t
(
sd
, &
wr™es
);

1463 
tv
.
tv_£c
 = 0;

1464 
tv
.
tv_u£c
 = 0;

1466 
¡©us
 = 
	`£Ëù
(
sd
 + 1, 
NULL
, &
wr™es
, NULL, &
tv
);

1468 ià(
sigÇl_»ûived
)

1470 
	`g‘_sigÇl
(
sigÇl_»ûived
);

1471 ià(*
sigÇl_»ûived
)

1473 
¡©us
 = 0;

1477 ià(
¡©us
 < 0)

1479 
¡©us
 = 
	`İ’v²_”ºo
();

1482 ià(
¡©us
 <= 0)

1484 ià(--
cÚÃù_timeout
 < 0)

1486 #ifdeà
_WIN32


1487 
¡©us
 = 
WSAETIMEDOUT
;

1489 
¡©us
 = 
ETIMEDOUT
;

1493 
	`mªagem’t_¦“p
(1);

1499 
v®
 = 0;

1500 
sockËn_t
 
Ën
;

1502 
Ën
 = (
v®
);

1503 ià(
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_ERROR
, (*è&
v®
, &
Ën
) == 0

1504 && 
Ën
 =ğ(
v®
))

1506 
¡©us
 = 
v®
;

1510 
¡©us
 = 
	`İ’v²_”ºo
();

1517 
¡©us
 = 
	`cÚÃù
(
sd
, 
»mÙe
, 
	`af_addr_size
ÔemÙe->
§_çmy
));

1518 ià(
¡©us
)

1520 
¡©us
 = 
	`İ’v²_”ºo
();

1524  
¡©us
;

1525 
	}
}

1528 
	$£t_aùu®_add»ss
(
lšk_sock‘_aùu®
 *
aùu®
, 
addršfo
 *
ai
)

1530 
	`CLEAR
(*
aùu®
);

1531 
	`ASSERT
(
ai
);

1533 ià(
ai
->
ai_çmy
 =ğ
AF_INET
)

1535 
aùu®
->
de¡
.
addr
.
š4
 =

1536 *((
sockaddr_š
 *è
ai
->
ai_addr
);

1538 ià(
ai
->
ai_çmy
 =ğ
AF_INET6
)

1540 
aùu®
->
de¡
.
addr
.
š6
 =

1541 *((
sockaddr_š6
 *è
ai
->
ai_addr
);

1545 
	`ASSERT
(0);

1548 
	}
}

1551 
	$sock‘_cÚÃù
(
sock‘_desütÜ_t
 *
sd
,

1552 cÚ¡ 
sockaddr
 *
de¡
,

1553 cÚ¡ 
cÚÃù_timeout
,

1554 
sigÇl_šfo
 *
sig_šfo
)

1556 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1557 
¡©us
;

1559 #ifdeà
CONNECT_NONBLOCK


1560 
	`msg
(
M_INFO
, "Attemptingoƒstablish TCP connection with %s [nonblock]",

1561 
	`´št_sockaddr
(
de¡
, &
gc
));

1563 
	`msg
(
M_INFO
, "Attemptingoƒstablish TCP connection with %s",

1564 
	`´št_sockaddr
(
de¡
, &
gc
));

1567 #ifdeà
ENABLE_MANAGEMENT


1568 ià(
mªagem’t
)

1570 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

1571 
OPENVPN_STATE_TCP_CONNECT
,

1572 
NULL
,

1573 
NULL
,

1574 
NULL
,

1575 
NULL
,

1576 
NULL
);

1581 
¡©us
 = 
	`İ’v²_cÚÃù
(*
sd
, 
de¡
, 
cÚÃù_timeout
, &
sig_šfo
->
sigÇl_»ûived
);

1583 
	`g‘_sigÇl
(&
sig_šfo
->
sigÇl_»ûived
);

1584 ià(
sig_šfo
->
sigÇl_»ûived
)

1586 
dÚe
;

1589 ià(
¡©us
)

1592 
	`msg
(
D_LINK_ERRORS
, "TCP: connecto %s failed: %s",

1593 
	`´št_sockaddr
(
de¡
, &
gc
), 
	`¡»¼Ü
(
¡©us
));

1595 
	`İ’v²_şo£_sock‘
(*
sd
);

1596 *
sd
 = 
SOCKET_UNDEFINED
;

1597 
sig_šfo
->
sigÇl_»ûived
 = 
SIGUSR1
;

1598 
sig_šfo
->
sourû
 = 
SIG_SOURCE_CONNECTION_FAILED
;

1602 
	`msg
(
M_INFO
, "TCP connectionƒstablished with %s",

1603 
	`´št_sockaddr
(
de¡
, &
gc
));

1606 
dÚe
:

1607 
	`gc_ä“
(&
gc
);

1608 
	}
}

1614 
	$sock‘_äame_š™
(cÚ¡ 
äame
 *äame, 
lšk_sock‘
 *
sock
)

1616 #ifdeà
_WIN32


1617 
	`ov”Ïµed_io_š™
(&
sock
->
»ads
, 
äame
, 
FALSE
, 
çl£
);

1618 
	`ov”Ïµed_io_š™
(&
sock
->
wr™es
, 
äame
, 
TRUE
, 
çl£
);

1619 
sock
->
rw_hªdË
.
»ad
 = sock->
»ads
.
ov”Ïµed
.
hEv’t
;

1620 
sock
->
rw_hªdË
.
wr™e
 = sock->
wr™es
.
ov”Ïµed
.
hEv’t
;

1623 ià(
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
sock
))

1625 #ifdeà
_WIN32


1626 
	`¡»am_buf_š™
(&
sock
->
¡»am_buf
,

1627 &
sock
->
»ads
.
buf_š™
,

1628 
sock
->
sockæags
,

1629 
sock
->
šfo
.
´Ùo
);

1631 
	`®loc_buf_sock_tun
(&
sock
->
¡»am_buf_d©a
,

1632 
äame
,

1633 
çl£
,

1634 
FRAME_HEADROOM_MARKER_READ_STREAM
);

1636 
	`¡»am_buf_š™
(&
sock
->
¡»am_buf
,

1637 &
sock
->
¡»am_buf_d©a
,

1638 
sock
->
sockæags
,

1639 
sock
->
šfo
.
´Ùo
);

1642 
	}
}

1649 
	$äame_adju¡_·th_mtu
(
äame
 *äame, 
pmtu
, 
´Ùo
)

1651 
	`äame_£t_mtu_dyÇmic
(
äame
, 
pmtu
 - 
	`d©ag¿m_ov”h—d
(
´Ùo
), 
SET_MTU_UPPER_BOUND
);

1652 
	}
}

1655 
	$»sŞve_bšd_loÿl
(
lšk_sock‘
 *
sock
, cÚ¡ 
§_çmy_t
 
af
)

1657 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1660 ià(!
sock
->
šfo
.
l§
->
bšd_loÿl
)

1662 
æags
 = 
GETADDR_RESOLVE
 | 
GETADDR_WARN_ON_SIGNAL


1663 |
GETADDR_FATAL
 | 
GETADDR_PASSIVE
;

1664 
¡©us
;

1666 ià(
	`´Ùo_is_dg¿m
(
sock
->
šfo
.
´Ùo
))

1668 
æags
 |ğ
GETADDR_DATAGRAM
;

1672 
¡©us
 = 
	`g‘_ÿched_dns_’Œy
(
sock
->
dns_ÿche
,

1673 
sock
->
loÿl_ho¡
,

1674 
sock
->
loÿl_pÜt
,

1675 
af
,

1676 
æags
,

1677 &
sock
->
šfo
.
l§
->
bšd_loÿl
);

1679 ià(
¡©us
)

1681 
¡©us
 = 
	`İ’v²_g‘addršfo
(
æags
, 
sock
->
loÿl_ho¡
, sock->
loÿl_pÜt
, 0,

1682 
NULL
, 
af
, &
sock
->
šfo
.
l§
->
bšd_loÿl
);

1685 ià(
¡©us
 !=0)

1687 
	`msg
(
M_FATAL
, "getaddrinfo() failed for†ocal \"%s:%s\": %s",

1688 
sock
->
loÿl_ho¡
, sock->
loÿl_pÜt
,

1689 
	`gai_¡»¼Ü
(
¡©us
));

1693 
	`gc_ä“
(&
gc
);

1694 
	}
}

1697 
	$»sŞve_»mÙe
(
lšk_sock‘
 *
sock
,

1698 
pha£
,

1699 cÚ¡ **
»mÙe_dyÇmic
,

1700 vŞ©*
sigÇl_»ûived
)

1702 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1705 ià(!
sock
->
šfo
.
l§
->
»mÙe_li¡
)

1707 ià(
sock
->
»mÙe_ho¡
)

1709 
æags
 = 
	`sf2gaf
(
GETADDR_RESOLVE
|
GETADDR_UPDATE_MANAGEMENT_STATE
, 
sock
->
sockæags
);

1710 
»Œy
 = 0;

1711 
¡©us
 = -1;

1712 
addršfo
 *
ai
;

1713 ià(
	`´Ùo_is_dg¿m
(
sock
->
šfo
.
´Ùo
))

1715 
æags
 |ğ
GETADDR_DATAGRAM
;

1718 ià(
sock
->
»sŞve_»Œy_£cÚds
 =ğ
RESOLV_RETRY_INFINITE
)

1720 ià(
pha£
 == 2)

1722 
æags
 |ğ(
GETADDR_TRY_ONCE
 | 
GETADDR_FATAL
);

1724 
»Œy
 = 0;

1726 ià(
pha£
 == 1)

1728 ià(
sock
->
»sŞve_»Œy_£cÚds
)

1730 
»Œy
 = 0;

1734 
æags
 |ğ(
GETADDR_FATAL
 | 
GETADDR_MENTION_RESOLVE_RETRY
);

1735 
»Œy
 = 0;

1738 ià(
pha£
 == 2)

1740 ià(
sock
->
»sŞve_»Œy_£cÚds
)

1742 
æags
 |ğ
GETADDR_FATAL
;

1743 
»Œy
 = 
sock
->
»sŞve_»Œy_£cÚds
;

1747 
	`ASSERT
(0);

1752 
	`ASSERT
(0);

1756 
¡©us
 = 
	`g‘_ÿched_dns_’Œy
(
sock
->
dns_ÿche
,

1757 
sock
->
»mÙe_ho¡
,

1758 
sock
->
»mÙe_pÜt
,

1759 
sock
->
šfo
.
af
,

1760 
æags
, &
ai
);

1761 ià(
¡©us
)

1763 
¡©us
 = 
	`İ’v²_g‘addršfo
(
æags
, 
sock
->
»mÙe_ho¡
, sock->
»mÙe_pÜt
,

1764 
»Œy
, 
sigÇl_»ûived
, 
sock
->
šfo
.
af
, &
ai
);

1767 ià(
¡©us
 == 0)

1769 
sock
->
šfo
.
l§
->
»mÙe_li¡
 = 
ai
;

1770 
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
 = 
ai
;

1772 
	`dmsg
(
D_SOCKET_DEBUG
, "RESOLVE_REMOTE flags=0x%04x…hase=%d„rs=%d sig=%d status=%d",

1773 
æags
,

1774 
pha£
,

1775 
»Œy
,

1776 
sigÇl_»ûived
 ? *signal_received : -1,

1777 
¡©us
);

1779 ià(
sigÇl_»ûived
)

1781 ià(*
sigÇl_»ûived
)

1783 
dÚe
;

1786 ià(
¡©us
!=0)

1788 ià(
sigÇl_»ûived
)

1790 *
sigÇl_»ûived
 = 
SIGUSR1
;

1792 
dÚe
;

1798 ià(
	`lšk_sock‘_aùu®_defšed
(&
sock
->
šfo
.
l§
->
aùu®
))

1800 
	`msg
(
M_INFO
, "TCP/UDP: Preserving„ecently used„emote‡ddress: %s",

1801 
	`´št_lšk_sock‘_aùu®
(&
sock
->
šfo
.
l§
->
aùu®
, &
gc
));

1802 ià(
»mÙe_dyÇmic
)

1804 *
»mÙe_dyÇmic
 = 
NULL
;

1809 
	`CLEAR
(
sock
->
šfo
.
l§
->
aùu®
);

1810 ià(
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
)

1812 
	`£t_aùu®_add»ss
(&
sock
->
šfo
.
l§
->
aùu®
,

1813 
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
);

1817 
dÚe
:

1818 
	`gc_ä“
(&
gc
);

1819 
	}
}

1823 
lšk_sock‘
 *

1824 
	$lšk_sock‘_Ãw
()

1826 
lšk_sock‘
 *
sock
;

1828 
	`ALLOC_OBJ_CLEAR
(
sock
, 
lšk_sock‘
);

1829 
sock
->
sd
 = 
SOCKET_UNDEFINED
;

1830 
sock
->
ù¾_sd
 = 
SOCKET_UNDEFINED
;

1831  
sock
;

1832 
	}
}

1835 
lšk_sock‘_š™_pha£1
(
lšk_sock‘
 *
sock
,

1836 cÚ¡ *
loÿl_ho¡
,

1837 cÚ¡ *
loÿl_pÜt
,

1838 cÚ¡ *
»mÙe_ho¡
,

1839 cÚ¡ *
»mÙe_pÜt
,

1840 
ÿched_dns_’Œy
 *
dns_ÿche
,

1841 
´Ùo
,

1842 
§_çmy_t
 
af
,

1843 
boŞ
 
bšd_v6_Úly
,

1844 
mode
,

1845 cÚ¡ 
lšk_sock‘
 *
acû±_äom
,

1846 
h‰p_´oxy_šfo
 *
h‰p_´oxy
,

1847 
socks_´oxy_šfo
 *
socks_´oxy
,

1848 #ifdeà
ENABLE_DEBUG


1849 
g»mlš
,

1851 
boŞ
 
bšd_loÿl
,

1852 
boŞ
 
»mÙe_æßt
,

1853 
š‘d
,

1854 
lšk_sock‘_addr
 *
l§
,

1855 cÚ¡ *
chªge_commªd
,

1856 cÚ¡ 
¶ugš_li¡
 *
¶ugšs
,

1857 
»sŞve_»Œy_£cÚds
,

1858 
mtu_discov”_ty³
,

1859 
rcvbuf
,

1860 
¢dbuf
,

1861 
m¬k
,

1862 
ev’t_timeout
 *
£rv”_pŞl_timeout
,

1863 
sockæags
)

1865 
ASSERT
(
sock
);

1867 
	gsock
->
	gloÿl_ho¡
 = 
loÿl_ho¡
;

1868 
	gsock
->
	gloÿl_pÜt
 = 
loÿl_pÜt
;

1869 
	gsock
->
	g»mÙe_ho¡
 = 
»mÙe_ho¡
;

1870 
	gsock
->
	g»mÙe_pÜt
 = 
»mÙe_pÜt
;

1871 
	gsock
->
	gdns_ÿche
 = 
dns_ÿche
;

1872 
	gsock
->
	gh‰p_´oxy
 = 
h‰p_´oxy
;

1873 
	gsock
->
	gsocks_´oxy
 = 
socks_´oxy
;

1874 
	gsock
->
	gbšd_loÿl
 = 
bšd_loÿl
;

1875 
	gsock
->
	gš‘d
 = 
š‘d
;

1876 
	gsock
->
	g»sŞve_»Œy_£cÚds
 = 
»sŞve_»Œy_£cÚds
;

1877 
	gsock
->
	gmtu_discov”_ty³
 = 
mtu_discov”_ty³
;

1879 #ifdeà
ENABLE_DEBUG


1880 
	gsock
->
	gg»mlš
 = 
g»mlš
;

1883 
	gsock
->
	gsock‘_bufãr_sizes
.
	grcvbuf
 = 
rcvbuf
;

1884 
	gsock
->
	gsock‘_bufãr_sizes
.
	g¢dbuf
 = 
¢dbuf
;

1886 
	gsock
->
	gsockæags
 = 
sockæags
;

1887 
	gsock
->
	gm¬k
 = 
m¬k
;

1889 
	gsock
->
	gšfo
.
	g´Ùo
 = 
´Ùo
;

1890 
	gsock
->
	gšfo
.
	gaf
 = 
af
;

1891 
	gsock
->
	gšfo
.
	g»mÙe_æßt
 = 
»mÙe_æßt
;

1892 
	gsock
->
	gšfo
.
	gl§
 = 
l§
;

1893 
	gsock
->
	gšfo
.
	gbšd_v6_Úly
 = 
bšd_v6_Úly
;

1894 
	gsock
->
	gšfo
.
	gchªge_commªd
 = 
chªge_commªd
;

1895 
	gsock
->
	gšfo
.
	g¶ugšs
 = 
¶ugšs
;

1896 
	gsock
->
	g£rv”_pŞl_timeout
 = 
£rv”_pŞl_timeout
;

1898 
	gsock
->
	gmode
 = 
mode
;

1899 ià(
	gmode
 =ğ
LS_MODE_TCP_ACCEPT_FROM
)

1901 
ASSERT
(
acû±_äom
);

1902 
ASSERT
(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_TCP_SERVER
);

1903 
ASSERT
(!
sock
->
š‘d
);

1904 
	gsock
->
	gsd
 = 
acû±_äom
->
sd
;

1906 
	gsock
->
	gšfo
.
	gaf
 = 
acû±_äom
->
šfo
.
af
;

1910 ià(
	gsock
->
	gh‰p_´oxy
)

1912 
ASSERT
(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_TCP_CLIENT
);

1913 
ASSERT
(!
sock
->
š‘d
);

1916 
	gsock
->
	g»mÙe_ho¡
 = 
h‰p_´oxy
->
İtiÚs
.
£rv”
;

1917 
	gsock
->
	g»mÙe_pÜt
 = 
h‰p_´oxy
->
İtiÚs
.
pÜt
;

1920 
	gsock
->
	g´oxy_de¡_ho¡
 = 
»mÙe_ho¡
;

1921 
	gsock
->
	g´oxy_de¡_pÜt
 = 
»mÙe_pÜt
;

1924 ià(
	gsock
->
	gsocks_´oxy
)

1926 
ASSERT
(!
sock
->
š‘d
);

1929 
	gsock
->
	g»mÙe_ho¡
 = 
socks_´oxy
->
£rv”
;

1930 
	gsock
->
	g»mÙe_pÜt
 = 
socks_´oxy
->
pÜt
;

1933 
	gsock
->
	g´oxy_de¡_ho¡
 = 
»mÙe_ho¡
;

1934 
	gsock
->
	g´oxy_de¡_pÜt
 = 
»mÙe_pÜt
;

1938 
	gsock
->
	g»mÙe_ho¡
 = 
»mÙe_ho¡
;

1939 
	gsock
->
	g»mÙe_pÜt
 = 
»mÙe_pÜt
;

1943 ià(
	gsock
->
	gšfo
.
	g´Ùo
 =ğ
PROTO_TCP_SERVER
)

1945 ià(
sock
->
mode
 =ğ
LS_MODE_TCP_ACCEPT_FROM
)

1947 
sock
->
bšd_loÿl
 = 
çl£
;

1951 
	gsock
->
	gbšd_loÿl
 = 
Œue
;

1956 ià(
	gsock
->
	gš‘d
)

1958 
ASSERT
(
sock
->
šfo
.
´Ùo
 !ğ
PROTO_TCP_CLIENT
);

1959 
ASSERT
(
sock‘_defšed
(
š‘d_sock‘_desütÜ
));

1960 
	gsock
->
	gsd
 = 
š‘d_sock‘_desütÜ
;

1961 
£t_şÛxec
(
sock
->
sd
);

1963 ià(
	gmode
 !ğ
LS_MODE_TCP_ACCEPT_FROM
)

1965 ià(
sock
->
bšd_loÿl
)

1967 
»sŞve_bšd_loÿl
(
sock
, sock->
šfo
.
af
);

1969 
»sŞve_»mÙe
(
sock
, 1, 
NULL
, NULL);

1975 
	$pha£2_š‘d
(
lšk_sock‘
 *
sock
, cÚ¡ 
äame
 *frame,

1976 cÚ¡ *
»mÙe_dyÇmic
, vŞ©*
sigÇl_»ûived
)

1978 
boŞ
 
»mÙe_chªged
 = 
çl£
;

1980 ià(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_TCP_SERVER
)

1983 
sock
->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 = 
AF_INET
;

1984 #ifdeà
HAVE_GETSOCKNAME


1987 
İ’v²_sockaddr
 
loÿl_addr
;

1988 
sockËn_t
 
add¾’
 = (
loÿl_addr
);

1989 ià(
	`g‘sockÇme
(
sock
->
sd
, &
loÿl_addr
.
addr
.
§
, &
add¾’
) == 0)

1991 
sock
->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 = 
loÿl_addr
.addr.sa.sa_family;

1992 
	`dmsg
(
D_SOCKET_DEBUG
, "inetd(%s): using sa_family=%d from getsockname(%d)",

1993 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
çl£
),

1994 
loÿl_addr
.
addr
.
§
.
§_çmy
, ()
sock
->
sd
);

1998 
	`msg
(
M_WARN
, "inetd(%s): getsockname(%d) failed, using AF_INET",

1999 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
çl£
), ()sock->
sd
);

2003 
	`msg
(
M_WARN
, "inetd(%s):his OS does‚ot…rovidehe getsockname() "

2005 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, 
çl£
));

2007 
sock
->
sd
 =

2008 
	`sock‘_li¡’_acû±
(
sock
->
sd
,

2009 &
sock
->
šfo
.
l§
->
aùu®
,

2010 
»mÙe_dyÇmic
,

2011 
sock
->
šfo
.
l§
->
bšd_loÿl
,

2012 
çl£
,

2013 
sock
->
š‘d
 =ğ
INETD_NOWAIT
,

2014 
sigÇl_»ûived
);

2017 
	`ASSERT
(!
»mÙe_chªged
);

2018 
	}
}

2021 
	$pha£2_£t_sock‘_æags
(
lšk_sock‘
 *
sock
)

2024 
	`sock‘_£t_æags
(
sock
->
sd
, sock->
sockæags
);

2027 
	`£t_nÚblock
(
sock
->
sd
);

2030 
	`£t_mtu_discov”_ty³
(
sock
->
sd
, sock->
mtu_discov”_ty³
, sock->
šfo
.
af
);

2032 #ià
EXTENDED_SOCKET_ERROR_CAPABILITY


2034 
	`£t_sock_ex‹nded_”rÜ_·ssšg
(
sock
->
sd
);

2036 
	}
}

2040 
	$lšksock_´št_addr
(
lšk_sock‘
 *
sock
)

2042 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2043 cÚ¡ 
msgËv–
 = (
sock
->
mode
 =ğ
LS_MODE_TCP_ACCEPT_FROM
è? 
D_INIT_MEDIUM
 : 
M_INFO
;

2046 ià(
sock
->
š‘d
)

2048 
	`msg
(
msgËv–
, "% lšk†oÿl: [š‘d]", 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
));

2050 ià(
sock
->
bšd_loÿl
)

2052 
§_çmy_t
 
ai_çmy
 = 
sock
->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
;

2056 
addršfo
 *
cur
;

2057 
cur
 = 
sock
->
šfo
.
l§
->
bšd_loÿl
; cur; cu¸ğcur->
ai_Ãxt
)

2059 ià(!
ai_çmy
 ||‡i_çmy =ğ
cur
->ai_family)

2064 
	`ASSERT
(
cur
);

2065 
	`msg
(
msgËv–
, "%s†ink†ocal (bound): %s",

2066 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
),

2067 
	`´št_sockaddr
(
cur
->
ai_addr
,&
gc
));

2071 
	`msg
(
msgËv–
, "%s†ink†ocal: (not bound)",

2072 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
));

2076 
	`msg
(
msgËv–
, "%s†ink„emote: %s",

2077 
	`´Ùo2ascii
(
sock
->
šfo
.
´Ùo
, sock->šfo.
af
, 
Œue
),

2078 
	`´št_lšk_sock‘_aùu®_ex
(&
sock
->
šfo
.
l§
->
aùu®
,

2080 
PS_SHOW_PORT_IF_DEFINED
,

2081 &
gc
));

2082 
	`gc_ä“
(&
gc
);

2083 
	}
}

2086 
	$pha£2_tı_£rv”
(
lšk_sock‘
 *
sock
, cÚ¡ *
»mÙe_dyÇmic
,

2087 vŞ©*
sigÇl_»ûived
)

2089 
sock
->
mode
)

2091 
LS_MODE_DEFAULT
:

2092 
sock
->
sd
 = 
	`sock‘_li¡’_acû±
(sock->sd,

2093 &
sock
->
šfo
.
l§
->
aùu®
,

2094 
»mÙe_dyÇmic
,

2095 
sock
->
šfo
.
l§
->
bšd_loÿl
,

2096 
Œue
,

2097 
çl£
,

2098 
sigÇl_»ûived
);

2101 
LS_MODE_TCP_LISTEN
:

2102 
	`sock‘_do_li¡’
(
sock
->
sd
,

2103 
sock
->
šfo
.
l§
->
bšd_loÿl
,

2104 
Œue
,

2105 
çl£
);

2108 
LS_MODE_TCP_ACCEPT_FROM
:

2109 
sock
->
sd
 = 
	`sock‘_do_acû±
(sock->sd,

2110 &
sock
->
šfo
.
l§
->
aùu®
,

2111 
çl£
);

2112 ià(!
	`sock‘_defšed
(
sock
->
sd
))

2114 *
sigÇl_»ûived
 = 
SIGTERM
;

2117 
	`tı_cÚÃùiÚ_e¡ablished
(&
sock
->
šfo
.
l§
->
aùu®
);

2121 
	`ASSERT
(0);

2123 
	}
}

2127 
	$pha£2_tı_ş›Á
(
lšk_sock‘
 *
sock
, 
sigÇl_šfo
 *
sig_šfo
)

2129 
boŞ
 
´oxy_»Œy
 = 
çl£
;

2132 
	`sock‘_cÚÃù
(&
sock
->
sd
,

2133 
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
->
ai_addr
,

2134 
	`g‘_£rv”_pŞl_»maššg_time
(
sock
->
£rv”_pŞl_timeout
),

2135 
sig_šfo
);

2137 ià(
sig_šfo
->
sigÇl_»ûived
)

2142 ià(
sock
->
h‰p_´oxy
)

2144 
´oxy_»Œy
 = 
	`e¡ablish_h‰p_´oxy_·s¡hru
(
sock
->
h‰p_´oxy
,

2145 
sock
->
sd
,

2146 
sock
->
´oxy_de¡_ho¡
,

2147 
sock
->
´oxy_de¡_pÜt
,

2148 
sock
->
£rv”_pŞl_timeout
,

2149 &
sock
->
¡»am_buf
.
»sidu®
,

2150 &
sig_šfo
->
sigÇl_»ûived
);

2152 ià(
sock
->
socks_´oxy
)

2154 
	`e¡ablish_socks_´oxy_·s¡hru
(
sock
->
socks_´oxy
,

2155 
sock
->
sd
,

2156 
sock
->
´oxy_de¡_ho¡
,

2157 
sock
->
´oxy_de¡_pÜt
,

2158 &
sig_šfo
->
sigÇl_»ûived
);

2160 ià(
´oxy_»Œy
)

2162 
	`İ’v²_şo£_sock‘
(
sock
->
sd
);

2163 
sock
->
sd
 = 
	`ü—‹_sock‘_tı
(sock->
šfo
.
l§
->
cu¼’t_»mÙe
);

2166 } 
´oxy_»Œy
);

2168 
	}
}

2171 
	$pha£2_socks_ş›Á
(
lšk_sock‘
 *
sock
, 
sigÇl_šfo
 *
sig_šfo
)

2173 
	`sock‘_cÚÃù
(&
sock
->
ù¾_sd
,

2174 
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
->
ai_addr
,

2175 
	`g‘_£rv”_pŞl_»maššg_time
(
sock
->
£rv”_pŞl_timeout
),

2176 
sig_šfo
);

2178 ià(
sig_šfo
->
sigÇl_»ûived
)

2183 
	`e¡ablish_socks_´oxy_ud·ssoc
(
sock
->
socks_´oxy
,

2184 
sock
->
ù¾_sd
,

2185 
sock
->
sd
,

2186 &
sock
->
socks_»Ïy
.
de¡
,

2187 &
sig_šfo
->
sigÇl_»ûived
);

2189 ià(
sig_šfo
->
sigÇl_»ûived
)

2194 
sock
->
»mÙe_ho¡
 = sock->
´oxy_de¡_ho¡
;

2195 
sock
->
»mÙe_pÜt
 = sock->
´oxy_de¡_pÜt
;

2197 
	`addr_z”o_ho¡
(&
sock
->
šfo
.
l§
->
aùu®
.
de¡
);

2198 ià(
sock
->
šfo
.
l§
->
»mÙe_li¡
)

2200 
	`ä“addršfo
(
sock
->
šfo
.
l§
->
»mÙe_li¡
);

2201 
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
 = 
NULL
;

2202 
sock
->
šfo
.
l§
->
»mÙe_li¡
 = 
NULL
;

2205 
	`»sŞve_»mÙe
(
sock
, 1, 
NULL
, &
sig_šfo
->
sigÇl_»ûived
);

2206 
	}
}

2210 
	$lšk_sock‘_š™_pha£2
(
lšk_sock‘
 *
sock
,

2211 cÚ¡ 
äame
 *frame,

2212 
sigÇl_šfo
 *
sig_šfo
)

2214 cÚ¡ *
»mÙe_dyÇmic
 = 
NULL
;

2215 
sig_§ve
 = 0;

2217 
	`ASSERT
(
sock
);

2218 
	`ASSERT
(
sig_šfo
);

2220 ià(
sig_šfo
->
sigÇl_»ûived
)

2222 
sig_§ve
 = 
sig_šfo
->
sigÇl_»ûived
;

2223 
sig_šfo
->
sigÇl_»ûived
 = 0;

2227 
	`sock‘_äame_š™
(
äame
, 
sock
);

2234 ià(
sock
->
»sŞve_»Œy_£cÚds
)

2236 
»mÙe_dyÇmic
 = 
sock
->
»mÙe_ho¡
;

2240 ià(
sock
->
š‘d
)

2242 
	`pha£2_š‘d
(
sock
, 
äame
, 
»mÙe_dyÇmic
, &
sig_šfo
->
sigÇl_»ûived
);

2243 ià(
sig_šfo
->
sigÇl_»ûived
)

2245 
dÚe
;

2252 
	`»sŞve_»mÙe
(
sock
, 2, &
»mÙe_dyÇmic
, &
sig_šfo
->
sigÇl_»ûived
);

2255 ià(
sock
->
šfo
.
l§
->
cu¼’t_»mÙe
)

2257 
	`ü—‹_sock‘
(
sock
, sock->
šfo
.
l§
->
cu¼’t_»mÙe
);

2261 ià(
sock
->
sd
 =ğ
SOCKET_UNDEFINED
)

2266 ià(
sock
->
bšd_loÿl
 && !sock->
»mÙe_ho¡
 && sock->
šfo
.
l§
->bind_local)

2270 ià(
sock
->
šfo
.
af
 =ğ
AF_UNSPEC
)

2272 
	`msg
(
M_WARN
, "Could‚ot determine IPv4/IPv6…rotocol. Using %s",

2273 
	`addr_çmy_Çme
(
sock
->
šfo
.
l§
->
bšd_loÿl
->
ai_çmy
));

2274 
sock
->
šfo
.
af
 = sock->šfo.
l§
->
bšd_loÿl
->
ai_çmy
;

2277 
	`ü—‹_sock‘
(
sock
, sock->
šfo
.
l§
->
bšd_loÿl
);

2282 ià(
sock
->
sd
 =ğ
SOCKET_UNDEFINED
)

2284 
	`msg
(
M_WARN
, "Could‚ot determine IPv4/IPv6…rotocol");

2285 
sig_šfo
->
sigÇl_»ûived
 = 
SIGUSR1
;

2286 
dÚe
;

2289 ià(
sig_šfo
->
sigÇl_»ûived
)

2291 
dÚe
;

2294 ià(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_TCP_SERVER
)

2296 
	`pha£2_tı_£rv”
(
sock
, 
»mÙe_dyÇmic
,

2297 &
sig_šfo
->
sigÇl_»ûived
);

2299 ià(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_TCP_CLIENT
)

2301 
	`pha£2_tı_ş›Á
(
sock
, 
sig_šfo
);

2304 ià(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_UDP
 && sock->
socks_´oxy
)

2306 
	`pha£2_socks_ş›Á
(
sock
, 
sig_šfo
);

2308 #ifdeà
TARGET_ANDROID


2309 ià(
sock
->
sd
 != -1)

2311 
	`´Ùeù_fd_nÚloÿl
(
sock
->
sd
, &sock->
šfo
.
l§
->
aùu®
.
de¡
.
addr
.
§
);

2314 ià(
sig_šfo
->
sigÇl_»ûived
)

2316 
dÚe
;

2320 
	`pha£2_£t_sock‘_æags
(
sock
);

2321 
	`lšksock_´št_addr
(
sock
);

2323 
dÚe
:

2324 ià(
sig_§ve
)

2326 ià(!
sig_šfo
->
sigÇl_»ûived
)

2328 
sig_šfo
->
sigÇl_»ûived
 = 
sig_§ve
;

2331 
	}
}

2334 
	$lšk_sock‘_şo£
(
lšk_sock‘
 *
sock
)

2336 ià(
sock
)

2338 #ifdeà
ENABLE_DEBUG


2339 cÚ¡ 
g»mlš
 = 
	`GREMLIN_CONNECTION_FLOOD_LEVEL
(
sock
->gremlin);

2341 cÚ¡ 
g»mlš
 = 0;

2344 ià(
	`sock‘_defšed
(
sock
->
sd
))

2346 #ifdeà
_WIN32


2347 
	`şo£_Ãt_ev’t_wš32
(&
sock
->
li¡’_hªdË
, sock->
sd
, 0);

2349 ià(!
g»mlš
)

2351 
	`msg
(
D_LOW
, "TCP/UDP: Closing socket");

2352 ià(
	`İ’v²_şo£_sock‘
(
sock
->
sd
))

2354 
	`msg
(
M_WARN
 | 
M_ERRNO
, "TCP/UDP: Close Socket failed");

2357 
sock
->
sd
 = 
SOCKET_UNDEFINED
;

2358 #ifdeà
_WIN32


2359 ià(!
g»mlš
)

2361 
	`ov”Ïµed_io_şo£
(&
sock
->
»ads
);

2362 
	`ov”Ïµed_io_şo£
(&
sock
->
wr™es
);

2367 ià(
	`sock‘_defšed
(
sock
->
ù¾_sd
))

2369 ià(
	`İ’v²_şo£_sock‘
(
sock
->
ù¾_sd
))

2371 
	`msg
(
M_WARN
 | 
M_ERRNO
, "TCP/UDP: Close Socket (ctrl_sd) failed");

2373 
sock
->
ù¾_sd
 = 
SOCKET_UNDEFINED
;

2376 
	`¡»am_buf_şo£
(&
sock
->
¡»am_buf
);

2377 
	`ä“_buf
(&
sock
->
¡»am_buf_d©a
);

2378 ià(!
g»mlš
)

2380 
	`ä“
(
sock
);

2383 
	}
}

2387 
	$sock‘_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
´Ùo
)

2389 ià(
	`lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
´Ùo
))

2391 
	`äame_add_to_exŒa_äame
(
äame
, (
·ck‘_size_ty³
));

2393 
	}
}

2396 
	$£‹nv_Œu¡ed
(
’v_£t
 *
es
, cÚ¡ 
lšk_sock‘_šfo
 *
šfo
)

2398 
	`£‹nv_lšk_sock‘_aùu®
(
es
, "Œu¡ed", &
šfo
->
l§
->
aùu®
, 
SA_IP_PORT
);

2399 
	}
}

2402 
	$chªge_fmt
(cÚ¡ 
boŞ
 
šşude_cmd
, 
¬gv
 *¬gv, cÚ¡ 
lšk_sock‘_šfo
 *
šfo
, 
gc_¬’a
 *
gc
)

2404 cÚ¡ *
ho¡
 = 
	`´št_sockaddr_ex
(&
šfo
->
l§
->
aùu®
.
de¡
.
addr
.
§
, " ", 
PS_SHOW_PORT
, 
gc
);

2405 ià(
šşude_cmd
)

2407 
	`¬gv_·r£_cmd
(
¬gv
, 
šfo
->
chªge_commªd
);

2408 
	`¬gv_´štf_ÿt
(
¬gv
, "%s", 
ho¡
);

2412 
	`¬gv_´štf
(
¬gv
, "%s", 
ho¡
);

2415 
	}
}

2418 
	$lšk_sock‘_cÚÃùiÚ_š™Ÿ‹d
(cÚ¡ 
bufãr
 *
buf
,

2419 
lšk_sock‘_šfo
 *
šfo
,

2420 cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

2421 cÚ¡ *
commÚ_Çme
,

2422 
’v_£t
 *
es
)

2424 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2426 
šfo
->
l§
->
aùu®
 = *
aù
;

2427 
	`£‹nv_Œu¡ed
(
es
, 
šfo
);

2428 
šfo
->
cÚÃùiÚ_e¡ablished
 = 
Œue
;

2432 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

2433 ià(
commÚ_Çme
)

2435 
	`buf_´štf
(&
out
, "[%s] ", 
commÚ_Çme
);

2437 
	`buf_´štf
(&
out
, "P“¸CÚÃùiÚ In™Ÿ‹d w™h %s", 
	`´št_lšk_sock‘_aùu®
(&
šfo
->
l§
->
aùu®
, &
gc
));

2438 
	`msg
(
M_INFO
, "%s", 
	`BSTR
(&
out
));

2442 
	`£‹nv_¡r
(
es
, "commÚ_Çme", 
commÚ_Çme
);

2445 ià(
	`¶ugš_defšed
(
šfo
->
¶ugšs
, 
OPENVPN_PLUGIN_IPCHANGE
))

2447 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2448 
	`chªge_fmt
(
çl£
, &
¬gv
, 
šfo
, &
gc
);

2449 ià(
	`¶ugš_ÿÎ
(
šfo
->
¶ugšs
, 
OPENVPN_PLUGIN_IPCHANGE
, &
¬gv
, 
NULL
, 
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

2451 
	`msg
(
M_WARN
, "WARNING: ipchange…lugin call failed");

2453 
	`¬gv_»£t
(&
¬gv
);

2457 ià(
šfo
->
chªge_commªd
)

2459 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2460 
	`£‹nv_¡r
(
es
, "script_type", "ipchange");

2461 
	`chªge_fmt
(
Œue
, &
¬gv
, 
šfo
, &
gc
);

2462 
	`İ’v²_run_süt
(&
¬gv
, 
es
, 0, "--ipchange");

2463 
	`¬gv_»£t
(&
¬gv
);

2466 
	`gc_ä“
(&
gc
);

2467 
	}
}

2470 
	$lšk_sock‘_bad_šcomšg_addr
(
bufãr
 *
buf
,

2471 cÚ¡ 
lšk_sock‘_šfo
 *
šfo
,

2472 cÚ¡ 
lšk_sock‘_aùu®
 *
äom_addr
)

2474 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2475 
addršfo
 *
ai
;

2477 
äom_addr
->
de¡
.
addr
.
§
.
§_çmy
)

2479 
AF_INET
:

2480 
AF_INET6
:

2481 
	`msg
(
D_LINK_ERRORS
,

2483 
	`´št_lšk_sock‘_aùu®
(
äom_addr
, &
gc
),

2484 ()
äom_addr
->
de¡
.
addr
.
§
.
§_çmy
,

2485 
	`´št_sockaddr_ex
(
šfo
->
l§
->
»mÙe_li¡
->
ai_addr
,":",
PS_SHOW_PORT
, &
gc
));

2487 
ai
 = 
šfo
->
l§
->
»mÙe_li¡
->
ai_Ãxt
;‡i;‡i =‡i->ai_next)

2489 
	`msg
(
D_LINK_ERRORS
,"or from…eer‡ddress: %s",

2490 
	`´št_sockaddr_ex
(
ai
->
ai_addr
,":",
PS_SHOW_PORT
, &
gc
));

2494 
buf
->
Ën
 = 0;

2495 
	`gc_ä“
(&
gc
);

2496 
	}
}

2499 
	$lšk_sock‘_bad_outgošg_addr
()

2501 
	`dmsg
(
D_READ_WRITE
, "TCP/UDP: No outgoing‡ddresso send…acket");

2502 
	}
}

2504 
š_addr_t


2505 
	$lšk_sock‘_cu¼’t_»mÙe
(cÚ¡ 
lšk_sock‘_šfo
 *
šfo
)

2507 cÚ¡ 
lšk_sock‘_addr
 *
l§
 = 
šfo
->lsa;

2519 ià(
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 !ğ
AF_INET
)

2521  
IPV4_INVALID_ADDR
;

2524 ià(
	`lšk_sock‘_aùu®_defšed
(&
l§
->
aùu®
))

2526  
	`Áohl
(
l§
->
aùu®
.
de¡
.
addr
.
š4
.
sš_addr
.
s_addr
);

2528 ià(
l§
->
cu¼’t_»mÙe
)

2530  
	`Áohl
(((
sockaddr_š
 *)
l§
->
cu¼’t_»mÙe
->
ai_addr
)

2531 ->
sš_addr
.
s_addr
);

2537 
	}
}

2539 cÚ¡ 
š6_addr
 *

2540 
	$lšk_sock‘_cu¼’t_»mÙe_v6
(cÚ¡ 
lšk_sock‘_šfo
 *
šfo
)

2542 cÚ¡ 
lšk_sock‘_addr
 *
l§
 = 
šfo
->lsa;

2550 ià(
l§
->
aùu®
.
de¡
.
addr
.
§
.
§_çmy
 !ğ
AF_INET6
)

2552  
NULL
;

2555 ià(
	`lšk_sock‘_aùu®_defšed
(&
l§
->
aùu®
))

2557  &(
l§
->
aùu®
.
de¡
.
addr
.
š6
.
sš6_addr
);

2559 ià(
l§
->
cu¼’t_»mÙe
)

2561  &(((
sockaddr_š6
 *)
l§
->
cu¼’t_»mÙe
->
ai_addr
)->
sš6_addr
);

2565  
NULL
;

2567 
	}
}

2573 
	$sock‘_¡©
(cÚ¡ 
lšk_sock‘
 *
s
, 
rwæags
, 
gc_¬’a
 *
gc
)

2575 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

2576 ià(
s
)

2578 ià(
rwæags
 & 
EVENT_READ
)

2580 
	`buf_´štf
(&
out
, "S%s",

2581 (
s
->
rwæags_debug
 & 
EVENT_READ
) ? "R" : "r");

2582 #ifdeà
_WIN32


2583 
	`buf_´štf
(&
out
, "%s",

2584 
	`ov”Ïµed_io_¡©e_ascii
(&
s
->
»ads
));

2587 ià(
rwæags
 & 
EVENT_WRITE
)

2589 
	`buf_´štf
(&
out
, "S%s",

2590 (
s
->
rwæags_debug
 & 
EVENT_WRITE
) ? "W" : "w");

2591 #ifdeà
_WIN32


2592 
	`buf_´štf
(&
out
, "%s",

2593 
	`ov”Ïµed_io_¡©e_ascii
(&
s
->
wr™es
));

2599 
	`buf_´štf
(&
out
, "S?");

2601  
	`BSTR
(&
out
);

2602 
	}
}

2609 
šlše
 

2610 
	$¡»am_buf_»£t
(
¡»am_buf
 *
sb
)

2612 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: RESET");

2613 
sb
->
»sidu®_fuÎy_fÜmed
 = 
çl£
;

2614 
sb
->
buf
 = sb->
buf_š™
;

2615 
	`buf_»£t
(&
sb
->
Ãxt
);

2616 
sb
->
Ën
 = -1;

2617 
	}
}

2620 
	$¡»am_buf_š™
(
¡»am_buf
 *
sb
,

2621 
bufãr
 *
buf
,

2622 cÚ¡ 
sockæags
,

2623 cÚ¡ 
´Ùo
)

2625 
sb
->
buf_š™
 = *
buf
;

2626 
sb
->
maxËn
 = sb->
buf_š™
.
Ën
;

2627 
sb
->
buf_š™
.
Ën
 = 0;

2628 
sb
->
»sidu®
 = 
	`®loc_buf
(sb->
maxËn
);

2629 
sb
->
”rÜ
 = 
çl£
;

2630 #ià
PORT_SHARE


2631 
sb
->
pÜt_sh¬e_¡©e
 = ((
sockæags
 & 
SF_PORT_SHARE
è&& (
´Ùo
 =ğ
PROTO_TCP_SERVER
))

2632 ? 
PS_ENABLED


2633 : 
PS_DISABLED
;

2635 
	`¡»am_buf_»£t
(
sb
);

2637 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: INIT maxËn=%d", 
sb
->
maxËn
);

2638 
	}
}

2640 
šlše
 

2641 
	$¡»am_buf_£t_Ãxt
(
¡»am_buf
 *
sb
)

2644 
sb
->
Ãxt
 = sb->
buf
;

2645 
sb
->
Ãxt
.
off£t
 = sb->
buf
.off£ˆ+ sb->buf.
Ën
;

2646 
sb
->
Ãxt
.
Ën
 = (sb->ËÀ>ğ0 ? sb->ËÀ: sb->
maxËn
è- sb->
buf
.len;

2647 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: SET NEXT, buf=[%d,%d]‚ext=[%d,%d]†en=%d maxlen=%d",

2648 
sb
->
buf
.
off£t
, sb->buf.
Ën
,

2649 
sb
->
Ãxt
.
off£t
, sb->Ãxt.
Ën
,

2650 
sb
->
Ën
, sb->
maxËn
);

2651 
	`ASSERT
(
sb
->
Ãxt
.
Ën
 > 0);

2652 
	`ASSERT
(
	`buf_§ã
(&
sb
->
buf
, sb->
Ãxt
.
Ën
));

2653 
	}
}

2655 
šlše
 

2656 
	$¡»am_buf_g‘_fš®
(
¡»am_buf
 *
sb
, 
bufãr
 *
buf
)

2658 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: GET FINAL†en=%d",

2659 
	`buf_defšed
(&
sb
->
buf
è? sb->buf.
Ën
 : -1);

2660 
	`ASSERT
(
	`buf_defšed
(&
sb
->
buf
));

2661 *
buf
 = 
sb
->buf;

2662 
	}
}

2664 
šlše
 

2665 
	$¡»am_buf_g‘_Ãxt
(
¡»am_buf
 *
sb
, 
bufãr
 *
buf
)

2667 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: GET NEXT†en=%d",

2668 
	`buf_defšed
(&
sb
->
Ãxt
è? sb->Ãxt.
Ën
 : -1);

2669 
	`ASSERT
(
	`buf_defšed
(&
sb
->
Ãxt
));

2670 *
buf
 = 
sb
->
Ãxt
;

2671 
	}
}

2673 
boŞ


2674 
	$¡»am_buf_»ad_£tup_dowÜk
(
lšk_sock‘
 *
sock
)

2676 ià(
sock
->
¡»am_buf
.
»sidu®
.
Ën
 && !sock->¡»am_buf.
»sidu®_fuÎy_fÜmed
)

2678 
	`ASSERT
(
	`buf_cİy
(&
sock
->
¡»am_buf
.
buf
, &sock->¡»am_buf.
»sidu®
));

2679 
	`ASSERT
(
	`buf_š™
(&
sock
->
¡»am_buf
.
»sidu®
, 0));

2680 
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
 = 
	`¡»am_buf_added
(&sock->stream_buf, 0);

2681 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: RESIDUAL FULLY FORMED [%s],†en=%d",

2682 
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
 ? "YES" : "NO",

2683 
sock
->
¡»am_buf
.
»sidu®
.
Ën
);

2686 ià(!
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
)

2688 
	`¡»am_buf_£t_Ãxt
(&
sock
->
¡»am_buf
);

2690  !
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
;

2691 
	}
}

2693 
boŞ


2694 
	$¡»am_buf_added
(
¡»am_buf
 *
sb
,

2695 
Ëngth_added
)

2697 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: ADD†’gth_added=%d", 
Ëngth_added
);

2698 ià(
Ëngth_added
 > 0)

2700 
sb
->
buf
.
Ën
 +ğ
Ëngth_added
;

2705 ià(
sb
->
Ën
 < 0 && sb->
buf
.ËÀ>ğ(è(
·ck‘_size_ty³
))

2707 
·ck‘_size_ty³
 
Ãt_size
;

2709 #ià
PORT_SHARE


2710 ià(
sb
->
pÜt_sh¬e_¡©e
 =ğ
PS_ENABLED
)

2712 ià(!
	`is_İ’v²_´ÙocŞ
(&
sb
->
buf
))

2714 
	`msg
(
D_STREAM_ERRORS
, "Non-OpenVPN client…rotocol detected");

2715 
sb
->
pÜt_sh¬e_¡©e
 = 
PS_FOREIGN
;

2716 
sb
->
”rÜ
 = 
Œue
;

2717  
çl£
;

2721 
sb
->
pÜt_sh¬e_¡©e
 = 
PS_DISABLED
;

2726 
	`ASSERT
(
	`buf_»ad
(&
sb
->
buf
, &
Ãt_size
, (net_size)));

2727 
sb
->
Ën
 = 
	`Áohps
(
Ãt_size
);

2729 ià(
sb
->
Ën
 < 1 || sb->ËÀ> sb->
maxËn
)

2731 
	`msg
(
M_WARN
, "WARNING: BadƒnÿpsuÏ‹d…ack‘†’gth from…“¸(%d), which mu¡ b> 0‡nd <ğ%d --…Ëa£ƒnsu»h© --tun-mtu o¸--lšk-mtu i equ® oÀbÙh…“r --hi cÚd™iÚ could‡lsØšdiÿ‹‡…ossibË‡ùiv©ck oÀthTCP†šk -- [A‰em±šg„e¡¬t...]", 
sb
->
Ën
, sb->
maxËn
);

2732 
	`¡»am_buf_»£t
(
sb
);

2733 
sb
->
”rÜ
 = 
Œue
;

2734  
çl£
;

2739 ià(
sb
->
Ën
 > 0 && sb->
buf
.len >= sb->len)

2742 
	`ASSERT
(
	`buf_š™
(&
sb
->
»sidu®
, 0));

2743 ià(
sb
->
buf
.
Ën
 > sb->len)

2745 
	`ASSERT
(
	`buf_cİy_exûss
(&
sb
->
»sidu®
, &sb->
buf
, sb->
Ën
));

2747 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: ADD„eturned TRUE, buf_len=%d,„esidual_len=%d",

2748 
	`BLEN
(&
sb
->
buf
),

2749 
	`BLEN
(&
sb
->
»sidu®
));

2750  
Œue
;

2754 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: ADD„‘uºed FALSE (have=%d‚“d=%d)", 
sb
->
buf
.
Ën
, sb->len);

2755 
	`¡»am_buf_£t_Ãxt
(
sb
);

2756  
çl£
;

2758 
	}
}

2761 
	$¡»am_buf_şo£
(
¡»am_buf
 *
sb
)

2763 
	`ä“_buf
(&
sb
->
»sidu®
);

2764 
	}
}

2771 
ev’t_t


2772 
	$sock‘_li¡’_ev’t_hªdË
(
lšk_sock‘
 *
s
)

2774 #ifdeà
_WIN32


2775 ià(!
	`defšed_Ãt_ev’t_wš32
(&
s
->
li¡’_hªdË
))

2777 
	`š™_Ãt_ev’t_wš32
(&
s
->
li¡’_hªdË
, 
FD_ACCEPT
, s->
sd
, 0);

2779  &
s
->
li¡’_hªdË
;

2781  
s
->
sd
;

2783 
	}
}

2790 
	$´št_sockaddr_ex
(cÚ¡ 
sockaddr
 *
§
,

2791 cÚ¡ *
£·¿tÜ
,

2792 cÚ¡ 
æags
,

2793 
gc_¬’a
 *
gc
)

2795 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

2796 
boŞ
 
addr_is_defšed
 = 
çl£
;

2797 
ho¡addr
[
NI_MAXHOST
] = "";

2798 
£rvÇme
[
NI_MAXSERV
] = "";

2799 
¡©us
;

2801 
sockËn_t
 
§Ën
 = 0;

2802 
§
->
§_çmy
)

2804 
AF_INET
:

2805 ià(!(
æags
 & 
PS_DONT_SHOW_FAMILY
))

2807 
	`buf_puts
(&
out
, "[AF_INET]");

2809 
§Ën
 = (
sockaddr_š
);

2810 
addr_is_defšed
 = ((
sockaddr_š
 *è
§
)->
sš_addr
.
s_addr
 != 0;

2813 
AF_INET6
:

2814 ià(!(
æags
 & 
PS_DONT_SHOW_FAMILY
))

2816 
	`buf_puts
(&
out
, "[AF_INET6]");

2818 
§Ën
 = (
sockaddr_š6
);

2819 
addr_is_defšed
 = !
	`IN6_IS_ADDR_UNSPECIFIED
(&((
sockaddr_š6
 *è
§
)->
sš6_addr
);

2822 
AF_UNSPEC
:

2823 ià(!(
æags
 & 
PS_DONT_SHOW_FAMILY
))

2833 
	`ASSERT
(0);

2836 
¡©us
 = 
	`g‘Çmešfo
(
§
, 
§Ën
, 
ho¡addr
, (hostaddr),

2837 
£rvÇme
, (£rvÇme), 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

2839 ià(
¡©us
!=0)

2841 
	`buf_´štf
(&
out
,"[Çmešfo(è”r: %s]",
	`gai_¡»¼Ü
(
¡©us
));

2842  
	`BSTR
(&
out
);

2845 ià(!(
æags
 & 
PS_DONT_SHOW_ADDR
))

2847 ià(
addr_is_defšed
)

2849 
	`buf_puts
(&
out
, 
ho¡addr
);

2853 
	`buf_puts
(&
out
, "[undef]");

2857 ià((
æags
 & 
PS_SHOW_PORT
è|| (æag & 
PS_SHOW_PORT_IF_DEFINED
))

2859 ià(
£·¿tÜ
)

2861 
	`buf_puts
(&
out
, 
£·¿tÜ
);

2864 
	`buf_puts
(&
out
, 
£rvÇme
);

2867  
	`BSTR
(&
out
);

2868 
	}
}

2871 
	$´št_lšk_sock‘_aùu®
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
, 
gc_¬’a
 *
gc
)

2873  
	`´št_lšk_sock‘_aùu®_ex
(
aù
, ":", 
PS_SHOW_PORT
|
PS_SHOW_PKTINFO
, 
gc
);

2874 
	}
}

2876 #iâdeà
IF_NAMESIZE


2877 
	#IF_NAMESIZE
 16

	)

2881 
	$´št_lšk_sock‘_aùu®_ex
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

2882 cÚ¡ *
£·¿tÜ
,

2883 cÚ¡ 
æags
,

2884 
gc_¬’a
 *
gc
)

2886 ià(
aù
)

2888 
iâame
[
IF_NAMESIZE
] = "[undef]";

2889 
bufãr
 
out
 = 
	`®loc_buf_gc
(128, 
gc
);

2890 
	`buf_´štf
(&
out
, "%s", 
	`´št_sockaddr_ex
(&
aù
->
de¡
.
addr
.
§
, 
£·¿tÜ
, 
æags
, 
gc
));

2891 #ià
ENABLE_IP_PKTINFO


2892 ià((
æags
 & 
PS_SHOW_PKTINFO
è&& 
	`addr_defšed_i
(
aù
))

2894 
aù
->
de¡
.
addr
.
§
.
§_çmy
)

2896 
AF_INET
:

2898 
İ’v²_sockaddr
 
§
;

2899 
	`CLEAR
(
§
);

2900 
§
.
addr
.
š4
.
sš_çmy
 = 
AF_INET
;

2901 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

2902 
§
.
addr
.
š4
.
sš_addr
 = 
aù
->
pi
.š4.
i_¥ec_d¡
;

2903 
	`if_šdextÚame
(
aù
->
pi
.
š4
.
i_ifšdex
, 
iâame
);

2904 #–ià
	`defšed
(
IP_RECVDSTADDR
)

2905 
§
.
addr
.
š4
.
sš_addr
 = 
aù
->
pi
.in4;

2906 
iâame
[0] = 0;

2908 #”rÜ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
w™hout
 
IP_PKTINFO
 
xÜ
 
	`IP_RECVDSTADDR
 (
fix
 
sysh—d
.
h
)

2910 
	`buf_´štf
(&
out
, " (via %s%%%s)",

2911 
	`´št_sockaddr_ex
(&
§
.
addr
.§, 
£·¿tÜ
, 0, 
gc
),

2912 
iâame
);

2916 
AF_INET6
:

2918 
sockaddr_š6
 
sš6
;

2919 
buf
[
INET6_ADDRSTRLEN
] = "[undef]";

2920 
	`CLEAR
(
sš6
);

2921 
sš6
.
sš6_çmy
 = 
AF_INET6
;

2922 
sš6
.
sš6_addr
 = 
aù
->
pi
.
š6
.
i6_addr
;

2923 
	`if_šdextÚame
(
aù
->
pi
.
š6
.
i6_ifšdex
, 
iâame
);

2924 ià(
	`g‘Çmešfo
((
sockaddr
 *)&
sš6
, (
sockaddr_š6
),

2925 
buf
, (buf), 
NULL
, 0, 
NI_NUMERICHOST
) == 0)

2927 
	`buf_´štf
(&
out
, " (vŸ %s%%%s)", 
buf
, 
iâame
);

2931 
	`buf_´štf
(&
out
, " (vŸ [g‘Çmešfo(è”r]%%%s)", 
iâame
);

2938  
	`BSTR
(&
out
);

2944 
	}
}

2951 
	$´št_š_addr_t
(
š_addr_t
 
addr
, 
æags
, 
gc_¬’a
 *
gc
)

2953 
š_addr
 
Ÿ
;

2954 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

2956 ià(
addr
 || !(
æags
 & 
IA_EMPTY_IF_UNDEF
))

2958 
	`CLEAR
(
Ÿ
);

2959 
Ÿ
.
s_addr
 = (
æags
 & 
IA_NET_ORDER
è? 
addr
 : 
	`htÚl
(addr);

2961 
	`buf_´štf
(&
out
, "%s", 
	`š‘_Áß
(
Ÿ
));

2963  
	`BSTR
(&
out
);

2964 
	}
}

2971 
	$´št_š6_addr
(
š6_addr
 
a6
, 
æags
, 
gc_¬’a
 *
gc
)

2973 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

2974 
tmp_out_buf
[64];

2976 ià(
	`memcmp
(&
a6
, &
š6addr_ªy
, (a6)) != 0

2977 || !(
æags
 & 
IA_EMPTY_IF_UNDEF
))

2979 
	`š‘_Áİ
(
AF_INET6
, &
a6
, 
tmp_out_buf
, (tmp_out_buf)-1);

2980 
	`buf_´štf
(&
out
, "%s", 
tmp_out_buf
 );

2982  
	`BSTR
(&
out
);

2983 
	}
}

2985 #iâdeà
UINT8_MAX


2986 
	#UINT8_MAX
 0xff

	)

2992 
š6_addr


2993 
	$add_š6_addr
Ğ
š6_addr
 
ba£
, 
ušt32_t
 
add
 )

2995 
i
;

2997 
i
 = 15; i>=0 && 
add
 > 0; i--)

2999 
ÿ¼y
;

3000 
ušt32_t
 
h
;

3002 
h
 = (è
ba£
.
s6_addr
[
i
];

3003 
ba£
.
s6_addr
[
i
] = (
h
+
add
è& 
UINT8_MAX
;

3008 
ÿ¼y
 = ((
h
 & 0xffè+ (
add
 & 0xff)) >> 8;

3009 
add
 = (add>>8è+ 
ÿ¼y
;

3011  
ba£
;

3012 
	}
}

3016 
	$£‹nv_sockaddr
(
’v_£t
 *
es
, cÚ¡ *
Çme_´efix
, cÚ¡ 
İ’v²_sockaddr
 *
addr
, cÚ¡ 
æags
)

3018 
Çme_buf
[256];

3020 
buf
[128];

3021 
addr
->addr.
§
.
§_çmy
)

3023 
AF_INET
:

3024 ià(
æags
 & 
SA_IP_PORT
)

3026 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s_", 
Çme_´efix
);

3030 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s", 
Çme_´efix
);

3033 
	`£‹nv_¡r
(
es
, 
Çme_buf
, 
	`š‘_Áß
(
addr
->addr.
š4
.
sš_addr
));

3035 ià((
æags
 & 
SA_IP_PORT
è&& 
addr
->addr.
š4
.
sš_pÜt
)

3037 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s_pÜt", 
Çme_´efix
);

3038 
	`£‹nv_št
(
es
, 
Çme_buf
, 
	`Áohs
(
addr
->addr.
š4
.
sš_pÜt
));

3042 
AF_INET6
:

3043 ià(
	`IN6_IS_ADDR_V4MAPPED
Ğ&
addr
->addr.
š6
.
sš6_addr
 ))

3045 
š_addr
 
Ÿ
;

3046 
	`memıy
(&
Ÿ
.
s_addr
, &
addr
->addr.
š6
.
sš6_addr
.
s6_addr
[12],

3047 (
Ÿ
.
s_addr
));

3048 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s_", 
Çme_´efix
);

3049 
	`İ’v²_¢´štf
(
buf
, (buf), "%s", 
	`š‘_Áß
(
Ÿ
) );

3053 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s_6", 
Çme_´efix
);

3054 
	`g‘Çmešfo
(&
addr
->addr.
§
, (
sockaddr_š6
),

3055 
buf
, (buf), 
NULL
, 0, 
NI_NUMERICHOST
);

3057 
	`£‹nv_¡r
(
es
, 
Çme_buf
, 
buf
);

3059 ià((
æags
 & 
SA_IP_PORT
è&& 
addr
->addr.
š6
.
sš6_pÜt
)

3061 
	`İ’v²_¢´štf
(
Çme_buf
, Òame_buf), "%s_pÜt", 
Çme_´efix
);

3062 
	`£‹nv_št
(
es
, 
Çme_buf
, 
	`Áohs
(
addr
->addr.
š6
.
sš6_pÜt
));

3066 
	}
}

3069 
	$£‹nv_š_addr_t
(
’v_£t
 *
es
, cÚ¡ *
Çme_´efix
, 
š_addr_t
 
addr
, cÚ¡ 
æags
)

3071 ià(
addr
 || !(
æags
 & 
SA_SET_IF_NONZERO
))

3073 
İ’v²_sockaddr
 
si
;

3074 
	`CLEAR
(
si
);

3075 
si
.
addr
.
š4
.
sš_çmy
 = 
AF_INET
;

3076 
si
.
addr
.
š4
.
sš_addr
.
s_addr
 = 
	`htÚl
(addr);

3077 
	`£‹nv_sockaddr
(
es
, 
Çme_´efix
, &
si
, 
æags
);

3079 
	}
}

3082 
	$£‹nv_š6_addr
(
’v_£t
 *
es
,

3083 cÚ¡ *
Çme_´efix
,

3084 cÚ¡ 
š6_addr
 *
addr
,

3085 cÚ¡ 
æags
)

3087 ià(!
	`IN6_IS_ADDR_UNSPECIFIED
(
addr
è|| !(
æags
 & 
SA_SET_IF_NONZERO
))

3089 
İ’v²_sockaddr
 
si
;

3090 
	`CLEAR
(
si
);

3091 
si
.
addr
.
š6
.
sš6_çmy
 = 
AF_INET6
;

3092 
si
.
addr
.
š6
.
sš6_addr
 = *addr;

3093 
	`£‹nv_sockaddr
(
es
, 
Çme_´efix
, &
si
, 
æags
);

3095 
	}
}

3098 
	$£‹nv_lšk_sock‘_aùu®
(
’v_£t
 *
es
,

3099 cÚ¡ *
Çme_´efix
,

3100 cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

3101 cÚ¡ 
æags
)

3103 
	`£‹nv_sockaddr
(
es
, 
Çme_´efix
, &
aù
->
de¡
, 
æags
);

3104 
	}
}

3110 
	s´Ùo_Çmes
 {

3111 cÚ¡ *
	mshÜt_fÜm
;

3112 cÚ¡ *
	mdi¥Ïy_fÜm
;

3113 
§_çmy_t
 
	m´Ùo_af
;

3114 
	m´Ùo
;

3118 cÚ¡ 
´Ùo_Çmes
 
	g´Ùo_Çmes
[] = {

3119 {"´Ùo-unš™Ÿlized", "´Ùo-NONE", 
AF_UNSPEC
, 
PROTO_NONE
},

3121 {"udp", "UDP", 
AF_UNSPEC
, 
PROTO_UDP
},

3122 {"tı-£rv”", "TCP_SERVER", 
AF_UNSPEC
, 
PROTO_TCP_SERVER
},

3123 {"tı-ş›Á", "TCP_CLIENT", 
AF_UNSPEC
, 
PROTO_TCP_CLIENT
},

3124 {"tı", "TCP", 
AF_UNSPEC
, 
PROTO_TCP
},

3126 {"udp4", "UDPv4", 
AF_INET
, 
PROTO_UDP
},

3127 {"tı4-£rv”","TCPv4_SERVER", 
AF_INET
, 
PROTO_TCP_SERVER
},

3128 {"tı4-ş›Á","TCPv4_CLIENT", 
AF_INET
, 
PROTO_TCP_CLIENT
},

3129 {"tı4", "TCPv4", 
AF_INET
, 
PROTO_TCP
},

3131 {"udp6","UDPv6", 
AF_INET6
, 
PROTO_UDP
},

3132 {"tı6-£rv”","TCPv6_SERVER", 
AF_INET6
, 
PROTO_TCP_SERVER
},

3133 {"tı6-ş›Á","TCPv6_CLIENT", 
AF_INET6
, 
PROTO_TCP_CLIENT
},

3134 {"tı6","TCPv6", 
AF_INET6
, 
PROTO_TCP
},

3137 
boŞ


3138 
	$´Ùo_is_Ãt
(
´Ùo
)

3140 ià(
´Ùo
 < 0 ||…rÙØ>ğ
PROTO_N
)

3142 
	`ASSERT
(0);

3144  
´Ùo
 !ğ
PROTO_NONE
;

3145 
	}
}

3146 
boŞ


3147 
	$´Ùo_is_dg¿m
(
´Ùo
)

3149  
	`´Ùo_is_udp
(
´Ùo
);

3150 
	}
}

3152 
boŞ


3153 
	$´Ùo_is_udp
(
´Ùo
)

3155 ià(
´Ùo
 < 0 ||…rÙØ>ğ
PROTO_N
)

3157 
	`ASSERT
(0);

3159  
´Ùo
 =ğ
PROTO_UDP
;

3160 
	}
}

3162 
boŞ


3163 
	$´Ùo_is_tı
(
´Ùo
)

3165 ià(
´Ùo
 < 0 ||…rÙØ>ğ
PROTO_N
)

3167 
	`ASSERT
(0);

3169  
´Ùo
 =ğ
PROTO_TCP_CLIENT
 ||…rÙØ=ğ
PROTO_TCP_SERVER
;

3170 
	}
}

3173 
	$ascii2´Ùo
(cÚ¡ *
´Ùo_Çme
)

3175 
i
;

3176 
i
 = 0; i < 
	`SIZE
(
´Ùo_Çmes
); ++i)

3178 ià(!
	`¡rcmp
(
´Ùo_Çme
, 
´Ùo_Çmes
[
i
].
shÜt_fÜm
))

3180  
´Ùo_Çmes
[
i
].
´Ùo
;

3184 
	}
}

3186 
§_çmy_t


3187 
	$ascii2af
(cÚ¡ *
´Ùo_Çme
)

3189 
i
;

3190 
i
 = 0; i < 
	`SIZE
(
´Ùo_Çmes
); ++i)

3192 ià(!
	`¡rcmp
(
´Ùo_Çme
, 
´Ùo_Çmes
[
i
].
shÜt_fÜm
))

3194  
´Ùo_Çmes
[
i
].
´Ùo_af
;

3198 
	}
}

3201 
	$´Ùo2ascii
(
´Ùo
, 
§_çmy_t
 
af
, 
boŞ
 
di¥Ïy_fÜm
)

3203 
i
;

3204 
i
 = 0; i < 
	`SIZE
(
´Ùo_Çmes
); ++i)

3206 ià(
´Ùo_Çmes
[
i
].
´Ùo_af
 =ğ
af
 &&…rÙo_Çmes[i].
´Ùo
 ==…roto)

3208 ià(
di¥Ïy_fÜm
)

3210  
´Ùo_Çmes
[
i
].
di¥Ïy_fÜm
;

3214  
´Ùo_Çmes
[
i
].
shÜt_fÜm
;

3220 
	}
}

3223 
	$´Ùo2ascii_®l
(
gc_¬’a
 *
gc
)

3225 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

3226 
i
;

3228 
i
 = 0; i < 
	`SIZE
(
´Ùo_Çmes
); ++i)

3230 ià(
i
)

3232 
	`buf_´štf
(&
out
, " ");

3234 
	`buf_´štf
(&
out
, "[%s]", 
´Ùo_Çmes
[
i
].
shÜt_fÜm
);

3236  
	`BSTR
(&
out
);

3237 
	}
}

3240 
	$addr_çmy_Çme
(
af
)

3242 
af
)

3244 
AF_INET
:  "AF_INET";

3246 
AF_INET6
:  "AF_INET6";

3249 
	}
}

3264 
	$´Ùo_»mÙe
(
´Ùo
, 
boŞ
 
»mÙe
)

3266 
	`ASSERT
(
´Ùo
 >ğ0 &&…rÙØ< 
PROTO_N
);

3267 ià(
´Ùo
 =ğ
PROTO_UDP
)

3272 iàĞ(
»mÙe
 && 
´Ùo
 =ğ
PROTO_TCP_CLIENT
)

3273 || (!
»mÙe
 && 
´Ùo
 =ğ
PROTO_TCP_SERVER
))

3277 iàĞ(
»mÙe
 && 
´Ùo
 =ğ
PROTO_TCP_SERVER
)

3278 || (!
»mÙe
 && 
´Ùo
 =ğ
PROTO_TCP_CLIENT
))

3283 
	`ASSERT
(0);

3285 
	}
}

3292 
	$bad_add»ss_Ëngth
(
aùu®
, 
ex³ùed
)

3294 
	`msg
(
M_FATAL
, "ERROR:„eceived strange incoming…acket with‡n‡ddress†ength of %d -- we only‡ccept‡ddress†engths of %d.",

3295 
aùu®
,

3296 
ex³ùed
);

3297 
	}
}

3304 
	$lšk_sock‘_»ad_tı
(
lšk_sock‘
 *
sock
,

3305 
bufãr
 *
buf
)

3307 
Ën
 = 0;

3309 ià(!
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
)

3311 #ifdeà
_WIN32


3312 
Ën
 = 
	`sock‘_fš®ize
(
sock
->
sd
, &sock->
»ads
, 
buf
, 
NULL
);

3314 
bufãr
 
äag
;

3315 
	`¡»am_buf_g‘_Ãxt
(&
sock
->
¡»am_buf
, &
äag
);

3316 
Ën
 = 
	`»cv
(
sock
->
sd
, 
	`BPTR
(&
äag
), 
	`BLEN
(&äag), 
MSG_NOSIGNAL
);

3319 ià(!
Ën
)

3321 
sock
->
¡»am_»£t
 = 
Œue
;

3323 ià(
Ën
 <= 0)

3325  
buf
->
Ën
 =†en;

3329 ià(
sock
->
¡»am_buf
.
»sidu®_fuÎy_fÜmed


3330 || 
	`¡»am_buf_added
(&
sock
->
¡»am_buf
, 
Ën
))

3332 
	`¡»am_buf_g‘_fš®
(&
sock
->
¡»am_buf
, 
buf
);

3333 
	`¡»am_buf_»£t
(&
sock
->
¡»am_buf
);

3334  
buf
->
Ën
;

3338  
buf
->
Ën
 = 0;

3340 
	}
}

3342 #iâdeà
_WIN32


3344 #ià
ENABLE_IP_PKTINFO


3349 #ià
defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

3350 
	#PKTINFO_BUF_SIZE
 
	`max_št
Ğ
	`CMSG_SPACE
((
š6_pktšfo
)), \

3351 
	`CMSG_SPACE
((
š_pktšfo
)è)

	)

3353 
	#PKTINFO_BUF_SIZE
 
	`max_št
Ğ
	`CMSG_SPACE
((
š6_pktšfo
)), \

3354 
	`CMSG_SPACE
((
š_addr
)è)

	)

3357 
sockËn_t


3358 
	$lšk_sock‘_»ad_udp_posix_»cvmsg
(
lšk_sock‘
 *
sock
,

3359 
bufãr
 *
buf
,

3360 
lšk_sock‘_aùu®
 *
äom
)

3362 
iovec
 
iov
;

3363 
ušt8_t
 
pktšfo_buf
[
PKTINFO_BUF_SIZE
];

3364 
msghdr
 
mesg
;

3365 
sockËn_t
 
äomËn
 = (
äom
->
de¡
.
addr
);

3367 
iov
.
iov_ba£
 = 
	`BPTR
(
buf
);

3368 
iov
.
iov_Ën
 = 
	`buf_fÜw¬d_ÿ·c™y_tÙ®
(
buf
);

3369 
mesg
.
msg_iov
 = &
iov
;

3370 
mesg
.
msg_iovËn
 = 1;

3371 
mesg
.
msg_Çme
 = &
äom
->
de¡
.
addr
;

3372 
mesg
.
msg_Çm–’
 = 
äomËn
;

3373 
mesg
.
msg_cÚŒŞ
 = 
pktšfo_buf
;

3374 
mesg
.
msg_cÚŒŞËn
 =  
pktšfo_buf
;

3375 
buf
->
Ën
 = 
	`»cvmsg
(
sock
->
sd
, &
mesg
, 0);

3376 ià(
buf
->
Ën
 >= 0)

3378 
cmsghdr
 *
cmsg
;

3379 
äomËn
 = 
mesg
.
msg_Çm–’
;

3380 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

3381 ià(
cmsg
 !ğ
NULL


3382 && 
	`CMSG_NXTHDR
(&
mesg
, 
cmsg
è=ğ
NULL


3383 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

3384 && 
cmsg
->
cmsg_Ëv–
 =ğ
SOL_IP


3385 && 
cmsg
->
cmsg_ty³
 =ğ
IP_PKTINFO


3386 && 
cmsg
->
cmsg_Ën
 >ğ
	`CMSG_LEN
((
š_pktšfo
)) )

3387 #–ià
	`defšed
(
IP_RECVDSTADDR
)

3388 && 
cmsg
->
cmsg_Ëv–
 =ğ
IPPROTO_IP


3389 && 
cmsg
->
cmsg_ty³
 =ğ
IP_RECVDSTADDR


3390 && 
cmsg
->
cmsg_Ën
 >ğ
	`CMSG_LEN
((
š_addr
)) )

3392 #”rÜ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
w™hout
 
IP_PKTINFO
 
xÜ
 
	`IP_RECVDSTADDR
 (
fix
 
sysh—d
.
h
)

3395 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

3396 
š_pktšfo
 *
pkti
 = (š_pktšfØ*è
	`CMSG_DATA
(
cmsg
);

3397 
äom
->
pi
.
š4
.
i_ifšdex
 = 
pkti
->ipi_ifindex;

3398 
äom
->
pi
.
š4
.
i_¥ec_d¡
 = 
pkti
->ipi_spec_dst;

3399 #–ià
	`defšed
(
IP_RECVDSTADDR
)

3400 
äom
->
pi
.
š4
 = *(
š_addr
 *è
	`CMSG_DATA
(
cmsg
);

3402 #”rÜ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
w™hout
 
IP_PKTINFO
 
xÜ
 
	`IP_RECVDSTADDR
 (
fix
 
sysh—d
.
h
)

3405 ià(
cmsg
 !ğ
NULL


3406 && 
	`CMSG_NXTHDR
(&
mesg
, 
cmsg
è=ğ
NULL


3407 && 
cmsg
->
cmsg_Ëv–
 =ğ
IPPROTO_IPV6


3408 && 
cmsg
->
cmsg_ty³
 =ğ
IPV6_PKTINFO


3409 && 
cmsg
->
cmsg_Ën
 >ğ
	`CMSG_LEN
((
š6_pktšfo
)) )

3411 
š6_pktšfo
 *
pkti6
 = (š6_pktšfØ*è
	`CMSG_DATA
(
cmsg
);

3412 
äom
->
pi
.
š6
.
i6_ifšdex
 = 
pkti6
->ipi6_ifindex;

3413 
äom
->
pi
.
š6
.
i6_addr
 = 
pkti6
->ipi6_addr;

3415 ià(
cmsg
 !ğ
NULL
)

3417 
	`msg
(
M_WARN
, "CMSG„eûivedh© cªnÙ b·r£d (cmsg_Ëv–=%d, cmsg_ty³=%d, cmsgö’=%d)", ()
cmsg
->
cmsg_Ëv–
, ()cmsg->
cmsg_ty³
, ()cmsg->
cmsg_Ën
 );

3421  
äomËn
;

3422 
	}
}

3426 
	$lšk_sock‘_»ad_udp_posix
(
lšk_sock‘
 *
sock
,

3427 
bufãr
 *
buf
,

3428 
lšk_sock‘_aùu®
 *
äom
)

3430 
sockËn_t
 
äomËn
 = (
äom
->
de¡
.
addr
);

3431 
sockËn_t
 
ex³ùedËn
 = 
	`af_addr_size
(
sock
->
šfo
.
af
);

3432 
	`addr_z”o_ho¡
(&
äom
->
de¡
);

3433 #ià
ENABLE_IP_PKTINFO


3435 ià(
sock
->
šfo
.
´Ùo
 =ğ
PROTO_UDP
 && sock->
sockæags
 & 
SF_USE_IP_PKTINFO
)

3437 
äomËn
 = 
	`lšk_sock‘_»ad_udp_posix_»cvmsg
(
sock
, 
buf
, 
äom
);

3441 
buf
->
Ën
 = 
	`»cväom
(
sock
->
sd
, 
	`BPTR
(buf), 
	`buf_fÜw¬d_ÿ·c™y
(buf), 0,

3442 &
äom
->
de¡
.
addr
.
§
, &
äomËn
);

3444 ià(
buf
->
Ën
 >ğ0 && 
ex³ùedËn
 && 
äomËn
 !=ƒxpectedlen)

3446 
	`bad_add»ss_Ëngth
(
äomËn
, 
ex³ùedËn
);

3448  
buf
->
Ën
;

3449 
	}
}

3458 
	$lšk_sock‘_wr™e_tı
(
lšk_sock‘
 *
sock
,

3459 
bufãr
 *
buf
,

3460 
lšk_sock‘_aùu®
 *
to
)

3462 
·ck‘_size_ty³
 
Ën
 = 
	`BLEN
(
buf
);

3463 
	`dmsg
(
D_STREAM_DEBUG
, "STREAM: WRITE %d off£t=%d", ()
Ën
, 
buf
->
off£t
);

3464 
	`ASSERT
(
Ën
 <ğ
sock
->
¡»am_buf
.
maxËn
);

3465 
Ën
 = 
	`htÚps
(len);

3466 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
Ën
, (len)));

3467 #ifdeà
_WIN32


3468  
	`lšk_sock‘_wr™e_wš32
(
sock
, 
buf
, 
to
);

3470  
	`lšk_sock‘_wr™e_tı_posix
(
sock
, 
buf
, 
to
);

3472 
	}
}

3474 #ià
ENABLE_IP_PKTINFO


3476 
size_t


3477 
	$lšk_sock‘_wr™e_udp_posix_£ndmsg
(
lšk_sock‘
 *
sock
,

3478 
bufãr
 *
buf
,

3479 
lšk_sock‘_aùu®
 *
to
)

3481 
iovec
 
iov
;

3482 
msghdr
 
mesg
;

3483 
cmsghdr
 *
cmsg
;

3484 
ušt8_t
 
pktšfo_buf
[
PKTINFO_BUF_SIZE
];

3486 
iov
.
iov_ba£
 = 
	`BPTR
(
buf
);

3487 
iov
.
iov_Ën
 = 
	`BLEN
(
buf
);

3488 
mesg
.
msg_iov
 = &
iov
;

3489 
mesg
.
msg_iovËn
 = 1;

3490 
to
->
de¡
.
addr
.
§
.
§_çmy
)

3492 
AF_INET
:

3494 
mesg
.
msg_Çme
 = &
to
->
de¡
.
addr
.
§
;

3495 
mesg
.
msg_Çm–’
 = (
sockaddr_š
);

3496 
mesg
.
msg_cÚŒŞ
 = 
pktšfo_buf
;

3497 
mesg
.
msg_æags
 = 0;

3498 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

3499 
mesg
.
msg_cÚŒŞËn
 = 
	`CMSG_SPACE
((
š_pktšfo
));

3500 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

3501 
cmsg
->
cmsg_Ën
 = 
	`CMSG_LEN
((
š_pktšfo
));

3502 
cmsg
->
cmsg_Ëv–
 = 
SOL_IP
;

3503 
cmsg
->
cmsg_ty³
 = 
IP_PKTINFO
;

3505 
š_pktšfo
 *
pkti
;

3506 
pkti
 = (
š_pktšfo
 *è
	`CMSG_DATA
(
cmsg
);

3507 
pkti
->
i_ifšdex
 = 
to
->
pi
.
š4
.ipi_ifindex;

3508 
pkti
->
i_¥ec_d¡
 = 
to
->
pi
.
š4
.ipi_spec_dst;

3509 
pkti
->
i_addr
.
s_addr
 = 0;

3511 #–ià
	`defšed
(
IP_RECVDSTADDR
)

3512 
	`ASSERT
Ğ
	`CMSG_SPACE
((
š_addr
)è<ğ(
pktšfo_buf
) );

3513 
mesg
.
msg_cÚŒŞËn
 = 
	`CMSG_SPACE
((
š_addr
));

3514 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

3515 
cmsg
->
cmsg_Ën
 = 
	`CMSG_LEN
((
š_addr
));

3516 
cmsg
->
cmsg_Ëv–
 = 
IPPROTO_IP
;

3517 
cmsg
->
cmsg_ty³
 = 
IP_RECVDSTADDR
;

3518 *(
š_addr
 *è
	`CMSG_DATA
(
cmsg
èğ
to
->
pi
.
š4
;

3520 #”rÜ 
ENABLE_IP_PKTINFO
 
is
 
£t
 
w™hout
 
IP_PKTINFO
 
xÜ
 
	`IP_RECVDSTADDR
 (
fix
 
sysh—d
.
h
)

3525 
AF_INET6
:

3527 
š6_pktšfo
 *
pkti6
;

3528 
mesg
.
msg_Çme
 = &
to
->
de¡
.
addr
.
§
;

3529 
mesg
.
msg_Çm–’
 = (
sockaddr_š6
);

3531 
	`ASSERT
Ğ
	`CMSG_SPACE
((
š6_pktšfo
)è<ğ(
pktšfo_buf
) );

3532 
mesg
.
msg_cÚŒŞ
 = 
pktšfo_buf
;

3533 
mesg
.
msg_cÚŒŞËn
 = 
	`CMSG_SPACE
((
š6_pktšfo
));

3534 
mesg
.
msg_æags
 = 0;

3535 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
mesg
);

3536 
cmsg
->
cmsg_Ën
 = 
	`CMSG_LEN
((
š6_pktšfo
));

3537 
cmsg
->
cmsg_Ëv–
 = 
IPPROTO_IPV6
;

3538 
cmsg
->
cmsg_ty³
 = 
IPV6_PKTINFO
;

3540 
pkti6
 = (
š6_pktšfo
 *è
	`CMSG_DATA
(
cmsg
);

3541 
pkti6
->
i6_ifšdex
 = 
to
->
pi
.
š6
.ipi6_ifindex;

3542 
pkti6
->
i6_addr
 = 
to
->
pi
.
š6
.ipi6_addr;

3546 : 
	`ASSERT
(0);

3548  
	`£ndmsg
(
sock
->
sd
, &
mesg
, 0);

3549 
	}
}

3557 #ifdeà
_WIN32


3560 
	$sock‘_»cv_queue
(
lšk_sock‘
 *
sock
, 
maxsize
)

3562 ià(
sock
->
»ads
.
io¡©e
 =ğ
IOSTATE_INITIAL
)

3564 
WSABUF
 
w§buf
[1];

3565 
¡©us
;

3568 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
))

3570 
sock
->
»ads
.
buf
 = sock->»ads.
buf_š™
;

3572 ià(
	`´Ùo_is_tı
(
sock
->
šfo
.
´Ùo
))

3574 
	`¡»am_buf_g‘_Ãxt
(&
sock
->
¡»am_buf
, &sock->
»ads
.
buf
);

3578 
	`ASSERT
(0);

3582 
w§buf
[0].
buf
 = 
	`BPTR
(&
sock
->
»ads
.buf);

3583 
w§buf
[0].
Ën
 = 
maxsize
 ? maxsiz: 
	`BLEN
(&
sock
->
»ads
.
buf
);

3586 
	`ASSERT
(
w§buf
[0].
Ën
 <ğ
	`BLEN
(&
sock
->
»ads
.
buf
));

3589 
	`ASSERT
(
	`Re£tEv’t
(
sock
->
»ads
.
ov”Ïµed
.
hEv’t
));

3590 
sock
->
»ads
.
æags
 = 0;

3592 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
))

3594 
sock
->
»ads
.
addr_defšed
 = 
Œue
;

3595 
sock
->
»ads
.
add¾’
 = (sock->»ads.
addr6
);

3596 
¡©us
 = 
	`WSARecvFrom
(

3597 
sock
->
sd
,

3598 
w§buf
,

3600 &
sock
->
»ads
.
size
,

3601 &
sock
->
»ads
.
æags
,

3602 (
sockaddr
 *è&
sock
->
»ads
.
addr
,

3603 &
sock
->
»ads
.
add¾’
,

3604 &
sock
->
»ads
.
ov”Ïµed
,

3605 
NULL
);

3607 ià(
	`´Ùo_is_tı
(
sock
->
šfo
.
´Ùo
))

3609 
sock
->
»ads
.
addr_defšed
 = 
çl£
;

3610 
¡©us
 = 
	`WSARecv
(

3611 
sock
->
sd
,

3612 
w§buf
,

3614 &
sock
->
»ads
.
size
,

3615 &
sock
->
»ads
.
æags
,

3616 &
sock
->
»ads
.
ov”Ïµed
,

3617 
NULL
);

3621 
¡©us
 = 0;

3622 
	`ASSERT
(0);

3625 ià(!
¡©us
)

3628 
af_Ën
 = 
	`af_addr_size
(
sock
->
šfo
.
af
);

3629 ià(
sock
->
»ads
.
addr_defšed
 && 
af_Ën
 && sock->»ads.
add¾’
 !=‡f_len)

3631 
	`bad_add»ss_Ëngth
(
sock
->
»ads
.
add¾’
, 
af_Ën
);

3633 
sock
->
»ads
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3636 
	`ASSERT
(
	`S‘Ev’t
(
sock
->
»ads
.
ov”Ïµed
.
hEv’t
));

3637 
sock
->
»ads
.
¡©us
 = 0;

3639 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Receive immediate„eturn [%d,%d]",

3640 (è
w§buf
[0].
Ën
,

3641 (è
sock
->
»ads
.
size
);

3645 
¡©us
 = 
	`WSAG‘La¡E¼Ü
();

3646 ià(
¡©us
 =ğ
WSA_IO_PENDING
)

3648 
sock
->
»ads
.
io¡©e
 = 
IOSTATE_QUEUED
;

3649 
sock
->
»ads
.
¡©us
 = status;

3650 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Receive queued [%d]",

3651 (è
w§buf
[0].
Ën
);

3655 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3656 
	`ASSERT
(
	`S‘Ev’t
(
sock
->
»ads
.
ov”Ïµed
.
hEv’t
));

3657 
sock
->
»ads
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3658 
sock
->
»ads
.
¡©us
 = status;

3659 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Receiveƒrror [%d]: %s",

3660 (è
w§buf
[0].
Ën
,

3661 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

3662 
	`gc_ä“
(&
gc
);

3666  
sock
->
»ads
.
io¡©e
;

3667 
	}
}

3670 
	$sock‘_£nd_queue
(
lšk_sock‘
 *
sock
, 
bufãr
 *
buf
, cÚ¡ 
lšk_sock‘_aùu®
 *
to
)

3672 ià(
sock
->
wr™es
.
io¡©e
 =ğ
IOSTATE_INITIAL
)

3674 
WSABUF
 
w§buf
[1];

3675 
¡©us
;

3678 
sock
->
wr™es
.
buf
 = sock->wr™es.
buf_š™
;

3679 
sock
->
wr™es
.
buf
.
Ën
 = 0;

3680 
	`ASSERT
(
	`buf_cİy
(&
sock
->
wr™es
.
buf
, buf));

3683 
w§buf
[0].
buf
 = 
	`BPTR
(&
sock
->
wr™es
.buf);

3684 
w§buf
[0].
Ën
 = 
	`BLEN
(&
sock
->
wr™es
.
buf
);

3687 
	`ASSERT
(
	`Re£tEv’t
(
sock
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3688 
sock
->
wr™es
.
æags
 = 0;

3690 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
))

3693 
sock
->
wr™es
.
addr_defšed
 = 
Œue
;

3694 ià(
to
->
de¡
.
addr
.
§
.
§_çmy
 =ğ
AF_INET6
)

3696 
sock
->
wr™es
.
addr6
 = 
to
->
de¡
.
addr
.
š6
;

3697 
sock
->
wr™es
.
add¾’
 = (sock->wr™es.
addr6
);

3701 
sock
->
wr™es
.
addr
 = 
to
->
de¡
.addr.
š4
;

3702 
sock
->
wr™es
.
add¾’
 = (sock->wr™es.
addr
);

3705 
¡©us
 = 
	`WSAS’dTo
(

3706 
sock
->
sd
,

3707 
w§buf
,

3709 &
sock
->
wr™es
.
size
,

3710 
sock
->
wr™es
.
æags
,

3711 (
sockaddr
 *è&
sock
->
wr™es
.
addr
,

3712 
sock
->
wr™es
.
add¾’
,

3713 &
sock
->
wr™es
.
ov”Ïµed
,

3714 
NULL
);

3716 ià(
	`´Ùo_is_tı
(
sock
->
šfo
.
´Ùo
))

3719 
sock
->
wr™es
.
addr_defšed
 = 
çl£
;

3721 
¡©us
 = 
	`WSAS’d
(

3722 
sock
->
sd
,

3723 
w§buf
,

3725 &
sock
->
wr™es
.
size
,

3726 
sock
->
wr™es
.
æags
,

3727 &
sock
->
wr™es
.
ov”Ïµed
,

3728 
NULL
);

3732 
¡©us
 = 0;

3733 
	`ASSERT
(0);

3736 ià(!
¡©us
)

3738 
sock
->
wr™es
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3741 
	`ASSERT
(
	`S‘Ev’t
(
sock
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3743 
sock
->
wr™es
.
¡©us
 = 0;

3745 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Send immediate„eturn [%d,%d]",

3746 (è
w§buf
[0].
Ën
,

3747 (è
sock
->
wr™es
.
size
);

3751 
¡©us
 = 
	`WSAG‘La¡E¼Ü
();

3752 ià(
¡©us
 =ğ
WSA_IO_PENDING
)

3754 
sock
->
wr™es
.
io¡©e
 = 
IOSTATE_QUEUED
;

3755 
sock
->
wr™es
.
¡©us
 = status;

3756 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Send queued [%d]",

3757 (è
w§buf
[0].
Ën
);

3761 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3762 
	`ASSERT
(
	`S‘Ev’t
(
sock
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3763 
sock
->
wr™es
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3764 
sock
->
wr™es
.
¡©us
 = status;

3766 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Sendƒrror [%d]: %s",

3767 (è
w§buf
[0].
Ën
,

3768 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

3770 
	`gc_ä“
(&
gc
);

3774  
sock
->
wr™es
.
io¡©e
;

3775 
	}
}

3778 
	$sock‘_fš®ize
(
SOCKET
 
s
,

3779 
ov”Ïµed_io
 *
io
,

3780 
bufãr
 *
buf
,

3781 
lšk_sock‘_aùu®
 *
äom
)

3783 
»t
 = -1;

3784 
BOOL
 
¡©us
;

3786 
io
->
io¡©e
)

3788 
IOSTATE_QUEUED
:

3789 
¡©us
 = 
	`WSAG‘Ov”ÏµedResuÉ
(

3790 
s
,

3791 &
io
->
ov”Ïµed
,

3792 &
io
->
size
,

3793 
FALSE
,

3794 &
io
->
æags


3796 ià(
¡©us
)

3799 ià(
buf
)

3801 *
buf
 = 
io
->buf;

3803 
»t
 = 
io
->
size
;

3804 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3805 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3807 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Sock‘ Com¶‘iÚ sucûs [%d]", 
»t
);

3812 
»t
 = -1;

3813 ià(
	`WSAG‘La¡E¼Ü
(è!ğ
WSA_IO_INCOMPLETE
)

3816 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3817 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3818 
	`msg
(
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: Socket Completionƒrror");

3823 
IOSTATE_IMMEDIATE_RETURN
:

3824 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3825 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3826 ià(
io
->
¡©us
)

3829 
	`WSAS‘La¡E¼Ü
(
io
->
¡©us
);

3830 
»t
 = -1;

3831 
	`msg
(
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: Socket Completion‚on-queuedƒrror");

3836 ià(
buf
)

3838 *
buf
 = 
io
->buf;

3840 
»t
 = 
io
->
size
;

3841 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Sock‘ Com¶‘iÚ‚Ú-queued sucûs [%d]", 
»t
);

3845 
IOSTATE_INITIAL
:

3846 
	`WSAS‘La¡E¼Ü
(
WSAEINVAL
);

3847 
»t
 = -1;

3848 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: Socket Completion BAD STATE");

3852 
	`ASSERT
(0);

3856 ià(
äom
)

3858 ià(
»t
 >ğ0 && 
io
->
addr_defšed
)

3866 
io
->
add¾’
)

3868 (
sockaddr_š
):

3869 (
sockaddr_š6
):

3872 (
sockaddr_š6
)-4:

3876 
	`bad_add»ss_Ëngth
(
io
->
add¾’
, 
	`af_addr_size
(io->
addr
.
sš_çmy
));

3879 
io
->
addr
.
sš_çmy
)

3881 
AF_INET
:

3882 
äom
->
de¡
.
addr
.
š4
 = 
io
->addr;

3885 
AF_INET6
:

3886 
äom
->
de¡
.
addr
.
š6
 = 
io
->
addr6
;

3892 
	`CLEAR
(
äom
->
de¡
.
addr
);

3896 ià(
buf
)

3898 
buf
->
Ën
 = 
»t
;

3900  
»t
;

3901 
	}
}

3910 
	$sock‘_£t
(
lšk_sock‘
 *
s
,

3911 
ev’t_£t
 *
es
,

3912 
rwæags
,

3913 *
¬g
,

3914 *
³rsi¡’t
)

3916 ià(
s
)

3918 ià((
rwæags
 & 
EVENT_READ
è&& !
	`¡»am_buf_»ad_£tup
(
s
))

3920 
	`ASSERT
(!
³rsi¡’t
);

3921 
rwæags
 &ğ~
EVENT_READ
;

3924 #ifdeà
_WIN32


3925 ià(
rwæags
 & 
EVENT_READ
)

3927 
	`sock‘_»cv_queue
(
s
, 0);

3932 ià(!
³rsi¡’t
 || *³rsi¡’ˆ!ğ
rwæags
)

3934 
	`ev’t_ùl
(
es
, 
	`sock‘_ev’t_hªdË
(
s
), 
rwæags
, 
¬g
);

3935 ià(
³rsi¡’t
)

3937 *
³rsi¡’t
 = 
rwæags
;

3941 
s
->
rwæags_debug
 = 
rwæags
;

3943  
rwæags
;

3944 
	}
}

3947 
	$sd_şo£
(
sock‘_desütÜ_t
 *
sd
)

3949 ià(
sd
 && 
	`sock‘_defšed
(*sd))

3951 
	`İ’v²_şo£_sock‘
(*
sd
);

3952 *
sd
 = 
SOCKET_UNDEFINED
;

3954 
	}
}

3956 #ià
UNIX_SOCK_SUPPORT


3963 
	$sockaddr_unix_Çme
(cÚ¡ 
sockaddr_un
 *
loÿl
, cÚ¡ *
nuÎ
)

3965 ià(
loÿl
 &&†oÿl->
sun_çmy
 =ğ
PF_UNIX
)

3967  
loÿl
->
sun_·th
;

3971  
nuÎ
;

3973 
	}
}

3975 
sock‘_desütÜ_t


3976 
	$ü—‹_sock‘_unix
()

3978 
sock‘_desütÜ_t
 
sd
;

3980 ià((
sd
 = 
	`sock‘
(
PF_UNIX
, 
SOCK_STREAM
, 0)) < 0)

3982 
	`msg
(
M_ERR
, "Cannot create unix domain socket");

3987 
	`£t_şÛxec
(
sd
);

3989  
sd
;

3990 
	}
}

3993 
	$sock‘_bšd_unix
(
sock‘_desütÜ_t
 
sd
,

3994 
sockaddr_un
 *
loÿl
,

3995 cÚ¡ *
´efix
)

3997 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3999 #ifdeà
HAVE_UMASK


4000 cÚ¡ 
mode_t
 
Üig_umask
 = 
	`umask
(0);

4003 ià(
	`bšd
(
sd
, (
sockaddr
 *è
loÿl
, (
sockaddr_un
)))

4005 
	`msg
(
M_FATAL
 | 
M_ERRNO
,

4007 
´efix
,

4008 ()
sd
,

4009 
	`sockaddr_unix_Çme
(
loÿl
, "NULL"));

4012 #ifdeà
HAVE_UMASK


4013 
	`umask
(
Üig_umask
);

4016 
	`gc_ä“
(&
gc
);

4017 
	}
}

4019 
sock‘_desütÜ_t


4020 
	$sock‘_acû±_unix
(
sock‘_desütÜ_t
 
sd
,

4021 
sockaddr_un
 *
»mÙe
)

4023 
sockËn_t
 
»mÙe_Ën
 = (
sockaddr_un
);

4024 
sock‘_desütÜ_t
 
»t
;

4026 
	`CLEAR
(*
»mÙe
);

4027 
»t
 = 
	`acû±
(
sd
, (
sockaddr
 *è
»mÙe
, &
»mÙe_Ën
);

4028 ià(
»t
 >= 0)

4032 
	`£t_şÛxec
(
»t
);

4034  
»t
;

4035 
	}
}

4038 
	$sock‘_cÚÃù_unix
(
sock‘_desütÜ_t
 
sd
,

4039 
sockaddr_un
 *
»mÙe
)

4041 
¡©us
 = 
	`cÚÃù
(
sd
, (
sockaddr
 *è
»mÙe
, (
sockaddr_un
));

4042 ià(
¡©us
)

4044 
¡©us
 = 
	`İ’v²_”ºo
();

4046  
¡©us
;

4047 
	}
}

4050 
	$sockaddr_unix_š™
(
sockaddr_un
 *
loÿl
, cÚ¡ *
·th
)

4052 
loÿl
->
sun_çmy
 = 
PF_UNIX
;

4053 
	`¡ºıyÁ
(
loÿl
->
sun_·th
, 
·th
, (local->sun_path));

4054 
	}
}

4057 
	$sock‘_d–‘e_unix
(cÚ¡ 
sockaddr_un
 *
loÿl
)

4059 cÚ¡ *
Çme
 = 
	`sockaddr_unix_Çme
(
loÿl
, 
NULL
);

4060 #ifdeà
HAVE_UNLINK


4061 ià(
Çme
 && 
	`¡¾’
(name))

4063 
	`uÆšk
(
Çme
);

4066 
	}
}

4068 
boŞ


4069 
	$unix_sock‘_g‘_³”_uid_gid
(cÚ¡ 
sock‘_desütÜ_t
 
sd
, *
uid
, *
gid
)

4071 #ifdeà
HAVE_GETPEEREID


4072 
uid_t
 
u
;

4073 
gid_t
 
g
;

4074 ià(
	`g‘³”eid
(
sd
, &
u
, &
g
) == -1)

4076  
çl£
;

4078 ià(
uid
)

4080 *
uid
 = 
u
;

4082 ià(
gid
)

4084 *
gid
 = 
g
;

4086  
Œue
;

4087 #–ià
	`defšed
(
SO_PEERCRED
)

4088 
uüed
 
³”üed
;

4089 
sockËn_t
 
so_Ën
 = (
³”üed
);

4090 ià(
	`g‘sockİt
(
sd
, 
SOL_SOCKET
, 
SO_PEERCRED
, &
³”üed
, &
so_Ën
) == -1)

4092  
çl£
;

4094 ià(
uid
)

4096 *
uid
 = 
³”üed
.uid;

4098 ià(
gid
)

4100 *
gid
 = 
³”üed
.gid;

4102  
Œue
;

4104  
çl£
;

4106 
	}
}

	@socket.h

24 #iâdeà
SOCKET_H


25 
	#SOCKET_H


	)

27 
	~"bufãr.h
"

28 
	~"commÚ.h
"

29 
	~"”rÜ.h
"

30 
	~"´Ùo.h
"

31 
	~"mtu.h
"

32 
	~"wš32.h
"

33 
	~"ev’t.h
"

34 
	~"´oxy.h
"

35 
	~"socks.h
"

36 
	~"misc.h
"

41 
	#OPENVPN_PORT
 "1194"

	)

47 
	#RESOLV_RETRY_INFINITE
 1000000000

	)

55 
ušt16_t
 
	t·ck‘_size_ty³
;

58 
	#htÚps
(
x
è
	`htÚs
(x)

	)

61 
	#Áohps
(
x
è
	`Áohs
(x)

	)

64 
	sİ’v²_sockaddr


68 
sockaddr
 
	m§
;

69 
sockaddr_š
 
	mš4
;

70 
sockaddr_š6
 
	mš6
;

71 } 
	maddr
;

75 
	sÿched_dns_’Œy
 {

76 cÚ¡ *
	mho¡Çme
;

77 cÚ¡ *
	m£rvÇme
;

78 
	mai_çmy
;

79 
	mæags
;

80 
addršfo
 *
	mai
;

81 
ÿched_dns_’Œy
 *
	mÃxt
;

85 
	slšk_sock‘_aùu®


89 
İ’v²_sockaddr
 
	mde¡
;

90 #ià
ENABLE_IP_PKTINFO


92 #ià
defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

93 
š_pktšfo
 
	mš4
;

94 #–ià
defšed
(
IP_RECVDSTADDR
)

95 
š_addr
 
	mš4
;

97 
š6_pktšfo
 
	mš6
;

98 } 
	mpi
;

103 
	slšk_sock‘_addr


105 
addršfo
 *
	mbšd_loÿl
;

106 
addršfo
 *
	m»mÙe_li¡
;

107 
addršfo
 *
	mcu¼’t_»mÙe
;

109 
lšk_sock‘_aùu®
 
	maùu®
;

112 
	slšk_sock‘_šfo


114 
lšk_sock‘_addr
 *
	ml§
;

115 
boŞ
 
	mcÚÃùiÚ_e¡ablished
;

116 cÚ¡ *
	mchªge_commªd
;

117 cÚ¡ 
¶ugš_li¡
 *
	m¶ugšs
;

118 
boŞ
 
	m»mÙe_æßt
;

119 
	m´Ùo
;

120 
§_çmy_t
 
	maf
;

121 
boŞ
 
	mbšd_v6_Úly
;

122 
	mmtu_chªged
;

129 
	s¡»am_buf


131 
bufãr
 
	mbuf_š™
;

132 
bufãr
 
	m»sidu®
;

133 
	mmaxËn
;

134 
boŞ
 
	m»sidu®_fuÎy_fÜmed
;

136 
bufãr
 
	mbuf
;

137 
bufãr
 
	mÃxt
;

138 
	mËn
;

140 
boŞ
 
	m”rÜ
;

142 #ià
PORT_SHARE


143 
	#PS_DISABLED
 0

	)

144 
	#PS_ENABLED
 1

	)

145 
	#PS_FOREIGN
 2

	)

146 
	mpÜt_sh¬e_¡©e
;

153 
	ssock‘_bufãr_size


155 
	mrcvbuf
;

156 
	m¢dbuf
;

164 
	slšk_sock‘


166 
lšk_sock‘_šfo
 
	mšfo
;

168 
sock‘_desütÜ_t
 
	msd
;

169 
sock‘_desütÜ_t
 
	mù¾_sd
;

171 #ifdeà
_WIN32


172 
ov”Ïµed_io
 
	m»ads
;

173 
ov”Ïµed_io
 
	mwr™es
;

174 
rw_hªdË
 
	mrw_hªdË
;

175 
rw_hªdË
 
	mli¡’_hªdË
;

179 
	mrwæags_debug
;

182 
boŞ
 
	mli¡’_³rsi¡’t_queued
;

184 cÚ¡ *
	m»mÙe_ho¡
;

185 cÚ¡ *
	m»mÙe_pÜt
;

186 cÚ¡ *
	mloÿl_ho¡
;

187 cÚ¡ *
	mloÿl_pÜt
;

188 
ÿched_dns_’Œy
 *
	mdns_ÿche
;

189 
boŞ
 
	mbšd_loÿl
;

191 
	#INETD_NONE
 0

	)

192 
	#INETD_WAIT
 1

	)

193 
	#INETD_NOWAIT
 2

	)

194 
	mš‘d
;

196 
	#LS_MODE_DEFAULT
 0

	)

197 
	#LS_MODE_TCP_LISTEN
 1

	)

198 
	#LS_MODE_TCP_ACCEPT_FROM
 2

	)

199 
	mmode
;

201 
	m»sŞve_»Œy_£cÚds
;

202 
	mmtu_discov”_ty³
;

204 
sock‘_bufãr_size
 
	msock‘_bufãr_sizes
;

206 
	mmtu
;

208 
	#SF_USE_IP_PKTINFO
 (1<<0)

	)

209 
	#SF_TCP_NODELAY
 (1<<1)

	)

210 
	#SF_PORT_SHARE
 (1<<2)

	)

211 
	#SF_HOST_RANDOMIZE
 (1<<3)

	)

212 
	#SF_GETADDRINFO_DGRAM
 (1<<4)

	)

213 
	msockæags
;

214 
	mm¬k
;

217 
¡»am_buf
 
	m¡»am_buf
;

218 
bufãr
 
	m¡»am_buf_d©a
;

219 
boŞ
 
	m¡»am_»£t
;

222 
h‰p_´oxy_šfo
 *
	mh‰p_´oxy
;

225 
socks_´oxy_šfo
 *
	msocks_´oxy
;

226 
lšk_sock‘_aùu®
 
	msocks_»Ïy
;

229 cÚ¡ *
	m´oxy_de¡_ho¡
;

230 cÚ¡ *
	m´oxy_de¡_pÜt
;

234 
ev’t_timeout
 *
	m£rv”_pŞl_timeout
;

236 #ià
PASSTOS_CAPABILITY


238 #ià
defšed
(
TARGET_LINUX
)

239 
ušt8_t
 
	m±os
;

241 
	m±os
;

243 
boŞ
 
	m±os_defšed
;

246 #ifdeà
ENABLE_DEBUG


247 
	mg»mlš
;

255 #iâdeà
MSG_NOSIGNAL


256 
	#MSG_NOSIGNAL
 0

	)

259 #ifdeà
_WIN32


261 
	#İ’v²_şo£_sock‘
(
s
è
	`şo£sock‘
(s)

	)

263 
sock‘_»cv_queue
(
lšk_sock‘
 *
sock
, 
maxsize
);

265 
sock‘_£nd_queue
(
lšk_sock‘
 *
sock
,

266 
bufãr
 *
buf
,

267 cÚ¡ 
lšk_sock‘_aùu®
 *
to
);

269 
sock‘_fš®ize
(

270 
SOCKET
 
s
,

271 
ov”Ïµed_io
 *
io
,

272 
bufãr
 *
buf
,

273 
lšk_sock‘_aùu®
 *
äom
);

277 
	#İ’v²_şo£_sock‘
(
s
è
	`şo£
(s)

	)

281 
lšk_sock‘
 *
lšk_sock‘_Ãw
();

283 
sock‘_bšd
(
sock‘_desütÜ_t
 
sd
,

284 
addršfo
 *
loÿl
,

285 
af_çmy
,

286 cÚ¡ *
´efix
,

287 
boŞ
 
v6Úly
);

289 
İ’v²_cÚÃù
(
sock‘_desütÜ_t
 
sd
,

290 cÚ¡ 
sockaddr
 *
»mÙe
,

291 
cÚÃù_timeout
,

292 vŞ©*
sigÇl_»ûived
);

301 
lšk_sock‘_š™_pha£1
(
lšk_sock‘
 *
sock
,

302 cÚ¡ *
loÿl_ho¡
,

303 cÚ¡ *
loÿl_pÜt
,

304 cÚ¡ *
»mÙe_ho¡
,

305 cÚ¡ *
»mÙe_pÜt
,

306 
ÿched_dns_’Œy
 *
dns_ÿche
,

307 
´Ùo
,

308 
§_çmy_t
 
af
,

309 
boŞ
 
bšd_v6_Úly
,

310 
mode
,

311 cÚ¡ 
lšk_sock‘
 *
acû±_äom
,

312 
h‰p_´oxy_šfo
 *
h‰p_´oxy
,

313 
socks_´oxy_šfo
 *
socks_´oxy
,

314 #ifdeà
ENABLE_DEBUG


315 
g»mlš
,

317 
boŞ
 
bšd_loÿl
,

318 
boŞ
 
»mÙe_æßt
,

319 
š‘d
,

320 
lšk_sock‘_addr
 *
l§
,

321 cÚ¡ *
chªge_commªd
,

322 cÚ¡ 
¶ugš_li¡
 *
¶ugšs
,

323 
»sŞve_»Œy_£cÚds
,

324 
mtu_discov”_ty³
,

325 
rcvbuf
,

326 
¢dbuf
,

327 
m¬k
,

328 
ev’t_timeout
 *
£rv”_pŞl_timeout
,

329 
sockæags
);

331 
lšk_sock‘_š™_pha£2
(
lšk_sock‘
 *
sock
,

332 cÚ¡ 
äame
 *frame,

333 
sigÇl_šfo
 *
sig_šfo
);

335 
do_´”esŞve
(
cÚ‹xt
 *
c
);

337 
sock‘_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
´Ùo
);

339 
äame_adju¡_·th_mtu
(
äame
 *äame, 
pmtu
, 
´Ùo
);

341 
lšk_sock‘_şo£
(
lšk_sock‘
 *
sock
);

343 
sd_şo£
(
sock‘_desütÜ_t
 *
sd
);

345 
	#PS_SHOW_PORT_IF_DEFINED
 (1<<0)

	)

346 
	#PS_SHOW_PORT
 (1<<1)

	)

347 
	#PS_SHOW_PKTINFO
 (1<<2)

	)

348 
	#PS_DONT_SHOW_ADDR
 (1<<3)

	)

349 
	#PS_DONT_SHOW_FAMILY
 (1<<4)

	)

351 cÚ¡ *
´št_sockaddr_ex
(cÚ¡ 
sockaddr
 *
addr
,

352 cÚ¡ *
£·¿tÜ
,

353 cÚ¡ 
æags
,

354 
gc_¬’a
 *
gc
);

356 
šlše


358 
	$´št_İ’v²_sockaddr_ex
(cÚ¡ 
İ’v²_sockaddr
 *
addr
,

359 cÚ¡ *
£·¿tÜ
,

360 cÚ¡ 
æags
,

361 
gc_¬’a
 *
gc
)

363  
	`´št_sockaddr_ex
(&
addr
->addr.
§
, 
£·¿tÜ
, 
æags
, 
gc
);

364 
	}
}

366 
šlše


368 
	$´št_İ’v²_sockaddr
(cÚ¡ 
İ’v²_sockaddr
 *
addr
,

369 
gc_¬’a
 *
gc
)

371  
	`´št_sockaddr_ex
(&
addr
->addr.
§
, ":", 
PS_SHOW_PORT
, 
gc
);

372 
	}
}

374 
šlše


376 
	$´št_sockaddr
(cÚ¡ 
sockaddr
 *
addr
,

377 
gc_¬’a
 *
gc
)

379  
	`´št_sockaddr_ex
(
addr
, ":", 
PS_SHOW_PORT
, 
gc
);

380 
	}
}

384 cÚ¡ *
´št_lšk_sock‘_aùu®_ex
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

385 cÚ¡ *
£·¿tÜ
,

386 cÚ¡ 
æags
,

387 
gc_¬’a
 *
gc
);

389 cÚ¡ *
´št_lšk_sock‘_aùu®
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

390 
gc_¬’a
 *
gc
);

393 
	#IA_EMPTY_IF_UNDEF
 (1<<0)

	)

394 
	#IA_NET_ORDER
 (1<<1)

	)

395 cÚ¡ *
´št_š_addr_t
(
š_addr_t
 
addr
, 
æags
, 
gc_¬’a
 *
gc
);

397 cÚ¡ *
´št_š6_addr
(
š6_addr
 
addr6
, 
æags
, 
gc_¬’a
 *
gc
);

399 
š6_addr
 
add_š6_addr
Ğš6_add¸
ba£
, 
ušt32_t
 
add
 );

401 
	#SA_IP_PORT
 (1<<0)

	)

402 
	#SA_SET_IF_NONZERO
 (1<<1)

	)

403 
£‹nv_sockaddr
(
’v_£t
 *
es
,

404 cÚ¡ *
Çme_´efix
,

405 cÚ¡ 
İ’v²_sockaddr
 *
addr
,

406 cÚ¡ 
æags
);

408 
£‹nv_š_addr_t
(
’v_£t
 *
es
,

409 cÚ¡ *
Çme_´efix
,

410 
š_addr_t
 
addr
,

411 cÚ¡ 
æags
);

413 
£‹nv_š6_addr
(
’v_£t
 *
es
,

414 cÚ¡ *
Çme_´efix
,

415 cÚ¡ 
š6_addr
 *
addr
,

416 cÚ¡ 
æags
);

418 
£‹nv_lšk_sock‘_aùu®
(
’v_£t
 *
es
,

419 cÚ¡ *
Çme_´efix
,

420 cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

421 cÚ¡ 
æags
);

423 
bad_add»ss_Ëngth
(
aùu®
, 
ex³ùed
);

428 
	#IPV4_INVALID_ADDR
 0xffffffff

	)

429 
š_addr_t
 
lšk_sock‘_cu¼’t_»mÙe
(cÚ¡ 
lšk_sock‘_šfo
 *
šfo
);

431 cÚ¡ 
š6_addr
 *
	glšk_sock‘_cu¼’t_»mÙe_v6


432 (cÚ¡ 
lšk_sock‘_šfo
 *
	gšfo
);

434 
lšk_sock‘_cÚÃùiÚ_š™Ÿ‹d
(cÚ¡ 
bufãr
 *
buf
,

435 
lšk_sock‘_šfo
 *
šfo
,

436 cÚ¡ 
lšk_sock‘_aùu®
 *
addr
,

437 cÚ¡ *
commÚ_Çme
,

438 
’v_£t
 *
es
);

440 
lšk_sock‘_bad_šcomšg_addr
(
bufãr
 *
buf
,

441 cÚ¡ 
lšk_sock‘_šfo
 *
šfo
,

442 cÚ¡ 
lšk_sock‘_aùu®
 *
äom_addr
);

444 
£t_aùu®_add»ss
(
lšk_sock‘_aùu®
 *
aùu®
,

445 
addršfo
 *
ai
);

447 
lšk_sock‘_bad_outgošg_addr
();

449 
£‹nv_Œu¡ed
(
’v_£t
 *
es
, cÚ¡ 
lšk_sock‘_šfo
 *
šfo
);

451 
boŞ
 
lšk_sock‘_upd©e_æags
(
lšk_sock‘
 *
ls
, 
sockæags
);

453 
lšk_sock‘_upd©e_bufãr_sizes
(
lšk_sock‘
 *
ls
, 
rcvbuf
, 
¢dbuf
);

460 
	#OIA_HOSTNAME
 0

	)

461 
	#OIA_IP
 1

	)

462 
	#OIA_ERROR
 -1

	)

463 
İ’v²_š‘_©Ú
(cÚ¡ *
dÙ‹d_quad
, 
š_addr
 *
addr
);

466 
boŞ
 
_addr_dÙ‹d_quad_§ã
(cÚ¡ *
dÙ‹d_quad
);

468 
boŞ
 
_Ü_dns_addr_§ã
(cÚ¡ *
addr
, cÚ¡ boŞ 
®low_fqdn
);

470 
boŞ
 
mac_addr_§ã
(cÚ¡ *
mac_addr
);

472 
boŞ
 
v6_addr_§ã
(cÚ¡ *
v6_‹xt_addr
);

474 
sock‘_desütÜ_t
 
ü—‹_sock‘_tı
(
addršfo
 *);

476 
sock‘_desütÜ_t
 
sock‘_do_acû±
(sock‘_desütÜ_ˆ
sd
,

477 
lšk_sock‘_aùu®
 *
aù
,

478 cÚ¡ 
boŞ
 
nowa™
);

483 
boŞ
 
´Ùo_is_Ãt
(
´Ùo
);

485 
boŞ
 
´Ùo_is_dg¿m
(
´Ùo
);

487 
boŞ
 
´Ùo_is_udp
(
´Ùo
);

489 
boŞ
 
´Ùo_is_tı
(
´Ùo
);

492 #ià
UNIX_SOCK_SUPPORT


494 
sock‘_desütÜ_t
 
ü—‹_sock‘_unix
();

496 
sock‘_bšd_unix
(
sock‘_desütÜ_t
 
sd
,

497 
sockaddr_un
 *
loÿl
,

498 cÚ¡ *
´efix
);

500 
sock‘_desütÜ_t
 
sock‘_acû±_unix
(sock‘_desütÜ_ˆ
sd
,

501 
sockaddr_un
 *
»mÙe
);

503 
sock‘_cÚÃù_unix
(
sock‘_desütÜ_t
 
sd
,

504 
sockaddr_un
 *
»mÙe
);

506 
sockaddr_unix_š™
(
sockaddr_un
 *
loÿl
, cÚ¡ *
·th
);

508 cÚ¡ *
sockaddr_unix_Çme
(cÚ¡ 
sockaddr_un
 *
loÿl
, cÚ¡ *
nuÎ
);

510 
sock‘_d–‘e_unix
(cÚ¡ 
sockaddr_un
 *
loÿl
);

512 
boŞ
 
unix_sock‘_g‘_³”_uid_gid
(cÚ¡ 
sock‘_desütÜ_t
 
sd
, *
uid
, *
gid
);

520 
	#GETADDR_RESOLVE
 (1<<0)

	)

521 
	#GETADDR_FATAL
 (1<<1)

	)

522 
	#GETADDR_HOST_ORDER
 (1<<2)

	)

523 
	#GETADDR_MENTION_RESOLVE_RETRY
 (1<<3)

	)

524 
	#GETADDR_FATAL_ON_SIGNAL
 (1<<4)

	)

525 
	#GETADDR_WARN_ON_SIGNAL
 (1<<5)

	)

526 
	#GETADDR_MSG_VIRT_OUT
 (1<<6)

	)

527 
	#GETADDR_TRY_ONCE
 (1<<7)

	)

528 
	#GETADDR_UPDATE_MANAGEMENT_STATE
 (1<<8)

	)

529 
	#GETADDR_RANDOMIZE
 (1<<9)

	)

530 
	#GETADDR_PASSIVE
 (1<<10)

	)

531 
	#GETADDR_DATAGRAM
 (1<<11)

	)

533 
	#GETADDR_CACHE_MASK
 (
GETADDR_DATAGRAM
|
GETADDR_PASSIVE
)

	)

541 
š_addr_t
 
g‘addr
(
æags
,

542 cÚ¡ *
ho¡Çme
,

543 
»sŞve_»Œy_£cÚds
,

544 
boŞ
 *
sucûeded
,

545 vŞ©*
sigÇl_»ûived
);

550 
boŞ
 
g‘_v6_addr
(cÚ¡ *
ho¡Çme
, 
š6_addr
 *
ÃtwÜk
,

551 *
Ãtb™s
, 
msgËv–
);

553 
İ’v²_g‘addršfo
(
æags
,

554 cÚ¡ *
ho¡Çme
,

555 cÚ¡ *
£rvÇme
,

556 
»sŞve_»Œy_£cÚds
,

557 vŞ©*
sigÇl_»ûived
,

558 
ai_çmy
,

559 
addršfo
 **
»s
);

569 
	e´Ùo_num
 {

570 
	mPROTO_NONE
,

571 
	mPROTO_UDP
,

572 
	mPROTO_TCP
,

573 
	mPROTO_TCP_SERVER
,

574 
	mPROTO_TCP_CLIENT
,

575 
	mPROTO_N


578 
ascii2´Ùo
(cÚ¡ *
´Ùo_Çme
);

580 
§_çmy_t
 
ascii2af
(cÚ¡ *
´Ùo_Çme
);

582 cÚ¡ *
´Ùo2ascii
(
´Ùo
, 
§_çmy_t
 
af
, 
boŞ
 
di¥Ïy_fÜm
);

584 cÚ¡ *
´Ùo2ascii_®l
(
gc_¬’a
 *
gc
);

586 cÚ¡ *
´Ùo_»mÙe
(
´Ùo
, 
boŞ
 
»mÙe
);

588 cÚ¡ *
addr_çmy_Çme
(
af
);

593 
	#IPv4_UDP_HEADER_SIZE
 28

	)

594 
	#IPv4_TCP_HEADER_SIZE
 40

	)

595 
	#IPv6_UDP_HEADER_SIZE
 48

	)

596 
	#IPv6_TCP_HEADER_SIZE
 60

	)

598 cÚ¡ 
´Ùo_ov”h—d
[];

600 
šlše
 

601 
	$d©ag¿m_ov”h—d
(
´Ùo
)

603 
	`ASSERT
(
´Ùo
 >ğ0 &&…rÙØ< 
PROTO_N
);

604  
´Ùo_ov”h—d
 [
´Ùo
];

605 
	}
}

611 
šlše
 
boŞ


612 
	$lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
´Ùo
)

614  !
	`´Ùo_is_dg¿m
(
´Ùo
);

615 
	}
}

617 
šlše
 
boŞ


618 
	$lšk_sock‘_cÚÃùiÚ_Ü›Áed
(cÚ¡ 
lšk_sock‘
 *
sock
)

620 ià(
sock
)

622  
	`lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
sock
->
šfo
.
´Ùo
);

626  
çl£
;

628 
	}
}

630 
šlše
 
boŞ


631 
	$addr_defšed
(cÚ¡ 
İ’v²_sockaddr
 *
addr
)

633 ià(!
addr
)

637 
addr
->addr.
§
.
§_çmy
)

639 
AF_INET
:  
addr
->addr.
š4
.
sš_addr
.
s_addr
 != 0;

641 
AF_INET6
:  !
	`IN6_IS_ADDR_UNSPECIFIED
(&
addr
->addr.
š6
.
sš6_addr
);

645 
	}
}

647 
šlše
 
boŞ


648 
	$addr_loÿl
(cÚ¡ 
sockaddr
 *
addr
)

650 ià(!
addr
)

652  
çl£
;

654 
addr
->
§_çmy
)

656 
AF_INET
:

657  ((cÚ¡ 
sockaddr_š
 *)
addr
)->
sš_addr
.
s_addr
 =ğ
	`htÚl
(
INADDR_LOOPBACK
);

659 
AF_INET6
:

660  
	`IN6_IS_ADDR_LOOPBACK
(&((cÚ¡ 
sockaddr_š6
 *)
addr
)->
sš6_addr
);

663  
çl£
;

665 
	}
}

668 
šlše
 
boŞ


669 
	$addr_defšed_i
(cÚ¡ 
lšk_sock‘_aùu®
 *
l§
)

671 #ià
ENABLE_IP_PKTINFO


672 ià(!
l§
)

676 
l§
->
de¡
.
addr
.
§
.
§_çmy
)

678 #ià
	`defšed
(
HAVE_IN_PKTINFO
è&& defšed(
HAVE_IPI_SPEC_DST
)

679 
AF_INET
:  
l§
->
pi
.
š4
.
i_¥ec_d¡
.
s_addr
 != 0;

681 #–ià
	`defšed
(
IP_RECVDSTADDR
)

682 
AF_INET
:  
l§
->
pi
.
š4
.
s_addr
 != 0;

685 
AF_INET6
:  !
	`IN6_IS_ADDR_UNSPECIFIED
(&
l§
->
pi
.
š6
.
i6_addr
);

690 
	`ASSERT
(0);

692  
çl£
;

693 
	}
}

695 
šlše
 
boŞ


696 
	$lšk_sock‘_aùu®_defšed
(cÚ¡ 
lšk_sock‘_aùu®
 *
aù
)

698  
aù
 && 
	`addr_defšed
(&aù->
de¡
);

699 
	}
}

701 
šlše
 
boŞ


702 
	$addr_m©ch
(cÚ¡ 
İ’v²_sockaddr
 *
a1
, cÚ¡ İ’v²_sockadd¸*
a2
)

704 
a1
->
addr
.
§
.
§_çmy
)

706 
AF_INET
:

707  
a1
->
addr
.
š4
.
sš_addr
.
s_addr
 =ğ
a2
->addr.in4.sin_addr.s_addr;

709 
AF_INET6
:

710  
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
š6
.
sš6_addr
, &
a2
->addr.in6.sin6_addr);

712 
	`ASSERT
(0);

713  
çl£
;

714 
	}
}

716 
šlše
 
boŞ


717 
	$add¾i¡_m©ch
(cÚ¡ 
İ’v²_sockaddr
 *
a1
, cÚ¡ 
addršfo
 *
add¾i¡
)

719 cÚ¡ 
addršfo
 *
cu»Ë
;

720 
cu»Ë
 = 
add¾i¡
; cu»Ë; cu»Ë = cu»Ë->
ai_Ãxt
)

722 
a1
->
addr
.
§
.
§_çmy
)

724 
AF_INET
:

725 ià(
a1
->
addr
.
š4
.
sš_addr
.
s_addr
 =ğ((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->sin_addr.s_addr)

727  
Œue
;

731 
AF_INET6
:

732 ià(
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
š6
.
sš6_addr
, &((
sockaddr_š6
 *è
cu»Ë
->
ai_addr
)->sin6_addr))

734  
Œue
;

739 
	`ASSERT
(0);

742  
çl£
;

743 
	}
}

745 
šlše
 
š_addr_t


746 
	$addr_ho¡
(cÚ¡ 
İ’v²_sockaddr
 *
addr
)

753 ià(
addr
->addr.
§
.
§_çmy
 !ğ
AF_INET
)

757  
	`Áohl
(
addr
->addr.
š4
.
sš_addr
.
s_addr
);

758 
	}
}

761 
šlše
 
boŞ


762 
	$add¾i¡_pÜt_m©ch
(cÚ¡ 
İ’v²_sockaddr
 *
a1
, cÚ¡ 
addršfo
 *
a2
)

764 cÚ¡ 
addršfo
 *
cu»Ë
;

765 
cu»Ë
 = 
a2
; cu»Ë; cu»Ë = cu»Ë->
ai_Ãxt
)

767 
a1
->
addr
.
§
.
§_çmy
)

769 
AF_INET
:

770 ià(
cu»Ë
->
ai_çmy
 =ğ
AF_INET


771 && 
a1
->
addr
.
š4
.
sš_addr
.
s_addr
 =ğ((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->sin_addr.s_addr

772 && 
a1
->
addr
.
š4
.
sš_pÜt
 =ğ((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->sin_port)

774  
Œue
;

778 
AF_INET6
:

779 ià(
cu»Ë
->
ai_çmy
 =ğ
AF_INET6


780 && 
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
š6
.
sš6_addr
, &((
sockaddr_š6
 *è
cu»Ë
->
ai_addr
)->sin6_addr)

781 && 
a1
->
addr
.
š6
.
sš6_pÜt
 =ğ((
sockaddr_š6
 *è
cu»Ë
->
ai_addr
)->sin6_port)

783  
Œue
;

788 
	`ASSERT
(0);

791  
çl£
;

792 
	}
}

796 
šlše
 
boŞ


797 
	$addr_pÜt_m©ch
(cÚ¡ 
İ’v²_sockaddr
 *
a1
, cÚ¡ İ’v²_sockadd¸*
a2
)

799 
a1
->
addr
.
§
.
§_çmy
)

801 
AF_INET
:

802  
a1
->
addr
.
š4
.
sš_addr
.
s_addr
 =ğ
a2
->addr.in4.sin_addr.s_addr

803 && 
a1
->
addr
.
š4
.
sš_pÜt
 =ğ
a2
->addr.in4.sin_port;

805 
AF_INET6
:

806  
	`IN6_ARE_ADDR_EQUAL
(&
a1
->
addr
.
š6
.
sš6_addr
, &
a2
->addr.in6.sin6_addr)

807 && 
a1
->
addr
.
š6
.
sš6_pÜt
 =ğ
a2
->addr.in6.sin6_port;

809 
	`ASSERT
(0);

810  
çl£
;

811 
	}
}

813 
šlše
 
boŞ


814 
	$addr_m©ch_´Ùo
(cÚ¡ 
İ’v²_sockaddr
 *
a1
,

815 cÚ¡ 
İ’v²_sockaddr
 *
a2
,

816 cÚ¡ 
´Ùo
)

818  
	`lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
´Ùo
)

819 ? 
	`addr_m©ch
(
a1
, 
a2
)

820 : 
	`addr_pÜt_m©ch
(
a1
, 
a2
);

821 
	}
}

824 
šlše
 
boŞ


825 
	$add¾i¡_m©ch_´Ùo
(cÚ¡ 
İ’v²_sockaddr
 *
a1
,

826 
addršfo
 *
addr_li¡
,

827 cÚ¡ 
´Ùo
)

829  
	`lšk_sock‘_´Ùo_cÚÃùiÚ_Ü›Áed
(
´Ùo
)

830 ? 
	`add¾i¡_m©ch
(
a1
, 
addr_li¡
)

831 : 
	`add¾i¡_pÜt_m©ch
(
a1
, 
addr_li¡
);

832 
	}
}

834 
šlše
 

835 
	$addr_z”o_ho¡
(
İ’v²_sockaddr
 *
addr
)

837 
addr
->addr.
§
.
§_çmy
)

839 
AF_INET
:

840 
addr
->addr.
š4
.
sš_addr
.
s_addr
 = 0;

843 
AF_INET6
:

844 
	`mem£t
(&
addr
->addr.
š6
.
sš6_addr
, 0, (
š6_addr
));

847 
	}
}

849 
šlše
 

850 
	$addr_cİy_§
(
İ’v²_sockaddr
 *
d¡
, cÚ¡ İ’v²_sockadd¸*
¤c
)

852 
d¡
->
addr
 = 
¤c
->addr;

853 
	}
}

855 
šlše
 
boŞ


856 
	$addr_š‘4Ü6
(
sockaddr
 *
addr
)

858  
addr
->
§_çmy
 =ğ
AF_INET
 ||‡ddr->§_çmy =ğ
AF_INET6
;

859 
	}
}

861 
addr_guess_çmy
(
§_çmy_t
 
af
,cÚ¡ *
Çme
);

863 
šlše
 

864 
	$af_addr_size
(
§_çmy_t
 
af
)

866 
af
)

868 
AF_INET
:  (
sockaddr_š
);

870 
AF_INET6
:  (
sockaddr_š6
);

875 
	`msg
(
M_ERR
, "Bad‡dd»s çmy: %d\n", 
af
);

876 
	`ASSERT
(0);

880 
	}
}

882 
šlše
 
boŞ


883 
	$lšk_sock‘_aùu®_m©ch
(cÚ¡ 
lšk_sock‘_aùu®
 *
a1
, cÚ¡ lšk_sock‘_aùu® *
a2
)

885  
	`addr_pÜt_m©ch
(&
a1
->
de¡
, &
a2
->dest);

886 
	}
}

888 #ià
PORT_SHARE


890 
šlše
 
boŞ


891 
	$sock‘_fÜeign_´ÙocŞ_d‘eùed
(cÚ¡ 
lšk_sock‘
 *
sock
)

893  
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
sock
)

894 && 
sock
->
¡»am_buf
.
pÜt_sh¬e_¡©e
 =ğ
PS_FOREIGN
;

895 
	}
}

897 
šlše
 cÚ¡ 
bufãr
 *

898 
	$sock‘_fÜeign_´ÙocŞ_h—d
(cÚ¡ 
lšk_sock‘
 *
sock
)

900  &
sock
->
¡»am_buf
.
buf
;

901 
	}
}

903 
šlše
 

904 
	$sock‘_fÜeign_´ÙocŞ_sd
(cÚ¡ 
lšk_sock‘
 *
sock
)

906  
sock
->
sd
;

907 
	}
}

911 
šlše
 
boŞ


912 
	$sock‘_cÚÃùiÚ_»£t
(cÚ¡ 
lšk_sock‘
 *
sock
, 
¡©us
)

914 ià(
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
sock
))

916 ià(
sock
->
¡»am_»£t
 || sock->
¡»am_buf
.
”rÜ
)

918  
Œue
;

920 ià(
¡©us
 < 0)

922 cÚ¡ 
”r
 = 
	`İ’v²_”ºo
();

923 #ifdeà
_WIN32


924  
”r
 =ğ
WSAECONNRESET
 ||ƒ¼ =ğ
WSAECONNABORTED
;

926  
”r
 =ğ
ECONNRESET
;

930  
çl£
;

931 
	}
}

933 
šlše
 
boŞ


934 
	$lšk_sock‘_v”ify_šcomšg_addr
(
bufãr
 *
buf
,

935 cÚ¡ 
lšk_sock‘_šfo
 *
šfo
,

936 cÚ¡ 
lšk_sock‘_aùu®
 *
äom_addr
)

938 ià(
buf
->
Ën
 > 0)

940 
äom_addr
->
de¡
.
addr
.
§
.
§_çmy
)

942 
AF_INET6
:

943 
AF_INET
:

944 ià(!
	`lšk_sock‘_aùu®_defšed
(
äom_addr
))

946  
çl£
;

948 ià(
šfo
->
»mÙe_æßt
 || (!šfo->
l§
->
»mÙe_li¡
))

950  
Œue
;

952 ià(
	`add¾i¡_m©ch_´Ùo
(&
äom_addr
->
de¡
, 
šfo
->
l§
->
»mÙe_li¡
, info->
´Ùo
))

954  
Œue
;

958  
çl£
;

959 
	}
}

961 
šlše
 

962 
	$lšk_sock‘_g‘_outgošg_addr
(
bufãr
 *
buf
,

963 cÚ¡ 
lšk_sock‘_šfo
 *
šfo
,

964 
lšk_sock‘_aùu®
 **
aù
)

966 ià(
buf
->
Ën
 > 0)

968 
lšk_sock‘_addr
 *
l§
 = 
šfo
->lsa;

969 ià(
	`lšk_sock‘_aùu®_defšed
(&
l§
->
aùu®
))

971 *
aù
 = &
l§
->
aùu®
;

975 
	`lšk_sock‘_bad_outgošg_addr
();

976 
buf
->
Ën
 = 0;

977 *
aù
 = 
NULL
;

980 
	}
}

982 
šlše
 

983 
	$lšk_sock‘_£t_outgošg_addr
(cÚ¡ 
bufãr
 *
buf
,

984 
lšk_sock‘_šfo
 *
šfo
,

985 cÚ¡ 
lšk_sock‘_aùu®
 *
aù
,

986 cÚ¡ *
commÚ_Çme
,

987 
’v_£t
 *
es
)

989 ià(!
buf
 || buf->
Ën
 > 0)

991 
lšk_sock‘_addr
 *
l§
 = 
šfo
->lsa;

994 (!
šfo
->
cÚÃùiÚ_e¡ablished


995 || !
	`addr_m©ch_´Ùo
(&
aù
->
de¡
, &
l§
->
aùu®
.de¡, 
šfo
->
´Ùo
)

999 (
šfo
->
»mÙe_æßt


1000 || (!
l§
->
»mÙe_li¡
 || 
	`add¾i¡_m©ch_´Ùo
(&
aù
->
de¡
,†§->»mÙe_li¡, 
šfo
->
´Ùo
))

1004 
	`lšk_sock‘_cÚÃùiÚ_š™Ÿ‹d
(
buf
, 
šfo
, 
aù
, 
commÚ_Çme
, 
es
);

1007 
	}
}

1015 
¡»am_buf_š™
(
¡»am_buf
 *
sb
,

1016 
bufãr
 *
buf
,

1017 cÚ¡ 
sockæags
,

1018 cÚ¡ 
´Ùo
);

1020 
¡»am_buf_şo£
(
¡»am_buf
 *
sb
);

1022 
boŞ
 
¡»am_buf_added
(
¡»am_buf
 *
sb
, 
Ëngth_added
);

1024 
šlše
 
boŞ


1025 
	$¡»am_buf_»ad_£tup
(
lšk_sock‘
 *
sock
)

1027 
boŞ
 
	`¡»am_buf_»ad_£tup_dowÜk
(
lšk_sock‘
 *
sock
);

1029 ià(
	`lšk_sock‘_cÚÃùiÚ_Ü›Áed
(
sock
))

1031  
	`¡»am_buf_»ad_£tup_dowÜk
(
sock
);

1035  
Œue
;

1037 
	}
}

1043 
lšk_sock‘_»ad_tı
(
lšk_sock‘
 *
sock
,

1044 
bufãr
 *
buf
);

1046 #ifdeà
_WIN32


1048 
šlše
 

1049 
	$lšk_sock‘_»ad_udp_wš32
(
lšk_sock‘
 *
sock
,

1050 
bufãr
 *
buf
,

1051 
lšk_sock‘_aùu®
 *
äom
)

1053  
	`sock‘_fš®ize
(
sock
->
sd
, &sock->
»ads
, 
buf
, 
äom
);

1054 
	}
}

1058 
lšk_sock‘_»ad_udp_posix
(
lšk_sock‘
 *
sock
,

1059 
bufãr
 *
buf
,

1060 
lšk_sock‘_aùu®
 *
äom
);

1065 
šlše
 

1066 
	$lšk_sock‘_»ad
(
lšk_sock‘
 *
sock
,

1067 
bufãr
 *
buf
,

1068 
lšk_sock‘_aùu®
 *
äom
)

1070 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
))

1072 
»s
;

1074 #ifdeà
_WIN32


1075 
»s
 = 
	`lšk_sock‘_»ad_udp_wš32
(
sock
, 
buf
, 
äom
);

1077 
»s
 = 
	`lšk_sock‘_»ad_udp_posix
(
sock
, 
buf
, 
äom
);

1079  
»s
;

1081 ià(
	`´Ùo_is_tı
(
sock
->
šfo
.
´Ùo
))

1084 
	`addr_cİy_§
(&
äom
->
de¡
, &
sock
->
šfo
.
l§
->
aùu®
.dest);

1085  
	`lšk_sock‘_»ad_tı
(
sock
, 
buf
);

1089 
	`ASSERT
(0);

1092 
	}
}

1098 
lšk_sock‘_wr™e_tı
(
lšk_sock‘
 *
sock
,

1099 
bufãr
 *
buf
,

1100 
lšk_sock‘_aùu®
 *
to
);

1102 #ifdeà
_WIN32


1104 
šlše
 

1105 
	$lšk_sock‘_wr™e_wš32
(
lšk_sock‘
 *
sock
,

1106 
bufãr
 *
buf
,

1107 
lšk_sock‘_aùu®
 *
to
)

1109 
”r
 = 0;

1110 
¡©us
 = 0;

1111 ià(
	`ov”Ïµed_io_aùive
(&
sock
->
wr™es
))

1113 
¡©us
 = 
	`sock‘_fš®ize
(
sock
->
sd
, &sock->
wr™es
, 
NULL
, NULL);

1114 ià(
¡©us
 < 0)

1116 
”r
 = 
	`WSAG‘La¡E¼Ü
();

1119 
	`sock‘_£nd_queue
(
sock
, 
buf
, 
to
);

1120 ià(
¡©us
 < 0)

1122 
	`WSAS‘La¡E¼Ü
(
”r
);

1123  
¡©us
;

1127  
	`BLEN
(
buf
);

1129 
	}
}

1133 
šlše
 
size_t


1134 
	$lšk_sock‘_wr™e_udp_posix
(
lšk_sock‘
 *
sock
,

1135 
bufãr
 *
buf
,

1136 
lšk_sock‘_aùu®
 *
to
)

1138 #ià
ENABLE_IP_PKTINFO


1139 
size_t
 
	`lšk_sock‘_wr™e_udp_posix_£ndmsg
(
lšk_sock‘
 *
sock
,

1140 
bufãr
 *
buf
,

1141 
lšk_sock‘_aùu®
 *
to
);

1143 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
è&& (sock->
sockæags
 & 
SF_USE_IP_PKTINFO
)

1144 && 
	`addr_defšed_i
(
to
))

1146  
	`lšk_sock‘_wr™e_udp_posix_£ndmsg
(
sock
, 
buf
, 
to
);

1150  
	`£ndto
(
sock
->
sd
, 
	`BPTR
(
buf
), 
	`BLEN
(buf), 0,

1151 (
sockaddr
 *è&
to
->
de¡
.
addr
.
§
,

1152 (
sockËn_t
è
	`af_addr_size
(
to
->
de¡
.
addr
.
§
.
§_çmy
));

1153 
	}
}

1155 
šlše
 
size_t


1156 
	$lšk_sock‘_wr™e_tı_posix
(
lšk_sock‘
 *
sock
,

1157 
bufãr
 *
buf
,

1158 
lšk_sock‘_aùu®
 *
to
)

1160  
	`£nd
(
sock
->
sd
, 
	`BPTR
(
buf
), 
	`BLEN
(buf), 
MSG_NOSIGNAL
);

1161 
	}
}

1165 
šlše
 
size_t


1166 
	$lšk_sock‘_wr™e_udp
(
lšk_sock‘
 *
sock
,

1167 
bufãr
 *
buf
,

1168 
lšk_sock‘_aùu®
 *
to
)

1170 #ifdeà
_WIN32


1171  
	`lšk_sock‘_wr™e_wš32
(
sock
, 
buf
, 
to
);

1173  
	`lšk_sock‘_wr™e_udp_posix
(
sock
, 
buf
, 
to
);

1175 
	}
}

1178 
šlše
 

1179 
	$lšk_sock‘_wr™e
(
lšk_sock‘
 *
sock
,

1180 
bufãr
 *
buf
,

1181 
lšk_sock‘_aùu®
 *
to
)

1183 ià(
	`´Ùo_is_udp
(
sock
->
šfo
.
´Ùo
))

1185  
	`lšk_sock‘_wr™e_udp
(
sock
, 
buf
, 
to
);

1187 ià(
	`´Ùo_is_tı
(
sock
->
šfo
.
´Ùo
))

1189  
	`lšk_sock‘_wr™e_tı
(
sock
, 
buf
, 
to
);

1193 
	`ASSERT
(0);

1196 
	}
}

1198 #ià
PASSTOS_CAPABILITY


1203 
šlše
 

1204 
	$lšk_sock‘_exŒaù_tos
(
lšk_sock‘
 *
ls
, cÚ¡ 
bufãr
 *
buf
)

1206 ià(
ls
 && 
buf
)

1208 
İ’v²_hdr
 *
h
 = (İ’v²_hd¸*è
	`BPTR
(
buf
);

1209 
ls
->
±os
 = 
h
->
tos
;

1210 
ls
->
±os_defšed
 = 
Œue
;

1212 
	}
}

1218 
šlše
 

1219 
	$lšk_sock‘_£t_tos
(
lšk_sock‘
 *
ls
)

1221 ià(
ls
 &&†s->
±os_defšed
)

1223 
	`£tsockİt
(
ls
->
sd
, 
IPPROTO_IP
, 
IP_TOS
, (cÚ¡ *)&ls->
±os
, (ls->ptos));

1225 
	}
}

1233 
šlše
 
boŞ


1234 
	$sock‘_»ad_»sidu®
(cÚ¡ 
lšk_sock‘
 *
s
)

1236  
s
 && s->
¡»am_buf
.
»sidu®_fuÎy_fÜmed
;

1237 
	}
}

1239 
šlše
 
ev’t_t


1240 
	$sock‘_ev’t_hªdË
(cÚ¡ 
lšk_sock‘
 *
s
)

1242 #ifdeà
_WIN32


1243  &
s
->
rw_hªdË
;

1245  
s
->
sd
;

1247 
	}
}

1249 
ev’t_t
 
sock‘_li¡’_ev’t_hªdË
(
lšk_sock‘
 *
s
);

1252 
sock‘_£t
(
lšk_sock‘
 *
s
,

1253 
ev’t_£t
 *
es
,

1254 
rwæags
,

1255 *
¬g
,

1256 *
³rsi¡’t
);

1258 
šlše
 

1259 
	$sock‘_£t_li¡’_³rsi¡’t
(
lšk_sock‘
 *
s
,

1260 
ev’t_£t
 *
es
,

1261 *
¬g
)

1263 ià(
s
 && !s->
li¡’_³rsi¡’t_queued
)

1265 
	`ev’t_ùl
(
es
, 
	`sock‘_li¡’_ev’t_hªdË
(
s
), 
EVENT_READ
, 
¬g
);

1266 
s
->
li¡’_³rsi¡’t_queued
 = 
Œue
;

1268 
	}
}

1270 
šlše
 

1271 
	$sock‘_»£t_li¡’_³rsi¡’t
(
lšk_sock‘
 *
s
)

1273 #ifdeà
_WIN32


1274 
	`»£t_Ãt_ev’t_wš32
(&
s
->
li¡’_hªdË
, s->
sd
);

1276 
	}
}

1278 cÚ¡ *
sock‘_¡©
(cÚ¡ 
lšk_sock‘
 *
s
, 
rwæags
, 
gc_¬’a
 *
gc
);

	@socks.c

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

34 #–ià
defšed
(
_MSC_VER
)

35 
	~"cÚfig-msvc.h
"

38 
	~"sysh—d.h
"

40 
	~"commÚ.h
"

41 
	~"misc.h
"

42 
	~"wš32.h
"

43 
	~"sock‘.h
"

44 
	~"fdmisc.h
"

45 
	~"misc.h
"

46 
	~"´oxy.h
"

48 
	~"memdbg.h
"

50 
	#UP_TYPE_SOCKS
 "SOCKS Proxy"

	)

53 
	$socks_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
´Ùo
)

55 ià(
´Ùo
 =ğ
PROTO_UDP
)

57 
	`äame_add_to_exŒa_lšk
(
äame
, 10);

59 
	}
}

61 
socks_´oxy_šfo
 *

62 
	$socks_´oxy_Ãw
(cÚ¡ *
£rv”
,

63 cÚ¡ *
pÜt
,

64 cÚ¡ *
authfe
)

66 
socks_´oxy_šfo
 *
p
;

68 
	`ALLOC_OBJ_CLEAR
(
p
, 
socks_´oxy_šfo
);

70 
	`ASSERT
(
£rv”
);

71 
	`ASSERT
(
pÜt
);

73 
	`¡ºıyÁ
(
p
->
£rv”
, server, (p->server));

74 
p
->
pÜt
 =…ort;

76 ià(
authfe
)

78 
	`¡ºıyÁ
(
p
->
authfe
,‡uthfile, (p->authfile));

82 
p
->
authfe
[0] = 0;

85 
p
->
defšed
 = 
Œue
;

87  
p
;

88 
	}
}

91 
	$socks_´oxy_şo£
(
socks_´oxy_šfo
 *
¥
)

93 
	`ä“
(
¥
);

94 
	}
}

96 
boŞ


97 
	$socks_u£ºame_·sswÜd_auth
(
socks_´oxy_šfo
 *
p
,

98 
sock‘_desütÜ_t
 
sd
,

99 vŞ©*
sigÇl_»ûived
)

101 
to_£nd
[516];

102 
buf
[2];

103 
Ën
 = 0;

104 cÚ¡ 
timeout_£c
 = 5;

105 
u£r_·ss
 
üeds
;

106 
ssize_t
 
size
;

108 
üeds
.
defšed
 = 0;

109 ià(!
	`g‘_u£r_·ss
(&
üeds
, 
p
->
authfe
, 
UP_TYPE_SOCKS
, 
GET_USER_PASS_MANAGEMENT
))

111 
	`msg
(
M_NONFATAL
, "SOCKS failedo get username/password.");

112  
çl£
;

115 iàĞ(
	`¡¾’
(
üeds
.
u£ºame
è> 255è|| (¡¾’(üeds.
·sswÜd
) > 255) )

117 
	`msg
(
M_NONFATAL
,

120  
çl£
;

122 
	`İ’v²_¢´štf
(
to_£nd
, Ño_£nd), "\x01%c%s%c%s", (è
	`¡¾’
(
üeds
.
u£ºame
),

123 
üeds
.
u£ºame
, (è
	`¡¾’
(üeds.
·sswÜd
), creds.password);

124 
size
 = 
	`£nd
(
sd
, 
to_£nd
, 
	`¡¾’
Ño_£nd), 
MSG_NOSIGNAL
);

126 ià(
size
 !ğ
	`¡¾’
(
to_£nd
))

128 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCP…ort write failed on send()");

129  
çl£
;

132 
Ën
 < 2)

134 
¡©us
;

135 
ssize_t
 
size
;

136 
fd_£t
 
»ads
;

137 
timev®
 
tv
;

138 
c
;

140 
	`FD_ZERO
(&
»ads
);

141 
	`İ’v²_fd_£t
(
sd
, &
»ads
);

142 
tv
.
tv_£c
 = 
timeout_£c
;

143 
tv
.
tv_u£c
 = 0;

145 
¡©us
 = 
	`£Ëù
(
sd
 + 1, &
»ads
, 
NULL
, NULL, &
tv
);

147 
	`g‘_sigÇl
(
sigÇl_»ûived
);

148 ià(*
sigÇl_»ûived
)

150  
çl£
;

154 ià(
¡©us
 == 0)

156 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCP…ort„eadimeoutƒxpired");

157  
çl£
;

161 ià(
¡©us
 < 0)

163 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCP…ort„ead failed on select()");

164  
çl£
;

168 
size
 = 
	`»cv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

171 ià(
size
 != 1)

173 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_username_password_auth: TCP…ort„ead failed on„ecv()");

174  
çl£
;

178 
buf
[
Ën
++] = 
c
;

182 ià(
buf
[0] != 5 && buf[1] != 0)

184 
	`msg
(
D_LINK_ERRORS
, "socks_username_password_auth: server„efusedhe‡uthentication");

185  
çl£
;

188  
Œue
;

189 
	}
}

191 
boŞ


192 
	$socks_hªdshake
(
socks_´oxy_šfo
 *
p
,

193 
sock‘_desütÜ_t
 
sd
,

194 vŞ©*
sigÇl_»ûived
)

196 
buf
[2];

197 
Ën
 = 0;

198 cÚ¡ 
timeout_£c
 = 5;

199 
ssize_t
 
size
;

202 
m‘hod_£l
[3] = { 0x05, 0x01, 0x00 };

203 ià(
p
->
authfe
[0])

205 
m‘hod_£l
[2] = 0x02;

208 
size
 = 
	`£nd
(
sd
, 
m‘hod_£l
, (m‘hod_£l), 
MSG_NOSIGNAL
);

209 ià(
size
 !ğ(
m‘hod_£l
))

211 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCP…ort write failed on send()");

212  
çl£
;

215 
Ën
 < 2)

217 
¡©us
;

218 
ssize_t
 
size
;

219 
fd_£t
 
»ads
;

220 
timev®
 
tv
;

221 
c
;

223 
	`FD_ZERO
(&
»ads
);

224 
	`İ’v²_fd_£t
(
sd
, &
»ads
);

225 
tv
.
tv_£c
 = 
timeout_£c
;

226 
tv
.
tv_u£c
 = 0;

228 
¡©us
 = 
	`£Ëù
(
sd
 + 1, &
»ads
, 
NULL
, NULL, &
tv
);

230 
	`g‘_sigÇl
(
sigÇl_»ûived
);

231 ià(*
sigÇl_»ûived
)

233  
çl£
;

237 ià(
¡©us
 == 0)

239 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCP…ort„eadimeoutƒxpired");

240  
çl£
;

244 ià(
¡©us
 < 0)

246 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCP…ort„ead failed on select()");

247  
çl£
;

251 
size
 = 
	`»cv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

254 ià(
size
 != 1)

256 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "socks_handshake: TCP…ort„ead failed on„ecv()");

257  
çl£
;

261 
buf
[
Ën
++] = 
c
;

265 ià(
buf
[0] != '\x05')

267 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: Socks…roxy„eturned bad status");

268  
çl£
;

272 ià(
buf
[1] !ğ
m‘hod_£l
[2])

274 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: Socks…roxy„eturned unexpected‡uth");

275  
çl£
;

279 
buf
[1])

285 ià(!
p
->
authfe
[0])

287 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: server‡sked for username/login‡uth but we were "

289  
çl£
;

292 ià(!
	`socks_u£ºame_·sswÜd_auth
(
p
, 
sd
, 
sigÇl_»ûived
))

294  
çl£
;

300 
	`msg
(
D_LINK_ERRORS
, "socks_handshake: unknown SOCKS‡uth method");

301  
çl£
;

304  
Œue
;

305 
	}
}

307 
boŞ


308 
	$»cv_socks_»¶y
(
sock‘_desütÜ_t
 
sd
,

309 
İ’v²_sockaddr
 *
addr
,

310 vŞ©*
sigÇl_»ûived
)

312 
©yp
 = '\0';

313 
®’
 = 0;

314 
Ën
 = 0;

315 
buf
[22];

316 cÚ¡ 
timeout_£c
 = 5;

318 ià(
addr
 !ğ
NULL
)

320 
addr
->addr.
š4
.
sš_çmy
 = 
AF_INET
;

321 
addr
->addr.
š4
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

322 
addr
->addr.
š4
.
sš_pÜt
 = 
	`htÚs
(0);

325 
Ën
 < 4 + 
®’
 + 2)

327 
¡©us
;

328 
ssize_t
 
size
;

329 
fd_£t
 
»ads
;

330 
timev®
 
tv
;

331 
c
;

333 
	`FD_ZERO
(&
»ads
);

334 
	`İ’v²_fd_£t
(
sd
, &
»ads
);

335 
tv
.
tv_£c
 = 
timeout_£c
;

336 
tv
.
tv_u£c
 = 0;

338 
¡©us
 = 
	`£Ëù
(
sd
 + 1, &
»ads
, 
NULL
, NULL, &
tv
);

340 
	`g‘_sigÇl
(
sigÇl_»ûived
);

341 ià(*
sigÇl_»ûived
)

343  
çl£
;

347 ià(
¡©us
 == 0)

349 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCP…ort„eadimeoutƒxpired");

350  
çl£
;

354 ià(
¡©us
 < 0)

356 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCP…ort„ead failed on select()");

357  
çl£
;

361 
size
 = 
	`»cv
(
sd
, &
c
, 1, 
MSG_NOSIGNAL
);

364 ià(
size
 != 1)

366 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "recv_socks_reply: TCP…ort„ead failed on„ecv()");

367  
çl£
;

370 ià(
Ën
 == 3)

372 
©yp
 = 
c
;

375 ià(
Ën
 == 4)

377 
©yp
)

380 
®’
 = 4;

384 
®’
 = (è
c
;

388 
®’
 = 16;

392 
	`msg
(
D_LINK_ERRORS
, "recv_socks_reply: Socks…roxy„eturned bad‡ddressype");

393  
çl£
;

398 ià(
Ën
 < ()(
buf
))

400 
buf
[
Ën
] = 
c
;

402 ++
Ën
;

406 ià(
buf
[0] != '\x05' || buf[1] != '\x00')

408 
	`msg
(
D_LINK_ERRORS
, "recv_socks_reply: Socks…roxy„eturned bad„eply");

409  
çl£
;

413 ià(
©yp
 =ğ'\x01' && 
addr
 !ğ
NULL
)

415 
	`memıy
(&
addr
->addr.
š4
.
sš_addr
, 
buf
 + 4, (addr->addr.in4.sin_addr));

416 
	`memıy
(&
addr
->addr.
š4
.
sš_pÜt
, 
buf
 + 8, (addr->addr.in4.sin_port));

420  
Œue
;

421 
	}
}

424 
	$pÜt_äom_£rvÇme
(cÚ¡ *
£rvÇme
)

426 
pÜt
 = 0;

427 
pÜt
 = 
	`©oi
(
£rvÇme
);

428 ià(
pÜt
 >0 &&…ort < 65536)

430  
pÜt
;

433 
£rv’t
 *
£rviû
;

434 
£rviû
 = 
	`g‘£rvbyÇme
(
£rvÇme
, 
NULL
);

435 ià(
£rviû
)

437  
£rviû
->
s_pÜt
;

441 
	}
}

444 
	$e¡ablish_socks_´oxy_·s¡hru
(
socks_´oxy_šfo
 *
p
,

445 
sock‘_desütÜ_t
 
sd
,

446 cÚ¡ *
ho¡
,

447 cÚ¡ *
£rvÇme
,

448 vŞ©*
sigÇl_»ûived
)

450 
buf
[128];

451 
size_t
 
Ën
;

453 ià(!
	`socks_hªdshake
(
p
, 
sd
, 
sigÇl_»ûived
))

455 
”rÜ
;

459 
buf
[0] = '\x05';

460 
buf
[1] = '\x01';

461 
buf
[2] = '\x00';

462 
buf
[3] = '\x03';

464 
Ën
 = 
	`¡¾’
(
ho¡
);

465 
Ën
 = (5 +†’ + 2 > (
buf
)) ? ((buf) - 5 - 2) :†en;

467 
buf
[4] = (è
Ën
;

468 
	`memıy
(
buf
 + 5, 
ho¡
, 
Ën
);

470 
pÜt
 = 
	`pÜt_äom_£rvÇme
(
£rvÇme
);

471 ià(
pÜt
 ==0)

473 
	`msg
(
D_LINK_ERRORS
, "e¡ablish_socks_´oxy_·s¡hrough: CªnÙ cÚv”ˆ% tØpÜˆnumb”", 
£rvÇme
);

474 
”rÜ
;

477 
buf
[5 + 
Ën
] = (è(
pÜt
 >> 8);

478 
buf
[5 + 
Ën
 + 1] = (è(
pÜt
 & 0xff);

481 cÚ¡ 
ssize_t
 
size
 = 
	`£nd
(
sd
, 
buf
, 5 + 
Ën
 + 2, 
MSG_NOSIGNAL
);

482 ià(()
size
 !ğ5 + ()
Ën
 + 2)

484 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "establish_socks_proxy_passthru: TCP…ort write failed on send()");

485 
”rÜ
;

491 ià(!
	`»cv_socks_»¶y
(
sd
, 
NULL
, 
sigÇl_»ûived
))

493 
”rÜ
;

498 
”rÜ
:

499 ià(!*
sigÇl_»ûived
)

501 *
sigÇl_»ûived
 = 
SIGUSR1
;

504 
	}
}

507 
	$e¡ablish_socks_´oxy_ud·ssoc
(
socks_´oxy_šfo
 *
p
,

508 
sock‘_desütÜ_t
 
ù¾_sd
,

509 
sock‘_desütÜ_t
 
udp_sd
,

510 
İ’v²_sockaddr
 *
»Ïy_addr
,

511 vŞ©*
sigÇl_»ûived
)

513 ià(!
	`socks_hªdshake
(
p
, 
ù¾_sd
, 
sigÇl_»ûived
))

515 
”rÜ
;

522 cÚ¡ 
ssize_t
 
size
 = 
	`£nd
(
ù¾_sd
,

524 10, 
MSG_NOSIGNAL
);

525 ià(
size
 != 10)

527 
	`msg
(
D_LINK_ERRORS
 | 
M_ERRNO
, "establish_socks_proxy_passthru: TCP…ort write failed on send()");

528 
”rÜ
;

533 
	`CLEAR
(*
»Ïy_addr
);

534 ià(!
	`»cv_socks_»¶y
(
ù¾_sd
, 
»Ïy_addr
, 
sigÇl_»ûived
))

536 
”rÜ
;

541 
”rÜ
:

542 ià(!*
sigÇl_»ûived
)

544 *
sigÇl_»ûived
 = 
SIGUSR1
;

547 
	}
}

556 
	$socks_´oûss_šcomšg_udp
(
bufãr
 *
buf
,

557 
lšk_sock‘_aùu®
 *
äom
)

559 
©yp
;

561 ià(
	`BLEN
(
buf
) < 10)

563 
”rÜ
;

566 
	`buf_»ad_u16
(
buf
);

567 ià(
	`buf_»ad_u8
(
buf
) != 0)

569 
”rÜ
;

572 
©yp
 = 
	`buf_»ad_u8
(
buf
);

573 ià(
©yp
 != 1)

575 
”rÜ
;

578 
	`buf_»ad
(
buf
, &
äom
->
de¡
.
addr
.
š4
.
sš_addr
, (from->dest.addr.in4.sin_addr));

579 
	`buf_»ad
(
buf
, &
äom
->
de¡
.
addr
.
š4
.
sš_pÜt
, (from->dest.addr.in4.sin_port));

583 
”rÜ
:

584 
buf
->
Ën
 = 0;

585 
	}
}

595 
	$socks_´oûss_outgošg_udp
(
bufãr
 *
buf
,

596 cÚ¡ 
lšk_sock‘_aùu®
 *
to
)

603 
bufãr
 
h—d
 = 
	`buf_sub
(
buf
, 10, 
Œue
);

606 
	`ASSERT
(
	`buf_defšed
(&
h—d
));

608 
	`buf_wr™e_u16
(&
h—d
, 0);

609 
	`buf_wr™e_u8
(&
h—d
, 0);

610 
	`buf_wr™e_u8
(&
h—d
, '\x01');

611 
	`buf_wr™e
(&
h—d
, &
to
->
de¡
.
addr
.
š4
.
sš_addr
, (to->dest.addr.in4.sin_addr));

612 
	`buf_wr™e
(&
h—d
, &
to
->
de¡
.
addr
.
š4
.
sš_pÜt
, (to->dest.addr.in4.sin_port));

615 
	}
}

	@socks.h

29 #iâdeà
SOCKS_H


30 
	#SOCKS_H


	)

32 
	~"bufãr.h
"

34 
	gİ’v²_sockaddr
;

35 
	glšk_sock‘_aùu®
;

37 
	ssocks_´oxy_šfo
 {

38 
boŞ
 
	mdefšed
;

40 
	m£rv”
[128];

41 cÚ¡ *
	mpÜt
;

42 
	mauthfe
[256];

45 
socks_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
´Ùo
);

47 
socks_´oxy_šfo
 *
socks_´oxy_Ãw
(cÚ¡ *
£rv”
,

48 cÚ¡ *
pÜt
,

49 cÚ¡ *
authfe
);

51 
socks_´oxy_şo£
(
socks_´oxy_šfo
 *
¥
);

53 
e¡ablish_socks_´oxy_·s¡hru
(
socks_´oxy_šfo
 *
p
,

54 
sock‘_desütÜ_t
 
sd
,

55 cÚ¡ *
ho¡
,

56 cÚ¡ *
£rvÇme
,

57 vŞ©*
sigÇl_»ûived
);

59 
e¡ablish_socks_´oxy_ud·ssoc
(
socks_´oxy_šfo
 *
p
,

60 
sock‘_desütÜ_t
 
ù¾_sd
,

61 
sock‘_desütÜ_t
 
udp_sd
,

62 
İ’v²_sockaddr
 *
»Ïy_addr
,

63 vŞ©*
sigÇl_»ûived
);

65 
socks_´oûss_šcomšg_udp
(
bufãr
 *
buf
,

66 
lšk_sock‘_aùu®
 *
äom
);

68 
socks_´oûss_outgošg_udp
(
bufãr
 *
buf
,

69 cÚ¡ 
lšk_sock‘_aùu®
 *
to
);

	@ssl.c

37 #ifdeà
HAVE_CONFIG_H


38 
	~"cÚfig.h
"

39 #–ià
defšed
(
_MSC_VER
)

40 
	~"cÚfig-msvc.h
"

43 
	~"sysh—d.h
"

44 
	~"wš32.h
"

46 #ià
defšed
(
ENABLE_CRYPTO
)

48 
	~"”rÜ.h
"

49 
	~"commÚ.h
"

50 
	~"sock‘.h
"

51 
	~"misc.h
"

52 
	~"fdmisc.h
"

53 
	~"š‹rv®.h
"

54 
	~"³rf.h
"

55 
	~"¡©us.h
"

56 
	~"g»mlš.h
"

57 
	~"pkcs11.h
"

58 
	~"rou‹.h
"

59 
	~"s_üy±.h
"

61 
	~"s¦.h
"

62 
	~"s¦_v”ify.h
"

63 
	~"s¦_back’d.h
"

65 
	~"memdbg.h
"

67 #iâdeà
ENABLE_OCC


68 cÚ¡ 
	gs¦_deçuÉ_İtiÚs_¡ršg
[] = "V0 UNDEF";

71 
šlše
 const *

72 
	$loÿl_İtiÚs_¡ršg
(cÚ¡ 
s_£ssiÚ
 *
£ssiÚ
)

74 #ifdeà
ENABLE_OCC


75  
£ssiÚ
->
İt
->
loÿl_İtiÚs
;

77  
s¦_deçuÉ_İtiÚs_¡ršg
;

79 
	}
}

81 #ifdeà
MEASURE_TLS_HANDSHAKE_STATS


83 
	gs_hªdshake_sucûss
;

84 
	gs_hªdshake_”rÜ
;

85 
	gs_·ck‘s_g’”©ed
;

86 
	gs_·ck‘s_£Á
;

88 
	#INCR_SENT
 ++
s_·ck‘s_£Á


	)

89 
	#INCR_GENERATED
 ++
s_·ck‘s_g’”©ed


	)

90 
	#INCR_SUCCESS
 ++
s_hªdshake_sucûss


	)

91 
	#INCR_ERROR
 ++
s_hªdshake_”rÜ


	)

94 
	$show_s_³rfÜmªû_¡©s
()

96 
	`msg
(
D_TLS_DEBUG_LOW
, "TLS Handshakes, success=%f%% (good=%d, bad=%d),„etransmits=%f%%",

97 (è
s_hªdshake_sucûss
 / (s_hªdshake_sucûs + 
s_hªdshake_”rÜ
) * 100.0,

98 
s_hªdshake_sucûss
, 
s_hªdshake_”rÜ
,

99 (è(
s_·ck‘s_£Á
 - 
s_·ck‘s_g’”©ed
) /ls_packets_generated * 100.0);

100 
	}
}

103 
	#INCR_SENT


	)

104 
	#INCR_GENERATED


	)

105 
	#INCR_SUCCESS


	)

106 
	#INCR_ERROR


	)

113 cÚ¡ 
s_ch”_Çme_·œ
 
	gs_ch”_Çme_Œª¦©iÚ_bË
[] = {

238 #ifdeà
ENABLE_CRYPTO_OPENSSL


253 {
NULL
, NULL}

268 
key_ùx_upd©e_im¶ic™_iv
(
key_ùx
 *
ùx
, 
ušt8_t
 *
key
, 
size_t
 
key_Ën
);

270 cÚ¡ 
s_ch”_Çme_·œ
 *

271 
	$s_g‘_ch”_Çme_·œ
(cÚ¡ *
ch”_Çme
, 
size_t
 
Ën
)

273 cÚ¡ 
s_ch”_Çme_·œ
 *
·œ
 = 
s_ch”_Çme_Œª¦©iÚ_bË
;

275 
·œ
->
İ’s¦_Çme
 !ğ
NULL
)

277 ià((
	`¡¾’
(
·œ
->
İ’s¦_Çme
è=ğ
Ën
 && 0 =ğ
	`memcmp
(
ch”_Çme
,…air->openssl_name,†en))

278 || (
	`¡¾’
(
·œ
->
ŸÇ_Çme
è=ğ
Ën
 && 0 =ğ
	`memcmp
(
ch”_Çme
,…air->iana_name,†en)))

280  
·œ
;

282 
·œ
++;

286  
NULL
;

287 
	}
}

297 
	$s_lim™_»Ãg_by‹s
(cÚ¡ 
ch”_kt_t
 *
ch”
, *
»Ãg_by‹s
)

299 ià(
ch”
 && (
	`ch”_kt_block_size
(cipher) < 128/8))

301 ià(*
»Ãg_by‹s
 == -1)

303 
	`msg
(
M_WARN
, "WARNING: cipher with small block size in use, "

305 *
»Ãg_by‹s
 = 64 * 1024 * 1024;

308 
	}
}

317 
	$s_adju¡_äame_·¿m‘”s
(
äame
 *frame)

319 
	`äame_add_to_exŒa_äame
(
äame
, 1);

320 
	}
}

327 
	$s_š™_cÚŒŞ_chªÃl_äame_·¿m‘”s
(cÚ¡ 
äame
 *
d©a_chªÃl_äame
,

328 
äame
 *frame)

336 
äame
->
lšk_mtu
 = 
d©a_chªÃl_äame
->link_mtu;

337 
äame
->
exŒa_lšk
 = 
d©a_chªÃl_äame
->extra_link;

340 
	`s_adju¡_äame_·¿m‘”s
(
äame
);

341 
	`»lŸbË_ack_adju¡_äame_·¿m‘”s
(
äame
, 
CONTROL_SEND_ACK_MAX
);

342 
	`äame_add_to_exŒa_äame
(
äame
, 
SID_SIZE
 + (
·ck‘_id_ty³
));

345 
	`ASSERT
(
	`TUN_LINK_DELTA
(
äame
è< 
	`mš_št
(äame->
lšk_mtu
, 1250));

346 
äame
->
lšk_mtu_dyÇmic
 = 
	`mš_št
(äame->
lšk_mtu
, 1250è- 
	`TUN_LINK_DELTA
(frame);

347 
	}
}

350 
	$š™_s¦_lib
()

352 
	`s_š™_lib
();

354 
	`üy±o_š™_lib
();

355 
	}
}

358 
	$ä“_s¦_lib
()

360 
	`üy±o_unš™_lib
();

361 
	`´ng_unš™
();

363 
	`s_ä“_lib
();

364 
	}
}

371 
u£r_·ss
 
	g·ssbuf
;

374 
	$³m_·sswÜd_£tup
(cÚ¡ *
auth_fe
)

376 ià(!
	`¡¾’
(
·ssbuf
.
·sswÜd
))

378 
	`g‘_u£r_·ss
(&
·ssbuf
, 
auth_fe
, 
UP_TYPE_PRIVATE_KEY
, 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_PASSWORD_ONLY
);

380 
	}
}

383 
	$³m_·sswÜd_ÿÎback
(*
buf
, 
size
, 
rwæag
, *
u
)

385 ià(
buf
)

388 
	`³m_·sswÜd_£tup
(
NULL
);

389 
	`¡ºıyÁ
(
buf
, 
·ssbuf
.
·sswÜd
, 
size
);

390 
	`purge_u£r_·ss
(&
·ssbuf
, 
çl£
);

392  
	`¡¾’
(
buf
);

395 
	}
}

401 
boŞ
 
	gauth_u£r_·ss_’abËd
;

402 
u£r_·ss
 
	gauth_u£r_·ss
;

403 
u£r_·ss
 
	gauth_tok’
;

405 #ifdeà
ENABLE_CLIENT_CR


406 *
	gauth_ch®Ënge
;

410 
	$auth_u£r_·ss_£tup
(cÚ¡ *
auth_fe
, cÚ¡ 
¡©ic_ch®Ënge_šfo
 *
sci
)

412 
auth_u£r_·ss_’abËd
 = 
Œue
;

413 ià(!
auth_u£r_·ss
.
defšed
 && !
auth_tok’
.defined)

415 #ià
AUTO_USERID


416 
	`g‘_u£r_·ss_auto_u£rid
(&
auth_u£r_·ss
, 
auth_fe
);

418 #ifdeà
ENABLE_CLIENT_CR


419 ià(
auth_ch®Ënge
)

421 
	`g‘_u£r_·ss_ü
(&
auth_u£r_·ss
,

422 
auth_fe
,

423 
UP_TYPE_AUTH
,

424 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_DYNAMIC_CHALLENGE
,

425 
auth_ch®Ënge
);

427 ià(
sci
)

429 
æags
 = 
GET_USER_PASS_MANAGEMENT
|
GET_USER_PASS_STATIC_CHALLENGE
;

430 ià(
sci
->
æags
 & 
SC_ECHO
)

432 
æags
 |ğ
GET_USER_PASS_STATIC_CHALLENGE_ECHO
;

434 
	`g‘_u£r_·ss_ü
(&
auth_u£r_·ss
,

435 
auth_fe
,

436 
UP_TYPE_AUTH
,

437 
æags
,

438 
sci
->
ch®Ënge_‹xt
);

442 
	`g‘_u£r_·ss
(&
auth_u£r_·ss
, 
auth_fe
, 
UP_TYPE_AUTH
, 
GET_USER_PASS_MANAGEMENT
);

445 
	}
}

451 
	$s¦_£t_auth_noÿche
()

453 
·ssbuf
.
noÿche
 = 
Œue
;

454 
auth_u£r_·ss
.
noÿche
 = 
Œue
;

456 
auth_u£r_·ss
.
wa™_fÜ_push
 = 
Œue
;

457 
	}
}

463 
	$s¦_£t_auth_tok’
(cÚ¡ *
tok’
)

465 
	`£t_auth_tok’
(&
auth_u£r_·ss
, &
auth_tok’
, 
tok’
);

466 
	}
}

471 
boŞ


472 
	$s¦_ş—n_auth_tok’
 ()

474 
boŞ
 
wasdefšed
 = 
auth_tok’
.
defšed
;

475 
	`purge_u£r_·ss
(&
auth_tok’
, 
Œue
);

476  
wasdefšed
;

477 
	}
}

483 
	$s¦_purge_auth
(cÚ¡ 
boŞ
 
auth_u£r_·ss_Úly
)

485 ià(!
auth_u£r_·ss_Úly
)

487 #ifdeà
ENABLE_PKCS11


488 
	`pkcs11_logout
();

490 
	`purge_u£r_·ss
(&
·ssbuf
, 
Œue
);

492 
	`purge_u£r_·ss
(&
auth_u£r_·ss
, 
Œue
);

493 #ifdeà
ENABLE_CLIENT_CR


494 
	`s¦_purge_auth_ch®Ënge
();

496 
	}
}

498 #ifdeà
ENABLE_CLIENT_CR


501 
	$s¦_purge_auth_ch®Ënge
()

503 
	`ä“
(
auth_ch®Ënge
);

504 
auth_ch®Ënge
 = 
NULL
;

505 
	}
}

508 
	$s¦_put_auth_ch®Ënge
(cÚ¡ *
ü_¡r
)

510 
	`s¦_purge_auth_ch®Ënge
();

511 
auth_ch®Ënge
 = 
	`¡ršg_®loc
(
ü_¡r
, 
NULL
);

512 
	}
}

522 
	$s_v”siÚ_·r£
(cÚ¡ *
v¡r
, cÚ¡ *
exŒa
)

524 cÚ¡ 
max_v”siÚ
 = 
	`s_v”siÚ_max
();

525 ià(!
	`¡rcmp
(
v¡r
, "1.0"è&& 
TLS_VER_1_0
 <ğ
max_v”siÚ
)

527  
TLS_VER_1_0
;

529 ià(!
	`¡rcmp
(
v¡r
, "1.1"è&& 
TLS_VER_1_1
 <ğ
max_v”siÚ
)

531  
TLS_VER_1_1
;

533 ià(!
	`¡rcmp
(
v¡r
, "1.2"è&& 
TLS_VER_1_2
 <ğ
max_v”siÚ
)

535  
TLS_VER_1_2
;

537 ià(!
	`¡rcmp
(
v¡r
, "1.3"è&& 
TLS_VER_1_3
 <ğ
max_v”siÚ
)

539  
TLS_VER_1_3
;

541 ià(
exŒa
 && !
	`¡rcmp
(extra, "or-highest"))

543  
max_v”siÚ
;

547  
TLS_VER_BAD
;

549 
	}
}

563 
	$s_ùx_»lßd_ül
(
s_roÙ_ùx
 *
s¦_ùx
, cÚ¡ *
ül_fe
,

564 cÚ¡ *
ül_fe_šlše
)

567 
¶©fÜm_¡©_t
 
ül_¡©
 = {0};

575 ià(
ül_fe_šlše
)

577 
ül_¡©
.
¡_mtime
 = 1;

579 ià(
	`¶©fÜm_¡©
(
ül_fe
, &
ül_¡©
) < 0)

581 
	`msg
(
M_WARN
, "WARNING: Failedo stat CRL file,‚ot (re)loading CRL.");

590 ià((
s¦_ùx
->
ül_Ï¡_size
 =ğ
ül_¡©
.
¡_size
)

591 && (
s¦_ùx
->
ül_Ï¡_mtime
 =ğ
ül_¡©
.
¡_mtime
))

596 
s¦_ùx
->
ül_Ï¡_mtime
 = 
ül_¡©
.
¡_mtime
;

597 
s¦_ùx
->
ül_Ï¡_size
 = 
ül_¡©
.
¡_size
;

598 
	`back’d_s_ùx_»lßd_ül
(
s¦_ùx
, 
ül_fe
, 
ül_fe_šlše
);

599 
	}
}

606 
	$š™_s¦
(cÚ¡ 
İtiÚs
 *İtiÚs, 
s_roÙ_ùx
 *
Ãw_ùx
)

608 
	`ASSERT
(
NULL
 !ğ
Ãw_ùx
);

610 
	`s_ş—r_”rÜ
();

612 ià(
İtiÚs
->
s_£rv”
)

614 
	`s_ùx_£rv”_Ãw
(
Ãw_ùx
);

616 ià(
İtiÚs
->
dh_fe
)

618 
	`s_ùx_lßd_dh_·¿ms
(
Ãw_ùx
, 
İtiÚs
->
dh_fe
,

619 
İtiÚs
->
dh_fe_šlše
);

624 
	`s_ùx_ş›Á_Ãw
(
Ãw_ùx
);

628 
	`s_ùx_£t_û¹_´ofe
(
Ãw_ùx
, 
İtiÚs
->
s_û¹_´ofe
);

633 
	`s_ùx_»¡riù_ch”s
(
Ãw_ùx
, 
İtiÚs
->
ch”_li¡
);

634 
	`s_ùx_»¡riù_ch”s_s13
(
Ãw_ùx
, 
İtiÚs
->
ch”_li¡_s13
);

636 ià(!
	`s_ùx_£t_İtiÚs
(
Ãw_ùx
, 
İtiÚs
->
s¦_æags
))

638 
”r
;

641 ià(
İtiÚs
->
pkcs12_fe
)

643 ià(0 !ğ
	`s_ùx_lßd_pkcs12
(
Ãw_ùx
, 
İtiÚs
->
pkcs12_fe
,

644 
İtiÚs
->
pkcs12_fe_šlše
, !İtiÚs->
ÿ_fe
))

646 
”r
;

649 #ifdeà
ENABLE_PKCS11


650 ià(
İtiÚs
->
pkcs11_´ovid”s
[0])

652 ià(!
	`s_ùx_u£_pkcs11
(
Ãw_ùx
, 
İtiÚs
->
pkcs11_id_mªagem’t
, o±iÚs->
pkcs11_id
))

654 
	`msg
(
M_WARN
, "Cannot†oad certificate \"%s\" using PKCS#11 interface",

655 
İtiÚs
->
pkcs11_id
);

656 
”r
;

660 #ifdeà
ENABLE_CRYPTOAPI


661 ià(
İtiÚs
->
üy±ßpi_û¹
)

663 
	`s_ùx_lßd_üy±ßpi
(
Ãw_ùx
, 
İtiÚs
->
üy±ßpi_û¹
);

666 #ifdeà
MANAGMENT_EXTERNAL_KEY


667 ià((
İtiÚs
->
mªagem’t_æags
 & 
MF_EXTERNAL_KEY
)

668 && (
İtiÚs
->
û¹_fe
 || o±iÚs->
mªagem’t_æags
 & 
MF_EXTERNAL_CERT
))

670 ià(
İtiÚs
->
û¹_fe
)

672 
	`s_ùx_u£_ex‹º®_´iv©e_key
(
Ãw_ùx
, 
İtiÚs
->
û¹_fe
,

673 
İtiÚs
->
û¹_fe_šlše
);

677 *
ex‹º®_û¹ifiÿ‹
 = 
	`mªagem’t_qu”y_û¹
(
mªagem’t
,

678 
İtiÚs
->
mªagem’t_û¹ifiÿ‹
);

679 
	`s_ùx_u£_ex‹º®_´iv©e_key
(
Ãw_ùx
, 
INLINE_FILE_TAG
,

680 
ex‹º®_û¹ifiÿ‹
);

681 
	`ä“
(
ex‹º®_û¹ifiÿ‹
);

688 ià(
İtiÚs
->
û¹_fe
)

690 
	`s_ùx_lßd_û¹_fe
(
Ãw_ùx
, 
İtiÚs
->
û¹_fe
, o±iÚs->
û¹_fe_šlše
);

694 ià(
İtiÚs
->
´iv_key_fe
)

696 ià(0 !ğ
	`s_ùx_lßd_´iv_fe
(
Ãw_ùx
, 
İtiÚs
->
´iv_key_fe
, o±iÚs->
´iv_key_fe_šlše
))

698 
”r
;

703 ià(
İtiÚs
->
ÿ_fe
 || o±iÚs->
ÿ_·th
)

705 
	`s_ùx_lßd_ÿ
(
Ãw_ùx
, 
İtiÚs
->
ÿ_fe
, o±iÚs->
ÿ_fe_šlše
,

706 
İtiÚs
->
ÿ_·th
, o±iÚs->
s_£rv”
);

711 ià(
İtiÚs
->
exŒa_û¹s_fe
)

713 
	`s_ùx_lßd_exŒa_û¹s
(
Ãw_ùx
, 
İtiÚs
->
exŒa_û¹s_fe
, o±iÚs->
exŒa_û¹s_fe_šlše
);

717 
	`s_ùx_check_û¹_time
(
Ãw_ùx
);

720 ià(
İtiÚs
->
ül_fe
 && !(İtiÚs->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
))

722 
	`s_ùx_»lßd_ül
(
Ãw_ùx
, 
İtiÚs
->
ül_fe
, o±iÚs->
ül_fe_šlše
);

726 ià(
İtiÚs
->
s_£rv”
)

728 
	`s_ùx_lßd_ecdh_·¿ms
(
Ãw_ùx
, 
İtiÚs
->
ecdh_curve
);

731 #ifdeà
ENABLE_CRYPTO_MBEDTLS


733 
	`s_ùx_³rsÚ®i£_¿ndom
(
Ãw_ùx
);

736 
	`s_ş—r_”rÜ
();

739 
”r
:

740 
	`s_ş—r_”rÜ
();

741 
	`s_ùx_ä“
(
Ãw_ùx
);

743 
	}
}

749 
	$¡©e_Çme
(
¡©e
)

751 
¡©e
)

753 
S_UNDEF
:

756 
S_INITIAL
:

759 
S_PRE_START
:

762 
S_START
:

765 
S_SENT_KEY
:

768 
S_GOT_KEY
:

771 
S_ACTIVE
:

774 
S_NORMAL_OP
:

777 
S_ERROR
:

783 
	}
}

786 
	$·ck‘_İcode_Çme
(
İ
)

788 
İ
)

790 
P_CONTROL_HARD_RESET_CLIENT_V1
:

793 
P_CONTROL_HARD_RESET_SERVER_V1
:

796 
P_CONTROL_HARD_RESET_CLIENT_V2
:

799 
P_CONTROL_HARD_RESET_SERVER_V2
:

802 
P_CONTROL_SOFT_RESET_V1
:

805 
P_CONTROL_V1
:

808 
P_ACK_V1
:

811 
P_DATA_V1
:

814 
P_DATA_V2
:

820 
	}
}

823 
	$£ssiÚ_šdex_Çme
(
šdex
)

825 
šdex
)

827 
TM_ACTIVE
:

830 
TM_UNTRUSTED
:

833 
TM_LAME_DUCK
:

839 
	}
}

845 
	$´št_key_id
(
s_muÉi
 *
muÉi
, 
gc_¬’a
 *
gc
)

847 
i
;

848 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

850 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

852 
key_¡©e
 *
ks
 = 
muÉi
->
key_sÿn
[
i
];

853 
	`buf_´štf
(&
out
, " [key#%d s‹=% id=%d sid=%s]", 
i
,

854 
	`¡©e_Çme
(
ks
->
¡©e
), ks->
key_id
,

855 
	`£ssiÚ_id_´št
(&
ks
->
£ssiÚ_id_»mÙe
, 
gc
));

858  
	`BSTR
(&
out
);

859 
	}
}

861 
boŞ


862 
	$is_h¬d_»£t
(
İ
, 
key_m‘hod
)

864 ià(!
key_m‘hod
 || key_method == 1)

866 ià(
İ
 =ğ
P_CONTROL_HARD_RESET_CLIENT_V1
 || o°=ğ
P_CONTROL_HARD_RESET_SERVER_V1
)

868  
Œue
;

872 ià(!
key_m‘hod
 || key_method >= 2)

874 ià(
İ
 =ğ
P_CONTROL_HARD_RESET_CLIENT_V2
 || o°=ğ
P_CONTROL_HARD_RESET_SERVER_V2
)

876  
Œue
;

880  
çl£
;

881 
	}
}

907 
	$key_¡©e_š™
(
s_£ssiÚ
 *
£ssiÚ
, 
key_¡©e
 *
ks
)

909 
	`upd©e_time
();

911 
	`CLEAR
(*
ks
);

917 
	`key_¡©e_s¦_š™
(&
ks
->
ks_s¦
, &
£ssiÚ
->
İt
->
s¦_ùx
, sessiÚ->İt->
£rv”
,

918 
£ssiÚ
);

921 
ks
->
š™Ÿl_İcode
 = 
£ssiÚ
->initial_opcode;

922 
£ssiÚ
->
š™Ÿl_İcode
 = 
P_CONTROL_SOFT_RESET_V1
;

923 
ks
->
¡©e
 = 
S_INITIAL
;

924 
ks
->
key_id
 = 
£ssiÚ
->key_id;

930 ++
£ssiÚ
->
key_id
;

931 
£ssiÚ
->
key_id
 &ğ
P_KEY_ID_MASK
;

932 ià(!
£ssiÚ
->
key_id
)

934 
£ssiÚ
->
key_id
 = 1;

938 
	`ALLOC_OBJ_CLEAR
(
ks
->
key_¤c
, 
key_sourû2
);

941 
	`ALLOC_OBJ_CLEAR
(
ks
->
£nd_»lŸbË
, 
»lŸbË
);

942 
	`ALLOC_OBJ_CLEAR
(
ks
->
»c_»lŸbË
, 
»lŸbË
);

943 
	`ALLOC_OBJ_CLEAR
(
ks
->
»c_ack
, 
»lŸbË_ack
);

946 
ks
->
¶aš‹xt_»ad_buf
 = 
	`®loc_buf
(
TLS_CHANNEL_BUF_SIZE
);

947 
ks
->
¶aš‹xt_wr™e_buf
 = 
	`®loc_buf
(
TLS_CHANNEL_BUF_SIZE
);

948 
ks
->
ack_wr™e_buf
 = 
	`®loc_buf
(
	`BUF_SIZE
(&
£ssiÚ
->
İt
->
äame
));

949 
	`»lŸbË_š™
(
ks
->
£nd_»lŸbË
, 
	`BUF_SIZE
(&
£ssiÚ
->
İt
->
äame
),

950 
	`FRAME_HEADROOM
(&
£ssiÚ
->
İt
->
äame
), 
TLS_RELIABLE_N_SEND_BUFFERS
,

951 
ks
->
key_id
 ? 
çl£
 : 
£ssiÚ
->
İt
->
xm™_hŞd
);

952 
	`»lŸbË_š™
(
ks
->
»c_»lŸbË
, 
	`BUF_SIZE
(&
£ssiÚ
->
İt
->
äame
),

953 
	`FRAME_HEADROOM
(&
£ssiÚ
->
İt
->
äame
), 
TLS_RELIABLE_N_REC_BUFFERS
,

954 
çl£
);

955 
	`»lŸbË_£t_timeout
(
ks
->
£nd_»lŸbË
, 
£ssiÚ
->
İt
->
·ck‘_timeout
);

958 ià(
£ssiÚ
->
İt
->
»¶ay
)

960 
	`·ck‘_id_š™
(&
ks
->
üy±o_İtiÚs
.
·ck‘_id
,

961 
£ssiÚ
->
İt
->
»¶ay_wšdow
, sessiÚ->İt->
»¶ay_time
, "SSL",

962 
ks
->
key_id
);

965 
ks
->
üy±o_İtiÚs
.
pid_³rsi¡
 = 
NULL
;

967 #ifdeà
MANAGEMENT_DEF_AUTH


968 
ks
->
mda_key_id
 = 
£ssiÚ
->
İt
->
mda_cÚ‹xt
->
mda_key_id_couÁ”
++;

970 
	}
}

987 
	$key_¡©e_ä“
(
key_¡©e
 *
ks
, 
boŞ
 
ş—r
)

989 
ks
->
¡©e
 = 
S_UNDEF
;

991 
	`key_¡©e_s¦_ä“
(&
ks
->
ks_s¦
);

993 
	`ä“_key_ùx_bi
(&
ks
->
üy±o_İtiÚs
.
key_ùx_bi
);

994 
	`ä“_buf
(&
ks
->
¶aš‹xt_»ad_buf
);

995 
	`ä“_buf
(&
ks
->
¶aš‹xt_wr™e_buf
);

996 
	`ä“_buf
(&
ks
->
ack_wr™e_buf
);

997 
	`bufãr_li¡_ä“
(
ks
->
·ybuf
);

999 ià(
ks
->
£nd_»lŸbË
)

1001 
	`»lŸbË_ä“
(
ks
->
£nd_»lŸbË
);

1002 
	`ä“
(
ks
->
£nd_»lŸbË
);

1005 ià(
ks
->
»c_»lŸbË
)

1007 
	`»lŸbË_ä“
(
ks
->
»c_»lŸbË
);

1008 
	`ä“
(
ks
->
»c_»lŸbË
);

1011 ià(
ks
->
»c_ack
)

1013 
	`ä“
(
ks
->
»c_ack
);

1016 ià(
ks
->
key_¤c
)

1018 
	`ä“
(
ks
->
key_¤c
);

1021 
	`·ck‘_id_ä“
(&
ks
->
üy±o_İtiÚs
.
·ck‘_id
);

1023 #ifdeà
PLUGIN_DEF_AUTH


1024 
	`key_¡©e_rm_auth_cÚŒŞ_fe
(
ks
);

1027 ià(
ş—r
)

1029 
	`£cu»_memz”o
(
ks
, (*ks));

1031 
	}
}

1046 
šlše
 
boŞ


1047 
	$s_£ssiÚ_u£r_·ss_’abËd
(
s_£ssiÚ
 *
£ssiÚ
)

1049  (
£ssiÚ
->
İt
->
auth_u£r_·ss_v”ify_süt


1050 || 
	`¶ugš_defšed
(
£ssiÚ
->
İt
->
¶ugšs
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
)

1051 #ifdeà
MANAGEMENT_DEF_AUTH


1052 || 
	`mªagem’t_’abË_def_auth
(
mªagem’t
)

1055 
	}
}

1079 
	$s_£ssiÚ_š™
(
s_muÉi
 *
muÉi
, 
s_£ssiÚ
 *
£ssiÚ
)

1081 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1083 
	`dmsg
(
D_TLS_DEBUG
, "TLS:ls_session_init:ƒntry");

1085 
	`CLEAR
(*
£ssiÚ
);

1088 
£ssiÚ
->
İt
 = &
muÉi
->opt;

1091 !
	`£ssiÚ_id_defšed
(&
£ssiÚ
->
£ssiÚ_id
))

1093 
	`£ssiÚ_id_¿ndom
(&
£ssiÚ
->
£ssiÚ_id
);

1097 
	`ASSERT
(
£ssiÚ
->
İt
->
key_m‘hod
 >= 1);

1098 ià(
£ssiÚ
->
İt
->
key_m‘hod
 == 1)

1100 
£ssiÚ
->
š™Ÿl_İcode
 = sessiÚ->
İt
->
£rv”
 ?

1101 
P_CONTROL_HARD_RESET_SERVER_V1
 : 
P_CONTROL_HARD_RESET_CLIENT_V1
;

1105 
£ssiÚ
->
š™Ÿl_İcode
 = sessiÚ->
İt
->
£rv”
 ?

1106 
P_CONTROL_HARD_RESET_SERVER_V2
 : 
P_CONTROL_HARD_RESET_CLIENT_V2
;

1110 
£ssiÚ
->
s_w¿p
 = sessiÚ->
İt
->tls_wrap;

1111 
£ssiÚ
->
s_w¿p
.
wÜk
 = 
	`®loc_buf
(
	`BUF_SIZE
(&£ssiÚ->
İt
->
äame
));

1114 
	`·ck‘_id_š™
(&
£ssiÚ
->
s_w¿p
.
İt
.
·ck‘_id
,

1115 
£ssiÚ
->
İt
->
»¶ay_wšdow
,

1116 
£ssiÚ
->
İt
->
»¶ay_time
,

1117 "TLS_WRAP", 
£ssiÚ
->
key_id
);

1120 
	`·ck‘_id_³rsi¡_lßd_obj
(
£ssiÚ
->
s_w¿p
.
İt
.
pid_³rsi¡
,

1121 &
£ssiÚ
->
s_w¿p
.
İt
.
·ck‘_id
);

1123 
	`key_¡©e_š™
(
£ssiÚ
, &£ssiÚ->
key
[
KS_PRIMARY
]);

1125 
	`dmsg
(
D_TLS_DEBUG
, "TLS:ls_session_init:‚ew session object, sid=%s",

1126 
	`£ssiÚ_id_´št
(&
£ssiÚ
->
£ssiÚ_id
, &
gc
));

1128 
	`gc_ä“
(&
gc
);

1129 
	}
}

1144 
	$s_£ssiÚ_ä“
(
s_£ssiÚ
 *
£ssiÚ
, 
boŞ
 
ş—r
)

1146 
i
;

1148 ià(
	`·ck‘_id_š™Ÿlized
(&
£ssiÚ
->
s_w¿p
.
İt
.
·ck‘_id
))

1150 
	`·ck‘_id_ä“
(&
£ssiÚ
->
s_w¿p
.
İt
.
·ck‘_id
);

1153 
	`ä“_buf
(&
£ssiÚ
->
s_w¿p
.
wÜk
);

1155 
i
 = 0; i < 
KS_SIZE
; ++i)

1157 
	`key_¡©e_ä“
(&
£ssiÚ
->
key
[
i
], 
çl£
);

1160 ià(
£ssiÚ
->
commÚ_Çme
)

1162 
	`ä“
(
£ssiÚ
->
commÚ_Çme
);

1165 
	`û¹_hash_ä“
(
£ssiÚ
->
û¹_hash_£t
);

1167 ià(
ş—r
)

1169 
	`£cu»_memz”o
(
£ssiÚ
, (*session));

1171 
	}
}

1179 
	$move_£ssiÚ
(
s_muÉi
 *
muÉi
, 
de¡
, 
¤c
, 
boŞ
 
»š™_¤c
)

1181 
	`msg
(
D_TLS_DEBUG_LOW
, "TLS: move_session: dest=%s src=%s„einit_src=%d",

1182 
	`£ssiÚ_šdex_Çme
(
de¡
),

1183 
	`£ssiÚ_šdex_Çme
(
¤c
),

1184 
»š™_¤c
);

1185 
	`ASSERT
(
¤c
 !ğ
de¡
);

1186 
	`ASSERT
(
¤c
 >ğ0 && srø< 
TM_SIZE
);

1187 
	`ASSERT
(
de¡
 >ğ0 && de¡ < 
TM_SIZE
);

1188 
	`s_£ssiÚ_ä“
(&
muÉi
->
£ssiÚ
[
de¡
], 
çl£
);

1189 
muÉi
->
£ssiÚ
[
de¡
] = muÉi->£ssiÚ[
¤c
];

1191 ià(
»š™_¤c
)

1193 
	`s_£ssiÚ_š™
(
muÉi
, &muÉi->
£ssiÚ
[
¤c
]);

1197 
	`£cu»_memz”o
(&
muÉi
->
£ssiÚ
[
¤c
], (multi->session[src]));

1200 
	`dmsg
(
D_TLS_DEBUG
, "TLS: move_session:ƒxit");

1201 
	}
}

1204 
	$»£t_£ssiÚ
(
s_muÉi
 *
muÉi
, 
s_£ssiÚ
 *
£ssiÚ
)

1206 
	`s_£ssiÚ_ä“
(
£ssiÚ
, 
çl£
);

1207 
	`s_£ssiÚ_š™
(
muÉi
, 
£ssiÚ
);

1208 
	}
}

1214 
šlše
 

1215 
	$compu‹_—¾›¡_wakeup
(
š‹rv®_t
 *
—¾›¡
, iÁ”v®_ˆ
£cÚds_äom_now
)

1217 ià(
£cÚds_äom_now
 < *
—¾›¡
)

1219 *
—¾›¡
 = 
£cÚds_äom_now
;

1221 ià(*
—¾›¡
 < 0)

1223 *
—¾›¡
 = 0;

1225 
	}
}

1231 
šlše
 
boŞ


1232 
	$Ïme_duck_mu¡_d›
(cÚ¡ 
s_£ssiÚ
 *
£ssiÚ
, 
š‹rv®_t
 *
wakeup
)

1234 cÚ¡ 
key_¡©e
 *
Ïme
 = &
£ssiÚ
->
key
[
KS_LAME_DUCK
];

1235 ià(
Ïme
->
¡©e
 >ğ
S_INITIAL
)

1237 cÚ¡ 
time_t
 
loÿl_now
 = 
now
;

1238 
	`ASSERT
(
Ïme
->
mu¡_d›
);

1239 ià(
loÿl_now
 < 
Ïme
->
mu¡_d›
)

1241 
	`compu‹_—¾›¡_wakeup
(
wakeup
, 
Ïme
->
mu¡_d›
 - 
loÿl_now
);

1242  
çl£
;

1246  
Œue
;

1249 ià(
Ïme
->
¡©e
 =ğ
S_ERROR
)

1251  
Œue
;

1255  
çl£
;

1257 
	}
}

1259 
s_muÉi
 *

1260 
	$s_muÉi_š™
(
s_İtiÚs
 *tls_options)

1262 
s_muÉi
 *
»t
;

1264 
	`ALLOC_OBJ_CLEAR
(
»t
, 
s_muÉi
);

1267 
»t
->
İt
 = *
s_İtiÚs
;

1270 
	`ASSERT
(
	`SIZE
(
»t
->
key_sÿn
) == 3);

1271 
»t
->
key_sÿn
[0] = &»t->
£ssiÚ
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

1272 
»t
->
key_sÿn
[1] = &»t->
£ssiÚ
[
TM_ACTIVE
].
key
[
KS_LAME_DUCK
];

1273 
»t
->
key_sÿn
[2] = &»t->
£ssiÚ
[
TM_LAME_DUCK
].
key
[
KS_LAME_DUCK
];

1276 
»t
->
u£_³”_id
 = 
çl£
;

1278  
»t
;

1279 
	}
}

1282 
	$s_muÉi_š™_fš®ize
(
s_muÉi
 *
muÉi
, cÚ¡ 
äame
 *frame)

1284 
	`s_š™_cÚŒŞ_chªÃl_äame_·¿m‘”s
(
äame
, &
muÉi
->
İt
.frame);

1288 
	`s_£ssiÚ_š™
(
muÉi
, &muÉi->
£ssiÚ
[
TM_ACTIVE
]);

1290 ià(!
muÉi
->
İt
.
sšgË_£ssiÚ
)

1292 
	`s_£ssiÚ_š™
(
muÉi
, &muÉi->
£ssiÚ
[
TM_UNTRUSTED
]);

1294 
	}
}

1300 
s_auth_¡ªd®Úe
 *

1301 
	$s_auth_¡ªd®Úe_š™
(
s_İtiÚs
 *tls_options,

1302 
gc_¬’a
 *
gc
)

1304 
s_auth_¡ªd®Úe
 *
s
;

1306 
	`ALLOC_OBJ_CLEAR_GC
(
s
, 
s_auth_¡ªd®Úe
, 
gc
);

1308 
s
->
s_w¿p
 = 
s_İtiÚs
->tls_wrap;

1315 
s
->
s_w¿p
.
İt
.
æags
 |ğ
CO_IGNORE_PACKET_ID
;

1318 
s
->
äame
 = 
s_İtiÚs
->frame;

1320  
s
;

1321 
	}
}

1324 
	$s_auth_¡ªd®Úe_fš®ize
(
s_auth_¡ªd®Úe
 *
s
,

1325 cÚ¡ 
äame
 *frame)

1327 
	`s_š™_cÚŒŞ_chªÃl_äame_·¿m‘”s
(
äame
, &
s
->frame);

1328 
	}
}

1336 
	$s_muÉi_š™_£t_İtiÚs
(
s_muÉi
 *
muÉi
,

1337 cÚ¡ *
loÿl
,

1338 cÚ¡ *
»mÙe
)

1340 #ifdeà
ENABLE_OCC


1342 
muÉi
->
İt
.
loÿl_İtiÚs
 = 
loÿl
;

1343 
muÉi
->
İt
.
»mÙe_İtiÚs
 = 
»mÙe
;

1345 
	}
}

1351 
	$s_muÉi_ä“
(
s_muÉi
 *
muÉi
, 
boŞ
 
ş—r
)

1353 
i
;

1355 
	`ASSERT
(
muÉi
);

1357 #ifdeà
MANAGEMENT_DEF_AUTH


1358 
	`mª_def_auth_£t_ş›Á_»asÚ
(
muÉi
, 
NULL
);

1361 #ià
P2MP_SERVER


1362 
	`ä“
(
muÉi
->
³”_šfo
);

1365 ià(
muÉi
->
locked_ú
)

1367 
	`ä“
(
muÉi
->
locked_ú
);

1370 ià(
muÉi
->
locked_u£ºame
)

1372 
	`ä“
(
muÉi
->
locked_u£ºame
);

1375 
	`û¹_hash_ä“
(
muÉi
->
locked_û¹_hash_£t
);

1377 ià(
muÉi
->
auth_tok’
)

1379 
	`£cu»_memz”o
(
muÉi
->
auth_tok’
, 
AUTH_TOKEN_SIZE
);

1380 
	`ä“
(
muÉi
->
auth_tok’
);

1383 
	`ä“
(
muÉi
->
»mÙe_ch”Çme
);

1385 
i
 = 0; i < 
TM_SIZE
; ++i)

1387 
	`s_£ssiÚ_ä“
(&
muÉi
->
£ssiÚ
[
i
], 
çl£
);

1390 ià(
ş—r
)

1392 
	`£cu»_memz”o
(
muÉi
, (*multi));

1395 
	`ä“
(
muÉi
);

1396 
	}
}

1408 
	#SWAP_BUF_SIZE
 256

	)

1410 
boŞ


1411 
	$sw­_hmac
(
bufãr
 *
buf
, cÚ¡ 
üy±o_İtiÚs
 *
co
, 
boŞ
 
šcomšg
)

1413 cÚ¡ 
key_ùx
 *
ùx
;

1415 
	`ASSERT
(
co
);

1417 
ùx
 = (
šcomšg
 ? &
co
->
key_ùx_bi
.
deüy±
 : &co->key_ùx_bi.
’üy±
);

1418 
	`ASSERT
(
ùx
->
hmac
);

1422 cÚ¡ 
hmac_size
 = 
	`hmac_ùx_size
(
ùx
->
hmac
è+ 
	`·ck‘_id_size
(
Œue
);

1425 cÚ¡ 
osid_size
 = 1 + 
SID_SIZE
;

1427 
e1
, 
e2
;

1428 
ušt8_t
 *
b
 = 
	`BPTR
(
buf
);

1429 
ušt8_t
 
buf1
[
SWAP_BUF_SIZE
];

1430 
ušt8_t
 
buf2
[
SWAP_BUF_SIZE
];

1432 ià(
šcomšg
)

1434 
e1
 = 
osid_size
;

1435 
e2
 = 
hmac_size
;

1439 
e1
 = 
hmac_size
;

1440 
e2
 = 
osid_size
;

1443 
	`ASSERT
(
e1
 <ğ
SWAP_BUF_SIZE
 && 
e2
 <= SWAP_BUF_SIZE);

1445 ià(
buf
->
Ën
 >ğ
e1
 + 
e2
)

1447 
	`memıy
(
buf1
, 
b
, 
e1
);

1448 
	`memıy
(
buf2
, 
b
 + 
e1
, 
e2
);

1449 
	`memıy
(
b
, 
buf2
, 
e2
);

1450 
	`memıy
(
b
 + 
e2
, 
buf1
, 
e1
);

1451  
Œue
;

1455  
çl£
;

1458 
	}
}

1460 #undeà
SWAP_BUF_SIZE


1466 
	$wr™e_cÚŒŞ_auth
(
s_£ssiÚ
 *
£ssiÚ
,

1467 
key_¡©e
 *
ks
,

1468 
bufãr
 *
buf
,

1469 
lšk_sock‘_aùu®
 **
to_lšk_addr
,

1470 
İcode
,

1471 
max_ack
,

1472 
boŞ
 
´•’d_ack
)

1474 
ušt8_t
 
h—d”
 = 
ks
->
key_id
 | (
İcode
 << 
P_OPCODE_SHIFT
);

1475 
bufãr
 
nuÎ
 = 
	`ş—r_buf
();

1477 
	`ASSERT
(
	`lšk_sock‘_aùu®_defšed
(&
ks
->
»mÙe_addr
));

1478 
	`ASSERT
(
»lŸbË_ack_wr™e


1479 (
ks
->
»c_ack
, 
buf
, &ks->
£ssiÚ_id_»mÙe
, 
max_ack
, 
´•’d_ack
));

1481 ià(
£ssiÚ
->
s_w¿p
.
mode
 =ğ
TLS_WRAP_AUTH


1482 || 
£ssiÚ
->
s_w¿p
.
mode
 =ğ
TLS_WRAP_NONE
)

1484 
	`ASSERT
(
	`£ssiÚ_id_wr™e_´•’d
(&
£ssiÚ
->
£ssiÚ_id
, 
buf
));

1485 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
h—d”
, (header)));

1487 ià(
£ssiÚ
->
s_w¿p
.
mode
 =ğ
TLS_WRAP_AUTH
)

1490 
	`İ’v²_’üy±
(
buf
, 
nuÎ
, &
£ssiÚ
->
s_w¿p
.
İt
);

1491 
	`ASSERT
(
	`sw­_hmac
(
buf
, &
£ssiÚ
->
s_w¿p
.
İt
, 
çl£
));

1493 ià(
£ssiÚ
->
s_w¿p
.
mode
 =ğ
TLS_WRAP_CRYPT
)

1495 
	`ASSERT
(
	`buf_š™
(&
£ssiÚ
->
s_w¿p
.
wÜk
, 
buf
->
off£t
));

1496 
	`ASSERT
(
	`buf_wr™e
(&
£ssiÚ
->
s_w¿p
.
wÜk
, &
h—d”
, (header)));

1497 
	`ASSERT
(
	`£ssiÚ_id_wr™e
(&
£ssiÚ
->
£ssiÚ_id
, &£ssiÚ->
s_w¿p
.
wÜk
));

1498 ià(
	`s_üy±_w¿p
(
buf
, &
£ssiÚ
->
s_w¿p
.
wÜk
, &£ssiÚ->s_w¿p.
İt
))

1502 *
buf
 = 
£ssiÚ
->
s_w¿p
.
wÜk
;

1506 
buf
->
Ën
 = 0;

1510 *
to_lšk_addr
 = &
ks
->
»mÙe_addr
;

1511 
	}
}

1516 
boŞ


1517 
	$»ad_cÚŒŞ_auth
(
bufãr
 *
buf
,

1518 
s_w¿p_ùx
 *
ùx
,

1519 cÚ¡ 
lšk_sock‘_aùu®
 *
äom
)

1521 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1522 
boŞ
 
»t
 = 
çl£
;

1524 ià(
ùx
->
mode
 =ğ
TLS_WRAP_AUTH
)

1526 
bufãr
 
nuÎ
 = 
	`ş—r_buf
();

1529 ià(!
	`sw­_hmac
(
buf
, &
ùx
->
İt
, 
Œue
))

1531 
	`msg
(
D_TLS_ERRORS
,

1533 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

1534 
	`gc_ä“
(&
gc
);

1535  
çl£
;

1540 
	`İ’v²_deüy±
(
buf
, 
nuÎ
, &
ùx
->
İt
, 
NULL
, 
	`BPTR
(buf));

1541 ià(!
buf
->
Ën
)

1543 
	`msg
(
D_TLS_ERRORS
,

1545 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

1546 
ş—nup
;

1550 ià(
ùx
->
mode
 =ğ
TLS_WRAP_CRYPT
)

1552 
bufãr
 
tmp
 = 
	`®loc_buf_gc
(
	`buf_fÜw¬d_ÿ·c™y_tÙ®
(
buf
), &
gc
);

1553 ià(!
	`s_üy±_unw¿p
(
buf
, &
tmp
, &
ùx
->
İt
))

1555 
	`msg
(
D_TLS_ERRORS
, "TLS Error:ls-crypt unwrapping failed from %s",

1556 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

1557 
ş—nup
;

1559 
	`ASSERT
(
	`buf_š™
(
buf
, buf->
off£t
));

1560 
	`ASSERT
(
	`buf_cİy
(
buf
, &
tmp
));

1561 
	`buf_ş—r
(&
tmp
);

1564 ià(
ùx
->
mode
 =ğ
TLS_WRAP_NONE
 || ctx->mod=ğ
TLS_WRAP_AUTH
)

1568 
	`buf_advªû
(
buf
, 
SID_SIZE
 + 1);

1571 
»t
 = 
Œue
;

1572 
ş—nup
:

1573 
	`gc_ä“
(&
gc
);

1574  
»t
;

1575 
	}
}

1582 
	$key_sourû_´št
(cÚ¡ 
key_sourû
 *
k
,

1583 cÚ¡ *
´efix
)

1585 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1587 
	`VALGRIND_MAKE_READABLE
((*)
k
->
´e_ma¡”
, (k->pre_master));

1588 
	`VALGRIND_MAKE_READABLE
((*)
k
->
¿ndom1
, (k->random1));

1589 
	`VALGRIND_MAKE_READABLE
((*)
k
->
¿ndom2
, (k->random2));

1591 
	`dmsg
(
D_SHOW_KEY_SOURCE
,

1593 
´efix
,

1594 
	`fÜm©_hex
(
k
->
´e_ma¡”
, (k->´e_ma¡”), 0, &
gc
));

1595 
	`dmsg
(
D_SHOW_KEY_SOURCE
,

1597 
´efix
,

1598 
	`fÜm©_hex
(
k
->
¿ndom1
, (k->¿ndom1), 0, &
gc
));

1599 
	`dmsg
(
D_SHOW_KEY_SOURCE
,

1601 
´efix
,

1602 
	`fÜm©_hex
(
k
->
¿ndom2
, (k->¿ndom2), 0, &
gc
));

1604 
	`gc_ä“
(&
gc
);

1605 
	}
}

1608 
	$key_sourû2_´št
(cÚ¡ 
key_sourû2
 *
k
)

1610 
	`key_sourû_´št
(&
k
->
ş›Á
, "Client");

1611 
	`key_sourû_´št
(&
k
->
£rv”
, "Server");

1612 
	}
}

1626 
	$s1_P_hash
(cÚ¡ 
md_kt_t
 *
md_kt
,

1627 cÚ¡ 
ušt8_t
 *
£c
,

1628 
£c_Ën
,

1629 cÚ¡ 
ušt8_t
 *
£ed
,

1630 
£ed_Ën
,

1631 
ušt8_t
 *
out
,

1632 
Ş’
)

1634 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1635 
chunk
;

1636 
hmac_ùx_t
 *
ùx
;

1637 
hmac_ùx_t
 *
ùx_tmp
;

1638 
ušt8_t
 
A1
[
MAX_HMAC_KEY_LENGTH
];

1639 
A1_Ën
;

1641 #ifdeà
ENABLE_DEBUG


1642 cÚ¡ 
Ş’_Üig
 = 
Ş’
;

1643 cÚ¡ 
ušt8_t
 *
out_Üig
 = 
out
;

1646 
ùx
 = 
	`hmac_ùx_Ãw
();

1647 
ùx_tmp
 = 
	`hmac_ùx_Ãw
();

1649 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "s1_P_hash sec: %s", 
	`fÜm©_hex
(
£c
, 
£c_Ën
, 0, &
gc
));

1650 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "s1_P_hash s“d: %s", 
	`fÜm©_hex
(
£ed
, 
£ed_Ën
, 0, &
gc
));

1652 
chunk
 = 
	`md_kt_size
(
md_kt
);

1653 
A1_Ën
 = 
	`md_kt_size
(
md_kt
);

1655 
	`hmac_ùx_š™
(
ùx
, 
£c
, 
£c_Ën
, 
md_kt
);

1656 
	`hmac_ùx_š™
(
ùx_tmp
, 
£c
, 
£c_Ën
, 
md_kt
);

1658 
	`hmac_ùx_upd©e
(
ùx
,
£ed
,
£ed_Ën
);

1659 
	`hmac_ùx_fš®
(
ùx
, 
A1
);

1663 
	`hmac_ùx_»£t
(
ùx
);

1664 
	`hmac_ùx_»£t
(
ùx_tmp
);

1665 
	`hmac_ùx_upd©e
(
ùx
,
A1
,
A1_Ën
);

1666 
	`hmac_ùx_upd©e
(
ùx_tmp
,
A1
,
A1_Ën
);

1667 
	`hmac_ùx_upd©e
(
ùx
,
£ed
,
£ed_Ën
);

1669 ià(
Ş’
 > 
chunk
)

1671 
	`hmac_ùx_fš®
(
ùx
, 
out
);

1672 
out
 +ğ
chunk
;

1673 
Ş’
 -ğ
chunk
;

1674 
	`hmac_ùx_fš®
(
ùx_tmp
, 
A1
);

1678 
	`hmac_ùx_fš®
(
ùx
, 
A1
);

1679 
	`memıy
(
out
,
A1
,
Ş’
);

1683 
	`hmac_ùx_ş—nup
(
ùx
);

1684 
	`hmac_ùx_ä“
(
ùx
);

1685 
	`hmac_ùx_ş—nup
(
ùx_tmp
);

1686 
	`hmac_ùx_ä“
(
ùx_tmp
);

1687 
	`£cu»_memz”o
(
A1
, (A1));

1689 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "s1_P_hash out: %s", 
	`fÜm©_hex
(
out_Üig
, 
Ş’_Üig
, 0, &
gc
));

1690 
	`gc_ä“
(&
gc
);

1691 
	}
}

1713 
	$s1_PRF
(cÚ¡ 
ušt8_t
 *
Ïb–
,

1714 
Ïb–_Ën
,

1715 cÚ¡ 
ušt8_t
 *
£c
,

1716 
¦’
,

1717 
ušt8_t
 *
out1
,

1718 
Ş’
)

1720 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1721 cÚ¡ 
md_kt_t
 *
md5
 = 
	`md_kt_g‘
("MD5");

1722 cÚ¡ 
md_kt_t
 *
sha1
 = 
	`md_kt_g‘
("SHA1");

1723 
Ën
,
i
;

1724 cÚ¡ 
ušt8_t
 *
S1
,*
S2
;

1725 
ušt8_t
 *
out2
;

1727 
out2
 = (
ušt8_t
 *è
	`gc_m®loc
(
Ş’
, 
çl£
, &
gc
);

1729 
Ën
 = 
¦’
/2;

1730 
S1
 = 
£c
;

1731 
S2
 = &(
£c
[
Ën
]);

1732 
Ën
 +ğ(
¦’
&1);

1734 
	`s1_P_hash
(
md5
,
S1
,
Ën
,
Ïb–
,
Ïb–_Ën
,
out1
,
Ş’
);

1735 
	`s1_P_hash
(
sha1
,
S2
,
Ën
,
Ïb–
,
Ïb–_Ën
,
out2
,
Ş’
);

1737 
i
 = 0; i<
Ş’
; i++)

1739 
out1
[
i
] ^ğ
out2
[i];

1742 
	`£cu»_memz”o
(
out2
, 
Ş’
);

1744 
	`dmsg
(
D_SHOW_KEY_SOURCE
, "s1_PRF out[%d]: %s", 
Ş’
, 
	`fÜm©_hex
(
out1
, oËn, 0, &
gc
));

1746 
	`gc_ä“
(&
gc
);

1747 
	}
}

1750 
	$İ’v²_PRF
(cÚ¡ 
ušt8_t
 *
£ü‘
,

1751 
£ü‘_Ën
,

1752 cÚ¡ *
Ïb–
,

1753 cÚ¡ 
ušt8_t
 *
ş›Á_£ed
,

1754 
ş›Á_£ed_Ën
,

1755 cÚ¡ 
ušt8_t
 *
£rv”_£ed
,

1756 
£rv”_£ed_Ën
,

1757 cÚ¡ 
£ssiÚ_id
 *
ş›Á_sid
,

1758 cÚ¡ 
£ssiÚ_id
 *
£rv”_sid
,

1759 
ušt8_t
 *
ouut
,

1760 
ouut_Ën
)

1764 
bufãr
 
£ed
 = 
	`®loc_buf
(
	`¡¾’
(
Ïb–
)

1765 + 
ş›Á_£ed_Ën


1766 + 
£rv”_£ed_Ën


1767 + 
SID_SIZE
 * 2);

1769 
	`ASSERT
(
	`buf_wr™e
(&
£ed
, 
Ïb–
, 
	`¡¾’
(label)));

1770 
	`ASSERT
(
	`buf_wr™e
(&
£ed
, 
ş›Á_£ed
, 
ş›Á_£ed_Ën
));

1771 
	`ASSERT
(
	`buf_wr™e
(&
£ed
, 
£rv”_£ed
, 
£rv”_£ed_Ën
));

1773 ià(
ş›Á_sid
)

1775 
	`ASSERT
(
	`buf_wr™e
(&
£ed
, 
ş›Á_sid
->
id
, 
SID_SIZE
));

1777 ià(
£rv”_sid
)

1779 
	`ASSERT
(
	`buf_wr™e
(&
£ed
, 
£rv”_sid
->
id
, 
SID_SIZE
));

1783 
	`s1_PRF
(
	`BPTR
(&
£ed
), 
	`BLEN
(&£ed), 
£ü‘
, 
£ü‘_Ën
, 
ouut
, 
ouut_Ën
);

1785 
	`buf_ş—r
(&
£ed
);

1786 
	`ä“_buf
(&
£ed
);

1788 
	`VALGRIND_MAKE_READABLE
((*)
ouut
, 
ouut_Ën
);

1789 
	}
}

1795 
boŞ


1796 
	$g’”©e_key_ex·nsiÚ
(
key_ùx_bi
 *
key
,

1797 cÚ¡ 
key_ty³
 *key_type,

1798 cÚ¡ 
key_sourû2
 *
key_¤c
,

1799 cÚ¡ 
£ssiÚ_id
 *
ş›Á_sid
,

1800 cÚ¡ 
£ssiÚ_id
 *
£rv”_sid
,

1801 
boŞ
 
£rv”
)

1803 
ušt8_t
 
ma¡”
[48] = { 0 };

1804 
key2
 key2 = { 0 };

1805 
boŞ
 
»t
 = 
çl£
;

1807 ià(
key
->
š™Ÿlized
)

1809 
	`msg
(
D_TLS_ERRORS
, "TLS Error: key‡lready initialized");

1810 
ex™
;

1814 
	`key_sourû2_´št
(
key_¤c
);

1817 
	`İ’v²_PRF
(
key_¤c
->
ş›Á
.
´e_ma¡”
,

1818 (
key_¤c
->
ş›Á
.
´e_ma¡”
),

1819 
KEY_EXPANSION_ID
 " master secret",

1820 
key_¤c
->
ş›Á
.
¿ndom1
,

1821 (
key_¤c
->
ş›Á
.
¿ndom1
),

1822 
key_¤c
->
£rv”
.
¿ndom1
,

1823 (
key_¤c
->
£rv”
.
¿ndom1
),

1824 
NULL
,

1825 
NULL
,

1826 
ma¡”
,

1827 (
ma¡”
));

1830 
	`İ’v²_PRF
(
ma¡”
,

1831 (
ma¡”
),

1832 
KEY_EXPANSION_ID
 " keyƒxpansion",

1833 
key_¤c
->
ş›Á
.
¿ndom2
,

1834 (
key_¤c
->
ş›Á
.
¿ndom2
),

1835 
key_¤c
->
£rv”
.
¿ndom2
,

1836 (
key_¤c
->
£rv”
.
¿ndom2
),

1837 
ş›Á_sid
,

1838 
£rv”_sid
,

1839 (
ušt8_t
 *)
key2
.
keys
,

1840 (
key2
.
keys
));

1842 
key2
.
n
 = 2;

1844 
	`key2_´št
(&
key2
, 
key_ty³
, "Master Encrypt", "Master Decrypt");

1847 
i
 = 0; i < 2; ++i)

1849 
	`fixup_key
(&
key2
.
keys
[
i
], 
key_ty³
);

1850 ià(!
	`check_key
(&
key2
.
keys
[
i
], 
key_ty³
))

1852 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Bad dynamic key generated");

1853 
ex™
;

1858 
key_dœeùiÚ
 = 
£rv”
 ? 
KEY_DIRECTION_INVERSE
 : 
KEY_DIRECTION_NORMAL
;

1859 
	`š™_key_ùx_bi
(
key
, &
key2
, 
key_dœeùiÚ
, 
key_ty³
, "Data Channel");

1862 
	`key_ùx_upd©e_im¶ic™_iv
(&
key
->
’üy±
, 
key2
.
keys
[()
£rv”
].
hmac
,

1863 
MAX_HMAC_KEY_LENGTH
);

1864 
	`key_ùx_upd©e_im¶ic™_iv
(&
key
->
deüy±
, 
key2
.
keys
[1-()
£rv”
].
hmac
,

1865 
MAX_HMAC_KEY_LENGTH
);

1867 
»t
 = 
Œue
;

1869 
ex™
:

1870 
	`£cu»_memz”o
(&
ma¡”
, (master));

1871 
	`£cu»_memz”o
(&
key2
, (key2));

1873  
»t
;

1874 
	}
}

1877 
	$key_ùx_upd©e_im¶ic™_iv
(
key_ùx
 *
ùx
, 
ušt8_t
 *
key
, 
size_t
 
key_Ën
)

1879 cÚ¡ 
ch”_kt_t
 *
ch”_kt
 = 
	`ch”_ùx_g‘_ch”_kt
(
ùx
->
ch”
);

1882 ià(
	`ch”_kt_mode_«ad
(
ch”_kt
))

1884 
size_t
 
im¶_iv_Ën
 = 0;

1885 
	`ASSERT
(
	`ch”_kt_iv_size
(
ch”_kt
è>ğ
OPENVPN_AEAD_MIN_IV_LEN
);

1886 
im¶_iv_Ën
 = 
	`ch”_kt_iv_size
(
ch”_kt
è- (
·ck‘_id_ty³
);

1887 
	`ASSERT
(
im¶_iv_Ën
 <ğ
OPENVPN_MAX_IV_LENGTH
);

1888 
	`ASSERT
(
im¶_iv_Ën
 <ğ
key_Ën
);

1889 
	`memıy
(
ùx
->
im¶ic™_iv
, 
key
, 
im¶_iv_Ën
);

1890 
ùx
->
im¶ic™_iv_Ën
 = 
im¶_iv_Ën
;

1892 
	}
}

1894 
boŞ


1895 
	$s_™em_š_ch”_li¡
(cÚ¡ *
™em
, cÚ¡ *
li¡
)

1897 *
tmp_ch”s
 = 
	`¡ršg_®loc
(
li¡
, 
NULL
);

1898 *
tmp_ch”s_Üig
 = 
tmp_ch”s
;

1900 cÚ¡ *
tok’
 = 
	`¡¹ok
(
tmp_ch”s
, ":");

1901 
tok’
)

1903 ià(0 =ğ
	`¡rcmp
(
tok’
, 
™em
))

1907 
tok’
 = 
	`¡¹ok
(
NULL
, ":");

1909 
	`ä“
(
tmp_ch”s_Üig
);

1911  
tok’
 !ğ
NULL
;

1912 
	}
}

1915 
	$s_poÜ_mªs_nı
(
İtiÚs
 *
o
, cÚ¡ *
»mÙe_ch”Çme
)

1917 ià(
o
->
nı_’abËd
 && 
»mÙe_ch”Çme


1918 && 0 !ğ
	`¡rcmp
(
o
->
ch”Çme
, 
»mÙe_ch”Çme
))

1920 ià(
	`s_™em_š_ch”_li¡
(
»mÙe_ch”Çme
, 
o
->
nı_ch”s
))

1922 
o
->
ch”Çme
 = 
	`¡ršg_®loc
(
»mÙe_ch”Çme
, &o->
gc
);

1923 
	`msg
(
D_TLS_DEBUG_LOW
, "Usšg…“¸ch” '%s'", 
o
->
ch”Çme
);

1926 
	}
}

1934 
boŞ


1935 
	$s_£ssiÚ_g’”©e_d©a_chªÃl_keys
(
s_£ssiÚ
 *
£ssiÚ
)

1937 
boŞ
 
»t
 = 
çl£
;

1938 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

1939 cÚ¡ 
£ssiÚ_id
 *
ş›Á_sid
 = 
£ssiÚ
->
İt
->
£rv”
 ?

1940 &
ks
->
£ssiÚ_id_»mÙe
 : &
£ssiÚ
->
£ssiÚ_id
;

1941 cÚ¡ 
£ssiÚ_id
 *
£rv”_sid
 = !
£ssiÚ
->
İt
->
£rv”
 ?

1942 &
ks
->
£ssiÚ_id_»mÙe
 : &
£ssiÚ
->
£ssiÚ_id
;

1944 
	`ASSERT
(
ks
->
auth’tiÿ‹d
);

1946 
ks
->
üy±o_İtiÚs
.
æags
 = 
£ssiÚ
->
İt
->
üy±o_æags
;

1947 ià(!
	`g’”©e_key_ex·nsiÚ
(&
ks
->
üy±o_İtiÚs
.
key_ùx_bi
,

1948 &
£ssiÚ
->
İt
->
key_ty³
, 
ks
->
key_¤c
, 
ş›Á_sid
, 
£rv”_sid
,

1949 
£ssiÚ
->
İt
->
£rv”
))

1951 
	`msg
(
D_TLS_ERRORS
, "TLS Error: generate_key_expansion failed");

1952 
ş—nup
;

1954 
	`s_lim™_»Ãg_by‹s
(
£ssiÚ
->
İt
->
key_ty³
.
ch”
,

1955 &
£ssiÚ
->
İt
->
»ÃgÙŸ‹_by‹s
);

1957 
»t
 = 
Œue
;

1958 
ş—nup
:

1959 
	`£cu»_memz”o
(
ks
->
key_¤c
, (*ks->key_src));

1960  
»t
;

1961 
	}
}

1963 
boŞ


1964 
	$s_£ssiÚ_upd©e_üy±o_·¿ms
(
s_£ssiÚ
 *
£ssiÚ
,

1965 
İtiÚs
 *İtiÚs, 
äame
 *frame)

1967 ià(!
£ssiÚ
->
İt
->
£rv”


1968 && 0 !ğ
	`¡rcmp
(
İtiÚs
->
ch”Çme
, 
£ssiÚ
->
İt
->
cÚfig_ch”Çme
)

1969 && !
	`s_™em_š_ch”_li¡
(
İtiÚs
->
ch”Çme
, o±iÚs->
nı_ch”s
))

1971 
	`msg
(
D_TLS_ERRORS
, "Error:…ushed cipher‚ot‡llowed - %s‚ot in %s or %s",

1972 
İtiÚs
->
ch”Çme
, 
£ssiÚ
->
İt
->
cÚfig_ch”Çme
,

1973 
İtiÚs
->
nı_ch”s
);

1975 
İtiÚs
->
ch”Çme
 = 
£ssiÚ
->
İt
->
cÚfig_ch”Çme
;

1976  
çl£
;

1979 ià(
	`¡rcmp
(
İtiÚs
->
ch”Çme
, 
£ssiÚ
->
İt
->
cÚfig_ch”Çme
))

1981 
	`msg
(
D_HANDSHAKE
, "Data Channel: using‚egotiated cipher '%s'",

1982 
İtiÚs
->
ch”Çme
);

1983 ià(
İtiÚs
->
keysize
)

1985 
	`msg
(
D_HANDSHAKE
, "NCP: overriding user-set keysize with default");

1986 
İtiÚs
->
keysize
 = 0;

1990 
	`š™_key_ty³
(&
£ssiÚ
->
İt
->
key_ty³
, 
İtiÚs
->
ch”Çme
,

1991 
İtiÚs
->
authÇme
, o±iÚs->
keysize
, 
Œue
,rue);

1993 
boŞ
 
·ck‘_id_lÚg_fÜm
 = 
	`ch”_kt_mode_ofb_cfb
(
£ssiÚ
->
İt
->
key_ty³
.
ch”
);

1994 
£ssiÚ
->
İt
->
üy±o_æags
 &ğ~(
CO_PACKET_ID_LONG_FORM
);

1995 ià(
·ck‘_id_lÚg_fÜm
)

1997 
£ssiÚ
->
İt
->
üy±o_æags
 |ğ
CO_PACKET_ID_LONG_FORM
;

2001 
	`äame_»move_äom_exŒa_äame
(
äame
, 
	`üy±o_max_ov”h—d
());

2002 
	`üy±o_adju¡_äame_·¿m‘”s
(
äame
, &
£ssiÚ
->
İt
->
key_ty³
,

2003 
İtiÚs
->
u£_iv
, o±iÚs->
»¶ay
, 
·ck‘_id_lÚg_fÜm
);

2004 
	`äame_fš®ize
(
äame
, 
İtiÚs
->
û
.
lšk_mtu_defšed
, o±iÚs->û.
lšk_mtu
,

2005 
İtiÚs
->
û
.
tun_mtu_defšed
, o±iÚs->û.
tun_mtu
);

2006 
	`äame_š™_mssfix
(
äame
, 
İtiÚs
);

2007 
	`äame_´št
(
äame
, 
D_MTU_INFO
, "Data Channel MTU…arms");

2009  
	`s_£ssiÚ_g’”©e_d©a_chªÃl_keys
(
£ssiÚ
);

2010 
	}
}

2012 
boŞ


2013 
	$¿ndom_by‹s_to_buf
(
bufãr
 *
buf
,

2014 
ušt8_t
 *
out
,

2015 
ou’
)

2017 ià(!
	`¿nd_by‹s
(
out
, 
ou’
))

2019 
	`msg
(
M_FATAL
, "ERROR: Random‚umber generator cannot obtainƒntropy for key generation [SSL]");

2021 ià(!
	`buf_wr™e
(
buf
, 
out
, 
ou’
))

2023  
çl£
;

2025  
Œue
;

2026 
	}
}

2028 
boŞ


2029 
	$key_sourû2_¿ndomize_wr™e
(
key_sourû2
 *
k2
,

2030 
bufãr
 *
buf
,

2031 
boŞ
 
£rv”
)

2033 
key_sourû
 *
k
 = &
k2
->
ş›Á
;

2034 ià(
£rv”
)

2036 
k
 = &
k2
->
£rv”
;

2039 
	`CLEAR
(*
k
);

2041 ià(!
£rv”
)

2043 ià(!
	`¿ndom_by‹s_to_buf
(
buf
, 
k
->
´e_ma¡”
, (k->pre_master)))

2045  
çl£
;

2049 ià(!
	`¿ndom_by‹s_to_buf
(
buf
, 
k
->
¿ndom1
, (k->random1)))

2051  
çl£
;

2053 ià(!
	`¿ndom_by‹s_to_buf
(
buf
, 
k
->
¿ndom2
, (k->random2)))

2055  
çl£
;

2058  
Œue
;

2059 
	}
}

2062 
	$key_sourû2_»ad
(
key_sourû2
 *
k2
,

2063 
bufãr
 *
buf
,

2064 
boŞ
 
£rv”
)

2066 
key_sourû
 *
k
 = &
k2
->
ş›Á
;

2068 ià(!
£rv”
)

2070 
k
 = &
k2
->
£rv”
;

2073 
	`CLEAR
(*
k
);

2075 ià(
£rv”
)

2077 ià(!
	`buf_»ad
(
buf
, 
k
->
´e_ma¡”
, (k->pre_master)))

2083 ià(!
	`buf_»ad
(
buf
, 
k
->
¿ndom1
, (k->random1)))

2087 ià(!
	`buf_»ad
(
buf
, 
k
->
¿ndom2
, (k->random2)))

2093 
	}
}

2096 
	$æush_·ylßd_bufãr
(
key_¡©e
 *
ks
)

2098 
bufãr
 *
b
;

2100 (
b
 = 
	`bufãr_li¡_³ek
(
ks
->
·ybuf
)))

2102 
	`key_¡©e_wr™e_¶aš‹xt_cÚ¡
(&
ks
->
ks_s¦
, 
b
->
d©a
, b->
Ën
);

2103 
	`bufãr_li¡_pİ
(
ks
->
·ybuf
);

2105 
	}
}

2108 
	#FULL_SYNC
 \

2109 (
	`»lŸbË_em±y
(
ks
->
£nd_»lŸbË
è&& 
	`»lŸbË_ack_em±y
(ks->
»c_ack
))

	)

2116 
	$key_¡©e_soá_»£t
(
s_£ssiÚ
 *
£ssiÚ
)

2118 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2119 
key_¡©e
 *
ks_Ïme
 = &
£ssiÚ
->
key
[
KS_LAME_DUCK
];

2121 
ks
->
mu¡_d›
 = 
now
 + 
£ssiÚ
->
İt
->
Œªs™iÚ_wšdow
;

2122 
	`key_¡©e_ä“
(
ks_Ïme
, 
çl£
);

2123 *
ks_Ïme
 = *
ks
;

2125 
	`key_¡©e_š™
(
£ssiÚ
, 
ks
);

2126 
ks
->
£ssiÚ_id_»mÙe
 = 
ks_Ïme
->session_id_remote;

2127 
ks
->
»mÙe_addr
 = 
ks_Ïme
->remote_addr;

2128 
	}
}

2134 
boŞ


2135 
	$wr™e_em±y_¡ršg
(
bufãr
 *
buf
)

2137 ià(!
	`buf_wr™e_u16
(
buf
, 0))

2139  
çl£
;

2141  
Œue
;

2142 
	}
}

2144 
boŞ


2145 
	$wr™e_¡ršg
(
bufãr
 *
buf
, cÚ¡ *
¡r
, cÚ¡ 
maxËn
)

2147 cÚ¡ 
Ën
 = 
	`¡¾’
(
¡r
) + 1;

2148 ià(
Ën
 < 1 || (
maxËn
 >= 0 &&†en > maxlen))

2150  
çl£
;

2152 ià(!
	`buf_wr™e_u16
(
buf
, 
Ën
))

2154  
çl£
;

2156 ià(!
	`buf_wr™e
(
buf
, 
¡r
, 
Ën
))

2158  
çl£
;

2160  
Œue
;

2161 
	}
}

2163 
boŞ


2164 
	$»ad_¡ršg
(
bufãr
 *
buf
, *
¡r
, cÚ¡ 
ÿ·c™y
)

2166 cÚ¡ 
Ën
 = 
	`buf_»ad_u16
(
buf
);

2167 ià(
Ën
 < 1 ||†’ > ()
ÿ·c™y
)

2169  
çl£
;

2171 ià(!
	`buf_»ad
(
buf
, 
¡r
, 
Ën
))

2173  
çl£
;

2175 
¡r
[
Ën
-1] = '\0';

2176  
Œue
;

2177 
	}
}

2180 
	$»ad_¡ršg_®loc
(
bufãr
 *
buf
)

2182 cÚ¡ 
Ën
 = 
	`buf_»ad_u16
(
buf
);

2183 *
¡r
;

2185 ià(
Ën
 < 1)

2187  
NULL
;

2189 
¡r
 = (*è
	`m®loc
(
Ën
);

2190 
	`check_m®loc_»tuº
(
¡r
);

2191 ià(!
	`buf_»ad
(
buf
, 
¡r
, 
Ën
))

2193 
	`ä“
(
¡r
);

2194  
NULL
;

2196 
¡r
[
Ën
-1] = '\0';

2197  
¡r
;

2198 
	}
}

2205 
boŞ


2206 
	$key_m‘hod_1_wr™e
(
bufãr
 *
buf
, 
s_£ssiÚ
 *
£ssiÚ
)

2208 
key
 key;

2209 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2211 
	`ASSERT
(
£ssiÚ
->
İt
->
key_m‘hod
 == 1);

2212 
	`ASSERT
(
	`buf_š™
(
buf
, 0));

2214 
	`g’”©e_key_¿ndom
(&
key
, &
£ssiÚ
->
İt
->
key_ty³
);

2215 ià(!
	`check_key
(&
key
, &
£ssiÚ
->
İt
->
key_ty³
))

2217 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Badƒncrypting key generated");

2218  
çl£
;

2221 ià(!
	`wr™e_key
(&
key
, &
£ssiÚ
->
İt
->
key_ty³
, 
buf
))

2223 
	`msg
(
D_TLS_ERRORS
, "TLS Error: write_key failed");

2224  
çl£
;

2227 
	`š™_key_ùx
(&
ks
->
üy±o_İtiÚs
.
key_ùx_bi
.
’üy±
, &
key
,

2228 &
£ssiÚ
->
İt
->
key_ty³
, 
OPENVPN_OP_ENCRYPT
,

2230 
	`£cu»_memz”o
(&
key
, (key));

2234 cÚ¡ *
loÿl_İtiÚs
 = 
	`loÿl_İtiÚs_¡ršg
(
£ssiÚ
);

2235 cÚ¡ 
İ’
 = 
	`¡¾’
(
loÿl_İtiÚs
) + 1;

2236 ià(!
	`buf_wr™e
(
buf
, 
loÿl_İtiÚs
, 
İ’
))

2238 
	`msg
(
D_TLS_ERRORS
, "TLS Error: KM1 write options failed");

2239  
çl£
;

2243  
Œue
;

2244 
	}
}

2246 
boŞ


2247 
	$push_³”_šfo
(
bufãr
 *
buf
, 
s_£ssiÚ
 *
£ssiÚ
)

2249 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2250 
boŞ
 
»t
 = 
çl£
;

2252 #ifdeà
ENABLE_PUSH_PEER_INFO


2253 ià(
£ssiÚ
->
İt
->
push_³”_šfo_d‘a
 > 0)

2255 
’v_£t
 *
es
 = 
£ssiÚ
->
İt
->es;

2256 
’v_™em
 *
e
;

2257 
bufãr
 
out
 = 
	`®loc_buf_gc
(512*3, &
gc
);

2260 
	`buf_´štf
(&
out
, "IV_VER=%s\n", 
PACKAGE_VERSION
);

2263 #ià
	`defšed
(
TARGET_LINUX
)

2264 
	`buf_´štf
(&
out
, "IV_PLAT=linux\n");

2265 #–ià
	`defšed
(
TARGET_SOLARIS
)

2266 
	`buf_´štf
(&
out
, "IV_PLAT=solaris\n");

2267 #–ià
	`defšed
(
TARGET_OPENBSD
)

2268 
	`buf_´štf
(&
out
, "IV_PLAT=openbsd\n");

2269 #–ià
	`defšed
(
TARGET_DARWIN
)

2270 
	`buf_´štf
(&
out
, "IV_PLAT=mac\n");

2271 #–ià
	`defšed
(
TARGET_NETBSD
)

2272 
	`buf_´štf
(&
out
, "IV_PLAT=netbsd\n");

2273 #–ià
	`defšed
(
TARGET_FREEBSD
)

2274 
	`buf_´štf
(&
out
, "IV_PLAT=freebsd\n");

2275 #–ià
	`defšed
(
TARGET_ANDROID
)

2276 
	`buf_´štf
(&
out
, "IV_PLAT=android\n");

2277 #–ià
	`defšed
(
_WIN32
)

2278 
	`buf_´štf
(&
out
, "IV_PLAT=win\n");

2282 
	`buf_´štf
(&
out
, "IV_PROTO=2\n");

2285 ià(
£ssiÚ
->
İt
->
nı_’abËd


2286 && (
£ssiÚ
->
İt
->
mode
 =ğ
MODE_SERVER
 || sessiÚ->İt->
puÎ
))

2288 
	`buf_´štf
(&
out
, "IV_NCP=2\n");

2292 #ifdeà
USE_COMP


2293 
	`comp_g’”©e_³”_šfo_¡ršg
(&
£ssiÚ
->
İt
->
comp_İtiÚs
, &
out
);

2296 ià(
£ssiÚ
->
İt
->
push_³”_šfo_d‘a
 >= 2)

2299 
rou‹_g©eway_šfo
 
rgi
;

2300 
	`g‘_deçuÉ_g©eway
(&
rgi
);

2301 ià(
rgi
.
æags
 & 
RGI_HWADDR_DEFINED
)

2303 
	`buf_´štf
(&
out
, "IV_HWADDR=%s\n", 
	`fÜm©_hex_ex
(
rgi
.
hwaddr
, 6, 0, 1, ":", &
gc
));

2305 
	`buf_´štf
(&
out
, "IV_SSL=%s\n", 
	`g‘_s¦_lib¿ry_v”siÚ
() );

2306 #ià
	`defšed
(
_WIN32
)

2307 
	`buf_´štf
(&
out
, "IV_PLAT_VER=%s\n", 
	`wš32_v”siÚ_¡ršg
(&
gc
, 
çl£
));

2312 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

2314 ià(
e
->
¡ršg
)

2316 ià((((
	`¡ºcmp
(
e
->
¡ršg
, "UV_", 3)==0

2317 || 
	`¡ºcmp
(
e
->
¡ršg
, "IV_PLAT_VER=", ("IV_PLAT_VER=")-1)==0)

2318 && 
£ssiÚ
->
İt
->
push_³”_šfo_d‘a
 >= 2)

2319 || (
	`¡ºcmp
(
e
->
¡ršg
,"IV_GUI_VER=",("IV_GUI_VER=")-1)==0))

2320 && 
	`buf_§ã
(&
out
, 
	`¡¾’
(
e
->
¡ršg
)+1))

2322 
	`buf_´štf
(&
out
, "%s\n", 
e
->
¡ršg
);

2327 ià(!
	`wr™e_¡ršg
(
buf
, 
	`BSTR
(&
out
), -1))

2329 
”rÜ
;

2335 ià(!
	`wr™e_em±y_¡ršg
(
buf
))

2337 
”rÜ
;

2340 
»t
 = 
Œue
;

2342 
”rÜ
:

2343 
	`gc_ä“
(&
gc
);

2344  
»t
;

2345 
	}
}

2347 
boŞ


2348 
	$key_m‘hod_2_wr™e
(
bufãr
 *
buf
, 
s_£ssiÚ
 *
£ssiÚ
)

2350 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2352 
	`ASSERT
(
£ssiÚ
->
İt
->
key_m‘hod
 == 2);

2353 
	`ASSERT
(
	`buf_š™
(
buf
, 0));

2356 ià(!
	`buf_wr™e_u32
(
buf
, 0))

2358 
”rÜ
;

2362 ià(!
	`buf_wr™e_u8
(
buf
, (
£ssiÚ
->
İt
->
key_m‘hod
 & 
KEY_METHOD_MASK
)))

2364 
”rÜ
;

2368 ià(!
	`key_sourû2_¿ndomize_wr™e
(
ks
->
key_¤c
, 
buf
, 
£ssiÚ
->
İt
->
£rv”
))

2370 
”rÜ
;

2375 ià(!
	`wr™e_¡ršg
(
buf
, 
	`loÿl_İtiÚs_¡ršg
(
£ssiÚ
), 
TLS_OPTIONS_LEN
))

2377 
”rÜ
;

2382 ià(
auth_u£r_·ss_’abËd
)

2384 #ifdeà
ENABLE_CLIENT_CR


2385 
	`auth_u£r_·ss_£tup
(
£ssiÚ
->
İt
->
auth_u£r_·ss_fe
, sessiÚ->İt->
sci
);

2387 
	`auth_u£r_·ss_£tup
(
£ssiÚ
->
İt
->
auth_u£r_·ss_fe
, 
NULL
);

2389 
u£r_·ss
 *
up
 = &
auth_u£r_·ss
;

2395 ià(
auth_tok’
.
defšed
)

2396 
up
 = &
auth_tok’
;

2398 ià(!
	`wr™e_¡ršg
(
buf
, 
up
->
u£ºame
, -1))

2400 
”rÜ
;

2402 ià(!
	`wr™e_¡ršg
(
buf
, 
up
->
·sswÜd
, -1))

2404 
”rÜ
;

2415 ià(!
auth_u£r_·ss
.
wa™_fÜ_push
)

2417 
	`purge_u£r_·ss
(&
auth_u£r_·ss
, 
çl£
);

2422 ià(!
	`wr™e_em±y_¡ršg
(
buf
))

2424 
”rÜ
;

2426 ià(!
	`wr™e_em±y_¡ršg
(
buf
))

2428 
”rÜ
;

2432 ià(!
	`push_³”_šfo
(
buf
, 
£ssiÚ
))

2434 
”rÜ
;

2442 ià(
£ssiÚ
->
İt
->
£rv”
 && !(£ssiÚ->İt->
nı_’abËd


2443 && 
£ssiÚ
->
İt
->
mode
 =ğ
MODE_SERVER
 && 
ks
->
key_id
 <= 0))

2445 ià(
ks
->
auth’tiÿ‹d
)

2447 ià(!
	`s_£ssiÚ_g’”©e_d©a_chªÃl_keys
(
£ssiÚ
))

2449 
	`msg
(
D_TLS_ERRORS
, "TLS Error: server generate_key_expansion failed");

2450 
”rÜ
;

2455  
Œue
;

2457 
”rÜ
:

2458 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Key Method #2 write failed");

2459 
	`£cu»_memz”o
(
ks
->
key_¤c
, (*ks->key_src));

2460  
çl£
;

2461 
	}
}

2463 
boŞ


2464 
	$key_m‘hod_1_»ad
(
bufãr
 *
buf
, 
s_£ssiÚ
 *
£ssiÚ
)

2466 
¡©us
;

2467 
key
 key;

2468 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2470 
	`ASSERT
(
£ssiÚ
->
İt
->
key_m‘hod
 == 1);

2472 ià(!
£ssiÚ
->
v”if›d
)

2474 
	`msg
(
D_TLS_ERRORS
,

2476 
”rÜ
;

2479 
¡©us
 = 
	`»ad_key
(&
key
, &
£ssiÚ
->
İt
->
key_ty³
, 
buf
);

2480 ià(
¡©us
 != 1)

2482 
	`msg
(
D_TLS_ERRORS
,

2484 
”rÜ
;

2487 ià(!
	`check_key
(&
key
, &
£ssiÚ
->
İt
->
key_ty³
))

2489 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Bad decrypting key„eceived from…eer");

2490 
”rÜ
;

2493 ià(
buf
->
Ën
 < 1)

2495 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Missing options string");

2496 
”rÜ
;

2499 #ifdeà
ENABLE_OCC


2502 ià(!
£ssiÚ
->
İt
->
di§bË_occ


2503 && !
	`İtiÚs_cmp_equ®_§ã
((*è
	`BPTR
(
buf
), 
£ssiÚ
->
İt
->
»mÙe_İtiÚs
, buf->
Ën
))

2505 
	`İtiÚs_w¬nšg_§ã
((*è
	`BPTR
(
buf
), 
£ssiÚ
->
İt
->
»mÙe_İtiÚs
, buf->
Ën
);

2509 
	`buf_ş—r
(
buf
);

2511 
	`š™_key_ùx
(&
ks
->
üy±o_İtiÚs
.
key_ùx_bi
.
deüy±
, &
key
,

2512 &
£ssiÚ
->
İt
->
key_ty³
, 
OPENVPN_OP_DECRYPT
,

2514 
	`£cu»_memz”o
(&
key
, (key));

2515 
ks
->
auth’tiÿ‹d
 = 
Œue
;

2516  
Œue
;

2518 
”rÜ
:

2519 
	`buf_ş—r
(
buf
);

2520 
	`£cu»_memz”o
(&
key
, (key));

2521  
çl£
;

2522 
	}
}

2524 
boŞ


2525 
	$key_m‘hod_2_»ad
(
bufãr
 *
buf
, 
s_muÉi
 *
muÉi
, 
s_£ssiÚ
 *
£ssiÚ
)

2527 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2529 
key_m‘hod_æags
;

2530 
boŞ
 
u£ºame_¡©us
, 
·sswÜd_¡©us
;

2532 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2533 *
İtiÚs
;

2534 
u£r_·ss
 *
up
 = 
NULL
;

2537 
	`ALLOC_ARRAY_CLEAR_GC
(
İtiÚs
, , 
TLS_OPTIONS_LEN
, &
gc
);

2539 
	`ASSERT
(
£ssiÚ
->
İt
->
key_m‘hod
 == 2);

2542 ià(!
	`buf_advªû
(
buf
, 4))

2544 
	`msg
(
D_TLS_ERRORS
, "TLS ERROR: Plaintext bufferoo short (%d bytes).",

2545 
buf
->
Ën
);

2546 
”rÜ
;

2550 
key_m‘hod_æags
 = 
	`buf_»ad_u8
(
buf
);

2551 ià((
key_m‘hod_æags
 & 
KEY_METHOD_MASK
) != 2)

2553 
	`msg
(
D_TLS_ERRORS
,

2555 
key_m‘hod_æags
);

2556 
”rÜ
;

2560 ià(!
	`key_sourû2_»ad
(
ks
->
key_¤c
, 
buf
, 
£ssiÚ
->
İt
->
£rv”
))

2562 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Error„eading„emote data channel key sourceƒntropy from…laintext buffer");

2563 
”rÜ
;

2567 ià(!
	`»ad_¡ršg
(
buf
, 
İtiÚs
, 
TLS_OPTIONS_LEN
))

2569 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Failedo„ead„equired OCC options string");

2570 
”rÜ
;

2573 
ks
->
auth’tiÿ‹d
 = 
çl£
;

2579 
	`ALLOC_OBJ_CLEAR_GC
(
up
, 
u£r_·ss
, &
gc
);

2580 
u£ºame_¡©us
 = 
	`»ad_¡ršg
(
buf
, 
up
->
u£ºame
, 
USER_PASS_LEN
);

2581 
·sswÜd_¡©us
 = 
	`»ad_¡ršg
(
buf
, 
up
->
·sswÜd
, 
USER_PASS_LEN
);

2583 #ià
P2MP_SERVER


2585 
	`ä“
(
muÉi
->
³”_šfo
);

2586 
muÉi
->
³”_šfo
 = 
	`»ad_¡ršg_®loc
(
buf
);

2587 ià(
muÉi
->
³”_šfo
)

2589 
	`ouut_³”_šfo_’v
(
£ssiÚ
->
İt
->
es
, 
muÉi
->
³”_šfo
);

2592 
	`ä“
(
muÉi
->
»mÙe_ch”Çme
);

2593 
muÉi
->
»mÙe_ch”Çme
 =

2594 
	`İtiÚs_¡ršg_exŒaù_İtiÚ
(
İtiÚs
, "ch”", 
NULL
);

2596 ià(
	`s_³”_šfo_nı_v”
(
muÉi
->
³”_šfo
) < 2)

2601 ià(
muÉi
->
»mÙe_ch”Çme
 =ğ
NULL


2602 || 0 =ğ
	`¡rcmp
(
muÉi
->
»mÙe_ch”Çme
, muÉi->
İt
.
cÚfig_ch”Çme
))

2604 
£ssiÚ
->
İt
->
nı_’abËd
 = 
çl£
;

2609 ià(
	`s_£ssiÚ_u£r_·ss_’abËd
(
£ssiÚ
))

2612 ià(!
u£ºame_¡©us
 || !
·sswÜd_¡©us
)

2614 
	`CLEAR
(*
up
);

2615 ià(!(
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
))

2617 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Auth Username/Password was‚ot…rovided by…eer");

2618 
”rÜ
;

2622 
	`v”ify_u£r_·ss
(
up
, 
muÉi
, 
£ssiÚ
);

2627 ià(!
£ssiÚ
->
v”if›d
)

2629 
	`msg
(
D_TLS_ERRORS
,

2631 
”rÜ
;

2633 
ks
->
auth’tiÿ‹d
 = 
Œue
;

2637 
	`£cu»_memz”o
(
up
, (*up));

2640 ià(
ks
->
auth’tiÿ‹d
)

2642 
	`v”ify_fš®_auth_checks
(
muÉi
, 
£ssiÚ
);

2645 #ifdeà
ENABLE_OCC


2647 ià(!
£ssiÚ
->
İt
->
di§bË_occ


2648 && !
	`İtiÚs_cmp_equ®
(
İtiÚs
, 
£ssiÚ
->
İt
->
»mÙe_İtiÚs
))

2650 
	`İtiÚs_w¬nšg
(
İtiÚs
, 
£ssiÚ
->
İt
->
»mÙe_İtiÚs
);

2651 ià(
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_OPT_VERIFY
)

2653 
	`msg
(
D_TLS_ERRORS
, "Option inconsistency warningsriggering disconnect dueo --opt-verify");

2654 
ks
->
auth’tiÿ‹d
 = 
çl£
;

2659 
	`buf_ş—r
(
buf
);

2665 ià(
ks
->
auth’tiÿ‹d
 && 
	`¶ugš_defšed
(
£ssiÚ
->
İt
->
¶ugšs
, 
OPENVPN_PLUGIN_TLS_FINAL
))

2667 
	`key_¡©e_expÜt_keyšg_m©”Ÿl
(&
ks
->
ks_s¦
, 
£ssiÚ
);

2669 ià(
	`¶ugš_ÿÎ
(
£ssiÚ
->
İt
->
¶ugšs
, 
OPENVPN_PLUGIN_TLS_FINAL
, 
NULL
, NULL, sessiÚ->İt->
es
è!ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

2671 
ks
->
auth’tiÿ‹d
 = 
çl£
;

2674 
	`£‹nv_d–
(
£ssiÚ
->
İt
->
es
, "exported_keying_material");

2682 ià(!
£ssiÚ
->
İt
->
£rv”
 && (!£ssiÚ->İt->
puÎ
 || 
ks
->
key_id
 > 0))

2684 ià(!
	`s_£ssiÚ_g’”©e_d©a_chªÃl_keys
(
£ssiÚ
))

2686 
	`msg
(
D_TLS_ERRORS
, "TLS Error: client generate_key_expansion failed");

2687 
”rÜ
;

2691 
	`gc_ä“
(&
gc
);

2692  
Œue
;

2694 
”rÜ
:

2695 
	`£cu»_memz”o
(
ks
->
key_¤c
, (*ks->key_src));

2696 ià(
up
)

2698 
	`£cu»_memz”o
(
up
, (*up));

2700 
	`buf_ş—r
(
buf
);

2701 
	`gc_ä“
(&
gc
);

2702  
çl£
;

2703 
	}
}

2706 
	$auth_deã¼ed_expœe_wšdow
(cÚ¡ 
s_İtiÚs
 *
o
)

2708 
»t
 = 
o
->
hªdshake_wšdow
;

2709 cÚ¡ 
r2
 = 
o
->
»ÃgÙŸ‹_£cÚds
 / 2;

2711 ià(
o
->
»ÃgÙŸ‹_£cÚds
 && 
r2
 < 
»t
)

2713 
»t
 = 
r2
;

2715  
»t
;

2716 
	}
}

2727 
boŞ


2728 
	$s_´oûss
(
s_muÉi
 *
muÉi
,

2729 
s_£ssiÚ
 *
£ssiÚ
,

2730 
bufãr
 *
to_lšk
,

2731 
lšk_sock‘_aùu®
 **
to_lšk_addr
,

2732 
lšk_sock‘_šfo
 *
to_lšk_sock‘_šfo
,

2733 
š‹rv®_t
 *
wakeup
)

2735 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2736 
bufãr
 *
buf
;

2737 
boŞ
 
¡©e_chªge
 = 
çl£
;

2738 
boŞ
 
aùive
 = 
çl£
;

2739 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

2740 
key_¡©e
 *
ks_Ïme
 = &
£ssiÚ
->
key
[
KS_LAME_DUCK
];

2743 
	`ASSERT
(
ks
->
¡©e
 !ğ
S_UNDEF
);

2744 
	`ASSERT
(
ks
->
¡©e
 !ğ
S_ERROR
);

2745 
	`ASSERT
(
	`£ssiÚ_id_defšed
(&
£ssiÚ
->
£ssiÚ_id
));

2748 ià(
ks
->
¡©e
 >ğ
S_ACTIVE


2749 && ((
£ssiÚ
->
İt
->
»ÃgÙŸ‹_£cÚds


2750 && 
now
 >ğ
ks
->
e¡ablished
 + 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_£cÚds
)

2751 || (
£ssiÚ
->
İt
->
»ÃgÙŸ‹_by‹s
 > 0

2752 && 
ks
->
n_by‹s
 >ğ
£ssiÚ
->
İt
->
»ÃgÙŸ‹_by‹s
)

2753 || (
£ssiÚ
->
İt
->
»ÃgÙŸ‹_·ck‘s


2754 && 
ks
->
n_·ck‘s
 >ğ
£ssiÚ
->
İt
->
»ÃgÙŸ‹_·ck‘s
)

2755 || (
	`·ck‘_id_şo£_to_w¿µšg
(&
ks
->
üy±o_İtiÚs
.
·ck‘_id
.
£nd
))))

2757 
	`msg
(
D_TLS_DEBUG_LOW
,

2758 "TLS: soá„e£ˆ£c=%d by‹s=" 
couÁ”_fÜm©
 "/%d…kts=" counter_format "/%d",

2759 ()(
ks
->
e¡ablished
 + 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_£cÚds
 - 
now
),

2760 
ks
->
n_by‹s
, 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_by‹s
,

2761 
ks
->
n_·ck‘s
, 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_·ck‘s
);

2762 
	`key_¡©e_soá_»£t
(
£ssiÚ
);

2766 ià(
	`Ïme_duck_mu¡_d›
(
£ssiÚ
, 
wakeup
))

2768 
	`key_¡©e_ä“
(
ks_Ïme
, 
Œue
);

2769 
	`msg
(
D_TLS_DEBUG_LOW
, "TLS:ls_process: killedƒxpiring key");

2774 
	`upd©e_time
();

2776 
	`dmsg
(
D_TLS_DEBUG
, "TLS:ls_process: chg=%d ks=%s†ame=%so_link->len=%d wakeup=%d",

2777 
¡©e_chªge
,

2778 
	`¡©e_Çme
(
ks
->
¡©e
),

2779 
	`¡©e_Çme
(
ks_Ïme
->
¡©e
),

2780 
to_lšk
->
Ën
,

2781 *
wakeup
);

2783 
¡©e_chªge
 = 
çl£
;

2794 ià(
ks
->
¡©e
 =ğ
S_INITIAL
)

2796 
buf
 = 
	`»lŸbË_g‘_buf_ouut_£qu’ûd
(
ks
->
£nd_»lŸbË
);

2797 ià(
buf
)

2799 
ks
->
mu¡_ÃgÙŸ‹
 = 
now
 + 
£ssiÚ
->
İt
->
hªdshake_wšdow
;

2800 
ks
->
auth_deã¼ed_expœe
 = 
now
 + 
	`auth_deã¼ed_expœe_wšdow
(
£ssiÚ
->
İt
);

2803 
	`»lŸbË_m¬k_aùive_outgošg
(
ks
->
£nd_»lŸbË
, 
buf
, ks->
š™Ÿl_İcode
);

2804 
INCR_GENERATED
;

2806 
ks
->
¡©e
 = 
S_PRE_START
;

2807 
¡©e_chªge
 = 
Œue
;

2808 
	`dmsg
(
D_TLS_DEBUG
, "TLS: Initial Handshake, sid=%s",

2809 
	`£ssiÚ_id_´št
(&
£ssiÚ
->
£ssiÚ_id
, &
gc
));

2811 #ifdeà
ENABLE_MANAGEMENT


2812 ià(
mªagem’t
 && 
ks
->
š™Ÿl_İcode
 !ğ
P_CONTROL_SOFT_RESET_V1
)

2814 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

2815 
OPENVPN_STATE_WAIT
,

2816 
NULL
,

2817 
NULL
,

2818 
NULL
,

2819 
NULL
,

2820 
NULL
);

2827 ià(
now
 >ğ
ks
->
mu¡_ÃgÙŸ‹
)

2829 ià(
ks
->
¡©e
 < 
S_ACTIVE
)

2831 
	`msg
(
D_TLS_ERRORS
,

2833 
£ssiÚ
->
İt
->
hªdshake_wšdow
);

2834 
”rÜ
;

2838 
	`dmsg
(
D_TLS_DEBUG_MED
, "STATE S_NORMAL_OP");

2839 
ks
->
¡©e
 = 
S_NORMAL_OP
;

2840 
ks
->
mu¡_ÃgÙŸ‹
 = 0;

2845 ià(
ks
->
¡©e
 =ğ
S_PRE_START
 && 
FULL_SYNC
)

2847 
ks
->
¡©e
 = 
S_START
;

2848 
¡©e_chªge
 = 
Œue
;

2854 ià(
£ssiÚ
->
İt
->
ül_fe


2855 && !(
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
))

2857 
	`s_ùx_»lßd_ül
(&
£ssiÚ
->
İt
->
s¦_ùx
,

2858 
£ssiÚ
->
İt
->
ül_fe
, sessiÚ->İt->
ül_fe_šlše
);

2862 
	`s_x509_ş—r_’v
(
£ssiÚ
->
İt
->
es
);

2864 
	`dmsg
(
D_TLS_DEBUG_MED
, "STATE S_START");

2868 ià(((
ks
->
¡©e
 =ğ
S_GOT_KEY
 && !
£ssiÚ
->
İt
->
£rv”
)

2869 || (
ks
->
¡©e
 =ğ
S_SENT_KEY
 && 
£ssiÚ
->
İt
->
£rv”
)))

2871 ià(
FULL_SYNC
)

2873 
ks
->
e¡ablished
 = 
now
;

2874 
	`dmsg
(
D_TLS_DEBUG_MED
, "STATE S_ACTIVE");

2875 ià(
	`check_debug_Ëv–
(
D_HANDSHAKE
))

2877 
	`´št_d‘as
(&
ks
->
ks_s¦
, "Control Channel:");

2879 
¡©e_chªge
 = 
Œue
;

2880 
ks
->
¡©e
 = 
S_ACTIVE
;

2881 
INCR_SUCCESS
;

2884 
	`lšk_sock‘_£t_outgošg_addr
(
NULL
, 
to_lšk_sock‘_šfo
, &
ks
->
»mÙe_addr
, 
£ssiÚ
->
commÚ_Çme
, sessiÚ->
İt
->
es
);

2887 
	`æush_·ylßd_bufãr
(
ks
);

2889 #ifdeà
MEASURE_TLS_HANDSHAKE_STATS


2890 
	`show_s_³rfÜmªû_¡©s
();

2897 ià(!
to_lšk
->
Ën
 && 
	`»lŸbË_ÿn_£nd
(
ks
->
£nd_»lŸbË
))

2899 
İcode
;

2900 
bufãr
 
b
;

2902 
buf
 = 
	`»lŸbË_£nd
(
ks
->
£nd_»lŸbË
, &
İcode
);

2903 
	`ASSERT
(
buf
);

2904 
b
 = *
buf
;

2905 
INCR_SENT
;

2907 
	`wr™e_cÚŒŞ_auth
(
£ssiÚ
, 
ks
, &
b
, 
to_lšk_addr
, 
İcode
,

2908 
CONTROL_SEND_ACK_MAX
, 
Œue
);

2909 *
to_lšk
 = 
b
;

2910 
aùive
 = 
Œue
;

2911 
¡©e_chªge
 = 
Œue
;

2912 
	`dmsg
(
D_TLS_DEBUG
, "Reliable -> TCP/UDP");

2917 
buf
 = 
	`»lŸbË_g‘_buf_£qu’ûd
(
ks
->
»c_»lŸbË
);

2918 ià(
buf
)

2920 
¡©us
 = 0;

2921 ià(
buf
->
Ën
)

2923 
¡©us
 = 
	`key_¡©e_wr™e_ch”‹xt
(&
ks
->
ks_s¦
, 
buf
);

2924 ià(
¡©us
 == -1)

2926 
	`msg
(
D_TLS_ERRORS
,

2928 
”rÜ
;

2933 
¡©us
 = 1;

2935 ià(
¡©us
 == 1)

2937 
	`»lŸbË_m¬k_d–‘ed
(
ks
->
»c_»lŸbË
, 
buf
, 
Œue
);

2938 
¡©e_chªge
 = 
Œue
;

2939 
	`dmsg
(
D_TLS_DEBUG
, "Incoming Ciphertext -> TLS");

2944 
buf
 = &
ks
->
¶aš‹xt_»ad_buf
;

2945 ià(!
buf
->
Ën
)

2947 
¡©us
;

2949 
	`ASSERT
(
	`buf_š™
(
buf
, 0));

2950 
¡©us
 = 
	`key_¡©e_»ad_¶aš‹xt
(&
ks
->
ks_s¦
, 
buf
, 
TLS_CHANNEL_BUF_SIZE
);

2951 
	`upd©e_time
();

2952 ià(
¡©us
 == -1)

2954 
	`msg
(
D_TLS_ERRORS
, "TLS Error: TLS object -> incoming…laintext„eadƒrror");

2955 
”rÜ
;

2957 ià(
¡©us
 == 1)

2959 
¡©e_chªge
 = 
Œue
;

2960 
	`dmsg
(
D_TLS_DEBUG
, "TLS -> Incoming Plaintext");

2963 *
wakeup
 = 0;

2968 
buf
 = &
ks
->
¶aš‹xt_wr™e_buf
;

2969 ià(!
buf
->
Ën
 && ((
ks
->
¡©e
 =ğ
S_START
 && !
£ssiÚ
->
İt
->
£rv”
)

2970 || (
ks
->
¡©e
 =ğ
S_GOT_KEY
 && 
£ssiÚ
->
İt
->
£rv”
)))

2972 ià(
£ssiÚ
->
İt
->
key_m‘hod
 == 1)

2974 ià(!
	`key_m‘hod_1_wr™e
(
buf
, 
£ssiÚ
))

2976 
”rÜ
;

2979 ià(
£ssiÚ
->
İt
->
key_m‘hod
 == 2)

2981 ià(!
	`key_m‘hod_2_wr™e
(
buf
, 
£ssiÚ
))

2983 
”rÜ
;

2988 
	`ASSERT
(0);

2991 
¡©e_chªge
 = 
Œue
;

2992 
	`dmsg
(
D_TLS_DEBUG_MED
, "STATE S_SENT_KEY");

2993 
ks
->
¡©e
 = 
S_SENT_KEY
;

2997 
buf
 = &
ks
->
¶aš‹xt_»ad_buf
;

2998 ià(
buf
->
Ën


2999 && ((
ks
->
¡©e
 =ğ
S_SENT_KEY
 && !
£ssiÚ
->
İt
->
£rv”
)

3000 || (
ks
->
¡©e
 =ğ
S_START
 && 
£ssiÚ
->
İt
->
£rv”
)))

3002 ià(
£ssiÚ
->
İt
->
key_m‘hod
 == 1)

3004 ià(!
	`key_m‘hod_1_»ad
(
buf
, 
£ssiÚ
))

3006 
”rÜ
;

3009 ià(
£ssiÚ
->
İt
->
key_m‘hod
 == 2)

3011 ià(!
	`key_m‘hod_2_»ad
(
buf
, 
muÉi
, 
£ssiÚ
))

3013 
”rÜ
;

3018 
	`ASSERT
(0);

3021 
¡©e_chªge
 = 
Œue
;

3022 
	`dmsg
(
D_TLS_DEBUG_MED
, "STATE S_GOT_KEY");

3023 
ks
->
¡©e
 = 
S_GOT_KEY
;

3027 
buf
 = &
ks
->
¶aš‹xt_wr™e_buf
;

3028 ià(
buf
->
Ën
)

3030 
¡©us
 = 
	`key_¡©e_wr™e_¶aš‹xt
(&
ks
->
ks_s¦
, 
buf
);

3031 ià(
¡©us
 == -1)

3033 
	`msg
(
D_TLS_ERRORS
,

3035 
”rÜ
;

3037 ià(
¡©us
 == 1)

3039 
¡©e_chªge
 = 
Œue
;

3040 
	`dmsg
(
D_TLS_DEBUG
, "Outgoing Plaintext -> TLS");

3045 ià(
ks
->
¡©e
 >ğ
S_START
)

3047 
buf
 = 
	`»lŸbË_g‘_buf_ouut_£qu’ûd
(
ks
->
£nd_»lŸbË
);

3048 ià(
buf
)

3050 
¡©us
 = 
	`key_¡©e_»ad_ch”‹xt
(&
ks
->
ks_s¦
, 
buf
, 
	`PAYLOAD_SIZE_DYNAMIC
(&
muÉi
->
İt
.
äame
));

3051 ià(
¡©us
 == -1)

3053 
	`msg
(
D_TLS_ERRORS
,

3055 
”rÜ
;

3057 ià(
¡©us
 == 1)

3059 
	`»lŸbË_m¬k_aùive_outgošg
(
ks
->
£nd_»lŸbË
, 
buf
, 
P_CONTROL_V1
);

3060 
INCR_GENERATED
;

3061 
¡©e_chªge
 = 
Œue
;

3062 
	`dmsg
(
D_TLS_DEBUG
, "Outgoing Ciphertext -> Reliable");

3067 
¡©e_chªge
);

3069 
	`upd©e_time
();

3072 ià(!
to_lšk
->
Ën
 && !
	`»lŸbË_ack_em±y
(
ks
->
»c_ack
))

3074 
bufãr
 
buf
 = 
ks
->
ack_wr™e_buf
;

3075 
	`ASSERT
(
	`buf_š™
(&
buf
, 
	`FRAME_HEADROOM
(&
muÉi
->
İt
.
äame
)));

3076 
	`wr™e_cÚŒŞ_auth
(
£ssiÚ
, 
ks
, &
buf
, 
to_lšk_addr
, 
P_ACK_V1
,

3077 
RELIABLE_ACK_SIZE
, 
çl£
);

3078 *
to_lšk
 = 
buf
;

3079 
aùive
 = 
Œue
;

3080 
	`dmsg
(
D_TLS_DEBUG
, "Dedicated ACK -> TCP/UDP");

3085 ià(
ks
->
¡©e
 >ğ
S_INITIAL
)

3087 
	`compu‹_—¾›¡_wakeup
(
wakeup
,

3088 
	`»lŸbË_£nd_timeout
(
ks
->
£nd_»lŸbË
));

3090 ià(
ks
->
mu¡_ÃgÙŸ‹
)

3092 
	`compu‹_—¾›¡_wakeup
(
wakeup
, 
ks
->
mu¡_ÃgÙŸ‹
 - 
now
);

3096 ià(
ks
->
e¡ablished
 && 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_£cÚds
)

3098 
	`compu‹_—¾›¡_wakeup
(
wakeup
,

3099 
ks
->
e¡ablished
 + 
£ssiÚ
->
İt
->
»ÃgÙŸ‹_£cÚds
 - 
now
);

3103 ià(*
wakeup
 <= 0)

3105 *
wakeup
 = 1;

3109 
aùive
 = 
Œue
;

3112 
	`dmsg
(
D_TLS_DEBUG
, "TLS:ls_´oûss:imeouˆ£ˆtØ%d", *
wakeup
);

3114 
	`gc_ä“
(&
gc
);

3115  
aùive
;

3118 
”rÜ
:

3119 
	`s_ş—r_”rÜ
();

3120 
ks
->
¡©e
 = 
S_ERROR
;

3121 
	`msg
(
D_TLS_ERRORS
, "TLS Error: TLS handshake failed");

3122 
INCR_ERROR
;

3123 
	`gc_ä“
(&
gc
);

3124  
çl£
;

3125 
	}
}

3135 
	$s_muÉi_´oûss
(
s_muÉi
 *
muÉi
,

3136 
bufãr
 *
to_lšk
,

3137 
lšk_sock‘_aùu®
 **
to_lšk_addr
,

3138 
lšk_sock‘_šfo
 *
to_lšk_sock‘_šfo
,

3139 
š‹rv®_t
 *
wakeup
)

3141 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3142 
i
;

3143 
aùive
 = 
TLSMP_INACTIVE
;

3144 
boŞ
 
”rÜ
 = 
çl£
;

3145 
s
;

3147 
	`³rf_push
(
PERF_TLS_MULTI_PROCESS
);

3149 
	`s_ş—r_”rÜ
();

3156 
i
 = 0; i < 
TM_SIZE
; ++i)

3158 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
i
];

3159 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

3160 
key_¡©e
 *
ks_Ïme
 = &
£ssiÚ
->
key
[
KS_LAME_DUCK
];

3163 ià(
i
 =ğ
TM_ACTIVE
 && 
ks
->
¡©e
 =ğ
S_INITIAL


3164 && 
	`lšk_sock‘_aùu®_defšed
(&
to_lšk_sock‘_šfo
->
l§
->
aùu®
))

3166 
ks
->
»mÙe_addr
 = 
to_lšk_sock‘_šfo
->
l§
->
aùu®
;

3169 
	`dmsg
(
D_TLS_DEBUG
,

3171 
i
,

3172 
	`¡©e_Çme
(
ks
->
¡©e
),

3173 
	`£ssiÚ_id_´št
(&
£ssiÚ
->
£ssiÚ_id
, &
gc
),

3174 
	`£ssiÚ_id_´št
(&
ks
->
£ssiÚ_id_»mÙe
, &
gc
),

3175 
	`´št_lšk_sock‘_aùu®
(&
ks
->
»mÙe_addr
, &
gc
));

3177 ià(
ks
->
¡©e
 >ğ
S_INITIAL
 && 
	`lšk_sock‘_aùu®_defšed
(&ks->
»mÙe_addr
))

3179 
lšk_sock‘_aùu®
 *
a
 = 
NULL
;

3181 
	`upd©e_time
();

3183 ià(
	`s_´oûss
(
muÉi
, 
£ssiÚ
, 
to_lšk
, &
a
,

3184 
to_lšk_sock‘_šfo
, 
wakeup
))

3186 
aùive
 = 
TLSMP_ACTIVE
;

3194 ià(
a
)

3196 
muÉi
->
to_lšk_addr
 = *
a
;

3197 *
to_lšk_addr
 = &
muÉi
->to_link_addr;

3206 ià(
ks
->
¡©e
 =ğ
S_ERROR
)

3208 ++
muÉi
->
n_soá_”rÜs
;

3210 ià(
i
 =ğ
TM_ACTIVE
)

3212 
”rÜ
 = 
Œue
;

3215 ià(
i
 =ğ
TM_ACTIVE


3216 && 
ks_Ïme
->
¡©e
 >ğ
S_ACTIVE


3217 && !
muÉi
->
İt
.
sšgË_£ssiÚ
)

3219 
	`move_£ssiÚ
(
muÉi
, 
TM_LAME_DUCK
, 
TM_ACTIVE
, 
Œue
);

3223 
	`»£t_£ssiÚ
(
muÉi
, 
£ssiÚ
);

3229 
	`upd©e_time
();

3231 
s
 = 
	`s_auth’tiÿtiÚ_¡©us
(
muÉi
, 
TLS_MULTI_AUTH_STATUS_INTERVAL
);

3236 ià(
	`Ïme_duck_mu¡_d›
(&
muÉi
->
£ssiÚ
[
TM_LAME_DUCK
], 
wakeup
))

3238 
	`s_£ssiÚ_ä“
(&
muÉi
->
£ssiÚ
[
TM_LAME_DUCK
], 
Œue
);

3239 
	`msg
(
D_TLS_DEBUG_LOW
, "TLS:ls_multi_process: killedƒxpiring key");

3251 ià(
	`DECRYPT_KEY_ENABLED
(
muÉi
, &muÉi->
£ssiÚ
[
TM_UNTRUSTED
].
key
[
KS_PRIMARY
]))

3253 
	`move_£ssiÚ
(
muÉi
, 
TM_ACTIVE
, 
TM_UNTRUSTED
, 
Œue
);

3254 
	`msg
(
D_TLS_DEBUG_LOW
, "TLS:ls_multi_process: untrusted session…romotedo %strusted",

3255 
s
 =ğ
TLS_AUTHENTICATION_SUCCEEDED
 ? "" : "semi-");

3262 ià(
”rÜ
)

3264 
i
 = 0; i < (è
	`SIZE
(
muÉi
->
key_sÿn
); ++i)

3266 ià(
muÉi
->
key_sÿn
[
i
]->
¡©e
 >ğ
S_ACTIVE
)

3268 
noh¬d
;

3271 ++
muÉi
->
n_h¬d_”rÜs
;

3273 
noh¬d
:

3275 #ifdeà
ENABLE_DEBUG


3278 cÚ¡ 
throw_Ëv–
 = 
	`GREMLIN_CONNECTION_FLOOD_LEVEL
(
muÉi
->
İt
.
g»mlš
);

3279 ià(
throw_Ëv–
)

3281 
i
 = 0; i < (è
	`SIZE
(
muÉi
->
key_sÿn
); ++i)

3283 ià(
muÉi
->
key_sÿn
[
i
]->
¡©e
 >ğ
throw_Ëv–
)

3285 ++
muÉi
->
n_h¬d_”rÜs
;

3286 ++
muÉi
->
n_soá_”rÜs
;

3293 
	`³rf_pİ
();

3294 
	`gc_ä“
(&
gc
);

3296  (
s
 =ğ
TLS_AUTHENTICATION_FAILED
è? 
TLSMP_KILL
 : 
aùive
;

3297 
	}
}

3329 
boŞ


3330 
	$s_´e_deüy±
(
s_muÉi
 *
muÉi
,

3331 cÚ¡ 
lšk_sock‘_aùu®
 *
äom
,

3332 
bufãr
 *
buf
,

3333 
üy±o_İtiÚs
 **
İt
,

3334 
boŞ
 
æß‹d
,

3335 cÚ¡ 
ušt8_t
 **
ad_¡¬t
)

3337 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3338 
boŞ
 
»t
 = 
çl£
;

3340 ià(
buf
->
Ën
 > 0)

3342 
i
;

3343 
İ
;

3344 
key_id
;

3348 
ušt8_t
 
c
 = *
	`BPTR
(
buf
);

3349 
İ
 = 
c
 >> 
P_OPCODE_SHIFT
;

3350 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

3353 ià((
İ
 =ğ
P_DATA_V1
è|| (İ =ğ
P_DATA_V2
))

3356 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

3358 
key_¡©e
 *
ks
 = 
muÉi
->
key_sÿn
[
i
];

3373 ià(
	`DECRYPT_KEY_ENABLED
(
muÉi
, 
ks
)

3374 && 
key_id
 =ğ
ks
->key_id

3375 && 
ks
->
auth’tiÿ‹d


3376 #ifdeà
ENABLE_DEF_AUTH


3377 && !
ks
->
auth_deã¼ed


3379 && (
æß‹d
 || 
	`lšk_sock‘_aùu®_m©ch
(
äom
, &
ks
->
»mÙe_addr
)))

3381 ià(!
ks
->
üy±o_İtiÚs
.
key_ùx_bi
.
š™Ÿlized
)

3383 
	`msg
(
D_MULTI_DROPPED
,

3385 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
), 
key_id
);

3386 
”rÜ_l™e
;

3390 *
İt
 = &
ks
->
üy±o_İtiÚs
;

3391 ià(
İ
 =ğ
P_DATA_V2
)

3393 *
ad_¡¬t
 = 
	`BPTR
(
buf
);

3395 
	`ASSERT
(
	`buf_advªû
(
buf
, 1));

3396 ià(
İ
 =ğ
P_DATA_V1
)

3398 *
ad_¡¬t
 = 
	`BPTR
(
buf
);

3400 ià(
İ
 =ğ
P_DATA_V2
)

3402 ià(
buf
->
Ën
 < 4)

3404 
	`msg
(
D_TLS_ERRORS
, "Protocolƒrror:„eceived P_DATA_V2 from %s but†ength is < 4",

3405 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3406 
”rÜ
;

3408 
	`ASSERT
(
	`buf_advªû
(
buf
, 3));

3411 ++
ks
->
n_·ck‘s
;

3412 
ks
->
n_by‹s
 +ğ
buf
->
Ën
;

3413 
	`dmsg
(
D_TLS_KEYSELECT
,

3415 
key_id
, 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3416 
	`gc_ä“
(&
gc
);

3417  
»t
;

3421 
	`msg
(
D_TLS_ERRORS
,

3423 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
), 
key_id
);

3424 
”rÜ_l™e
;

3428 
boŞ
 
do_bur¡
 = 
çl£
;

3429 
boŞ
 
Ãw_lšk
 = 
çl£
;

3430 
£ssiÚ_id
 
sid
;

3433 ià(
İ
 < 
P_FIRST_OPCODE
 || o°> 
P_LAST_OPCODE
)

3435 
	`msg
(
D_TLS_ERRORS
,

3437 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
), 
İ
);

3438 
”rÜ
;

3442 ià(
	`is_h¬d_»£t
(
İ
, 0))

3445 ià(((
İ
 =ğ
P_CONTROL_HARD_RESET_CLIENT_V1


3446 || 
İ
 =ğ
P_CONTROL_HARD_RESET_CLIENT_V2
è&& !
muÉi
->
İt
.
£rv”
)

3447 || ((
İ
 =ğ
P_CONTROL_HARD_RESET_SERVER_V1


3448 || 
İ
 =ğ
P_CONTROL_HARD_RESET_SERVER_V2
è&& 
muÉi
->
İt
.
£rv”
))

3450 
	`msg
(
D_TLS_ERRORS
,

3452 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3453 
”rÜ
;

3460 
	`dmsg
(
D_TLS_DEBUG
, "TLS: control channel, op=%s, IP=%s",

3461 
	`·ck‘_İcode_Çme
(
İ
), 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3465 
bufãr
 
tmp
 = *
buf
;

3466 
	`buf_advªû
(&
tmp
, 1);

3467 ià(!
	`£ssiÚ_id_»ad
(&
sid
, &
tmp
è|| !
	`£ssiÚ_id_defšed
(&sid))

3469 
	`msg
(
D_TLS_ERRORS
,

3471 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3472 
”rÜ
;

3477 
i
 = 0; i < 
TM_SIZE
; ++i)

3479 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
i
];

3480 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

3482 
	`dmsg
(
D_TLS_DEBUG
,

3484 
i
,

3485 
	`¡©e_Çme
(
ks
->
¡©e
),

3486 
	`£ssiÚ_id_´št
(&
£ssiÚ
->
£ssiÚ_id
, &
gc
),

3487 
	`£ssiÚ_id_´št
(&
sid
, &
gc
),

3488 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
),

3489 
	`£ssiÚ_id_´št
(&
ks
->
£ssiÚ_id_»mÙe
, &
gc
),

3490 
	`´št_lšk_sock‘_aùu®
(&
ks
->
»mÙe_addr
, &
gc
));

3492 ià(
	`£ssiÚ_id_equ®
(&
ks
->
£ssiÚ_id_»mÙe
, &
sid
))

3495 ià(
i
 =ğ
TM_LAME_DUCK
)

3497 
	`msg
(
D_TLS_ERRORS
,

3499 
	`£ssiÚ_id_´št
(&
sid
, &
gc
));

3500 
”rÜ
;

3502 
	`dmsg
(
D_TLS_DEBUG
,

3504 
i
, 
	`£ssiÚ_id_´št
(&
sid
, &
gc
));

3513 ià(
i
 =ğ
TM_SIZE
 && 
	`is_h¬d_»£t
(
İ
, 0))

3515 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
TM_ACTIVE
];

3516 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

3518 ià(!
	`is_h¬d_»£t
(
İ
, 
muÉi
->
İt
.
key_m‘hod
))

3520 
	`msg
(
D_TLS_ERRORS
, "TLS ERROR: initial…acket†ocal/remote key_method mismatch,†ocal key_method=%d, op=%s",

3521 
muÉi
->
İt
.
key_m‘hod
,

3522 
	`·ck‘_İcode_Çme
(
İ
));

3523 
”rÜ
;

3530 ià(!
	`£ssiÚ_id_defšed
(&
ks
->
£ssiÚ_id_»mÙe
))

3532 ià(
muÉi
->
İt
.
sšgË_£ssiÚ
 && muÉi->
n_£ssiÚs
)

3534 
	`msg
(
D_TLS_ERRORS
,

3536 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3537 
”rÜ
;

3540 #ifdeà
ENABLE_MANAGEMENT


3541 ià(
mªagem’t
)

3543 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

3544 
OPENVPN_STATE_AUTH
,

3545 
NULL
,

3546 
NULL
,

3547 
NULL
,

3548 
NULL
,

3549 
NULL
);

3553 
	`msg
(
D_TLS_DEBUG_LOW
,

3555 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
),

3556 
	`£ssiÚ_id_´št
(&
sid
, &
gc
));

3558 
do_bur¡
 = 
Œue
;

3559 
Ãw_lšk
 = 
Œue
;

3560 
i
 = 
TM_ACTIVE
;

3561 
£ssiÚ
->
uÁru¡ed_addr
 = *
äom
;

3565 ià(
i
 =ğ
TM_SIZE
 && 
	`is_h¬d_»£t
(
İ
, 0))

3571 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
TM_UNTRUSTED
];

3577 ià(
muÉi
->
İt
.
sšgË_£ssiÚ
)

3579 
	`msg
(
D_TLS_ERRORS
,

3581 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3582 
”rÜ
;

3585 ià(!
	`is_h¬d_»£t
(
İ
, 
muÉi
->
İt
.
key_m‘hod
))

3587 
	`msg
(
D_TLS_ERRORS
, "TLS ERROR:‚ew session†ocal/remote key_method mismatch,†ocal key_method=%d, op=%s",

3588 
muÉi
->
İt
.
key_m‘hod
,

3589 
	`·ck‘_İcode_Çme
(
İ
));

3590 
”rÜ
;

3593 ià(!
	`»ad_cÚŒŞ_auth
(
buf
, &
£ssiÚ
->
s_w¿p
, 
äom
))

3595 
”rÜ
;

3604 
	`msg
(
D_TLS_DEBUG_LOW
,

3606 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3608 
Ãw_lšk
 = 
Œue
;

3609 
i
 = 
TM_UNTRUSTED
;

3610 
£ssiÚ
->
uÁru¡ed_addr
 = *
äom
;

3614 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
i
];

3615 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

3620 ià(
i
 !ğ
TM_ACTIVE
 && i !ğ
TM_UNTRUSTED
)

3622 
	`msg
(
D_TLS_ERRORS
,

3624 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
),

3625 
i
,

3626 
	`·ck‘_İcode_Çme
(
İ
));

3627 
”rÜ
;

3633 ià(!
Ãw_lšk
 && !
	`lšk_sock‘_aùu®_m©ch
(&
ks
->
»mÙe_addr
, 
äom
))

3635 
	`msg
(
D_TLS_ERRORS
, "TLS Error: Received control…acket from unexpected IP‡ddr: %s",

3636 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3637 
”rÜ
;

3643 ià(
İ
 =ğ
P_CONTROL_SOFT_RESET_V1


3644 && 
	`DECRYPT_KEY_ENABLED
(
muÉi
, 
ks
))

3646 ià(!
	`»ad_cÚŒŞ_auth
(
buf
, &
£ssiÚ
->
s_w¿p
, 
äom
))

3648 
”rÜ
;

3651 
	`key_¡©e_soá_»£t
(
£ssiÚ
);

3653 
	`dmsg
(
D_TLS_DEBUG
,

3655 
i
, 
	`£ssiÚ_id_´št
(&
sid
, &
gc
));

3662 ià(
İ
 =ğ
P_CONTROL_SOFT_RESET_V1
)

3664 
do_bur¡
 = 
Œue
;

3667 ià(!
	`»ad_cÚŒŞ_auth
(
buf
, &
£ssiÚ
->
s_w¿p
, 
äom
))

3669 
”rÜ
;

3672 
	`dmsg
(
D_TLS_DEBUG
,

3674 
i
, 
	`£ssiÚ_id_´št
(&
sid
, &
gc
));

3684 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
i
];

3685 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

3688 
	`ASSERT
(
ks
->
¡©e
 !ğ
S_UNDEF
);

3689 
	`ASSERT
(
ks
->
¡©e
 !ğ
S_ERROR
);

3690 
	`ASSERT
(
	`£ssiÚ_id_defšed
(&
£ssiÚ
->
£ssiÚ_id
));

3693 
»t
 = 
Œue
;

3698 ià(
Ãw_lšk
)

3700 
ks
->
£ssiÚ_id_»mÙe
 = 
sid
;

3701 
ks
->
»mÙe_addr
 = *
äom
;

3702 ++
muÉi
->
n_£ssiÚs
;

3704 ià(!
	`lšk_sock‘_aùu®_m©ch
(&
ks
->
»mÙe_addr
, 
äom
))

3706 
	`msg
(
D_TLS_ERRORS
,

3708 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3709 
”rÜ
;

3717 ià(
do_bur¡
 && !
£ssiÚ
->
bur¡
)

3719 
	`»lŸbË_scheduË_now
(
ks
->
£nd_»lŸbË
);

3720 
£ssiÚ
->
bur¡
 = 
Œue
;

3724 ià(
ks
->
key_id
 != key_id)

3726 
	`msg
(
D_TLS_ERRORS
,

3728 
ks
->
key_id
, key_id, 
	`´št_key_id
(
muÉi
, &
gc
));

3729 
”rÜ
;

3738 
»lŸbË_ack
 
£nd_ack
;

3740 
£nd_ack
.
Ën
 = 0;

3741 ià(!
	`»lŸbË_ack_»ad
(&
£nd_ack
, 
buf
, &
£ssiÚ
->
£ssiÚ_id
))

3743 
	`msg
(
D_TLS_ERRORS
,

3745 
”rÜ
;

3747 
	`»lŸbË_£nd_purge
(
ks
->
£nd_»lŸbË
, &
£nd_ack
);

3750 ià(
İ
 !ğ
P_ACK_V1
 && 
	`»lŸbË_ÿn_g‘
(
ks
->
»c_»lŸbË
))

3752 
·ck‘_id_ty³
 
id
;

3755 ià(
	`»lŸbË_ack_»ad_·ck‘_id
(
buf
, &
id
))

3758 ià(
	`»lŸbË_wÚt_b»ak_£qu’tŸl™y
(
ks
->
»c_»lŸbË
, 
id
))

3760 ià(
	`»lŸbË_nÙ_»¶ay
(
ks
->
»c_»lŸbË
, 
id
))

3763 
bufãr
 *
š
 = 
	`»lŸbË_g‘_buf
(
ks
->
»c_»lŸbË
);

3764 
	`ASSERT
(
š
);

3765 if(!
	`buf_cİy
(
š
, 
buf
))

3767 
	`msg
(
D_MULTI_DROPPED
,

3769 
”rÜ
;

3771 
	`»lŸbË_m¬k_aùive_šcomšg
(
ks
->
»c_»lŸbË
, 
š
, 
id
, 
İ
);

3775 
	`»lŸbË_ack_acknowËdge_·ck‘_id
(
ks
->
»c_ack
, 
id
);

3783 
dÚe
:

3784 
buf
->
Ën
 = 0;

3785 *
İt
 = 
NULL
;

3786 
	`gc_ä“
(&
gc
);

3787  
»t
;

3789 
”rÜ
:

3790 ++
muÉi
->
n_soá_”rÜs
;

3791 
”rÜ_l™e
:

3792 
	`s_ş—r_”rÜ
();

3793 
dÚe
;

3794 
	}
}

3807 
boŞ


3808 
	$s_´e_deüy±_l™e
(cÚ¡ 
s_auth_¡ªd®Úe
 *
s
,

3809 cÚ¡ 
lšk_sock‘_aùu®
 *
äom
,

3810 cÚ¡ 
bufãr
 *
buf
)

3813 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3814 
boŞ
 
»t
 = 
çl£
;

3816 ià(
buf
->
Ën
 > 0)

3818 
İ
;

3819 
key_id
;

3823 
ušt8_t
 
c
 = *
	`BPTR
(
buf
);

3824 
İ
 = 
c
 >> 
P_OPCODE_SHIFT
;

3825 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

3831 ià(
İ
 !ğ
P_CONTROL_HARD_RESET_CLIENT_V2
)

3836 
	`dmsg
(
D_TLS_STATE_ERRORS
,

3838 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
),

3839 
İ
);

3840 
”rÜ
;

3843 ià(
key_id
 != 0)

3845 
	`dmsg
(
D_TLS_STATE_ERRORS
,

3847 
key_id
,

3848 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
));

3849 
”rÜ
;

3852 ià(
buf
->
Ën
 > 
	`EXPANDED_SIZE_DYNAMIC
(&
s
->
äame
))

3854 
	`dmsg
(
D_TLS_STATE_ERRORS
,

3856 
buf
->
Ën
,

3857 
	`´št_lšk_sock‘_aùu®
(
äom
, &
gc
),

3858 
	`EXPANDED_SIZE_DYNAMIC
(&
s
->
äame
));

3859 
”rÜ
;

3863 
bufãr
 
Ãwbuf
 = 
	`şÚe_buf
(
buf
);

3864 
s_w¿p_ùx
 
s_w¿p_tmp
 = 
s
->
s_w¿p
;

3865 
boŞ
 
¡©us
;

3868 
¡©us
 = 
	`»ad_cÚŒŞ_auth
(&
Ãwbuf
, &
s_w¿p_tmp
, 
äom
);

3869 
	`ä“_buf
(&
Ãwbuf
);

3870 ià(!
¡©us
)

3872 
”rÜ
;

3891 
»t
 = 
Œue
;

3894 
	`gc_ä“
(&
gc
);

3895  
»t
;

3897 
”rÜ
:

3898 
	`s_ş—r_”rÜ
();

3899 
	`gc_ä“
(&
gc
);

3900  
»t
;

3901 
	}
}

3905 
	$s_´e_’üy±
(
s_muÉi
 *
muÉi
,

3906 
bufãr
 *
buf
, 
üy±o_İtiÚs
 **
İt
)

3908 
muÉi
->
§ve_ks
 = 
NULL
;

3909 ià(
buf
->
Ën
 > 0)

3911 
i
;

3912 
key_¡©e
 *
ks_£Ëù
 = 
NULL
;

3913 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

3915 
key_¡©e
 *
ks
 = 
muÉi
->
key_sÿn
[
i
];

3916 ià(
ks
->
¡©e
 >ğ
S_ACTIVE


3917 && 
ks
->
auth’tiÿ‹d


3918 && 
ks
->
üy±o_İtiÚs
.
key_ùx_bi
.
š™Ÿlized


3919 #ifdeà
ENABLE_DEF_AUTH


3920 && !
ks
->
auth_deã¼ed


3924 ià(!
ks_£Ëù
)

3926 
ks_£Ëù
 = 
ks
;

3928 ià(
now
 >ğ
ks
->
auth_deã¼ed_expœe
)

3930 
ks_£Ëù
 = 
ks
;

3936 ià(
ks_£Ëù
)

3938 *
İt
 = &
ks_£Ëù
->
üy±o_İtiÚs
;

3939 
muÉi
->
§ve_ks
 = 
ks_£Ëù
;

3940 
	`dmsg
(
D_TLS_KEYSELECT
, "TLS:ls_´e_’üy±: key_id=%d", 
ks_£Ëù
->
key_id
);

3945 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3946 
	`dmsg
(
D_TLS_KEYSELECT
, "TLS Warning:‚o data channel send key‡vailable: %s",

3947 
	`´št_key_id
(
muÉi
, &
gc
));

3948 
	`gc_ä“
(&
gc
);

3952 
buf
->
Ën
 = 0;

3953 *
İt
 = 
NULL
;

3954 
	}
}

3957 
	$s_´•’d_İcode_v1
(cÚ¡ 
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
)

3959 
key_¡©e
 *
ks
 = 
muÉi
->
§ve_ks
;

3960 
ušt8_t
 
İ
;

3962 
	`msg
(
D_TLS_DEBUG
, 
__func__
);

3964 
	`ASSERT
(
ks
);

3966 
İ
 = (
P_DATA_V1
 << 
P_OPCODE_SHIFT
è| 
ks
->
key_id
;

3967 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
İ
, 1));

3968 
	}
}

3971 
	$s_´•’d_İcode_v2
(cÚ¡ 
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
)

3973 
key_¡©e
 *
ks
 = 
muÉi
->
§ve_ks
;

3974 
ušt32_t
 
³”
;

3976 
	`msg
(
D_TLS_DEBUG
, 
__func__
);

3978 
	`ASSERT
(
ks
);

3980 
³”
 = 
	`htÚl
(((
P_DATA_V2
 << 
P_OPCODE_SHIFT
è| 
ks
->
key_id
) << 24

3981 | (
muÉi
->
³”_id
 & 0xFFFFFF));

3982 
	`ASSERT
(
	`buf_wr™e_´•’d
(
buf
, &
³”
, 4));

3983 
	}
}

3986 
	$s_po¡_’üy±
(
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
)

3988 
key_¡©e
 *
ks
 = 
muÉi
->
§ve_ks
;

3989 
muÉi
->
§ve_ks
 = 
NULL
;

3991 ià(
buf
->
Ën
 > 0)

3993 
	`ASSERT
(
ks
);

3995 ++
ks
->
n_·ck‘s
;

3996 
ks
->
n_by‹s
 +ğ
buf
->
Ën
;

3998 
	}
}

4005 
boŞ


4006 
	$s_£nd_·ylßd
(
s_muÉi
 *
muÉi
,

4007 cÚ¡ 
ušt8_t
 *
d©a
,

4008 
size
)

4010 
s_£ssiÚ
 *
£ssiÚ
;

4011 
key_¡©e
 *
ks
;

4012 
boŞ
 
»t
 = 
çl£
;

4014 
	`s_ş—r_”rÜ
();

4016 
	`ASSERT
(
muÉi
);

4018 
£ssiÚ
 = &
muÉi
->£ssiÚ[
TM_ACTIVE
];

4019 
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

4021 ià(
ks
->
¡©e
 >ğ
S_ACTIVE
)

4023 ià(
	`key_¡©e_wr™e_¶aš‹xt_cÚ¡
(&
ks
->
ks_s¦
, 
d©a
, 
size
) == 1)

4025 
»t
 = 
Œue
;

4030 ià(!
ks
->
·ybuf
)

4032 
ks
->
·ybuf
 = 
	`bufãr_li¡_Ãw
(0);

4034 
	`bufãr_li¡_push_d©a
(
ks
->
·ybuf
, 
d©a
, (
size_t
)
size
);

4035 
»t
 = 
Œue
;

4039 
	`s_ş—r_”rÜ
();

4041  
»t
;

4042 
	}
}

4044 
boŞ


4045 
	$s_»c_·ylßd
(
s_muÉi
 *
muÉi
,

4046 
bufãr
 *
buf
)

4048 
s_£ssiÚ
 *
£ssiÚ
;

4049 
key_¡©e
 *
ks
;

4050 
boŞ
 
»t
 = 
çl£
;

4052 
	`s_ş—r_”rÜ
();

4054 
	`ASSERT
(
muÉi
);

4056 
£ssiÚ
 = &
muÉi
->£ssiÚ[
TM_ACTIVE
];

4057 
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

4059 ià(
ks
->
¡©e
 >ğ
S_ACTIVE
 && 
	`BLEN
(&ks->
¶aš‹xt_»ad_buf
))

4061 ià(
	`buf_cİy
(
buf
, &
ks
->
¶aš‹xt_»ad_buf
))

4063 
»t
 = 
Œue
;

4065 
ks
->
¶aš‹xt_»ad_buf
.
Ën
 = 0;

4068 
	`s_ş—r_”rÜ
();

4070  
»t
;

4071 
	}
}

4074 
	$s_upd©e_»mÙe_addr
(
s_muÉi
 *
muÉi
, cÚ¡ 
lšk_sock‘_aùu®
 *
addr
)

4076 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4077 
i
, 
j
;

4079 
i
 = 0; i < 
TM_SIZE
; ++i)

4081 
s_£ssiÚ
 *
£ssiÚ
 = &
muÉi
->£ssiÚ[
i
];

4083 
j
 = 0; j < 
KS_SIZE
; ++j)

4085 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
j
];

4087 ià(!
	`lšk_sock‘_aùu®_defšed
(&
ks
->
»mÙe_addr
)

4088 || 
	`lšk_sock‘_aùu®_m©ch
(
addr
, &
ks
->
»mÙe_addr
))

4093 
	`dmsg
(
D_TLS_KEYSELECT
, "TLS:ls_update_remote_addr from IP=%so IP=%s",

4094 
	`´št_lšk_sock‘_aùu®
(&
ks
->
»mÙe_addr
, &
gc
),

4095 
	`´št_lšk_sock‘_aùu®
(
addr
, &
gc
));

4097 
ks
->
»mÙe_addr
 = *
addr
;

4100 
	`gc_ä“
(&
gc
);

4101 
	}
}

4104 
	$s_³”_šfo_nı_v”
(cÚ¡ *
³”_šfo
)

4106 cÚ¡ *
nı¡r
 = 
³”_šfo
 ? 
	`¡r¡r
Õ“r_šfo, "IV_NCP="è: 
NULL
;

4107 ià(
nı¡r
)

4109 
nı
 = 0;

4110 
r
 = 
	`ssÿnf
(
nı¡r
, "IV_NCP=%d", &
nı
);

4111 ià(
r
 == 1)

4113  
nı
;

4117 
	}
}

4119 
boŞ


4120 
	$s_check_nı_ch”_li¡
(cÚ¡ *
li¡
)

4122 
boŞ
 
unsuµÜ‹d_ch”_found
 = 
çl£
;

4124 
	`ASSERT
(
li¡
);

4126 *cÚ¡ 
tmp_ch”s
 = 
	`¡ršg_®loc
(
li¡
, 
NULL
);

4127 cÚ¡ *
tok’
 = 
	`¡¹ok
(
tmp_ch”s
, ":");

4128 
tok’
)

4130 ià(!
	`ch”_kt_g‘
(
	`Œª¦©e_ch”_Çme_äom_İ’v²
(
tok’
)))

4132 
	`msg
(
M_WARN
, "UnsuµÜ‹d ch” iÀ--nı-ch”s: %s", 
tok’
);

4133 
unsuµÜ‹d_ch”_found
 = 
Œue
;

4135 
tok’
 = 
	`¡¹ok
(
NULL
, ":");

4137 
	`ä“
(
tmp_ch”s
);

4139  0 < 
	`¡¾’
(
li¡
è&& !
unsuµÜ‹d_ch”_found
;

4140 
	}
}

4143 
	$show_avaabË_s_ch”s
(cÚ¡ *
ch”_li¡
,

4144 cÚ¡ *
ch”_li¡_s13
,

4145 cÚ¡ *
s_û¹_´ofe
)

4147 
	`´štf
("Available TLS Ciphers,†isted in order of…reference:\n");

4149 #ià(
ENABLE_CRYPTO_OPENSSL
 && 
OPENSSL_VERSION_NUMBER
 >= 0x1010100fL)

4150 
	`´štf
("\nFor TLS 1.3‡nd‚ewer (--tls-ciphersuites):\n\n");

4151 
	`show_avaabË_s_ch”s_li¡
(
ch”_li¡_s13
, 
s_û¹_´ofe
, 
Œue
);

4153 (è
ch”_li¡_s13
;

4156 
	`´štf
("\nFor TLS 1.2‡nd older (--tls-cipher):\n\n");

4157 
	`show_avaabË_s_ch”s_li¡
(
ch”_li¡
, 
s_û¹_´ofe
, 
çl£
);

4159 
	`´štf
("\n"

4164 
	}
}

4171 
	$´ÙocŞ_dump
(
bufãr
 *bufãr, 
æags
, 
gc_¬’a
 *
gc
)

4173 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

4174 
bufãr
 
buf
 = *buffer;

4176 
ušt8_t
 
c
;

4177 
İ
;

4178 
key_id
;

4180 
s_auth_hmac_size
 = (
æags
 & 
PD_TLS_AUTH_HMAC_SIZE_MASK
);

4182 ià(
buf
.
Ën
 <= 0)

4184 
	`buf_´štf
(&
out
, "DATA UNDEF†’=%d", 
buf
.
Ën
);

4185 
dÚe
;

4188 ià(!(
æags
 & 
PD_TLS
))

4190 
´št_d©a
;

4196 ià(!
	`buf_»ad
(&
buf
, &
c
, (c)))

4198 
dÚe
;

4200 
İ
 = (
c
 >> 
P_OPCODE_SHIFT
);

4201 
key_id
 = 
c
 & 
P_KEY_ID_MASK
;

4202 
	`buf_´štf
(&
out
, "% kid=%d", 
	`·ck‘_İcode_Çme
(
İ
), 
key_id
);

4204 ià((
İ
 =ğ
P_DATA_V1
è|| (İ =ğ
P_DATA_V2
))

4206 
´št_d©a
;

4213 
£ssiÚ_id
 
sid
;

4215 ià(!
	`£ssiÚ_id_»ad
(&
sid
, &
buf
))

4217 
dÚe
;

4219 ià(
æags
 & 
PD_VERBOSE
)

4221 
	`buf_´štf
(&
out
, " sid=%s", 
	`£ssiÚ_id_´št
(&
sid
, 
gc
));

4228 ià(
s_auth_hmac_size
)

4230 
·ck‘_id_Ãt
 
pš
;

4231 
ušt8_t
 
s_auth_hmac
[
MAX_HMAC_KEY_LENGTH
];

4233 
	`ASSERT
(
s_auth_hmac_size
 <ğ
MAX_HMAC_KEY_LENGTH
);

4235 ià(!
	`buf_»ad
(&
buf
, 
s_auth_hmac
, 
s_auth_hmac_size
))

4237 
dÚe
;

4239 ià(
æags
 & 
PD_VERBOSE
)

4241 
	`buf_´štf
(&
out
, "ls_hmac=%s", 
	`fÜm©_hex
(
s_auth_hmac
, 
s_auth_hmac_size
, 0, 
gc
));

4244 ià(!
	`·ck‘_id_»ad
(&
pš
, &
buf
, 
Œue
))

4246 
dÚe
;

4248 
	`buf_´štf
(&
out
, "…id=%s", 
	`·ck‘_id_Ãt_´št
(&
pš
, (
æags
 & 
PD_VERBOSE
), 
gc
));

4254 
	`buf_´štf
(&
out
, " %s", 
	`»lŸbË_ack_´št
(&
buf
, (
æags
 & 
PD_VERBOSE
), 
gc
));

4256 ià(
İ
 =ğ
P_ACK_V1
)

4258 
dÚe
;

4265 
·ck‘_id_ty³
 
l
;

4266 ià(!
	`buf_»ad
(&
buf
, &
l
, (l)))

4268 
dÚe
;

4270 
l
 = 
	`Áohpid
(l);

4271 
	`buf_´štf
(&
out
, "…id=" 
·ck‘_id_fÜm©
, (
·ck‘_id_´št_ty³
)
l
);

4274 
´št_d©a
:

4275 ià(
æags
 & 
PD_SHOW_DATA
)

4277 
	`buf_´štf
(&
out
, " DATA %s", 
	`fÜm©_hex
(
	`BPTR
(&
buf
), 
	`BLEN
(&buf), 80, 
gc
));

4281 
	`buf_´štf
(&
out
, " DATA†’=%d", 
buf
.
Ën
);

4284 
dÚe
:

4285  
	`BSTR
(&
out
);

4286 
	}
}

4289 
	$d–ayed_auth_·ss_purge
()

4291 
auth_u£r_·ss
.
wa™_fÜ_push
 = 
çl£
;

4292 
	`purge_u£r_·ss
(&
auth_u£r_·ss
, 
çl£
);

4293 
	}
}

4297 
	$dummy
()

4299 
	}
}

	@ssl.h

29 #iâdeà
OPENVPN_SSL_H


30 
	#OPENVPN_SSL_H


	)

32 #ià
defšed
(
ENABLE_CRYPTO
)

34 
	~"basic.h
"

35 
	~"commÚ.h
"

36 
	~"üy±o.h
"

37 
	~"·ck‘_id.h
"

38 
	~"£ssiÚ_id.h
"

39 
	~"»lŸbË.h
"

40 
	~"sock‘.h
"

41 
	~"mtu.h
"

42 
	~"İtiÚs.h
"

43 
	~"¶ugš.h
"

45 
	~"s¦_commÚ.h
"

46 
	~"s¦_back’d.h
"

49 
	#KEY_EXPANSION_ID
 "O³nVPN"

	)

52 
	#P_KEY_ID_MASK
 0x07

	)

53 
	#P_OPCODE_SHIFT
 3

	)

56 
	#P_CONTROL_HARD_RESET_CLIENT_V1
 1

	)

57 
	#P_CONTROL_HARD_RESET_SERVER_V1
 2

	)

58 
	#P_CONTROL_SOFT_RESET_V1
 3

	)

59 
	#P_CONTROL_V1
 4

	)

60 
	#P_ACK_V1
 5

	)

61 
	#P_DATA_V1
 6

	)

62 
	#P_DATA_V2
 9

	)

65 
	#P_CONTROL_HARD_RESET_CLIENT_V2
 7

	)

66 
	#P_CONTROL_HARD_RESET_SERVER_V2
 8

	)

69 
	#P_FIRST_OPCODE
 1

	)

70 
	#P_LAST_OPCODE
 9

	)

76 
	#CONTROL_SEND_ACK_MAX
 4

	)

81 
	#TLS_RELIABLE_N_SEND_BUFFERS
 4

	)

82 
	#TLS_RELIABLE_N_REC_BUFFERS
 8

	)

87 
	#TLS_MULTI_REFRESH
 15

	)

88 
	#TLS_MULTI_HORIZON
 2

	)

96 
	#TLS_MULTI_THREAD_SEND_TIMEOUT
 5

	)

99 
	#TLS_MULTI_AUTH_STATUS_INTERVAL
 10

	)

106 
	#TLS_OPTIONS_LEN
 512

	)

109 
	#X509_USERNAME_FIELD_DEFAULT
 "CN"

	)

114 
	#KEY_METHOD_MIN
 1

	)

115 
	#KEY_METHOD_MAX
 2

	)

118 
	#KEY_METHOD_MASK
 0x0F

	)

129 
	ss_auth_¡ªd®Úe


131 
s_w¿p_ùx
 
	ms_w¿p
;

132 
äame
 
	mäame
;

138 
š™_s¦_lib
();

143 
ä“_s¦_lib
();

149 
š™_s¦
(cÚ¡ 
İtiÚs
 *İtiÚs, 
s_roÙ_ùx
 *
ùx
);

171 
s_muÉi
 *
s_muÉi_š™
(
s_İtiÚs
 *tls_options);

187 
s_muÉi_š™_fš®ize
(
s_muÉi
 *
muÉi
,

188 cÚ¡ 
äame
 *frame);

193 
s_auth_¡ªd®Úe
 *
s_auth_¡ªd®Úe_š™
(
s_İtiÚs
 *tls_options,

194 
gc_¬’a
 *
gc
);

199 
s_auth_¡ªd®Úe_fš®ize
(
s_auth_¡ªd®Úe
 *
s
,

200 cÚ¡ 
äame
 *frame);

207 
s_muÉi_š™_£t_İtiÚs
(
s_muÉi
 *
muÉi
,

208 cÚ¡ *
loÿl
,

209 cÚ¡ *
»mÙe
);

223 
s_muÉi_ä“
(
s_muÉi
 *
muÉi
, 
boŞ
 
ş—r
);

229 
	#TLSMP_INACTIVE
 0

	)

230 
	#TLSMP_ACTIVE
 1

	)

231 
	#TLSMP_KILL
 2

	)

239 
s_muÉi_´oûss
(
s_muÉi
 *
muÉi
,

240 
bufãr
 *
to_lšk
,

241 
lšk_sock‘_aùu®
 **
to_lšk_addr
,

242 
lšk_sock‘_šfo
 *
to_lšk_sock‘_šfo
,

243 
š‹rv®_t
 *
wakeup
);

298 
boŞ
 
s_´e_deüy±
(
s_muÉi
 *
muÉi
,

299 cÚ¡ 
lšk_sock‘_aùu®
 *
äom
,

300 
bufãr
 *
buf
,

301 
üy±o_İtiÚs
 **
İt
,

302 
boŞ
 
æß‹d
,

303 cÚ¡ 
ušt8_t
 **
ad_¡¬t
);

341 
boŞ
 
s_´e_deüy±_l™e
(cÚ¡ 
s_auth_¡ªd®Úe
 *
s
,

342 cÚ¡ 
lšk_sock‘_aùu®
 *
äom
,

343 cÚ¡ 
bufãr
 *
buf
);

359 
s_´e_’üy±
(
s_muÉi
 *
muÉi
,

360 
bufãr
 *
buf
, 
üy±o_İtiÚs
 **
İt
);

376 
s_´•’d_İcode_v1
(cÚ¡ 
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
);

395 
s_´•’d_İcode_v2
(cÚ¡ 
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
);

404 
s_po¡_’üy±
(
s_muÉi
 *
muÉi
, 
bufãr
 *
buf
);

412 
³m_·sswÜd_£tup
(cÚ¡ *
auth_fe
);

418 
auth_u£r_·ss_£tup
(cÚ¡ *
auth_fe
, cÚ¡ 
¡©ic_ch®Ënge_šfo
 *
sc_šfo
);

423 
s¦_£t_auth_noÿche
();

429 
s¦_purge_auth
(cÚ¡ 
boŞ
 
auth_u£r_·ss_Úly
);

431 
s¦_£t_auth_tok’
(cÚ¡ *
tok’
);

433 #ifdeà
ENABLE_CLIENT_CR


439 
s¦_purge_auth_ch®Ënge
();

441 
boŞ
 
s¦_ş—n_auth_tok’
();

443 
s¦_put_auth_ch®Ënge
(cÚ¡ *
ü_¡r
);

450 
s_adju¡_äame_·¿m‘”s
(
äame
 *frame);

455 
boŞ
 
s_£nd_·ylßd
(
s_muÉi
 *
muÉi
,

456 cÚ¡ 
ušt8_t
 *
d©a
,

457 
size
);

462 
boŞ
 
s_»c_·ylßd
(
s_muÉi
 *
muÉi
,

463 
bufãr
 *
buf
);

471 
s_upd©e_»mÙe_addr
(
s_muÉi
 *
muÉi
,

472 cÚ¡ 
lšk_sock‘_aùu®
 *
addr
);

485 
boŞ
 
s_£ssiÚ_upd©e_üy±o_·¿ms
(
s_£ssiÚ
 *
£ssiÚ
,

486 
İtiÚs
 *İtiÚs, 
äame
 *frame);

495 
s_poÜ_mªs_nı
(
İtiÚs
 *
o
, cÚ¡ *
»mÙe_ch”Çme
);

497 #ifdeà
MANAGEMENT_DEF_AUTH


498 
šlše
 *

499 
	$s_g‘_³”_šfo
(cÚ¡ 
s_muÉi
 *
muÉi
)

501  
muÉi
->
³”_šfo
;

502 
	}
}

509 
s_³”_šfo_nı_v”
(cÚ¡ *
³”_šfo
);

518 
boŞ
 
s_check_nı_ch”_li¡
(cÚ¡ *
li¡
);

524 
boŞ
 
s_™em_š_ch”_li¡
(cÚ¡ *
™em
, cÚ¡ *
li¡
);

531 
šlše
 
boŞ


532 
	$s_š™Ÿl_·ck‘_»ûived
(cÚ¡ 
s_muÉi
 *
muÉi
)

534  
muÉi
->
n_£ssiÚs
 > 0;

535 
	}
}

537 
šlše
 
boŞ


538 
	$s_‹¡_auth_deã¼ed_š‹rv®
(cÚ¡ 
s_muÉi
 *
muÉi
)

540 ià(
muÉi
)

542 cÚ¡ 
key_¡©e
 *
ks
 = &
muÉi
->
£ssiÚ
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

543  
now
 < 
ks
->
auth_deã¼ed_expœe
;

545  
çl£
;

546 
	}
}

548 
šlše
 

549 
	$s_‹¡_·ylßd_Ën
(cÚ¡ 
s_muÉi
 *
muÉi
)

551 ià(
muÉi
)

553 cÚ¡ 
key_¡©e
 *
ks
 = &
muÉi
->
£ssiÚ
[
TM_ACTIVE
].
key
[
KS_PRIMARY
];

554 ià(
ks
->
¡©e
 >ğ
S_ACTIVE
)

556  
	`BLEN
(&
ks
->
¶aš‹xt_»ad_buf
);

560 
	}
}

562 
šlše
 

563 
	$s_£t_sšgË_£ssiÚ
(
s_muÉi
 *
muÉi
)

565 ià(
muÉi
)

567 
muÉi
->
İt
.
sšgË_£ssiÚ
 = 
Œue
;

569 
	}
}

574 
	#PD_TLS_AUTH_HMAC_SIZE_MASK
 0xFF

	)

575 
	#PD_SHOW_DATA
 (1<<8)

	)

576 
	#PD_TLS
 (1<<9)

	)

577 
	#PD_VERBOSE
 (1<<10)

	)

579 cÚ¡ *
´ÙocŞ_dump
(
bufãr
 *buffer,

580 
æags
,

581 
gc_¬’a
 *
gc
);

587 #ifdeà
MEASURE_TLS_HANDSHAKE_STATS


588 
show_s_³rfÜmªû_¡©s
();

593 
exŒaù_x509_f›ld_‹¡
();

601 
boŞ
 
is_h¬d_»£t
(
İ
, 
key_m‘hod
);

603 
d–ayed_auth_·ss_purge
();

615 
show_avaabË_s_ch”s
(cÚ¡ *
ch”_li¡
,

616 cÚ¡ *
ch”_li¡_s13
,

617 cÚ¡ *
s_û¹_´ofe
);

	@ssl_backend.h

30 #iâdeà
SSL_BACKEND_H_


31 
	#SSL_BACKEND_H_


	)

33 
	~"bufãr.h
"

35 #ifdeà
ENABLE_CRYPTO_OPENSSL


36 
	~"s¦_İ’s¦.h
"

37 
	~"s¦_v”ify_İ’s¦.h
"

38 
	#SSLAPI
 
SSLAPI_OPENSSL


	)

40 #ifdeà
ENABLE_CRYPTO_MBEDTLS


41 
	~"s¦_mbeds.h
"

42 
	~"s¦_v”ify_mbeds.h
"

43 
	#SSLAPI
 
SSLAPI_MBEDTLS


	)

47 #iâdeà
SSLAPI


48 
	#SSLAPI
 
SSLAPI_NONE


	)

54 
	gs_£ssiÚ
;

62 ¡ruù { cÚ¡ *
	mİ’s¦_Çme
; cÚ¡ *
	mŸÇ_Çme
; } 
	ts_ch”_Çme_·œ
;

63 cÚ¡ 
s_ch”_Çme_·œ
 *
s_g‘_ch”_Çme_·œ
(cÚ¡ *
ch”_Çme
, 
size_t
 
Ën
);

79 
³m_·sswÜd_ÿÎback
(*
buf
, 
size
, 
rwæag
, *
u
);

91 
s_š™_lib
();

96 
s_ä“_lib
();

101 
s_ş—r_”rÜ
();

112 
	#TLS_VER_BAD
 -1

	)

113 
	#TLS_VER_UNSPEC
 0

	)

114 
	#TLS_VER_1_0
 1

	)

115 
	#TLS_VER_1_1
 2

	)

116 
	#TLS_VER_1_2
 3

	)

117 
	#TLS_VER_1_3
 4

	)

118 
s_v”siÚ_·r£
(cÚ¡ *
v¡r
, cÚ¡ *
exŒa
);

126 
s_v”siÚ_max
();

128 #ifdeà
ENABLE_CRYPTO


135 
s_ùx_£rv”_Ãw
(
s_roÙ_ùx
 *
ùx
);

142 
s_ùx_ş›Á_Ãw
(
s_roÙ_ùx
 *
ùx
);

149 
s_ùx_ä“
(
s_roÙ_ùx
 *
ùx
);

158 
boŞ
 
s_ùx_š™Ÿli£d
(
s_roÙ_ùx
 *
ùx
);

171 
boŞ
 
s_ùx_£t_İtiÚs
(
s_roÙ_ùx
 *
ùx
, 
s¦_æags
);

181 
s_ùx_»¡riù_ch”s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
);

191 
s_ùx_»¡riù_ch”s_s13
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
);

201 
s_ùx_£t_û¹_´ofe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´ofe
);

210 
s_ùx_check_û¹_time
(cÚ¡ 
s_roÙ_ùx
 *
ùx
);

221 
s_ùx_lßd_dh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
dh_fe
,

222 cÚ¡ *
dh_fe_šlše
);

231 
s_ùx_lßd_ecdh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
curve_Çme


246 
s_ùx_lßd_pkcs12
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
pkcs12_fe
,

247 cÚ¡ *
pkcs12_fe_šlše
, 
boŞ
 
lßd_ÿ_fe


257 #ifdeà
ENABLE_CRYPTOAPI


258 
s_ùx_lßd_üy±ßpi
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
üy±ßpi_û¹
);

271 
s_ùx_lßd_û¹_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
û¹_fe
,

272 cÚ¡ *
û¹_fe_šlše
);

285 
s_ùx_lßd_´iv_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´iv_key_fe
,

286 cÚ¡ *
´iv_key_fe_šlše


289 #ifdeà
MANAGMENT_EXTERNAL_KEY


303 
s_ùx_u£_ex‹º®_´iv©e_key
(
s_roÙ_ùx
 *
ùx
,

304 cÚ¡ *
û¹_fe
, cÚ¡ *
û¹_fe_šlše
);

320 
s_ùx_lßd_ÿ
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ÿ_fe
,

321 cÚ¡ *
ÿ_fe_šlše
, cÚ¡ *
ÿ_·th
, 
boŞ
 
s_£rv”


335 
s_ùx_lßd_exŒa_û¹s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
exŒa_û¹s_fe
,

336 cÚ¡ *
exŒa_û¹s_fe_šlše


339 #ifdeà
ENABLE_CRYPTO_MBEDTLS


346 
s_ùx_³rsÚ®i£_¿ndom
(
s_roÙ_ùx
 *
ùx
);

365 
key_¡©e_s¦_š™
(
key_¡©e_s¦
 *
ks_s¦
,

366 cÚ¡ 
s_roÙ_ùx
 *
s¦_ùx
, 
boŞ
 
is_£rv”
, 
s_£ssiÚ
 *
£ssiÚ
);

373 
key_¡©e_s¦_ä“
(
key_¡©e_s¦
 *
ks_s¦
);

383 
back’d_s_ùx_»lßd_ül
(
s_roÙ_ùx
 *
s¦_ùx
,

384 cÚ¡ *
ül_fe
, cÚ¡ *
ül_šlše
);

396 
	$key_¡©e_expÜt_keyšg_m©”Ÿl
(
key_¡©e_s¦
 *
ks_s¦
,

397 
s_£ssiÚ
 *
£ssiÚ
è
	`__©Œibu‹__
((
nÚnuÎ
));

423 
	`key_¡©e_wr™e_¶aš‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
);

440 
	`key_¡©e_wr™e_¶aš‹xt_cÚ¡
(
key_¡©e_s¦
 *
ks_s¦
,

441 cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
);

461 
	`key_¡©e_»ad_ch”‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
,

462 
maxËn
);

487 
	`key_¡©e_wr™e_ch”‹xt
(
key_¡©e_s¦
 *
ks_s¦
,

488 
bufãr
 *
buf
);

508 
	`key_¡©e_»ad_¶aš‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
,

509 
maxËn
);

526 
	`´št_d‘as
(
key_¡©e_s¦
 *
ks_s¦
, cÚ¡ *
´efix
);

539 
	`show_avaabË_s_ch”s_li¡
(cÚ¡ *
ch”_li¡
,

540 cÚ¡ *
s_û¹_´ofe
,

541 
boŞ
 
s13
);

546 
	`show_avaabË_curves
();

552 
	`g‘_highe¡_´eã»nû_s_ch”
(*
buf
, 
size
);

558 cÚ¡ *
	`g‘_s¦_lib¿ry_v”siÚ
();

	@ssl_common.h

29 #iâdeà
SSL_COMMON_H_


30 
	#SSL_COMMON_H_


	)

32 
	~"£ssiÚ_id.h
"

33 
	~"sock‘.h
"

34 
	~"·ck‘_id.h
"

35 
	~"üy±o.h
"

36 
	~"İtiÚs.h
"

38 
	~"s¦_back’d.h
"

41 
	#UP_TYPE_AUTH
 "Auth"

	)

42 
	#UP_TYPE_PRIVATE_KEY
 "Priv©Key"

	)

77 
	#S_ERROR
 -1

	)

78 
	#S_UNDEF
 0

	)

80 
	#S_INITIAL
 1

	)

83 
	#S_PRE_START
 2

	)

86 
	#S_START
 3

	)

88 
	#S_SENT_KEY
 4

	)

90 
	#S_GOT_KEY
 5

	)

93 
	#S_ACTIVE
 6

	)

98 
	#S_NORMAL_OP
 7

	)

108 
	skey_sourû
 {

109 
ušt8_t
 
	m´e_ma¡”
[48];

112 
ušt8_t
 
	m¿ndom1
[32];

115 
ušt8_t
 
	m¿ndom2
[32];

125 
	skey_sourû2
 {

126 
key_sourû
 
	mş›Á
;

127 
key_sourû
 
	m£rv”
;

148 
	skey_¡©e


150 
	m¡©e
;

156 
	mkey_id
;

158 
key_¡©e_s¦
 
	mks_s¦
;

160 
time_t
 
	me¡ablished
;

161 
time_t
 
	mmu¡_ÃgÙŸ‹
;

162 
time_t
 
	mmu¡_d›
;

164 
	mš™Ÿl_İcode
;

165 
£ssiÚ_id
 
	m£ssiÚ_id_»mÙe
;

166 
lšk_sock‘_aùu®
 
	m»mÙe_addr
;

168 
üy±o_İtiÚs
 
	müy±o_İtiÚs
;

170 
key_sourû2
 *
	mkey_¤c
;

172 
bufãr
 
	m¶aš‹xt_»ad_buf
;

173 
bufãr
 
	m¶aš‹xt_wr™e_buf
;

174 
bufãr
 
	mack_wr™e_buf
;

176 
»lŸbË
 *
	m£nd_»lŸbË
;

177 
»lŸbË
 *
	m»c_»lŸbË
;

178 
»lŸbË_ack
 *
	m»c_ack
;

180 
bufãr_li¡
 *
	m·ybuf
;

182 
couÁ”_ty³
 
	mn_by‹s
;

183 
couÁ”_ty³
 
	mn_·ck‘s
;

188 
boŞ
 
	mauth’tiÿ‹d
;

189 
time_t
 
	mauth_deã¼ed_expœe
;

191 #ifdeà
ENABLE_DEF_AUTH


193 
boŞ
 
	mauth_deã¼ed
;

194 #ifdeà
MANAGEMENT_DEF_AUTH


195 
	mmda_key_id
;

196 
	mmda_¡©us
;

198 #ifdeà
PLUGIN_DEF_AUTH


199 
	mauth_cÚŒŞ_¡©us
;

200 
time_t
 
	macf_Ï¡_mod
;

201 *
	mauth_cÚŒŞ_fe
;

207 
	ss_w¿p_ùx


210 
	mTLS_WRAP_NONE
 = 0,

211 
	mTLS_WRAP_AUTH
,

212 
	mTLS_WRAP_CRYPT
,

213 } 
	mmode
;

214 
üy±o_İtiÚs
 
	mİt
;

215 
bufãr
 
	mwÜk
;

222 
	ss_İtiÚs


225 
s_roÙ_ùx
 
	ms¦_ùx
;

228 
key_ty³
 
	mkey_ty³
;

231 
boŞ
 
	m£rv”
;

234 
boŞ
 
	mxm™_hŞd
;

236 #ifdeà
ENABLE_OCC


239 cÚ¡ *
	mloÿl_İtiÚs
;

240 cÚ¡ *
	m»mÙe_İtiÚs
;

244 
	mkey_m‘hod
;

245 
boŞ
 
	m»¶ay
;

246 
boŞ
 
	msšgË_£ssiÚ
;

247 #ifdeà
ENABLE_OCC


248 
boŞ
 
	mdi§bË_occ
;

250 
	mmode
;

251 
boŞ
 
	mpuÎ
;

252 #ifdeà
ENABLE_PUSH_PEER_INFO


253 
	mpush_³”_šfo_d‘a
;

255 
	mŒªs™iÚ_wšdow
;

256 
	mhªdshake_wšdow
;

257 
š‹rv®_t
 
	m·ck‘_timeout
;

258 
	m»ÃgÙŸ‹_by‹s
;

259 
	m»ÃgÙŸ‹_·ck‘s
;

260 
š‹rv®_t
 
	m»ÃgÙŸ‹_£cÚds
;

263 cÚ¡ *
	mv”ify_commªd
;

264 cÚ¡ *
	mv”ify_expÜt_û¹
;

265 
	mv”ify_x509_ty³
;

266 cÚ¡ *
	mv”ify_x509_Çme
;

267 cÚ¡ *
	mül_fe
;

268 cÚ¡ *
	mül_fe_šlše
;

269 
	mns_û¹_ty³
;

270 
	m»mÙe_û¹_ku
[
MAX_PARMS
];

271 cÚ¡ *
	m»mÙe_û¹_eku
;

272 
ušt8_t
 *
	mv”ify_hash
;

273 
hash_®go_ty³
 
	mv”ify_hash_®go
;

274 *
	mx509_u£ºame_f›ld
;

278 
boŞ
 
	m·ss_cÚfig_šfo
;

281 
	müy±o_æags
;

283 
	m»¶ay_wšdow
;

284 
	m»¶ay_time
;

285 
boŞ
 
	mtı_mode
;

287 cÚ¡ *
	mcÚfig_ch”Çme
;

288 cÚ¡ *
	mcÚfig_authÇme
;

289 
boŞ
 
	mnı_’abËd
;

292 
s_w¿p_ùx
 
	ms_w¿p
;

295 
äame
 
	mäame
;

298 cÚ¡ *
	mauth_u£r_·ss_v”ify_süt
;

299 
boŞ
 
	mauth_u£r_·ss_v”ify_süt_vŸ_fe
;

300 cÚ¡ *
	mtmp_dœ
;

301 cÚ¡ *
	mauth_u£r_·ss_fe
;

302 
boŞ
 
	mauth_tok’_g’”©e
;

304 
	mauth_tok’_liãtime
;

307 cÚ¡ *
	mş›Á_cÚfig_dœ_exşusive
;

310 
’v_£t
 *
	mes
;

311 cÚ¡ 
¶ugš_li¡
 *
	m¶ugšs
;

314 #ifdeà
USE_COMP


315 
com´ess_İtiÚs
 
	mcomp_İtiÚs
;

319 
	#SSLF_CLIENT_CERT_NOT_REQUIRED
 (1<<0)

	)

320 
	#SSLF_CLIENT_CERT_OPTIONAL
 (1<<1)

	)

321 
	#SSLF_USERNAME_AS_COMMON_NAME
 (1<<2)

	)

322 
	#SSLF_AUTH_USER_PASS_OPTIONAL
 (1<<3)

	)

323 
	#SSLF_OPT_VERIFY
 (1<<4)

	)

324 
	#SSLF_CRL_VERIFY_DIR
 (1<<5)

	)

325 
	#SSLF_TLS_VERSION_MIN_SHIFT
 6

	)

326 
	#SSLF_TLS_VERSION_MIN_MASK
 0xF

	)

327 
	#SSLF_TLS_VERSION_MAX_SHIFT
 10

	)

328 
	#SSLF_TLS_VERSION_MAX_MASK
 0xF

	)

329 
	ms¦_æags
;

331 #ifdeà
MANAGEMENT_DEF_AUTH


332 
mª_def_auth_cÚ‹xt
 *
	mmda_cÚ‹xt
;

335 cÚ¡ 
x509_Œack
 *
	mx509_Œack
;

337 #ifdeà
ENABLE_CLIENT_CR


338 cÚ¡ 
¡©ic_ch®Ënge_šfo
 *
	msci
;

342 
	mg»mlš
;

345 cÚ¡ *
	mekm_Ïb–
;

346 
size_t
 
	mekm_Ïb–_size
;

347 
size_t
 
	mekm_size
;

357 
	#KS_PRIMARY
 0

	)

358 
	#KS_LAME_DUCK
 1

	)

360 
	#KS_SIZE
 2

	)

364 
	#AUTH_TOKEN_SIZE
 32

	)

384 
	ss_£ssiÚ


387 
s_İtiÚs
 *
	mİt
;

390 
boŞ
 
	mbur¡
;

393 
s_w¿p_ùx
 
	ms_w¿p
;

395 
	mš™Ÿl_İcode
;

396 
£ssiÚ_id
 
	m£ssiÚ_id
;

403 
	mkey_id
;

405 
	mlim™_Ãxt
;

407 
	mv”ify_maxËv–
;

409 *
	mcommÚ_Çme
;

411 
û¹_hash_£t
 *
	mû¹_hash_£t
;

413 #ifdeà
ENABLE_PF


414 
ušt32_t
 
	mcommÚ_Çme_hashv®
;

417 
boŞ
 
	mv”if›d
;

420 
lšk_sock‘_aùu®
 
	muÁru¡ed_addr
;

422 
key_¡©e
 
	mkey
[
KS_SIZE
];

442 
	#TM_ACTIVE
 0

	)

443 
	#TM_UNTRUSTED
 1

	)

445 
	#TM_LAME_DUCK
 2

	)

446 
	#TM_SIZE
 3

	)

462 
	#KEY_SCAN_SIZE
 3

	)

478 
	ss_muÉi


484 
s_İtiÚs
 
	mİt
;

486 
key_¡©e
 *
	mkey_sÿn
[
KEY_SCAN_SIZE
];

495 
key_¡©e
 *
	m§ve_ks
;

501 
lšk_sock‘_aùu®
 
	mto_lšk_addr
;

503 
	mn_£ssiÚs
;

509 
	mn_h¬d_”rÜs
;

510 
	mn_soá_”rÜs
;

515 *
	mlocked_ú
;

516 *
	mlocked_u£ºame
;

517 
û¹_hash_£t
 *
	mlocked_û¹_hash_£t
;

519 #ifdeà
ENABLE_DEF_AUTH


523 *
	mş›Á_»asÚ
;

526 
time_t
 
	ms_Ï¡
;

529 #ià
P2MP_SERVER


534 *
	m³”_šfo
;

538 
ušt32_t
 
	m³”_id
;

539 
boŞ
 
	mu£_³”_id
;

541 *
	m»mÙe_ch”Çme
;

543 *
	mauth_tok’
;

547 
time_t
 
	mauth_tok’_t¡amp
;

548 
boŞ
 
	mauth_tok’_£Á
;

553 
s_£ssiÚ
 
	m£ssiÚ
[
TM_SIZE
];

	@ssl_mbedtls.c

30 #ifdeà
HAVE_CONFIG_H


31 
	~"cÚfig.h
"

32 #–ià
defšed
(
_MSC_VER
)

33 
	~"cÚfig-msvc.h
"

36 
	~"sysh—d.h
"

38 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_MBEDTLS
)

40 
	~"”¾ev–.h
"

41 
	~"s¦_back’d.h
"

42 
	~"ba£64.h
"

43 
	~"bufãr.h
"

44 
	~"misc.h
"

45 
	~"mªage.h
"

46 
	~"s¦_commÚ.h
"

48 
	~<mbeds/havege.h
>

50 
	~"s¦_v”ify_mbeds.h
"

51 
	~<mbeds/debug.h
>

52 
	~<mbeds/”rÜ.h
>

53 
	~<mbeds/v”siÚ.h
>

55 #ià
MBEDTLS_VERSION_NUMBER
 >= 0x02040000

56 
	~<mbeds/Ãt_sock‘s.h
>

58 
	~<mbeds/Ãt.h
>

61 
	~<mbeds/oid.h
>

62 
	~<mbeds/³m.h
>

64 cÚ¡ 
mbeds_x509_üt_´ofe
 
	gİ’v²_x509_üt_´ofe_Ëgacy
 =

67 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA1
 ) |

68 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_RIPEMD160
 ) |

69 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA224
 ) |

70 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA256
 ) |

71 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA384
 ) |

72 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA512
 ),

78 cÚ¡ 
mbeds_x509_üt_´ofe
 
	gİ’v²_x509_üt_´ofe_´eã¼ed
 =

81 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA224
 ) |

82 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA256
 ) |

83 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA384
 ) |

84 
MBEDTLS_X509_ID_FLAG
Ğ
MBEDTLS_MD_SHA512
 ),

90 
	#İ’v²_x509_üt_´ofe_su™eb
 
mbeds_x509_üt_´ofe_su™eb
;

	)

93 
	$s_š™_lib
()

95 
	}
}

98 
	$s_ä“_lib
()

100 
	}
}

103 
	$s_ş—r_”rÜ
()

105 
	}
}

108 
	$s_ùx_£rv”_Ãw
(
s_roÙ_ùx
 *
ùx
)

110 
	`ASSERT
(
NULL
 !ğ
ùx
);

111 
	`CLEAR
(*
ùx
);

113 
	`ALLOC_OBJ_CLEAR
(
ùx
->
dhm_ùx
, 
mbeds_dhm_cÚ‹xt
);

115 
	`ALLOC_OBJ_CLEAR
(
ùx
->
ÿ_chaš
, 
mbeds_x509_üt
);

117 
ùx
->
’dpošt
 = 
MBEDTLS_SSL_IS_SERVER
;

118 
ùx
->
š™Ÿli£d
 = 
Œue
;

119 
	}
}

122 
	$s_ùx_ş›Á_Ãw
(
s_roÙ_ùx
 *
ùx
)

124 
	`ASSERT
(
NULL
 !ğ
ùx
);

125 
	`CLEAR
(*
ùx
);

127 
	`ALLOC_OBJ_CLEAR
(
ùx
->
dhm_ùx
, 
mbeds_dhm_cÚ‹xt
);

128 
	`ALLOC_OBJ_CLEAR
(
ùx
->
ÿ_chaš
, 
mbeds_x509_üt
);

130 
ùx
->
’dpošt
 = 
MBEDTLS_SSL_IS_CLIENT
;

131 
ùx
->
š™Ÿli£d
 = 
Œue
;

132 
	}
}

135 
	$s_ùx_ä“
(
s_roÙ_ùx
 *
ùx
)

137 ià(
ùx
)

139 
	`mbeds_pk_ä“
(
ùx
->
´iv_key
);

140 ià(
ùx
->
´iv_key
)

142 
	`ä“
(
ùx
->
´iv_key
);

145 
	`mbeds_x509_üt_ä“
(
ùx
->
ÿ_chaš
);

146 ià(
ùx
->
ÿ_chaš
)

148 
	`ä“
(
ùx
->
ÿ_chaš
);

151 
	`mbeds_x509_üt_ä“
(
ùx
->
üt_chaš
);

152 ià(
ùx
->
üt_chaš
)

154 
	`ä“
(
ùx
->
üt_chaš
);

157 
	`mbeds_dhm_ä“
(
ùx
->
dhm_ùx
);

158 ià(
ùx
->
dhm_ùx
)

160 
	`ä“
(
ùx
->
dhm_ùx
);

163 
	`mbeds_x509_ül_ä“
(
ùx
->
ül
);

164 ià(
ùx
->
ül
)

166 
	`ä“
(
ùx
->
ül
);

169 #ià
	`defšed
(
ENABLE_PKCS11
)

170 ià(
ùx
->
´iv_key_pkcs11
 !ğ
NULL
)

172 
	`mbeds_pkcs11_´iv_key_ä“
(
ùx
->
´iv_key_pkcs11
);

173 
	`ä“
(
ùx
->
´iv_key_pkcs11
);

176 #ià
	`defšed
(
MANAGMENT_EXTERNAL_KEY
)

177 ià(
ùx
->
ex‹º®_key
 !ğ
NULL
)

179 
	`ä“
(
ùx
->
ex‹º®_key
);

183 ià(
ùx
->
®lowed_ch”s
)

185 
	`ä“
(
ùx
->
®lowed_ch”s
);

188 
	`CLEAR
(*
ùx
);

190 
ùx
->
š™Ÿli£d
 = 
çl£
;

193 
	}
}

195 
boŞ


196 
	$s_ùx_š™Ÿli£d
(
s_roÙ_ùx
 *
ùx
)

198 
	`ASSERT
(
NULL
 !ğ
ùx
);

199  
ùx
->
š™Ÿli£d
;

200 
	}
}

203 
	$key_¡©e_expÜt_keyšg_m©”Ÿl
(
key_¡©e_s¦
 *
s¦
,

204 
s_£ssiÚ
 *
£ssiÚ
)

206 
	}
}

208 
boŞ


209 
	$s_ùx_£t_İtiÚs
(
s_roÙ_ùx
 *
ùx
, 
s¦_æags
)

211  
Œue
;

212 
	}
}

215 
	$s_Œª¦©e_ch”_Çme
(cÚ¡ *
ch”_Çme
)

217 cÚ¡ 
s_ch”_Çme_·œ
 *
·œ
 = 
	`s_g‘_ch”_Çme_·œ
(
ch”_Çme
, 
	`¡¾’
(cipher_name));

219 ià(
NULL
 =ğ
·œ
)

222  
ch”_Çme
;

225 ià(0 !ğ
	`¡rcmp
(
ch”_Çme
, 
·œ
->
ŸÇ_Çme
))

228 
	`msg
(
M_WARN
, "D•»ÿ‹d ch” su™Çm'%s',…Ëa£ u£ IANA‚am'%s'", 
·œ
->
İ’s¦_Çme
,…aœ->
ŸÇ_Çme
);

231  
·œ
->
ŸÇ_Çme
;

232 
	}
}

235 
	$s_ùx_»¡riù_ch”s_s13
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
)

237 ià(
ch”s
 =ğ
NULL
)

243 
	`msg
(
M_WARN
, "mbed TLS does‚ot support settingls-ciphersuites. "

244 "IgnÜšg TLS 1.3 ch”†i¡: %s", 
ch”s
);

245 
	}
}

248 
	$s_ùx_»¡riù_ch”s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
)

250 *
tmp_ch”s
, *
tmp_ch”s_Üig
, *
tok’
;

251 
i
, 
ch”_couÁ
;

252 
ch”s_Ën
;

254 ià(
NULL
 =ğ
ch”s
)

259 
ch”s_Ën
 = 
	`¡¾’
(
ch”s
);

261 
	`ASSERT
(
NULL
 !ğ
ùx
);

262 
	`ASSERT
(0 !ğ
ch”s_Ën
);

265 
i
 = 0, 
ch”_couÁ
 = 1; i < 
ch”s_Ën
; i++)

267 ià(
ch”s
[
i
] == ':')

269 
ch”_couÁ
++;

274 
	`ALLOC_ARRAY_CLEAR
(
ùx
->
®lowed_ch”s
, , 
ch”_couÁ
+1)

277 
i
 = 0;

278 
tmp_ch”s_Üig
 = 
tmp_ch”s
 = 
	`¡ršg_®loc
(
ch”s
, 
NULL
);

280 
tok’
 = 
	`¡¹ok
(
tmp_ch”s
, ":");

281 
tok’
)

283 
ùx
->
®lowed_ch”s
[
i
] = 
	`mbeds_s¦_g‘_ch”su™e_id
(

284 
	`s_Œª¦©e_ch”_Çme
(
tok’
));

285 ià(0 !ğ
ùx
->
®lowed_ch”s
[
i
])

287 
i
++;

289 
tok’
 = 
	`¡¹ok
(
NULL
, ":");

291 
	`ä“
(
tmp_ch”s_Üig
);

292 
	}
}

295 
	$s_ùx_£t_û¹_´ofe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´ofe
)

297 ià(!
´ofe
 || 0 =ğ
	`¡rcmp
(profile, "legacy"))

299 
ùx
->
û¹_´ofe
 = 
İ’v²_x509_üt_´ofe_Ëgacy
;

301 ià(0 =ğ
	`¡rcmp
(
´ofe
, "preferred"))

303 
ùx
->
û¹_´ofe
 = 
İ’v²_x509_üt_´ofe_´eã¼ed
;

305 ià(0 =ğ
	`¡rcmp
(
´ofe
, "suiteb"))

307 
ùx
->
û¹_´ofe
 = 
İ’v²_x509_üt_´ofe_su™eb
;

311 
	`msg
 (
M_FATAL
, "ERROR: Inv®id c”ˆ´ofe: %s", 
´ofe
);

313 
	}
}

316 
	$s_ùx_check_û¹_time
(cÚ¡ 
s_roÙ_ùx
 *
ùx
)

318 
	`ASSERT
(
ùx
);

319 ià(
ùx
->
üt_chaš
 =ğ
NULL
)

324 ià(
	`mbeds_x509_time_is_futu»
(&
ùx
->
üt_chaš
->
v®id_äom
))

326 
	`msg
(
M_WARN
, "WARNING: Your certificate is‚ot yet valid!");

329 ià(
	`mbeds_x509_time_is_·¡
(&
ùx
->
üt_chaš
->
v®id_to
))

331 
	`msg
(
M_WARN
, "WARNING: Your certificate hasƒxpired!");

333 
	}
}

336 
	$s_ùx_lßd_dh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
dh_fe
,

337 cÚ¡ *
dh_šlše


340 ià(!
	`¡rcmp
(
dh_fe
, 
INLINE_FILE_TAG
è&& 
dh_šlše
)

342 ià(!
	`mbed_ok
(
	`mbeds_dhm_·r£_dhm
(
ùx
->
dhm_ùx
,

343 (cÚ¡ *è
dh_šlše
, 
	`¡¾’
(dh_inline)+1)))

345 
	`msg
(
M_FATAL
, "Cannot„ead inline DH…arameters");

350 ià(!
	`mbed_ok
(
	`mbeds_dhm_·r£_dhmfe
(
ùx
->
dhm_ùx
, 
dh_fe
)))

352 
	`msg
(
M_FATAL
, "CªnÙ„—d DH…¬am‘” äom f%s", 
dh_fe
);

356 
	`msg
(
D_TLS_DEBUG_LOW
, "Diff›-H–lmª in™Ÿlized w™h " 
couÁ”_fÜm©
 " bit key",

357 (
couÁ”_ty³
è8 * 
	`mbeds_mpi_size
(&
ùx
->
dhm_ùx
->
P
));

358 
	}
}

361 
	$s_ùx_lßd_ecdh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
curve_Çme


364 ià(
NULL
 !ğ
curve_Çme
)

366 
	`msg
(
M_WARN
, "WARNING: mbed TLS builds do‚ot support specifying‡n ECDH "

369 
	}
}

372 
	$s_ùx_lßd_pkcs12
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
pkcs12_fe
,

373 cÚ¡ *
pkcs12_fe_šlše
,

374 
boŞ
 
lßd_ÿ_fe


377 
	`msg
(
M_FATAL
, "PKCS #12 files‚ot yet supported for mbed TLS.");

379 
	}
}

381 #ifdeà
ENABLE_CRYPTOAPI


383 
	$s_ùx_lßd_üy±ßpi
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
üy±ßpi_û¹
)

385 
	`msg
(
M_FATAL
, "Windows CryptoAPI‚ot yet supported for mbed TLS.");

386 
	}
}

390 
	$s_ùx_lßd_û¹_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
û¹_fe
,

391 cÚ¡ *
û¹_šlše


394 
	`ASSERT
(
NULL
 !ğ
ùx
);

396 ià(!
ùx
->
üt_chaš
)

398 
	`ALLOC_OBJ_CLEAR
(
ùx
->
üt_chaš
, 
mbeds_x509_üt
);

401 ià(!
	`¡rcmp
(
û¹_fe
, 
INLINE_FILE_TAG
è&& 
û¹_šlše
)

403 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£
(
ùx
->
üt_chaš
,

404 (cÚ¡ *è
û¹_šlše
, 
	`¡¾’
(cert_inline)+1)))

406 
	`msg
(
M_FATAL
, "Cannot†oad inline certificate file");

411 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£_fe
(
ùx
->
üt_chaš
, 
û¹_fe
)))

413 
	`msg
(
M_FATAL
, "CªnÙ†ßd c”tifiÿ‹ f%s", 
û¹_fe
);

416 
	}
}

419 
	$s_ùx_lßd_´iv_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´iv_key_fe
,

420 cÚ¡ *
´iv_key_šlše


423 
¡©us
;

424 
	`ASSERT
(
NULL
 !ğ
ùx
);

426 ià(!
ùx
->
´iv_key
)

428 
	`ALLOC_OBJ_CLEAR
(
ùx
->
´iv_key
, 
mbeds_pk_cÚ‹xt
);

431 ià(!
	`¡rcmp
(
´iv_key_fe
, 
INLINE_FILE_TAG
è&& 
´iv_key_šlše
)

433 
¡©us
 = 
	`mbeds_pk_·r£_key
(
ùx
->
´iv_key
,

434 (cÚ¡ *è
´iv_key_šlše
, 
	`¡¾’
(priv_key_inline)+1,

435 
NULL
, 0);

437 ià(
MBEDTLS_ERR_PK_PASSWORD_REQUIRED
 =ğ
¡©us
)

439 
·ssbuf
[512] = {0};

440 
	`³m_·sswÜd_ÿÎback
(
·ssbuf
, 512, 0, 
NULL
);

441 
¡©us
 = 
	`mbeds_pk_·r£_key
(
ùx
->
´iv_key
,

442 (cÚ¡ *è
´iv_key_šlše
,

443 
	`¡¾’
(
´iv_key_šlše
)+1, (*è
·ssbuf
,

444 
	`¡¾’
(
·ssbuf
));

449 
¡©us
 = 
	`mbeds_pk_·r£_keyfe
(
ùx
->
´iv_key
, 
´iv_key_fe
, 
NULL
);

450 ià(
MBEDTLS_ERR_PK_PASSWORD_REQUIRED
 =ğ
¡©us
)

452 
·ssbuf
[512] = {0};

453 
	`³m_·sswÜd_ÿÎback
(
·ssbuf
, 512, 0, 
NULL
);

454 
¡©us
 = 
	`mbeds_pk_·r£_keyfe
(
ùx
->
´iv_key
, 
´iv_key_fe
, 
·ssbuf
);

457 ià(!
	`mbed_ok
(
¡©us
))

459 #ifdeà
ENABLE_MANAGEMENT


460 ià(
mªagem’t
 && (
MBEDTLS_ERR_PK_PASSWORD_MISMATCH
 =ğ
¡©us
))

462 
	`mªagem’t_auth_çu»
(
mªagem’t
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

465 
	`msg
(
M_WARN
, "CªnÙ†ßd…riv©key f%s", 
´iv_key_fe
);

469 ià(!
	`mbed_ok
(
	`mbeds_pk_check_·œ
(&
ùx
->
üt_chaš
->
pk
, ctx->
´iv_key
)))

471 
	`msg
(
M_WARN
, "Private key does‚ot matchhe certificate");

476 
	}
}

478 #ifdeà
MANAGMENT_EXTERNAL_KEY


481 
	sex‹º®_cÚ‹xt
 {

482 
size_t
 
	msigÇtu»_Ëngth
;

504 
šlše
 

505 
	$ex‹º®_pkcs1_sign
Ğ*
ùx_void±r
,

506 (*
f_ºg
)(*, *, 
size_t
), *
p_ºg
, 
mode
,

507 
mbeds_md_ty³_t
 
md_®g
, 
hashËn
, cÚ¡ *
hash
,

508 *
sig
 )

510 
ex‹º®_cÚ‹xt
 *cÚ¡ 
ùx
 = 
ùx_void±r
;

511 *
š_b64
 = 
NULL
;

512 *
out_b64
 = 
NULL
;

513 
rv
;

514 *
p
 = 
sig
;

515 
size_t
 
a¢_Ën
 = 0, 
oid_size
 = 0, 
sig_Ën
 = 0;

516 cÚ¡ *
oid
 = 
NULL
;

518 ià(
NULL
 =ğ
ùx
)

520  
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
;

523 ià(
MBEDTLS_RSA_PRIVATE
 !ğ
mode
)

525  
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
;

534 ià(
md_®g
 !ğ
MBEDTLS_MD_NONE
)

536 cÚ¡ 
mbeds_md_šfo_t
 *
md_šfo
 = 
	`mbeds_md_šfo_äom_ty³
Ğ
md_®g
 );

537 ià(
md_šfo
 =ğ
NULL
)

539 Ğ
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
 );

542 ià(!
	`mbed_ok
(
	`mbeds_oid_g‘_oid_by_md
Ğ
md_®g
, &
oid
, &
oid_size
 )))

544 Ğ
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
 );

547 
hashËn
 = 
	`mbeds_md_g‘_size
Ğ
md_šfo
 );

548 
a¢_Ën
 = 10 + 
oid_size
;

551 
sig_Ën
 = 
ùx
->
sigÇtu»_Ëngth
;

552 iàĞ(
SIZE_MAX
 - 
hashËn
è< 
a¢_Ën
 || (hashËÀ+‡¢_Ënè> 
sig_Ën
)

554  
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
;

557 ià(
md_®g
 !ğ
MBEDTLS_MD_NONE
)

568 *
p
++ = 
MBEDTLS_ASN1_SEQUENCE
 | 
MBEDTLS_ASN1_CONSTRUCTED
;

569 *
p
++ = (èĞ0x08 + 
oid_size
 + 
hashËn
 );

570 *
p
++ = 
MBEDTLS_ASN1_SEQUENCE
 | 
MBEDTLS_ASN1_CONSTRUCTED
;

571 *
p
++ = (èĞ0x04 + 
oid_size
 );

572 *
p
++ = 
MBEDTLS_ASN1_OID
;

573 *
p
++ = 
oid_size
 & 0xFF;

574 
	`memıy
Ğ
p
, 
oid
, 
oid_size
 );

575 
p
 +ğ
oid_size
;

576 *
p
++ = 
MBEDTLS_ASN1_NULL
;

577 *
p
++ = 0x00;

578 *
p
++ = 
MBEDTLS_ASN1_OCTET_STRING
;

579 *
p
++ = 
hashËn
;

582 
a¢_Ën
 = 
p
 - 
sig
;

586 
	`memıy
Ğ
p
, 
hash
, 
hashËn
 );

589 ià(
	`İ’v²_ba£64_’code
(
sig
, 
a¢_Ën
 + 
hashËn
, &
š_b64
) <= 0)

591 
rv
 = 
MBEDTLS_ERR_RSA_BAD_INPUT_DATA
;

592 
dÚe
;

596 ià(
mªagem’t
)

598 
out_b64
 = 
	`mªagem’t_qu”y_r§_sig
(
mªagem’t
, 
š_b64
);

600 ià(!
out_b64
)

602 
rv
 = 
MBEDTLS_ERR_RSA_PRIVATE_FAILED
;

603 
dÚe
;

607 ià(
	`İ’v²_ba£64_decode
(
out_b64
, 
sig
, 
ùx
->
sigÇtu»_Ëngth
) !=

608 
ùx
->
sigÇtu»_Ëngth
)

610 
rv
 = 
MBEDTLS_ERR_RSA_PRIVATE_FAILED
;

611 
dÚe
;

614 
rv
 = 0;

616 
dÚe
:

617 ià(
š_b64
)

619 
	`ä“
(
š_b64
);

621 ià(
out_b64
)

623 
	`ä“
(
out_b64
);

625  
rv
;

626 
	}
}

628 
šlše
 
size_t


629 
	$ex‹º®_key_Ën
(*
vùx
)

631 
ex‹º®_cÚ‹xt
 *cÚ¡ 
ùx
 = 
vùx
;

633  
ùx
->
sigÇtu»_Ëngth
;

634 
	}
}

637 
	$s_ùx_u£_ex‹º®_´iv©e_key
(
s_roÙ_ùx
 *
ùx
,

638 cÚ¡ *
û¹_fe
, cÚ¡ *
û¹_fe_šlše
)

640 
	`ASSERT
(
NULL
 !ğ
ùx
);

642 
	`s_ùx_lßd_û¹_fe
(
ùx
, 
û¹_fe
, 
û¹_fe_šlše
);

644 ià(
ùx
->
üt_chaš
 =ğ
NULL
)

649 
	`ALLOC_OBJ_CLEAR
(
ùx
->
ex‹º®_key
, 
ex‹º®_cÚ‹xt
);

650 
ùx
->
ex‹º®_key
->
sigÇtu»_Ëngth
 = 
	`mbeds_pk_g‘_Ën
(&ùx->
üt_chaš
->
pk
);

652 
	`ALLOC_OBJ_CLEAR
(
ùx
->
´iv_key
, 
mbeds_pk_cÚ‹xt
);

653 ià(!
	`mbed_ok
(
	`mbeds_pk_£tup_r§_®t
(
ùx
->
´iv_key
, ctx->
ex‹º®_key
,

654 
NULL
, 
ex‹º®_pkcs1_sign
, 
ex‹º®_key_Ën
)))

660 
	}
}

664 
	$s_ùx_lßd_ÿ
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ÿ_fe
,

665 cÚ¡ *
ÿ_šlše
, cÚ¡ *
ÿ_·th
, 
boŞ
 
s_£rv”


668 ià(
ÿ_·th
)

670 
	`msg
(
M_FATAL
, "ERROR: mbed TLS cannot handlehe capath directive");

673 ià(
ÿ_fe
 && !
	`¡rcmp
(ÿ_fe, 
INLINE_FILE_TAG
è&& 
ÿ_šlše
)

675 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£
(
ùx
->
ÿ_chaš
,

676 (cÚ¡ *è
ÿ_šlše
, 
	`¡¾’
(ca_inline)+1)))

678 
	`msg
(
M_FATAL
, "Cannot†oad inline CA certificates");

684 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£_fe
(
ùx
->
ÿ_chaš
, 
ÿ_fe
)))

686 
	`msg
(
M_FATAL
, "CªnÙ†ßd CA c”tifiÿ‹ f%s", 
ÿ_fe
);

689 
	}
}

692 
	$s_ùx_lßd_exŒa_û¹s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
exŒa_û¹s_fe
,

693 cÚ¡ *
exŒa_û¹s_šlše


696 
	`ASSERT
(
NULL
 !ğ
ùx
);

698 ià(!
ùx
->
üt_chaš
)

700 
	`ALLOC_OBJ_CLEAR
(
ùx
->
üt_chaš
, 
mbeds_x509_üt
);

703 ià(!
	`¡rcmp
(
exŒa_û¹s_fe
, 
INLINE_FILE_TAG
è&& 
exŒa_û¹s_šlše
)

705 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£
(
ùx
->
üt_chaš
,

706 (cÚ¡ *è
exŒa_û¹s_šlše
,

707 
	`¡¾’
(
exŒa_û¹s_šlše
)+1)))

709 
	`msg
(
M_FATAL
, "Cannot†oad inlineƒxtra-certs file");

714 ià(!
	`mbed_ok
(
	`mbeds_x509_üt_·r£_fe
(
ùx
->
üt_chaš
, 
exŒa_û¹s_fe
)))

716 
	`msg
(
M_FATAL
, "CªnÙ†ßdƒxŒa-û¹ fe: %s", 
exŒa_û¹s_fe
);

719 
	}
}

731 
šlše
 

732 
	$buf_ä“_’Œy
(
bufãr_’Œy
 *
’Œy
)

734 ià(
NULL
 !ğ
’Œy
)

736 
	`ä“
(
’Œy
->
d©a
);

737 
	`ä“
(
’Œy
);

739 
	}
}

742 
	$buf_ä“_’Œ›s
(
’dËss_bufãr
 *
buf
)

744 
buf
->
fœ¡_block
)

746 
bufãr_’Œy
 *
cur_block
 = 
buf
->
fœ¡_block
;

747 
buf
->
fœ¡_block
 = 
cur_block
->
Ãxt_block
;

748 
	`buf_ä“_’Œy
(
cur_block
);

750 
buf
->
Ï¡_block
 = 
NULL
;

751 
	}
}

754 
	$’dËss_buf_»ad
Ğ
’dËss_bufãr
 *
š
, *
out
, 
size_t
 
out_Ën
 )

756 
size_t
 
»ad_Ën
 = 0;

758 ià(
š
->
fœ¡_block
 =ğ
NULL
)

760  
MBEDTLS_ERR_SSL_WANT_READ
;

763 
š
->
fœ¡_block
 !ğ
NULL
 && 
»ad_Ën
 < 
out_Ën
)

765 
block_Ën
 = 
š
->
fœ¡_block
->
Ëngth
 - in->
d©a_¡¬t
;

766 ià(
block_Ën
 <ğ
out_Ën
 - 
»ad_Ën
)

768 
bufãr_’Œy
 *
cur_’Œy
 = 
š
->
fœ¡_block
;

769 
	`memıy
(
out
 + 
»ad_Ën
, 
cur_’Œy
->
d©a
 + 
š
->
d©a_¡¬t
,

770 
block_Ën
);

772 
»ad_Ën
 +ğ
block_Ën
;

774 
š
->
fœ¡_block
 = 
cur_’Œy
->
Ãxt_block
;

775 
š
->
d©a_¡¬t
 = 0;

777 ià(
š
->
fœ¡_block
 =ğ
NULL
)

779 
š
->
Ï¡_block
 = 
NULL
;

782 
	`buf_ä“_’Œy
(
cur_’Œy
);

786 
	`memıy
(
out
 + 
»ad_Ën
, 
š
->
fœ¡_block
->
d©a
 + in->
d©a_¡¬t
,

787 
out_Ën
 - 
»ad_Ën
);

788 
š
->
d©a_¡¬t
 +ğ
out_Ën
 - 
»ad_Ën
;

789 
»ad_Ën
 = 
out_Ën
;

793  
»ad_Ën
;

794 
	}
}

797 
	$’dËss_buf_wr™e
Ğ
’dËss_bufãr
 *
out
, cÚ¡ *
š
, 
size_t
 
Ën
 )

799 
bufãr_’Œy
 *
Ãw_block
 = 
	`m®loc
((buffer_entry));

800 ià(
NULL
 =ğ
Ãw_block
)

802  
MBEDTLS_ERR_NET_SEND_FAILED
;

805 
Ãw_block
->
d©a
 = 
	`m®loc
(
Ën
);

806 ià(
NULL
 =ğ
Ãw_block
->
d©a
)

808 
	`ä“
(
Ãw_block
);

809  
MBEDTLS_ERR_NET_SEND_FAILED
;

812 
Ãw_block
->
Ëngth
 = 
Ën
;

813 
Ãw_block
->
Ãxt_block
 = 
NULL
;

815 
	`memıy
(
Ãw_block
->
d©a
, 
š
, 
Ën
);

817 ià(
NULL
 =ğ
out
->
fœ¡_block
)

819 
out
->
fœ¡_block
 = 
Ãw_block
;

822 ià(
NULL
 !ğ
out
->
Ï¡_block
)

824 
out
->
Ï¡_block
->
Ãxt_block
 = 
Ãw_block
;

827 
out
->
Ï¡_block
 = 
Ãw_block
;

829  
Ën
;

830 
	}
}

833 
	$s¦_bio_»ad
Ğ*
ùx
, *
out
, 
size_t
 
out_Ën
)

835 
bio_ùx
 *
my_ùx
 = (bio_ùx *è
ùx
;

836  
	`’dËss_buf_»ad
(&
my_ùx
->
š
, 
out
, 
out_Ën
);

837 
	}
}

840 
	$s¦_bio_wr™e
Ğ*
ùx
, cÚ¡ *
š
, 
size_t
 
š_Ën
)

842 
bio_ùx
 *
my_ùx
 = (bio_ùx *è
ùx
;

843  
	`’dËss_buf_wr™e
(&
my_ùx
->
out
, 
š
, 
š_Ën
);

844 
	}
}

847 
	$my_debug
Ğ*
ùx
, 
Ëv–
, cÚ¡ *
fe
, 
lše
,

848 cÚ¡ *
¡r
 )

850 
my_logËv–
 = (
Ëv–
 < 3è? 
D_TLS_DEBUG_MED
 : 
D_TLS_DEBUG
;

851 
	`msg
(
my_logËv–
, "mbed TLS msg (%s:%d): %s", 
fe
, 
lše
, 
¡r
);

852 
	}
}

858 
	$s_ùx_³rsÚ®i£_¿ndom
(
s_roÙ_ùx
 *
ùx
)

860 
Şd_sha256_hash
[32] = {0};

861 
sha256_hash
[32] = {0};

862 
mbeds_ùr_drbg_cÚ‹xt
 *
cd_ùx
 = 
	`¿nd_ùx_g‘
();

864 ià(
NULL
 !ğ
ùx
->
üt_chaš
)

866 cÚ¡ 
md_kt_t
 *
sha256_kt
 = 
	`md_kt_g‘
("SHA256");

867 
mbeds_x509_üt
 *
û¹
 = 
ùx
->
üt_chaš
;

869 ià(!
	`md_fuÎ
(
sha256_kt
, 
û¹
->
tbs
.
p
, c”t->tbs.
Ën
, 
sha256_hash
))

871 
	`msg
(
M_WARN
, "WARNING: failedo…ersonalise„andom");

874 ià(0 !ğ
	`memcmp
(
Şd_sha256_hash
, 
sha256_hash
, (sha256_hash)))

876 
	`mbeds_ùr_drbg_upd©e
(
cd_ùx
, 
sha256_hash
, 32);

877 
	`memıy
(
Şd_sha256_hash
, 
sha256_hash
, (old_sha256_hash));

880 
	}
}

883 
	$s_v”siÚ_max
()

885 #ià
	`defšed
(
MBEDTLS_SSL_MAJOR_VERSION_3
è&& defšed(
MBEDTLS_SSL_MINOR_VERSION_3
)

886  
TLS_VER_1_2
;

887 #–ià
	`defšed
(
MBEDTLS_SSL_MAJOR_VERSION_3
è&& defšed(
MBEDTLS_SSL_MINOR_VERSION_2
)

888  
TLS_VER_1_1
;

890  
TLS_VER_1_0
;

892 
	}
}

905 
	$s_v”siÚ_to_majÜ_mšÜ
(
s_v”
, *
majÜ
, *
mšÜ
)

907 
	`ASSERT
(
majÜ
);

908 
	`ASSERT
(
mšÜ
);

910 
s_v”
)

912 
TLS_VER_1_0
:

913 *
majÜ
 = 
MBEDTLS_SSL_MAJOR_VERSION_3
;

914 *
mšÜ
 = 
MBEDTLS_SSL_MINOR_VERSION_1
;

917 
TLS_VER_1_1
:

918 *
majÜ
 = 
MBEDTLS_SSL_MAJOR_VERSION_3
;

919 *
mšÜ
 = 
MBEDTLS_SSL_MINOR_VERSION_2
;

922 
TLS_VER_1_2
:

923 *
majÜ
 = 
MBEDTLS_SSL_MAJOR_VERSION_3
;

924 *
mšÜ
 = 
MBEDTLS_SSL_MINOR_VERSION_3
;

928 
	`msg
(
M_FATAL
, "%s: inv®id TLS v”siÚ %d", 
__func__
, 
s_v”
);

931 
	}
}

934 
	$back’d_s_ùx_»lßd_ül
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ül_fe
,

935 cÚ¡ *
ül_šlše
)

937 
	`ASSERT
(
ül_fe
);

939 ià(
ùx
->
ül
 =ğ
NULL
)

941 
	`ALLOC_OBJ_CLEAR
(
ùx
->
ül
, 
mbeds_x509_ül
);

943 
	`mbeds_x509_ül_ä“
(
ùx
->
ül
);

945 ià(!
	`¡rcmp
(
ül_fe
, 
INLINE_FILE_TAG
è&& 
ül_šlše
)

947 ià(!
	`mbed_ok
(
	`mbeds_x509_ül_·r£
(
ùx
->
ül
,

948 (cÚ¡ *)
ül_šlše
, 
	`¡¾’
(crl_inline)+1)))

950 
	`msg
(
M_WARN
, "CRL: cannot…arse inline CRL");

951 
”r
;

956 ià(!
	`mbed_ok
(
	`mbeds_x509_ül_·r£_fe
(
ùx
->
ül
, 
ül_fe
)))

958 
	`msg
(
M_WARN
, "CRL: cªnÙ„—d CRL from f%s", 
ül_fe
);

959 
”r
;

964 
”r
:

965 
	`mbeds_x509_ül_ä“
(
ùx
->
ül
);

966 
	}
}

969 
	$key_¡©e_s¦_š™
(
key_¡©e_s¦
 *
ks_s¦
,

970 cÚ¡ 
s_roÙ_ùx
 *
s¦_ùx
, 
boŞ
 
is_£rv”
, 
s_£ssiÚ
 *
£ssiÚ
)

972 
	`ASSERT
(
NULL
 !ğ
s¦_ùx
);

973 
	`ASSERT
(
ks_s¦
);

974 
	`CLEAR
(*
ks_s¦
);

977 
	`mbeds_s¦_cÚfig_š™
(&
ks_s¦
->
s¦_cÚfig
);

978 
	`mbeds_s¦_cÚfig_deçuÉs
(&
ks_s¦
->
s¦_cÚfig
, 
s¦_ùx
->
’dpošt
,

979 
MBEDTLS_SSL_TRANSPORT_STREAM
, 
MBEDTLS_SSL_PRESET_DEFAULT
);

980 #ifdeà
MBEDTLS_DEBUG_C


981 
	`mbeds_debug_£t_th»shŞd
(3);

983 
	`mbeds_s¦_cÚf_dbg
(&
ks_s¦
->
s¦_cÚfig
, 
my_debug
, 
NULL
);

984 
	`mbeds_s¦_cÚf_ºg
(&
ks_s¦
->
s¦_cÚfig
, 
mbeds_ùr_drbg_¿ndom
,

985 
	`¿nd_ùx_g‘
());

987 
	`mbeds_s¦_cÚf_û¹_´ofe
(&
ks_s¦
->
s¦_cÚfig
, &
s¦_ùx
->
û¹_´ofe
);

989 ià(
s¦_ùx
->
®lowed_ch”s
)

991 
	`mbeds_s¦_cÚf_ch”su™es
(&
ks_s¦
->
s¦_cÚfig
, 
s¦_ùx
->
®lowed_ch”s
);

998 #ià
	`defšed
(
MBEDTLS_SSL_CBC_RECORD_SPLITTING
)

999 
	`mbeds_s¦_cÚf_cbc_»cÜd_¥l™tšg
(&
ks_s¦
->
s¦_cÚfig
,

1000 
MBEDTLS_SSL_CBC_RECORD_SPLITTING_DISABLED
);

1004 ià(
is_£rv”
)

1006 
	`mbed_ok
(
	`mbeds_s¦_cÚf_dh_·¿m_ùx
(&
ks_s¦
->
s¦_cÚfig
,

1007 
s¦_ùx
->
dhm_ùx
));

1010 
	`mbed_ok
(
	`mbeds_s¦_cÚf_own_û¹
(&
ks_s¦
->
s¦_cÚfig
, 
s¦_ùx
->
üt_chaš
,

1011 
s¦_ùx
->
´iv_key
));

1014 #ià
P2MP_SERVER


1015 ià(
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_CLIENT_CERT_OPTIONAL
)

1017 
	`mbeds_s¦_cÚf_authmode
(&
ks_s¦
->
s¦_cÚfig
, 
MBEDTLS_SSL_VERIFY_OPTIONAL
);

1019 ià(!(
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
))

1022 
	`mbeds_s¦_cÚf_authmode
(&
ks_s¦
->
s¦_cÚfig
, 
MBEDTLS_SSL_VERIFY_REQUIRED
);

1024 
	`mbeds_s¦_cÚf_v”ify
(&
ks_s¦
->
s¦_cÚfig
, 
v”ify_ÿÎback
, 
£ssiÚ
);

1027 
	`mbeds_s¦_cÚf_ÿ_chaš
(&
ks_s¦
->
s¦_cÚfig
, 
s¦_ùx
->
ÿ_chaš
, s¦_ùx->
ül
);

1031 cÚ¡ 
s_v”siÚ_mš
 =

1032 (
£ssiÚ
->
İt
->
s¦_æags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
)

1033 &
SSLF_TLS_VERSION_MIN_MASK
;

1036 
majÜ
 = 
MBEDTLS_SSL_MAJOR_VERSION_3
;

1037 
mšÜ
 = 
MBEDTLS_SSL_MINOR_VERSION_1
;

1039 ià(
s_v”siÚ_mš
 > 
TLS_VER_UNSPEC
)

1041 
	`s_v”siÚ_to_majÜ_mšÜ
(
s_v”siÚ_mš
, &
majÜ
, &
mšÜ
);

1044 
	`mbeds_s¦_cÚf_mš_v”siÚ
(&
ks_s¦
->
s¦_cÚfig
, 
majÜ
, 
mšÜ
);

1049 cÚ¡ 
s_v”siÚ_max
 =

1050 (
£ssiÚ
->
İt
->
s¦_æags
 >> 
SSLF_TLS_VERSION_MAX_SHIFT
)

1051 &
SSLF_TLS_VERSION_MAX_MASK
;

1053 ià(
s_v”siÚ_max
 > 
TLS_VER_UNSPEC
)

1055 
majÜ
, 
mšÜ
;

1056 
	`s_v”siÚ_to_majÜ_mšÜ
(
s_v”siÚ_max
, &
majÜ
, &
mšÜ
);

1057 
	`mbeds_s¦_cÚf_max_v”siÚ
(&
ks_s¦
->
s¦_cÚfig
, 
majÜ
, 
mšÜ
);

1062 
	`ALLOC_OBJ_CLEAR
(
ks_s¦
->
ùx
, 
mbeds_s¦_cÚ‹xt
);

1063 
	`mbeds_s¦_š™
(
ks_s¦
->
ùx
);

1064 
	`mbeds_s¦_£tup
(
ks_s¦
->
ùx
, &ks_s¦->
s¦_cÚfig
);

1067 
	`CLEAR
(
ks_s¦
->
bio_ùx
);

1068 
	`mbeds_s¦_£t_bio
(
ks_s¦
->
ùx
, &ks_s¦->
bio_ùx
, 
s¦_bio_wr™e
,

1069 
s¦_bio_»ad
, 
NULL
);

1070 
	}
}

1073 
	$key_¡©e_s¦_ä“
(
key_¡©e_s¦
 *
ks_s¦
)

1075 ià(
ks_s¦
)

1077 ià(
ks_s¦
->
ùx
)

1079 
	`mbeds_s¦_ä“
(
ks_s¦
->
ùx
);

1080 
	`ä“
(
ks_s¦
->
ùx
);

1082 
	`mbeds_s¦_cÚfig_ä“
(&
ks_s¦
->
s¦_cÚfig
);

1083 
	`buf_ä“_’Œ›s
(&
ks_s¦
->
bio_ùx
.
š
);

1084 
	`buf_ä“_’Œ›s
(&
ks_s¦
->
bio_ùx
.
out
);

1085 
	`CLEAR
(*
ks_s¦
);

1087 
	}
}

1090 
	$key_¡©e_wr™e_¶aš‹xt
(
key_¡©e_s¦
 *
ks
, 
bufãr
 *
buf
)

1092 
»tv®
 = 0;

1094 
	`ASSERT
(
buf
);

1096 
»tv®
 = 
	`key_¡©e_wr™e_¶aš‹xt_cÚ¡
(
ks
, 
	`BPTR
(
buf
), 
	`BLEN
(buf));

1098 ià(1 =ğ
»tv®
)

1100 
	`mem£t
(
	`BPTR
(
buf
), 0, 
	`BLEN
(buf));

1101 
buf
->
Ën
 = 0;

1104  
»tv®
;

1105 
	}
}

1108 
	$key_¡©e_wr™e_¶aš‹xt_cÚ¡
(
key_¡©e_s¦
 *
ks
, cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

1110 
»tv®
 = 0;

1111 
	`³rf_push
(
PERF_BIO_WRITE_PLAINTEXT
);

1113 
	`ASSERT
(
NULL
 !ğ
ks
);

1114 
	`ASSERT
(
Ën
 >= 0);

1116 ià(0 =ğ
Ën
)

1118 
	`³rf_pİ
();

1122 
	`ASSERT
(
d©a
);

1124 
»tv®
 = 
	`mbeds_s¦_wr™e
(
ks
->
ùx
, 
d©a
, 
Ën
);

1126 ià(
»tv®
 < 0)

1128 
	`³rf_pİ
();

1129 ià(
MBEDTLS_ERR_SSL_WANT_WRITE
 =ğ
»tv®
 || 
MBEDTLS_ERR_SSL_WANT_READ
 ==„etval)

1133 
	`mbed_log_”r
(
D_TLS_ERRORS
, 
»tv®
,

1138 ià(
»tv®
 !ğ
Ën
)

1140 
	`msg
(
D_TLS_ERRORS
,

1142 
»tv®
, 
Ën
);

1143 
	`³rf_pİ
();

1148 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "wr™s_wr™e_¶aš‹xt_cÚ¡ %d by‹s", 
»tv®
);

1150 
	`³rf_pİ
();

1152 
	}
}

1155 
	$key_¡©e_»ad_ch”‹xt
(
key_¡©e_s¦
 *
ks
, 
bufãr
 *
buf
,

1156 
maxËn
)

1158 
»tv®
 = 0;

1159 
Ën
 = 0;

1161 
	`³rf_push
(
PERF_BIO_READ_CIPHERTEXT
);

1163 
	`ASSERT
(
NULL
 !ğ
ks
);

1164 
	`ASSERT
(
buf
);

1165 
	`ASSERT
(
buf
->
Ën
 >= 0);

1167 ià(
buf
->
Ën
)

1169 
	`³rf_pİ
();

1173 
Ën
 = 
	`buf_fÜw¬d_ÿ·c™y
(
buf
);

1174 ià(
maxËn
 < 
Ën
)

1176 
Ën
 = 
maxËn
;

1179 
»tv®
 = 
	`’dËss_buf_»ad
(&
ks
->
bio_ùx
.
out
, 
	`BPTR
(
buf
), 
Ën
);

1182 ià(
»tv®
 < 0)

1184 
	`³rf_pİ
();

1185 ià(
MBEDTLS_ERR_SSL_WANT_WRITE
 =ğ
»tv®
 || 
MBEDTLS_ERR_SSL_WANT_READ
 ==„etval)

1189 
	`mbed_log_”r
(
D_TLS_ERRORS
, 
»tv®
, "TLS_ERROR:„eadls_read_ciphertextƒrror");

1190 
buf
->
Ën
 = 0;

1194 ià(0 =ğ
»tv®
)

1196 
buf
->
Ën
 = 0;

1197 
	`³rf_pİ
();

1202 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "»adls_»ad_ch”‹xˆ%d by‹s", 
»tv®
);

1203 
buf
->
Ën
 = 
»tv®
;

1204 
	`³rf_pİ
();

1206 
	}
}

1209 
	$key_¡©e_wr™e_ch”‹xt
(
key_¡©e_s¦
 *
ks
, 
bufãr
 *
buf
)

1211 
»tv®
 = 0;

1212 
	`³rf_push
(
PERF_BIO_WRITE_CIPHERTEXT
);

1214 
	`ASSERT
(
NULL
 !ğ
ks
);

1215 
	`ASSERT
(
buf
);

1216 
	`ASSERT
(
buf
->
Ën
 >= 0);

1218 ià(0 =ğ
buf
->
Ën
)

1220 
	`³rf_pİ
();

1224 
»tv®
 = 
	`’dËss_buf_wr™e
(&
ks
->
bio_ùx
.
š
, 
	`BPTR
(
buf
), buf->
Ën
);

1226 ià(
»tv®
 < 0)

1228 
	`³rf_pİ
();

1230 ià(
MBEDTLS_ERR_SSL_WANT_WRITE
 =ğ
»tv®
 || 
MBEDTLS_ERR_SSL_WANT_READ
 ==„etval)

1234 
	`mbed_log_”r
(
D_TLS_ERRORS
, 
»tv®
,

1239 ià(
»tv®
 !ğ
buf
->
Ën
)

1241 
	`msg
(
D_TLS_ERRORS
, "TLS ERROR: writels_write_ciphertext incomplete %d/%d",

1242 
»tv®
, 
buf
->
Ën
);

1243 
	`³rf_pİ
();

1248 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "wr™s_wr™e_ch”‹xˆ%d by‹s", 
»tv®
);

1250 
	`mem£t
(
	`BPTR
(
buf
), 0, 
	`BLEN
(buf));

1251 
buf
->
Ën
 = 0;

1253 
	`³rf_pİ
();

1255 
	}
}

1258 
	$key_¡©e_»ad_¶aš‹xt
(
key_¡©e_s¦
 *
ks
, 
bufãr
 *
buf
,

1259 
maxËn
)

1261 
»tv®
 = 0;

1262 
Ën
 = 0;

1264 
	`³rf_push
(
PERF_BIO_READ_PLAINTEXT
);

1266 
	`ASSERT
(
NULL
 !ğ
ks
);

1267 
	`ASSERT
(
buf
);

1268 
	`ASSERT
(
buf
->
Ën
 >= 0);

1270 ià(
buf
->
Ën
)

1272 
	`³rf_pİ
();

1276 
Ën
 = 
	`buf_fÜw¬d_ÿ·c™y
(
buf
);

1277 ià(
maxËn
 < 
Ën
)

1279 
Ën
 = 
maxËn
;

1282 
»tv®
 = 
	`mbeds_s¦_»ad
(
ks
->
ùx
, 
	`BPTR
(
buf
), 
Ën
);

1285 ià(
»tv®
 < 0)

1287 ià(
MBEDTLS_ERR_SSL_WANT_WRITE
 =ğ
»tv®
 || 
MBEDTLS_ERR_SSL_WANT_READ
 ==„etval)

1291 
	`mbed_log_”r
(
D_TLS_ERRORS
, 
»tv®
, "TLS_ERROR:„eadls_read_plaintextƒrror");

1292 
buf
->
Ën
 = 0;

1293 
	`³rf_pİ
();

1297 ià(0 =ğ
»tv®
)

1299 
buf
->
Ën
 = 0;

1300 
	`³rf_pİ
();

1305 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "»adls_»ad_¶aš‹xˆ%d by‹s", 
»tv®
);

1306 
buf
->
Ën
 = 
»tv®
;

1308 
	`³rf_pİ
();

1310 
	}
}

1320 
	$´št_d‘as
(
key_¡©e_s¦
 *
ks_s¦
, cÚ¡ *
´efix
)

1322 cÚ¡ 
mbeds_x509_üt
 *
û¹
;

1323 
s1
[256];

1324 
s2
[256];

1326 
s1
[0] = 
s2
[0] = 0;

1327 
	`İ’v²_¢´štf
(
s1
, (s1), "%s %s, cipher %s",

1328 
´efix
,

1329 
	`mbeds_s¦_g‘_v”siÚ
(
ks_s¦
->
ùx
),

1330 
	`mbeds_s¦_g‘_ch”su™e
(
ks_s¦
->
ùx
));

1332 
û¹
 = 
	`mbeds_s¦_g‘_³”_û¹
(
ks_s¦
->
ùx
);

1333 ià(
û¹
 !ğ
NULL
)

1335 
	`İ’v²_¢´štf
(
s2
, (s2), ", %u bit key",

1336 (è
	`mbeds_pk_g‘_b™Ën
(&
û¹
->
pk
));

1339 
	`msg
(
D_HANDSHAKE
, "%s%s", 
s1
, 
s2
);

1340 
	}
}

1343 
	$show_avaabË_s_ch”s_li¡
(cÚ¡ *
ch”_li¡
,

1344 cÚ¡ *
s_û¹_´ofe
,

1345 
boŞ
 
s13
)

1347 ià(
s13
)

1352 
s_roÙ_ùx
 
s_ùx
;

1353 cÚ¡ *
ch”s
 = 
	`mbeds_s¦_li¡_ch”su™es
();

1355 
	`s_ùx_£rv”_Ãw
(&
s_ùx
);

1356 
	`s_ùx_£t_û¹_´ofe
(&
s_ùx
, 
s_û¹_´ofe
);

1357 
	`s_ùx_»¡riù_ch”s
(&
s_ùx
, 
ch”_li¡
);

1359 ià(
s_ùx
.
®lowed_ch”s
)

1361 
ch”s
 = 
s_ùx
.
®lowed_ch”s
;

1364 *
ch”s
 != 0)

1366 
	`´štf
("%s\n", 
	`mbeds_s¦_g‘_ch”su™e_Çme
(*
ch”s
));

1367 
ch”s
++;

1369 
	`s_ùx_ä“
(&
s_ùx
);

1370 
	}
}

1373 
	$show_avaabË_curves
()

1375 cÚ¡ 
mbeds_eı_curve_šfo
 *
pcurve
 = 
	`mbeds_eı_curve_li¡
();

1377 ià(
NULL
 =ğ
pcurve
)

1379 
	`msg
(
M_FATAL
, "Cannot„etrieve curve†ist from mbed TLS");

1383 
	`´štf
("Available Elliptic curves,†isted in order of…reference:\n\n");

1384 
MBEDTLS_ECP_DP_NONE
 !ğ
pcurve
->
g½_id
)

1386 
	`´štf
("%s\n", 
pcurve
->
Çme
);

1387 
pcurve
++;

1389 
	}
}

1392 
	$g‘_highe¡_´eã»nû_s_ch”
(*
buf
, 
size
)

1394 cÚ¡ *
ch”_Çme
;

1395 cÚ¡ *
ch”s
 = 
	`mbeds_s¦_li¡_ch”su™es
();

1396 ià(*
ch”s
 == 0)

1398 
	`msg
(
M_FATAL
, "Cannot„etrieve†ist of supported SSL ciphers.");

1401 
ch”_Çme
 = 
	`mbeds_s¦_g‘_ch”su™e_Çme
(*
ch”s
);

1402 
	`¡ºıyÁ
(
buf
, 
ch”_Çme
, 
size
);

1403 
	}
}

1406 
	$g‘_s¦_lib¿ry_v”siÚ
()

1408 
mbeds_v”siÚ
[30];

1409 
pv
 = 
	`mbeds_v”siÚ_g‘_numb”
();

1410 
	`¥rštf
Ğ
mbeds_v”siÚ
, "mbed TLS %d.%d.%d",

1411 (
pv
>>24)&0xff, (pv>>16)&0xff, (pv>>8)&0xff );

1412  
mbeds_v”siÚ
;

1413 
	}
}

	@ssl_mbedtls.h

29 #iâdeà
SSL_MBEDTLS_H_


30 
	#SSL_MBEDTLS_H_


	)

32 
	~"sysh—d.h
"

34 
	~<mbeds/s¦.h
>

35 
	~<mbeds/x509_üt.h
>

37 #ià
defšed
(
ENABLE_PKCS11
)

38 
	~<mbeds/pkcs11.h
>

41 
_bufãr_’Œy
 
	tbufãr_’Œy
;

43 
	s_bufãr_’Œy
 {

44 
size_t
 
	mËngth
;

45 
ušt8_t
 *
	md©a
;

46 
bufãr_’Œy
 *
	mÃxt_block
;

50 
size_t
 
	md©a_¡¬t
;

51 
bufãr_’Œy
 *
	mfœ¡_block
;

52 
bufãr_’Œy
 *
	mÏ¡_block
;

53 } 
	t’dËss_bufãr
;

56 
’dËss_bufãr
 
	mš
;

57 
’dËss_bufãr
 
	mout
;

58 } 
	tbio_ùx
;

66 
	ss_roÙ_ùx
 {

67 
boŞ
 
	mš™Ÿli£d
;

69 
	m’dpošt
;

71 
mbeds_dhm_cÚ‹xt
 *
	mdhm_ùx
;

72 
mbeds_x509_üt
 *
	müt_chaš
;

73 
mbeds_x509_üt
 *
	mÿ_chaš
;

74 
mbeds_pk_cÚ‹xt
 *
	m´iv_key
;

75 
mbeds_x509_ül
 *
	mül
;

76 
time_t
 
	mül_Ï¡_mtime
;

77 
off_t
 
	mül_Ï¡_size
;

78 #ià
defšed
(
ENABLE_PKCS11
)

79 
mbeds_pkcs11_cÚ‹xt
 *
	m´iv_key_pkcs11
;

81 #ifdeà
MANAGMENT_EXTERNAL_KEY


82 
ex‹º®_cÚ‹xt
 *
	mex‹º®_key
;

84 *
	m®lowed_ch”s
;

85 
mbeds_x509_üt_´ofe
 
	mû¹_´ofe
;

88 
	skey_¡©e_s¦
 {

89 
mbeds_s¦_cÚfig
 
	ms¦_cÚfig
;

90 
mbeds_s¦_cÚ‹xt
 *
	mùx
;

91 
bio_ùx
 
	mbio_ùx
;

	@ssl_openssl.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_OPENSSL
)

39 
	~"”¾ev–.h
"

40 
	~"bufãr.h
"

41 
	~"misc.h
"

42 
	~"mªage.h
"

43 
	~"memdbg.h
"

44 
	~"s¦_back’d.h
"

45 
	~"s¦_commÚ.h
"

46 
	~"ba£64.h
"

47 
	~"İ’s¦_com·t.h
"

49 #ifdeà
ENABLE_CRYPTOAPI


50 
	~"üy±ßpi.h
"

53 
	~"s¦_v”ify_İ’s¦.h
"

55 
	~<İ’s¦/”r.h
>

56 
	~<İ’s¦/pkcs12.h
>

57 
	~<İ’s¦/x509.h
>

58 
	~<İ’s¦/üy±o.h
>

59 #iâdeà
OPENSSL_NO_EC


60 
	~<İ’s¦/ec.h
>

69 
	gmyd©a_šdex
;

72 
	$s_š™_lib
()

74 
	`SSL_lib¿ry_š™
();

75 #iâdeà
ENABLE_SMALL


76 
	`SSL_lßd_”rÜ_¡ršgs
();

78 
	`O³nSSL_add_®l_®gÜ™hms
();

80 
myd©a_šdex
 = 
	`SSL_g‘_ex_Ãw_šdex
(0, "¡ruù sessiÚ *", 
NULL
, NULL, NULL);

81 
	`ASSERT
(
myd©a_šdex
 >= 0);

82 
	}
}

85 
	$s_ä“_lib
()

87 
	`EVP_ş—nup
();

88 #iâdeà
ENABLE_SMALL


89 
	`ERR_ä“_¡ršgs
();

91 
	}
}

94 
	$s_ş—r_”rÜ
()

96 
	`ERR_ş—r_”rÜ
();

97 
	}
}

100 
	$s_ùx_£rv”_Ãw
(
s_roÙ_ùx
 *
ùx
)

102 
	`ASSERT
(
NULL
 !ğ
ùx
);

104 
ùx
->ùx = 
	`SSL_CTX_Ãw
(
	`SSLv23_£rv”_m‘hod
());

106 ià(
ùx
->ùx =ğ
NULL
)

108 
	`üy±o_msg
(
M_FATAL
, "SSL_CTX_new SSLv23_server_method");

110 
	}
}

113 
	$s_ùx_ş›Á_Ãw
(
s_roÙ_ùx
 *
ùx
)

115 
	`ASSERT
(
NULL
 !ğ
ùx
);

117 
ùx
->ùx = 
	`SSL_CTX_Ãw
(
	`SSLv23_ş›Á_m‘hod
());

119 ià(
ùx
->ùx =ğ
NULL
)

121 
	`üy±o_msg
(
M_FATAL
, "SSL_CTX_new SSLv23_client_method");

123 
	}
}

126 
	$s_ùx_ä“
(
s_roÙ_ùx
 *
ùx
)

128 
	`ASSERT
(
NULL
 !ğ
ùx
);

129 ià(
NULL
 !ğ
ùx
->ctx)

131 
	`SSL_CTX_ä“
(
ùx
->ctx);

133 
ùx
->ùx = 
NULL
;

134 
	}
}

136 
boŞ


137 
	$s_ùx_š™Ÿli£d
(
s_roÙ_ùx
 *
ùx
)

139 
	`ASSERT
(
NULL
 !ğ
ùx
);

140  
NULL
 !ğ
ùx
->ctx;

141 
	}
}

144 
	$key_¡©e_expÜt_keyšg_m©”Ÿl
(
key_¡©e_s¦
 *
s¦
,

145 
s_£ssiÚ
 *
£ssiÚ
)

147 ià(
£ssiÚ
->
İt
->
ekm_size
 > 0)

149 #ià(
OPENSSL_VERSION_NUMBER
 >= 0x10001000)

150 
size
 = 
£ssiÚ
->
İt
->
ekm_size
;

151 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

152 *
ekm
 = (*è
	`gc_m®loc
(
size
, 
Œue
, &
gc
);

154 ià(
	`SSL_expÜt_keyšg_m©”Ÿl
(
s¦
->s¦, 
ekm
, 
size
,

155 
£ssiÚ
->
İt
->
ekm_Ïb–
, sessiÚ->İt->
ekm_Ïb–_size
, 
NULL
, 0, 0))

157 
Ën
 = (
size
 * 2) + 2;

159 cÚ¡ *
key
 = 
	`fÜm©_hex_ex
(
ekm
, 
size
, 
Ën
, 0, 
NULL
, &
gc
);

160 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "expÜ‹d_keyšg_m©”Ÿl", 
key
);

162 
	`dmsg
(
D_TLS_DEBUG_MED
, "%s:ƒxported keying material: %s",

163 
__func__
, 
key
);

167 
	`msg
(
M_WARN
, "WARNING: Export keying material failed!");

168 
	`£‹nv_d–
(
£ssiÚ
->
İt
->
es
, "exported_keying_material");

170 
	`gc_ä“
(&
gc
);

173 
	}
}

179 #iâdeà
INFO_CALLBACK_SSL_CONST


180 
	#INFO_CALLBACK_SSL_CONST
 cÚ¡

	)

183 
	$šfo_ÿÎback
(
INFO_CALLBACK_SSL_CONST
 
SSL
 *
s
, 
wh”e
, 
»t
)

185 ià(
wh”e
 & 
SSL_CB_LOOP
)

187 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "SSL state (%s): %s",

188 
wh”e
 & 
SSL_ST_CONNECT
 ? "connect" :

189 
wh”e
 &
SSL_ST_ACCEPT
 ? "accept" :

190 "undefšed", 
	`SSL_¡©e_¡ršg_lÚg
(
s
));

192 ià(
wh”e
 & 
SSL_CB_ALERT
)

194 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "SSL‡lert (%s): %s: %s",

195 
wh”e
 & 
SSL_CB_READ
 ? "read" : "write",

196 
	`SSL_®”t_ty³_¡ršg_lÚg
(
»t
),

197 
	`SSL_®”t_desc_¡ršg_lÚg
(
»t
));

199 
	}
}

207 
	$s_v”siÚ_max
()

209 #ià
	`defšed
(
TLS1_3_VERSION
)

210  
TLS_VER_1_3
;

211 #–ià
	`defšed
(
TLS1_2_VERSION
è|| defšed(
SSL_OP_NO_TLSv1_2
)

212  
TLS_VER_1_2
;

213 #–ià
	`defšed
(
TLS1_1_VERSION
è|| defšed(
SSL_OP_NO_TLSv1_1
)

214  
TLS_VER_1_1
;

216  
TLS_VER_1_0
;

218 
	}
}

222 
	$İ’s¦_s_v”siÚ
(
v”
)

224 ià(
v”
 =ğ
TLS_VER_1_0
)

226  
TLS1_VERSION
;

228 ià(
v”
 =ğ
TLS_VER_1_1
)

230  
TLS1_1_VERSION
;

232 ià(
v”
 =ğ
TLS_VER_1_2
)

234  
TLS1_2_VERSION
;

236 #ià
	`defšed
(
TLS1_3_VERSION
)

237 ià(
v”
 =ğ
TLS_VER_1_3
)

239  
TLS1_3_VERSION
;

243 
	}
}

245 
boŞ


246 
	$s_ùx_£t_s_v”siÚs
(
s_roÙ_ùx
 *
ùx
, 
s¦_æags
)

248 
s_v”_mš
 = 
	`İ’s¦_s_v”siÚ
(

249 (
s¦_æags
 >> 
SSLF_TLS_VERSION_MIN_SHIFT
è& 
SSLF_TLS_VERSION_MIN_MASK
);

250 
s_v”_max
 = 
	`İ’s¦_s_v”siÚ
(

251 (
s¦_æags
 >> 
SSLF_TLS_VERSION_MAX_SHIFT
è& 
SSLF_TLS_VERSION_MAX_MASK
);

253 ià(!
s_v”_mš
)

256 
cur_mš
 = 
	`SSL_CTX_g‘_mš_´Ùo_v”siÚ
(
ùx
->ctx);

257 
s_v”_mš
 = 
cur_mš
 < 
TLS1_VERSION
 ? TLS1_VERSION : cur_min;

260 ià(!
	`SSL_CTX_£t_mš_´Ùo_v”siÚ
(
ùx
->ùx, 
s_v”_mš
))

262 
	`msg
(
D_TLS_ERRORS
, "%s: faedØ£ˆmšimum TLS v”siÚ", 
__func__
);

263  
çl£
;

266 ià(
s_v”_max
 && !
	`SSL_CTX_£t_max_´Ùo_v”siÚ
(
ùx
->ctx,ls_ver_max))

268 
	`msg
(
D_TLS_ERRORS
, "%s: faedØ£ˆmaximum TLS v”siÚ", 
__func__
);

269  
çl£
;

272  
Œue
;

273 
	}
}

275 
boŞ


276 
	$s_ùx_£t_İtiÚs
(
s_roÙ_ùx
 *
ùx
, 
s¦_æags
)

278 
	`ASSERT
(
NULL
 !ğ
ùx
);

281 
æags
 = 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
;

284 
s¦İt
 = 
SSL_OP_SINGLE_DH_USE
 | 
SSL_OP_NO_TICKET
;

285 #ifdeà
SSL_OP_CIPHER_SERVER_PREFERENCE


286 
s¦İt
 |ğ
SSL_OP_CIPHER_SERVER_PREFERENCE
;

288 #ifdeà
SSL_OP_NO_COMPRESSION


290 
s¦İt
 |ğ
SSL_OP_NO_COMPRESSION
;

293 
	`SSL_CTX_£t_İtiÚs
(
ùx
->ùx, 
s¦İt
);

295 ià(!
	`s_ùx_£t_s_v”siÚs
(
ùx
, 
s¦_æags
))

297  
çl£
;

300 #ifdeà
SSL_MODE_RELEASE_BUFFERS


301 
	`SSL_CTX_£t_mode
(
ùx
->ùx, 
SSL_MODE_RELEASE_BUFFERS
);

303 
	`SSL_CTX_£t_£ssiÚ_ÿche_mode
(
ùx
->ùx, 
SSL_SESS_CACHE_OFF
);

304 
	`SSL_CTX_£t_deçuÉ_·sswd_cb
(
ùx
->ùx, 
³m_·sswÜd_ÿÎback
);

307 #ià
P2MP_SERVER


308 ià(
s¦_æags
 & 
SSLF_CLIENT_CERT_NOT_REQUIRED
)

310 
æags
 = 0;

312 ià(
s¦_æags
 & 
SSLF_CLIENT_CERT_OPTIONAL
)

314 
æags
 = 
SSL_VERIFY_PEER
;

317 
	`SSL_CTX_£t_v”ify
(
ùx
->ùx, 
æags
, 
v”ify_ÿÎback
);

319 
	`SSL_CTX_£t_šfo_ÿÎback
(
ùx
->ùx, 
šfo_ÿÎback
);

321  
Œue
;

322 
	}
}

325 
	$s_ùx_»¡riù_ch”s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
)

327 ià(
ch”s
 =ğ
NULL
)

330 ià(!
	`SSL_CTX_£t_ch”_li¡
(
ùx
->ctx,

342 
	`üy±o_msg
(
M_FATAL
, "Failedo set default TLS cipher†ist.");

348 
size_t
 
begš_of_ch”
, 
’d_of_ch”
;

350 cÚ¡ *
cu¼’t_ch”
;

351 
size_t
 
cu¼’t_ch”_Ën
;

353 cÚ¡ 
s_ch”_Çme_·œ
 *
ch”_·œ
;

355 
İ’s¦_ch”s
[4096];

356 
size_t
 
İ’s¦_ch”s_Ën
 = 0;

357 
İ’s¦_ch”s
[0] = '\0';

359 
	`ASSERT
(
NULL
 !ğ
ùx
);

362 
begš_of_ch”
 = 
’d_of_ch”
 = 0;

363 ; 
begš_of_ch”
 < 
	`¡¾’
(
ch”s
); begš_of_ch” = 
’d_of_ch”
)

365 
’d_of_ch”
 +ğ
	`¡rc¥n
(&
ch”s
[
begš_of_ch”
], ":");

366 
ch”_·œ
 = 
	`s_g‘_ch”_Çme_·œ
(&
ch”s
[
begš_of_ch”
], 
’d_of_ch”
 - begin_of_cipher);

368 ià(
NULL
 =ğ
ch”_·œ
)

371 
cu¼’t_ch”
 = &
ch”s
[
begš_of_ch”
];

372 
cu¼’t_ch”_Ën
 = 
’d_of_ch”
 - 
begš_of_ch”
;

377 
	`msg
(
D_LOW
, "No validranslation found for TLS cipher '%.*s'",

378 
	`cÚ¡¿š_št
(
cu¼’t_ch”_Ën
, 0, 256), 
cu¼’t_ch”
);

383 
cu¼’t_ch”
 = 
ch”_·œ
->
İ’s¦_Çme
;

384 
cu¼’t_ch”_Ën
 = 
	`¡¾’
(
cu¼’t_ch”
);

386 ià(
’d_of_ch”
 - 
begš_of_ch”
 =ğ
cu¼’t_ch”_Ën


387 && 0 !ğ
	`memcmp
(&
ch”s
[
begš_of_ch”
], 
ch”_·œ
->
ŸÇ_Çme
,

388 
’d_of_ch”
 - 
begš_of_ch”
))

391 
	`msg
(
M_WARN
, "D•»ÿ‹d TLS ch”‚am'%s',…Ëa£ u£ IANA‚am'%s'", 
ch”_·œ
->
İ’s¦_Çme
, ch”_·œ->
ŸÇ_Çme
);

396 ià((
SIZE_MAX
 - 
İ’s¦_ch”s_Ën
è< 
cu¼’t_ch”_Ën


397 || (((
İ’s¦_ch”s
)-1è< 
İ’s¦_ch”s_Ën
 + 
cu¼’t_ch”_Ën
))

399 
	`msg
(
M_FATAL
,

401 ()(
İ’s¦_ch”s
)-1);

405 
	`memıy
(&
İ’s¦_ch”s
[
İ’s¦_ch”s_Ën
], 
cu¼’t_ch”
, 
cu¼’t_ch”_Ën
);

406 
İ’s¦_ch”s_Ën
 +ğ
cu¼’t_ch”_Ën
;

407 
İ’s¦_ch”s
[
İ’s¦_ch”s_Ën
] = ':';

408 
İ’s¦_ch”s_Ën
++;

410 
’d_of_ch”
++;

413 ià(
İ’s¦_ch”s_Ën
 > 0)

415 
İ’s¦_ch”s
[
İ’s¦_ch”s_Ën
-1] = '\0';

419 ià(!
	`SSL_CTX_£t_ch”_li¡
(
ùx
->ùx, 
İ’s¦_ch”s
))

421 
	`üy±o_msg
(
M_FATAL
, "FaedØ£ˆ»¡riùed TLS ch”†i¡: %s", 
İ’s¦_ch”s
);

423 
	}
}

426 
	$cÚv”t_s13_li¡_to_İ’s¦
(*
İ’s¦_ch”s
, 
size_t
 
Ën
,

427 cÚ¡ *
ch”s
)

434 ià(
	`¡¾’
(
ch”s
è>ğ(
Ën
 - 1))

436 
	`msg
(
M_FATAL
,

438 (è(
Ën
 - 1));

441 
	`¡ºıy
(
İ’s¦_ch”s
, 
ch”s
, 
Ën
);

443 
size_t
 
i
 = 0; i < 
	`¡¾’
(
İ’s¦_ch”s
); i++)

445 ià(
İ’s¦_ch”s
[
i
] == '-')

447 
İ’s¦_ch”s
[
i
] = '_';

450 
	}
}

453 
	$s_ùx_»¡riù_ch”s_s13
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ch”s
)

455 ià(
ch”s
 =ğ
NULL
)

462 #ià(
OPENSSL_VERSION_NUMBER
 < 0x1010100fL)

463 
	`üy±o_msg
(
M_WARN
, "Not compiled with OpenSSL 1.1.1 or higher. "

465 
ch”s
);

467 
	`ASSERT
(
NULL
 !ğ
ùx
);

469 
İ’s¦_ch”s
[4096];

470 
	`cÚv”t_s13_li¡_to_İ’s¦
(
İ’s¦_ch”s
, (openssl_ciphers),

471 
ch”s
);

473 ià(!
	`SSL_CTX_£t_ch”su™es
(
ùx
->ùx, 
İ’s¦_ch”s
))

475 
	`üy±o_msg
(
M_FATAL
, "Failedo set„estricted TLS 1.3 cipher†ist: %s",

476 
İ’s¦_ch”s
);

479 
	}
}

482 
	$s_ùx_£t_û¹_´ofe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´ofe
)

484 #ifdeà
HAVE_SSL_CTX_SET_SECURITY_LEVEL


489 ià(!
´ofe
 || 0 =ğ
	`¡rcmp
(profile, "legacy"))

491 
	`SSL_CTX_£t_£cur™y_Ëv–
(
ùx
->ctx, 1);

493 ià(0 =ğ
	`¡rcmp
(
´ofe
, "preferred"))

495 
	`SSL_CTX_£t_£cur™y_Ëv–
(
ùx
->ctx, 2);

497 ià(0 =ğ
	`¡rcmp
(
´ofe
, "suiteb"))

499 
	`SSL_CTX_£t_£cur™y_Ëv–
(
ùx
->ctx, 3);

500 
	`SSL_CTX_£t_ch”_li¡
(
ùx
->ctx, "SUITEB128");

504 
	`msg
(
M_FATAL
, "ERROR: Inv®id c”ˆ´ofe: %s", 
´ofe
);

507 ià(
´ofe
)

509 
	`msg
(
M_WARN
, "WARNING: OpenSSL 1.0.1 does‚ot support --tls-cert-profile"

510 ", ignÜšg u£r-£ˆ´ofe: '%s'", 
´ofe
);

513 
	}
}

516 
	$s_ùx_check_û¹_time
(cÚ¡ 
s_roÙ_ùx
 *
ùx
)

518 
»t
;

519 cÚ¡ 
X509
 *
û¹
;

521 
	`ASSERT
(
ùx
);

523 #ià
OPENSSL_VERSION_NUMBER
 >ğ0x10002000L && !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

525 
û¹
 = 
	`SSL_CTX_g‘0_û¹ifiÿ‹
(
ùx
->ctx);

528 
SSL
 *
s¦
 = 
	`SSL_Ãw
(
ùx
->ctx);

529 
û¹
 = 
	`SSL_g‘_û¹ifiÿ‹
(
s¦
);

532 ià(
û¹
 =ğ
NULL
)

534 
ş—nup
;

537 
»t
 = 
	`X509_cmp_time
(
	`X509_g‘_nÙBefÜe
(
û¹
), 
NULL
);

538 ià(
»t
 == 0)

540 
	`msg
(
D_TLS_DEBUG_MED
, "Failedo„ead certificate‚otBefore field.");

542 ià(
»t
 > 0)

544 
	`msg
(
M_WARN
, "WARNING: Your certificate is‚ot yet valid!");

547 
»t
 = 
	`X509_cmp_time
(
	`X509_g‘_nÙAá”
(
û¹
), 
NULL
);

548 ià(
»t
 == 0)

550 
	`msg
(
D_TLS_DEBUG_MED
, "Failedo„ead certificate‚otAfter field.");

552 ià(
»t
 < 0)

554 
	`msg
(
M_WARN
, "WARNING: Your certificate hasƒxpired!");

557 
ş—nup
:

558 #ià
OPENSSL_VERSION_NUMBER
 < 0x10002000L || 
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

559 
	`SSL_ä“
(
s¦
);

562 
	}
}

565 
	$s_ùx_lßd_dh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
dh_fe
,

566 cÚ¡ *
dh_fe_šlše


569 
DH
 *
dh
;

570 
BIO
 *
bio
;

572 
	`ASSERT
(
NULL
 !ğ
ùx
);

574 ià(!
	`¡rcmp
(
dh_fe
, 
INLINE_FILE_TAG
è&& 
dh_fe_šlše
)

576 ià(!(
bio
 = 
	`BIO_Ãw_mem_buf
((*)
dh_fe_šlše
, -1)))

578 
	`üy±o_msg
(
M_FATAL
, "Cannot open memory BIO for inline DH…arameters");

584 ià(!(
bio
 = 
	`BIO_Ãw_fe
(
dh_fe
, "r")))

586 
	`üy±o_msg
(
M_FATAL
, "CªnÙ o³À% fÜ DH…¬am‘”s", 
dh_fe
);

590 
dh
 = 
	`PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

591 
	`BIO_ä“
(
bio
);

593 ià(!
dh
)

595 
	`üy±o_msg
(
M_FATAL
, "CªnÙ†ßd DH…¬am‘” äom %s", 
dh_fe
);

597 ià(!
	`SSL_CTX_£t_tmp_dh
(
ùx
->ùx, 
dh
))

599 
	`üy±o_msg
(
M_FATAL
, "SSL_CTX_set_tmp_dh");

602 
	`msg
(
D_TLS_DEBUG_LOW
, "Diffie-Hellman initialized with %d bit key",

603 8 * 
	`DH_size
(
dh
));

605 
	`DH_ä“
(
dh
);

606 
	}
}

609 
	$s_ùx_lßd_ecdh_·¿ms
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
curve_Çme


612 #iâdeà
OPENSSL_NO_EC


613 
nid
 = 
NID_undef
;

614 
EC_KEY
 *
ecdh
 = 
NULL
;

615 cÚ¡ *
¢ame
 = 
NULL
;

618 
	`SSL_CTX_£t_İtiÚs
(
ùx
->ùx, 
SSL_OP_SINGLE_ECDH_USE
);

620 ià(
curve_Çme
 !ğ
NULL
)

623 
	`msg
(
D_TLS_DEBUG
, "Usšg u£¸¥ecif›d ECDH curv(%s)", 
curve_Çme
);

624 
nid
 = 
	`OBJ_¢2nid
(
curve_Çme
);

628 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10002000L

631 
	`SSL_CTX_£t_ecdh_auto
(
ùx
->ctx, 1);

635 
EC_KEY
 *
eckey
 = 
NULL
;

636 cÚ¡ 
EC_GROUP
 *
ecg½
 = 
NULL
;

637 
EVP_PKEY
 *
pkey
 = 
NULL
;

640 
SSL
 *
s¦
 = 
	`SSL_Ãw
(
ùx
->ctx);

641 ià(!
s¦
)

643 
	`üy±o_msg
(
M_FATAL
, "SSL_new failed");

645 
pkey
 = 
	`SSL_g‘_´iv©ekey
(
s¦
);

646 
	`SSL_ä“
(
s¦
);

648 
	`msg
(
D_TLS_DEBUG
, "Extracting ECDH curve from…rivate key");

650 ià(
pkey
 !ğ
NULL
 && (
eckey
 = 
	`EVP_PKEY_g‘1_EC_KEY
(pkey)) != NULL

651 && (
ecg½
 = 
	`EC_KEY_g‘0_group
(
eckey
)è!ğ
NULL
)

653 
nid
 = 
	`EC_GROUP_g‘_curve_Çme
(
ecg½
);

659 
¢ame
 = 
	`OBJ_nid2¢
(
nid
);

660 ià(
¢ame
 =ğ
NULL
)

662 
¢ame
 = "(Unknown)";

666 ià(
NID_undef
 =ğ
nid
 || 
NULL
 =ğ(
ecdh
 = 
	`EC_KEY_Ãw_by_curve_Çme
(nid)))

669 
ecdh
 = 
	`EC_KEY_Ãw_by_curve_Çme
(
NID_£ı384r1
);

670 cÚ¡ *
sourû
 = (
NULL
 =ğ
curve_Çme
) ?

672 
	`msg
(
D_TLS_DEBUG_LOW
,

673 "FaedØ% (%s), usšg seı384r1 in¡—d.", 
sourû
, 
¢ame
);

674 
¢ame
 = 
	`OBJ_nid2¢
(
NID_£ı384r1
);

677 ià(!
	`SSL_CTX_£t_tmp_ecdh
(
ùx
->ùx, 
ecdh
))

679 
	`üy±o_msg
(
M_FATAL
, "SSL_CTX_set_tmp_ecdh: cannot‡dd curve");

682 
	`msg
(
D_TLS_DEBUG_LOW
, "ECDH curv% added", 
¢ame
);

684 
	`EC_KEY_ä“
(
ecdh
);

686 
	`msg
(
D_LOW
, "Your OpenSSL†ibrary was built withoutƒlliptic curve support."

689 
	}
}

692 
	$s_ùx_lßd_pkcs12
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
pkcs12_fe
,

693 cÚ¡ *
pkcs12_fe_šlše
,

694 
boŞ
 
lßd_ÿ_fe


697 
FILE
 *
å
;

698 
EVP_PKEY
 *
pkey
;

699 
X509
 *
û¹
;

700 
	`STACK_OF
(
X509
è*
ÿ
 = 
NULL
;

701 
PKCS12
 *
p12
;

702 
i
;

703 
·sswÜd
[256];

705 
	`ASSERT
(
NULL
 !ğ
ùx
);

707 ià(!
	`¡rcmp
(
pkcs12_fe
, 
INLINE_FILE_TAG
è&& 
pkcs12_fe_šlše
)

709 
BIO
 *
b64
 = 
	`BIO_Ãw
(
	`BIO_f_ba£64
());

710 
BIO
 *
bio
 = 
	`BIO_Ãw_mem_buf
((*è
pkcs12_fe_šlše
,

711 (è
	`¡¾’
(
pkcs12_fe_šlše
));

712 
	`ASSERT
(
b64
 && 
bio
);

713 
	`BIO_push
(
b64
, 
bio
);

714 
p12
 = 
	`d2i_PKCS12_bio
(
b64
, 
NULL
);

715 ià(!
p12
)

717 
	`üy±o_msg
(
M_FATAL
, "Error„eading inline PKCS#12 file");

719 
	`BIO_ä“
(
b64
);

720 
	`BIO_ä“
(
bio
);

725 ià(!(
å
 = 
	`¶©fÜm_fİ’
(
pkcs12_fe
, "rb")))

727 
	`üy±o_msg
(
M_FATAL
, "E¼Ü o³nšg f%s", 
pkcs12_fe
);

729 
p12
 = 
	`d2i_PKCS12_å
(
å
, 
NULL
);

730 
	`fşo£
(
å
);

731 ià(!
p12
)

733 
	`üy±o_msg
(
M_FATAL
, "E¼Ü„—dšg PKCS#12 f%s", 
pkcs12_fe
);

738 ià(!
	`PKCS12_·r£
(
p12
, "", &
pkey
, &
û¹
, &
ÿ
))

740 
	`³m_·sswÜd_ÿÎback
(
·sswÜd
, ÕasswÜdè- 1, 0, 
NULL
);

742 
ÿ
 = 
NULL
;

743 ià(!
	`PKCS12_·r£
(
p12
, 
·sswÜd
, &
pkey
, &
û¹
, &
ÿ
))

745 #ifdeà
ENABLE_MANAGEMENT


746 ià(
mªagem’t
 && (
	`ERR_GET_REASON
(
	`ERR_³ek_”rÜ
()è=ğ
PKCS12_R_MAC_VERIFY_FAILURE
))

748 
	`mªagem’t_auth_çu»
(
mªagem’t
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

751 
	`PKCS12_ä“
(
p12
);

755 
	`PKCS12_ä“
(
p12
);

758 ià(!
	`SSL_CTX_u£_û¹ifiÿ‹
(
ùx
->ùx, 
û¹
))

760 
	`üy±o_msg
(
M_FATAL
, "Cannot use certificate");

764 ià(!
	`SSL_CTX_u£_Priv©eKey
(
ùx
->ùx, 
pkey
))

766 
	`üy±o_msg
(
M_FATAL
, "Cannot use…rivate key");

770 ià(!
	`SSL_CTX_check_´iv©e_key
(
ùx
->ctx))

772 
	`üy±o_msg
(
M_FATAL
, "Private key does‚ot matchhe certificate");

776 ià(
lßd_ÿ_fe
)

782 ià(
ÿ
 && 
	`sk_X509_num
(ca))

784 
i
 = 0; i < 
	`sk_X509_num
(
ÿ
); i++)

786 
X509_STORE
 *
û¹_¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
ùx
->ctx);

787 ià(!
	`X509_STORE_add_û¹
(
û¹_¡Üe
,
	`sk_X509_v®ue
(
ÿ
, 
i
)))

789 
	`üy±o_msg
(
M_FATAL
,"Cannot‡dd certificateo certificate chain (X509_STORE_add_cert)");

791 ià(!
	`SSL_CTX_add_ş›Á_CA
(
ùx
->ùx, 
	`sk_X509_v®ue
(
ÿ
, 
i
)))

793 
	`üy±o_msg
(
M_FATAL
,"Cannot‡dd certificateo client CA†ist (SSL_CTX_add_client_CA)");

805 ià(
ÿ
 && 
	`sk_X509_num
(ca))

807 
i
 = 0; i < 
	`sk_X509_num
(
ÿ
); i++)

809 ià(!
	`SSL_CTX_add_exŒa_chaš_û¹
(
ùx
->ùx,
	`sk_X509_v®ue
(
ÿ
, 
i
)))

811 
	`üy±o_msg
(
M_FATAL
, "Cannot‡ddƒxtra certificateo chain (SSL_CTX_add_extra_chain_cert)");

817 
	}
}

819 #ifdeà
ENABLE_CRYPTOAPI


821 
	$s_ùx_lßd_üy±ßpi
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
üy±ßpi_û¹
)

823 
	`ASSERT
(
NULL
 !ğ
ùx
);

826 ià(!
	`SSL_CTX_u£_Cry±oAPI_û¹ifiÿ‹
(
ùx
->ùx, 
üy±ßpi_û¹
))

828 
	`üy±o_msg
(
M_FATAL
, "CªnÙ†ßd c”tifiÿ‹ \"%s\" from Miüosoá C”tifiÿ‹ StÜe", 
üy±ßpi_û¹
);

830 
	}
}

834 
	$s_ùx_add_exŒa_û¹s
(
s_roÙ_ùx
 *
ùx
, 
BIO
 *
bio
)

836 
X509
 *
û¹
;

839 
û¹
 = 
NULL
;

840 ià(!
	`PEM_»ad_bio_X509
(
bio
, &
û¹
, 
NULL
, NULL))

844 ià(!
û¹
)

846 
	`üy±o_msg
(
M_FATAL
, "Error„eadingƒxtra certificate");

848 ià(
	`SSL_CTX_add_exŒa_chaš_û¹
(
ùx
->ùx, 
û¹
) != 1)

850 
	`üy±o_msg
(
M_FATAL
, "Error‡ddingƒxtra certificate");

853 
	}
}

857 
	$s_ùx_lßd_û¹_fe_ªd_cİy
(
s_roÙ_ùx
 *
ùx
,

858 cÚ¡ *
û¹_fe
, cÚ¡ *
û¹_fe_šlše
, 
X509
 **
x509


861 
BIO
 *
š
 = 
NULL
;

862 
X509
 *
x
 = 
NULL
;

863 
»t
 = 0;

864 
boŞ
 
šlše_fe
 = 
çl£
;

866 
	`ASSERT
(
NULL
 !ğ
ùx
);

867 ià(
NULL
 !ğ
x509
)

869 
	`ASSERT
(
NULL
 =ğ*
x509
);

872 
šlše_fe
 = (
	`¡rcmp
(
û¹_fe
, 
INLINE_FILE_TAG
) == 0);

874 ià(
šlše_fe
 && 
û¹_fe_šlše
)

876 
š
 = 
	`BIO_Ãw_mem_buf
((*)
û¹_fe_šlše
, -1);

880 
š
 = 
	`BIO_Ãw_fe
(
û¹_fe
, "r");

883 ià(
š
 =ğ
NULL
)

885 
	`SSL”r
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_SYS_LIB
);

886 
’d
;

889 
x
 = 
	`PEM_»ad_bio_X509
(
š
, 
NULL
,

890 
	`SSL_CTX_g‘_deçuÉ_·sswd_cb
(
ùx
->ctx),

891 
	`SSL_CTX_g‘_deçuÉ_·sswd_cb_u£rd©a
(
ùx
->ctx));

892 ià(
x
 =ğ
NULL
)

894 
	`SSL”r
(
SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
, 
ERR_R_PEM_LIB
);

895 
’d
;

898 
»t
 = 
	`SSL_CTX_u£_û¹ifiÿ‹
(
ùx
->ùx, 
x
);

899 ià(
»t
)

901 
	`s_ùx_add_exŒa_û¹s
(
ùx
, 
š
);

904 
’d
:

905 ià(!
»t
)

907 ià(
šlše_fe
)

909 
	`üy±o_msg
(
M_FATAL
, "Cannot†oad inline certificate file");

913 
	`üy±o_msg
(
M_FATAL
, "CªnÙ†ßd c”tifiÿ‹ f%s", 
û¹_fe
);

917 ià(
š
 !ğ
NULL
)

919 
	`BIO_ä“
(
š
);

921 ià(
x509
)

923 *
x509
 = 
x
;

925 ià(
x
)

927 
	`X509_ä“
(
x
);

929 
	}
}

932 
	$s_ùx_lßd_û¹_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
û¹_fe
,

933 cÚ¡ *
û¹_fe_šlše
)

935 
	`s_ùx_lßd_û¹_fe_ªd_cİy
(
ùx
, 
û¹_fe
, 
û¹_fe_šlše
, 
NULL
);

936 
	}
}

939 
	$s_ùx_lßd_´iv_fe
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
´iv_key_fe
,

940 cÚ¡ *
´iv_key_fe_šlše


943 
SSL_CTX
 *
s¦_ùx
 = 
NULL
;

944 
BIO
 *
š
 = 
NULL
;

945 
EVP_PKEY
 *
pkey
 = 
NULL
;

946 
»t
 = 1;

948 
	`ASSERT
(
NULL
 !ğ
ùx
);

950 
s¦_ùx
 = 
ùx
->ctx;

952 ià(!
	`¡rcmp
(
´iv_key_fe
, 
INLINE_FILE_TAG
è&& 
´iv_key_fe_šlše
)

954 
š
 = 
	`BIO_Ãw_mem_buf
((*)
´iv_key_fe_šlše
, -1);

958 
š
 = 
	`BIO_Ãw_fe
(
´iv_key_fe
, "r");

961 ià(!
š
)

963 
’d
;

966 
pkey
 = 
	`PEM_»ad_bio_Priv©eKey
(
š
, 
NULL
,

967 
	`SSL_CTX_g‘_deçuÉ_·sswd_cb
(
ùx
->ctx),

968 
	`SSL_CTX_g‘_deçuÉ_·sswd_cb_u£rd©a
(
ùx
->ctx));

969 ià(!
pkey
)

971 
’d
;

974 ià(!
	`SSL_CTX_u£_Priv©eKey
(
s¦_ùx
, 
pkey
))

976 #ifdeà
ENABLE_MANAGEMENT


977 ià(
mªagem’t
 && (
	`ERR_GET_REASON
(
	`ERR_³ek_”rÜ
()è=ğ
EVP_R_BAD_DECRYPT
))

979 
	`mªagem’t_auth_çu»
(
mªagem’t
, 
UP_TYPE_PRIVATE_KEY
, 
NULL
);

982 
	`üy±o_msg
(
M_WARN
, "CªnÙ†ßd…riv©key f%s", 
´iv_key_fe
);

983 
’d
;

987 ià(!
	`SSL_CTX_check_´iv©e_key
(
s¦_ùx
))

989 
	`üy±o_msg
(
M_FATAL
, "Private key does‚ot matchhe certificate");

991 
»t
 = 0;

993 
’d
:

994 ià(
pkey
)

996 
	`EVP_PKEY_ä“
(
pkey
);

998 ià(
š
)

1000 
	`BIO_ä“
(
š
);

1002  
»t
;

1003 
	}
}

1006 
	$back’d_s_ùx_»lßd_ül
(
s_roÙ_ùx
 *
s¦_ùx
, cÚ¡ *
ül_fe
,

1007 cÚ¡ *
ül_šlše
)

1009 
X509_CRL
 *
ül
 = 
NULL
;

1010 
BIO
 *
š
 = 
NULL
;

1012 
X509_STORE
 *
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
s¦_ùx
->
ùx
);

1013 ià(!
¡Üe
)

1015 
	`üy±o_msg
(
M_FATAL
, "Cannot get certificate store");

1021 
	`STACK_OF
(
X509_OBJECT
è*
objs
 = 
	`X509_STORE_g‘0_objeùs
(
¡Üe
);

1022 
i
 = 0; i < 
	`sk_X509_OBJECT_num
(
objs
); i++)

1024 
X509_OBJECT
 *
obj
 = 
	`sk_X509_OBJECT_v®ue
(
objs
, 
i
);

1025 
	`ASSERT
(
obj
);

1026 ià(
	`X509_OBJECT_g‘_ty³
(
obj
è=ğ
X509_LU_CRL
)

1028 
	`sk_X509_OBJECT_d–‘e
(
objs
, 
i
);

1029 
	`X509_OBJECT_ä“
(
obj
);

1033 
	`X509_STORE_£t_æags
(
¡Üe
, 
X509_V_FLAG_CRL_CHECK
 | 
X509_V_FLAG_CRL_CHECK_ALL
);

1035 ià(!
	`¡rcmp
(
ül_fe
, 
INLINE_FILE_TAG
è&& 
ül_šlše
)

1037 
š
 = 
	`BIO_Ãw_mem_buf
((*)
ül_šlše
, -1);

1041 
š
 = 
	`BIO_Ãw_fe
(
ül_fe
, "r");

1044 ià(
š
 =ğ
NULL
)

1046 
	`msg
(
M_WARN
, "CRL: cªnÙ„—d: %s", 
ül_fe
);

1047 
’d
;

1050 
ül
 = 
	`PEM_»ad_bio_X509_CRL
(
š
, 
NULL
, NULL, NULL);

1051 ià(
ül
 =ğ
NULL
)

1053 
	`msg
(
M_WARN
, "CRL: cªnÙ„—d CRL from f%s", 
ül_fe
);

1054 
’d
;

1057 ià(!
	`X509_STORE_add_ül
(
¡Üe
, 
ül
))

1059 
	`msg
(
M_WARN
, "CRL: cªnÙ‡dd % tØ¡Üe", 
ül_fe
);

1060 
’d
;

1063 
’d
:

1064 
	`X509_CRL_ä“
(
ül
);

1065 
	`BIO_ä“
(
š
);

1066 
	}
}

1069 #ifdeà
MANAGMENT_EXTERNAL_KEY


1073 
	$r§_pub_’c
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

1075 
	`ASSERT
(0);

1077 
	}
}

1081 
	$r§_pub_dec
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

1083 
	`ASSERT
(0);

1085 
	}
}

1089 
	$r§_´iv_dec
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

1091 
	`ASSERT
(0);

1093 
	}
}

1097 
	$İ’v²_extkey_r§_fšish
(
RSA
 *
r§
)

1102 cÚ¡ 
RSA_METHOD
 *
m‘h
 = 
	`RSA_g‘_m‘hod
(
r§
);

1103 
	`RSA_m‘h_ä“
((
RSA_METHOD
 *)
m‘h
);

1105 
	}
}

1109 
	$r§_´iv_’c
(
æ’
, cÚ¡ *
äom
, *
to
, 
RSA
 *
r§
, 
·ddšg
)

1112 *
š_b64
 = 
NULL
;

1113 *
out_b64
 = 
NULL
;

1114 
»t
 = -1;

1115 
Ën
;

1117 ià(
·ddšg
 !ğ
RSA_PKCS1_PADDING
)

1119 
	`RSA”r
(
RSA_F_RSA_OSSL_PRIVATE_ENCRYPT
, 
RSA_R_UNKNOWN_PADDING_TYPE
);

1120 
dÚe
;

1124 ià(
	`İ’v²_ba£64_’code
(
äom
, 
æ’
, &
š_b64
) <= 0)

1126 
dÚe
;

1130 ià(
mªagem’t
)

1132 
out_b64
 = 
	`mªagem’t_qu”y_r§_sig
(
mªagem’t
, 
š_b64
);

1134 ià(!
out_b64
)

1136 
dÚe
;

1140 
Ën
 = 
	`RSA_size
(
r§
);

1141 
»t
 = 
	`İ’v²_ba£64_decode
(
out_b64
, 
to
, 
Ën
);

1144 ià(
»t
 !ğ
Ën
)

1146 
»t
 = -1;

1149 
dÚe
:

1150 ià(
š_b64
)

1152 
	`ä“
(
š_b64
);

1154 ià(
out_b64
)

1156 
	`ä“
(
out_b64
);

1158  
»t
;

1159 
	}
}

1162 
	$s_ùx_u£_ex‹º®_´iv©e_key
(
s_roÙ_ùx
 *
ùx
,

1163 cÚ¡ *
û¹_fe
, cÚ¡ *
û¹_fe_šlše
)

1165 
RSA
 *
r§
 = 
NULL
;

1166 
RSA
 *
pub_r§
;

1167 
RSA_METHOD
 *
r§_m‘h
;

1168 
X509
 *
û¹
 = 
NULL
;

1170 
	`ASSERT
(
NULL
 !ğ
ùx
);

1172 
	`s_ùx_lßd_û¹_fe_ªd_cİy
(
ùx
, 
û¹_fe
, 
û¹_fe_šlše
, &
û¹
);

1174 
	`ASSERT
(
NULL
 !ğ
û¹
);

1177 
r§_m‘h
 = 
	`RSA_m‘h_Ãw
("OpenVPNƒxternal…rivate key RSA Method",

1178 
RSA_METHOD_FLAG_NO_CHECK
);

1179 
	`check_m®loc_»tuº
(
r§_m‘h
);

1180 
	`RSA_m‘h_£t_pub_’c
(
r§_m‘h
, 
r§_pub_’c
);

1181 
	`RSA_m‘h_£t_pub_dec
(
r§_m‘h
, 
r§_pub_dec
);

1182 
	`RSA_m‘h_£t_´iv_’c
(
r§_m‘h
, 
r§_´iv_’c
);

1183 
	`RSA_m‘h_£t_´iv_dec
(
r§_m‘h
, 
r§_´iv_dec
);

1184 
	`RSA_m‘h_£t_š™
(
r§_m‘h
, 
NULL
);

1185 
	`RSA_m‘h_£t_fšish
(
r§_m‘h
, 
İ’v²_extkey_r§_fšish
);

1186 
	`RSA_m‘h_£t0_­p_d©a
(
r§_m‘h
, 
NULL
);

1189 
r§
 = 
	`RSA_Ãw
();

1190 ià(
r§
 =ğ
NULL
)

1192 
	`SSL”r
(
SSL_F_SSL_USE_PRIVATEKEY
, 
ERR_R_MALLOC_FAILURE
);

1193 
”r
;

1197 
EVP_PKEY
 *
pkey
 = 
	`X509_g‘0_pubkey
(
û¹
);

1198 
	`ASSERT
(
pkey
);

1199 
pub_r§
 = 
	`EVP_PKEY_g‘0_RSA
(
pkey
);

1202 ià(!
pub_r§
)

1204 
	`üy±o_msg
(
M_WARN
, "management-external-key„equires‡ RSA certificate");

1205 
”r
;

1209 cÚ¡ 
BIGNUM
 *
n
 = 
NULL
;

1210 cÚ¡ 
BIGNUM
 *
e
 = 
NULL
;

1211 
	`RSA_g‘0_key
(
pub_r§
, &
n
, &
e
, 
NULL
);

1212 
	`RSA_£t0_key
(
r§
, 
	`BN_dup
(
n
), BN_dup(
e
), 
NULL
);

1213 
	`RSA_£t_æags
(
r§
, 
	`RSA_æags
Ô§è| 
RSA_FLAG_EXT_PKEY
);

1214 ià(!
	`RSA_£t_m‘hod
(
r§
, 
r§_m‘h
))

1216 
”r
;

1220 ià(!
	`SSL_CTX_u£_RSAPriv©eKey
(
ùx
->ùx, 
r§
))

1222 
”r
;

1225 
	`X509_ä“
(
û¹
);

1226 
	`RSA_ä“
(
r§
);

1229 
”r
:

1230 ià(
û¹
)

1232 
	`X509_ä“
(
û¹
);

1234 ià(
r§
)

1236 
	`RSA_ä“
(
r§
);

1240 ià(
r§_m‘h
)

1242 
	`RSA_m‘h_ä“
(
r§_m‘h
);

1245 
	`üy±o_msg
(
M_FATAL
, "Cannotƒnable SSLƒxternal…rivate key capability");

1247 
	}
}

1252 
	$sk_x509_Çme_cmp
(cÚ¡ 
X509_NAME
 *cÚ¡ *
a
, cÚ¡ X509_NAME *cÚ¡ *
b
)

1254  
	`X509_NAME_cmp
(*
a
, *
b
);

1255 
	}
}

1258 
	$s_ùx_lßd_ÿ
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
ÿ_fe
,

1259 cÚ¡ *
ÿ_fe_šlše
,

1260 cÚ¡ *
ÿ_·th
, 
boŞ
 
s_£rv”


1263 
	`STACK_OF
(
X509_INFO
è*
šfo_¡ack
 = 
NULL
;

1264 
	`STACK_OF
(
X509_NAME
è*
û¹_Çmes
 = 
NULL
;

1265 
X509_LOOKUP
 *
lookup
 = 
NULL
;

1266 
X509_STORE
 *
¡Üe
 = 
NULL
;

1267 
X509_NAME
 *
xn
 = 
NULL
;

1268 
BIO
 *
š
 = 
NULL
;

1269 
i
, 
added
 = 0, 
´ev
 = 0;

1271 
	`ASSERT
(
NULL
 !ğ
ùx
);

1273 
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
ùx
->ctx);

1274 ià(!
¡Üe
)

1276 
	`üy±o_msg
(
M_FATAL
, "Cannot get certificate store");

1280 ià(
ÿ_fe
)

1282 ià(!
	`¡rcmp
(
ÿ_fe
, 
INLINE_FILE_TAG
è&& 
ÿ_fe_šlše
)

1284 
š
 = 
	`BIO_Ãw_mem_buf
((*)
ÿ_fe_šlše
, -1);

1288 
š
 = 
	`BIO_Ãw_fe
(
ÿ_fe
, "r");

1291 ià(
š
)

1293 
šfo_¡ack
 = 
	`PEM_X509_INFO_»ad_bio
(
š
, 
NULL
, NULL, NULL);

1296 ià(
šfo_¡ack
)

1298 
i
 = 0; i < 
	`sk_X509_INFO_num
(
šfo_¡ack
); i++)

1300 
X509_INFO
 *
šfo
 = 
	`sk_X509_INFO_v®ue
(
šfo_¡ack
, 
i
);

1301 ià(
šfo
->
ül
)

1303 
	`X509_STORE_add_ül
(
¡Üe
, 
šfo
->
ül
);

1306 ià(
s_£rv”
 && !
šfo
->
x509
)

1308 
	`üy±o_msg
(
M_FATAL
, "X509‚ame was missing in TLS mode");

1311 ià(
šfo
->
x509
)

1313 
	`X509_STORE_add_û¹
(
¡Üe
, 
šfo
->
x509
);

1314 
added
++;

1316 ià(!
s_£rv”
)

1322 ià(
û¹_Çmes
 =ğ
NULL
)

1324 
û¹_Çmes
 = 
	`sk_X509_NAME_Ãw
(
sk_x509_Çme_cmp
);

1325 ià(!
û¹_Çmes
)

1331 
xn
 = 
	`X509_g‘_subjeù_Çme
(
šfo
->
x509
);

1332 ià(!
xn
)

1338 ià(
	`sk_X509_NAME_fšd
(
û¹_Çmes
, 
xn
) == -1)

1340 
xn
 = 
	`X509_NAME_dup
(xn);

1341 ià(!
xn
)

1345 
	`sk_X509_NAME_push
(
û¹_Çmes
, 
xn
);

1349 ià(
s_£rv”
)

1351 
úum
 = 
	`sk_X509_NAME_num
(
û¹_Çmes
);

1352 ià(
úum
 !ğ(
´ev
 + 1))

1354 
	`üy±o_msg
(
M_WARN
,

1356 
	`Å
(
ÿ_fe
), 
added
);

1358 
´ev
 = 
úum
;

1362 
	`sk_X509_INFO_pİ_ä“
(
šfo_¡ack
, 
X509_INFO_ä“
);

1365 ià(
s_£rv”
)

1367 
	`SSL_CTX_£t_ş›Á_CA_li¡
(
ùx
->ùx, 
û¹_Çmes
);

1370 ià(!
added
)

1372 
	`üy±o_msg
(
M_FATAL
,

1374 
	`Å
(
ÿ_fe
));

1377 ià(
s_£rv”
)

1379 
úum
 = 
	`sk_X509_NAME_num
(
û¹_Çmes
);

1380 ià(
úum
 !ğ
added
)

1382 
	`üy±o_msg
(
M_FATAL
, "Cannot†oad CA certificate file %s (only %d "

1384 
	`Å
(
ÿ_fe
), 
úum
, 
added
);

1388 ià(
š
)

1390 
	`BIO_ä“
(
š
);

1395 ià(
ÿ_·th
)

1397 
lookup
 = 
	`X509_STORE_add_lookup
(
¡Üe
, 
	`X509_LOOKUP_hash_dœ
());

1398 ià(
lookup
 && 
	`X509_LOOKUP_add_dœ
Öookup, 
ÿ_·th
, 
X509_FILETYPE_PEM
))

1400 
	`msg
(
M_WARN
, "WARNING:ƒx³rim’ÈİtiÚ --ÿ·th %s", 
ÿ_·th
);

1404 
	`üy±o_msg
(
M_FATAL
, "CªnÙ‡dd†ooku°© --ÿ·th %s", 
ÿ_·th
);

1406 
	`X509_STORE_£t_æags
(
¡Üe
, 
X509_V_FLAG_CRL_CHECK
 | 
X509_V_FLAG_CRL_CHECK_ALL
);

1408 
	}
}

1411 
	$s_ùx_lßd_exŒa_û¹s
(
s_roÙ_ùx
 *
ùx
, cÚ¡ *
exŒa_û¹s_fe
,

1412 cÚ¡ *
exŒa_û¹s_fe_šlše


1415 
BIO
 *
š
;

1416 ià(!
	`¡rcmp
(
exŒa_û¹s_fe
, 
INLINE_FILE_TAG
è&& 
exŒa_û¹s_fe_šlše
)

1418 
š
 = 
	`BIO_Ãw_mem_buf
((*)
exŒa_û¹s_fe_šlše
, -1);

1422 
š
 = 
	`BIO_Ãw_fe
(
exŒa_û¹s_fe
, "r");

1425 ià(
š
 =ğ
NULL
)

1427 
	`üy±o_msg
(
M_FATAL
, "CªnÙ†ßdƒxŒa-û¹ fe: %s", 
exŒa_û¹s_fe
);

1431 
	`s_ùx_add_exŒa_û¹s
(
ùx
, 
š
);

1434 
	`BIO_ä“
(
š
);

1435 
	}
}

1448 #ifdeà
BIO_DEBUG


1450 #w¬nšg 
BIO_DEBUG
 
defšed


1452 
FILE
 *
	gbioå
;

1453 
boŞ
 
	gbioå_toggË
;

1454 
time_t
 
	gbioå_Ï¡_İ’
;

1455 cÚ¡ 
	gbioå_»İ’_š‹rv®
 = 600;

1458 
	$şo£_bioå
()

1460 ià(
bioå
)

1462 
	`ASSERT
(!
	`fşo£
(
bioå
));

1463 
bioå
 = 
NULL
;

1465 
	}
}

1468 
	$İ’_bioå
()

1470 cÚ¡ 
time_t
 
cu¼’t
 = 
	`time
(
NULL
);

1471 cÚ¡ 
pid_t
 
pid
 = 
	`g‘pid
();

1473 ià(
bioå_Ï¡_İ’
 + 
bioå_»İ’_š‹rv®
 < 
cu¼’t
)

1475 
	`şo£_bioå
();

1477 ià(!
bioå
)

1479 
â
[256];

1480 
	`İ’v²_¢´štf
(
â
, (â), "bio/%d-%d.log", 
pid
, 
bioå_toggË
);

1481 
bioå
 = 
	`fİ’
(
â
, "w");

1482 
	`ASSERT
(
bioå
);

1483 
bioå_Ï¡_İ’
 = 
	`time
(
NULL
);

1484 
bioå_toggË
 ^= 1;

1486 
	}
}

1489 
	$bio_debug_d©a
(cÚ¡ *
mode
, 
BIO
 *
bio
, cÚ¡ 
ušt8_t
 *
buf
, 
Ën
, cÚ¡ *
desc
)

1491 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1492 ià(
Ën
 > 0)

1494 
	`İ’_bioå
();

1495 
	`årštf
(
bioå
, "BIO_% % time=" 
time_fÜm©
 " bio=" 
±r_fÜm©
 "†en=%d data=%s\n",

1496 
mode
, 
desc
, 
	`time
(
NULL
), (
±r_ty³
)
bio
, 
Ën
, 
	`fÜm©_hex
(
buf
,†’, 0, &
gc
));

1497 
	`fæush
(
bioå
);

1499 
	`gc_ä“
(&
gc
);

1500 
	}
}

1503 
	$bio_debug_oc
(cÚ¡ *
mode
, 
BIO
 *
bio
)

1505 
	`İ’_bioå
();

1506 
	`årštf
(
bioå
, "BIO % time=" 
time_fÜm©
 " bio=" 
±r_fÜm©
 "\n",

1507 
mode
, 
	`time
(
NULL
), (
±r_ty³
)
bio
);

1508 
	`fæush
(
bioå
);

1509 
	}
}

1517 
	$bio_wr™e
(
BIO
 *
bio
, cÚ¡ 
ušt8_t
 *
d©a
, 
size
, cÚ¡ *
desc
)

1519 
i
;

1520 
»t
 = 0;

1521 
	`ASSERT
(
size
 >= 0);

1522 ià(
size
)

1530 #ifdeà
BIO_DEBUG


1531 
	`bio_debug_d©a
("wr™e", 
bio
, 
d©a
, 
size
, 
desc
);

1533 
i
 = 
	`BIO_wr™e
(
bio
, 
d©a
, 
size
);

1535 ià(
i
 < 0)

1537 ià(
	`BIO_should_»Œy
(
bio
))

1542 
	`üy±o_msg
(
D_TLS_ERRORS
, "TLS ERROR: BIO wr™% ”rÜ", 
desc
);

1543 
»t
 = -1;

1544 
	`ERR_ş—r_”rÜ
();

1547 ià(
i
 !ğ
size
)

1549 
	`üy±o_msg
(
D_TLS_ERRORS
, "TLS ERROR: BIO write %s incomplete %d/%d",

1550 
desc
, 
i
, 
size
);

1551 
»t
 = -1;

1552 
	`ERR_ş—r_”rÜ
();

1556 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "BIO wr™% %d by‹s", 
desc
, 
i
);

1557 
»t
 = 1;

1560  
»t
;

1561 
	}
}

1569 
	$bio_wr™e_po¡
(cÚ¡ 
¡©us
, 
bufãr
 *
buf
)

1571 ià(
¡©us
 == 1)

1573 
	`mem£t
(
	`BPTR
(
buf
), 0, 
	`BLEN
(buf));

1574 
buf
->
Ën
 = 0;

1576 
	}
}

1582 
	$bio_»ad
(
BIO
 *
bio
, 
bufãr
 *
buf
, 
maxËn
, cÚ¡ *
desc
)

1584 
i
;

1585 
»t
 = 0;

1586 
	`ASSERT
(
buf
->
Ën
 >= 0);

1587 ià(
buf
->
Ën
)

1592 
Ën
 = 
	`buf_fÜw¬d_ÿ·c™y
(
buf
);

1593 ià(
maxËn
 < 
Ën
)

1595 
Ën
 = 
maxËn
;

1602 
i
 = 
	`BIO_»ad
(
bio
, 
	`BPTR
(
buf
), 
Ën
);

1604 
	`VALGRIND_MAKE_READABLE
((*è&
i
, (i));

1606 #ifdeà
BIO_DEBUG


1607 
	`bio_debug_d©a
("»ad", 
bio
, 
	`BPTR
(
buf
), 
i
, 
desc
);

1609 ià(
i
 < 0)

1611 ià(
	`BIO_should_»Œy
(
bio
))

1616 
	`üy±o_msg
(
D_TLS_ERRORS
, "TLS_ERROR: BIO„—d % ”rÜ", 
desc
);

1617 
buf
->
Ën
 = 0;

1618 
»t
 = -1;

1619 
	`ERR_ş—r_”rÜ
();

1622 ià(!
i
)

1624 
buf
->
Ën
 = 0;

1628 
	`dmsg
(
D_HANDSHAKE_VERBOSE
, "BIO„—d % %d by‹s", 
desc
, 
i
);

1629 
buf
->
Ën
 = 
i
;

1630 
»t
 = 1;

1631 
	`VALGRIND_MAKE_READABLE
((*è
	`BPTR
(
buf
), 
	`BLEN
(buf));

1634  
»t
;

1635 
	}
}

1638 
	$key_¡©e_s¦_š™
(
key_¡©e_s¦
 *
ks_s¦
, cÚ¡ 
s_roÙ_ùx
 *
s¦_ùx
, 
boŞ
 
is_£rv”
, 
s_£ssiÚ
 *
£ssiÚ
)

1640 
	`ASSERT
(
NULL
 !ğ
s¦_ùx
);

1641 
	`ASSERT
(
ks_s¦
);

1642 
	`CLEAR
(*
ks_s¦
);

1644 
ks_s¦
->
s¦
 = 
	`SSL_Ãw
(
s¦_ùx
->
ùx
);

1645 ià(!
ks_s¦
->
s¦
)

1647 
	`üy±o_msg
(
M_FATAL
, "SSL_new failed");

1652 
	`SSL_£t_ex_d©a
(
ks_s¦
->
s¦
, 
myd©a_šdex
, 
£ssiÚ
);

1654 
	`ASSERT
((
ks_s¦
->
s¦_bio
 = 
	`BIO_Ãw
(
	`BIO_f_s¦
())));

1655 
	`ASSERT
((
ks_s¦
->
ù_š
 = 
	`BIO_Ãw
(
	`BIO_s_mem
())));

1656 
	`ASSERT
((
ks_s¦
->
ù_out
 = 
	`BIO_Ãw
(
	`BIO_s_mem
())));

1658 #ifdeà
BIO_DEBUG


1659 
	`bio_debug_oc
("İ’ s¦_bio", 
ks_s¦
->
s¦_bio
);

1660 
	`bio_debug_oc
("İ’ ct_š", 
ks_s¦
->
ù_š
);

1661 
	`bio_debug_oc
("İ’ ct_out", 
ks_s¦
->
ù_out
);

1664 ià(
is_£rv”
)

1666 
	`SSL_£t_acû±_¡©e
(
ks_s¦
->
s¦
);

1670 
	`SSL_£t_cÚÃù_¡©e
(
ks_s¦
->
s¦
);

1673 
	`SSL_£t_bio
(
ks_s¦
->
s¦
, ks_s¦->
ù_š
, ks_s¦->
ù_out
);

1674 
	`BIO_£t_s¦
(
ks_s¦
->
s¦_bio
, ks_s¦->
s¦
, 
BIO_NOCLOSE
);

1675 
	}
}

1678 
	$key_¡©e_s¦_ä“
(
key_¡©e_s¦
 *
ks_s¦
)

1680 ià(
ks_s¦
->
s¦
)

1682 #ifdeà
BIO_DEBUG


1683 
	`bio_debug_oc
("şo£ s¦_bio", 
ks_s¦
->
s¦_bio
);

1684 
	`bio_debug_oc
("şo£ ct_š", 
ks_s¦
->
ù_š
);

1685 
	`bio_debug_oc
("şo£ ct_out", 
ks_s¦
->
ù_out
);

1687 
	`BIO_ä“_®l
(
ks_s¦
->
s¦_bio
);

1688 
	`SSL_ä“
(
ks_s¦
->
s¦
);

1690 
	}
}

1693 
	$key_¡©e_wr™e_¶aš‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
)

1695 
»t
 = 0;

1696 
	`³rf_push
(
PERF_BIO_WRITE_PLAINTEXT
);

1698 #ifdeà
ENABLE_CRYPTO_OPENSSL


1699 
	`ASSERT
(
NULL
 !ğ
ks_s¦
);

1701 
»t
 = 
	`bio_wr™e
(
ks_s¦
->
s¦_bio
, 
	`BPTR
(
buf
), 
	`BLEN
(buf),

1703 
	`bio_wr™e_po¡
(
»t
, 
buf
);

1706 
	`³rf_pİ
();

1707  
»t
;

1708 
	}
}

1711 
	$key_¡©e_wr™e_¶aš‹xt_cÚ¡
(
key_¡©e_s¦
 *
ks_s¦
, cÚ¡ 
ušt8_t
 *
d©a
, 
Ën
)

1713 
»t
 = 0;

1714 
	`³rf_push
(
PERF_BIO_WRITE_PLAINTEXT
);

1716 
	`ASSERT
(
NULL
 !ğ
ks_s¦
);

1718 
»t
 = 
	`bio_wr™e
(
ks_s¦
->
s¦_bio
, 
d©a
, 
Ën
, "tls_write_plaintext_const");

1720 
	`³rf_pİ
();

1721  
»t
;

1722 
	}
}

1725 
	$key_¡©e_»ad_ch”‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
,

1726 
maxËn
)

1728 
»t
 = 0;

1729 
	`³rf_push
(
PERF_BIO_READ_CIPHERTEXT
);

1731 
	`ASSERT
(
NULL
 !ğ
ks_s¦
);

1733 
»t
 = 
	`bio_»ad
(
ks_s¦
->
ù_out
, 
buf
, 
maxËn
, "tls_read_ciphertext");

1735 
	`³rf_pİ
();

1736  
»t
;

1737 
	}
}

1740 
	$key_¡©e_wr™e_ch”‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
)

1742 
»t
 = 0;

1743 
	`³rf_push
(
PERF_BIO_WRITE_CIPHERTEXT
);

1745 
	`ASSERT
(
NULL
 !ğ
ks_s¦
);

1747 
»t
 = 
	`bio_wr™e
(
ks_s¦
->
ù_š
, 
	`BPTR
(
buf
), 
	`BLEN
(buf), "tls_write_ciphertext");

1748 
	`bio_wr™e_po¡
(
»t
, 
buf
);

1750 
	`³rf_pİ
();

1751  
»t
;

1752 
	}
}

1755 
	$key_¡©e_»ad_¶aš‹xt
(
key_¡©e_s¦
 *
ks_s¦
, 
bufãr
 *
buf
,

1756 
maxËn
)

1758 
»t
 = 0;

1759 
	`³rf_push
(
PERF_BIO_READ_PLAINTEXT
);

1761 
	`ASSERT
(
NULL
 !ğ
ks_s¦
);

1763 
»t
 = 
	`bio_»ad
(
ks_s¦
->
s¦_bio
, 
buf
, 
maxËn
, "tls_read_plaintext");

1765 
	`³rf_pİ
();

1766  
»t
;

1767 
	}
}

1777 
	$´št_d‘as
(
key_¡©e_s¦
 *
ks_s¦
, cÚ¡ *
´efix
)

1779 cÚ¡ 
SSL_CIPHER
 *
ch
;

1780 
X509
 *
û¹
;

1781 
s1
[256];

1782 
s2
[256];

1784 
s1
[0] = 
s2
[0] = 0;

1785 
ch
 = 
	`SSL_g‘_cu¼’t_ch”
(
ks_s¦
->
s¦
);

1786 
	`İ’v²_¢´štf
(
s1
, (s1), "%s %s, cipher %s %s",

1787 
´efix
,

1788 
	`SSL_g‘_v”siÚ
(
ks_s¦
->
s¦
),

1789 
	`SSL_CIPHER_g‘_v”siÚ
(
ch
),

1790 
	`SSL_CIPHER_g‘_Çme
(
ch
));

1791 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
ks_s¦
->
s¦
);

1792 ià(
û¹
 !ğ
NULL
)

1794 
EVP_PKEY
 *
pkey
 = 
	`X509_g‘_pubkey
(
û¹
);

1795 ià(
pkey
 !ğ
NULL
)

1797 ià((
	`EVP_PKEY_id
(
pkey
è=ğ
EVP_PKEY_RSA
è&& (
	`EVP_PKEY_g‘0_RSA
Õkeyè!ğ
NULL
))

1799 
RSA
 *
r§
 = 
	`EVP_PKEY_g‘0_RSA
(
pkey
);

1800 
	`İ’v²_¢´štf
(
s2
, (s2), ", %d bit RSA",

1801 
	`RSA_b™s
(
r§
));

1803 ià((
	`EVP_PKEY_id
(
pkey
è=ğ
EVP_PKEY_DSA
è&& (
	`EVP_PKEY_g‘0_DSA
Õkeyè!ğ
NULL
))

1805 
DSA
 *
d§
 = 
	`EVP_PKEY_g‘0_DSA
(
pkey
);

1806 
	`İ’v²_¢´štf
(
s2
, (s2), ", %d bit DSA",

1807 
	`DSA_b™s
(
d§
));

1809 #iâdeà
OPENSSL_NO_EC


1810 ià((
	`EVP_PKEY_id
(
pkey
è=ğ
EVP_PKEY_EC
è&& (
	`EVP_PKEY_g‘0_EC_KEY
Õkeyè!ğ
NULL
))

1812 
EC_KEY
 *
ec
 = 
	`EVP_PKEY_g‘0_EC_KEY
(
pkey
);

1813 cÚ¡ 
EC_GROUP
 *
group
 = 
	`EC_KEY_g‘0_group
(
ec
);

1814 cÚ¡ * 
curve
;

1816 
nid
 = 
	`EC_GROUP_g‘_curve_Çme
(
group
);

1817 ià(
nid
 =ğ0 || (
curve
 = 
	`OBJ_nid2¢
Òid)è=ğ
NULL
)

1819 
curve
 = "Error getting curve‚ame";

1822 
	`İ’v²_¢´štf
(
s2
, (s2), ", %d bit EC, curve: %s",

1823 
	`EC_GROUP_Üd”_b™s
(
group
), 
curve
);

1827 
	`EVP_PKEY_ä“
(
pkey
);

1829 
	`X509_ä“
(
û¹
);

1833 
	`msg
(
D_HANDSHAKE
, "%s%s", 
s1
, 
s2
);

1834 
	}
}

1837 
	$show_avaabË_s_ch”s_li¡
(cÚ¡ *
ch”_li¡
,

1838 cÚ¡ *
s_û¹_´ofe
,

1839 cÚ¡ 
boŞ
 
s13
)

1841 
s_roÙ_ùx
 
s_ùx
;

1843 
s_ùx
.
ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_m‘hod
());

1844 ià(!
s_ùx
.
ùx
)

1846 
	`üy±o_msg
(
M_FATAL
, "Cannot create SSL_CTX object");

1849 #ià(
OPENSSL_VERSION_NUMBER
 >= 0x1010100fL)

1850 ià(
s13
)

1852 
	`SSL_CTX_£t_mš_´Ùo_v”siÚ
(
s_ùx
.
ùx
, 
TLS1_3_VERSION
);

1853 
	`s_ùx_»¡riù_ch”s_s13
(&
s_ùx
, 
ch”_li¡
);

1858 
	`SSL_CTX_£t_max_´Ùo_v”siÚ
(
s_ùx
.
ùx
, 
TLS1_2_VERSION
);

1859 
	`s_ùx_»¡riù_ch”s
(&
s_ùx
, 
ch”_li¡
);

1862 
	`s_ùx_£t_û¹_´ofe
(&
s_ùx
, 
s_û¹_´ofe
);

1864 
SSL
 *
s¦
 = 
	`SSL_Ãw
(
s_ùx
.
ùx
);

1865 ià(!
s¦
)

1867 
	`üy±o_msg
(
M_FATAL
, "Cannot create SSL object");

1870 #ià(
OPENSSL_VERSION_NUMBER
 < 0x1010000fL)

1871 
	`STACK_OF
(
SSL_CIPHER
è*
sk
 = 
	`SSL_g‘_ch”s
(
s¦
);

1873 
	`STACK_OF
(
SSL_CIPHER
è*
sk
 = 
	`SSL_g‘1_suµÜ‹d_ch”s
(
s¦
);

1875 
i
=0;˜< 
	`sk_SSL_CIPHER_num
(
sk
);i++)

1877 cÚ¡ 
SSL_CIPHER
 *
c
 = 
	`sk_SSL_CIPHER_v®ue
(
sk
, 
i
);

1879 cÚ¡ *
ch”_Çme
 = 
	`SSL_CIPHER_g‘_Çme
(
c
);

1881 cÚ¡ 
s_ch”_Çme_·œ
 *
·œ
 =

1882 
	`s_g‘_ch”_Çme_·œ
(
ch”_Çme
, 
	`¡¾’
(cipher_name));

1884 ià(
s13
)

1886 
	`´štf
("%s\n", 
ch”_Çme
);

1888 ià(
NULL
 =ğ
·œ
)

1891 
	`´štf
("%s (No IANA‚ame knowno OpenVPN, use OpenSSL‚ame.)\n",

1892 
ch”_Çme
);

1896 
	`´štf
("%s\n", 
·œ
->
ŸÇ_Çme
);

1899 #ià(
OPENSSL_VERSION_NUMBER
 >= 0x1010000fL)

1900 
	`sk_SSL_CIPHER_ä“
(
sk
);

1902 
	`SSL_ä“
(
s¦
);

1903 
	`SSL_CTX_ä“
(
s_ùx
.
ùx
);

1904 
	}
}

1911 
	$show_avaabË_curves
()

1913 #iâdeà
OPENSSL_NO_EC


1914 
EC_butš_curve
 *
curves
 = 
NULL
;

1915 
size_t
 
üv_Ën
 = 0;

1916 
size_t
 
n
 = 0;

1918 
üv_Ën
 = 
	`EC_g‘_butš_curves
(
NULL
, 0);

1919 
	`ALLOC_ARRAY
(
curves
, 
EC_butš_curve
, 
üv_Ën
);

1920 ià(
	`EC_g‘_butš_curves
(
curves
, 
üv_Ën
))

1922 
	`´štf
("Available Elliptic curves:\n");

1923 
n
 = 0;‚ < 
üv_Ën
;‚++)

1925 cÚ¡ *
¢ame
;

1926 
¢ame
 = 
	`OBJ_nid2¢
(
curves
[
n
].
nid
);

1927 ià(
¢ame
 =ğ
NULL
)

1929 
¢ame
 = "";

1932 
	`´štf
("%s\n", 
¢ame
);

1937 
	`üy±o_msg
(
M_FATAL
, "Cannot get†ist of builtin curves");

1939 
	`ä“
(
curves
);

1941 
	`msg
(
M_WARN
, "Your OpenSSL†ibrary was built withoutƒlliptic curve support. "

1944 
	}
}

1947 
	$g‘_highe¡_´eã»nû_s_ch”
(*
buf
, 
size
)

1949 
SSL_CTX
 *
ùx
;

1950 
SSL
 *
s¦
;

1951 cÚ¡ *
ch”_Çme
;

1953 
ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_m‘hod
());

1954 ià(!
ùx
)

1956 
	`üy±o_msg
(
M_FATAL
, "Cannot create SSL_CTX object");

1958 
s¦
 = 
	`SSL_Ãw
(
ùx
);

1959 ià(!
s¦
)

1961 
	`üy±o_msg
(
M_FATAL
, "Cannot create SSL object");

1964 
ch”_Çme
 = 
	`SSL_g‘_ch”_li¡
(
s¦
, 0);

1965 
	`¡ºıyÁ
(
buf
, 
ch”_Çme
, 
size
);

1967 
	`SSL_ä“
(
s¦
);

1968 
	`SSL_CTX_ä“
(
ùx
);

1969 
	}
}

1972 
	$g‘_s¦_lib¿ry_v”siÚ
()

1974  
	`SSL—y_v”siÚ
(
SSLEAY_VERSION
);

1975 
	}
}

	@ssl_openssl.h

29 #iâdeà
SSL_OPENSSL_H_


30 
	#SSL_OPENSSL_H_


	)

32 
	~<İ’s¦/s¦.h
>

41 #iâdeà
SSL_OP_NO_TICKET


42 
	#SSL_OP_NO_TICKET
 0

	)

49 
	ss_roÙ_ùx
 {

50 
SSL_CTX
 *
	mùx
;

51 
time_t
 
	mül_Ï¡_mtime
;

52 
off_t
 
	mül_Ï¡_size
;

55 
	skey_¡©e_s¦
 {

56 
SSL
 *
	ms¦
;

57 
BIO
 *
	ms¦_bio
;

58 
BIO
 *
	mù_š
;

59 
BIO
 *
	mù_out
;

66 
myd©a_šdex
;

68 
İ’s¦_£t_myd©a_šdex
();

	@ssl_verify.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ifdeà
ENABLE_CRYPTO


39 
	~"misc.h
"

40 
	~"mªage.h
"

41 
	~"Ùime.h
"

42 
	~"ba£64.h
"

43 
	~"s¦_v”ify.h
"

44 
	~"s¦_v”ify_back’d.h
"

46 #ifdeà
ENABLE_CRYPTO_OPENSSL


47 
	~"s¦_v”ify_İ’s¦.h
"

51 
	#TLS_USERNAME_LEN
 64

	)

54 
	#X509_NAME_CHAR_CLASS
 (
CC_ALNUM
|
CC_UNDERBAR
|
CC_DASH
|
CC_DOT
|
CC_AT
|
CC_SLASH
|
CC_COLON
|
CC_EQUAL
)

	)

57 
	#COMMON_NAME_CHAR_CLASS
 (
CC_ALNUM
|
CC_UNDERBAR
|
CC_DASH
|
CC_DOT
|
CC_AT
|
CC_SLASH
)

	)

60 
	$¡ršg_mod_»m­_Çme
(*
¡r
, cÚ¡ 
»¡riùive_æags
)

62 ià(
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
)

63 && !
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NO_NAME_REMAPPING
))

65 
	`¡ršg_mod
(
¡r
, 
»¡riùive_æags
, 0, '_');

69 
	`¡ršg_mod
(
¡r
, 
CC_PRINT
, 
CC_CRLF
, '_');

71 
	}
}

77 
	$£‹nv_uÁru¡ed
(
s_£ssiÚ
 *
£ssiÚ
)

79 
	`£‹nv_lšk_sock‘_aùu®
(
£ssiÚ
->
İt
->
es
, "uÁru¡ed", &£ssiÚ->
uÁru¡ed_addr
, 
SA_IP_PORT
);

80 
	}
}

89 
	$we_auth_tok’
(
s_muÉi
 *
muÉi
)

91 if(
muÉi
)

93 ià(
muÉi
->
auth_tok’
)

95 
	`£cu»_memz”o
(
muÉi
->
auth_tok’
, 
AUTH_TOKEN_SIZE
);

96 
	`ä“
(
muÉi
->
auth_tok’
);

98 
muÉi
->
auth_tok’
 = 
NULL
;

99 
muÉi
->
auth_tok’_£Á
 = 
çl£
;

101 
	}
}

108 
	$s_d—uth’tiÿ‹
(
s_muÉi
 *
muÉi
)

110 ià(
muÉi
)

112 
	`we_auth_tok’
(
muÉi
);

113 
i
 = 0; i < 
TM_SIZE
; ++i)

115 
j
 = 0; j < 
KS_SIZE
; ++j)

117 
muÉi
->
£ssiÚ
[
i
].
key
[
j
].
auth’tiÿ‹d
 = 
çl£
;

121 
	}
}

127 
	$£t_commÚ_Çme
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ *
commÚ_Çme
)

129 ià(
£ssiÚ
->
commÚ_Çme
)

131 
	`ä“
(
£ssiÚ
->
commÚ_Çme
);

132 
£ssiÚ
->
commÚ_Çme
 = 
NULL
;

133 #ifdeà
ENABLE_PF


134 
£ssiÚ
->
commÚ_Çme_hashv®
 = 0;

137 ià(
commÚ_Çme
)

140 
£ssiÚ
->
commÚ_Çme
 = 
	`¡ršg_®loc
(commÚ_Çme, 
NULL
);

141 #ifdeà
ENABLE_PF


143 cÚ¡ 
ušt32_t
 
Ën
 = (ušt32_tè
	`¡¾’
(
commÚ_Çme
);

144 ià(
Ën
)

146 
£ssiÚ
->
commÚ_Çme_hashv®
 = 
	`hash_func
((cÚ¡ 
ušt8_t
 *)
commÚ_Çme
, 
Ën
+1, 0);

150 
£ssiÚ
->
commÚ_Çme_hashv®
 = 0;

155 
	}
}

163 
	$s_commÚ_Çme
(cÚ¡ 
s_muÉi
 *
muÉi
, cÚ¡ 
boŞ
 
nuÎ
)

165 cÚ¡ *
»t
 = 
NULL
;

166 ià(
muÉi
)

168 
»t
 = 
muÉi
->
£ssiÚ
[
TM_ACTIVE
].
commÚ_Çme
;

170 ià(
»t
 && 
	`¡¾’
(ret))

172  
»t
;

174 ià(
nuÎ
)

176  
NULL
;

182 
	}
}

188 
	$s_lock_commÚ_Çme
(
s_muÉi
 *
muÉi
)

190 cÚ¡ *
ú
 = 
muÉi
->
£ssiÚ
[
TM_ACTIVE
].
commÚ_Çme
;

191 ià(
ú
 && !
muÉi
->
locked_ú
)

193 
muÉi
->
locked_ú
 = 
	`¡ršg_®loc
(
ú
, 
NULL
);

195 
	}
}

200 
boŞ


201 
	$s_lock_u£ºame
(
s_muÉi
 *
muÉi
, cÚ¡ *
u£ºame
)

203 ià(
muÉi
->
locked_u£ºame
)

205 ià(!
u£ºame
 || 
	`¡rcmp
(u£ºame, 
muÉi
->
locked_u£ºame
))

207 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: username‡ttemptedo change from '%s'o '%s' --unnel disabled",

208 
muÉi
->
locked_u£ºame
,

209 
	`Å
(
u£ºame
));

212 
	`s_d—uth’tiÿ‹
(
muÉi
);

213  
çl£
;

218 ià(
u£ºame
)

220 
muÉi
->
locked_u£ºame
 = 
	`¡ršg_®loc
(
u£ºame
, 
NULL
);

223  
Œue
;

224 
	}
}

227 
	$s_u£ºame
(cÚ¡ 
s_muÉi
 *
muÉi
, cÚ¡ 
boŞ
 
nuÎ
)

229 cÚ¡ *
»t
 = 
NULL
;

230 ià(
muÉi
)

232 
»t
 = 
muÉi
->
locked_u£ºame
;

234 ià(
»t
 && 
	`¡¾’
(ret))

236  
»t
;

238 ià(
nuÎ
)

240  
NULL
;

246 
	}
}

249 
	$û¹_hash_»memb”
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ 
”rÜ_d•th
,

250 cÚ¡ 
bufãr
 *
û¹_hash
)

252 ià(
”rÜ_d•th
 >ğ0 &&ƒ¼Ü_d•th < 
MAX_CERT_DEPTH
)

254 ià(!
£ssiÚ
->
û¹_hash_£t
)

256 
	`ALLOC_OBJ_CLEAR
(
£ssiÚ
->
û¹_hash_£t
, cert_hash_set);

258 ià(!
£ssiÚ
->
û¹_hash_£t
->
ch
[
”rÜ_d•th
])

260 
	`ALLOC_OBJ
(
£ssiÚ
->
û¹_hash_£t
->
ch
[
”rÜ_d•th
], 
û¹_hash
);

263 
û¹_hash
 *
ch
 = 
£ssiÚ
->
û¹_hash_£t
->ch[
”rÜ_d•th
];

264 
	`ASSERT
((
ch
->
sha256_hash
è=ğ
	`BLEN
(
û¹_hash
));

265 
	`memıy
(
ch
->
sha256_hash
, 
	`BPTR
(
û¹_hash
), (ch->sha256_hash));

267 
	}
}

270 
	$û¹_hash_ä“
(
û¹_hash_£t
 *
chs
)

272 ià(
chs
)

274 
i
;

275 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

277 
	`ä“
(
chs
->
ch
[
i
]);

279 
	`ä“
(
chs
);

281 
	}
}

283 
boŞ


284 
	$û¹_hash_com·»
(cÚ¡ 
û¹_hash_£t
 *
chs1
, cÚ¡ û¹_hash_£ˆ*
chs2
)

286 ià(
chs1
 && 
chs2
)

288 
i
;

289 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

291 cÚ¡ 
û¹_hash
 *
ch1
 = 
chs1
->
ch
[
i
];

292 cÚ¡ 
û¹_hash
 *
ch2
 = 
chs2
->
ch
[
i
];

294 ià(!
ch1
 && !
ch2
)

298 ià(
ch1
 && 
ch2
 && !
	`memcmp
(ch1->
sha256_hash
, ch2->sha256_hash,

299 (
ch1
->
sha256_hash
)))

305  
çl£
;

308  
Œue
;

310 ià(!
chs1
 && !
chs2
)

312  
Œue
;

316  
çl£
;

318 
	}
}

320 
û¹_hash_£t
 *

321 
	$û¹_hash_cİy
(cÚ¡ 
û¹_hash_£t
 *
chs
)

323 
û¹_hash_£t
 *
de¡
 = 
NULL
;

324 ià(
chs
)

326 
i
;

327 
	`ALLOC_OBJ_CLEAR
(
de¡
, 
û¹_hash_£t
);

328 
i
 = 0; i < 
MAX_CERT_DEPTH
; ++i)

330 cÚ¡ 
û¹_hash
 *
ch
 = 
chs
->ch[
i
];

331 ià(
ch
)

333 
	`ALLOC_OBJ
(
de¡
->
ch
[
i
], 
û¹_hash
);

334 
	`memıy
(
de¡
->
ch
[
i
]->
sha256_hash
, ch->sha256_hash,

335 (
de¡
->
ch
[
i
]->
sha256_hash
));

339  
de¡
;

340 
	}
}

342 
	$s_lock_û¹_hash_£t
(
s_muÉi
 *
muÉi
)

344 cÚ¡ 
û¹_hash_£t
 *
chs
 = 
muÉi
->
£ssiÚ
[
TM_ACTIVE
].cert_hash_set;

345 ià(
chs
 && !
muÉi
->
locked_û¹_hash_£t
)

347 
muÉi
->
locked_û¹_hash_£t
 = 
	`û¹_hash_cİy
(
chs
);

349 
	}
}

355 
	$´št_nsC”tTy³
(
ty³
)

357 
ty³
)

359 
NS_CERT_CHECK_SERVER
:

362 
NS_CERT_CHECK_CLIENT
:

368 
	}
}

378 
»suÉ_t


379 
	$v”ify_³”_û¹
(cÚ¡ 
s_İtiÚs
 *
İt
, 
İ’v²_x509_û¹_t
 *
³”_û¹
,

380 cÚ¡ *
subjeù
, cÚ¡ *
commÚ_Çme
)

383 ià(
İt
->
ns_û¹_ty³
 !ğ
NS_CERT_CHECK_NONE
)

385 ià(
SUCCESS
 =ğ
	`x509_v”ify_ns_û¹_ty³
(
³”_û¹
, 
İt
->
ns_û¹_ty³
))

387 
	`msg
(
D_HANDSHAKE
, "VERIFY OK:‚sCertType=%s",

388 
	`´št_nsC”tTy³
(
İt
->
ns_û¹_ty³
));

392 
	`msg
(
D_HANDSHAKE
, "VERIFY‚sCertType ERROR: %s,„equire‚sCertType=%s",

393 
subjeù
, 
	`´št_nsC”tTy³
(
İt
->
ns_û¹_ty³
));

394  
FAILURE
;

399 ià(
İt
->
»mÙe_û¹_ku
[0] != 0)

401 ià(
SUCCESS
 =ğ
	`x509_v”ify_û¹_ku
(
³”_û¹
, 
İt
->
»mÙe_û¹_ku
, 
MAX_PARMS
))

403 
	`msg
(
D_HANDSHAKE
, "VERIFY KU OK");

407 
	`msg
(
D_HANDSHAKE
, "VERIFY KU ERROR");

408  
FAILURE
;

413 ià(
İt
->
»mÙe_û¹_eku
 !ğ
NULL
)

415 ià(
SUCCESS
 =ğ
	`x509_v”ify_û¹_eku
(
³”_û¹
, 
İt
->
»mÙe_û¹_eku
))

417 
	`msg
(
D_HANDSHAKE
, "VERIFY EKU OK");

421 
	`msg
(
D_HANDSHAKE
, "VERIFY EKU ERROR");

422  
FAILURE
;

427 ià(
İt
->
v”ify_x509_ty³
 !ğ
VERIFY_X509_NONE
)

429 iàĞ(
İt
->
v”ify_x509_ty³
 =ğ
VERIFY_X509_SUBJECT_DN


430 && 
	`¡rcmp
(
İt
->
v”ify_x509_Çme
, 
subjeù
) == 0)

431 || (
İt
->
v”ify_x509_ty³
 =ğ
VERIFY_X509_SUBJECT_RDN


432 && 
	`¡rcmp
(
İt
->
v”ify_x509_Çme
, 
commÚ_Çme
) == 0)

433 || (
İt
->
v”ify_x509_ty³
 =ğ
VERIFY_X509_SUBJECT_RDN_PREFIX


434 && 
	`¡ºcmp
(
İt
->
v”ify_x509_Çme
, 
commÚ_Çme
,

435 
	`¡¾’
(
İt
->
v”ify_x509_Çme
)) == 0) )

437 
	`msg
(
D_HANDSHAKE
, "VERIFY X509NAME OK: %s", 
subjeù
);

441 
	`msg
(
D_HANDSHAKE
, "VERIFY X509NAME ERROR: %s, must be %s",

442 
subjeù
, 
İt
->
v”ify_x509_Çme
);

443  
FAILURE
;

447  
SUCCESS
;

448 
	}
}

455 
	$v”ify_û¹_£t_’v
(
’v_£t
 *
es
, 
İ’v²_x509_û¹_t
 *
³”_û¹
, 
û¹_d•th
,

456 cÚ¡ *
subjeù
, cÚ¡ *
commÚ_Çme
,

457 cÚ¡ 
x509_Œack
 *x509_track)

459 
’vÇme
[64];

460 *
£rŸl
 = 
NULL
;

461 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

464 ià(
x509_Œack
)

466 
	`x509_£‹nv_Œack
(
x509_Œack
, 
es
, 
û¹_d•th
, 
³”_û¹
);

470 
	`x509_£‹nv
(
es
, 
û¹_d•th
, 
³”_û¹
);

474 
	`İ’v²_¢´štf
(
’vÇme
, ÓnvÇme), "s_id_%d", 
û¹_d•th
);

475 
	`£‹nv_¡r
(
es
, 
’vÇme
, 
subjeù
);

479 
	`İ’v²_¢´štf
(
’vÇme
, ÓnvÇme), "s_commÚ_Çme_%d", 
û¹_d•th
);

480 
	`£‹nv_¡r
(
es
, 
’vÇme
, 
commÚ_Çme
);

485 
bufãr
 
sha1
 = 
	`x509_g‘_sha1_fšg”´št
(
³”_û¹
, &
gc
);

486 
bufãr
 
sha256
 = 
	`x509_g‘_sha256_fšg”´št
(
³”_û¹
, &
gc
);

488 
	`İ’v²_¢´štf
(
’vÇme
, ÓnvÇme), "s_dige¡_%d", 
û¹_d•th
);

489 
	`£‹nv_¡r
(
es
, 
’vÇme
,

490 
	`fÜm©_hex_ex
(
	`BPTR
(&
sha1
), 
	`BLEN
(&sha1), 0, 1, ":", &
gc
));

492 
	`İ’v²_¢´štf
(
’vÇme
, (envname), "tls_digest_sha256_%d",

493 
û¹_d•th
);

494 
	`£‹nv_¡r
(
es
, 
’vÇme
,

495 
	`fÜm©_hex_ex
(
	`BPTR
(&
sha256
), 
	`BLEN
(&sha256), 0, 1, ":", &
gc
));

499 
£rŸl
 = 
	`back’d_x509_g‘_£rŸl
(
³”_û¹
, &
gc
);

500 
	`İ’v²_¢´štf
(
’vÇme
, ÓnvÇme), "s_£rŸl_%d", 
û¹_d•th
);

501 
	`£‹nv_¡r
(
es
, 
’vÇme
, 
£rŸl
);

504 
£rŸl
 = 
	`back’d_x509_g‘_£rŸl_hex
(
³”_û¹
, &
gc
);

505 
	`İ’v²_¢´štf
(
’vÇme
, ÓnvÇme), "s_£rŸl_hex_%d", 
û¹_d•th
);

506 
	`£‹nv_¡r
(
es
, 
’vÇme
, 
£rŸl
);

508 
	`gc_ä“
(&
gc
);

509 
	}
}

514 
»suÉ_t


515 
	$v”ify_û¹_ÿÎ_¶ugš
(cÚ¡ 
¶ugš_li¡
 *
¶ugšs
, 
’v_£t
 *
es
,

516 
û¹_d•th
, 
İ’v²_x509_û¹_t
 *
û¹
, *
subjeù
)

518 ià(
	`¶ugš_defšed
(
¶ugšs
, 
OPENVPN_PLUGIN_TLS_VERIFY
))

520 
»t
;

521 
¬gv
‡rgv = 
	`¬gv_Ãw
();

523 
	`¬gv_´štf
(&
¬gv
, "%d %s", 
û¹_d•th
, 
subjeù
);

525 
»t
 = 
	`¶ugš_ÿÎ_s¦
(
¶ugšs
, 
OPENVPN_PLUGIN_TLS_VERIFY
, &
¬gv
, 
NULL
, 
es
, 
û¹_d•th
, 
û¹
);

527 
	`¬gv_»£t
(&
¬gv
);

529 ià(
»t
 =ğ
OPENVPN_PLUGIN_FUNC_SUCCESS
)

531 
	`msg
(
D_HANDSHAKE
, "VERIFY PLUGIN OK: depth=%d, %s",

532 
û¹_d•th
, 
subjeù
);

536 
	`msg
(
D_HANDSHAKE
, "VERIFY PLUGIN ERROR: depth=%d, %s",

537 
û¹_d•th
, 
subjeù
);

538  
FAILURE
;

541  
SUCCESS
;

542 
	}
}

545 
	$v”ify_û¹_expÜt_û¹
(
İ’v²_x509_û¹_t
 *
³”û¹
, cÚ¡ *
tmp_dœ
, 
gc_¬’a
 *
gc
)

547 
FILE
 *
³”û¹_fe
;

548 cÚ¡ *
³”û¹_f’ame
 = "";

551 ià(!
tmp_dœ


552 || !(
³”û¹_f’ame
 = 
	`ü—‹_‹mp_fe
(
tmp_dœ
, "pcf", 
gc
)))

554 
	`msg
 (
M_WARN
, "Failedo create…eer cert file");

555  
NULL
;

559 
³”û¹_fe
 = 
	`fİ’
(
³”û¹_f’ame
, "w+");

560 ià(!
³”û¹_fe
)

562 
	`msg
(
M_ERR
, "FaedØİ’empÜ¬y f: %s", 
³”û¹_f’ame
);

563  
NULL
;

566 ià(
SUCCESS
 !ğ
	`x509_wr™e_³m
(
³”û¹_fe
, 
³”û¹
))

568 
	`msg
(
M_ERR
, "Error writing PEM file containing certificate");

571 
	`fşo£
(
³”û¹_fe
);

572  
³”û¹_f’ame
;

573 
	}
}

579 
»suÉ_t


580 
	$v”ify_û¹_ÿÎ_commªd
(cÚ¡ *
v”ify_commªd
, 
’v_£t
 *
es
,

581 
û¹_d•th
, 
İ’v²_x509_û¹_t
 *
û¹
, *
subjeù
, cÚ¡ *
v”ify_expÜt_û¹
)

583 cÚ¡ *
tmp_fe
 = 
NULL
;

584 
»t
;

585 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

586 
¬gv
‡rgv = 
	`¬gv_Ãw
();

588 
	`£‹nv_¡r
(
es
, "script_type", "tls-verify");

590 ià(
v”ify_expÜt_û¹
)

592 
tmp_fe
 = 
	`v”ify_û¹_expÜt_û¹
(
û¹
, 
v”ify_expÜt_û¹
, &
gc
);

593 ià(!
tmp_fe
)

595 
»t
 = 
çl£
;

596 
ş—nup
;

598 
	`£‹nv_¡r
(
es
, "³”_û¹", 
tmp_fe
);

601 
	`¬gv_·r£_cmd
(&
¬gv
, 
v”ify_commªd
);

602 
	`¬gv_´štf_ÿt
(&
¬gv
, "%d %s", 
û¹_d•th
, 
subjeù
);

604 
	`¬gv_msg_´efix
(
D_TLS_DEBUG
, &
¬gv
, "TLS:ƒxecuting verify command");

605 
»t
 = 
	`İ’v²_run_süt
(&
¬gv
, 
es
, 0, "--tls-verify script");

607 ià(
v”ify_expÜt_û¹
)

609 ià(
tmp_fe
)

611 
	`¶©fÜm_uÆšk
(
tmp_fe
);

615 
ş—nup
:

616 
	`gc_ä“
(&
gc
);

617 
	`¬gv_»£t
(&
¬gv
);

619 ià(
»t
)

621 
	`msg
(
D_HANDSHAKE
, "VERIFY SCRIPT OK: depth=%d, %s",

622 
û¹_d•th
, 
subjeù
);

623  
SUCCESS
;

626 
	`msg
(
D_HANDSHAKE
, "VERIFY SCRIPT ERROR: depth=%d, %s",

627 
û¹_d•th
, 
subjeù
);

628  
FAILURE
;

629 
	}
}

634 
»suÉ_t


635 
	$v”ify_check_ül_dœ
(cÚ¡ *
ül_dœ
, 
İ’v²_x509_û¹_t
 *
û¹
)

637 
»suÉ_t
 
»t
 = 
FAILURE
;

638 
â
[256];

639 
fd
 = -1;

640 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

642 *
£rŸl
 = 
	`back’d_x509_g‘_£rŸl
(
û¹
, &
gc
);

644 ià(!
	`İ’v²_¢´štf
(
â
, (â), "%s%c%s", 
ül_dœ
, 
OS_SPECIFIC_DIRSEP
, 
£rŸl
))

646 
	`msg
(
D_HANDSHAKE
, "VERIFY CRL: filename overflow");

647 
ş—nup
;

649 
fd
 = 
	`¶©fÜm_İ’
(
â
, 
O_RDONLY
, 0);

650 ià(
fd
 >= 0)

652 
	`msg
(
D_HANDSHAKE
, "VERIFY CRL: c”tifiÿ‹ s”ŸÈnumb” % i »voked", 
£rŸl
);

653 
ş—nup
;

656 
»t
 = 
SUCCESS
;

658 
ş—nup
:

660 ià(
fd
 != -1)

662 
	`şo£
(
fd
);

664 
	`gc_ä“
(&
gc
);

665  
»t
;

666 
	}
}

668 
»suÉ_t


669 
	$v”ify_û¹
(
s_£ssiÚ
 *
£ssiÚ
, 
İ’v²_x509_û¹_t
 *
û¹
, 
û¹_d•th
)

671 
»suÉ_t
 
»t
 = 
FAILURE
;

672 *
subjeù
 = 
NULL
;

673 
commÚ_Çme
[
TLS_USERNAME_LEN
+1] = {0};

674 cÚ¡ 
s_İtiÚs
 *
İt
;

675 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

677 
İt
 = 
£ssiÚ
->opt;

678 
	`ASSERT
(
İt
);

680 
£ssiÚ
->
v”if›d
 = 
çl£
;

683 
subjeù
 = 
	`x509_g‘_subjeù
(
û¹
, &
gc
);

684 ià(!
subjeù
)

686 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d, could‚otƒxtract X509 "

687 "subjeù sŒšg from c”tifiÿ‹", 
û¹_d•th
);

688 
ş—nup
;

692 
	`¡ršg_mod_»m­_Çme
(
subjeù
, 
X509_NAME_CHAR_CLASS
);

693 
	`¡ršg_»¶aû_Ëadšg
(
subjeù
, '-', '_');

696 ià(
SUCCESS
 !ğ
	`back’d_x509_g‘_u£ºame
(
commÚ_Çme
, (common_name),

697 
İt
->
x509_u£ºame_f›ld
, 
û¹
))

699 ià(!
û¹_d•th
)

701 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: could‚otƒxtract %s from X509 "

704 
İt
->
x509_u£ºame_f›ld
,

705 
subjeù
,

706 
TLS_USERNAME_LEN
);

707 
ş—nup
;

712 
	`¡ršg_mod_»m­_Çme
(
commÚ_Çme
, 
COMMON_NAME_CHAR_CLASS
);

715 ià(
û¹_d•th
 >ğ
MAX_CERT_DEPTH
)

717 
	`msg
(
D_TLS_ERRORS
, "TLS E¼Ü: CÚvŞu‹d c”tifiÿ‹ chaš d‘eùed w™h d•th [%d] g»©”hª %d", 
û¹_d•th
, 
MAX_CERT_DEPTH
);

718 
ş—nup
;

722 ià(
û¹_d•th
 =ğ1 && 
İt
->
v”ify_hash
)

724 
bufãr
 
ÿ_hash
 = {0};

726 
İt
->
v”ify_hash_®go
)

728 
MD_SHA1
:

729 
ÿ_hash
 = 
	`x509_g‘_sha1_fšg”´št
(
û¹
, &
gc
);

732 
MD_SHA256
:

733 
ÿ_hash
 = 
	`x509_g‘_sha256_fšg”´št
(
û¹
, &
gc
);

742 
	`msg
(
M_WARN
, "Unexpected invalid‡lgorithm used with "

743 "--v”ify-hash (%i)", 
İt
->
v”ify_hash_®go
);

744 
»t
 = 
FAILURE
;

745 
ş—nup
;

748 ià(
	`memcmp
(
	`BPTR
(&
ÿ_hash
), 
İt
->
v”ify_hash
, 
	`BLEN
(&ca_hash)))

750 
	`msg
(
D_TLS_ERRORS
, "TLS Error:†evel-1 certificate hash verification failed");

751 
ş—nup
;

756 ià(
û¹_d•th
 == 0)

758 
	`£t_commÚ_Çme
(
£ssiÚ
, 
commÚ_Çme
);

761 
£ssiÚ
->
v”ify_maxËv–
 = 
	`max_št
(£ssiÚ->v”ify_maxËv–, 
û¹_d•th
);

764 
	`v”ify_û¹_£t_’v
(
İt
->
es
, 
û¹
, 
û¹_d•th
, 
subjeù
, 
commÚ_Çme
,

765 
İt
->
x509_Œack
);

768 
	`£‹nv_uÁru¡ed
(
£ssiÚ
);

771 ià(
û¹_d•th
 =ğ0 && 
SUCCESS
 !ğ
	`v”ify_³”_û¹
(
İt
, 
û¹
, 
subjeù
, 
commÚ_Çme
))

773 
ş—nup
;

777 ià(
SUCCESS
 !ğ
	`v”ify_û¹_ÿÎ_¶ugš
(
İt
->
¶ugšs
, o±->
es
, 
û¹_d•th
, 
û¹
, 
subjeù
))

779 
ş—nup
;

783 ià(
İt
->
v”ify_commªd
 && 
SUCCESS
 !ğ
	`v”ify_û¹_ÿÎ_commªd
(opt->verify_command,

784 
İt
->
es
, 
û¹_d•th
, 
û¹
, 
subjeù
, o±->
v”ify_expÜt_û¹
))

786 
ş—nup
;

790 ià(
İt
->
ül_fe
)

792 ià(
İt
->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
)

794 ià(
SUCCESS
 !ğ
	`v”ify_check_ül_dœ
(
İt
->
ül_fe
, 
û¹
))

796 
ş—nup
;

801 ià(
	`s_v”ify_ül_missšg
(
İt
))

803 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: CRL‚ot†oaded");

804 
ş—nup
;

809 
	`msg
(
D_HANDSHAKE
, "VERIFY OK: d•th=%d, %s", 
û¹_d•th
, 
subjeù
);

810 
£ssiÚ
->
v”if›d
 = 
Œue
;

811 
»t
 = 
SUCCESS
;

813 
ş—nup
:

815 ià(
»t
 !ğ
SUCCESS
)

817 
	`s_ş—r_”rÜ
();

818 
£ssiÚ
->
v”if›d
 = 
çl£
;

820 
	`gc_ä“
(&
gc
);

822  
»t
;

823 
	}
}

830 #ifdeà
ENABLE_DEF_AUTH


833 
	#ACF_UNDEFINED
 0

	)

834 
	#ACF_SUCCEEDED
 1

	)

835 
	#ACF_DISABLED
 2

	)

836 
	#ACF_FAILED
 3

	)

839 #ifdeà
MANAGEMENT_DEF_AUTH


841 
	$mª_def_auth_£t_ş›Á_»asÚ
(
s_muÉi
 *
muÉi
, cÚ¡ *
ş›Á_»asÚ
)

843 ià(
muÉi
->
ş›Á_»asÚ
)

845 
	`ä“
(
muÉi
->
ş›Á_»asÚ
);

846 
muÉi
->
ş›Á_»asÚ
 = 
NULL
;

848 ià(
ş›Á_»asÚ
 && 
	`¡¾’
(client_reason))

851 
muÉi
->
ş›Á_»asÚ
 = 
	`¡ršg_®loc
(ş›Á_»asÚ, 
NULL
);

853 
	}
}

855 
šlše
 

856 
	$mª_def_auth_‹¡
(cÚ¡ 
key_¡©e
 *
ks
)

858 ià(
	`mªagem’t_’abË_def_auth
(
mªagem’t
))

860  
ks
->
mda_¡©us
;

864  
ACF_DISABLED
;

866 
	}
}

869 #ifdeà
PLUGIN_DEF_AUTH


876 
	$key_¡©e_rm_auth_cÚŒŞ_fe
(
key_¡©e
 *
ks
)

878 ià(
ks
 && ks->
auth_cÚŒŞ_fe
)

880 
	`¶©fÜm_uÆšk
(
ks
->
auth_cÚŒŞ_fe
);

881 
	`ä“
(
ks
->
auth_cÚŒŞ_fe
);

882 
ks
->
auth_cÚŒŞ_fe
 = 
NULL
;

884 
	}
}

886 
boŞ


887 
	$key_¡©e_g’_auth_cÚŒŞ_fe
(
key_¡©e
 *
ks
, cÚ¡ 
s_İtiÚs
 *
İt
)

889 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

891 
	`key_¡©e_rm_auth_cÚŒŞ_fe
(
ks
);

892 cÚ¡ *
acf
 = 
	`ü—‹_‹mp_fe
(
İt
->
tmp_dœ
, "acf", &
gc
);

893 ià(
acf
)

895 
ks
->
auth_cÚŒŞ_fe
 = 
	`¡ršg_®loc
(
acf
, 
NULL
);

896 
	`£‹nv_¡r
(
İt
->
es
, "auth_cÚŒŞ_fe", 
ks
->
auth_cÚŒŞ_fe
);

899 
	`gc_ä“
(&
gc
);

900  
acf
;

901 
	}
}

904 
	$key_¡©e_‹¡_auth_cÚŒŞ_fe
(
key_¡©e
 *
ks
)

906 ià(
ks
 && ks->
auth_cÚŒŞ_fe
)

908 
»t
 = 
ks
->
auth_cÚŒŞ_¡©us
;

909 ià(
»t
 =ğ
ACF_UNDEFINED
)

911 
FILE
 *
å
 = 
	`fİ’
(
ks
->
auth_cÚŒŞ_fe
, "r");

912 ià(
å
)

914 cÚ¡ 
c
 = 
	`fg‘c
(
å
);

915 ià(
c
 == '1')

917 
»t
 = 
ACF_SUCCEEDED
;

919 ià(
c
 == '0')

921 
»t
 = 
ACF_FAILED
;

923 
	`fşo£
(
å
);

924 
ks
->
auth_cÚŒŞ_¡©us
 = 
»t
;

927  
»t
;

929  
ACF_DISABLED
;

930 
	}
}

940 
	$s_auth’tiÿtiÚ_¡©us
(
s_muÉi
 *
muÉi
, cÚ¡ 
Ï‹ncy
)

942 
boŞ
 
deã¼ed
 = 
çl£
;

943 
boŞ
 
sucûss
 = 
çl£
;

944 
boŞ
 
aùive
 = 
çl£
;

946 #ifdeà
ENABLE_DEF_AUTH


947 cÚ¡ 
acf_m”ge
[] =

949 
ACF_UNDEFINED
,

950 
ACF_UNDEFINED
,

951 
ACF_UNDEFINED
,

952 
ACF_FAILED
,

953 
ACF_UNDEFINED
,

954 
ACF_SUCCEEDED
,

955 
ACF_SUCCEEDED
,

956 
ACF_FAILED
,

957 
ACF_UNDEFINED
,

958 
ACF_SUCCEEDED
,

959 
ACF_DISABLED
,

960 
ACF_FAILED
,

961 
ACF_FAILED
,

962 
ACF_FAILED
,

963 
ACF_FAILED
,

964 
ACF_FAILED


968 ià(
muÉi
)

970 
i
;

972 #ifdeà
ENABLE_DEF_AUTH


973 ià(
Ï‹ncy
 && 
muÉi
->
s_Ï¡
 && muÉi->s_Ï¡ +†©’cy >ğ
now
)

975  
TLS_AUTHENTICATION_UNDEFINED
;

977 
muÉi
->
s_Ï¡
 = 
now
;

980 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

982 
key_¡©e
 *
ks
 = 
muÉi
->
key_sÿn
[
i
];

983 ià(
	`DECRYPT_KEY_ENABLED
(
muÉi
, 
ks
))

985 
aùive
 = 
Œue
;

986 ià(
ks
->
auth’tiÿ‹d
)

988 #ifdeà
ENABLE_DEF_AUTH


989 
s1
 = 
ACF_DISABLED
;

990 
s2
 = 
ACF_DISABLED
;

991 #ifdeà
PLUGIN_DEF_AUTH


992 
s1
 = 
	`key_¡©e_‹¡_auth_cÚŒŞ_fe
(
ks
);

994 #ifdeà
MANAGEMENT_DEF_AUTH


995 
s2
 = 
	`mª_def_auth_‹¡
(
ks
);

997 
	`ASSERT
(
s1
 < 4 && 
s2
 < 4);

998 
acf_m”ge
[(
s1
<<2è+ 
s2
])

1000 
ACF_SUCCEEDED
:

1001 
ACF_DISABLED
:

1002 
sucûss
 = 
Œue
;

1003 
ks
->
auth_deã¼ed
 = 
çl£
;

1006 
ACF_UNDEFINED
:

1007 ià(
now
 < 
ks
->
auth_deã¼ed_expœe
)

1009 
deã¼ed
 = 
Œue
;

1013 
ACF_FAILED
:

1014 
ks
->
auth’tiÿ‹d
 = 
çl£
;

1018 
	`ASSERT
(0);

1021 
sucûss
 = 
Œue
;

1029 
	`dmsg
(
D_TLS_ERRORS
, "TAS:‡=%d s=%d d=%d", 
aùive
, 
sucûss
, 
deã¼ed
);

1032 ià(
sucûss
)

1034  
TLS_AUTHENTICATION_SUCCEEDED
;

1036 ià(!
aùive
 || 
deã¼ed
)

1038  
TLS_AUTHENTICATION_DEFERRED
;

1042  
TLS_AUTHENTICATION_FAILED
;

1044 
	}
}

1046 #ifdeà
MANAGEMENT_DEF_AUTH


1051 
boŞ


1052 
	$s_auth’tiÿ‹_key
(
s_muÉi
 *
muÉi
, cÚ¡ 
mda_key_id
, cÚ¡ 
boŞ
 
auth
, cÚ¡ *
ş›Á_»asÚ
)

1054 
boŞ
 
»t
 = 
çl£
;

1055 ià(
muÉi
)

1057 
i
;

1058 
	`mª_def_auth_£t_ş›Á_»asÚ
(
muÉi
, 
ş›Á_»asÚ
);

1059 
i
 = 0; i < 
KEY_SCAN_SIZE
; ++i)

1061 
key_¡©e
 *
ks
 = 
muÉi
->
key_sÿn
[
i
];

1062 ià(
ks
->
mda_key_id
 == mda_key_id)

1064 
ks
->
mda_¡©us
 = 
auth
 ? 
ACF_SUCCEEDED
 : 
ACF_FAILED
;

1065 
»t
 = 
Œue
;

1069  
»t
;

1070 
	}
}

1087 
boŞ


1088 
	$v”ify_u£r_·ss_süt
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ 
u£r_·ss
 *
up
)

1090 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1091 
¬gv
‡rgv = 
	`¬gv_Ãw
();

1092 cÚ¡ *
tmp_fe
 = "";

1093 
boŞ
 
»t
 = 
çl£
;

1096 ià((
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
è|| 
	`¡¾’
(
up
->
u£ºame
))

1099 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "script_type", "user-pass-verify");

1101 ià(
£ssiÚ
->
İt
->
auth_u£r_·ss_v”ify_süt_vŸ_fe
)

1103 
¡©us_ouut
 *
so
;

1105 
tmp_fe
 = 
	`ü—‹_‹mp_fe
(
£ssiÚ
->
İt
->
tmp_dœ
, "up", &
gc
);

1106 ià(
tmp_fe
)

1108 
so
 = 
	`¡©us_İ’
(
tmp_fe
, 0, -1, 
NULL
, 
STATUS_OUTPUT_WRITE
);

1109 
	`¡©us_´štf
(
so
, "%s", 
up
->
u£ºame
);

1110 
	`¡©us_´štf
(
so
, "%s", 
up
->
·sswÜd
);

1111 ià(!
	`¡©us_şo£
(
so
))

1113 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: could‚ot write username/passwordo file: %s",

1114 
tmp_fe
);

1115 
dÚe
;

1120 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: could‚ot create write "

1126 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "u£ºame", 
up
->
u£ºame
);

1127 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "·sswÜd", 
up
->
·sswÜd
);

1131 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "commÚ_Çme", sessiÚ->
commÚ_Çme
);

1134 
	`£‹nv_uÁru¡ed
(
£ssiÚ
);

1137 
	`¬gv_·r£_cmd
(&
¬gv
, 
£ssiÚ
->
İt
->
auth_u£r_·ss_v”ify_süt
);

1138 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", 
tmp_fe
);

1141 
»t
 = 
	`İ’v²_run_süt
(&
¬gv
, 
£ssiÚ
->
İt
->
es
, 0,

1144 ià(!
£ssiÚ
->
İt
->
auth_u£r_·ss_v”ify_süt_vŸ_fe
)

1146 
	`£‹nv_d–
(
£ssiÚ
->
İt
->
es
, "password");

1151 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error:…eer…rovided‡ blank username");

1154 
dÚe
:

1155 ià(
tmp_fe
 && 
	`¡¾’
(tmp_file) > 0)

1157 
	`¶©fÜm_uÆšk
(
tmp_fe
);

1160 
	`¬gv_»£t
(&
¬gv
);

1161 
	`gc_ä“
(&
gc
);

1162  
»t
;

1163 
	}
}

1169 
	$v”ify_u£r_·ss_¶ugš
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ 
u£r_·ss
 *
up
, cÚ¡ *
¿w_u£ºame
)

1171 
»tv®
 = 
OPENVPN_PLUGIN_FUNC_ERROR
;

1172 #ifdeà
PLUGIN_DEF_AUTH


1173 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

1177 ià((
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
è|| 
	`¡¾’
(
up
->
u£ºame
))

1180 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "u£ºame", (
¿w_u£ºame
 ?„aw_u£ºam: 
up
->
u£ºame
));

1181 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "·sswÜd", 
up
->
·sswÜd
);

1184 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "commÚ_Çme", sessiÚ->
commÚ_Çme
);

1187 
	`£‹nv_uÁru¡ed
(
£ssiÚ
);

1189 #ifdeà
PLUGIN_DEF_AUTH


1191 ià(!
	`key_¡©e_g’_auth_cÚŒŞ_fe
(
ks
, 
£ssiÚ
->
İt
))

1193 
	`msg
 (
D_TLS_ERRORS
, "TLS Auth Error (%s): "

1194 "could‚Ù c»©deã¼ed‡uth cÚŒŞ fe", 
__func__
);

1195 
ş—nup
;

1200 
»tv®
 = 
	`¶ugš_ÿÎ
(
£ssiÚ
->
İt
->
¶ugšs
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
, 
NULL
, NULL, sessiÚ->İt->
es
);

1202 #ifdeà
PLUGIN_DEF_AUTH


1204 ià(
»tv®
 !ğ
OPENVPN_PLUGIN_FUNC_DEFERRED
)

1206 
	`key_¡©e_rm_auth_cÚŒŞ_fe
(
ks
);

1210 
	`£‹nv_d–
(
£ssiÚ
->
İt
->
es
, "password");

1211 ià(
¿w_u£ºame
)

1213 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "u£ºame", 
up
->
u£ºame
);

1218 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error (verify_user_pass_plugin):…eer…rovided‡ blank username");

1221 
ş—nup
:

1222  
»tv®
;

1223 
	}
}

1226 #ifdeà
MANAGEMENT_DEF_AUTH


1230 
	#KMDA_ERROR
 0

	)

1231 
	#KMDA_SUCCESS
 1

	)

1232 
	#KMDA_UNDEF
 2

	)

1233 
	#KMDA_DEF
 3

	)

1236 
	$v”ify_u£r_·ss_mªagem’t
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ 
u£r_·ss
 *
up
, cÚ¡ *
¿w_u£ºame
)

1238 
»tv®
 = 
KMDA_ERROR
;

1239 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

1242 ià((
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_AUTH_USER_PASS_OPTIONAL
è|| 
	`¡¾’
(
up
->
u£ºame
))

1245 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "u£ºame", (
¿w_u£ºame
 ?„aw_u£ºam: 
up
->
u£ºame
));

1246 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "·sswÜd", 
up
->
·sswÜd
);

1249 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "commÚ_Çme", sessiÚ->
commÚ_Çme
);

1252 
	`£‹nv_uÁru¡ed
(
£ssiÚ
);

1254 ià(
mªagem’t
)

1256 
	`mªagem’t_nÙify_ş›Á_Ãedšg_auth
(
mªagem’t
, 
ks
->
mda_key_id
, 
£ssiÚ
->
İt
->
mda_cÚ‹xt
, sessiÚ->İt->
es
);

1259 
	`£‹nv_d–
(
£ssiÚ
->
İt
->
es
, "password");

1260 ià(
¿w_u£ºame
)

1262 
	`£‹nv_¡r
(
£ssiÚ
->
İt
->
es
, "u£ºame", 
up
->
u£ºame
);

1265 
»tv®
 = 
KMDA_SUCCESS
;

1269 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error (verify_user_pass_management):…eer…rovided‡ blank username");

1272  
»tv®
;

1273 
	}
}

1280 
	$v”ify_u£r_·ss
(
u£r_·ss
 *
up
, 
s_muÉi
 *
muÉi
,

1281 
s_£ssiÚ
 *
£ssiÚ
)

1283 
s1
 = 
OPENVPN_PLUGIN_FUNC_SUCCESS
;

1284 
boŞ
 
s2
 = 
Œue
;

1285 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

1287 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1288 *
¿w_u£ºame
 = 
NULL
;

1290 #ifdeà
MANAGEMENT_DEF_AUTH


1291 
mª_def_auth
 = 
KMDA_UNDEF
;

1293 ià(
	`mªagem’t_’abË_def_auth
(
mªagem’t
))

1295 
mª_def_auth
 = 
KMDA_DEF
;

1303 ià(
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

1305 
	`ALLOC_ARRAY_CLEAR_GC
(
¿w_u£ºame
, , 
USER_PASS_LEN
, &
gc
);

1306 
	`¡rıy
(
¿w_u£ºame
, 
up
->
u£ºame
);

1307 
	`¡ršg_mod
(
¿w_u£ºame
, 
CC_PRINT
, 
CC_CRLF
, '_');

1311 
	`¡ršg_mod_»m­_Çme
(
up
->
u£ºame
, 
COMMON_NAME_CHAR_CLASS
);

1312 
	`¡ršg_mod
(
up
->
·sswÜd
, 
CC_PRINT
, 
CC_CRLF
, '_');

1319 ià(
£ssiÚ
->
İt
->
auth_tok’_g’”©e
 && 
muÉi
->
auth_tok’_£Á


1320 && 
NULL
 !ğ
muÉi
->
auth_tok’
)

1322 
s¦_æags
 = 
£ssiÚ
->
İt
->ssl_flags;

1325 ià(!
	`s_lock_u£ºame
(
muÉi
, 
up
->
u£ºame
))

1328 
ks
->
auth’tiÿ‹d
 = 
çl£
;

1329 
dÚe
;

1335 ià(
£ssiÚ
->
İt
->
auth_tok’_liãtime
 > 0

1336 && (
muÉi
->
auth_tok’_t¡amp
 + 
£ssiÚ
->
İt
->
auth_tok’_liãtime
è< 
now
)

1338 
	`msg
(
D_HANDSHAKE
, "Auth-token for clientƒxpired\n");

1339 
	`we_auth_tok’
(
muÉi
);

1340 
ks
->
auth’tiÿ‹d
 = 
çl£
;

1341 
dÚe
;

1345 ià(
	`memcmp_cÚ¡ªt_time
(
muÉi
->
auth_tok’
, 
up
->
·sswÜd
,

1346 
	`¡¾’
(
muÉi
->
auth_tok’
)) != 0)

1348 
ks
->
auth’tiÿ‹d
 = 
çl£
;

1349 
	`s_d—uth’tiÿ‹
(
muÉi
);

1351 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: Auth-token verification "

1352 "çed fÜ u£ºam'%s' %s", 
up
->
u£ºame
,

1353 (
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1357 
ks
->
auth’tiÿ‹d
 = 
Œue
;

1359 ià(
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
)

1361 
	`£t_commÚ_Çme
(
£ssiÚ
, 
up
->
u£ºame
);

1363 
	`msg
(
D_HANDSHAKE
, "TLS: Username/auth-token‡uthentication "

1365 
up
->
u£ºame
,

1366 (
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1368 
dÚe
;

1372 #ifdeà
MANAGEMENT_DEF_AUTH


1373 ià(
mª_def_auth
 =ğ
KMDA_DEF
)

1375 
mª_def_auth
 = 
	`v”ify_u£r_·ss_mªagem’t
(
£ssiÚ
, 
up
, 
¿w_u£ºame
);

1378 ià(
	`¶ugš_defšed
(
£ssiÚ
->
İt
->
¶ugšs
, 
OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY
))

1380 
s1
 = 
	`v”ify_u£r_·ss_¶ugš
(
£ssiÚ
, 
up
, 
¿w_u£ºame
);

1382 ià(
£ssiÚ
->
İt
->
auth_u£r_·ss_v”ify_süt
)

1384 
s2
 = 
	`v”ify_u£r_·ss_süt
(
£ssiÚ
, 
up
);

1388 ià((
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
è&& 
	`¡¾’
(
up
->
u£ºame
è> 
TLS_USERNAME_LEN
)

1390 
	`msg
(
D_TLS_ERRORS
, "TLS Auth E¼Ü: --u£ºame-as-commÚ‚am¥ecif›d‡nd u£ºami lÚg”hªhmaximum…”m™‹d CommÚ NamËngth oà%d ch¬aù”s", 
TLS_USERNAME_LEN
);

1391 
s1
 = 
OPENVPN_PLUGIN_FUNC_ERROR
;

1395 ià((
s1
 =ğ
OPENVPN_PLUGIN_FUNC_SUCCESS


1396 #ifdeà
PLUGIN_DEF_AUTH


1397 || 
s1
 =ğ
OPENVPN_PLUGIN_FUNC_DEFERRED


1399 è&& 
s2


1400 #ifdeà
MANAGEMENT_DEF_AUTH


1401 && 
mª_def_auth
 !ğ
KMDA_ERROR


1403 && 
	`s_lock_u£ºame
(
muÉi
, 
up
->
u£ºame
))

1405 
ks
->
auth’tiÿ‹d
 = 
Œue
;

1406 #ifdeà
PLUGIN_DEF_AUTH


1407 ià(
s1
 =ğ
OPENVPN_PLUGIN_FUNC_DEFERRED
)

1409 
ks
->
auth_deã¼ed
 = 
Œue
;

1412 #ifdeà
MANAGEMENT_DEF_AUTH


1413 ià(
mª_def_auth
 !ğ
KMDA_UNDEF
)

1415 
ks
->
auth_deã¼ed
 = 
Œue
;

1419 ià((
£ssiÚ
->
İt
->
auth_tok’_g’”©e
è&& (
NULL
 =ğ
muÉi
->
auth_tok’
))

1424 
ušt8_t
 
tok
[
AUTH_TOKEN_SIZE
];

1426 ià(!
	`¿nd_by‹s
(
tok
, 
AUTH_TOKEN_SIZE
))

1428 
	`msg
Ğ
M_FATAL
, "Failedo getƒnough„andomness for "

1435 
	`ASSERT
(
	`İ’v²_ba£64_’code
(
tok
, 
AUTH_TOKEN_SIZE
,

1436 &
muÉi
->
auth_tok’
è> 
AUTH_TOKEN_SIZE
);

1437 
muÉi
->
auth_tok’_t¡amp
 = 
now
;

1438 
	`dmsg
(
D_SHOW_KEYS
, "Generatedoken for client: %s",

1439 
muÉi
->
auth_tok’
);

1442 ià((
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
))

1444 
	`£t_commÚ_Çme
(
£ssiÚ
, 
up
->
u£ºame
);

1447 #ifdeà
ENABLE_DEF_AUTH


1448 
	`msg
(
D_HANDSHAKE
, "TLS: Username/Password‡uthentication %s for username '%s' %s",

1449 
ks
->
auth_deã¼ed
 ? "deferred" : "succeeded",

1450 
up
->
u£ºame
,

1451 (
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1453 
	`msg
(
D_HANDSHAKE
, "TLS: Username/Password‡uthentication %s for username '%s' %s",

1455 
up
->
u£ºame
,

1456 (
£ssiÚ
->
İt
->
s¦_æags
 & 
SSLF_USERNAME_AS_COMMON_NAME
) ? "[CN SET]" : "");

1461 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: Auth Username/Password verification failed for…eer");

1464 
dÚe
:

1465 
	`gc_ä“
(&
gc
);

1466 
	}
}

1469 
	$v”ify_fš®_auth_checks
(
s_muÉi
 *
muÉi
, 
s_£ssiÚ
 *
£ssiÚ
)

1471 
key_¡©e
 *
ks
 = &
£ssiÚ
->
key
[
KS_PRIMARY
];

1474 ià(!
£ssiÚ
->
commÚ_Çme
)

1476 
	`£t_commÚ_Çme
(
£ssiÚ
, "");

1480 ià(
ks
->
auth’tiÿ‹d
 && 
muÉi
->
locked_ú
)

1482 cÚ¡ *
ú
 = 
£ssiÚ
->
commÚ_Çme
;

1483 ià(
ú
 && 
	`¡rcmp
(ú, 
muÉi
->
locked_ú
))

1485 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: TLS object CN‡ttemptedo change from '%s'o '%s' --unnel disabled",

1486 
muÉi
->
locked_ú
,

1487 
ú
);

1490 
	`£t_commÚ_Çme
(
£ssiÚ
, 
muÉi
->
locked_ú
);

1491 
	`s_d—uth’tiÿ‹
(
muÉi
);

1496 ià(
ks
->
auth’tiÿ‹d
 && 
muÉi
->
locked_û¹_hash_£t
)

1498 cÚ¡ 
û¹_hash_£t
 *
chs
 = 
£ssiÚ
->cert_hash_set;

1499 ià(
chs
 && !
	`û¹_hash_com·»
(chs, 
muÉi
->
locked_û¹_hash_£t
))

1501 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: TLS object CN=%s client-provided SSL certs unexpectedly changed during mid-session„eauth",

1502 
£ssiÚ
->
commÚ_Çme
);

1505 
	`s_d—uth’tiÿ‹
(
muÉi
);

1510 ià(
ks
->
auth’tiÿ‹d
 && 
£ssiÚ
->
İt
->
ş›Á_cÚfig_dœ_exşusive
)

1512 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1514 cÚ¡ *
ú
 = 
£ssiÚ
->
commÚ_Çme
;

1515 cÚ¡ *
·th
 = 
	`g’_·th
(
£ssiÚ
->
İt
->
ş›Á_cÚfig_dœ_exşusive
, 
ú
, &
gc
);

1516 ià(!
ú
 || !
	`¡rcmp
(ú, 
CCD_DEFAULT
è|| !
	`‹¡_fe
(
·th
))

1518 
ks
->
auth’tiÿ‹d
 = 
çl£
;

1519 
	`we_auth_tok’
(
muÉi
);

1520 
	`msg
(
D_TLS_ERRORS
, "TLS Auth Error: --client-config-dir‡uthentication failed for common‚ame '%s' file='%s'",

1521 
£ssiÚ
->
commÚ_Çme
,

1522 
·th
 ?…ath : "UNDEF");

1525 
	`gc_ä“
(&
gc
);

1527 
	}
}

1530 
	$s_x509_ş—r_’v
(
’v_£t
 *
es
)

1532 
’v_™em
 *
™em
 = 
es
->
li¡
;

1533 
™em
)

1535 
’v_™em
 *
Ãxt
 = 
™em
->next;

1536 ià(
™em
->
¡ršg


1537 && 0 =ğ
	`¡ºcmp
("X509_", 
™em
->
¡ršg
, 
	`¡¾’
("X509_")))

1539 
	`’v_£t_d–
(
es
, 
™em
->
¡ršg
);

1541 
™em
 = 
Ãxt
;

1543 
	}
}

	@ssl_verify.h

29 #iâdeà
SSL_VERIFY_H_


30 
	#SSL_VERIFY_H_


	)

32 #ifdeà
ENABLE_CRYPTO


34 
	~"sysh—d.h
"

35 
	~"misc.h
"

36 
	~"s¦_commÚ.h
"

39 #ifdeà
ENABLE_CRYPTO_OPENSSL


40 
	~"s¦_v”ify_İ’s¦.h
"

42 #ifdeà
ENABLE_CRYPTO_MBEDTLS


43 
	~"s¦_v”ify_mbeds.h
"

46 
	~"s¦_v”ify_back’d.h
"

53 
	#MAX_CERT_DEPTH
 16

	)

56 
	sû¹_hash
 {

57 
	msha256_hash
[256/8];

61 
	sû¹_hash_£t
 {

62 
û¹_hash
 *
	mch
[
MAX_CERT_DEPTH
];

65 
	#VERIFY_X509_NONE
 0

	)

66 
	#VERIFY_X509_SUBJECT_DN
 1

	)

67 
	#VERIFY_X509_SUBJECT_RDN
 2

	)

68 
	#VERIFY_X509_SUBJECT_RDN_PREFIX
 3

	)

70 
	#TLS_AUTHENTICATION_SUCCEEDED
 0

	)

71 
	#TLS_AUTHENTICATION_FAILED
 1

	)

72 
	#TLS_AUTHENTICATION_DEFERRED
 2

	)

73 
	#TLS_AUTHENTICATION_UNDEFINED
 3

	)

81 
s_auth’tiÿtiÚ_¡©us
(
s_muÉi
 *
muÉi
, cÚ¡ 
Ï‹ncy
);

91 
	#DECRYPT_KEY_ENABLED
(
muÉi
, 
ks
è((ks)->
¡©e
 >ğ(
S_GOT_KEY
 - (muÉi)->
İt
.
£rv”
))

	)

98 
key_¡©e_rm_auth_cÚŒŞ_fe
(
key_¡©e
 *
ks
);

105 
û¹_hash_ä“
(
û¹_hash_£t
 *
chs
);

112 
s_lock_û¹_hash_£t
(
s_muÉi
 *
muÉi
);

119 
s_lock_commÚ_Çme
(
s_muÉi
 *
muÉi
);

127 cÚ¡ *
s_commÚ_Çme
(cÚ¡ 
s_muÉi
 *
muÉi
, cÚ¡ 
boŞ
 
nuÎ
);

135 cÚ¡ *
s_u£ºame
(cÚ¡ 
s_muÉi
 *
muÉi
, cÚ¡ 
boŞ
 
nuÎ
);

143 
boŞ
 
û¹_hash_com·»
(cÚ¡ 
û¹_hash_£t
 *
chs1
, cÚ¡ û¹_hash_£ˆ*
chs2
);

145 #ifdeà
ENABLE_PF


156 
šlše
 
boŞ


157 
	$s_commÚ_Çme_hash
(cÚ¡ 
s_muÉi
 *
muÉi
, cÚ¡ **
ú
, 
ušt32_t
 *
ú_hash
)

159 ià(
muÉi
)

161 cÚ¡ 
s_£ssiÚ
 *
s
 = &
muÉi
->
£ssiÚ
[
TM_ACTIVE
];

162 ià(
s
->
commÚ_Çme
 && s->common_name[0] != '\0')

164 *
ú
 = 
s
->
commÚ_Çme
;

165 *
ú_hash
 = 
s
->
commÚ_Çme_hashv®
;

166  
Œue
;

169  
çl£
;

170 
	}
}

187 
v”ify_u£r_·ss
(
u£r_·ss
 *
up
, 
s_muÉi
 *
muÉi
,

188 
s_£ssiÚ
 *
£ssiÚ
);

199 
v”ify_fš®_auth_checks
(
s_muÉi
 *
muÉi
, 
s_£ssiÚ
 *
£ssiÚ
);

201 
	sx509_Œack


203 cÚ¡ 
x509_Œack
 *
	mÃxt
;

204 cÚ¡ *
	mÇme
;

205 
	#XT_FULL_CHAIN
 (1<<0)

	)

206 
	mæags
;

207 
	mnid
;

214 
	#NS_CERT_CHECK_NONE
 (0)

	)

216 
	#NS_CERT_CHECK_SERVER
 (1<<0)

	)

218 
	#NS_CERT_CHECK_CLIENT
 (1<<1)

	)

221 
	#OPENVPN_KU_REQUIRED
 (0xFFFF)

	)

226 #ifdeà
MANAGEMENT_DEF_AUTH


227 
boŞ
 
s_auth’tiÿ‹_key
(
s_muÉi
 *
muÉi
, cÚ¡ 
mda_key_id
, cÚ¡ boŞ 
auth
, cÚ¡ *
ş›Á_»asÚ
);

229 
mª_def_auth_£t_ş›Á_»asÚ
(
s_muÉi
 *
muÉi
, cÚ¡ *
ş›Á_»asÚ
);

233 
šlše
 const *

234 
	$s_ş›Á_»asÚ
(
s_muÉi
 *
muÉi
)

236 #ifdeà
ENABLE_DEF_AUTH


237  
muÉi
->
ş›Á_»asÚ
;

239  
NULL
;

241 
	}
}

244 
s_x509_ş—r_’v
(
’v_£t
 *
es
);

	@ssl_verify_backend.h

29 #iâdeà
SSL_VERIFY_BACKEND_H_


30 
	#SSL_VERIFY_BACKEND_H_


	)

35 ’um { 
	mSUCCESS
 = 0, 
	mFAILURE
 = 1 } 
	t»suÉ_t
;

57 
»suÉ_t
 
v”ify_û¹
(
s_£ssiÚ
 *
£ssiÚ
, 
İ’v²_x509_û¹_t
 *
û¹
, 
û¹_d•th
);

70 
û¹_hash_»memb”
(
s_£ssiÚ
 *
£ssiÚ
, cÚ¡ 
û¹_d•th
,

71 cÚ¡ 
bufãr
 *
û¹_hash
);

87 *
x509_g‘_subjeù
(
İ’v²_x509_û¹_t
 *
û¹
, 
gc_¬’a
 *
gc
);

97 
bufãr
 
x509_g‘_sha1_fšg”´št
(
İ’v²_x509_û¹_t
 *
û¹
,

98 
gc_¬’a
 *
gc
);

108 
bufãr
 
x509_g‘_sha256_fšg”´št
(
İ’v²_x509_û¹_t
 *
û¹
,

109 
gc_¬’a
 *
gc
);

124 
»suÉ_t
 
back’d_x509_g‘_u£ºame
(*
commÚ_Çme
, 
ú_Ën
,

125 *
x509_u£ºame_f›ld
, 
İ’v²_x509_û¹_t
 *
³”_û¹
);

127 #ifdeà
ENABLE_X509ALTUSERNAME


132 
boŞ
 
x509_u£ºame_f›ld_ext_suµÜ‹d
(cÚ¡ *
exŠame
);

146 *
back’d_x509_g‘_£rŸl
(
İ’v²_x509_û¹_t
 *
û¹
, 
gc_¬’a
 *
gc
);

159 *
back’d_x509_g‘_£rŸl_hex
(
İ’v²_x509_û¹_t
 *
û¹
,

160 
gc_¬’a
 *
gc
);

171 
x509_£‹nv
(
’v_£t
 *
es
, 
û¹_d•th
, 
İ’v²_x509_û¹_t
 *
û¹
);

184 
x509_Œack_add
(cÚ¡ 
x509_Œack
 **
Î_h—d
, cÚ¡ *
Çme
,

185 
msgËv–
, 
gc_¬’a
 *
gc
);

207 
x509_£‹nv_Œack
(cÚ¡ 
x509_Œack
 *
xt
, 
’v_£t
 *
es
,

208 cÚ¡ 
d•th
, 
İ’v²_x509_û¹_t
 *
x509
);

221 
»suÉ_t
 
x509_v”ify_ns_û¹_ty³
(
İ’v²_x509_û¹_t
 *
û¹
, cÚ¡ 
u§ge
);

233 
»suÉ_t
 
x509_v”ify_û¹_ku
(
İ’v²_x509_û¹_t
 *
x509
, cÚ¡ *cÚ¡ 
ex³ùed_ku
,

234 
ex³ùed_Ën
);

249 
»suÉ_t
 
x509_v”ify_û¹_eku
(
İ’v²_x509_û¹_t
 *
x509
, cÚ¡ *cÚ¡ 
ex³ùed_oid
);

260 
»suÉ_t
 
x509_wr™e_³m
(
FILE
 *
³”û¹_fe
, 
İ’v²_x509_û¹_t
 *
³”û¹
);

268 
boŞ
 
s_v”ify_ül_missšg
(cÚ¡ 
s_İtiÚs
 *
İt
);

	@ssl_verify_mbedtls.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_MBEDTLS
)

39 
	~"üy±o_mbeds.h
"

40 
	~"s¦_v”ify.h
"

41 
	~<mbeds/a¢1.h
>

42 
	~<mbeds/”rÜ.h
>

43 
	~<mbeds/bignum.h
>

44 
	~<mbeds/oid.h
>

45 
	~<mbeds/sha1.h
>

47 
	#MAX_SUBJECT_LENGTH
 256

	)

50 
	$v”ify_ÿÎback
(*
£ssiÚ_obj
, 
mbeds_x509_üt
 *
û¹
, 
û¹_d•th
,

51 
ušt32_t
 *
æags
)

53 
s_£ssiÚ
 *
£ssiÚ
 = (s_£ssiÚ *è
£ssiÚ_obj
;

54 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

56 
	`ASSERT
(
û¹
);

57 
	`ASSERT
(
£ssiÚ
);

59 
£ssiÚ
->
v”if›d
 = 
çl£
;

62 
bufãr
 
û¹_fšg”´št
 = 
	`x509_g‘_sha256_fšg”´št
(
û¹
, &
gc
);

63 
	`û¹_hash_»memb”
(
£ssiÚ
, 
û¹_d•th
, &
û¹_fšg”´št
);

66 ià(*
æags
 != 0)

68 
»t
 = 0;

69 
”r¡r
[512] = { 0 };

70 *
subjeù
 = 
	`x509_g‘_subjeù
(
û¹
, &
gc
);

72 
»t
 = 
	`mbeds_x509_üt_v”ify_šfo
(
”r¡r
, Ó¼¡r)-1, "", *
æags
);

73 ià(
»t
 <ğ0 && !
	`İ’v²_¢´štf
(
”r¡r
, (errstr),

74 "Could‚Ù„‘r›v”rÜ sŒšg, fÏgs=%" 
PRIx32
, *
æags
))

76 
”r¡r
[0] = '\0';

80 
	`chomp
(
”r¡r
);

83 ià(
subjeù
)

85 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d, subject=%s: %s",

86 
û¹_d•th
, 
subjeù
, 
”r¡r
);

90 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d, (could‚otƒxtract X509 "

91 "subjeù sŒšg from c”tifiÿ‹): %s", 
û¹_d•th
, 
”r¡r
);

96 ià(
SUCCESS
 !ğ
	`v”ify_û¹
(
£ssiÚ
, 
û¹
, 
û¹_d•th
))

98 *
æags
 |ğ
MBEDTLS_X509_BADCERT_OTHER
;

101 
	`gc_ä“
(&
gc
);

107 
	}
}

109 #ifdeà
ENABLE_X509ALTUSERNAME


113 
»suÉ_t


114 
	$back’d_x509_g‘_u£ºame
(*
ú
, 
ú_Ën
,

115 *
x509_u£ºame_f›ld
, 
mbeds_x509_üt
 *
û¹
)

117 
mbeds_x509_Çme
 *
Çme
;

119 
	`ASSERT
Ğ
ú
 !ğ
NULL
 );

121 
Çme
 = &
û¹
->
subjeù
;

124 
Çme
 !ğ
NULL
)

126 ià(0 =ğ
	`memcmp
(
Çme
->
oid
.
p
, 
MBEDTLS_OID_AT_CN
,

127 
	`MBEDTLS_OID_SIZE
(
MBEDTLS_OID_AT_CN
)))

132 
Çme
 =‚ame->
Ãxt
;

136 ià(
Çme
 =ğ
NULL
)

138  
FAILURE
;

142 ià(
ú_Ën
 > 
Çme
->
v®
.
Ën
)

144 
	`memıy
Ğ
ú
, 
Çme
->
v®
.
p
,‚ame->v®.
Ën
 );

145 
ú
[
Çme
->
v®
.
Ën
] = '\0';

149 
	`memıy
Ğ
ú
, 
Çme
->
v®
.
p
, 
ú_Ën
);

150 
ú
[
ú_Ën
-1] = '\0';

153  
SUCCESS
;

154 
	}
}

157 
	$back’d_x509_g‘_£rŸl
(
mbeds_x509_üt
 *
û¹
, 
gc_¬’a
 *
gc
)

159 *
buf
 = 
NULL
;

160 
size_t
 
buæ’
 = 0;

161 
mbeds_mpi
 
£rŸl_mpi
 = { 0 };

164 
	`mbeds_mpi_š™
(&
£rŸl_mpi
);

165 ià(!
	`mbed_ok
(
	`mbeds_mpi_»ad_bš¬y
(&
£rŸl_mpi
, 
û¹
->
£rŸl
.
p
,

166 
û¹
->
£rŸl
.
Ën
)))

168 
	`msg
(
M_WARN
, "Failedo„etrieve serial from certificate.");

169 
’d
;

173 
	`mbeds_mpi_wr™e_¡ršg
(&
£rŸl_mpi
, 10, 
NULL
, 0, &
buæ’
);

174 
buf
 = 
	`gc_m®loc
(
buæ’
, 
Œue
, 
gc
);

177 ià(!
	`mbed_ok
(
	`mbeds_mpi_wr™e_¡ršg
(&
£rŸl_mpi
, 10, 
buf
, 
buæ’
, &buflen)))

179 
	`msg
(
M_WARN
, "Failedo write serialo string.");

180 
buf
 = 
NULL
;

181 
’d
;

184 
’d
:

185 
	`mbeds_mpi_ä“
(&
£rŸl_mpi
);

186  
buf
;

187 
	}
}

190 
	$back’d_x509_g‘_£rŸl_hex
(
mbeds_x509_üt
 *
û¹
, 
gc_¬’a
 *
gc
)

192 *
buf
 = 
NULL
;

193 
size_t
 
Ën
 = 
û¹
->
£rŸl
.len * 3 + 1;

195 
buf
 = 
	`gc_m®loc
(
Ën
, 
Œue
, 
gc
);

197 ià(
	`mbeds_x509_£rŸl_g‘s
(
buf
, 
Ën
-1, &
û¹
->
£rŸl
) < 0)

199 
buf
 = 
NULL
;

202  
buf
;

203 
	}
}

205 
bufãr


206 
	$x509_g‘_fšg”´št
(cÚ¡ 
mbeds_md_šfo_t
 *
md_šfo
, 
mbeds_x509_üt
 *
û¹
,

207 
gc_¬’a
 *
gc
)

209 cÚ¡ 
size_t
 
md_size
 = 
	`mbeds_md_g‘_size
(
md_šfo
);

210 
bufãr
 
fšg”´št
 = 
	`®loc_buf_gc
(
md_size
, 
gc
);

211 
	`mbeds_md
(
md_šfo
, 
û¹
->
¿w
.
p
, c”t->¿w.
Ën
, 
	`BPTR
(&
fšg”´št
));

212 
	`ASSERT
(
	`buf_šc_Ën
(&
fšg”´št
, 
md_size
));

213  
fšg”´št
;

214 
	}
}

216 
bufãr


217 
	$x509_g‘_sha1_fšg”´št
(
mbeds_x509_üt
 *
û¹
, 
gc_¬’a
 *
gc
)

219  
	`x509_g‘_fšg”´št
(
	`mbeds_md_šfo_äom_ty³
(
MBEDTLS_MD_SHA1
),

220 
û¹
, 
gc
);

221 
	}
}

223 
bufãr


224 
	$x509_g‘_sha256_fšg”´št
(
mbeds_x509_üt
 *
û¹
, 
gc_¬’a
 *
gc
)

226  
	`x509_g‘_fšg”´št
(
	`mbeds_md_šfo_äom_ty³
(
MBEDTLS_MD_SHA256
),

227 
û¹
, 
gc
);

228 
	}
}

231 
	$x509_g‘_subjeù
(
mbeds_x509_üt
 *
û¹
, 
gc_¬’a
 *
gc
)

233 
tmp_subjeù
[
MAX_SUBJECT_LENGTH
] = {0};

234 *
subjeù
 = 
NULL
;

236 
»t
 = 0;

238 
»t
 = 
	`mbeds_x509_dn_g‘s
Ğ
tmp_subjeù
, 
MAX_SUBJECT_LENGTH
-1, &
û¹
->
subjeù
 );

239 ià(
»t
 > 0)

242 
subjeù
 = 
	`¡ršg_®loc
(
tmp_subjeù
, 
gc
);

245  
subjeù
;

246 
	}
}

249 
	$do_£‹nv_x509
(
’v_£t
 *
es
, cÚ¡ *
Çme
, *
v®ue
, 
d•th
)

251 *
Çme_ex·nd
;

252 
size_t
 
Çme_ex·nd_size
;

254 
	`¡ršg_mod
(
v®ue
, 
CC_ANY
, 
CC_CRLF
, '?');

255 
	`msg
(
D_X509_ATTR
, "X509 ATTRIBUTE‚ame='%s' v®ue='%s' d•th=%d", 
Çme
, 
v®ue
, 
d•th
);

256 
Çme_ex·nd_size
 = 64 + 
	`¡¾’
(
Çme
);

257 
Çme_ex·nd
 = (*è
	`m®loc
(
Çme_ex·nd_size
);

258 
	`check_m®loc_»tuº
(
Çme_ex·nd
);

259 
	`İ’v²_¢´štf
(
Çme_ex·nd
, 
Çme_ex·nd_size
, "X509_%d_%s", 
d•th
, 
Çme
);

260 
	`£‹nv_¡r
(
es
, 
Çme_ex·nd
, 
v®ue
);

261 
	`ä“
(
Çme_ex·nd
);

262 
	}
}

265 
	$a¢1_buf_to_c_¡ršg
(cÚ¡ 
mbeds_a¢1_buf
 *
Üig
, 
gc_¬’a
 *
gc
)

267 
size_t
 
i
;

268 *
v®
;

270 ià(!(
Üig
->
g
 =ğ
MBEDTLS_ASN1_UTF8_STRING


271 || 
Üig
->
g
 =ğ
MBEDTLS_ASN1_PRINTABLE_STRING


272 || 
Üig
->
g
 =ğ
MBEDTLS_ASN1_IA5_STRING
))

275  
	`¡ršg_®loc
("ERROR: unsuµÜ‹d ASN.1 sŒšgy³", 
gc
);

278 
i
 = 0; i < 
Üig
->
Ën
; ++i)

280 ià(
Üig
->
p
[
i
] == '\0')

282  
	`¡ršg_®loc
("ERROR:ƒmbedded‚uÎ v®ue", 
gc
);

285 
v®
 = 
	`gc_m®loc
(
Üig
->
Ën
+1, 
çl£
, 
gc
);

286 
	`memıy
(
v®
, 
Üig
->
p
, orig->
Ën
);

287 
v®
[
Üig
->
Ën
] = '\0';

288  
v®
;

289 
	}
}

292 
	$do_£‹nv_Çme
(
’v_£t
 *
es
, cÚ¡ 
x509_Œack
 *
xt
,

293 cÚ¡ 
mbeds_x509_üt
 *
û¹
, 
d•th
, 
gc_¬’a
 *
gc
)

295 cÚ¡ 
mbeds_x509_Çme
 *
xn
;

296 
xn
 = &
û¹
->
subjeù
; xÀ!ğ
NULL
; xÀğxn->
Ãxt
)

298 cÚ¡ *
xn_shÜt_Çme
 = 
NULL
;

299 ià(0 =ğ
	`mbeds_oid_g‘_©Œ_shÜt_Çme
(&
xn
->
oid
, &
xn_shÜt_Çme
)

300 && 0 =ğ
	`¡rcmp
(
xt
->
Çme
, 
xn_shÜt_Çme
))

302 *
v®_¡r
 = 
	`a¢1_buf_to_c_¡ršg
(&
xn
->
v®
, 
gc
);

303 
	`do_£‹nv_x509
(
es
, 
xt
->
Çme
, 
v®_¡r
, 
d•th
);

306 
	}
}

309 
	$x509_Œack_add
(cÚ¡ 
x509_Œack
 **
Î_h—d
, cÚ¡ *
Çme
, 
msgËv–
, 
gc_¬’a
 *
gc
)

311 
x509_Œack
 *
xt
;

312 
	`ALLOC_OBJ_CLEAR_GC
(
xt
, 
x509_Œack
, 
gc
);

313 ià(*
Çme
 == '+')

315 
xt
->
æags
 |ğ
XT_FULL_CHAIN
;

316 ++
Çme
;

318 
xt
->
Çme
 =‚ame;

319 
xt
->
Ãxt
 = *
Î_h—d
;

320 *
Î_h—d
 = 
xt
;

321 
	}
}

324 
	$x509_£‹nv_Œack
(cÚ¡ 
x509_Œack
 *
xt
, 
’v_£t
 *
es
,

325 cÚ¡ 
d•th
, 
mbeds_x509_üt
 *
û¹
)

327 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

328 
xt
)

330 ià(
d•th
 =ğ0 || (
xt
->
æags
 & 
XT_FULL_CHAIN
))

332 ià(0 =ğ
	`¡rcmp
(
xt
->
Çme
, "SHA1") || 0 == strcmp(xt->name, "SHA256"))

335 
bufãr
 
û¹_hash
;

336 *
fšg”´št
;

338 ià(0 =ğ
	`¡rcmp
(
xt
->
Çme
, "SHA1"))

340 
û¹_hash
 = 
	`x509_g‘_sha1_fšg”´št
(
û¹
, &
gc
);

344 
û¹_hash
 = 
	`x509_g‘_sha256_fšg”´št
(
û¹
, &
gc
);

347 
fšg”´št
 = 
	`fÜm©_hex_ex
(
	`BPTR
(&
û¹_hash
),

348 
	`BLEN
(&
û¹_hash
), 0, 1 | 
FHE_CAPS
, ":", &
gc
);

349 
	`do_£‹nv_x509
(
es
, 
xt
->
Çme
, 
fšg”´št
, 
d•th
);

353 
	`do_£‹nv_Çme
(
es
, 
xt
, 
û¹
, 
d•th
, &
gc
);

356 
xt
 = xt->
Ãxt
;

358 
	`gc_ä“
(&
gc
);

359 
	}
}

367 
	$x509_£‹nv
(
’v_£t
 *
es
, 
û¹_d•th
, 
mbeds_x509_üt
 *
û¹
)

369 
i
;

370 
c
;

371 cÚ¡ 
mbeds_x509_Çme
 *
Çme
;

372 
s
[128] = { 0 };

374 
Çme
 = &
û¹
->
subjeù
;

376 
Çme
 !ğ
NULL
)

378 
Çme_ex·nd
[64+8];

379 cÚ¡ *
shÜŠame
;

381 ià(0 =ğ
	`mbeds_oid_g‘_©Œ_shÜt_Çme
(&
Çme
->
oid
, &
shÜŠame
) )

383 
	`İ’v²_¢´štf
(
Çme_ex·nd
, (name_expand), "X509_%d_%s",

384 
û¹_d•th
, 
shÜŠame
);

388 
	`İ’v²_¢´štf
(
Çme_ex·nd
, (name_expand), "X509_%d_\?\?",

389 
û¹_d•th
);

392 
i
 = 0; i < 
Çme
->
v®
.
Ën
; i++)

394 ià(
i
 >ğ(èĞ
s
 ) - 1)

399 
c
 = 
Çme
->
v®
.
p
[
i
];

400 ià(
c
 < 32 || c == 127 || ( c > 128 && c < 160 ) )

402 
s
[
i
] = '?';

406 
s
[
i
] = 
c
;

409 
s
[
i
] = '\0';

412 
	`¡ršg_mod
(
Çme_ex·nd
, 
CC_PRINT
, 
CC_CRLF
, '_');

413 
	`¡ršg_mod
((*)
s
, 
CC_PRINT
, 
CC_CRLF
, '_');

414 
	`£‹nv_¡r_šü
(
es
, 
Çme_ex·nd
, (*)
s
);

416 
Çme
 =‚ame->
Ãxt
;

418 
	}
}

420 
»suÉ_t


421 
	$x509_v”ify_ns_û¹_ty³
(
mbeds_x509_üt
 *
û¹
, cÚ¡ 
u§ge
)

423 ià(
u§ge
 =ğ
NS_CERT_CHECK_NONE
)

425  
SUCCESS
;

427 ià(
u§ge
 =ğ
NS_CERT_CHECK_CLIENT
)

429  ((
û¹
->
ext_ty³s
 & 
MBEDTLS_X509_EXT_NS_CERT_TYPE
)

430 && (
û¹
->
ns_û¹_ty³
 & 
MBEDTLS_X509_NS_CERT_TYPE_SSL_CLIENT
)) ?

431 
SUCCESS
 : 
FAILURE
;

433 ià(
u§ge
 =ğ
NS_CERT_CHECK_SERVER
)

435  ((
û¹
->
ext_ty³s
 & 
MBEDTLS_X509_EXT_NS_CERT_TYPE
)

436 && (
û¹
->
ns_û¹_ty³
 & 
MBEDTLS_X509_NS_CERT_TYPE_SSL_SERVER
)) ?

437 
SUCCESS
 : 
FAILURE
;

440  
FAILURE
;

441 
	}
}

443 
»suÉ_t


444 
	$x509_v”ify_û¹_ku
(
mbeds_x509_üt
 *
û¹
, cÚ¡ *cÚ¡ 
ex³ùed_ku
,

445 
ex³ùed_Ën
)

447 
	`msg
(
D_HANDSHAKE
, "Validating certificate key usage");

449 ià(!(
û¹
->
ext_ty³s
 & 
MBEDTLS_X509_EXT_KEY_USAGE
))

451 
	`msg
(
D_TLS_ERRORS
,

453  
FAILURE
;

456 ià(
ex³ùed_ku
[0] =ğ
OPENVPN_KU_REQUIRED
)

459  
SUCCESS
;

462 
»suÉ_t
 
fFound
 = 
FAILURE
;

463 
size_t
 
i
 = 0; 
SUCCESS
 !ğ
fFound
 && i<
ex³ùed_Ën
; i++)

465 ià(
ex³ùed_ku
[
i
] != 0

466 && 0 =ğ
	`mbeds_x509_üt_check_key_u§ge
(
û¹
, 
ex³ùed_ku
[
i
]))

468 
fFound
 = 
SUCCESS
;

472 ià(
fFound
 !ğ
SUCCESS
)

474 
	`msg
(
D_TLS_ERRORS
,

476 
û¹
->
key_u§ge
);

477 
size_t
 
i
 = 0; i < 
ex³ùed_Ën
 && 
ex³ùed_ku
[i]; i++)

479 
	`msg
(
D_TLS_ERRORS
, " * %04x", 
ex³ùed_ku
[
i
]);

483  
fFound
;

484 
	}
}

486 
»suÉ_t


487 
	$x509_v”ify_û¹_eku
(
mbeds_x509_üt
 *
û¹
, cÚ¡ *cÚ¡ 
ex³ùed_oid
)

489 
»suÉ_t
 
fFound
 = 
FAILURE
;

491 ià(!(
û¹
->
ext_ty³s
 & 
MBEDTLS_X509_EXT_EXTENDED_KEY_USAGE
))

493 
	`msg
(
D_HANDSHAKE
, "Certificate does‚ot haveƒxtended key usageƒxtension");

497 
mbeds_x509_£qu’û
 *
oid_£q
 = &(
û¹
->
ext_key_u§ge
);

499 
	`msg
(
D_HANDSHAKE
, "Validating certificateƒxtended key usage");

500 
oid_£q
 !ğ
NULL
)

502 
mbeds_x509_buf
 *
oid
 = &
oid_£q
->
buf
;

503 
oid_num_¡r
[1024];

504 cÚ¡ *
oid_¡r
;

506 ià(0 =ğ
	`mbeds_oid_g‘_ex‹nded_key_u§ge
Ğ
oid
, &
oid_¡r
 ))

508 
	`msg
(
D_HANDSHAKE
, "++ Certificate has EKU (str) %s,ƒxpects %s",

509 
oid_¡r
, 
ex³ùed_oid
);

510 ià(!
	`¡rcmp
(
ex³ùed_oid
, 
oid_¡r
))

512 
fFound
 = 
SUCCESS
;

517 ià(0 < 
	`mbeds_oid_g‘_num”ic_¡ršg
Ğ
oid_num_¡r
,

518 (
oid_num_¡r
), 
oid
))

520 
	`msg
(
D_HANDSHAKE
, "++ Certificate has EKU (oid) %s,ƒxpects %s",

521 
oid_num_¡r
, 
ex³ùed_oid
);

522 ià(!
	`¡rcmp
(
ex³ùed_oid
, 
oid_num_¡r
))

524 
fFound
 = 
SUCCESS
;

528 
oid_£q
 = oid_£q->
Ãxt
;

532  
fFound
;

533 
	}
}

535 
»suÉ_t


536 
	$x509_wr™e_³m
(
FILE
 *
³”û¹_fe
, 
mbeds_x509_üt
 *
³”û¹
)

538 
	`msg
(
M_WARN
, "mbed TLS does‚ot support writing…eer certificate in PEM format");

539  
FAILURE
;

540 
	}
}

542 
boŞ


543 
	$s_v”ify_ül_missšg
(cÚ¡ 
s_İtiÚs
 *
İt
)

545 ià(
İt
->
ül_fe
 && !(İt->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
)

546 && (
İt
->
s¦_ùx
.
ül
 =ğ
NULL
 || o±->s¦_ùx.ül->
v”siÚ
 == 0))

548  
Œue
;

550  
çl£
;

551 
	}
}

	@ssl_verify_mbedtls.h

29 #iâdeà
SSL_VERIFY_MBEDTLS_H_


30 
	#SSL_VERIFY_MBEDTLS_H_


	)

32 
	~"sysh—d.h
"

33 
	~<mbeds/x509_üt.h
>

35 #iâdeà
__OPENVPN_X509_CERT_T_DECLARED


36 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

37 
mbeds_x509_üt
 
	tİ’v²_x509_û¹_t
;

72 
v”ify_ÿÎback
(*
£ssiÚ_obj
, 
mbeds_x509_üt
 *
û¹
, 
û¹_d•th
,

73 
ušt32_t
 *
æags
);

	@ssl_verify_openssl.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_OPENSSL
)

39 
	~"s¦_v”ify_İ’s¦.h
"

41 
	~"”rÜ.h
"

42 
	~"s¦_İ’s¦.h
"

43 
	~"s¦_v”ify.h
"

44 
	~"s¦_v”ify_back’d.h
"

45 
	~"İ’s¦_com·t.h
"

47 
	~<İ’s¦/x509v3.h
>

48 
	~<İ’s¦/”r.h
>

51 
	$v”ify_ÿÎback
(
´ev”ify_ok
, 
X509_STORE_CTX
 *
ùx
)

53 
»t
 = 0;

54 
s_£ssiÚ
 *
£ssiÚ
;

55 
SSL
 *
s¦
;

56 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

59 
s¦
 = 
	`X509_STORE_CTX_g‘_ex_d©a
(
ùx
, 
	`SSL_g‘_ex_d©a_X509_STORE_CTX_idx
());

60 
	`ASSERT
(
s¦
);

61 
£ssiÚ
 = (
s_£ssiÚ
 *è
	`SSL_g‘_ex_d©a
(
s¦
, 
myd©a_šdex
);

62 
	`ASSERT
(
£ssiÚ
);

64 
X509
 *
cu¼’t_û¹
 = 
	`X509_STORE_CTX_g‘_cu¼’t_û¹
(
ùx
);

65 
bufãr
 
û¹_hash
 = 
	`x509_g‘_sha256_fšg”´št
(
cu¼’t_û¹
, &
gc
);

66 
	`û¹_hash_»memb”
(
£ssiÚ
, 
	`X509_STORE_CTX_g‘_”rÜ_d•th
(
ùx
), &
û¹_hash
);

69 ià(!
´ev”ify_ok
)

72 *
subjeù
 = 
	`x509_g‘_subjeù
(
cu¼’t_û¹
, &
gc
);

74 ià(!
subjeù
)

76 
subjeù
 = "(Failedo„etrieve certificate subject)";

80 ià(
	`X509_STORE_CTX_g‘_”rÜ
(
ùx
è=ğ
X509_V_ERR_UNABLE_TO_GET_CRL
)

82 
	`msg
(
D_TLS_DEBUG_LOW
, "VERIFY WARNING: depth=%d, %s: %s",

83 
	`X509_STORE_CTX_g‘_”rÜ_d•th
(
ùx
),

84 
	`X509_v”ify_û¹_”rÜ_¡ršg
(
	`X509_STORE_CTX_g‘_”rÜ
(
ùx
)),

85 
subjeù
);

86 
»t
 = 1;

87 
ş—nup
;

91 
	`msg
(
D_TLS_ERRORS
, "VERIFY ERROR: depth=%d,ƒrror=%s: %s",

92 
	`X509_STORE_CTX_g‘_”rÜ_d•th
(
ùx
),

93 
	`X509_v”ify_û¹_”rÜ_¡ršg
(
	`X509_STORE_CTX_g‘_”rÜ
(
ùx
)),

94 
subjeù
);

96 
	`ERR_ş—r_”rÜ
();

98 
£ssiÚ
->
v”if›d
 = 
çl£
;

99 
ş—nup
;

102 ià(
SUCCESS
 !ğ
	`v”ify_û¹
(
£ssiÚ
, 
cu¼’t_û¹
, 
	`X509_STORE_CTX_g‘_”rÜ_d•th
(
ùx
)))

104 
ş—nup
;

107 
»t
 = 1;

109 
ş—nup
:

110 
	`gc_ä“
(&
gc
);

112  
»t
;

113 
	}
}

115 #ifdeà
ENABLE_X509ALTUSERNAME


116 
boŞ
 
	$x509_u£ºame_f›ld_ext_suµÜ‹d
(cÚ¡ *
f›ldÇme
)

118 
nid
 = 
	`OBJ_txt2nid
(
f›ldÇme
);

119  
nid
 =ğ
NID_subjeù_®t_Çme
 ||‚id =ğ
NID_issu”_®t_Çme
;

120 
	}
}

123 
boŞ


124 
	$exŒaù_x509_ex‹nsiÚ
(
X509
 *
û¹
, *
f›ldÇme
, *
out
, 
size
)

126 
boŞ
 
»tv®
 = 
çl£
;

127 *
buf
 = 0;

129 ià(!
	`x509_u£ºame_f›ld_ext_suµÜ‹d
(
f›ldÇme
))

131 
	`msg
(
D_TLS_ERRORS
,

132 "ERROR: --x509-u£ºame-f›ld 'ext:%s'‚Ù suµÜ‹d", 
f›ldÇme
);

133  
çl£
;

136 
nid
 = 
	`OBJ_txt2nid
(
f›ldÇme
);

137 
GENERAL_NAMES
 *
ex‹nsiÚs
 = 
	`X509_g‘_ext_d2i
(
û¹
, 
nid
, 
NULL
, NULL);

138 ià(
ex‹nsiÚs
)

140 
num®ts
;

141 
i
;

147 
num®ts
 = 
	`sk_GENERAL_NAME_num
(
ex‹nsiÚs
);

150 
i
 = 0; i<
num®ts
; i++)

153 cÚ¡ 
GENERAL_NAME
 *
Çme
 = 
	`sk_GENERAL_NAME_v®ue
(
ex‹nsiÚs
, 
i
 );

155 
Çme
->
ty³
)

157 
GEN_EMAIL
:

158 ià(
	`ASN1_STRING_to_UTF8
((**)&
buf
, 
Çme
->
d
.
Ÿ5
) < 0)

162 ià(
	`¡¾’
(
buf
è!ğ
Çme
->
d
.
Ÿ5
->
Ëngth
)

164 
	`msg
(
D_TLS_ERRORS
, "ASN1 ERROR: string containederminating zero");

165 
	`OPENSSL_ä“
(
buf
);

169 
	`¡ºıyÁ
(
out
, 
buf
, 
size
);

170 
	`OPENSSL_ä“
(
buf
);

171 
»tv®
 = 
Œue
;

176 
	`msg
(
D_TLS_DEBUG
, "%s: ignoring general‚ame fieldype %i",

177 
__func__
, 
Çme
->
ty³
);

181 
	`GENERAL_NAMES_ä“
(
ex‹nsiÚs
);

183  
»tv®
;

184 
	}
}

199 
»suÉ_t


200 
	$exŒaù_x509_f›ld_s¦
(
X509_NAME
 *
x509
, cÚ¡ *
f›ld_Çme
, *
out
,

201 
size
)

203 
Ï¡pos
 = -1;

204 
tmp
 = -1;

205 
X509_NAME_ENTRY
 *
x509Ã
 = 
NULL
;

206 
ASN1_STRING
 *
a¢1
 = 
NULL
;

207 *
buf
 = 
NULL
;

208 
ASN1_OBJECT
 *
f›ld_Çme_obj
 = 
	`OBJ_txt2obj
(
f›ld_Çme
, 0);

210 ià(
f›ld_Çme_obj
 =ğ
NULL
)

212 
	`msg
(
D_TLS_ERRORS
, "Inv®id X509‡‰ribu‹‚am'%s'", 
f›ld_Çme
);

213  
FAILURE
;

216 
	`ASSERT
(
size
 > 0);

217 *
out
 = '\0';

220 
Ï¡pos
 = 
tmp
;

221 
tmp
 = 
	`X509_NAME_g‘_šdex_by_OBJ
(
x509
, 
f›ld_Çme_obj
, 
Ï¡pos
);

222 } 
tmp
 > -1);

224 
	`ASN1_OBJECT_ä“
(
f›ld_Çme_obj
);

227 ià(
Ï¡pos
 == -1)

229  
FAILURE
;

232 
x509Ã
 = 
	`X509_NAME_g‘_’Œy
(
x509
, 
Ï¡pos
);

233 ià(!
x509Ã
)

235  
FAILURE
;

238 
a¢1
 = 
	`X509_NAME_ENTRY_g‘_d©a
(
x509Ã
);

239 ià(!
a¢1
)

241  
FAILURE
;

243 ià(
	`ASN1_STRING_to_UTF8
(&
buf
, 
a¢1
) < 0)

245  
FAILURE
;

248 
	`¡ºıyÁ
(
out
, (*)
buf
, 
size
);

251 cÚ¡ 
»suÉ_t
 
»t
 = (
	`¡¾’
((*)
buf
è< 
size
è? 
SUCCESS
 : 
FAILURE
;

252 
	`OPENSSL_ä“
(
buf
);

253  
»t
;

255 
	}
}

257 
»suÉ_t


258 
	$back’d_x509_g‘_u£ºame
(*
commÚ_Çme
, 
ú_Ën
,

259 *
x509_u£ºame_f›ld
, 
X509
 *
³”_û¹
)

261 #ifdeà
ENABLE_X509ALTUSERNAME


262 ià(
	`¡ºcmp
("ext:",
x509_u£ºame_f›ld
,4) == 0)

264 ià(!
	`exŒaù_x509_ex‹nsiÚ
(
³”_û¹
, 
x509_u£ºame_f›ld
+4, 
commÚ_Çme
, 
ú_Ën
))

266  
FAILURE
;

271 ià(
FAILURE
 =ğ
	`exŒaù_x509_f›ld_s¦
(
	`X509_g‘_subjeù_Çme
(
³”_û¹
),

272 
x509_u£ºame_f›ld
, 
commÚ_Çme
, 
ú_Ën
))

274  
FAILURE
;

277  
SUCCESS
;

278 
	}
}

281 
	$back’d_x509_g‘_£rŸl
(
İ’v²_x509_û¹_t
 *
û¹
, 
gc_¬’a
 *
gc
)

283 
ASN1_INTEGER
 *
a¢1_i
;

284 
BIGNUM
 *
bignum
;

285 *
İ’s¦_£rŸl
, *
£rŸl
;

287 
a¢1_i
 = 
	`X509_g‘_£rŸlNumb”
(
û¹
);

288 
bignum
 = 
	`ASN1_INTEGER_to_BN
(
a¢1_i
, 
NULL
);

289 
İ’s¦_£rŸl
 = 
	`BN_bn2dec
(
bignum
);

291 
£rŸl
 = 
	`¡ršg_®loc
(
İ’s¦_£rŸl
, 
gc
);

293 
	`BN_ä“
(
bignum
);

294 
	`OPENSSL_ä“
(
İ’s¦_£rŸl
);

296  
£rŸl
;

297 
	}
}

300 
	$back’d_x509_g‘_£rŸl_hex
(
İ’v²_x509_û¹_t
 *
û¹
, 
gc_¬’a
 *
gc
)

302 cÚ¡ 
ASN1_INTEGER
 *
a¢1_i
 = 
	`X509_g‘_£rŸlNumb”
(
û¹
);

304  
	`fÜm©_hex_ex
(
a¢1_i
->
d©a
,‡¢1_i->
Ëngth
, 0, 1, ":", 
gc
);

305 
	}
}

307 
bufãr


308 
	$x509_g‘_sha1_fšg”´št
(
X509
 *
û¹
, 
gc_¬’a
 *
gc
)

310 cÚ¡ 
EVP_MD
 *
sha1
 = 
	`EVP_sha1
();

311 
bufãr
 
hash
 = 
	`®loc_buf_gc
(
	`EVP_MD_size
(
sha1
), 
gc
);

312 
	`X509_dige¡
(
û¹
, 
	`EVP_sha1
(), 
	`BPTR
(&
hash
), 
NULL
);

313 
	`ASSERT
(
	`buf_šc_Ën
(&
hash
, 
	`EVP_MD_size
(
sha1
)));

314  
hash
;

315 
	}
}

317 
bufãr


318 
	$x509_g‘_sha256_fšg”´št
(
X509
 *
û¹
, 
gc_¬’a
 *
gc
)

320 cÚ¡ 
EVP_MD
 *
sha256
 = 
	`EVP_sha256
();

321 
bufãr
 
hash
 = 
	`®loc_buf_gc
(
	`EVP_MD_size
(
sha256
), 
gc
);

322 
	`X509_dige¡
(
û¹
, 
	`EVP_sha256
(), 
	`BPTR
(&
hash
), 
NULL
);

323 
	`ASSERT
(
	`buf_šc_Ën
(&
hash
, 
	`EVP_MD_size
(
sha256
)));

324  
hash
;

325 
	}
}

328 
	$x509_g‘_subjeù
(
X509
 *
û¹
, 
gc_¬’a
 *
gc
)

330 
BIO
 *
subjeù_bio
 = 
NULL
;

331 
BUF_MEM
 *
subjeù_mem
;

332 *
subjeù
 = 
NULL
;

338 ià(
	`com·t_æag
(
COMPAT_FLAG_QUERY
 | 
COMPAT_NAMES
))

340 
subjeù
 = 
	`gc_m®loc
(256, 
çl£
, 
gc
);

341 
	`X509_NAME_Ú–še
(
	`X509_g‘_subjeù_Çme
(
û¹
), 
subjeù
, 256);

342 
subjeù
[255] = '\0';

343  
subjeù
;

346 
subjeù_bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

347 ià(
subjeù_bio
 =ğ
NULL
)

349 
”r
;

352 
	`X509_NAME_´št_ex
(
subjeù_bio
, 
	`X509_g‘_subjeù_Çme
(
û¹
),

353 0, 
XN_FLAG_SEP_CPLUS_SPC
 | 
XN_FLAG_FN_SN


354 |
ASN1_STRFLGS_UTF8_CONVERT
 | 
ASN1_STRFLGS_ESC_CTRL
);

356 ià(
	`BIO_eof
(
subjeù_bio
))

358 
”r
;

361 
	`BIO_g‘_mem_±r
(
subjeù_bio
, &
subjeù_mem
);

363 
subjeù
 = 
	`gc_m®loc
(
subjeù_mem
->
Ëngth
 + 1, 
çl£
, 
gc
);

365 
	`memıy
(
subjeù
, 
subjeù_mem
->
d©a
, subjeù_mem->
Ëngth
);

366 
subjeù
[
subjeù_mem
->
Ëngth
] = '\0';

368 
”r
:

369 ià(
subjeù_bio
)

371 
	`BIO_ä“
(
subjeù_bio
);

374  
subjeù
;

375 
	}
}

400 
	$x509_Œack_add
(cÚ¡ 
x509_Œack
 **
Î_h—d
, cÚ¡ *
Çme
, 
msgËv–
, 
gc_¬’a
 *
gc
)

402 
x509_Œack
 *
xt
;

403 
	`ALLOC_OBJ_CLEAR_GC
(
xt
, 
x509_Œack
, 
gc
);

404 ià(*
Çme
 == '+')

406 
xt
->
æags
 |ğ
XT_FULL_CHAIN
;

407 ++
Çme
;

409 
xt
->
Çme
 =‚ame;

410 
xt
->
nid
 = 
	`OBJ_txt2nid
(
Çme
);

411 ià(
xt
->
nid
 !ğ
NID_undef
)

413 
xt
->
Ãxt
 = *
Î_h—d
;

414 *
Î_h—d
 = 
xt
;

418 
	`msg
(
msgËv–
, "x509_Œack:‚Øsuch‡‰ribu‹ '%s'", 
Çme
);

420 
	}
}

424 
	$do_£‹nv_x509
(
’v_£t
 *
es
, cÚ¡ *
Çme
, *
v®ue
, 
d•th
)

426 *
Çme_ex·nd
;

427 
size_t
 
Çme_ex·nd_size
;

429 
	`¡ršg_mod
(
v®ue
, 
CC_ANY
, 
CC_CRLF
, '?');

430 
	`msg
(
D_X509_ATTR
, "X509 ATTRIBUTE‚ame='%s' v®ue='%s' d•th=%d", 
Çme
, 
v®ue
, 
d•th
);

431 
Çme_ex·nd_size
 = 64 + 
	`¡¾’
(
Çme
);

432 
Çme_ex·nd
 = (*è
	`m®loc
(
Çme_ex·nd_size
);

433 
	`check_m®loc_»tuº
(
Çme_ex·nd
);

434 
	`İ’v²_¢´štf
(
Çme_ex·nd
, 
Çme_ex·nd_size
, "X509_%d_%s", 
d•th
, 
Çme
);

435 
	`£‹nv_¡r
(
es
, 
Çme_ex·nd
, 
v®ue
);

436 
	`ä“
(
Çme_ex·nd
);

437 
	}
}

440 
	$x509_£‹nv_Œack
(cÚ¡ 
x509_Œack
 *
xt
, 
’v_£t
 *
es
, cÚ¡ 
d•th
, 
X509
 *
x509
)

442 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

443 
X509_NAME
 *
x509_Çme
 = 
	`X509_g‘_subjeù_Çme
(
x509
);

444 cÚ¡ 
nuÎc
 = '\0';

446 
xt
)

448 ià(
d•th
 =ğ0 || (
xt
->
æags
 & 
XT_FULL_CHAIN
))

450 
xt
->
nid
)

452 
NID_sha1
:

453 
NID_sha256
:

455 
bufãr
 
å_buf
;

456 *
å_¡r
 = 
NULL
;

458 ià(
xt
->
nid
 =ğ
NID_sha1
)

460 
å_buf
 = 
	`x509_g‘_sha1_fšg”´št
(
x509
, &
gc
);

464 
å_buf
 = 
	`x509_g‘_sha256_fšg”´št
(
x509
, &
gc
);

467 
å_¡r
 = 
	`fÜm©_hex_ex
(
	`BPTR
(&
å_buf
), 
	`BLEN
(&fp_buf), 0,

468 1 | 
FHE_CAPS
, ":", &
gc
);

469 
	`do_£‹nv_x509
(
es
, 
xt
->
Çme
, 
å_¡r
, 
d•th
);

475 
i
 = 
	`X509_NAME_g‘_šdex_by_NID
(
x509_Çme
, 
xt
->
nid
, -1);

476 ià(
i
 >= 0)

478 
X509_NAME_ENTRY
 *
’t
 = 
	`X509_NAME_g‘_’Œy
(
x509_Çme
, 
i
);

479 ià(
’t
)

481 
ASN1_STRING
 *
v®
 = 
	`X509_NAME_ENTRY_g‘_d©a
(
’t
);

482 *
buf
;

483 
buf
 = (*)1;

484 ià(
	`ASN1_STRING_to_UTF8
(&
buf
, 
v®
) >= 0)

486 
	`do_£‹nv_x509
(
es
, 
xt
->
Çme
, (*)
buf
, 
d•th
);

487 
	`OPENSSL_ä“
(
buf
);

493 
i
 = 
	`X509_g‘_ext_by_NID
(
x509
, 
xt
->
nid
, -1);

494 ià(
i
 >= 0)

496 
X509_EXTENSION
 *
ext
 = 
	`X509_g‘_ext
(
x509
, 
i
);

497 ià(
ext
)

499 
BIO
 *
bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

500 ià(
bio
)

502 ià(
	`X509V3_EXT_´št
(
bio
, 
ext
, 0, 0))

504 ià(
	`BIO_wr™e
(
bio
, &
nuÎc
, 1) == 1)

506 *
¡r
;

507 
	`BIO_g‘_mem_d©a
(
bio
, &
¡r
);

508 
	`do_£‹nv_x509
(
es
, 
xt
->
Çme
, 
¡r
, 
d•th
);

511 
	`BIO_ä“
(
bio
);

519 
xt
 = xt->
Ãxt
;

521 
	`gc_ä“
(&
gc
);

522 
	}
}

530 
	$x509_£‹nv
(
’v_£t
 *
es
, 
û¹_d•th
, 
İ’v²_x509_û¹_t
 *
³”_û¹
)

532 
i
, 
n
;

533 
â_nid
;

534 
ASN1_OBJECT
 *
â
;

535 
ASN1_STRING
 *
v®
;

536 
X509_NAME_ENTRY
 *
’t
;

537 cÚ¡ *
objbuf
;

538 *
buf
;

539 *
Çme_ex·nd
;

540 
size_t
 
Çme_ex·nd_size
;

541 
X509_NAME
 *
x509
 = 
	`X509_g‘_subjeù_Çme
(
³”_û¹
);

543 
n
 = 
	`X509_NAME_’Œy_couÁ
(
x509
);

544 
i
 = 0; i < 
n
; ++i)

546 
’t
 = 
	`X509_NAME_g‘_’Œy
(
x509
, 
i
);

547 ià(!
’t
)

551 
â
 = 
	`X509_NAME_ENTRY_g‘_objeù
(
’t
);

552 ià(!
â
)

556 
v®
 = 
	`X509_NAME_ENTRY_g‘_d©a
(
’t
);

557 ià(!
v®
)

561 
â_nid
 = 
	`OBJ_obj2nid
(
â
);

562 ià(
â_nid
 =ğ
NID_undef
)

566 
objbuf
 = 
	`OBJ_nid2¢
(
â_nid
);

567 ià(!
objbuf
)

571 
buf
 = (*)1;

572 ià(
	`ASN1_STRING_to_UTF8
(&
buf
, 
v®
) < 0)

576 
Çme_ex·nd_size
 = 64 + 
	`¡¾’
(
objbuf
);

577 
Çme_ex·nd
 = (*è
	`m®loc
(
Çme_ex·nd_size
);

578 
	`check_m®loc_»tuº
(
Çme_ex·nd
);

579 
	`İ’v²_¢´štf
(
Çme_ex·nd
, 
Çme_ex·nd_size
, "X509_%d_%s", 
û¹_d•th
,

580 
objbuf
);

581 
	`¡ršg_mod
(
Çme_ex·nd
, 
CC_PRINT
, 
CC_CRLF
, '_');

582 
	`¡ršg_mod
((*)
buf
, 
CC_PRINT
, 
CC_CRLF
, '_');

583 
	`£‹nv_¡r_šü
(
es
, 
Çme_ex·nd
, (*)
buf
);

584 
	`ä“
(
Çme_ex·nd
);

585 
	`OPENSSL_ä“
(
buf
);

587 
	}
}

589 
»suÉ_t


590 
	$x509_v”ify_ns_û¹_ty³
(
İ’v²_x509_û¹_t
 *
³”_û¹
, cÚ¡ 
u§ge
)

592 ià(
u§ge
 =ğ
NS_CERT_CHECK_NONE
)

594  
SUCCESS
;

596 ià(
u§ge
 =ğ
NS_CERT_CHECK_CLIENT
)

602 
»suÉ_t
 
»suÉ
 = 
	`X509_check_pu½o£
(
³”_û¹
, 
X509_PURPOSE_SSL_CLIENT
, 0) ?

603 
SUCCESS
 : 
FAILURE
;

610 ià(
»suÉ
 =ğ
FAILURE
)

612 
ASN1_BIT_STRING
 *
ns
;

613 
ns
 = 
	`X509_g‘_ext_d2i
(
³”_û¹
, 
NID_Ãtsÿ³_û¹_ty³
, 
NULL
, NULL);

614 
»suÉ
 = (
ns
 &&‚s->
Ëngth
 > 0 && (ns->
d©a
[0] & 
NS_SSL_CLIENT
)è? 
SUCCESS
 : 
FAILURE
;

615 ià(
»suÉ
 =ğ
SUCCESS
)

617 
	`msg
(
M_WARN
, "X509: Certificate is‡ client certificate yet it's…urpose "

620 
	`ASN1_BIT_STRING_ä“
(
ns
);

622  
»suÉ
;

624 ià(
u§ge
 =ğ
NS_CERT_CHECK_SERVER
)

630 
»suÉ_t
 
»suÉ
 = 
	`X509_check_pu½o£
(
³”_û¹
, 
X509_PURPOSE_SSL_SERVER
, 0) ?

631 
SUCCESS
 : 
FAILURE
;

638 ià(
»suÉ
 =ğ
FAILURE
)

640 
ASN1_BIT_STRING
 *
ns
;

641 
ns
 = 
	`X509_g‘_ext_d2i
(
³”_û¹
, 
NID_Ãtsÿ³_û¹_ty³
, 
NULL
, NULL);

642 
»suÉ
 = (
ns
 &&‚s->
Ëngth
 > 0 && (ns->
d©a
[0] & 
NS_SSL_SERVER
)è? 
SUCCESS
 : 
FAILURE
;

643 ià(
»suÉ
 =ğ
SUCCESS
)

645 
	`msg
(
M_WARN
, "X509: Certificate is‡ server certificate yet it's…urpose "

648 
	`ASN1_BIT_STRING_ä“
(
ns
);

650  
»suÉ
;

653  
FAILURE
;

654 
	}
}

656 
»suÉ_t


657 
	$x509_v”ify_û¹_ku
(
X509
 *
x509
, cÚ¡ *cÚ¡ 
ex³ùed_ku
,

658 
ex³ùed_Ën
)

660 
ASN1_BIT_STRING
 *
ku
 = 
	`X509_g‘_ext_d2i
(
x509
, 
NID_key_u§ge
, 
NULL
, NULL);

662 ià(
ku
 =ğ
NULL
)

664 
	`msg
(
D_TLS_ERRORS
, "Certificate does‚ot have key usageƒxtension");

665  
FAILURE
;

668 ià(
ex³ùed_ku
[0] =ğ
OPENVPN_KU_REQUIRED
)

671 
	`ASN1_BIT_STRING_ä“
(
ku
);

672  
SUCCESS
;

675 
nku
 = 0;

676 
size_t
 
i
 = 0; i < 8; i++)

678 ià(
	`ASN1_BIT_STRING_g‘_b™
(
ku
, 
i
))

680 
nku
 |ğ1 << (7 - 
i
);

687 ià((
nku
 & 0xff) == 0)

689 
nku
 >>= 8;

692 
	`msg
(
D_HANDSHAKE
, "Validating certificate key usage");

693 
»suÉ_t
 
fFound
 = 
FAILURE
;

694 
size_t
 
i
 = 0; 
fFound
 !ğ
SUCCESS
 && i < 
ex³ùed_Ën
; i++)

696 ià(
ex³ùed_ku
[
i
] !ğ0 && (
nku
 &ƒxpected_ku[i]) ==ƒxpected_ku[i])

698 
fFound
 = 
SUCCESS
;

702 ià(
fFound
 !ğ
SUCCESS
)

704 
	`msg
(
D_TLS_ERRORS
,

705 "ERROR: C”tifiÿ‹ ha key u§g%04x,ƒx³ùed oÃ of:", 
nku
);

706 
size_t
 
i
 = 0; i < 
ex³ùed_Ën
 && 
ex³ùed_ku
[i]; i++)

708 
	`msg
(
D_TLS_ERRORS
, " * %04x", 
ex³ùed_ku
[
i
]);

712 
	`ASN1_BIT_STRING_ä“
(
ku
);

714  
fFound
;

715 
	}
}

717 
»suÉ_t


718 
	$x509_v”ify_û¹_eku
(
X509
 *
x509
, cÚ¡ *cÚ¡ 
ex³ùed_oid
)

720 
EXTENDED_KEY_USAGE
 *
eku
 = 
NULL
;

721 
»suÉ_t
 
fFound
 = 
FAILURE
;

723 ià((
eku
 = (
EXTENDED_KEY_USAGE
 *è
	`X509_g‘_ext_d2i
(
x509
, 
NID_ext_key_u§ge
,

724 
NULL
, NULL)) == NULL)

726 
	`msg
(
D_HANDSHAKE
, "Certificate does‚ot haveƒxtended key usageƒxtension");

730 
i
;

732 
	`msg
(
D_HANDSHAKE
, "Validating certificateƒxtended key usage");

733 
i
 = 0; 
SUCCESS
 !ğ
fFound
 && i < 
	`sk_ASN1_OBJECT_num
(
eku
); i++)

735 
ASN1_OBJECT
 *
oid
 = 
	`sk_ASN1_OBJECT_v®ue
(
eku
, 
i
);

736 
szOid
[1024];

738 ià(
SUCCESS
 !ğ
fFound
 && 
	`OBJ_obj2txt
(
szOid
, (szOid), 
oid
, 0) != -1)

740 
	`msg
(
D_HANDSHAKE
, "++ Certificate has EKU (str) %s,ƒxpects %s",

741 
szOid
, 
ex³ùed_oid
);

742 ià(!
	`¡rcmp
(
ex³ùed_oid
, 
szOid
))

744 
fFound
 = 
SUCCESS
;

747 ià(
SUCCESS
 !ğ
fFound
 && 
	`OBJ_obj2txt
(
szOid
, (szOid), 
oid
, 1) != -1)

749 
	`msg
(
D_HANDSHAKE
, "++ Certificate has EKU (oid) %s,ƒxpects %s",

750 
szOid
, 
ex³ùed_oid
);

751 ià(!
	`¡rcmp
(
ex³ùed_oid
, 
szOid
))

753 
fFound
 = 
SUCCESS
;

759 ià(
eku
 !ğ
NULL
)

761 
	`sk_ASN1_OBJECT_pİ_ä“
(
eku
, 
ASN1_OBJECT_ä“
);

764  
fFound
;

765 
	}
}

767 
»suÉ_t


768 
	$x509_wr™e_³m
(
FILE
 *
³”û¹_fe
, 
X509
 *
³”û¹
)

770 ià(
	`PEM_wr™e_X509
(
³”û¹_fe
, 
³”û¹
) < 0)

772 
	`msg
(
M_ERR
, "Failedo write…eer certificate in PEM format");

773  
FAILURE
;

775  
SUCCESS
;

776 
	}
}

778 
boŞ


779 
	$s_v”ify_ül_missšg
(cÚ¡ 
s_İtiÚs
 *
İt
)

781 ià(!
İt
->
ül_fe
 || (İt->
s¦_æags
 & 
SSLF_CRL_VERIFY_DIR
))

783  
çl£
;

786 
X509_STORE
 *
¡Üe
 = 
	`SSL_CTX_g‘_û¹_¡Üe
(
İt
->
s¦_ùx
.
ùx
);

787 ià(!
¡Üe
)

789 
	`üy±o_msg
(
M_FATAL
, "Cannot get certificate store");

792 
	`STACK_OF
(
X509_OBJECT
è*
objs
 = 
	`X509_STORE_g‘0_objeùs
(
¡Üe
);

793 
i
 = 0; i < 
	`sk_X509_OBJECT_num
(
objs
); i++)

795 
X509_OBJECT
 *
obj
 = 
	`sk_X509_OBJECT_v®ue
(
objs
, 
i
);

796 
	`ASSERT
(
obj
);

797 ià(
	`X509_OBJECT_g‘_ty³
(
obj
è=ğ
X509_LU_CRL
)

799  
çl£
;

802  
Œue
;

803 
	}
}

	@ssl_verify_openssl.h

30 #iâdeà
SSL_VERIFY_OPENSSL_H_


31 
	#SSL_VERIFY_OPENSSL_H_


	)

33 
	~<İ’s¦/x509.h
>

35 #iâdeà
__OPENVPN_X509_CERT_T_DECLARED


36 
	#__OPENVPN_X509_CERT_T_DECLARED


	)

37 
X509
 
	tİ’v²_x509_û¹_t
;

71 
v”ify_ÿÎback
(
´ev”ify_ok
, 
X509_STORE_CTX
 *
ùx
);

	@status.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 
	~"¡©us.h
"

33 
	~"³rf.h
"

34 
	~"misc.h
"

35 
	~"fdmisc.h
"

37 
	~"memdbg.h
"

44 
	$´št_¡©us_mode
(
æags
)

46 
æags
)

48 
STATUS_OUTPUT_WRITE
:

51 
STATUS_OUTPUT_READ
:

54 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
:

60 
	}
}

62 
¡©us_ouut
 *

63 
	$¡©us_İ’
(cÚ¡ *
f’ame
,

64 cÚ¡ 
»äesh_äeq
,

65 cÚ¡ 
msgËv–
,

66 cÚ¡ 
vœtu®_ouut
 *
vout
,

67 cÚ¡ 
æags
)

69 
¡©us_ouut
 *
so
 = 
NULL
;

70 ià(
f’ame
 || 
msgËv–
 >ğ0 || 
vout
)

72 
	`ALLOC_OBJ_CLEAR
(
so
, 
¡©us_ouut
);

73 
so
->
æags
 = flags;

74 
so
->
msgËv–
 = msglevel;

75 
so
->
vout
 = vout;

76 
so
->
fd
 = -1;

77 
	`buf_»£t
(&
so
->
»ad_buf
);

78 
	`ev’t_timeout_ş—r
(&
so
->
‘
);

79 ià(
f’ame
)

81 
so
->
æags
)

83 
STATUS_OUTPUT_WRITE
:

84 
so
->
fd
 = 
	`¶©fÜm_İ’
(
f’ame
,

85 
O_CREAT
 | 
O_TRUNC
 | 
O_WRONLY
,

86 
S_IRUSR
 | 
S_IWUSR
);

89 
STATUS_OUTPUT_READ
:

90 
so
->
fd
 = 
	`¶©fÜm_İ’
(
f’ame
,

91 
O_RDONLY
,

92 
S_IRUSR
 | 
S_IWUSR
);

95 
STATUS_OUTPUT_READ
|
STATUS_OUTPUT_WRITE
:

96 
so
->
fd
 = 
	`¶©fÜm_İ’
(
f’ame
,

97 
O_CREAT
 | 
O_RDWR
,

98 
S_IRUSR
 | 
S_IWUSR
);

102 
	`ASSERT
(0);

104 ià(
so
->
fd
 >= 0)

106 
so
->
f’ame
 = 
	`¡ršg_®loc
(f’ame, 
NULL
);

107 
	`£t_şÛxec
(
so
->
fd
);

110 ià(
so
->
æags
 & 
STATUS_OUTPUT_READ
)

112 
so
->
»ad_buf
 = 
	`®loc_buf
(512);

117 
	`msg
(
M_WARN
, "NÙe: cªnÙ o³À% fÜ %s", 
f’ame
, 
	`´št_¡©us_mode
(
so
->
æags
));

118 
so
->
”rÜs
 = 
Œue
;

123 
so
->
æags
 = 
STATUS_OUTPUT_WRITE
;

126 ià((
so
->
æags
 & 
STATUS_OUTPUT_WRITE
è&& 
»äesh_äeq
 > 0)

128 
	`ev’t_timeout_š™
(&
so
->
‘
, 
»äesh_äeq
, 0);

131  
so
;

132 
	}
}

134 
boŞ


135 
	$¡©us_Œigg”
(
¡©us_ouut
 *
so
)

137 ià(
so
)

139 
timev®
 
nuÎ
;

140 
	`CLEAR
(
nuÎ
);

141  
	`ev’t_timeout_Œigg”
(&
so
->
‘
, &
nuÎ
, 
ETT_DEFAULT
);

145  
çl£
;

147 
	}
}

149 
boŞ


150 
	$¡©us_Œigg”_tv
(
¡©us_ouut
 *
so
, 
timev®
 *
tv
)

152 ià(
so
)

154  
	`ev’t_timeout_Œigg”
(&
so
->
‘
, 
tv
, 
ETT_DEFAULT
);

158  
çl£
;

160 
	}
}

163 
	$¡©us_»£t
(
¡©us_ouut
 *
so
)

165 ià(
so
 && so->
fd
 >= 0)

167 
	`l£ek
(
so
->
fd
, (
off_t
)0, 
SEEK_SET
);

169 
	}
}

172 
	$¡©us_æush
(
¡©us_ouut
 *
so
)

174 ià(
so
 && so->
fd
 >ğ0 && (so->
æags
 & 
STATUS_OUTPUT_WRITE
))

176 #ià
	`defšed
(
HAVE_FTRUNCATE
)

178 cÚ¡ 
off_t
 
off
 = 
	`l£ek
(
so
->
fd
, (off_t)0, 
SEEK_CUR
);

179 ià(
	`árunÿ‹
(
so
->
fd
, 
off
) != 0)

181 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Failedoruncate status file");

184 #–ià
	`defšed
(
HAVE_CHSIZE
)

186 cÚ¡ 
off
 = (è
	`l£ek
(
so
->
fd
, (
off_t
)0, 
SEEK_CUR
);

187 
	`chsize
(
so
->
fd
, 
off
);

190 #w¬nšg 
bÙh
 
árunÿ‹
 
ªd
 
chsize
 
funùiÚs
 
­³¬
 
to
 
be
 
missšg
 
äom
 
this
 
OS


194 ià(
	`buf_defšed
(&
so
->
»ad_buf
))

196 
	`ASSERT
(
	`buf_š™
(&
so
->
»ad_buf
, 0));

199 
	}
}

202 
boŞ


203 
	$¡©us_şo£
(
¡©us_ouut
 *
so
)

205 
boŞ
 
»t
 = 
Œue
;

206 ià(
so
)

208 ià(
so
->
”rÜs
)

210 
»t
 = 
çl£
;

212 ià(
so
->
fd
 >= 0)

214 ià(
	`şo£
(
so
->
fd
) < 0)

216 
»t
 = 
çl£
;

219 ià(
so
->
f’ame
)

221 
	`ä“
(
so
->
f’ame
);

223 ià(
	`buf_defšed
(&
so
->
»ad_buf
))

225 
	`ä“_buf
(&
so
->
»ad_buf
);

227 
	`ä“
(
so
);

231 
»t
 = 
çl£
;

233  
»t
;

234 
	}
}

236 
	#STATUS_PRINTF_MAXLEN
 512

	)

239 
	$¡©us_´štf
(
¡©us_ouut
 *
so
, cÚ¡ *
fÜm©
, ...)

241 ià(
so
 && (so->
æags
 & 
STATUS_OUTPUT_WRITE
))

243 
buf
[
STATUS_PRINTF_MAXLEN
+2];

244 
va_li¡
 
¬gli¡
;

245 
¡©
;

247 
	`va_¡¬t
(
¬gli¡
, 
fÜm©
);

248 
¡©
 = 
	`v¢´štf
(
buf
, 
STATUS_PRINTF_MAXLEN
, 
fÜm©
, 
¬gli¡
);

249 
	`va_’d
(
¬gli¡
);

250 
buf
[
STATUS_PRINTF_MAXLEN
 - 1] = 0;

252 ià(
¡©
 < 0 || sˆ>ğ
STATUS_PRINTF_MAXLEN
)

254 
so
->
”rÜs
 = 
Œue
;

257 ià(
so
->
msgËv–
 >ğ0 && !so->
”rÜs
)

259 
	`msg
(
so
->
msgËv–
, "%s", 
buf
);

262 ià(
so
->
fd
 >ğ0 && !so->
”rÜs
)

264 
Ën
;

265 
	`¡rÿt
(
buf
, "\n");

266 
Ën
 = 
	`¡¾’
(
buf
);

267 ià(
Ën
 > 0)

269 ià(
	`wr™e
(
so
->
fd
, 
buf
, 
Ën
) !=†en)

271 
so
->
”rÜs
 = 
Œue
;

276 ià(
so
->
vout
 && !so->
”rÜs
)

278 
	`chomp
(
buf
);

279 (*
so
->
vout
->
func
)(so->vout->
¬g
, so->vout->
æags_deçuÉ
, 
buf
);

282 
	}
}

284 
boŞ


285 
	$¡©us_»ad
(
¡©us_ouut
 *
so
, 
bufãr
 *
buf
)

287 
boŞ
 
»t
 = 
çl£
;

289 ià(
so
 && so->
fd
 >ğ0 && (so->
æags
 & 
STATUS_OUTPUT_READ
))

291 
	`ASSERT
(
	`buf_defšed
(&
so
->
»ad_buf
));

292 
	`ASSERT
(
	`buf_defšed
(
buf
));

293 
Œue
)

295 cÚ¡ 
c
 = 
	`buf_»ad_u8
(&
so
->
»ad_buf
);

298 ià(
c
 == -1)

300 
Ën
;

302 
	`ASSERT
(
	`buf_š™
(&
so
->
»ad_buf
, 0));

303 
Ën
 = 
	`»ad
(
so
->
fd
, 
	`BPTR
(&so->
»ad_buf
), 
	`BCAP
(&so->read_buf));

304 ià(
Ën
 <= 0)

309 
	`ASSERT
(
	`buf_šc_Ën
(&
so
->
»ad_buf
, 
Ën
));

313 
»t
 = 
Œue
;

315 ià(
c
 == '\r')

320 ià(
c
 == '\n')

325 
	`buf_wr™e_u8
(
buf
, 
c
);

328 
	`buf_nuÎ_‹rmš©e
(
buf
);

331  
»t
;

332 
	}
}

	@status.h

24 #iâdeà
STATUS_H


25 
	#STATUS_H


	)

27 
	~"š‹rv®.h
"

32 
	svœtu®_ouut
 {

33 *
	m¬g
;

34 
	mæags_deçuÉ
;

35 (*
	mfunc
è(*
	m¬g
, cÚ¡ 
	mæags
, cÚ¡ *
	m¡r
);

38 
šlše
 

39 
	$vœtu®_ouut_´št
(cÚ¡ 
vœtu®_ouut
 *
vo
, cÚ¡ 
æags
, cÚ¡ *
¡r
)

41 (*
vo
->
func
)(vo->
¬g
, 
æags
, 
¡r
);

42 
	}
}

48 
	s¡©us_ouut


50 
	#STATUS_OUTPUT_READ
 (1<<0)

	)

51 
	#STATUS_OUTPUT_WRITE
 (1<<1)

	)

52 
	mæags
;

54 *
	mf’ame
;

55 
	mfd
;

56 
	mmsgËv–
;

57 cÚ¡ 
vœtu®_ouut
 *
	mvout
;

59 
bufãr
 
	m»ad_buf
;

61 
ev’t_timeout
 
	m‘
;

63 
boŞ
 
	m”rÜs
;

66 
¡©us_ouut
 *
¡©us_İ’
(cÚ¡ *
f’ame
,

67 cÚ¡ 
»äesh_äeq
,

68 cÚ¡ 
msgËv–
,

69 cÚ¡ 
vœtu®_ouut
 *
vout
,

70 cÚ¡ 
æags
);

72 
boŞ
 
¡©us_Œigg”_tv
(
¡©us_ouut
 *
so
, 
timev®
 *
tv
);

74 
boŞ
 
¡©us_Œigg”
(
¡©us_ouut
 *
so
);

76 
¡©us_»£t
(
¡©us_ouut
 *
so
);

78 
¡©us_æush
(
¡©us_ouut
 *
so
);

80 
boŞ
 
¡©us_şo£
(
¡©us_ouut
 *
so
);

82 
	$¡©us_´štf
(
¡©us_ouut
 *
so
, cÚ¡ *
fÜm©
, ...)

83 #ifdeà
__GNUC__


84 #ià
__USE_MINGW_ANSI_STDIO


85 
	`__©Œibu‹__
 ((
	$fÜm©
(
gnu_´štf
, 2, 3)))

87 
	`__©Œibu‹__
 ((
	$fÜm©
(
__´štf__
, 2, 3)))

92 
boŞ
 
	`¡©us_»ad
(
¡©us_ouut
 *
so
, 
bufãr
 *
buf
);

94 
šlše
 

95 
	$¡©us_rw_æags
(cÚ¡ 
¡©us_ouut
 *
so
)

97 ià(
so
)

99  
so
->
æags
;

105 
	}
}

	@syshead.h

24 #iâdeà
SYSHEAD_H


25 
	#SYSHEAD_H


	)

27 
	~"com·t.h
"

28 
	~<¡dboŞ.h
>

31 #ià
defšed
(
__GNUC__
)

32 
	#lik–y
(
x
è
	`__butš_ex³ù
((x),1)

	)

33 
	#uÆik–y
(
x
è
	`__butš_ex³ù
((x),0)

	)

35 
	#lik–y
(
x
è(x)

	)

36 
	#uÆik–y
(
x
è(x)

	)

39 #ifdeà
_WIN32


40 
	~<wšdows.h
>

41 
	~<wšsock2.h
>

42 
	#¦“p
(
x
è
	`SË•
((x)*1000)

	)

43 
	#¿ndom
 
¿nd


	)

44 
	#¤ªdom
 
¤ªd


	)

47 #ifdeà
_MSC_VER


48 
	#__func__
 
__FUNCTION__


	)

49 
	#__©Œibu‹__
(
x
)

	)

52 #ià
defšed
(
__APPLE__
)

53 #ià
__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__
 >= 1070

54 
	#__APPLE_USE_RFC_3542
 1

	)

58 #ifdeà
HAVE_SYS_TYPES_H


59 
	~<sys/ty³s.h
>

62 #ifdeà
HAVE_SYS_WAIT_H


63 
	~<sys/wa™.h
>

66 #iâdeà
_WIN32


67 #iâdeà
WEXITSTATUS


68 
	#WEXITSTATUS
(
¡©_v®
è(()(¡©_v®è>> 8)

	)

70 #iâdeà
WIFEXITED


71 
	#WIFEXITED
(
¡©_v®
è(((¡©_v®è& 255è=ğ0)

	)

75 #ifdeà
HAVE_SYS_TIME_H


76 
	~<sys/time.h
>

79 #ifdeà
HAVE_TIME_H


80 
	~<time.h
>

83 #ifdeà
HAVE_SYS_SOCKET_H


84 
	~<sys/sock‘.h
>

87 #ifdeà
HAVE_SYS_UN_H


88 
	~<sys/un.h
>

91 #ifdeà
HAVE_SYS_IOCTL_H


92 
	~<sys/ioùl.h
>

95 #ifdeà
HAVE_SYS_STAT_H


96 
	~<sys/¡©.h
>

99 #ifdeà
HAVE_FCNTL_H


100 
	~<fú.h
>

103 #ifdeà
HAVE_DIRECT_H


104 
	~<dœeù.h
>

107 #ifdeà
HAVE_IO_H


108 
	~<io.h
>

111 #ifdeà
HAVE_SYS_FILE_H


112 
	~<sys/fe.h
>

115 #ifdeà
HAVE_STDLIB_H


116 
	~<¡dlib.h
>

119 #ifdeà
HAVE_INTTYPES_H


120 
	~<š‰y³s.h
>

121 #–ià
defšed
(
HAVE_STDINT_H
)

122 
	~<¡dšt.h
>

125 #ifdeà
HAVE_STDARG_H


126 
	~<¡d¬g.h
>

129 #ifdeà
HAVE_UNISTD_H


130 
	~<uni¡d.h
>

133 #ifdeà
HAVE_SIGNAL_H


134 
	~<sigÇl.h
>

137 #ifdeà
HAVE_LIMITS_H


138 
	~<lim™s.h
>

141 #ifdeà
HAVE_STDIO_H


142 
	~<¡dio.h
>

145 #ifdeà
HAVE_CTYPE_H


146 
	~<ùy³.h
>

149 #ifdeà
HAVE_ERRNO_H


150 
	~<”ºo.h
>

153 #ifdeà
HAVE_ERR_H


154 
	~<”r.h
>

157 #ifdeà
HAVE_SYSLOG_H


158 
	~<sy¦og.h
>

161 #ifdeà
HAVE_PWD_H


162 
	~<pwd.h
>

165 #ifdeà
HAVE_GRP_H


166 
	~<g½.h
>

169 #ifdeà
HAVE_NETDB_H


170 
	~<Ãtdb.h
>

173 #ifdeà
HAVE_NETINET_IN_H


174 
	~<Ãtš‘/š.h
>

177 #ifdeà
HAVE_RESOLV_H


178 
	~<»sŞv.h
>

181 #ifdeà
HAVE_SYS_POLL_H


182 
	~<sys/pŞl.h
>

185 #ifdeà
HAVE_SYS_EPOLL_H


186 
	~<sys/•Şl.h
>

189 #ifdeà
ENABLE_SELINUX


190 
	~<£lšux/£lšux.h
>

193 #ià
defšed
(
HAVE_LIBGEN_H
)

194 
	~<libg’.h
>

197 #ifdeà
TARGET_SOLARIS


198 #ifdeà
HAVE_STRINGS_H


199 
	~<¡ršgs.h
>

202 #ifdeà
HAVE_STRING_H


203 
	~<¡ršg.h
>

207 #ifdeà
HAVE_ARPA_INET_H


208 
	~<¬·/š‘.h
>

211 #ifdeà
HAVE_NET_IF_H


212 
	~<Ãt/if.h
>

215 #ifdeà
TARGET_NETBSD


216 
	~<Ãt/if_p.h
>

219 #ià
defšed
(
TARGET_LINUX
è|| defšed (
TARGET_ANDROID
)

221 #ifdeà
HAVE_LINUX_IF_TUN_H


222 
	~<lšux/if_tun.h
>

225 #ifdeà
HAVE_NETINET_IP_H


226 
	~<Ãtš‘/.h
>

229 #ifdeà
HAVE_LINUX_SOCKIOS_H


230 
	~<lšux/sockios.h
>

233 #ifdeà
HAVE_LINUX_TYPES_H


234 
	~<lšux/ty³s.h
>

237 #ifdeà
HAVE_LINUX_ERRQUEUE_H


238 
	~<lšux/”rqueue.h
>

241 #ifdeà
HAVE_NETINET_TCP_H


242 
	~<Ãtš‘/tı.h
>

247 #ifdeà
TARGET_SOLARIS


249 #ifdeà
HAVE_STROPTS_H


250 
	~<¡rİts.h
>

251 #undeà
S_ERROR


254 #ifdeà
HAVE_NET_IF_TUN_H


255 
	~<Ãt/if_tun.h
>

258 #ifdeà
HAVE_SYS_SOCKIO_H


259 
	~<sys/sockio.h
>

262 #ifdeà
HAVE_NETINET_IN_SYSTM_H


263 
	~<Ãtš‘/š_sy¡m.h
>

266 #ifdeà
HAVE_NETINET_IP_H


267 
	~<Ãtš‘/.h
>

270 #ifdeà
HAVE_NETINET_TCP_H


271 
	~<Ãtš‘/tı.h
>

276 #ifdeà
TARGET_OPENBSD


278 #ifdeà
HAVE_SYS_UIO_H


279 
	~<sys/uio.h
>

282 #ifdeà
HAVE_NETINET_IN_SYSTM_H


283 
	~<Ãtš‘/š_sy¡m.h
>

286 #ifdeà
HAVE_NETINET_IP_H


287 
	~<Ãtš‘/.h
>

290 #ifdeà
HAVE_NETINET_TCP_H


291 
	~<Ãtš‘/tı.h
>

294 #ifdeà
HAVE_NET_IF_TUN_H


295 
	~<Ãt/if_tun.h
>

300 #ifdeà
TARGET_FREEBSD


302 #ifdeà
HAVE_SYS_UIO_H


303 
	~<sys/uio.h
>

306 #ifdeà
HAVE_NETINET_IN_SYSTM_H


307 
	~<Ãtš‘/š_sy¡m.h
>

310 #ifdeà
HAVE_NETINET_IP_H


311 
	~<Ãtš‘/.h
>

314 #ifdeà
HAVE_NETINET_TCP_H


315 
	~<Ãtš‘/tı.h
>

318 #ifdeà
HAVE_NET_IF_TUN_H


319 
	~<Ãt/if_tun.h
>

324 #ifdeà
TARGET_NETBSD


326 #ifdeà
HAVE_NET_IF_TUN_H


327 
	~<Ãt/if_tun.h
>

330 #ifdeà
HAVE_NETINET_TCP_H


331 
	~<Ãtš‘/tı.h
>

336 #ifdeà
TARGET_DRAGONFLY


338 #ifdeà
HAVE_SYS_UIO_H


339 
	~<sys/uio.h
>

342 #ifdeà
HAVE_NETINET_IN_SYSTM_H


343 
	~<Ãtš‘/š_sy¡m.h
>

346 #ifdeà
HAVE_NETINET_IP_H


347 
	~<Ãtš‘/.h
>

350 #ifdeà
HAVE_NET_TUN_IF_TUN_H


351 
	~<Ãt/tun/if_tun.h
>

356 #ifdeà
TARGET_DARWIN


358 #ifdeà
HAVE_NETINET_TCP_H


359 
	~<Ãtš‘/tı.h
>

364 #ifdeà
_WIN32


367 
	tMIB_TCP_STATE
;

369 
	~<Ç±y³s.h
>

370 
	~<Áddndis.h
>

371 
	~<hÍ­i.h
>

372 
	~<wšš‘.h
>

373 
	~<sh–Ïpi.h
>

375 
	~<wšsock2.h
>

376 
	~<ws2tı.h
>

379 #ifdeà
HAVE_SYS_MMAN_H


380 #ifdeà
TARGET_DARWIN


381 
	#_P1003_1B_VISIBLE


	)

383 
	~<sys/mmª.h
>

390 #ifdeà
PEDANTIC


391 #undeà
HAVE_CPP_VARARG_MACRO_GCC


392 #undeà
HAVE_CPP_VARARG_MACRO_ISO


393 #undeà
EMPTY_ARRAY_SIZE


394 
	#EMPTY_ARRAY_SIZE
 1

	)

395 #undeà
šlše


396 
	#šlše


	)

402 #ià
defšed
(
IPPROTO_IP
è&& defšed(
IP_TOS
è&& defšed(
HAVE_SETSOCKOPT
)

403 
	#PASSTOS_CAPABILITY
 1

	)

405 
	#PASSTOS_CAPABILITY
 0

	)

411 #ià
defšed
(
HAVE_GETTIMEOFDAY
è|| defšed(
_WIN32
)

412 
	#HAVE_GETTIMEOFDAY_NANOSECONDS
 1

	)

418 #ià
defšed
(
HAVE_LINUX_TYPES_H
è&& defšed(
HAVE_LINUX_ERRQUEUE_H
è&& defšed(
HAVE_SOCK_EXTENDED_ERR
è&& defšed(
HAVE_MSGHDR
è&& defšed(
HAVE_CMSGHDR
è&& defšed(
CMSG_FIRSTHDR
è&& defšed(
CMSG_NXTHDR
è&& defšed(
IP_RECVERR
è&& defšed(
MSG_ERRQUEUE
è&& defšed(
SOL_IP
è&& defšed(
HAVE_IOVEC
)

419 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 1

	)

421 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 0

	)

428 #ià
defšed
(
ENABLE_MULTIHOME
è&& ((defšed(
HAVE_IN_PKTINFO
è&& defšed(
IP_PKTINFO
)è|| defšed(
IP_RECVDSTADDR
)è&& defšed(
HAVE_MSGHDR
è&& defšed(
HAVE_CMSGHDR
è&& defšed(
HAVE_IOVEC
è&& defšed(
CMSG_FIRSTHDR
è&& defšed(
CMSG_NXTHDR
è&& defšed(
HAVE_RECVMSG
è&& defšed(
HAVE_SENDMSG
)

429 
	#ENABLE_IP_PKTINFO
 1

	)

431 
	#ENABLE_IP_PKTINFO
 0

	)

438 #iâdeà
SOL_IP


439 
	#SOL_IP
 
IPPROTO_IP


	)

445 #iâdeà
HAVE_SA_FAMILY_T


446 
	t§_çmy_t
;

453 #undeà
EXTENDED_SOCKET_ERROR_CAPABILITY


454 
	#EXTENDED_SOCKET_ERROR_CAPABILITY
 0

	)

460 #ià
defšed
(
HAVE_OPENLOG
è&& defšed(
HAVE_SYSLOG
)

461 
	#SYSLOG_CAPABILITY
 1

	)

463 
	#SYSLOG_CAPABILITY
 0

	)

469 #iâdeà
O_BINARY


470 
	#O_BINARY
 0

	)

476 #ifdeà
_WIN32


477 
	#OS_SPECIFIC_DIRSEP
 '\\'

	)

479 
	#OS_SPECIFIC_DIRSEP
 '/'

	)

485 #ifdeà
_WIN32


486 
	#SOCKET_UNDEFINED
 (
INVALID_SOCKET
)

	)

487 
SOCKET
 
	tsock‘_desütÜ_t
;

489 
	#SOCKET_UNDEFINED
 (-1)

	)

490 
	tsock‘_desütÜ_t
;

493 
šlše
 

494 
	$sock‘_defšed
(cÚ¡ 
sock‘_desütÜ_t
 
sd
)

496  
sd
 !ğ
SOCKET_UNDEFINED
;

497 
	}
}

502 
	#USE_64_BIT_COUNTERS


	)

508 #ià
defšed
(
HAVE_EXECVE
è&& defšed(
HAVE_FORK
)

509 
	#ENABLE_FEATURE_EXECVE


	)

516 #ià
defšed
(
ENABLE_CRYPTO
è&& defšed(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

517 
	#P2MP
 1

	)

519 
	#P2MP
 0

	)

522 #ià
P2MP
 && !
defšed
(
ENABLE_CLIENT_ONLY
)

523 
	#P2MP_SERVER
 1

	)

525 
	#P2MP_SERVER
 0

	)

531 #ià
defšed
(
ENABLE_PORT_SHARE
è&& 
P2MP_SERVER
 && defšed(
SCM_RIGHTS
è&& defšed(
HAVE_MSGHDR
è&& defšed(
HAVE_CMSGHDR
è&& defšed(
HAVE_IOVEC
è&& defšed(
CMSG_FIRSTHDR
è&& defšed(
CMSG_NXTHDR
è&& defšed(
HAVE_RECVMSG
è&& defšed(
HAVE_SENDMSG
)

532 
	#PORT_SHARE
 1

	)

534 
	#PORT_SHARE
 0

	)

540 #ià
defšed
(
ENABLE_DEF_AUTH
è&& 
P2MP_SERVER
 && defšed(
ENABLE_PLUGIN
)

541 
	#PLUGIN_DEF_AUTH


	)

543 #ià
defšed
(
ENABLE_DEF_AUTH
è&& 
P2MP_SERVER
 && defšed(
ENABLE_MANAGEMENT
)

544 
	#MANAGEMENT_DEF_AUTH


	)

546 #ià!
defšed
(
PLUGIN_DEF_AUTH
è&& !defšed(
MANAGEMENT_DEF_AUTH
)

547 #undeà
ENABLE_DEF_AUTH


553 #ià
defšed
(
ENABLE_MANAGEMENT
è&& defšed(
ENABLE_CRYPTO
)

554 
	#MANAGMENT_EXTERNAL_KEY


	)

558 #ifdeà
ENABLE_CRYPTO_MBEDTLS


559 
	#ENABLE_PREDICTION_RESISTANCE


	)

566 #ià
defšed
(
MANAGEMENT_DEF_AUTH
è|| defšed(
MANAGMENT_EXTERNAL_KEY
)

567 
	#MANAGEMENT_IN_EXTRA


	)

573 #ià
defšed
(
ENABLE_PF
è&& 
P2MP_SERVER
 && defšed(
ENABLE_PLUGIN
è&& defšed(
HAVE_STAT
)

574 
	#PLUGIN_PF


	)

576 #ià
defšed
(
ENABLE_PF
è&& 
P2MP_SERVER
 && defšed(
MANAGEMENT_DEF_AUTH
)

577 
	#MANAGEMENT_PF


	)

579 #ià!
defšed
(
PLUGIN_PF
è&& !defšed(
MANAGEMENT_PF
)

580 #undeà
ENABLE_PF


586 #ià
defšed
(
PF_UNIX
è&& !defšed(
_WIN32
)

587 
	#UNIX_SOCK_SUPPORT
 1

	)

589 
	#UNIX_SOCK_SUPPORT
 0

	)

595 
	#ENABLE_OCC


	)

600 #ià
defšed
(
ENABLE_CRYPTO
)

601 
	#NTLM
 1

	)

603 
	#NTLM
 0

	)

609 #ià
defšed
(
ENABLE_CRYPTO
)

610 
	#PROXY_DIGEST_AUTH
 1

	)

612 
	#PROXY_DIGEST_AUTH
 0

	)

618 #ià
defšed
(
_WIN32
è&& defšed(
ENABLE_CRYPTO
è&& defšed(
ENABLE_CRYPTO_OPENSSL
)

619 
	#ENABLE_CRYPTOAPI


	)

625 #ià
defšed
(
HAVE_POLL
è&& defšed(
HAVE_SYS_POLL_H
)

626 
	#POLL
 1

	)

628 
	#POLL
 0

	)

634 #ià
defšed
(
HAVE_EPOLL_CREATE
è&& defšed(
HAVE_SYS_EPOLL_H
)

635 
	#EPOLL
 1

	)

637 
	#EPOLL
 0

	)

642 #undeà
EPOLL


643 
	#EPOLL
 0

	)

650 #ià
defšed
(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

651 
	#TIME_BACKTRACK_PROTECTION
 1

	)

657 #ià
defšed
(
HAVE_GETTIMEOFDAY_NANOSECONDS
)

658 
	#ENABLE_FEATURE_SHAPER
 1

	)

664 #ià
defšed
(
HAVE_GETSOCKOPT
è&& defšed(
SOL_SOCKET
è&& defšed(
SO_ERROR
è&& defšed(
EINPROGRESS
è&& defšed(
ETIMEDOUT
)

665 
	#CONNECT_NONBLOCK


	)

671 #ià
defšed
(
ENABLE_AUTO_USERID
)

672 
	#AUTO_USERID
 1

	)

674 
	#AUTO_USERID
 0

	)

680 #ià
defšed
(
ENABLE_MANAGEMENT
)

681 
	#ENABLE_CLIENT_CR


	)

687 #ià
defšed
(
ENABLE_CRYPTO
)

688 
	#ENABLE_PUSH_PEER_INFO


	)

694 #ià
defšed
(
ENABLE_LZO
è|| defšed(
ENABLE_LZ4
) \

695 || 
	$defšed
(
ENABLE_COMP_STUB
)

696 
	#USE_COMP


	)

702 #ifdeà
TARGET_LINUX


703 
	#ENABLE_MEMSTATS


	)

	@tls_crypt.c

24 #ifdeà
HAVE_CONFIG_H


25 
	~"cÚfig.h
"

26 #–ià
defšed
(
_MSC_VER
)

27 
	~"cÚfig-msvc.h
"

30 
	~"sysh—d.h
"

32 #ifdeà
ENABLE_CRYPTO


33 
	~"üy±o.h
"

34 
	~"£ssiÚ_id.h
"

36 
	~"s_üy±.h
"

38 
key_ty³


39 
	$s_üy±_kt
()

41 
key_ty³
 
kt
;

42 
kt
.
ch”
 = 
	`ch”_kt_g‘
("AES-256-CTR");

43 
kt
.
dige¡
 = 
	`md_kt_g‘
("SHA256");

45 ià(!
kt
.
ch”
)

47 
	`msg
(
M_WARN
, "ERROR: --tls-crypt„equires AES-256-CTR support.");

48  (
key_ty³
) { 0 };

50 ià(!
kt
.
dige¡
)

52 
	`msg
(
M_WARN
, "ERROR: --tls-crypt„equires HMAC-SHA-256 support.");

53  (
key_ty³
) { 0 };

56 
kt
.
ch”_Ëngth
 = 
	`ch”_kt_key_size
(kt.
ch”
);

57 
kt
.
hmac_Ëngth
 = 
	`md_kt_size
(kt.
dige¡
);

59  
kt
;

60 
	}
}

63 
	$s_üy±_buf_ov”h—d
()

65  
	`·ck‘_id_size
(
Œue
è+ 
TLS_CRYPT_TAG_SIZE
 + 
TLS_CRYPT_BLOCK_SIZE
;

66 
	}
}

69 
	$s_üy±_š™_key
(
key_ùx_bi
 *
key
, cÚ¡ *
key_fe
,

70 cÚ¡ *
key_šlše
, 
boŞ
 
s_£rv”
)

72 cÚ¡ 
key_dœeùiÚ
 = 
s_£rv”
 ?

73 
KEY_DIRECTION_NORMAL
 : 
KEY_DIRECTION_INVERSE
;

74 
key_ty³
 
kt
 = 
	`s_üy±_kt
();

75 ià(!
kt
.
ch”
 || !kt.
dige¡
)

77 
	`msg
 (
M_FATAL
, "ERROR: --tls-crypt‚ot supported");

79 
	`üy±o_»ad_İ’v²_key
(&
kt
, 
key
, 
key_fe
, 
key_šlše
, 
key_dœeùiÚ
,

81 
	}
}

84 
	$s_üy±_adju¡_äame_·¿m‘”s
(
äame
 *frame)

86 
	`äame_add_to_exŒa_äame
(
äame
, 
	`s_üy±_buf_ov”h—d
());

88 
	`msg
(
D_MTU_DEBUG
, "%s: Adjusting frame…arameters forls-crypt by %i bytes",

89 
__func__
, 
	`s_üy±_buf_ov”h—d
());

90 
	}
}

93 
boŞ


94 
	$s_üy±_w¿p
(cÚ¡ 
bufãr
 *
¤c
, bufã¸*
d¡
,

95 
üy±o_İtiÚs
 *
İt
)

97 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
’üy±
;

98 
gc_¬’a
 
gc
;

101 
	`ASSERT
(
ùx
->
ch”
);

102 
	`ASSERT
(
ùx
->
hmac
);

103 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
));

104 
	`ASSERT
(
	`hmac_ùx_size
(
ùx
->
hmac
) == 256/8);

106 
	`gc_š™
(&
gc
);

108 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT WRAP FROM: %s",

109 
	`fÜm©_hex
(
	`BPTR
(
¤c
), 
	`BLEN
(¤c), 80, &
gc
));

112 ià(!
	`·ck‘_id_wr™e
(&
İt
->
·ck‘_id
.
£nd
, 
d¡
, 
Œue
, 
çl£
))

114 
	`msg
(
D_CRYPT_ERRORS
, "TLS-CRYPT ERROR:…acket ID„oll over.");

115 
”r
;

118 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT WRAP AD: %s",

119 
	`fÜm©_hex
(
	`BPTR
(
d¡
), 
	`BLEN
(d¡), 0, &
gc
));

122 ià(!
	`buf_§ã
(
d¡
, 
	`BLEN
(
¤c
è+ 
TLS_CRYPT_BLOCK_SIZE
 + 
TLS_CRYPT_TAG_SIZE
))

124 
	`msg
(
D_CRYPT_ERRORS
, "TLS-CRYPT WRAP: buffer sizeƒrror, "

125 "sc=%d so=%d sl=%d dc=%d do=%d dl=%d", 
¤c
->
ÿ·c™y
, src->
off£t
,

126 
¤c
->
Ën
, 
d¡
->
ÿ·c™y
, d¡->
off£t
, dst->len);

127 
”r
;

132 
ušt8_t
 *
g
 = 
NULL
;

133 
	`hmac_ùx_»£t
(
ùx
->
hmac
);

134 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
	`BPTR
(
d¡
), 
	`BLEN
(dst));

135 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
	`BPTR
(
¤c
), 
	`BLEN
(src));

137 
	`ASSERT
(
g
 = 
	`buf_wr™e_®loc
(
d¡
, 
TLS_CRYPT_TAG_SIZE
));

138 
	`hmac_ùx_fš®
(
ùx
->
hmac
, 
g
);

140 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT WRAP TAG: %s",

141 
	`fÜm©_hex
(
g
, 
TLS_CRYPT_TAG_SIZE
, 0, &
gc
));

144 
	`ASSERT
(
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
g
));

149 
ou’
 = 0;

150 
	`ASSERT
(
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BEND
(
d¡
), &
ou’
,

151 
	`BPTR
(
¤c
), 
	`BLEN
(src)));

152 
	`ASSERT
(
	`buf_šc_Ën
(
d¡
, 
ou’
));

153 
	`ASSERT
(
	`ch”_ùx_fš®
(
ùx
->
ch”
, 
	`BPTR
(
d¡
), &
ou’
));

154 
	`ASSERT
(
	`buf_šc_Ën
(
d¡
, 
ou’
));

157 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT WRAP TO: %s",

158 
	`fÜm©_hex
(
	`BPTR
(
d¡
), 
	`BLEN
(d¡), 80, &
gc
));

160 
	`gc_ä“
(&
gc
);

161  
Œue
;

163 
”r
:

164 
	`üy±o_ş—r_”rÜ
();

165 
d¡
->
Ën
 = 0;

166 
	`gc_ä“
(&
gc
);

167  
çl£
;

168 
	}
}

170 
boŞ


171 
	$s_üy±_unw¿p
(cÚ¡ 
bufãr
 *
¤c
, bufã¸*
d¡
,

172 
üy±o_İtiÚs
 *
İt
)

174 cÚ¡ 
”rÜ_´efix
[] = "tls-crypt unwrapƒrror";

175 cÚ¡ 
key_ùx
 *
ùx
 = &
İt
->
key_ùx_bi
.
deüy±
;

176 
gc_¬’a
 
gc
;

178 
	`gc_š™
(&
gc
);

180 
	`ASSERT
(
İt
);

181 
	`ASSERT
(
¤c
->
Ën
 > 0);

182 
	`ASSERT
(
ùx
->
ch”
);

183 
	`ASSERT
(
	`·ck‘_id_š™Ÿlized
(&
İt
->
·ck‘_id
)

184 || (
İt
->
æags
 & 
CO_IGNORE_PACKET_ID
));

186 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT UNWRAP FROM: %s",

187 
	`fÜm©_hex
(
	`BPTR
(
¤c
), 
	`BLEN
(¤c), 80, &
gc
));

189 ià(
	`buf_Ën
(
¤c
è< 
TLS_CRYPT_OFF_CT
)

191 
	`CRYPT_ERROR
("packetoo short");

196 
ou’
 = 0;

199 ià(!
	`buf_§ã
(
d¡
, 
	`BLEN
(
¤c
è- 
TLS_CRYPT_OFF_CT
 + 
TLS_CRYPT_BLOCK_SIZE
))

201 
	`CRYPT_ERROR
("potential buffer overflow");

204 ià(!
	`ch”_ùx_»£t
(
ùx
->
ch”
, 
	`BPTR
(
¤c
è+ 
TLS_CRYPT_OFF_TAG
))

206 
	`CRYPT_ERROR
("cipher„eset failed");

208 ià(!
	`ch”_ùx_upd©e
(
ùx
->
ch”
, 
	`BPTR
(
d¡
), &
ou’
,

209 
	`BPTR
(
¤c
è+ 
TLS_CRYPT_OFF_CT
, 
	`BLEN
(src) - TLS_CRYPT_OFF_CT))

211 
	`CRYPT_ERROR
("cipher update failed");

213 
	`ASSERT
(
	`buf_šc_Ën
(
d¡
, 
ou’
));

214 ià(!
	`ch”_ùx_fš®
(
ùx
->
ch”
, 
	`BPTR
(
d¡
), &
ou’
))

216 
	`CRYPT_ERROR
("cipher final failed");

218 
	`ASSERT
(
	`buf_šc_Ën
(
d¡
, 
ou’
));

223 cÚ¡ 
ušt8_t
 *
g
 = 
	`BPTR
(
¤c
è+ 
TLS_CRYPT_OFF_TAG
;

224 
ušt8_t
 
g_check
[
TLS_CRYPT_TAG_SIZE
] = { 0 };

226 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT UNWRAP AD: %s",

227 
	`fÜm©_hex
(
	`BPTR
(
¤c
), 
TLS_CRYPT_OFF_TAG
, 0, &
gc
));

228 
	`dmsg
(
D_PACKET_CONTENT
, "TLS-CRYPT UNWRAP TO: %s",

229 
	`fÜm©_hex
(
	`BPTR
(
d¡
), 
	`BLEN
(d¡), 80, &
gc
));

231 
	`hmac_ùx_»£t
(
ùx
->
hmac
);

232 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
	`BPTR
(
¤c
), 
TLS_CRYPT_OFF_TAG
);

233 
	`hmac_ùx_upd©e
(
ùx
->
hmac
, 
	`BPTR
(
d¡
), 
	`BLEN
(dst));

234 
	`hmac_ùx_fš®
(
ùx
->
hmac
, 
g_check
);

236 ià(
	`memcmp_cÚ¡ªt_time
(
g
, 
g_check
, (tag_check)))

238 
	`dmsg
(
D_CRYPTO_DEBUG
, "tag : %s",

239 
	`fÜm©_hex
(
g
, (
g_check
), 0, &
gc
));

240 
	`dmsg
(
D_CRYPTO_DEBUG
, "tag_check: %s",

241 
	`fÜm©_hex
(
g_check
, Ñag_check), 0, &
gc
));

242 
	`CRYPT_ERROR
("packet‡uthentication failed");

247 ià(!(
İt
->
æags
 & 
CO_IGNORE_PACKET_ID
))

249 
·ck‘_id_Ãt
 
pš
;

250 
bufãr
 
tmp
 = *
¤c
;

251 
	`ASSERT
(
	`buf_advªû
(&
tmp
, 
TLS_CRYPT_OFF_PID
));

252 
	`ASSERT
(
	`·ck‘_id_»ad
(&
pš
, &
tmp
, 
Œue
));

253 ià(!
	`üy±o_check_»¶ay
(
İt
, &
pš
, 
”rÜ_´efix
, &
gc
))

255 
	`CRYPT_ERROR
("packet„eplay");

259 
	`gc_ä“
(&
gc
);

260  
Œue
;

262 
”rÜ_ex™
:

263 
	`üy±o_ş—r_”rÜ
();

264 
d¡
->
Ën
 = 0;

265 
	`gc_ä“
(&
gc
);

266  
çl£
;

267 
	}
}

	@tls_crypt.h

74 #iâdeà
TLSCRYPT_H


75 
	#TLSCRYPT_H


	)

77 #ifdeà
ENABLE_CRYPTO


79 
	~"bufãr.h
"

80 
	~"üy±o.h
"

81 
	~"£ssiÚ_id.h
"

83 
	#TLS_CRYPT_TAG_SIZE
 (256/8)

	)

84 
	#TLS_CRYPT_PID_SIZE
 ((
·ck‘_id_ty³
è+ (
Ãt_time_t
))

	)

85 
	#TLS_CRYPT_BLOCK_SIZE
 (128/8)

	)

87 
	#TLS_CRYPT_OFF_PID
 (1 + 
SID_SIZE
)

	)

88 
	#TLS_CRYPT_OFF_TAG
 (
TLS_CRYPT_OFF_PID
 + 
TLS_CRYPT_PID_SIZE
)

	)

89 
	#TLS_CRYPT_OFF_CT
 (
TLS_CRYPT_OFF_TAG
 + 
TLS_CRYPT_TAG_SIZE
)

	)

101 
s_üy±_š™_key
(
key_ùx_bi
 *
key
, cÚ¡ *
key_fe
,

102 cÚ¡ *
key_šlše
, 
boŞ
 
s_£rv”
);

108 
s_üy±_buf_ov”h—d
();

113 
s_üy±_adju¡_äame_·¿m‘”s
(
äame
 *frame);

126 
boŞ
 
s_üy±_w¿p
(cÚ¡ 
bufãr
 *
¤c
, bufã¸*
d¡
,

127 
üy±o_İtiÚs
 *
İt
);

140 
boŞ
 
s_üy±_unw¿p
(cÚ¡ 
bufãr
 *
¤c
, bufã¸*
d¡
,

141 
üy±o_İtiÚs
 *
İt
);

	@tun.c

32 #ifdeà
HAVE_CONFIG_H


33 
	~"cÚfig.h
"

34 #–ià
defšed
(
_MSC_VER
)

35 
	~"cÚfig-msvc.h
"

38 
	~"sysh—d.h
"

40 
	~"tun.h
"

41 
	~"fdmisc.h
"

42 
	~"commÚ.h
"

43 
	~"misc.h
"

44 
	~"sock‘.h
"

45 
	~"mªage.h
"

46 
	~"rou‹.h
"

47 
	~"wš32.h
"

48 
	~"block_dns.h
"

50 
	~"memdbg.h
"

52 #ifdeà
_WIN32


53 
	~"İ’v²-msg.h
"

56 
	~<¡ršg.h
>

58 #ifdeà
_WIN32


62 
	#NI_TEST_FIRST
 (1<<0)

	)

63 
	#NI_IP_NETMASK
 (1<<1)

	)

64 
	#NI_OPTIONS
 (1<<2)

	)

66 
Ãtsh_ifcÚfig
(cÚ¡ 
tuÁ­_İtiÚs
 *
to
,

67 cÚ¡ *
æex_Çme
,

68 cÚ¡ 
š_addr_t
 

,

69 cÚ¡ 
š_addr_t
 
Ãtmask
,

70 cÚ¡ 
æags
);

72 
Ãtsh_£t_dns6_£rv”s
(cÚ¡ 
š6_addr
 *
addr_li¡
,

73 cÚ¡ 
addr_Ën
,

74 cÚ¡ *
æex_Çme
);

76 
Ãtsh_commªd
(cÚ¡ 
¬gv
 *
a
, 
n
, 
msgËv–
);

78 cÚ¡ *
Ãtsh_g‘_id
(cÚ¡ *
dev_node
, 
gc_¬’a
 *
gc
);

80 
DWORD
 
g‘_ad­‹r_šdex_æexibË
(cÚ¡ *
Çme
);

82 
boŞ


83 
	$do_add»ss_£rviû
(cÚ¡ 
boŞ
 
add
, cÚ¡ 
çmy
, cÚ¡ 
tuÁ­
 *
‰
)

85 
DWORD
 
Ën
;

86 
boŞ
 
»t
 = 
çl£
;

87 
ack_mes§ge_t
 
ack
;

88 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

89 
HANDLE
 
pe
 = 
‰
->
İtiÚs
.
msg_chªÃl
;

91 
add»ss_mes§ge_t
 
addr
 = {

92 .
h—d”
 = {

93 (
add
 ? 
msg_add_add»ss
 : 
msg_d–_add»ss
),

94 (
add»ss_mes§ge_t
),

97 .
çmy
 = family,

98 .
içû
 = { .
šdex
 = 
‰
->
ad­‹r_šdex
, .
Çme
 = "" }

101 ià(
addr
.
içû
.
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

103 
	`¡ºıy
(
addr
.
içû
.
Çme
, 
‰
->
aùu®_Çme
, (addr.iface.name));

104 
addr
.
içû
.
Çme
[(addr.iface.name) - 1] = '\0';

107 ià(
addr
.
çmy
 =ğ
AF_INET
)

109 
addr
.
add»ss
.
v4
.
s_addr
 = 
‰
->
loÿl
;

110 
addr
.
´efix_Ën
 = 32;

114 
addr
.
add»ss
.
v6
 = 
‰
->
loÿl_v6
;

115 
addr
.
´efix_Ën
 = 
‰
->
Ãtb™s_v6
;

118 ià(!
	`Wr™eFe
(
pe
, &
addr
, ×ddr), &
Ën
, 
NULL
)

119 || !
	`R—dFe
(
pe
, &
ack
, ×ck), &
Ën
, 
NULL
))

121 
	`msg
(
M_WARN
, "TUN: could‚otalko service: %s [%lu]",

122 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

123 
out
;

126 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

128 
	`msg
(
M_WARN
, "TUN: %s‡ddress failed using service: %s [status=%u if_index=%d]",

129 (
add
 ? "addšg" : "d–‘šg"), 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),

130 
ack
.
”rÜ_numb”
, 
addr
.
içû
.
šdex
);

131 
out
;

134 
»t
 = 
Œue
;

136 
out
:

137 
	`gc_ä“
(&
gc
);

138  
»t
;

139 
	}
}

141 
boŞ


142 
	$do_dns6_£rviû
(
boŞ
 
add
, cÚ¡ 
tuÁ­
 *
‰
)

144 
DWORD
 
Ën
;

145 
boŞ
 
»t
 = 
çl£
;

146 
ack_mes§ge_t
 
ack
;

147 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

148 
HANDLE
 
pe
 = 
‰
->
İtiÚs
.
msg_chªÃl
;

149 
addr_Ën
 = 
add
 ? 
‰
->
İtiÚs
.
dns6_Ën
 : 0;

151 ià(
addr_Ën
 =ğ0 && 
add
)

153  
Œue
;

156 
dns_cfg_mes§ge_t
 
dns
 = {

157 .
h—d”
 = {

158 (
add
 ? 
msg_add_dns_cfg
 : 
msg_d–_dns_cfg
),

159 (
dns_cfg_mes§ge_t
),

162 .
içû
 = { .
šdex
 = 
‰
->
ad­‹r_šdex
, .
Çme
 = "" },

163 .
domašs
 = "",

164 .
çmy
 = 
AF_INET6
,

165 .
addr_Ën
 =‡ddr_len

169 
	`¡ºıy
(
dns
.
içû
.
Çme
, 
‰
->
aùu®_Çme
, (dns.iface.name));

170 
dns
.
içû
.
Çme
[(dns.iface.name) - 1] = '\0';

172 ià(
addr_Ën
 > 
	`_couÁof
(
dns
.
addr
))

174 
addr_Ën
 = 
	`_couÁof
(
dns
.
addr
);

175 
dns
.
addr_Ën
 =‡ddr_len;

176 
	`msg
(
M_WARN
, "Number of IPv6 DNS‡ddresses sento serviceruncatedo %d",

177 
addr_Ën
);

180 
i
 = 0; i < 
addr_Ën
; ++i)

182 
dns
.
addr
[
i
].
v6
 = 
‰
->
İtiÚs
.
dns6
[i];

185 
	`msg
(
D_LOW
, "%s IPv6 dns servers on '%s' (if_index = %d) using service",

186 (
add
 ? "S‘tšg" : "D–‘šg"), 
dns
.
içû
.
Çme
, dns.içû.
šdex
);

188 ià(!
	`Wr™eFe
(
pe
, &
dns
, (dns), &
Ën
, 
NULL
)

189 || !
	`R—dFe
(
pe
, &
ack
, ×ck), &
Ën
, 
NULL
))

191 
	`msg
(
M_WARN
, "TUN: could‚otalko service: %s [%lu]",

192 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

193 
out
;

196 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

198 
	`msg
(
M_WARN
, "TUN: %s IPv6 dns failed using service: %s [status=%u if_name=%s]",

199 (
add
 ? "addšg" : "d–‘šg"), 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),

200 
ack
.
”rÜ_numb”
, 
dns
.
içû
.
Çme
);

201 
out
;

204 
	`msg
(
M_INFO
, "IPv6 dn £rv” % usšg s”viû", (
add
 ? "set" : "deleted"));

205 
»t
 = 
Œue
;

207 
out
:

208 
	`gc_ä“
(&
gc
);

209  
»t
;

210 
	}
}

214 #ifdeà
TARGET_SOLARIS


215 
sŞ¬is_”rÜ_şo£
(
tuÁ­
 *
‰
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ *
aùu®
, 
boŞ
 
uÅlumb_š‘6
);

217 
	~<¡rİts.h
>

220 #ià
defšed
(
TARGET_DARWIN
è&& 
HAVE_NET_IF_UTUN_H


221 
	~<sys/k”n_cÚŒŞ.h
>

222 
	~<Ãt/if_utun.h
>

223 
	~<sys/sys_domaš.h
>

226 
ş—r_tuÁ­
(
tuÁ­
 *tuntap);

228 
boŞ


229 
	$is_dev_ty³
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
m©ch_ty³
)

231 
	`ASSERT
(
m©ch_ty³
);

232 ià(!
dev
)

234  
çl£
;

236 ià(
dev_ty³
)

238  !
	`¡rcmp
(
dev_ty³
, 
m©ch_ty³
);

242  !
	`¡ºcmp
(
dev
, 
m©ch_ty³
, 
	`¡¾’
(match_type));

244 
	}
}

247 
	$dev_ty³_’um
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
)

249 ià(
	`is_dev_ty³
(
dev
, 
dev_ty³
, "tun"))

251  
DEV_TYPE_TUN
;

253 ià(
	`is_dev_ty³
(
dev
, 
dev_ty³
, "tap"))

255  
DEV_TYPE_TAP
;

257 ià(
	`is_dev_ty³
(
dev
, 
dev_ty³
, "null"))

259  
DEV_TYPE_NULL
;

263  
DEV_TYPE_UNDEF
;

265 
	}
}

268 
	$dev_ty³_¡ršg
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
)

270 
	`dev_ty³_’um
(
dev
, 
dev_ty³
))

272 
DEV_TYPE_TUN
:

275 
DEV_TYPE_TAP
:

278 
DEV_TYPE_NULL
:

284 
	}
}

291 
	$guess_tuÁ­_dev
(cÚ¡ *
dev
,

292 cÚ¡ *
dev_ty³
,

293 cÚ¡ *
dev_node
,

294 
gc_¬’a
 *
gc
)

296 #ifdeà
_WIN32


297 cÚ¡ 
dt
 = 
	`dev_ty³_’um
(
dev
, 
dev_ty³
);

298 ià(
dt
 =ğ
DEV_TYPE_TUN
 || dˆ=ğ
DEV_TYPE_TAP
)

300  
	`Ãtsh_g‘_id
(
dev_node
, 
gc
);

305  
dev
;

306 
	}
}

310 cÚ¡ 
	gifcÚfig_w¬n_how_to_s’û
[] = "(silencehis warning with --ifconfig-nowarn)";

320 
	$ifcÚfig_§n™y_check
(
boŞ
 
tun
, 
š_addr_t
 
addr
, 
tİŞogy
)

322 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

323 cÚ¡ 
boŞ
 
looks_like_Ãtmask
 = ((
addr
 & 0xFF000000) == 0xFF000000);

324 ià(
tun
)

326 ià(
looks_like_Ãtmask
 && (
tİŞogy
 =ğ
TOP_NET30
 ||İŞogy =ğ
TOP_P2P
))

328 
	`msg
(
M_WARN
, "WARNING: Since you‡re using --devun with‡…oint-to-pointopology,he second‡rgumento --ifconfig must be‡n IP‡ddress. You‡re using something (%s)hat†ooks more†ike‡‚etmask. %s",

329 
	`´št_š_addr_t
(
addr
, 0, &
gc
),

330 
ifcÚfig_w¬n_how_to_s’û
);

335 ià(!
looks_like_Ãtmask
)

337 
	`msg
(
M_WARN
, "WARNING: Since you‡re using --devap,he second‡rgumento --ifconfig must be‡‚etmask, forƒxample something†ike 255.255.255.0. %s",

338 
ifcÚfig_w¬n_how_to_s’û
);

341 
	`gc_ä“
(&
gc
);

342 
	}
}

347 
š_addr_t


348 
	$g’”©e_ifcÚfig_brßdÿ¡_addr
(
š_addr_t
 
loÿl
,

349 
š_addr_t
 
Ãtmask
)

351  
loÿl
 | ~
Ãtmask
;

352 
	}
}

359 
	$check_addr_şash
(cÚ¡ *
Çme
,

360 
ty³
,

361 
š_addr_t
 
public
,

362 
š_addr_t
 
loÿl
,

363 
š_addr_t
 
»mÙe_Ãtmask
)

365 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

367 
	`msg
(
M_INFO
, "CHECK_ADDR_CLASHype=%d…ublic=%s†ocal=%s,„emote_netmask=%s",

368 
ty³
,

369 
	`´št_š_addr_t
(
public
, 0, &
gc
),

370 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

371 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 0, &
gc
));

374 ià(
public
)

376 ià(
ty³
 =ğ
DEV_TYPE_TUN
)

378 cÚ¡ 
š_addr_t
 
‹¡_Ãtmask
 = 0xFFFFFF00;

379 cÚ¡ 
š_addr_t
 
public_Ãt
 = 
public
 & 
‹¡_Ãtmask
;

380 cÚ¡ 
š_addr_t
 
loÿl_Ãt
 = 
loÿl
 & 
‹¡_Ãtmask
;

381 cÚ¡ 
š_addr_t
 
»mÙe_Ãt
 = 
»mÙe_Ãtmask
 & 
‹¡_Ãtmask
;

383 ià(
public
 =ğ
loÿl
 ||…ubliø=ğ
»mÙe_Ãtmask
)

385 
	`msg
(
M_WARN
,

387 
Çme
,

388 
	`´št_š_addr_t
(
public
, 0, &
gc
),

389 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

390 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 0, &
gc
),

391 
ifcÚfig_w¬n_how_to_s’û
);

394 ià(
public_Ãt
 =ğ
loÿl_Ãt
 ||…ublic_Ãˆ=ğ
»mÙe_Ãt
)

396 
	`msg
(
M_WARN
,

398 
Çme
,

399 
	`´št_š_addr_t
(
public
, 0, &
gc
),

400 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

401 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 0, &
gc
),

402 
ifcÚfig_w¬n_how_to_s’û
);

405 ià(
ty³
 =ğ
DEV_TYPE_TAP
)

407 cÚ¡ 
š_addr_t
 
public_ÃtwÜk
 = 
public
 & 
»mÙe_Ãtmask
;

408 cÚ¡ 
š_addr_t
 
vœtu®_ÃtwÜk
 = 
loÿl
 & 
»mÙe_Ãtmask
;

409 ià(
public_ÃtwÜk
 =ğ
vœtu®_ÃtwÜk
)

411 
	`msg
(
M_WARN
,

413 
Çme
,

414 
	`´št_š_addr_t
(
public
, 0, &
gc
),

415 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

416 
	`´št_š_addr_t
(
»mÙe_Ãtmask
, 0, &
gc
),

417 
ifcÚfig_w¬n_how_to_s’û
);

421 
	`gc_ä“
(&
gc
);

422 
	}
}

432 
	$check_subÃt_cÚæiù
(cÚ¡ 
š_addr_t
 

,

433 cÚ¡ 
š_addr_t
 
Ãtmask
,

434 cÚ¡ *
´efix
)

437 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

438 
š_addr_t
 
Ïn_gw
 = 0;

439 
š_addr_t
 
Ïn_Ãtmask
 = 0;

441 ià(
	`g‘_deçuÉ_g©eway
(&
Ïn_gw
, &
Ïn_Ãtmask
) &&†an_netmask)

443 cÚ¡ 
š_addr_t
 
Ïn_ÃtwÜk
 = 
Ïn_gw
 & 
Ïn_Ãtmask
;

444 cÚ¡ 
š_addr_t
 
ÃtwÜk
 = 

 & 
Ãtmask
;

447 ià((
ÃtwÜk
 & 
Ïn_Ãtmask
è=ğ
Ïn_ÃtwÜk


448 || (
Ïn_ÃtwÜk
 & 
Ãtmask
è=ğ
ÃtwÜk
)

450 
	`msg
(
M_WARN
, "WARNING:…otential %s subnet conflict between†ocal LAN [%s/%s]‡nd„emote VPN [%s/%s]",

451 
´efix
,

452 
	`´št_š_addr_t
(
Ïn_ÃtwÜk
, 0, &
gc
),

453 
	`´št_š_addr_t
(
Ïn_Ãtmask
, 0, &
gc
),

454 
	`´št_š_addr_t
(
ÃtwÜk
, 0, &
gc
),

455 
	`´št_š_addr_t
(
Ãtmask
, 0, &
gc
));

458 
	`gc_ä“
(&
gc
);

460 
	}
}

463 
	$w¬n_Ú_u£_of_commÚ_subÃts
()

465 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

466 
rou‹_g©eway_šfo
 
rgi
;

467 cÚ¡ 
Ãeded
 = (
RGI_ADDR_DEFINED
|
RGI_NETMASK_DEFINED
);

469 
	`g‘_deçuÉ_g©eway
(&
rgi
);

470 ià((
rgi
.
æags
 & 
Ãeded
) ==‚eeded)

472 cÚ¡ 
š_addr_t
 
Ïn_ÃtwÜk
 = 
rgi
.
g©eway
.
addr
 &„gi.g©eway.
Ãtmask
;

473 ià(
Ïn_ÃtwÜk
 == 0xC0A80000 ||†an_network == 0xC0A80100)

475 
	`msg
(
M_WARN
, "NOTE: your†ocal LAN usesheƒxtremely common subnet‡ddress 192.168.0.x or 192.168.1.x. Be‡warehathis might create„outing conflicts if you connectohe VPN server from…ublic†ocations such‡s internet cafeshat usehe same subnet.");

478 
	`gc_ä“
(&
gc
);

479 
	}
}

486 
	$ifcÚfig_İtiÚs_¡ršg
(cÚ¡ 
tuÁ­
 *
‰
, 
boŞ
 
»mÙe
, boŞ 
di§bË
, 
gc_¬’a
 *
gc
)

488 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

489 ià(
‰
->
did_ifcÚfig_£tup
 && !
di§bË
)

491 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
 || (‰->ty³ =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
))

493 
	`buf_´štf
(&
out
, "%s %s",

494 
	`´št_š_addr_t
(
‰
->
loÿl
 &t->
»mÙe_Ãtmask
, 0, 
gc
),

495 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, 
gc
));

497 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

499 cÚ¡ *
l
, *
r
;

500 ià(
»mÙe
)

502 
r
 = 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, 
gc
);

503 
l
 = 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, 
gc
);

507 
l
 = 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, 
gc
);

508 
r
 = 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, 
gc
);

510 
	`buf_´štf
(&
out
, "% %s", 
r
, 
l
);

514 
	`buf_´štf
(&
out
, "[undef]");

517  
	`BSTR
(&
out
);

518 
	}
}

524 
	$tun_¡©
(cÚ¡ 
tuÁ­
 *
‰
, 
rwæags
, 
gc_¬’a
 *
gc
)

526 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, 
gc
);

527 ià(
‰
)

529 ià(
rwæags
 & 
EVENT_READ
)

531 
	`buf_´štf
(&
out
, "T%s",

532 (
‰
->
rwæags_debug
 & 
EVENT_READ
) ? "R" : "r");

533 #ifdeà
_WIN32


534 
	`buf_´štf
(&
out
, "%s",

535 
	`ov”Ïµed_io_¡©e_ascii
(&
‰
->
»ads
));

538 ià(
rwæags
 & 
EVENT_WRITE
)

540 
	`buf_´štf
(&
out
, "T%s",

541 (
‰
->
rwæags_debug
 & 
EVENT_WRITE
) ? "W" : "w");

542 #ifdeà
_WIN32


543 
	`buf_´štf
(&
out
, "%s",

544 
	`ov”Ïµed_io_¡©e_ascii
(&
‰
->
wr™es
));

550 
	`buf_´štf
(&
out
, "T?");

552  
	`BSTR
(&
out
);

553 
	}
}

558 
boŞ


559 
	$is_tun_p2p
(cÚ¡ 
tuÁ­
 *
‰
)

561 
boŞ
 
tun
 = 
çl£
;

563 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP


564 || (
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

565 || 
‰
->
ty³
 =ğ
DEV_TYPE_NULL
 )

567 
tun
 = 
çl£
;

569 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

571 
tun
 = 
Œue
;

575 
	`msg
(
M_FATAL
, "Error:…roblem withun vs.ap setting");

578  
tun
;

579 
	}
}

585 
	$do_ifcÚfig_£‹nv
(cÚ¡ 
tuÁ­
 *
‰
, 
’v_£t
 *
es
)

587 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

588 cÚ¡ *
ifcÚfig_loÿl
 = 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
);

589 cÚ¡ *
ifcÚfig_»mÙe_Ãtmask
 = 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, &
gc
);

594 ià(
‰
->
did_ifcÚfig_£tup
)

596 
boŞ
 
tun
 = 
	`is_tun_p2p
(
‰
);

598 
	`£‹nv_¡r
(
es
, "ifcÚfig_loÿl", 
ifcÚfig_loÿl
);

599 ià(
tun
)

601 
	`£‹nv_¡r
(
es
, "ifcÚfig_»mÙe", 
ifcÚfig_»mÙe_Ãtmask
);

605 cÚ¡ *
ifcÚfig_brßdÿ¡
 = 
	`´št_š_addr_t
(
‰
->
brßdÿ¡
, 0, &
gc
);

606 
	`£‹nv_¡r
(
es
, "ifcÚfig_Ãtmask", 
ifcÚfig_»mÙe_Ãtmask
);

607 
	`£‹nv_¡r
(
es
, "ifcÚfig_brßdÿ¡", 
ifcÚfig_brßdÿ¡
);

611 ià(
‰
->
did_ifcÚfig_v6_£tup
)

613 cÚ¡ *
ifcÚfig_v6_loÿl
 = 
	`´št_š6_addr
(
‰
->
loÿl_v6
, 0, &
gc
);

614 cÚ¡ *
ifcÚfig_v6_»mÙe
 = 
	`´št_š6_addr
(
‰
->
»mÙe_v6
, 0, &
gc
);

616 
	`£‹nv_¡r
(
es
, "ifcÚfig_v6_loÿl", 
ifcÚfig_v6_loÿl
);

617 
	`£‹nv_št
(
es
, "ifcÚfig_v6_Ãtb™s", 
‰
->
Ãtb™s_v6
);

618 
	`£‹nv_¡r
(
es
, "ifcÚfig_v6_»mÙe", 
ifcÚfig_v6_»mÙe
);

621 
	`gc_ä“
(&
gc
);

622 
	}
}

630 
tuÁ­
 *

631 
	$š™_tun
(cÚ¡ *
dev
,

632 cÚ¡ *
dev_ty³
,

633 
tİŞogy
,

634 cÚ¡ *
ifcÚfig_loÿl_·rm
,

635 cÚ¡ *
ifcÚfig_»mÙe_Ãtmask_·rm
,

636 cÚ¡ *
ifcÚfig_v6_loÿl_·rm
,

637 
ifcÚfig_v6_Ãtb™s_·rm
,

638 cÚ¡ *
ifcÚfig_v6_»mÙe_·rm
,

639 
addršfo
 *
loÿl_public
,

640 
addršfo
 *
»mÙe_public
,

641 cÚ¡ 
boŞ
 
¡riù_w¬n
,

642 
’v_£t
 *
es
)

644 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

645 
tuÁ­
 *
‰
;

647 
	`ALLOC_OBJ
(
‰
, 
tuÁ­
);

648 
	`ş—r_tuÁ­
(
‰
);

650 
‰
->
ty³
 = 
	`dev_ty³_’um
(
dev
, 
dev_ty³
);

651 
‰
->
tİŞogy
 =opology;

653 ià(
ifcÚfig_loÿl_·rm
 && 
ifcÚfig_»mÙe_Ãtmask_·rm
)

655 
boŞ
 
tun
 = 
çl£
;

660 
tun
 = 
	`is_tun_p2p
(
‰
);

666 
‰
->
loÿl
 = 
	`g‘addr
(

667 
GETADDR_RESOLVE


668 | 
GETADDR_HOST_ORDER


669 | 
GETADDR_FATAL_ON_SIGNAL


670 | 
GETADDR_FATAL
,

671 
ifcÚfig_loÿl_·rm
,

673 
NULL
,

674 
NULL
);

676 
‰
->
»mÙe_Ãtmask
 = 
	`g‘addr
(

677 (
tun
 ? 
GETADDR_RESOLVE
 : 0)

678 | 
GETADDR_HOST_ORDER


679 | 
GETADDR_FATAL_ON_SIGNAL


680 | 
GETADDR_FATAL
,

681 
ifcÚfig_»mÙe_Ãtmask_·rm
,

683 
NULL
,

684 
NULL
);

689 ià(
¡riù_w¬n
)

691 
addršfo
 *
cu»Ë
;

692 
	`ifcÚfig_§n™y_check
(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
,t->
»mÙe_Ãtmask
,t->
tİŞogy
);

699 
cu»Ë
 = 
loÿl_public
; cu»Ë; cu»Ë = cu»Ë->
ai_Ãxt
)

701 ià(
cu»Ë
->
ai_çmy
 =ğ
AF_INET
)

703 
	`check_addr_şash
("local",

704 
‰
->
ty³
,

705 ((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->
sš_addr
.
s_addr
,

706 
‰
->
loÿl
,

707 
‰
->
»mÙe_Ãtmask
);

711 
cu»Ë
 = 
»mÙe_public
; cu»Ë; cu»Ë = cu»Ë->
ai_Ãxt
)

713 ià(
cu»Ë
->
ai_çmy
 =ğ
AF_INET
)

715 
	`check_addr_şash
("remote",

716 
‰
->
ty³
,

717 ((
sockaddr_š
 *)
cu»Ë
->
ai_addr
)->
sš_addr
.
s_addr
,

718 
‰
->
loÿl
,

719 
‰
->
»mÙe_Ãtmask
);

723 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
 || (‰->ty³ =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
))

725 
	`check_subÃt_cÚæiù
(
‰
->
loÿl
,t->
»mÙe_Ãtmask
, "TUN/TAP‡dapter");

727 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

729 
	`check_subÃt_cÚæiù
(
‰
->
loÿl
, 
IPV4_NETMASK_HOST
, "TUN/TAP‡dapter");

736 ià(!
tun
)

738 
‰
->
brßdÿ¡
 = 
	`g’”©e_ifcÚfig_brßdÿ¡_addr
Ñt->
loÿl
,t->
»mÙe_Ãtmask
);

741 #ifdeà
_WIN32


746 ià(
tun
)

748 
	`v”ify_255_255_255_252
(
‰
->
loÿl
,t->
»mÙe_Ãtmask
);

749 
‰
->
ad­‹r_Ãtmask
 = ~3;

753 
‰
->
ad­‹r_Ãtmask
 =t->
»mÙe_Ãtmask
;

757 
‰
->
did_ifcÚfig_£tup
 = 
Œue
;

760 ià(
ifcÚfig_v6_loÿl_·rm
 && 
ifcÚfig_v6_»mÙe_·rm
)

767 ià(
	`š‘_±Ú
Ğ
AF_INET6
, 
ifcÚfig_v6_loÿl_·rm
, &
‰
->
loÿl_v6
 ) != 1

768 || 
	`š‘_±Ú
Ğ
AF_INET6
, 
ifcÚfig_v6_»mÙe_·rm
, &
‰
->
»mÙe_v6
 ) != 1)

770 
	`msg
Ğ
M_FATAL
, "š™_tun:…robËm cÚv”tšg IPv6 ifcÚfig‡dd»s£ % ªd % tØbš¬y", 
ifcÚfig_v6_loÿl_·rm
, 
ifcÚfig_v6_»mÙe_·rm
 );

772 
‰
->
Ãtb™s_v6
 = 
ifcÚfig_v6_Ãtb™s_·rm
;

774 
‰
->
did_ifcÚfig_v6_£tup
 = 
Œue
;

780 ià(
es
)

782 
	`do_ifcÚfig_£‹nv
(
‰
, 
es
);

785 
	`gc_ä“
(&
gc
);

786  
‰
;

787 
	}
}

793 
	$š™_tun_po¡
(
tuÁ­
 *
‰
,

794 cÚ¡ 
äame
 *frame,

795 cÚ¡ 
tuÁ­_İtiÚs
 *
İtiÚs
)

797 
‰
->
İtiÚs
 = *options;

798 #ifdeà
_WIN32


799 
	`ov”Ïµed_io_š™
(&
‰
->
»ads
, 
äame
, 
FALSE
, 
Œue
);

800 
	`ov”Ïµed_io_š™
(&
‰
->
wr™es
, 
äame
, 
TRUE
, 
Œue
);

801 
‰
->
rw_hªdË
.
»ad
 =t->
»ads
.
ov”Ïµed
.
hEv’t
;

802 
‰
->
rw_hªdË
.
wr™e
 =t->
wr™es
.
ov”Ïµed
.
hEv’t
;

803 
‰
->
ad­‹r_šdex
 = 
TUN_ADAPTER_INDEX_INVALID
;

805 
	}
}

807 #ià
defšed
(
_WIN32
) \

808 || 
defšed
(
TARGET_DARWIN
è|| defšed(
TARGET_NETBSD
è|| 
	$defšed
(
TARGET_OPENBSD
)

816 
	$add_rou‹_cÚÃùed_v6_Ãt
(
tuÁ­
 *
‰
,

817 cÚ¡ 
’v_£t
 *
es
)

819 
rou‹_v6
 
r6
;

821 
	`CLEAR
(
r6
);

822 
r6
.
ÃtwÜk
 = 
‰
->
loÿl_v6
;

823 
r6
.
Ãtb™s
 = 
‰
->
Ãtb™s_v6
;

824 
r6
.
g©eway
 = 
‰
->
loÿl_v6
;

825 
r6
.
m‘ric
 = 0;

826 
r6
.
æags
 = 
RT_DEFINED
 | 
RT_METRIC_DEFINED
;

827 
	`add_rou‹_v6
(&
r6
, 
‰
, 0, 
es
);

828 
	}
}

831 
	$d–‘e_rou‹_cÚÃùed_v6_Ãt
(
tuÁ­
 *
‰
,

832 cÚ¡ 
’v_£t
 *
es
)

834 
rou‹_v6
 
r6
;

836 
	`CLEAR
(
r6
);

837 
r6
.
ÃtwÜk
 = 
‰
->
loÿl_v6
;

838 
r6
.
Ãtb™s
 = 
‰
->
Ãtb™s_v6
;

839 
r6
.
g©eway
 = 
‰
->
loÿl_v6
;

840 
r6
.
m‘ric
 = 0;

841 
r6
.
æags
 = 
RT_DEFINED
 | 
RT_ADDED
 | 
RT_METRIC_DEFINED
;

842 
	`rou‹_v6_ş—r_ho¡_b™s
(&
r6
);

843 
	`d–‘e_rou‹_v6
(&
r6
, 
‰
, 0, 
es
);

844 
	}
}

847 #ià
defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
) \

848 || 
defšed
(
TARGET_NETBSD
è|| 
	$defšed
(
TARGET_OPENBSD
)

858 
š_addr_t


859 
	$ü—‹_¬b™¿ry_»mÙe
Ğ
tuÁ­
 *
‰
 )

861 
š_addr_t
 
»mÙe
;

863 
»mÙe
 = (
‰
->
loÿl
 &t->
»mÙe_Ãtmask
) +1;

865 ià(
»mÙe
 =ğ
‰
->
loÿl
)

867 
»mÙe
++;

870  
»mÙe
;

871 
	}
}

876 
	$do_ifcÚfig
(
tuÁ­
 *
‰
,

877 cÚ¡ *
aùu®
,

878 
tun_mtu
,

879 cÚ¡ 
’v_£t
 *
es
)

881 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

883 ià(
‰
->
did_ifcÚfig_£tup
)

885 
boŞ
 
tun
 = 
çl£
;

886 cÚ¡ *
ifcÚfig_loÿl
 = 
NULL
;

887 cÚ¡ *
ifcÚfig_»mÙe_Ãtmask
 = 
NULL
;

888 cÚ¡ *
ifcÚfig_brßdÿ¡
 = 
NULL
;

889 cÚ¡ *
ifcÚfig_v6_loÿl
 = 
NULL
;

890 
boŞ
 
do_v6
 = 
çl£
;

891 
¬gv
‡rgv = 
	`¬gv_Ãw
();

893 
	`msg
Ğ
D_LOW
, "do_ifconfig,t->did_ifconfig_ipv6_setup=%d",

894 
‰
->
did_ifcÚfig_v6_£tup
 );

899 
tun
 = 
	`is_tun_p2p
(
‰
);

904 
ifcÚfig_loÿl
 = 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
);

905 
ifcÚfig_»mÙe_Ãtmask
 = 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, &
gc
);

907 ià(
‰
->
did_ifcÚfig_v6_£tup
)

909 
ifcÚfig_v6_loÿl
 = 
	`´št_š6_addr
(
‰
->
loÿl_v6
, 0, &
gc
);

910 
do_v6
 = 
Œue
;

916 ià(!
tun
)

918 
ifcÚfig_brßdÿ¡
 = 
	`´št_š_addr_t
(
‰
->
brßdÿ¡
, 0, &
gc
);

921 #ifdeà
ENABLE_MANAGEMENT


922 ià(
mªagem’t
)

924 
	`mªagem’t_£t_¡©e
(
mªagem’t
,

925 
OPENVPN_STATE_ASSIGN_IP
,

926 
NULL
,

927 &
‰
->
loÿl
,

928 &
‰
->
loÿl_v6
,

929 
NULL
,

930 
NULL
);

935 #ià
	`defšed
(
TARGET_LINUX
)

936 #ifdeà
ENABLE_IPROUTE


940 
	`¬gv_´štf
(&
¬gv
,

942 
rou‹_·th
,

943 
aùu®
,

944 
tun_mtu


946 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

947 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ip†ink set failed");

949 ià(
tun
)

955 
	`¬gv_´štf
(&
¬gv
,

957 
rou‹_·th
,

958 
aùu®
,

959 
ifcÚfig_loÿl
,

960 
ifcÚfig_»mÙe_Ãtmask


962 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

963 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ip‡ddr‡dd failed");

967 
	`¬gv_´štf
(&
¬gv
,

969 
rou‹_·th
,

970 
aùu®
,

971 
ifcÚfig_loÿl
,

972 
	`Ãtmask_to_Ãtb™s2
(
‰
->
»mÙe_Ãtmask
),

973 
ifcÚfig_brßdÿ¡


975 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

976 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ip‡ddr‡dd failed");

978 ià(
do_v6
)

980 
	`¬gv_´štf
Ğ&
¬gv
,

982 
rou‹_·th
,

983 
ifcÚfig_v6_loÿl
,

984 
‰
->
Ãtb™s_v6
,

985 
aùu®


987 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

988 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ip -6‡ddr‡dd failed");

990 
‰
->
did_ifcÚfig
 = 
Œue
;

992 ià(
tun
)

994 
	`¬gv_´štf
(&
¬gv
,

996 
IFCONFIG_PATH
,

997 
aùu®
,

998 
ifcÚfig_loÿl
,

999 
ifcÚfig_»mÙe_Ãtmask
,

1000 
tun_mtu


1005 
	`¬gv_´štf
(&
¬gv
,

1007 
IFCONFIG_PATH
,

1008 
aùu®
,

1009 
ifcÚfig_loÿl
,

1010 
ifcÚfig_»mÙe_Ãtmask
,

1011 
tun_mtu
,

1012 
ifcÚfig_brßdÿ¡


1015 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1016 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ifconfig failed");

1017 ià(
do_v6
)

1019 
	`¬gv_´štf
(&
¬gv
,

1021 
IFCONFIG_PATH
,

1022 
aùu®
,

1023 
ifcÚfig_v6_loÿl
,

1024 
‰
->
Ãtb™s_v6


1026 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1027 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Linux ifconfig inet6 failed");

1029 
‰
->
did_ifcÚfig
 = 
Œue
;

1032 #–ià
	`defšed
(
TARGET_ANDROID
)

1034 ià(
do_v6
)

1036 
bufãr
 
out6
 = 
	`®loc_buf_gc
(64, &
gc
);

1037 
	`buf_´štf
(&
out6
, "%s/%d", 
ifcÚfig_v6_loÿl
,
‰
->
Ãtb™s_v6
);

1038 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "IFCONFIG6",
	`buf_b±r
(&
out6
));

1041 
bufãr
 
out
 = 
	`®loc_buf_gc
(64, &
gc
);

1043 *
tİ
;

1044 
‰
->
tİŞogy
)

1046 
TOP_NET30
:

1047 
tİ
 = "net30";

1050 
TOP_P2P
:

1051 
tİ
 = "p2p";

1054 
TOP_SUBNET
:

1055 
tİ
 = "subnet";

1059 
tİ
 = "undef";

1062 
	`buf_´štf
(&
out
, "% % %d %s", 
ifcÚfig_loÿl
, 
ifcÚfig_»mÙe_Ãtmask
, 
tun_mtu
, 
tİ
);

1063 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "IFCONFIG", 
	`buf_b±r
(&
out
));

1065 #–ià
	`defšed
(
TARGET_SOLARIS
)

1071 ià(
tun
)

1073 
	`¬gv_´štf
(&
¬gv
,

1075 
IFCONFIG_PATH
,

1076 
aùu®
,

1077 
ifcÚfig_loÿl
,

1078 
ifcÚfig_»mÙe_Ãtmask
,

1079 
tun_mtu


1082 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1083 ià(!
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig…hase-1 failed"))

1085 
	`sŞ¬is_”rÜ_şo£
(
‰
, 
es
, 
aùu®
, 
çl£
);

1088 
	`¬gv_´štf
(&
¬gv
,

1090 
IFCONFIG_PATH
,

1091 
aùu®


1094 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1096 
	`¬gv_´štf
(&
¬gv
,

1098 
IFCONFIG_PATH
,

1099 
aùu®
,

1100 
ifcÚfig_loÿl
,

1101 
ifcÚfig_loÿl
,

1102 
ifcÚfig_»mÙe_Ãtmask
,

1103 
tun_mtu


1108 
	`¬gv_´štf
(&
¬gv
,

1110 
IFCONFIG_PATH
,

1111 
aùu®
,

1112 
ifcÚfig_loÿl
,

1113 
ifcÚfig_»mÙe_Ãtmask


1117 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1118 ià(!
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig…hase-2 failed"))

1120 
	`sŞ¬is_”rÜ_şo£
(
‰
, 
es
, 
aùu®
, 
çl£
);

1123 ià(
do_v6
)

1125 
	`¬gv_´štf
(&
¬gv
, "%s %s inet6 unplumb",

1126 
IFCONFIG_PATH
, 
aùu®
 );

1127 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1128 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, 
NULL
);

1130 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

1132 cÚ¡ *
ifcÚfig_v6_»mÙe
 =

1133 
	`´št_š6_addr
(
‰
->
»mÙe_v6
, 0, &
gc
);

1135 
	`¬gv_´štf
(&
¬gv
,

1137 
IFCONFIG_PATH
,

1138 
aùu®
,

1139 
ifcÚfig_v6_loÿl
,

1140 
‰
->
Ãtb™s_v6
,

1141 
ifcÚfig_v6_»mÙe


1148 
	`¬gv_´štf
(&
¬gv
, "%s %s inet6…lumb up",

1149 
IFCONFIG_PATH
, 
aùu®
 );

1150 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1151 ià(!
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig IPv6 (prepare) failed"))

1153 
	`sŞ¬is_”rÜ_şo£
(
‰
, 
es
, 
aùu®
, 
Œue
);

1164 
	`¬gv_´štf
(&
¬gv
,

1166 
IFCONFIG_PATH
, 
aùu®
,

1167 
ifcÚfig_v6_loÿl
, 
‰
->
Ãtb™s_v6
 );

1169 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1170 ià(!
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig IPv6 failed"))

1172 
	`sŞ¬is_”rÜ_şo£
(
‰
, 
es
, 
aùu®
, 
Œue
);

1176 ià(!
tun
 && 
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1179 
rou‹_v4
 
r
;

1180 
	`CLEAR
(
r
);

1181 
r
.
æags
 = 
RT_DEFINED
 | 
RT_METRIC_DEFINED
;

1182 
r
.
ÃtwÜk
 = 
‰
->
loÿl
 &t->
»mÙe_Ãtmask
;

1183 
r
.
Ãtmask
 = 
‰
->
»mÙe_Ãtmask
;

1184 
r
.
g©eway
 = 
‰
->
loÿl
;

1185 
r
.
m‘ric
 = 0;

1186 
	`add_rou‹
(&
r
, 
‰
, 0, 
NULL
, 
es
);

1189 
‰
->
did_ifcÚfig
 = 
Œue
;

1191 #–ià
	`defšed
(
TARGET_OPENBSD
)

1193 
š_addr_t
 
»mÙe_’d
;

1202 ià(
tun
)

1204 
	`¬gv_´štf
(&
¬gv
,

1206 
IFCONFIG_PATH
,

1207 
aùu®
,

1208 
ifcÚfig_loÿl
,

1209 
ifcÚfig_»mÙe_Ãtmask
,

1210 
tun_mtu


1213 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1215 
»mÙe_’d
 = 
	`ü—‹_¬b™¿ry_»mÙe
Ğ
‰
 );

1216 
	`¬gv_´štf
(&
¬gv
,

1218 
IFCONFIG_PATH
,

1219 
aùu®
,

1220 
ifcÚfig_loÿl
,

1221 
	`´št_š_addr_t
(
»mÙe_’d
, 0, &
gc
),

1222 
tun_mtu
,

1223 
ifcÚfig_»mÙe_Ãtmask


1228 
	`¬gv_´štf
(&
¬gv
,

1230 
IFCONFIG_PATH
,

1231 
aùu®
,

1232 
ifcÚfig_loÿl
,

1233 
ifcÚfig_»mÙe_Ãtmask
,

1234 
tun_mtu
,

1235 
ifcÚfig_brßdÿ¡


1238 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1239 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "OpenBSD ifconfig failed");

1242 ià(!
tun
 && 
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1244 
rou‹_v4
 
r
;

1245 
	`CLEAR
(
r
);

1246 
r
.
æags
 = 
RT_DEFINED
;

1247 
r
.
ÃtwÜk
 = 
‰
->
loÿl
 &t->
»mÙe_Ãtmask
;

1248 
r
.
Ãtmask
 = 
‰
->
»mÙe_Ãtmask
;

1249 
r
.
g©eway
 = 
»mÙe_’d
;

1250 
	`add_rou‹
(&
r
, 
‰
, 0, 
NULL
, 
es
);

1253 ià(
do_v6
)

1255 
	`¬gv_´štf
(&
¬gv
,

1257 
IFCONFIG_PATH
,

1258 
aùu®
,

1259 
ifcÚfig_v6_loÿl
,

1260 
‰
->
Ãtb™s_v6


1262 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1263 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "OpenBSD ifconfig inet6 failed");

1266 
	`add_rou‹_cÚÃùed_v6_Ãt
(
‰
, 
es
);

1268 
‰
->
did_ifcÚfig
 = 
Œue
;

1270 #–ià
	`defšed
(
TARGET_NETBSD
)

1272 
š_addr_t
 
»mÙe_’d
;

1274 ià(
tun
)

1276 
	`¬gv_´štf
(&
¬gv
,

1278 
IFCONFIG_PATH
,

1279 
aùu®
,

1280 
ifcÚfig_loÿl
,

1281 
ifcÚfig_»mÙe_Ãtmask
,

1282 
tun_mtu


1285 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1287 
»mÙe_’d
 = 
	`ü—‹_¬b™¿ry_»mÙe
Ğ
‰
 );

1288 
	`¬gv_´štf
(&
¬gv
,

1290 
IFCONFIG_PATH
,

1291 
aùu®
,

1292 
ifcÚfig_loÿl
,

1293 
	`´št_š_addr_t
(
»mÙe_’d
, 0, &
gc
),

1294 
tun_mtu
,

1295 
ifcÚfig_»mÙe_Ãtmask


1305 
	`¬gv_´štf
(&
¬gv
,

1307 
IFCONFIG_PATH
,

1308 
aùu®
,

1309 
ifcÚfig_loÿl
,

1310 
ifcÚfig_»mÙe_Ãtmask
,

1311 
tun_mtu
,

1312 
ifcÚfig_brßdÿ¡


1315 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1316 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "NetBSD ifconfig failed");

1319 ià(!
tun
 && 
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1321 
rou‹_v4
 
r
;

1322 
	`CLEAR
(
r
);

1323 
r
.
æags
 = 
RT_DEFINED
;

1324 
r
.
ÃtwÜk
 = 
‰
->
loÿl
 &t->
»mÙe_Ãtmask
;

1325 
r
.
Ãtmask
 = 
‰
->
»mÙe_Ãtmask
;

1326 
r
.
g©eway
 = 
»mÙe_’d
;

1327 
	`add_rou‹
(&
r
, 
‰
, 0, 
NULL
, 
es
);

1330 ià(
do_v6
)

1332 
	`¬gv_´štf
(&
¬gv
,

1334 
IFCONFIG_PATH
,

1335 
aùu®
,

1336 
ifcÚfig_v6_loÿl
,

1337 
‰
->
Ãtb™s_v6


1339 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1340 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "NetBSD ifconfig inet6 failed");

1343 
	`add_rou‹_cÚÃùed_v6_Ãt
(
‰
, 
es
);

1345 
‰
->
did_ifcÚfig
 = 
Œue
;

1347 #–ià
	`defšed
(
TARGET_DARWIN
)

1352 
	`¬gv_´štf
(&
¬gv
,

1354 
IFCONFIG_PATH
,

1355 
aùu®
);

1356 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1357 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, 
NULL
);

1358 
	`msg
(
M_INFO
, "NOTE: Triedo delete…re-existingun/tap instance -- No Problem if failure");

1362 ià(
tun
)

1364 
	`¬gv_´štf
(&
¬gv
,

1366 
IFCONFIG_PATH
,

1367 
aùu®
,

1368 
ifcÚfig_loÿl
,

1369 
ifcÚfig_»mÙe_Ãtmask
,

1370 
tun_mtu


1375 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1377 
	`¬gv_´štf
(&
¬gv
,

1379 
IFCONFIG_PATH
,

1380 
aùu®
,

1381 
ifcÚfig_loÿl
,

1382 
ifcÚfig_loÿl
,

1383 
ifcÚfig_»mÙe_Ãtmask
,

1384 
tun_mtu


1389 
	`¬gv_´štf
(&
¬gv
,

1391 
IFCONFIG_PATH
,

1392 
aùu®
,

1393 
ifcÚfig_loÿl
,

1394 
ifcÚfig_»mÙe_Ãtmask
,

1395 
tun_mtu


1400 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1401 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "Mac OS X ifconfig failed");

1402 
‰
->
did_ifcÚfig
 = 
Œue
;

1405 ià(!
tun
 && 
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1407 
rou‹_v4
 
r
;

1408 
	`CLEAR
(
r
);

1409 
r
.
æags
 = 
RT_DEFINED
;

1410 
r
.
ÃtwÜk
 = 
‰
->
loÿl
 &t->
»mÙe_Ãtmask
;

1411 
r
.
Ãtmask
 = 
‰
->
»mÙe_Ãtmask
;

1412 
r
.
g©eway
 = 
‰
->
loÿl
;

1413 
	`add_rou‹
(&
r
, 
‰
, 0, 
NULL
, 
es
);

1416 ià(
do_v6
)

1418 
	`¬gv_´štf
(&
¬gv
,

1420 
IFCONFIG_PATH
,

1421 
aùu®
,

1422 
ifcÚfig_v6_loÿl
,

1423 
‰
->
Ãtb™s_v6


1425 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1426 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "MacOS X ifconfig inet6 failed");

1429 
	`add_rou‹_cÚÃùed_v6_Ãt
(
‰
, 
es
);

1432 #–ià
	`defšed
(
TARGET_FREEBSD
è|| defšed(
TARGET_DRAGONFLY
)

1434 
š_addr_t
 
»mÙe_’d
;

1437 ià(
tun
)

1439 
	`¬gv_´štf
(&
¬gv
,

1441 
IFCONFIG_PATH
,

1442 
aùu®
,

1443 
ifcÚfig_loÿl
,

1444 
ifcÚfig_»mÙe_Ãtmask
,

1445 
tun_mtu


1448 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1450 
»mÙe_’d
 = 
	`ü—‹_¬b™¿ry_»mÙe
Ğ
‰
 );

1451 
	`¬gv_´štf
(&
¬gv
,

1453 
IFCONFIG_PATH
,

1454 
aùu®
,

1455 
ifcÚfig_loÿl
,

1456 
	`´št_š_addr_t
(
»mÙe_’d
, 0, &
gc
),

1457 
tun_mtu
,

1458 
ifcÚfig_»mÙe_Ãtmask


1463 
	`¬gv_´štf
(&
¬gv
,

1465 
IFCONFIG_PATH
,

1466 
aùu®
,

1467 
ifcÚfig_loÿl
,

1468 
ifcÚfig_»mÙe_Ãtmask
,

1469 
tun_mtu


1473 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1474 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "FreeBSD ifconfig failed");

1475 
‰
->
did_ifcÚfig
 = 
Œue
;

1478 ià(!
tun
 && 
‰
->
ty³
 =ğ
DEV_TYPE_TUN
 &&t->
tİŞogy
 =ğ
TOP_SUBNET
)

1480 
rou‹_v4
 
r
;

1481 
	`CLEAR
(
r
);

1482 
r
.
æags
 = 
RT_DEFINED
;

1483 
r
.
ÃtwÜk
 = 
‰
->
loÿl
 &t->
»mÙe_Ãtmask
;

1484 
r
.
Ãtmask
 = 
‰
->
»mÙe_Ãtmask
;

1485 
r
.
g©eway
 = 
»mÙe_’d
;

1486 
	`add_rou‹
(&
r
, 
‰
, 0, 
NULL
, 
es
);

1489 ià(
do_v6
)

1491 
	`¬gv_´štf
(&
¬gv
,

1493 
IFCONFIG_PATH
,

1494 
aùu®
,

1495 
ifcÚfig_v6_loÿl
,

1496 
‰
->
Ãtb™s_v6


1498 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1499 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "FreeBSD ifconfig inet6 failed");

1502 #–ià
	`defšed
(
TARGET_AIX
)

1505 
’v_£t
 *
aix_es
 = 
	`’v_£t_ü—‹
(
NULL
);

1506 
	`’v_£t_add
Ğ
aix_es
, "ODMDIR=/etc/objrepos" );

1508 ià(
tun
)

1510 
	`msg
(
M_FATAL
, "noun support on AIX (canthappen)");

1514 
	`¬gv_´štf
(&
¬gv
,

1516 
IFCONFIG_PATH
,

1517 
aùu®
,

1518 
ifcÚfig_loÿl
,

1519 
ifcÚfig_»mÙe_Ãtmask
,

1520 
tun_mtu


1523 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1524 
	`İ’v²_execve_check
(&
¬gv
, 
aix_es
, 
S_FATAL
, "AIX ifconfig failed");

1525 
‰
->
did_ifcÚfig
 = 
Œue
;

1527 ià(
do_v6
)

1529 
	`¬gv_´štf
(&
¬gv
,

1531 
IFCONFIG_PATH
,

1532 
aùu®
,

1533 
ifcÚfig_v6_loÿl
,

1534 
‰
->
Ãtb™s_v6


1536 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

1537 
	`İ’v²_execve_check
(&
¬gv
, 
aix_es
, 
S_FATAL
, "AIX ifconfig inet6 failed");

1539 
	`’v_£t_de¡roy
(
aix_es
);

1541 #–ià
	`defšed
 (
_WIN32
)

1543 
	`ASSERT
(
aùu®
 !ğ
NULL
);

1545 
‰
->
İtiÚs
.
_wš32_ty³
)

1547 
IPW32_SET_MANUAL
:

1548 
	`msg
(
M_INFO
, "******** NOTE: Please manually sethe IP/netmask of '%s'o %s/%s (if it is‚ot‡lready set)",

1549 
aùu®
,

1550 
ifcÚfig_loÿl
,

1551 
	`´št_š_addr_t
(
‰
->
ad­‹r_Ãtmask
, 0, &
gc
));

1554 
IPW32_SET_NETSH
:

1555 
	`Ãtsh_ifcÚfig
(&
‰
->
İtiÚs
,

1556 
aùu®
,

1557 
‰
->
loÿl
,

1558 
‰
->
ad­‹r_Ãtmask
,

1559 
NI_IP_NETMASK
|
NI_OPTIONS
);

1563 
‰
->
did_ifcÚfig
 = 
Œue
;

1566 ià(
do_v6
)

1568 ià(
‰
->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_MANUAL
)

1570 
	`msg
(
M_INFO
, "******** NOTE: Please manually sethe v6 IP of '%s'o %s (if it is‚ot‡lready set)",

1571 
aùu®
,

1572 
ifcÚfig_v6_loÿl
);

1574 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

1576 
	`do_add»ss_£rviû
(
Œue
, 
AF_INET6
, 
‰
);

1577 
	`do_dns6_£rviû
(
Œue
, 
‰
);

1582 
içû
[64];

1583 
	`İ’v²_¢´štf
(
içû
, (içû), "š‹rçû=%lu", 
‰
->
ad­‹r_šdex
 );

1584 
	`¬gv_´štf
(&
¬gv
,

1586 
	`g‘_wš_sys_·th
(),

1587 
NETSH_PATH_SUFFIX
,

1588 
içû
,

1589 
ifcÚfig_v6_loÿl
 );

1590 
	`Ãtsh_commªd
(&
¬gv
, 4, 
M_FATAL
);

1592 
	`Ãtsh_£t_dns6_£rv”s
(
‰
->
İtiÚs
.
dns6
,t->İtiÚs.
dns6_Ën
, 
aùu®
);

1596 ià(
‰
->
İtiÚs
.
_wš32_ty³
 !ğ
IPW32_SET_MANUAL
)

1598 
	`add_rou‹_cÚÃùed_v6_Ãt
(
‰
, 
es
);

1602 
	`msg
(
M_FATAL
, "Sorry, but I don't know howo do 'ifconfig' commands onhis operating system. You should ifconfig your TUN/TAP device manually or use‡n --up script.");

1604 
	`¬gv_»£t
(&
¬gv
);

1606 
	`gc_ä“
(&
gc
);

1607 
	}
}

1610 
	$ş—r_tuÁ­
(
tuÁ­
 *tuntap)

1612 
	`CLEAR
(*
tuÁ­
);

1613 #ifdeà
_WIN32


1614 
tuÁ­
->
hªd
 = 
NULL
;

1616 
tuÁ­
->
fd
 = -1;

1618 #ifdeà
TARGET_SOLARIS


1619 
tuÁ­
->
_fd
 = -1;

1621 
	}
}

1624 
	$İ’_nuÎ
(
tuÁ­
 *
‰
)

1626 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
("nuÎ", 
NULL
);

1627 
	}
}

1630 #ià
defšed
 (
TARGET_OPENBSD
è|| (defšed(
TARGET_DARWIN
è&& 
HAVE_NET_IF_UTUN_H
)

1650 
	~<Ãtš‘/.h
>

1651 
	~<sys/uio.h
>

1653 
šlše
 

1654 
	$h—d”_modify_»ad_wr™e_»tuº
(
Ën
)

1656 ià(
Ën
 > 0)

1658  
Ën
 > (
u_št32_t
) ?†en - (u_int32_t) : 0;

1662  
Ën
;

1664 
	}
}

1667 
	$wr™e_tun_h—d”
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

1669 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

1671 
u_št32_t
 
ty³
;

1672 
iovec
 
iv
[2];

1673 
İ’v²_hdr
 *
h
;

1675 
h
 = (
İ’v²_hdr
 *è
buf
;

1677 ià(
	`OPENVPN_IPH_GET_VER
(
h
->
v”siÚ_Ën
) == 6)

1679 
ty³
 = 
	`htÚl
(
AF_INET6
);

1683 
ty³
 = 
	`htÚl
(
AF_INET
);

1686 
iv
[0].
iov_ba£
 = &
ty³
;

1687 
iv
[0].
iov_Ën
 = (
ty³
);

1688 
iv
[1].
iov_ba£
 = 
buf
;

1689 
iv
[1].
iov_Ën
 = 
Ën
;

1691  
	`h—d”_modify_»ad_wr™e_»tuº
(
	`wr™ev
(
‰
->
fd
, 
iv
, 2));

1695  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

1697 
	}
}

1700 
	$»ad_tun_h—d”
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

1702 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

1704 
u_št32_t
 
ty³
;

1705 
iovec
 
iv
[2];

1707 
iv
[0].
iov_ba£
 = &
ty³
;

1708 
iv
[0].
iov_Ën
 = (
ty³
);

1709 
iv
[1].
iov_ba£
 = 
buf
;

1710 
iv
[1].
iov_Ën
 = 
Ën
;

1712  
	`h—d”_modify_»ad_wr™e_»tuº
(
	`»adv
(
‰
->
fd
, 
iv
, 2));

1716  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

1718 
	}
}

1722 #ià!(
defšed
(
_WIN32
è|| defšed(
TARGET_LINUX
))

1724 
	$İ’_tun_g’”ic
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
,

1725 
boŞ
 
dyÇmic
, 
tuÁ­
 *
‰
)

1727 
tuÂame
[256];

1728 
dyÇmic_Çme
[256];

1729 
boŞ
 
dyÇmic_İ’ed
 = 
çl£
;

1731 ià(
‰
->
ty³
 =ğ
DEV_TYPE_NULL
)

1733 
	`İ’_nuÎ
(
‰
);

1740 ià(
dev_node
)

1742 
	`İ’v²_¢´štf
(
tuÂame
, ÑuÂame), "%s", 
dev_node
);

1751 #ifdeà
TARGET_NETBSD


1756 ià(
dyÇmic
 && 
	`¡rcmp
Ğ
dev
, "tap" ) == 0)

1758 
iäeq
 
iä
;

1759 ià((
‰
->
fd
 = 
	`İ’
Ğ"/dev/p", 
O_RDWR
)) < 0)

1761 
	`msg
(
M_FATAL
, "Cannot‡llocate NetBSD TAP dev dynamically");

1763 ià(
	`ioùl
Ğ
‰
->
fd
, 
TAPGIFNAME
, (*)&
iä
 ) < 0)

1765 
	`msg
(
M_FATAL
, "Cannot query NetBSD TAP device‚ame");

1767 
	`CLEAR
(
dyÇmic_Çme
);

1768 
	`¡ºıy
Ğ
dyÇmic_Çme
, 
iä
.
iä_Çme
, (dynamic_name)-1 );

1769 
dyÇmic_İ’ed
 = 
Œue
;

1770 
	`İ’v²_¢´štf
(
tuÂame
, ÑuÂame), "/dev/%s", 
dyÇmic_Çme
 );

1775 ià(
dyÇmic
 && !
	`has_dig™
((*)
dev
))

1777 
i
;

1778 
i
 = 0; i < 256; ++i)

1780 
	`İ’v²_¢´štf
(
tuÂame
, (tunname),

1781 "/dev/%s%d", 
dev
, 
i
);

1782 
	`İ’v²_¢´štf
(
dyÇmic_Çme
, (dynamic_name),

1783 "%s%d", 
dev
, 
i
);

1784 ià((
‰
->
fd
 = 
	`İ’
(
tuÂame
, 
O_RDWR
)) > 0)

1786 
dyÇmic_İ’ed
 = 
Œue
;

1789 
	`msg
(
D_READ_WRITE
 | 
M_ERRNO
, "Tr›d o³nšg % (çed)", 
tuÂame
);

1791 ià(!
dyÇmic_İ’ed
)

1793 
	`msg
(
M_FATAL
, "Cannot‡llocate TUN/TAP dev dynamically");

1801 
	`İ’v²_¢´štf
(
tuÂame
, ÑuÂame), "/dev/%s", 
dev
);

1805 ià(!
dyÇmic_İ’ed
)

1808 ià(
	`if_Çm‘ošdex
Ğ
dev
 ) > 0)

1810 
	`msg
(
M_INFO
, "TUN/TAP deviû % exi¡ ´eviou¦y, k“°©…rog¿mƒnd", 
dev
 );

1811 
‰
->
³rsi¡’t_if
 = 
Œue
;

1814 ià((
‰
->
fd
 = 
	`İ’
(
tuÂame
, 
O_RDWR
)) < 0)

1816 
	`msg
(
M_ERR
, "CªnÙ o³ÀTUN/TAP dev %s", 
tuÂame
);

1820 
	`£t_nÚblock
(
‰
->
fd
);

1821 
	`£t_şÛxec
(
‰
->
fd
);

1822 
	`msg
(
M_INFO
, "TUN/TAP deviû % İ’ed", 
tuÂame
);

1825 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
dyÇmic_İ’ed
 ? 
dyÇmic_Çme
 : 
dev
, 
NULL
);

1827 
	}
}

1830 #ià!
defšed
(
_WIN32
)

1832 
	$şo£_tun_g’”ic
(
tuÁ­
 *
‰
)

1834 ià(
‰
->
fd
 >= 0)

1836 
	`şo£
(
‰
->
fd
);

1838 ià(
‰
->
aùu®_Çme
)

1840 
	`ä“
(
‰
->
aùu®_Çme
);

1842 
	`ş—r_tuÁ­
(
‰
);

1843 
	}
}

1846 #ià
defšed
 (
TARGET_ANDROID
)

1848 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

1850 
	#ANDROID_TUNNAME
 "v²£rviû-tun"

	)

1851 
u£r_·ss
 
up
;

1852 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1853 
boŞ
 
İ’tun
;

1855 
Şdtunfd
 = 
‰
->
fd
;

1859 
i
 = 0; i < 
‰
->
İtiÚs
.
dns6_Ën
; i++)

1861 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "DNS6SERVER",

1862 
	`´št_š6_addr
(
‰
->
İtiÚs
.
dns6
[
i
], 0, &
gc
));

1865 
i
 = 0; i < 
‰
->
İtiÚs
.
dns_Ën
; i++)

1867 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "DNSSERVER",

1868 
	`´št_š_addr_t
(
‰
->
İtiÚs
.
dns
[
i
], 0, &
gc
));

1871 ià(
‰
->
İtiÚs
.
domaš
)

1873 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "DNSDOMAIN", 
‰
->
İtiÚs
.
domaš
);

1876 
ªdroid_m‘hod
 = 
	`mªagm’t_ªdroid_³rsi¡tun_aùiÚ
(
mªagem’t
);

1879 ià(
Şdtunfd
 >=0 && 
ªdroid_m‘hod
 =ğ
ANDROID_OPEN_AFTER_CLOSE
)

1881 
	`şo£
(
Şdtunfd
);

1882 
	`mªagem’t_¦“p
(2);

1885 ià(
Şdtunfd
 >=0 && 
ªdroid_m‘hod
 =ğ
ANDROID_KEEP_OLD_TUN
)

1888 
İ’tun
 = 
Œue
;

1892 
İ’tun
 = 
	`mªagem’t_ªdroid_cÚŒŞ
(
mªagem’t
, "OPENTUN", 
dev
);

1895 
‰
->
fd
 = 
mªagem’t
->
cÚÃùiÚ
.
Ï¡fd»ûived
;

1896 
mªagem’t
->
cÚÃùiÚ
.
Ï¡fd»ûived
 = -1;

1899 ià(
Şdtunfd
>=0 && 
ªdroid_m‘hod
 =ğ
ANDROID_OPEN_BEFORE_CLOSE
)

1901 
	`şo£
(
Şdtunfd
);

1905 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
ANDROID_TUNNAME
, 
NULL
);

1907 ià((
‰
->
fd
 < 0è|| !
İ’tun
)

1909 
	`msg
(
M_ERR
, "ERROR: Cannot open TUN");

1912 
	`gc_ä“
(&
gc
);

1913 
	}
}

1916 
	$şo£_tun
(
tuÁ­
 *
‰
)

1918 ià(
‰
)

1920 
	`şo£_tun_g’”ic
(
‰
);

1921 
	`ä“
(
‰
);

1923 
	}
}

1926 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

1928  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

1929 
	}
}

1932 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

1934  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

1935 
	}
}

1937 #–ià
defšed
(
TARGET_LINUX
)

1939 #iâdeà
HAVE_LINUX_SOCKIOS_H


1940 #”rÜ 
h—d”
 
fe
 
lšux
/
sockios
.
h
 
»quœed


1943 #ià!
PEDANTIC


1946 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

1948 
iäeq
 
iä
;

1953 ià(
‰
->
ty³
 =ğ
DEV_TYPE_NULL
)

1955 
	`İ’_nuÎ
(
‰
);

1962 cÚ¡ *
node
 = 
dev_node
;

1963 ià(!
node
)

1965 
node
 = "/dev/net/tun";

1971 ià((
‰
->
fd
 = 
	`İ’
(
node
, 
O_RDWR
)) < 0)

1973 
	`msg
(
M_ERR
, "ERROR: CªnÙ o³ÀTUN/TAP dev %s", 
node
);

1979 
	`CLEAR
(
iä
);

1980 
iä
.
iä_æags
 = 
IFF_NO_PI
;

1982 #ià
	`defšed
(
IFF_ONE_QUEUE
è&& defšed(
SIOCSIFTXQLEN
)

1983 
iä
.
iä_æags
 |ğ
IFF_ONE_QUEUE
;

1989 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

1991 
iä
.
iä_æags
 |ğ
IFF_TUN
;

1993 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

1995 
iä
.
iä_æags
 |ğ
IFF_TAP
;

1999 
	`msg
(
M_FATAL
, "I don't„ecognize device %s‡s‡un orap device",

2000 
dev
);

2006 ià(
	`¡rcmp
(
dev
, "tun") && strcmp(dev, "tap"))

2008 
	`¡ºıyÁ
(
iä
.
iä_Çme
, 
dev
, 
IFNAMSIZ
);

2015 ià(
	`ioùl
(
‰
->
fd
, 
TUNSETIFF
, (*è&
iä
) < 0)

2017 
	`msg
(
M_ERR
, "ERROR: CªnÙ ioùÈTUNSETIFF %s", 
dev
);

2020 
	`msg
(
M_INFO
, "TUN/TAP deviû % İ’ed", 
iä
.
iä_Çme
);

2025 #ià
	`defšed
(
IFF_ONE_QUEUE
è&& defšed(
SIOCSIFTXQLEN
)

2026 ià(
‰
->
İtiÚs
.
txqueu–’
)

2028 
iäeq
 
Ãtiä
;

2029 
ùl_fd
;

2031 ià((
ùl_fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 0)) >= 0)

2033 
	`CLEAR
(
Ãtiä
);

2034 
	`¡ºıyÁ
(
Ãtiä
.
iä_Çme
, 
iä
.iä_Çme, 
IFNAMSIZ
);

2035 
Ãtiä
.
iä_qËn
 = 
‰
->
İtiÚs
.
txqueu–’
;

2036 ià(
	`ioùl
(
ùl_fd
, 
SIOCSIFTXQLEN
, (*è&
Ãtiä
) >= 0)

2038 
	`msg
(
D_OSBUF
, "TUN/TAP TX queuËngth s‘Ø%d", 
‰
->
İtiÚs
.
txqueu–’
);

2042 
	`msg
(
M_WARN
 | 
M_ERRNO
, "NÙe: CªnÙ s‘x queuËngth oÀ%s", 
iä
.
iä_Çme
);

2044 
	`şo£
(
ùl_fd
);

2048 
	`msg
(
M_WARN
 | 
M_ERRNO
, "NÙe: CªnÙ o³ÀcÚŒŞ sock‘ oÀ%s", 
iä
.
iä_Çme
);

2053 
	`£t_nÚblock
(
‰
->
fd
);

2054 
	`£t_şÛxec
(
‰
->
fd
);

2055 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
iä
.
iä_Çme
, 
NULL
);

2058 
	}
}

2063 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2065 
	`ASSERT
(0);

2066 
	}
}

2070 #ifdeà
ENABLE_FEATURE_TUN_PERSIST


2073 
	$tuncfg
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
³rsi¡_mode
, cÚ¡ *
u£ºame
, cÚ¡ *
grou²ame
, cÚ¡ 
tuÁ­_İtiÚs
 *
İtiÚs
)

2075 
tuÁ­
 *
‰
;

2077 
	`ALLOC_OBJ
(
‰
, 
tuÁ­
);

2078 
	`ş—r_tuÁ­
(
‰
);

2079 
‰
->
ty³
 = 
	`dev_ty³_’um
(
dev
, 
dev_ty³
);

2080 
‰
->
İtiÚs
 = *options;

2081 
	`İ’_tun
(
dev
, 
dev_ty³
, 
dev_node
, 
‰
);

2082 ià(
	`ioùl
(
‰
->
fd
, 
TUNSETPERSIST
, 
³rsi¡_mode
) < 0)

2084 
	`msg
(
M_ERR
, "CªnÙ ioùÈTUNSETPERSIST(%dè%s", 
³rsi¡_mode
, 
dev
);

2086 ià(
u£ºame
 !ğ
NULL
)

2088 
¶©fÜm_¡©e_u£r
…latform_state_user;

2090 ià(!
	`¶©fÜm_u£r_g‘
(
u£ºame
, &
¶©fÜm_¡©e_u£r
))

2092 
	`msg
(
M_ERR
, "CªnÙ g‘ u£¸’Œy fÜ %s", 
u£ºame
);

2094 ià(
	`ioùl
(
‰
->
fd
, 
TUNSETOWNER
, 
¶©fÜm_¡©e_u£r
.
pw
->
pw_uid
) < 0)

2096 
	`msg
(
M_ERR
, "CªnÙ ioùÈTUNSETOWNER(%sè%s", 
u£ºame
, 
dev
);

2099 ià(
grou²ame
 !ğ
NULL
)

2101 
¶©fÜm_¡©e_group
…latform_state_group;

2103 ià(!
	`¶©fÜm_group_g‘
(
grou²ame
, &
¶©fÜm_¡©e_group
))

2105 
	`msg
(
M_ERR
, "CªnÙ g‘ grou°’Œy fÜ %s", 
grou²ame
);

2107 ià(
	`ioùl
(
‰
->
fd
, 
TUNSETGROUP
, 
¶©fÜm_¡©e_group
.
gr
->
gr_gid
) < 0)

2109 
	`msg
(
M_ERR
, "CªnÙ ioùÈTUNSETOWNER(%sè%s", 
grou²ame
, 
dev
);

2112 
	`şo£_tun
(
‰
);

2113 
	`msg
(
M_INFO
, "P”si¡ s‹ s‘o: %s", (
³rsi¡_mode
 ? "ON" : "OFF"));

2114 
	}
}

2119 
	$şo£_tun
(
tuÁ­
 *
‰
)

2121 ià(
‰
)

2123 ià(
‰
->
ty³
 !ğ
DEV_TYPE_NULL
 &&t->
did_ifcÚfig
)

2125 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2126 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2128 #ifdeà
ENABLE_IPROUTE


2129 ià(
	`is_tun_p2p
(
‰
))

2131 
	`¬gv_´štf
(&
¬gv
,

2133 
rou‹_·th
,

2134 
‰
->
aùu®_Çme
,

2135 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
),

2136 
	`´št_š_addr_t
(
‰
->
»mÙe_Ãtmask
, 0, &
gc
)

2141 
	`¬gv_´štf
(&
¬gv
,

2143 
rou‹_·th
,

2144 
‰
->
aùu®_Çme
,

2145 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
),

2146 
	`Ãtmask_to_Ãtb™s2
(
‰
->
»mÙe_Ãtmask
)

2150 
	`¬gv_´štf
(&
¬gv
,

2152 
IFCONFIG_PATH
,

2153 
‰
->
aùu®_Çme


2157 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2158 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "Linux ip‡ddr del failed");

2160 ià(
‰
->
did_ifcÚfig_v6_£tup
)

2162 cÚ¡ *
ifcÚfig_v6_loÿl
 = 
	`´št_š6_addr
(
‰
->
loÿl_v6
, 0, &
gc
);

2164 #ifdeà
ENABLE_IPROUTE


2165 
	`¬gv_´štf
(&
¬gv
, "%s -6‡ddr del %s/%d dev %s",

2166 
rou‹_·th
,

2167 
ifcÚfig_v6_loÿl
,

2168 
‰
->
Ãtb™s_v6
,

2169 
‰
->
aùu®_Çme


2171 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2172 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "Linux ip -6‡ddr del failed");

2174 
	`¬gv_´štf
(&
¬gv
,

2176 
IFCONFIG_PATH
,

2177 
‰
->
aùu®_Çme
,

2178 
ifcÚfig_v6_loÿl
,

2179 
‰
->
Ãtb™s_v6


2181 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2182 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "Linux ifconfig inet6 del failed");

2186 
	`¬gv_»£t
(&
¬gv
);

2187 
	`gc_ä“
(&
gc
);

2189 
	`şo£_tun_g’”ic
(
‰
);

2190 
	`ä“
(
‰
);

2192 
	}
}

2195 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2197  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

2198 
	}
}

2201 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2203  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

2204 
	}
}

2206 #–ià
defšed
(
TARGET_SOLARIS
)

2208 #iâdeà
TUNNEWPPA


2209 #”rÜ 
I
 
Ãed
 
the
 
symbŞ
 
TUNNEWPPA
 
äom
 
Ãt
/
if_tun
.
h


2213 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2215 
if_fd
, 
_muxid
, 
¬p_muxid
, 
¬p_fd
, 
µa
 = -1;

2216 
liäeq
 
iä
;

2217 cÚ¡ *
±r
;

2218 cÚ¡ *
_node
, *
¬p_node
;

2219 cÚ¡ *
dev_tuÁ­_ty³
;

2220 
lšk_ty³
;

2221 
boŞ
 
is_tun
;

2222 
¡rioùl
 
¡rioc_if
, 
¡rioc_µa
;

2228 
	`CLEAR
(
iä
);

2230 ià(
‰
->
ty³
 =ğ
DEV_TYPE_NULL
)

2232 
	`İ’_nuÎ
(
‰
);

2236 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2238 
_node
 = "/dev/udp";

2239 ià(!
dev_node
)

2241 
dev_node
 = "/dev/tun";

2243 
dev_tuÁ­_ty³
 = "tun";

2244 
lšk_ty³
 = 
I_PLINK
;

2245 
is_tun
 = 
Œue
;

2247 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2249 
_node
 = "/dev/udp";

2250 ià(!
dev_node
)

2252 
dev_node
 = "/dev/tap";

2254 
¬p_node
 = 
dev_node
;

2255 
dev_tuÁ­_ty³
 = "tap";

2256 
lšk_ty³
 = 
I_PLINK
;

2257 
is_tun
 = 
çl£
;

2261 
	`msg
(
M_FATAL
, "I don't„ecognize device %s‡s‡un orap device",

2262 
dev
);

2265 ià((
‰
->
_fd
 = 
	`İ’
(
_node
, 
O_RDWR
, 0)) < 0)

2267 
	`msg
(
M_ERR
, "Cª'ˆİ’ %s", 
_node
);

2270 ià((
‰
->
fd
 = 
	`İ’
(
dev_node
, 
O_RDWR
, 0)) < 0)

2272 
	`msg
(
M_ERR
, "Cª'ˆİ’ %s", 
dev_node
);

2276 ià(*
dev
)

2278 
±r
 = 
dev
;

2279 *
±r
 && !
	`isdig™
(() *ptr))

2281 
±r
++;

2283 
µa
 = 
	`©oi
(
±r
);

2287 
¡rioc_µa
.
ic_cmd
 = 
TUNNEWPPA
;

2288 
¡rioc_µa
.
ic_timout
 = 0;

2289 
¡rioc_µa
.
ic_Ën
 = (
µa
);

2290 
¡rioc_µa
.
ic_dp
 = (*)&
µa
;

2292 ià(*
±r
 == '\0')

2294 
boŞ
 
found_Úe
 = 
çl£
;

2295 !
found_Úe
 && 
µa
 < 64)

2297 
Ãw_µa
 = 
	`ioùl
(
‰
->
fd
, 
I_STR
, &
¡rioc_µa
);

2298 ià(
Ãw_µa
 >= 0)

2300 
	`msg
Ğ
M_INFO
, "İ’_tun: gÙ dyÇmiøš‹rçû '%s%d'", 
dev_tuÁ­_ty³
, 
Ãw_µa
 );

2301 
µa
 = 
Ãw_µa
;

2302 
found_Úe
 = 
Œue
;

2305 ià(
”ºo
 !ğ
EEXIST
)

2307 
	`msg
(
M_ERR
, "İ’_tun: uÃx³ùedƒ¼ÜryšgØfšd f»% š‹rçû", 
dev_tuÁ­_ty³
 );

2309 
µa
++;

2311 ià(!
found_Úe
)

2313 
	`msg
(
M_ERR
, "İ’_tun: could‚Ù fšd f»% š‹rçû, givup.", 
dev_tuÁ­_ty³
 );

2318 ià((
µa
 = 
	`ioùl
(
‰
->
fd
, 
I_STR
, &
¡rioc_µa
)) < 0)

2320 
	`msg
(
M_ERR
, "Cª'ˆassigÀPPA fÜ‚ew iÁ”çû (%s%d)", 
dev_tuÁ­_ty³
, 
µa
 );

2324 ià((
if_fd
 = 
	`İ’
(
dev_node
, 
O_RDWR
, 0)) < 0)

2326 
	`msg
(
M_ERR
, "Cª'ˆİ’ % (2)", 
dev_node
);

2329 ià(
	`ioùl
(
if_fd
, 
I_PUSH
, "ip") < 0)

2331 
	`msg
(
M_ERR
, "Can't…ush IP module");

2334 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2337 ià(
	`ioùl
(
if_fd
, 
IF_UNITSEL
, (*è&
µa
) < 0)

2339 
	`msg
(
M_ERR
, "Cª'ˆ£ˆPPA %d", 
µa
);

2343 
‰
->
aùu®_Çme
 = (*è
	`m®loc
(32);

2344 
	`check_m®loc_»tuº
(
‰
->
aùu®_Çme
);

2346 
	`İ’v²_¢´štf
(
‰
->
aùu®_Çme
, 32, "%s%d", 
dev_tuÁ­_ty³
, 
µa
);

2348 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2350 ià(
	`ioùl
(
if_fd
, 
SIOCGLIFFLAGS
, &
iä
) < 0)

2352 
	`msg
(
M_ERR
, "Can't get flags\n");

2354 
	`¡ºıyÁ
(
iä
.
liä_Çme
, 
‰
->
aùu®_Çme
, (ifr.lifr_name));

2355 
iä
.
liä_µa
 = 
µa
;

2357 ià(
	`ioùl
(
if_fd
, 
SIOCSLIFNAME
, &
iä
) < 0)

2359 
	`msg
(
M_ERR
, "Cª'ˆ£ˆPPA %d", 
µa
);

2361 ià(
	`ioùl
(
if_fd
, 
SIOCGLIFFLAGS
, &
iä
) <0)

2363 
	`msg
(
M_ERR
, "Can't get flags\n");

2366 ià(
	`ioùl
(
if_fd
, 
I_PUSH
, "arp") < 0)

2368 
	`msg
(
M_ERR
, "Can't…ush ARP module");

2372 
Œue
)

2374 ià(
	`ioùl
(
‰
->
_fd
, 
I_POP
, 
NULL
) < 0)

2380 ià(
	`ioùl
(
‰
->
_fd
, 
I_PUSH
, "arp") < 0)

2382 
	`msg
(
M_ERR
, "Can't…ush ARP module\n");

2386 ià((
¬p_fd
 = 
	`İ’
(
¬p_node
, 
O_RDWR
, 0)) < 0)

2388 
	`msg
(
M_ERR
, "Cª'ˆİ’ %s\n", 
¬p_node
);

2391 ià(
	`ioùl
(
¬p_fd
, 
I_PUSH
, "arp") < 0)

2393 
	`msg
(
M_ERR
, "Can't…ush ARP module\n");

2397 
¡rioc_if
.
ic_cmd
 = 
SIOCSLIFNAME
;

2398 
¡rioc_if
.
ic_timout
 = 0;

2399 
¡rioc_if
.
ic_Ën
 = (
iä
);

2400 
¡rioc_if
.
ic_dp
 = (*)&
iä
;

2401 ià(
	`ioùl
(
¬p_fd
, 
I_STR
, &
¡rioc_if
) < 0)

2403 
	`msg
(
M_ERR
, "Can't set ifnameo‡rp\n");

2407 ià((
_muxid
 = 
	`ioùl
(
‰
->
_fd
, 
lšk_ty³
, 
if_fd
)) < 0)

2409 
	`msg
(
M_ERR
, "Cª'ˆlšk % deviûØIP", 
dev_tuÁ­_ty³
);

2412 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2414 ià((
¬p_muxid
 = 
	`ioùl
(
‰
->
_fd
, 
lšk_ty³
, 
¬p_fd
)) < 0)

2416 
	`msg
(
M_ERR
, "Cª'ˆlšk % deviûØARP", 
dev_tuÁ­_ty³
);

2418 
	`şo£
(
¬p_fd
);

2421 
	`CLEAR
(
iä
);

2422 
	`¡ºıyÁ
(
iä
.
liä_Çme
, 
‰
->
aùu®_Çme
, (ifr.lifr_name));

2423 
iä
.
liä__muxid
 = 
_muxid
;

2424 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2426 
iä
.
liä_¬p_muxid
 = 
¬p_muxid
;

2429 ià(
	`ioùl
(
‰
->
_fd
, 
SIOCSLIFMUXID
, &
iä
) < 0)

2431 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2433 
	`ioùl
(
‰
->
_fd
, 
I_PUNLINK
, 
¬p_muxid
);

2435 
	`ioùl
(
‰
->
_fd
, 
I_PUNLINK
, 
_muxid
);

2436 
	`msg
(
M_ERR
, "Can't set multiplexor id");

2439 
	`£t_nÚblock
(
‰
->
fd
);

2440 
	`£t_şÛxec
(
‰
->
fd
);

2441 
	`£t_şÛxec
(
‰
->
_fd
);

2443 
	`msg
(
M_INFO
, "TUN/TAP deviû % İ’ed", 
‰
->
aùu®_Çme
);

2444 
	}
}

2447 
	$sŞ¬is_şo£_tun
(
tuÁ­
 *
‰
)

2449 ià(
‰
)

2452 ià(
‰
->
did_ifcÚfig_v6_£tup
)

2454 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2455 
	`¬gv_´štf
Ğ&
¬gv
, "%s %s inet6 unplumb",

2456 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
 );

2457 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2458 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "Solaris ifconfig inet6 unplumb failed");

2459 
	`¬gv_»£t
(&
¬gv
);

2462 ià(
‰
->
_fd
 >= 0)

2464 
liäeq
 
iä
;

2465 
	`CLEAR
(
iä
);

2466 
	`¡ºıyÁ
(
iä
.
liä_Çme
, 
‰
->
aùu®_Çme
, (ifr.lifr_name));

2468 ià(
	`ioùl
(
‰
->
_fd
, 
SIOCGLIFFLAGS
, &
iä
) < 0)

2470 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't get iface flags");

2473 ià(
	`ioùl
(
‰
->
_fd
, 
SIOCGLIFMUXID
, &
iä
) < 0)

2475 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't get multiplexor id");

2478 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
)

2480 ià(
	`ioùl
(
‰
->
_fd
, 
I_PUNLINK
, 
iä
.
liä_¬p_muxid
) < 0)

2482 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't unlink interface(arp)");

2486 ià(
	`ioùl
(
‰
->
_fd
, 
I_PUNLINK
, 
iä
.
liä__muxid
) < 0)

2488 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't unlink interface(ip)");

2491 
	`şo£
(
‰
->
_fd
);

2492 
‰
->
_fd
 = -1;

2495 ià(
‰
->
fd
 >= 0)

2497 
	`şo£
(
‰
->
fd
);

2498 
‰
->
fd
 = -1;

2501 
	}
}

2507 
	$şo£_tun
(
tuÁ­
 *
‰
)

2509 ià(
‰
)

2511 
	`sŞ¬is_şo£_tun
(
‰
);

2513 ià(
‰
->
aùu®_Çme
)

2515 
	`ä“
(
‰
->
aùu®_Çme
);

2518 
	`ş—r_tuÁ­
(
‰
);

2519 
	`ä“
(
‰
);

2521 
	}
}

2524 
	$sŞ¬is_”rÜ_şo£
(
tuÁ­
 *
‰
, cÚ¡ 
’v_£t
 *
es
,

2525 cÚ¡ *
aùu®
, 
boŞ
 
uÅlumb_š‘6
 )

2527 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2529 ià(
uÅlumb_š‘6
)

2531 
	`¬gv_´štf
Ğ&
¬gv
, "%s %s inet6 unplumb",

2532 
IFCONFIG_PATH
, 
aùu®
 );

2533 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2534 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig inet6 unplumb failed");

2537 
	`¬gv_´štf
(&
¬gv
,

2539 
IFCONFIG_PATH
,

2540 
aùu®
);

2542 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2543 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "Solaris ifconfig unplumb failed");

2544 
	`şo£_tun
(
‰
);

2545 
	`msg
(
M_FATAL
, "Solaris ifconfig failed");

2546 
	`¬gv_»£t
(&
¬gv
);

2547 
	}
}

2550 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2552 
¡rbuf
 
sbuf
;

2553 
sbuf
.
Ën
 =†en;

2554 
sbuf
.
buf
 = (*)buf;

2555  
	`putmsg
(
‰
->
fd
, 
NULL
, &
sbuf
, 0è>ğ0 ? sbuf.
Ën
 : -1;

2556 
	}
}

2559 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2561 
¡rbuf
 
sbuf
;

2562 
f
 = 0;

2564 
sbuf
.
maxËn
 = 
Ën
;

2565 
sbuf
.
buf
 = (*)buf;

2566  
	`g‘msg
(
‰
->
fd
, 
NULL
, &
sbuf
, &
f
è>ğ0 ? sbuf.
Ën
 : -1;

2567 
	}
}

2569 #–ià
defšed
(
TARGET_OPENBSD
)

2572 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2574 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

2577 ià(
‰
->
fd
 >= 0)

2579 
tunšfo
 
šfo
;

2581 ià(
	`ioùl
(
‰
->
fd
, 
TUNGIFINFO
, &
šfo
) < 0)

2583 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't get interface info");

2586 #ifdeà
IFF_MULTICAST


2587 
šfo
.
æags
 |ğ
IFF_MULTICAST
;

2590 ià(
	`ioùl
(
‰
->
fd
, 
TUNSIFINFO
, &
šfo
) < 0)

2592 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Can't set interface info");

2595 
	}
}

2607 
	$şo£_tun
(
tuÁ­
 *
‰
)

2611 ià(
‰
 && (‰->
ty³
 =ğ
DEV_TYPE_TUN
 ||t->
³rsi¡’t_if
 ) )

2613 
	`şo£_tun_g’”ic
(
‰
);

2614 
	`ä“
(
‰
);

2616 ià(
‰
)

2618 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2619 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2624 
	`¬gv_´štf
(&
¬gv
, "%s %s destroy",

2625 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
);

2627 
	`şo£_tun_g’”ic
(
‰
);

2629 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2630 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "OpenBSD 'destroyun interface' failed (non-critical)");

2632 
	`ä“
(
‰
);

2634 
	}
}

2637 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2639  
	`wr™e_tun_h—d”
(
‰
, 
buf
, 
Ën
);

2640 
	}
}

2643 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2645  
	`»ad_tun_h—d”
(
‰
, 
buf
, 
Ën
);

2646 
	}
}

2648 #–ià
defšed
(
TARGET_NETBSD
)

2665 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2667 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

2669 ià(
‰
->
fd
 >= 0)

2671 
i
 = 
IFF_POINTOPOINT
|
IFF_MULTICAST
;

2672 
	`ioùl
(
‰
->
fd
, 
TUNSIFMODE
, &
i
);

2673 
i
 = 0;

2674 
	`ioùl
(
‰
->
fd
, 
TUNSLMODE
, &
i
);

2676 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2678 
i
 = 1;

2679 ià(
	`ioùl
(
‰
->
fd
, 
TUNSIFHEAD
, &
i
) < 0)

2681 
	`msg
(
M_WARN
 | 
M_ERRNO
, "ioctl(TUNSIFHEAD)");

2685 
	}
}

2692 
	$şo£_tun
(
tuÁ­
 *
‰
)

2696 ià(
‰
 && (t->
ty³
 !ğ
DEV_TYPE_TUN
 ||t->
³rsi¡’t_if
 ) )

2698 
	`şo£_tun_g’”ic
(
‰
);

2699 
	`ä“
(
‰
);

2701 ià(
‰
)

2703 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

2704 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2709 
	`¬gv_´štf
(&
¬gv
, "%s %s destroy",

2710 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
);

2712 
	`şo£_tun_g’”ic
(
‰
);

2714 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2715 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "NetBSD 'destroyun interface' failed (non-critical)");

2717 
	`ä“
(
‰
);

2719 
	}
}

2721 
šlše
 

2722 
	$Ãtbsd_modify_»ad_wr™e_»tuº
(
Ën
)

2724 ià(
Ën
 > 0)

2726  
Ën
 > (
u_št32_t
) ?†en - (u_int32_t) : 0;

2730  
Ën
;

2732 
	}
}

2735 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2737 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2739 
u_št32_t
 
ty³
;

2740 
iovec
 
iv
[2];

2741 
İ’v²_hdr
 *
h
;

2743 
h
 = (
İ’v²_hdr
 *è
buf
;

2745 ià(
	`OPENVPN_IPH_GET_VER
(
h
->
v”siÚ_Ën
) == 6)

2747 
ty³
 = 
	`htÚl
(
AF_INET6
);

2751 
ty³
 = 
	`htÚl
(
AF_INET
);

2754 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2755 
iv
[0].
iov_Ën
 = (
ty³
);

2756 
iv
[1].
iov_ba£
 = 
buf
;

2757 
iv
[1].
iov_Ën
 = 
Ën
;

2759  
	`Ãtbsd_modify_»ad_wr™e_»tuº
(
	`wr™ev
(
‰
->
fd
, 
iv
, 2));

2763  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

2765 
	}
}

2768 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2770 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2772 
u_št32_t
 
ty³
;

2773 
iovec
 
iv
[2];

2775 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2776 
iv
[0].
iov_Ën
 = (
ty³
);

2777 
iv
[1].
iov_ba£
 = 
buf
;

2778 
iv
[1].
iov_Ën
 = 
Ën
;

2780  
	`Ãtbsd_modify_»ad_wr™e_»tuº
(
	`»adv
(
‰
->
fd
, 
iv
, 2));

2784  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

2786 
	}
}

2788 #–ià
defšed
(
TARGET_FREEBSD
)

2790 
šlše
 

2791 
	$ä“bsd_modify_»ad_wr™e_»tuº
(
Ën
)

2793 ià(
Ën
 > 0)

2795  
Ën
 > (
u_št32_t
) ?†en - (u_int32_t) : 0;

2799  
Ën
;

2801 
	}
}

2804 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2806 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

2808 ià(
‰
->
fd
 >ğ0 &&t->
ty³
 =ğ
DEV_TYPE_TUN
)

2810 
i
 = 
IFF_POINTOPOINT
 | 
IFF_MULTICAST
;

2812 ià(
	`ioùl
(
‰
->
fd
, 
TUNSIFMODE
, &
i
) < 0)

2814 
	`msg
(
M_WARN
 | 
M_ERRNO
, "ioctl(TUNSIFMODE)");

2816 
i
 = 1;

2817 ià(
	`ioùl
(
‰
->
fd
, 
TUNSIFHEAD
, &
i
) < 0)

2819 
	`msg
(
M_WARN
 | 
M_ERRNO
, "ioctl(TUNSIFHEAD)");

2822 
	}
}

2832 
	$şo£_tun
(
tuÁ­
 *
‰
)

2834 ià(
‰
 &&t->
³rsi¡’t_if
)

2836 
	`şo£_tun_g’”ic
(
‰
);

2837 
	`ä“
(
‰
);

2839 ià(
‰
)

2841 
¬gv
‡rgv = 
	`¬gv_Ãw
();

2846 
	`¬gv_´štf
(&
¬gv
, "%s %s destroy",

2847 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
);

2849 
	`şo£_tun_g’”ic
(
‰
);

2851 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

2852 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "FreeBSD 'destroyun interface' failed (non-critical)");

2854 
	`ä“
(
‰
);

2856 
	}
}

2859 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2861 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2863 
u_št32_t
 
ty³
;

2864 
iovec
 
iv
[2];

2865 

 *
h
;

2867 
h
 = (

 *è
buf
;

2869 ià(
h
->
_v
 == 6)

2871 
ty³
 = 
	`htÚl
(
AF_INET6
);

2875 
ty³
 = 
	`htÚl
(
AF_INET
);

2878 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2879 
iv
[0].
iov_Ën
 = (
ty³
);

2880 
iv
[1].
iov_ba£
 = 
buf
;

2881 
iv
[1].
iov_Ën
 = 
Ën
;

2883  
	`ä“bsd_modify_»ad_wr™e_»tuº
(
	`wr™ev
(
‰
->
fd
, 
iv
, 2));

2887  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

2889 
	}
}

2892 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2894 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2896 
u_št32_t
 
ty³
;

2897 
iovec
 
iv
[2];

2899 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2900 
iv
[0].
iov_Ën
 = (
ty³
);

2901 
iv
[1].
iov_ba£
 = 
buf
;

2902 
iv
[1].
iov_Ën
 = 
Ën
;

2904  
	`ä“bsd_modify_»ad_wr™e_»tuº
(
	`»adv
(
‰
->
fd
, 
iv
, 2));

2908  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

2910 
	}
}

2912 #–ià
defšed
(
TARGET_DRAGONFLY
)

2914 
šlše
 

2915 
	$d¿gÚæy_modify_»ad_wr™e_»tuº
(
Ën
)

2917 ià(
Ën
 > 0)

2919  
Ën
 > (
u_št32_t
) ?†en - (u_int32_t) : 0;

2923  
Ën
;

2925 
	}
}

2928 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

2930 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

2932 ià(
‰
->
fd
 >= 0)

2934 
i
 = 0;

2937 
	`ioùl
(
‰
->
fd
, 
TUNSLMODE
, &
i
);

2938 
i
 = 1;

2939 
	`ioùl
(
‰
->
fd
, 
TUNSIFHEAD
, &
i
);

2941 
	}
}

2944 
	$şo£_tun
(
tuÁ­
 *
‰
)

2946 ià(
‰
)

2948 
	`şo£_tun_g’”ic
(
‰
);

2949 
	`ä“
(
‰
);

2951 
	}
}

2954 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2956 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2958 
u_št32_t
 
ty³
;

2959 
iovec
 
iv
[2];

2960 

 *
h
;

2962 
h
 = (

 *è
buf
;

2964 ià(
h
->
_v
 == 6)

2966 
ty³
 = 
	`htÚl
(
AF_INET6
);

2970 
ty³
 = 
	`htÚl
(
AF_INET
);

2973 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2974 
iv
[0].
iov_Ën
 = (
ty³
);

2975 
iv
[1].
iov_ba£
 = 
buf
;

2976 
iv
[1].
iov_Ën
 = 
Ën
;

2978  
	`d¿gÚæy_modify_»ad_wr™e_»tuº
(
	`wr™ev
(
‰
->
fd
, 
iv
, 2));

2982  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

2984 
	}
}

2987 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

2989 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

2991 
u_št32_t
 
ty³
;

2992 
iovec
 
iv
[2];

2994 
iv
[0].
iov_ba£
 = (*)&
ty³
;

2995 
iv
[0].
iov_Ën
 = (
ty³
);

2996 
iv
[1].
iov_ba£
 = 
buf
;

2997 
iv
[1].
iov_Ën
 = 
Ën
;

2999  
	`d¿gÚæy_modify_»ad_wr™e_»tuº
(
	`»adv
(
‰
->
fd
, 
iv
, 2));

3003  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

3005 
	}
}

3007 #–ià
defšed
(
TARGET_DARWIN
)

3023 #ifdeà
HAVE_NET_IF_UTUN_H


3031 
	$utun_İ’_h–³r
(
ùl_šfo
 
ùlInfo
, 
utuÂum
)

3033 
sockaddr_ùl
 
sc
;

3034 
fd
;

3036 
fd
 = 
	`sock‘
(
PF_SYSTEM
, 
SOCK_DGRAM
, 
SYSPROTO_CONTROL
);

3038 ià(
fd
 < 0)

3040 
	`msg
(
M_INFO
 | 
M_ERRNO
, "Opening utun (socket(SYSPROTO_CONTROL))");

3044 ià(
	`ioùl
(
fd
, 
CTLIOCGINFO
, &
ùlInfo
) == -1)

3046 
	`şo£
(
fd
);

3047 
	`msg
(
M_INFO
 | 
M_ERRNO
, "Opening utun (ioctl(CTLIOCGINFO))");

3052 
sc
.
sc_id
 = 
ùlInfo
.
ùl_id
;

3053 
sc
.
sc_Ën
 = (sc);

3054 
sc
.
sc_çmy
 = 
AF_SYSTEM
;

3055 
sc
.
ss_sy§ddr
 = 
AF_SYS_CONTROL
;

3057 
sc
.
sc_un™
 = 
utuÂum
+1;

3063 ià(
	`cÚÃù
(
fd
, (
sockaddr
 *)&
sc
, (sc)) < 0)

3065 
	`msg
(
M_INFO
 | 
M_ERRNO
, "Opening utun (connect(AF_SYS_CONTROL))");

3066 
	`şo£
(
fd
);

3070 
	`£t_nÚblock
(
fd
);

3071 
	`£t_şÛxec
(
fd
);

3073  
fd
;

3074 
	}
}

3077 
	$İ’_d¬wš_utun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

3079 
ùl_šfo
 
ùlInfo
;

3080 
fd
;

3081 
utuÂame
[20];

3082 
utuÂum
 = -1;

3083 
sockËn_t
 
utuÂame_Ën
 = (
utuÂame
);

3087 ià(
dev_node
 && (
	`¡rcmp
("utun", dev_node) != 0 ))

3089 ià(
	`ssÿnf
(
dev_node
, "utun%d", &
utuÂum
) != 1)

3091 
	`msg
(
M_FATAL
, "Cannot…arse 'dev-node %s'…lease use 'dev-node utunX'"

3092 "tØu£‡ utuÀdeviû‚umb” X", 
dev_node
);

3098 
	`CLEAR
(
ùlInfo
);

3099 ià(
	`¡¾ıy
(
ùlInfo
.
ùl_Çme
, 
UTUN_CONTROL_NAME
, (ctlInfo.ctl_name)) >=

3100 (
ùlInfo
.
ùl_Çme
))

3102 
	`msg
(
M_ERR
, "Opening utun: UTUN_CONTROL_NAMEoo†ong");

3106 ià(
utuÂum
 == -1)

3108 
utuÂum
 = 0; utunnum<255; utunnum++)

3110 
fd
 = 
	`utun_İ’_h–³r
(
ùlInfo
, 
utuÂum
);

3113 ià(
fd
 !=-1)

3121 
fd
 = 
	`utun_İ’_h–³r
(
ùlInfo
, 
utuÂum
);

3125 
‰
->
fd
 = fd;

3127 ià(
fd
 < 0)

3133 ià(
	`g‘sockİt
(
fd
, 
SYSPROTO_CONTROL
, 
UTUN_OPT_IFNAME
, 
utuÂame
, &
utuÂame_Ën
))

3135 
	`msg
(
M_ERR
 | 
M_ERRNO
, "Error„etrieving utun interface‚ame");

3138 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
utuÂame
, 
NULL
);

3140 
	`msg
(
M_INFO
, "O³Ãd utuÀdeviû %s", 
utuÂame
);

3141 
‰
->
is_utun
 = 
Œue
;

3142 
	}
}

3147 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

3149 #ifdeà
HAVE_NET_IF_UTUN_H


3151 ià((!
dev_node
 && 
‰
->
ty³
==
DEV_TYPE_TUN
)

3152 || (
dev_node
 && !
	`¡ºcmp
(dev_node, "utun", 4)))

3157 ià(
‰
->
ty³
!=
DEV_TYPE_TUN
)

3159 
	`msg
(
M_FATAL
, "Cannot use utun devices with --dev-type %s",

3160 
	`dev_ty³_¡ršg
(
dev
, 
dev_ty³
));

3165 
	`İ’_d¬wš_utun
(
dev
, 
dev_ty³
, 
dev_node
, 
‰
);

3167 ià(!
‰
->
is_utun
)

3169 ià(!
dev_node
)

3172 
	`msg
(
M_INFO
, "Failedo open utun device. Falling backo /dev/tun device");

3173 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
NULL
, 
Œue
, 
‰
);

3179 
	`msg
(
M_FATAL
, "Cannot open utun device");

3191 ià(
dev_node
 && 
	`¡rcmp
(dev_node, "tun")==0)

3193 
dev_node
 = 
NULL
;

3196 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

3198 
	}
}

3201 
	$şo£_tun
(
tuÁ­
 *
‰
)

3203 ià(
‰
)

3205 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3206 
¬gv
‡rgv = 
	`¬gv_Ãw
();

3208 ià(
‰
->
did_ifcÚfig_v6_£tup
)

3210 cÚ¡ *
ifcÚfig_v6_loÿl
 =

3211 
	`´št_š6_addr
(
‰
->
loÿl_v6
, 0, &
gc
);

3213 
	`¬gv_´štf
(&
¬gv
, "%s delete -inet6 %s",

3214 
ROUTE_PATH
, 
ifcÚfig_v6_loÿl
 );

3215 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

3216 
	`İ’v²_execve_check
(&
¬gv
, 
NULL
, 0, "MacOS X 'remove inet6„oute' failed (non-critical)");

3219 
	`şo£_tun_g’”ic
(
‰
);

3220 
	`ä“
(
‰
);

3221 
	`¬gv_»£t
(&
¬gv
);

3222 
	`gc_ä“
(&
gc
);

3224 
	}
}

3227 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

3229 #ifdeà
HAVE_NET_IF_UTUN_H


3230 ià(
‰
->
is_utun
)

3232  
	`wr™e_tun_h—d”
(
‰
, 
buf
, 
Ën
);

3236  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

3237 
	}
}

3240 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

3242 #ifdeà
HAVE_NET_IF_UTUN_H


3243 ià(
‰
->
is_utun
)

3245  
	`»ad_tun_h—d”
(
‰
, 
buf
, 
Ën
);

3249  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

3250 
	}
}

3252 #–ià
defšed
(
TARGET_AIX
)

3255 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

3257 
tuÂame
[256];

3258 
dyÇmic_Çme
[20];

3259 cÚ¡ *
p
;

3261 ià(
‰
->
ty³
 =ğ
DEV_TYPE_NULL
)

3263 
	`İ’_nuÎ
(
‰
);

3267 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

3269 
	`msg
(
M_FATAL
, "no support for 'tun' devices on AIX" );

3272 ià(
	`¡ºcmp
Ğ
dev
, "p", 3 ) !ğ0 || 
dev_node
)

3274 
	`msg
(
M_FATAL
, "'--dev %s'‡nd/Ü '--dev-node'‚Ù suµÜ‹d oÀAIX, u£ '--dev­0', 'p1',ƒtc.", 
dev
 );

3277 ià(
	`¡rcmp
Ğ
dev
, "tap" ) == 0)

3279 
i
;

3280 
i
 = 0; i<99; i++)

3282 
	`İ’v²_¢´štf
(
tuÂame
, ÑuÂame), "/dev/p%d", 
i
);

3283 ià(
	`acûss
Ğ
tuÂame
, 
F_OK
 ) < 0 && 
”ºo
 =ğ
ENOENT
)

3288 ià(
i
 >= 99)

3290 
	`msg
Ğ
M_FATAL
, "cannot find unusedap device" );

3293 
	`İ’v²_¢´štf
Ğ
dyÇmic_Çme
, (dyÇmic_Çme), "p%d", 
i
 );

3294 
dev
 = 
dyÇmic_Çme
;

3299 
p
 = &
dev
[3];

3300 
	`isdig™
(*
p
) )

3302 
p
++;

3304 ià(*
p
 != '\0')

3306 
	`msg
Ğ
M_FATAL
, "TAP device‚ame must be '--devapNNNN'" );

3309 
	`İ’v²_¢´štf
(
tuÂame
, ÑuÂame), "/dev/%s", 
dev
);

3314 ià(
	`acûss
Ğ
tuÂame
, 
F_OK
 ) < 0 && 
”ºo
 =ğ
ENOENT
)

3319 
¬gv
‡rgv = 
	`¬gv_Ãw
();

3320 
’v_£t
 *
es
 = 
	`’v_£t_ü—‹
(
NULL
);

3321 
	`¬gv_´štf
(&
¬gv
, "% % ü—‹", 
IFCONFIG_PATH
, 
dev
);

3322 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

3323 
	`’v_£t_add
Ğ
es
, "ODMDIR=/etc/objrepos" );

3324 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 
S_FATAL
, "AIX 'createun interface' failed");

3325 
	`’v_£t_de¡roy
(
es
);

3330 
‰
->
³rsi¡’t_if
 = 
TRUE
;

3333 ià((
‰
->
fd
 = 
	`İ’
(
tuÂame
, 
O_RDWR
)) < 0)

3335 
	`msg
(
M_ERR
, "CªnÙ o³ÀTAP deviû '%s'", 
tuÂame
);

3338 
	`£t_nÚblock
(
‰
->
fd
);

3339 
	`£t_şÛxec
(
‰
->
fd
);

3340 
	`msg
(
M_INFO
, "TUN/TAP deviû % İ’ed", 
tuÂame
);

3343 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
dev
, 
NULL
);

3344 
	}
}

3349 
	$şo£_tun
(
tuÁ­
 *
‰
)

3351 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3352 
¬gv
‡rgv = 
	`¬gv_Ãw
();

3353 
’v_£t
 *
es
 = 
	`’v_£t_ü—‹
(
NULL
);

3355 ià(!
‰
)

3362 ià(
‰
->
³rsi¡’t_if
)

3364 
	`¬gv_´štf
(&
¬gv
, "%s %s 0.0.0.0 down",

3365 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
);

3369 
	`¬gv_´štf
(&
¬gv
, "%s %s destroy",

3370 
IFCONFIG_PATH
, 
‰
->
aùu®_Çme
);

3373 
	`şo£_tun_g’”ic
(
‰
);

3374 
	`¬gv_msg
(
M_INFO
, &
¬gv
);

3375 
	`’v_£t_add
Ğ
es
, "ODMDIR=/etc/objrepos" );

3376 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, "AIX 'destroyap interface' failed (non-critical)");

3378 
	`ä“
(
‰
);

3379 
	`’v_£t_de¡roy
(
es
);

3380 
	}
}

3383 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

3385  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

3386 
	}
}

3389 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

3391  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

3392 
	}
}

3394 #–ià
defšed
(
_WIN32
)

3397 
	$tun_»ad_queue
(
tuÁ­
 *
‰
, 
maxsize
)

3399 ià(
‰
->
»ads
.
io¡©e
 =ğ
IOSTATE_INITIAL
)

3401 
DWORD
 
Ën
;

3402 
BOOL
 
¡©us
;

3403 
”r
;

3406 
‰
->
»ads
.
buf
 =t->»ads.
buf_š™
;

3408 
Ën
 = 
maxsize
 ? maxsiz: 
	`BLEN
(&
‰
->
»ads
.
buf
);

3409 
	`ASSERT
(
Ën
 <ğ
	`BLEN
(&
‰
->
»ads
.
buf
));

3412 
	`ASSERT
(
	`Re£tEv’t
(
‰
->
»ads
.
ov”Ïµed
.
hEv’t
));

3414 
¡©us
 = 
	`R—dFe
(

3415 
‰
->
hªd
,

3416 
	`BPTR
(&
‰
->
»ads
.
buf
),

3417 
Ën
,

3418 &
‰
->
»ads
.
size
,

3419 &
‰
->
»ads
.
ov”Ïµed


3422 ià(
¡©us
)

3425 
	`ASSERT
(
	`S‘Ev’t
(
‰
->
»ads
.
ov”Ïµed
.
hEv’t
));

3427 
‰
->
»ads
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3428 
‰
->
»ads
.
¡©us
 = 0;

3430 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Read immediate„eturn [%d,%d]",

3431 (è
Ën
,

3432 (è
‰
->
»ads
.
size
);

3436 
”r
 = 
	`G‘La¡E¼Ü
();

3437 ià(
”r
 =ğ
ERROR_IO_PENDING
)

3439 
‰
->
»ads
.
io¡©e
 = 
IOSTATE_QUEUED
;

3440 
‰
->
»ads
.
¡©us
 = 
”r
;

3441 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Read queued [%d]",

3442 (è
Ën
);

3446 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3447 
	`ASSERT
(
	`S‘Ev’t
(
‰
->
»ads
.
ov”Ïµed
.
hEv’t
));

3448 
‰
->
»ads
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3449 
‰
->
»ads
.
¡©us
 = 
”r
;

3450 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Readƒrror [%d] : %s",

3451 (è
Ën
,

3452 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

3453 
	`gc_ä“
(&
gc
);

3457  
‰
->
»ads
.
io¡©e
;

3458 
	}
}

3461 
	$tun_wr™e_queue
(
tuÁ­
 *
‰
, 
bufãr
 *
buf
)

3463 ià(
‰
->
wr™es
.
io¡©e
 =ğ
IOSTATE_INITIAL
)

3465 
BOOL
 
¡©us
;

3466 
”r
;

3469 
‰
->
wr™es
.
buf
 =t->wr™es.
buf_š™
;

3470 
‰
->
wr™es
.
buf
.
Ën
 = 0;

3471 
	`ASSERT
(
	`buf_cİy
(&
‰
->
wr™es
.
buf
, buf));

3474 
	`ASSERT
(
	`Re£tEv’t
(
‰
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3476 
¡©us
 = 
	`Wr™eFe
(

3477 
‰
->
hªd
,

3478 
	`BPTR
(&
‰
->
wr™es
.
buf
),

3479 
	`BLEN
(&
‰
->
wr™es
.
buf
),

3480 &
‰
->
wr™es
.
size
,

3481 &
‰
->
wr™es
.
ov”Ïµed


3484 ià(
¡©us
)

3486 
‰
->
wr™es
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3489 
	`ASSERT
(
	`S‘Ev’t
(
‰
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3491 
‰
->
wr™es
.
¡©us
 = 0;

3493 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Write immediate„eturn [%d,%d]",

3494 
	`BLEN
(&
‰
->
wr™es
.
buf
),

3495 (è
‰
->
wr™es
.
size
);

3499 
”r
 = 
	`G‘La¡E¼Ü
();

3500 ià(
”r
 =ğ
ERROR_IO_PENDING
)

3502 
‰
->
wr™es
.
io¡©e
 = 
IOSTATE_QUEUED
;

3503 
‰
->
wr™es
.
¡©us
 = 
”r
;

3504 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Write queued [%d]",

3505 
	`BLEN
(&
‰
->
wr™es
.
buf
));

3509 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3510 
	`ASSERT
(
	`S‘Ev’t
(
‰
->
wr™es
.
ov”Ïµed
.
hEv’t
));

3511 
‰
->
wr™es
.
io¡©e
 = 
IOSTATE_IMMEDIATE_RETURN
;

3512 
‰
->
wr™es
.
¡©us
 = 
”r
;

3513 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Writeƒrror [%d] : %s",

3514 
	`BLEN
(&
‰
->
wr™es
.
buf
),

3515 
	`¡»¼Ü_wš32
(
”r
, &
gc
));

3516 
	`gc_ä“
(&
gc
);

3520  
‰
->
wr™es
.
io¡©e
;

3521 
	}
}

3524 
	$tun_fš®ize
(

3525 
HANDLE
 
h
,

3526 
ov”Ïµed_io
 *
io
,

3527 
bufãr
 *
buf
)

3529 
»t
 = -1;

3530 
BOOL
 
¡©us
;

3532 
io
->
io¡©e
)

3534 
IOSTATE_QUEUED
:

3535 
¡©us
 = 
	`G‘Ov”ÏµedResuÉ
(

3536 
h
,

3537 &
io
->
ov”Ïµed
,

3538 &
io
->
size
,

3539 
FALSE


3541 ià(
¡©us
)

3544 ià(
buf
)

3546 *
buf
 = 
io
->buf;

3548 
»t
 = 
io
->
size
;

3549 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3550 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3551 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Com¶‘iÚ sucûs [%d]", 
»t
);

3556 
»t
 = -1;

3557 ià(
	`G‘La¡E¼Ü
(è!ğ
ERROR_IO_INCOMPLETE
)

3561 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3562 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3563 
	`msg
(
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: TAP Completionƒrror");

3568 
IOSTATE_IMMEDIATE_RETURN
:

3569 
io
->
io¡©e
 = 
IOSTATE_INITIAL
;

3570 
	`ASSERT
(
	`Re£tEv’t
(
io
->
ov”Ïµed
.
hEv’t
));

3571 ià(
io
->
¡©us
)

3574 
	`S‘La¡E¼Ü
(
io
->
¡©us
);

3575 
»t
 = -1;

3576 
	`msg
(
D_WIN32_IO
 | 
M_ERRNO
, "WIN32 I/O: TAP Completion‚on-queuedƒrror");

3581 ià(
buf
)

3583 *
buf
 = 
io
->buf;

3585 
»t
 = 
io
->
size
;

3586 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Com¶‘iÚ‚Ú-queued sucûs [%d]", 
»t
);

3590 
IOSTATE_INITIAL
:

3591 
	`S‘La¡E¼Ü
(
ERROR_INVALID_FUNCTION
);

3592 
»t
 = -1;

3593 
	`dmsg
(
D_WIN32_IO
, "WIN32 I/O: TAP Completion BAD STATE");

3597 
	`ASSERT
(0);

3600 ià(
buf
)

3602 
buf
->
Ën
 = 
»t
;

3604  
»t
;

3605 
	}
}

3607 cÚ¡ 
p_»g
 *

3608 
	$g‘_p_»g
(
gc_¬’a
 *
gc
)

3610 
HKEY
 
ad­‹r_key
;

3611 
LONG
 
¡©us
;

3612 
DWORD
 
Ën
;

3613 
p_»g
 *
fœ¡
 = 
NULL
;

3614 
p_»g
 *
Ï¡
 = 
NULL
;

3615 
i
 = 0;

3617 
¡©us
 = 
	`RegO³nKeyEx
(

3618 
HKEY_LOCAL_MACHINE
,

3619 
ADAPTER_KEY
,

3621 
KEY_READ
,

3622 &
ad­‹r_key
);

3624 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3626 
	`msg
(
M_FATAL
, "E¼Ü o³nšg„egi¡ry key: %s", 
ADAPTER_KEY
);

3629 
Œue
)

3631 
’um_Çme
[256];

3632 
un™_¡ršg
[256];

3633 
HKEY
 
un™_key
;

3634 
compÚ’t_id_¡ršg
[] = "ComponentId";

3635 
compÚ’t_id
[256];

3636 
Ãt_cfg_š¡ªû_id_¡ršg
[] = "NetCfgInstanceId";

3637 
Ãt_cfg_š¡ªû_id
[256];

3638 
DWORD
 
d©a_ty³
;

3640 
Ën
 = (
’um_Çme
);

3641 
¡©us
 = 
	`RegEnumKeyEx
(

3642 
ad­‹r_key
,

3643 
i
,

3644 
’um_Çme
,

3645 &
Ën
,

3646 
NULL
,

3647 
NULL
,

3648 
NULL
,

3649 
NULL
);

3650 ià(
¡©us
 =ğ
ERROR_NO_MORE_ITEMS
)

3654 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3656 
	`msg
(
M_FATAL
, "Errorƒnumerating„egistry subkeys of key: %s",

3657 
ADAPTER_KEY
);

3660 
	`İ’v²_¢´štf
(
un™_¡ršg
, (unit_string), "%s\\%s",

3661 
ADAPTER_KEY
, 
’um_Çme
);

3663 
¡©us
 = 
	`RegO³nKeyEx
(

3664 
HKEY_LOCAL_MACHINE
,

3665 
un™_¡ršg
,

3667 
KEY_READ
,

3668 &
un™_key
);

3670 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3672 
	`dmsg
(
D_REGISTRY
, "E¼Ü o³nšg„egi¡ry key: %s", 
un™_¡ršg
);

3676 
Ën
 = (
compÚ’t_id
);

3677 
¡©us
 = 
	`RegQu”yV®ueEx
(

3678 
un™_key
,

3679 
compÚ’t_id_¡ršg
,

3680 
NULL
,

3681 &
d©a_ty³
,

3682 
compÚ’t_id
,

3683 &
Ën
);

3685 ià(
¡©us
 !ğ
ERROR_SUCCESS
 || 
d©a_ty³
 !ğ
REG_SZ
)

3687 
	`dmsg
(
D_REGISTRY
, "Error opening„egistry key: %s\\%s",

3688 
un™_¡ršg
, 
compÚ’t_id_¡ršg
);

3692 
Ën
 = (
Ãt_cfg_š¡ªû_id
);

3693 
¡©us
 = 
	`RegQu”yV®ueEx
(

3694 
un™_key
,

3695 
Ãt_cfg_š¡ªû_id_¡ršg
,

3696 
NULL
,

3697 &
d©a_ty³
,

3698 
Ãt_cfg_š¡ªû_id
,

3699 &
Ën
);

3701 ià(
¡©us
 =ğ
ERROR_SUCCESS
 && 
d©a_ty³
 =ğ
REG_SZ
)

3703 ià(!
	`¡rcmp
(
compÚ’t_id
, 
TAP_WIN_COMPONENT_ID
) ||

3704 !
	`¡rcmp
(
compÚ’t_id
, "roÙ\\" 
TAP_WIN_COMPONENT_ID
))

3706 
p_»g
 *
»g
;

3707 
	`ALLOC_OBJ_CLEAR_GC
(
»g
, 
p_»g
, 
gc
);

3708 
»g
->
guid
 = 
	`¡ršg_®loc
(
Ãt_cfg_š¡ªû_id
, 
gc
);

3711 ià(!
fœ¡
)

3713 
fœ¡
 = 
»g
;

3715 ià(
Ï¡
)

3717 
Ï¡
->
Ãxt
 = 
»g
;

3719 
Ï¡
 = 
»g
;

3723 
	`RegClo£Key
(
un™_key
);

3725 ++
i
;

3728 
	`RegClo£Key
(
ad­‹r_key
);

3729  
fœ¡
;

3730 
	}
}

3732 cÚ¡ 
·Ãl_»g
 *

3733 
	$g‘_·Ãl_»g
(
gc_¬’a
 *
gc
)

3735 
LONG
 
¡©us
;

3736 
HKEY
 
ÃtwÜk_cÚÃùiÚs_key
;

3737 
DWORD
 
Ën
;

3738 
·Ãl_»g
 *
fœ¡
 = 
NULL
;

3739 
·Ãl_»g
 *
Ï¡
 = 
NULL
;

3740 
i
 = 0;

3742 
¡©us
 = 
	`RegO³nKeyEx
(

3743 
HKEY_LOCAL_MACHINE
,

3744 
NETWORK_CONNECTIONS_KEY
,

3746 
KEY_READ
,

3747 &
ÃtwÜk_cÚÃùiÚs_key
);

3749 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3751 
	`msg
(
M_FATAL
, "E¼Ü o³nšg„egi¡ry key: %s", 
NETWORK_CONNECTIONS_KEY
);

3754 
Œue
)

3756 
’um_Çme
[256];

3757 
cÚÃùiÚ_¡ršg
[256];

3758 
HKEY
 
cÚÃùiÚ_key
;

3759 
WCHAR
 
Çme_d©a
[256];

3760 
DWORD
 
Çme_ty³
;

3761 cÚ¡ 
WCHAR
 
Çme_¡ršg
[] = 
L
"Name";

3763 
Ën
 = (
’um_Çme
);

3764 
¡©us
 = 
	`RegEnumKeyEx
(

3765 
ÃtwÜk_cÚÃùiÚs_key
,

3766 
i
,

3767 
’um_Çme
,

3768 &
Ën
,

3769 
NULL
,

3770 
NULL
,

3771 
NULL
,

3772 
NULL
);

3773 ià(
¡©us
 =ğ
ERROR_NO_MORE_ITEMS
)

3777 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3779 
	`msg
(
M_FATAL
, "Errorƒnumerating„egistry subkeys of key: %s",

3780 
NETWORK_CONNECTIONS_KEY
);

3783 
	`İ’v²_¢´štf
(
cÚÃùiÚ_¡ršg
, (connection_string),

3785 
NETWORK_CONNECTIONS_KEY
, 
’um_Çme
);

3787 
¡©us
 = 
	`RegO³nKeyEx
(

3788 
HKEY_LOCAL_MACHINE
,

3789 
cÚÃùiÚ_¡ršg
,

3791 
KEY_READ
,

3792 &
cÚÃùiÚ_key
);

3794 ià(
¡©us
 !ğ
ERROR_SUCCESS
)

3796 
	`dmsg
(
D_REGISTRY
, "E¼Ü o³nšg„egi¡ry key: %s", 
cÚÃùiÚ_¡ršg
);

3800 
Ën
 = (
Çme_d©a
);

3801 
¡©us
 = 
	`RegQu”yV®ueExW
(

3802 
cÚÃùiÚ_key
,

3803 
Çme_¡ršg
,

3804 
NULL
,

3805 &
Çme_ty³
,

3806 (
LPBYTE
è
Çme_d©a
,

3807 &
Ën
);

3809 ià(
¡©us
 !ğ
ERROR_SUCCESS
 || 
Çme_ty³
 !ğ
REG_SZ
)

3811 
	`dmsg
(
D_REGISTRY
, "Error opening„egistry key: %s\\%s\\%ls",

3812 
NETWORK_CONNECTIONS_KEY
, 
cÚÃùiÚ_¡ršg
, 
Çme_¡ršg
);

3816 
n
;

3817 
LPSTR
 
Çme
;

3818 
·Ãl_»g
 *
»g
;

3820 
	`ALLOC_OBJ_CLEAR_GC
(
»g
, 
·Ãl_»g
, 
gc
);

3821 
n
 = 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
Çme_d©a
, -1, 
NULL
, 0, NULL, NULL);

3822 
Çme
 = 
	`gc_m®loc
(
n
, 
çl£
, 
gc
);

3823 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
Çme_d©a
, -1, 
Çme
, 
n
, 
NULL
, NULL);

3824 
»g
->
Çme
 =‚ame;

3825 
»g
->
guid
 = 
	`¡ršg_®loc
(
’um_Çme
, 
gc
);

3828 ià(!
fœ¡
)

3830 
fœ¡
 = 
»g
;

3832 ià(
Ï¡
)

3834 
Ï¡
->
Ãxt
 = 
»g
;

3836 
Ï¡
 = 
»g
;

3838 
	`RegClo£Key
(
cÚÃùiÚ_key
);

3840 ++
i
;

3843 
	`RegClo£Key
(
ÃtwÜk_cÚÃùiÚs_key
);

3845  
fœ¡
;

3846 
	}
}

3852 
	$v”ify_255_255_255_252
(
š_addr_t
 
loÿl
, in_addr_ˆ
»mÙe
)

3854 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3855 cÚ¡ 
mask
 = 3;

3856 cÚ¡ *
”r
 = 
NULL
;

3858 ià(
loÿl
 =ğ
»mÙe
)

3860 
”r
 = "must be different";

3861 
”rÜ
;

3863 ià((
loÿl
 & (~
mask
)è!ğ(
»mÙe
 & (~mask)))

3865 
”r
 = "mustƒxist withinhe same 255.255.255.252 subnet. This is‡†imitation of --devun when used withhe TAP-WIN32 driver";

3866 
”rÜ
;

3868 ià((
loÿl
 & 
mask
) == 0

3869 || (
loÿl
 & 
mask
) == 3

3870 || (
»mÙe
 & 
mask
) == 0

3871 || (
»mÙe
 & 
mask
) == 3)

3873 
”r
 = "cannot usehe first or†ast‡ddress within‡ given 255.255.255.252 subnet. This is‡†imitation of --devun when used withhe TAP-WIN32 driver";

3874 
”rÜ
;

3877 
	`gc_ä“
(&
gc
);

3880 
”rÜ
:

3881 
	`msg
(
M_FATAL
, "Th”i ¨´obËm iÀyou¸£ËùiÚ oà--ifcÚfigƒndpošt [loÿl=%s,„emÙe=%s]. ThloÿÈªd„emÙVPNƒndpošt %s. Try '" 
PACKAGE
 " --show-valid-subnets' option for more info.",

3882 
	`´št_š_addr_t
(
loÿl
, 0, &
gc
),

3883 
	`´št_š_addr_t
(
»mÙe
, 0, &
gc
),

3884 
”r
);

3885 
	`gc_ä“
(&
gc
);

3886 
	}
}

3889 
	$show_v®id_wš32_tun_subÃts
()

3891 
i
;

3892 
cŞ
 = 0;

3894 
	`´štf
("On Windows,…oint-to-point IP support (i.e. --devun)\n");

3895 
	`´štf
("isƒmulated byhe TAP-Windows driver. The major†imitation\n");

3896 
	`´štf
("imposed byhis‡pproach ishathe --ifconfig†ocal‡nd\n");

3897 
	`´štf
("remoteƒndpoints must be…art ofhe same 255.255.255.252\n");

3898 
	`´štf
("subnet. The following†ist showsƒxamples ofƒndpoint\n");

3899 
	`´štf
("pairs which satisfyhis„equirement. Onlyhe final\n");

3900 
	`´štf
("component ofhe IP‡ddress…airs is‡t issue.\n\n");

3901 
	`´štf
("As‡nƒxample,he following option would be correct:\n");

3902 
	`´štf
(" --ifconfig 10.7.0.5 10.7.0.6 (on host A)\n");

3903 
	`´štf
(" --ifconfig 10.7.0.6 10.7.0.5 (on host B)\n");

3904 
	`´štf
("because [5,6] is…art ofhe below†ist.\n\n");

3906 
i
 = 0; i < 256; i += 4)

3908 
	`´štf
("[%3d,%3d] ", 
i
+1, i+2);

3909 ià(++
cŞ
 > 4)

3911 
cŞ
 = 0;

3912 
	`´štf
("\n");

3915 ià(
cŞ
)

3917 
	`´štf
("\n");

3919 
	}
}

3922 
	$show_p_wš_ad­‹rs
(
msgËv
, 
w¬Æev
)

3924 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

3926 
boŞ
 
w¬n_·Ãl_nuÎ
 = 
çl£
;

3927 
boŞ
 
w¬n_·Ãl_dup
 = 
çl£
;

3928 
boŞ
 
w¬n_p_dup
 = 
çl£
;

3930 
lšks
;

3932 cÚ¡ 
p_»g
 *
Œ
;

3933 cÚ¡ 
p_»g
 *
Œ1
;

3934 cÚ¡ 
·Ãl_»g
 *
´
;

3936 cÚ¡ 
p_»g
 *p_»g = 
	`g‘_p_»g
(&
gc
);

3937 cÚ¡ 
·Ãl_»g
 *·Ãl_»g = 
	`g‘_·Ãl_»g
(&
gc
);

3939 
	`msg
(
msgËv
, "Available TAP-WIN32‡dapters [name, GUID]:");

3942 
Œ
 = 
p_»g
;¸!ğ
NULL
;¸ğŒ->
Ãxt
)

3944 
lšks
 = 0;

3947 
´
 = 
·Ãl_»g
;…¸!ğ
NULL
;…¸ğ´->
Ãxt
)

3949 ià(!
	`¡rcmp
(
Œ
->
guid
, 
´
->guid))

3951 
	`msg
(
msgËv
, "'%s' %s", 
´
->
Çme
, 
Œ
->
guid
);

3952 ++
lšks
;

3956 ià(
lšks
 > 1)

3958 
w¬n_·Ãl_dup
 = 
Œue
;

3960 ià(
lšks
 == 0)

3964 
w¬n_·Ãl_nuÎ
 = 
Œue
;

3965 
	`msg
(
msgËv
, "[NULL] %s", 
Œ
->
guid
);

3970 
Œ
 = 
p_»g
;¸!ğ
NULL
;¸ğŒ->
Ãxt
)

3972 
Œ1
 = 
p_»g
;r1 !ğ
NULL
;r1 =r1->
Ãxt
)

3974 ià(
Œ
 !ğ
Œ1
 && !
	`¡rcmp
Ñr->
guid
,r1->guid))

3976 
w¬n_p_dup
 = 
Œue
;

3982 ià(
w¬n_p_dup
)

3984 
	`msg
(
w¬Æev
, "WARNING: Some TAP-Windows‡dapters have duplicate GUIDs");

3987 ià(
w¬n_·Ãl_dup
)

3989 
	`msg
(
w¬Æev
, "WARNING: Some TAP-Windows‡dapters have duplicate†inks fromhe Network Connections control…anel");

3992 ià(
w¬n_·Ãl_nuÎ
)

3994 
	`msg
(
w¬Æev
, "WARNING: Some TAP-Windows‡dapters have‚o†ink fromhe Network Connections control…anel");

3997 
	`gc_ä“
(&
gc
);

3998 
	}
}

4003 
boŞ


4004 
	$is_p_wš
(cÚ¡ *
guid
, cÚ¡ 
p_»g
 *tap_reg)

4006 cÚ¡ 
p_»g
 *
Œ
;

4008 
Œ
 = 
p_»g
;¸!ğ
NULL
;¸ğŒ->
Ãxt
)

4010 ià(
guid
 && !
	`¡rcmp
(
Œ
->guid, guid))

4012  
Œue
;

4016  
çl£
;

4017 
	}
}

4020 
	$guid_to_Çme
(cÚ¡ *
guid
, cÚ¡ 
·Ãl_»g
 *panel_reg)

4022 cÚ¡ 
·Ãl_»g
 *
´
;

4024 
´
 = 
·Ãl_»g
;…¸!ğ
NULL
;…¸ğ´->
Ãxt
)

4026 ià(
guid
 && !
	`¡rcmp
(
´
->guid, guid))

4028  
´
->
Çme
;

4032  
NULL
;

4033 
	}
}

4036 
	$Çme_to_guid
(cÚ¡ *
Çme
, cÚ¡ 
p_»g
 *p_»g, cÚ¡ 
·Ãl_»g
 *panel_reg)

4038 cÚ¡ 
·Ãl_»g
 *
´
;

4040 
´
 = 
·Ãl_»g
;…¸!ğ
NULL
;…¸ğ´->
Ãxt
)

4042 ià(
Çme
 && !
	`¡rcmp
(
´
->Çme,‚ameè&& 
	`is_p_wš
Õr->
guid
, 
p_»g
))

4044  
´
->
guid
;

4048  
NULL
;

4049 
	}
}

4052 
	$©_Ëa¡_Úe_p_wš
(cÚ¡ 
p_»g
 *tap_reg)

4054 ià(!
p_»g
)

4056 
	`msg
(
M_FATAL
, "There‡re‚o TAP-Windows‡dapters onhis system. You should be‡bleo create‡ TAP-Windows‡dapter by goingo Start -> All Programs -> TAP-Windows -> Utilities -> Add‡‚ew TAP-Windows virtualƒthernet‡dapter.");

4058 
	}
}

4065 
	$g‘_un¥ecif›d_deviû_guid
(cÚ¡ 
deviû_numb”
,

4066 *
aùu®_Çme
,

4067 
aùu®_Çme_size
,

4068 cÚ¡ 
p_»g
 *
p_»g_¤c
,

4069 cÚ¡ 
·Ãl_»g
 *
·Ãl_»g_¤c
,

4070 
gc_¬’a
 *
gc
)

4072 cÚ¡ 
p_»g
 *p_»g = 
p_»g_¤c
;

4073 
bufãr
 
»t
 = 
	`ş—r_buf
();

4074 
bufãr
 
aùu®
 = 
	`ş—r_buf
();

4075 
i
;

4077 
	`ASSERT
(
deviû_numb”
 >= 0);

4080 ià(!
p_»g
)

4082  
NULL
;

4086 ià(
aùu®_Çme
)

4088 
	`ASSERT
(
aùu®_Çme_size
 > 0);

4089 
	`buf_£t_wr™e
(&
aùu®
, 
aùu®_Çme
, 
aùu®_Çme_size
);

4093 
i
 = 0; i < 
deviû_numb”
; i++)

4095 
p_»g
 =­_»g->
Ãxt
;

4096 ià(!
p_»g
)

4098  
NULL
;

4103 ià(
aùu®_Çme
)

4105 cÚ¡ *
aù
 = 
	`guid_to_Çme
(
p_»g
->
guid
, 
·Ãl_»g_¤c
);

4106 ià(
aù
)

4108 
	`buf_´štf
(&
aùu®
, "%s", 
aù
);

4112 
	`buf_´štf
(&
aùu®
, "%s", 
p_»g
->
guid
);

4117 
»t
 = 
	`®loc_buf_gc
(256, 
gc
);

4118 
	`buf_´štf
(&
»t
, "%s", 
p_»g
->
guid
);

4119  
	`BSTR
(&
»t
);

4120 
	}
}

4127 
	$g‘_deviû_guid
(cÚ¡ *
Çme
,

4128 *
aùu®_Çme
,

4129 
aùu®_Çme_size
,

4130 cÚ¡ 
p_»g
 *tap_reg,

4131 cÚ¡ 
·Ãl_»g
 *panel_reg,

4132 
gc_¬’a
 *
gc
)

4134 
bufãr
 
»t
 = 
	`®loc_buf_gc
(256, 
gc
);

4135 
bufãr
 
aùu®
 = 
	`ş—r_buf
();

4138 ià(!
p_»g
)

4140  
NULL
;

4144 ià(
aùu®_Çme
)

4146 
	`ASSERT
(
aùu®_Çme_size
 > 0);

4147 
	`buf_£t_wr™e
(&
aùu®
, 
aùu®_Çme
, 
aùu®_Çme_size
);

4151 ià(
	`is_p_wš
(
Çme
, 
p_»g
))

4153 cÚ¡ *
aù
 = 
	`guid_to_Çme
(
Çme
, 
·Ãl_»g
);

4154 
	`buf_´štf
(&
»t
, "%s", 
Çme
);

4155 ià(
aù
)

4157 
	`buf_´štf
(&
aùu®
, "%s", 
aù
);

4161 
	`buf_´štf
(&
aùu®
, "%s", 
Çme
);

4163  
	`BSTR
(&
»t
);

4168 cÚ¡ *
guid
 = 
	`Çme_to_guid
(
Çme
, 
p_»g
, 
·Ãl_»g
);

4169 ià(
guid
)

4171 
	`buf_´štf
(&
aùu®
, "%s", 
Çme
);

4172 
	`buf_´štf
(&
»t
, "%s", 
guid
);

4173  
	`BSTR
(&
»t
);

4177  
NULL
;

4178 
	}
}

4183 cÚ¡ 
IP_ADAPTER_INFO
 *

4184 
	$g‘_ad­‹r_šfo_li¡
(
gc_¬’a
 *
gc
)

4186 
ULONG
 
size
 = 0;

4187 
IP_ADAPTER_INFO
 *
pi
 = 
NULL
;

4188 
DWORD
 
¡©us
;

4190 ià((
¡©us
 = 
	`G‘Ad­‹rsInfo
(
NULL
, &
size
)è!ğ
ERROR_BUFFER_OVERFLOW
)

4192 
	`msg
(
M_INFO
, "GetAdaptersInfo #1 failed (status=%u) : %s",

4193 ()
¡©us
,

4194 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4198 
pi
 = (
PIP_ADAPTER_INFO
è
	`gc_m®loc
(
size
, 
çl£
, 
gc
);

4199 ià((
¡©us
 = 
	`G‘Ad­‹rsInfo
(
pi
, &
size
)è!ğ
NO_ERROR
)

4201 
	`msg
(
M_INFO
, "GetAdaptersInfo #2 failed (status=%u) : %s",

4202 ()
¡©us
,

4203 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4204 
pi
 = 
NULL
;

4207  
pi
;

4208 
	}
}

4210 cÚ¡ 
IP_PER_ADAPTER_INFO
 *

4211 
	$g‘_³r_ad­‹r_šfo
(cÚ¡ 
DWORD
 
šdex
, 
gc_¬’a
 *
gc
)

4213 
ULONG
 
size
 = 0;

4214 
IP_PER_ADAPTER_INFO
 *
pi
 = 
NULL
;

4215 
DWORD
 
¡©us
;

4217 ià(
šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

4219 ià((
¡©us
 = 
	`G‘P”Ad­‹rInfo
(
šdex
, 
NULL
, &
size
)è!ğ
ERROR_BUFFER_OVERFLOW
)

4221 
	`msg
(
M_INFO
, "GetPerAdapterInfo #1 failed (status=%u) : %s",

4222 ()
¡©us
,

4223 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4227 
pi
 = (
PIP_PER_ADAPTER_INFO
è
	`gc_m®loc
(
size
, 
çl£
, 
gc
);

4228 ià((
¡©us
 = 
	`G‘P”Ad­‹rInfo
((
ULONG
)
šdex
, 
pi
, &
size
)è=ğ
ERROR_SUCCESS
)

4230  
pi
;

4234 
	`msg
(
M_INFO
, "GetPerAdapterInfo #2 failed (status=%u) : %s",

4235 ()
¡©us
,

4236 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4240  
pi
;

4241 
	}
}

4243 cÚ¡ 
IP_INTERFACE_INFO
 *

4244 
	$g‘_š‹rçû_šfo_li¡
(
gc_¬’a
 *
gc
)

4246 
ULONG
 
size
 = 0;

4247 
IP_INTERFACE_INFO
 *
ii
 = 
NULL
;

4248 
DWORD
 
¡©us
;

4250 ià((
¡©us
 = 
	`G‘IÁ”çûInfo
(
NULL
, &
size
)è!ğ
ERROR_INSUFFICIENT_BUFFER
)

4252 
	`msg
(
M_INFO
, "GetInterfaceInfo #1 failed (status=%u) : %s",

4253 ()
¡©us
,

4254 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4258 
ii
 = (
PIP_INTERFACE_INFO
è
	`gc_m®loc
(
size
, 
çl£
, 
gc
);

4259 ià((
¡©us
 = 
	`G‘IÁ”çûInfo
(
ii
, &
size
)è=ğ
NO_ERROR
)

4261  
ii
;

4265 
	`msg
(
M_INFO
, "GetInterfaceInfo #2 failed (status=%u) : %s",

4266 ()
¡©us
,

4267 
	`¡»¼Ü_wš32
(
¡©us
, 
gc
));

4270  
ii
;

4271 
	}
}

4273 cÚ¡ 
IP_ADAPTER_INDEX_MAP
 *

4274 
	$g‘_š‹rçû_šfo
(
DWORD
 
šdex
, 
gc_¬’a
 *
gc
)

4276 cÚ¡ 
IP_INTERFACE_INFO
 *
li¡
 = 
	`g‘_š‹rçû_šfo_li¡
(
gc
);

4277 ià(
li¡
)

4279 
i
;

4280 
i
 = 0; i < 
li¡
->
NumAd­‹rs
; ++i)

4282 cÚ¡ 
IP_ADAPTER_INDEX_MAP
 *
š‹r
 = &
li¡
->
Ad­‹r
[
i
];

4283 ià(
šdex
 =ğ
š‹r
->
Index
)

4285  
š‹r
;

4289  
NULL
;

4290 
	}
}

4297 cÚ¡ 
IP_ADAPTER_INFO
 *

4298 
	$g‘_ad­‹r
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
, 
DWORD
 
šdex
)

4300 ià(
ai
 && 
šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

4302 cÚ¡ 
IP_ADAPTER_INFO
 *
a
;

4305 
a
 = 
ai
;‡ !ğ
NULL
;‡ =‡->
Next
)

4307 ià(
a
->
Index
 =ğ
šdex
)

4309  
a
;

4313  
NULL
;

4314 
	}
}

4316 cÚ¡ 
IP_ADAPTER_INFO
 *

4317 
	$g‘_ad­‹r_šfo
(
DWORD
 
šdex
, 
gc_¬’a
 *
gc
)

4319  
	`g‘_ad­‹r
(
	`g‘_ad­‹r_šfo_li¡
(
gc
), 
šdex
);

4320 
	}
}

4323 
	$g‘_ad­‹r_n__Ãtmask
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
)

4325 ià(
ai
)

4327 
n
 = 0;

4328 cÚ¡ 
IP_ADDR_STRING
 *

 = &
ai
->
IpAdd»ssLi¡
;

4330 

)

4332 ++
n
;

4333 

 = ip->
Next
;

4335  
n
;

4341 
	}
}

4343 
boŞ


4344 
	$g‘_ad­‹r__Ãtmask
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
, cÚ¡ 
n
, 
š_addr_t
 *

, in_addr_ˆ*
Ãtmask
)

4346 
boŞ
 
»t
 = 
çl£
;

4347 *

 = 0;

4348 *
Ãtmask
 = 0;

4350 ià(
ai
)

4352 cÚ¡ 
IP_ADDR_STRING
 *
li¡
 = &
ai
->
IpAdd»ssLi¡
;

4353 
i
 = 0;

4355 
li¡
)

4357 ià(
i
 =ğ
n
)

4361 ++
i
;

4362 
li¡
 = i¶i¡->
Next
;

4365 ià(
li¡
)

4367 cÚ¡ 
g‘addr_æags
 = 
GETADDR_HOST_ORDER
;

4368 cÚ¡ *
_¡r
 = 
li¡
->
IpAdd»ss
.
SŒšg
;

4369 cÚ¡ *
Ãtmask_¡r
 = 
li¡
->
IpMask
.
SŒšg
;

4370 
boŞ
 
sucûed1
 = 
çl£
;

4371 
boŞ
 
sucûed2
 = 
çl£
;

4373 ià(
_¡r
 && 
Ãtmask_¡r
 && 
	`¡¾’
(ip_str) && strlen(netmask_str))

4375 *

 = 
	`g‘addr
(
g‘addr_æags
, 
_¡r
, 0, &
sucûed1
, 
NULL
);

4376 *
Ãtmask
 = 
	`g‘addr
(
g‘addr_æags
, 
Ãtmask_¡r
, 0, &
sucûed2
, 
NULL
);

4377 
»t
 = (
sucûed1
 =ğ
Œue
 && 
sucûed2
 ==rue);

4382  
»t
;

4383 
	}
}

4385 
boŞ


4386 
	$‹¡_ad­‹r__Ãtmask
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
, cÚ¡ 
š_addr_t
 

, cÚ¡ in_addr_ˆ
Ãtmask
)

4388 ià(
ai
)

4390 
š_addr_t
 
_ad­‹r
 = 0;

4391 
š_addr_t
 
Ãtmask_ad­‹r
 = 0;

4392 cÚ¡ 
boŞ
 
¡©us
 = 
	`g‘_ad­‹r__Ãtmask
(
ai
, 0, &
_ad­‹r
, &
Ãtmask_ad­‹r
);

4393  (
¡©us
 && 
_ad­‹r
 =ğ

 && 
Ãtmask_ad­‹r
 =ğ
Ãtmask
);

4397  
çl£
;

4399 
	}
}

4401 cÚ¡ 
IP_ADAPTER_INFO
 *

4402 
	$g‘_tun_ad­‹r
(cÚ¡ 
tuÁ­
 *
‰
, cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
)

4404 ià(
li¡
 && 
‰
)

4406  
	`g‘_ad­‹r
(
li¡
, 
‰
->
ad­‹r_šdex
);

4410  
NULL
;

4412 
	}
}

4414 
boŞ


4415 
	$is_ad­‹r_up
(cÚ¡ 
tuÁ­
 *
‰
, cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
)

4417 
i
;

4418 
boŞ
 
»t
 = 
çl£
;

4420 cÚ¡ 
IP_ADAPTER_INFO
 *
ai
 = 
	`g‘_tun_ad­‹r
(
‰
, 
li¡
);

4422 ià(
ai
)

4424 cÚ¡ 
n
 = 
	`g‘_ad­‹r_n__Ãtmask
(
ai
);

4427 
i
 = 0; i < 
n
; ++i)

4429 
š_addr_t
 

, 
Ãtmask
;

4430 ià(
	`g‘_ad­‹r__Ãtmask
(
ai
, 
i
, &

, &
Ãtmask
))

4432 ià(
‰
->
loÿl
 &&t->
ad­‹r_Ãtmask
)

4435 ià(
‰
->
loÿl
 =ğ

 &&t->
ad­‹r_Ãtmask
 =ğ
Ãtmask
)

4437 
»t
 = 
Œue
;

4443 ià(

 && 
Ãtmask
)

4445 
»t
 = 
Œue
;

4453 
»t
 = 
Œue
;

4456  
»t
;

4457 
	}
}

4459 
boŞ


4460 
	$is__š_ad­‹r_subÃt
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
, cÚ¡ 
š_addr_t
 

, in_addr_ˆ*
highe¡_Ãtmask
)

4462 
i
;

4463 
boŞ
 
»t
 = 
çl£
;

4465 ià(
highe¡_Ãtmask
)

4467 *
highe¡_Ãtmask
 = 0;

4470 ià(
ai
)

4472 cÚ¡ 
n
 = 
	`g‘_ad­‹r_n__Ãtmask
(
ai
);

4473 
i
 = 0; i < 
n
; ++i)

4475 
š_addr_t
 
ad­‹r_
, 
ad­‹r_Ãtmask
;

4476 ià(
	`g‘_ad­‹r__Ãtmask
(
ai
, 
i
, &
ad­‹r_
, &
ad­‹r_Ãtmask
))

4478 ià(
ad­‹r_
 && 
ad­‹r_Ãtmask
 && (

 &‡dapter_netmask) == (adapter_ip &‡dapter_netmask))

4480 ià(
highe¡_Ãtmask
 && 
ad­‹r_Ãtmask
 > *highest_netmask)

4482 *
highe¡_Ãtmask
 = 
ad­‹r_Ãtmask
;

4484 
»t
 = 
Œue
;

4489  
»t
;

4490 
	}
}

4492 
DWORD


4493 
	$ad­‹r_šdex_of_
(cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
,

4494 cÚ¡ 
š_addr_t
 

,

4495 *
couÁ
,

4496 
š_addr_t
 *
Ãtmask
)

4498 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4499 
DWORD
 
»t
 = 
TUN_ADAPTER_INDEX_INVALID
;

4500 
š_addr_t
 
highe¡_Ãtmask
 = 0;

4501 
lowe¡_m‘ric
 = 
INT_MAX
;

4502 
boŞ
 
fœ¡
 = 
Œue
;

4504 ià(
couÁ
)

4506 *
couÁ
 = 0;

4509 
li¡
)

4511 
š_addr_t
 
hn
;

4513 ià(
	`is__š_ad­‹r_subÃt
(
li¡
, 

, &
hn
))

4515 
m‘ric
 = 
	`g‘_š‹rçû_m‘ric
(
li¡
->
Index
, 
AF_INET
, 
NULL
);

4516 ià(
fœ¡
 || 
hn
 > 
highe¡_Ãtmask
)

4518 
highe¡_Ãtmask
 = 
hn
;

4519 ià(
m‘ric
 >= 0)

4521 
lowe¡_m‘ric
 = 
m‘ric
;

4523 ià(
couÁ
)

4525 *
couÁ
 = 1;

4527 
»t
 = 
li¡
->
Index
;

4528 
fœ¡
 = 
çl£
;

4530 ià(
hn
 =ğ
highe¡_Ãtmask
)

4532 ià(
couÁ
)

4534 ++*
couÁ
;

4536 ià(
m‘ric
 >ğ0 && m‘riø< 
lowe¡_m‘ric
)

4538 
»t
 = 
li¡
->
Index
;

4539 
lowe¡_m‘ric
 = 
m‘ric
;

4543 
li¡
 =†i¡->
Next
;

4546 
	`dmsg
(
D_ROUTE_DEBUG
, "DEBUG: IP Locate: ip=%s‚m=%s index=%d count=%d metric=%d",

4547 
	`´št_š_addr_t
(

, 0, &
gc
),

4548 
	`´št_š_addr_t
(
highe¡_Ãtmask
, 0, &
gc
),

4549 ()
»t
,

4550 
couÁ
 ? *count : -1,

4551 
lowe¡_m‘ric
);

4553 ià(
»t
 =ğ
TUN_ADAPTER_INDEX_INVALID
 && 
couÁ
)

4555 *
couÁ
 = 0;

4558 ià(
Ãtmask
)

4560 *
Ãtmask
 = 
highe¡_Ãtmask
;

4563 
	`gc_ä“
(&
gc
);

4564  
»t
;

4565 
	}
}

4572 
	#DHCP_STATUS_UNDEF
 0

	)

4573 
	#DHCP_STATUS_ENABLED
 1

	)

4574 
	#DHCP_STATUS_DISABLED
 2

	)

4577 
	$dhı_¡©us
(
DWORD
 
šdex
)

4579 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4580 
»t
 = 
DHCP_STATUS_UNDEF
;

4581 ià(
šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

4583 cÚ¡ 
IP_ADAPTER_INFO
 *
ai
 = 
	`g‘_ad­‹r_šfo
(
šdex
, &
gc
);

4585 ià(
ai
)

4587 ià(
ai
->
DhıEÇbËd
)

4589 
»t
 = 
DHCP_STATUS_ENABLED
;

4593 
»t
 = 
DHCP_STATUS_DISABLED
;

4597 
	`gc_ä“
(&
gc
);

4598  
»t
;

4599 
	}
}

4606 
	$d–‘e_‹mp_add»s£s
(
DWORD
 
šdex
)

4608 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4609 cÚ¡ 
IP_ADAPTER_INFO
 *
a
 = 
	`g‘_ad­‹r_šfo
(
šdex
, &
gc
);

4611 ià(
a
)

4613 cÚ¡ 
IP_ADDR_STRING
 *

 = &
a
->
IpAdd»ssLi¡
;

4614 

)

4616 
DWORD
 
¡©us
;

4617 cÚ¡ 
DWORD
 
cÚ‹xt
 = 

->
CÚ‹xt
;

4619 ià((
¡©us
 = 
	`D–‘eIPAdd»ss
((
ULONG
è
cÚ‹xt
)è=ğ
NO_ERROR
)

4621 
	`msg
(
M_INFO
, "Successfully deleted…reviously set dynamic IP/netmask: %s/%s",

4622 

->
IpAdd»ss
.
SŒšg
,

4623 

->
IpMask
.
SŒšg
);

4627 cÚ¡ *
em±y
 = "0.0.0.0";

4628 ià(
	`¡rcmp
(

->
IpAdd»ss
.
SŒšg
, 
em±y
)

4629 || 
	`¡rcmp
(

->
IpMask
.
SŒšg
, 
em±y
))

4631 
	`msg
(
M_INFO
, "NOTE: could‚ot delete…reviously set dynamic IP/netmask: %s/%s (status=%u)",

4632 

->
IpAdd»ss
.
SŒšg
,

4633 

->
IpMask
.
SŒšg
,

4634 ()
¡©us
);

4637 

 = ip->
Next
;

4640 
	`gc_ä“
(&
gc
);

4641 
	}
}

4646 
DWORD


4647 
	$g‘_ad­‹r_šdex_m‘hod_1
(cÚ¡ *
guid
)

4649 
DWORD
 
šdex
;

4650 
ULONG
 
ašdex
;

4651 
wch¬_t
 
wbuf
[256];

4652 
	`sw´štf
(
wbuf
, 
	`SIZE
(wbuf), 
L
"\\DEVICE\\TCPIP_%S", 
guid
);

4653 
wbuf
 [
	`SIZE
(wbuf) - 1] = 0;

4654 ià(
	`G‘Ad­‹rIndex
(
wbuf
, &
ašdex
è!ğ
NO_ERROR
)

4656 
šdex
 = 
TUN_ADAPTER_INDEX_INVALID
;

4660 
šdex
 = (
DWORD
)
ašdex
;

4662  
šdex
;

4663 
	}
}

4665 
DWORD


4666 
	$g‘_ad­‹r_šdex_m‘hod_2
(cÚ¡ *
guid
)

4668 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4669 
DWORD
 
šdex
 = 
TUN_ADAPTER_INDEX_INVALID
;

4671 cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

4673 
li¡
)

4675 ià(!
	`¡rcmp
(
guid
, 
li¡
->
Ad­‹rName
))

4677 
šdex
 = 
li¡
->
Index
;

4680 
li¡
 =†i¡->
Next
;

4683 
	`gc_ä“
(&
gc
);

4684  
šdex
;

4685 
	}
}

4687 
DWORD


4688 
	$g‘_ad­‹r_šdex
(cÚ¡ *
guid
)

4690 
DWORD
 
šdex
;

4691 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_1
(
guid
);

4692 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4694 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_2
(
guid
);

4696 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4698 
	`msg
(
M_INFO
, "NOTE: could‚Ù g‘‡d­‹¸šdex fÜ %s", 
guid
);

4700  
šdex
;

4701 
	}
}

4703 
DWORD


4704 
	$g‘_ad­‹r_šdex_æexibË
(cÚ¡ *
Çme
)

4706 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4707 
DWORD
 
šdex
;

4708 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_1
(
Çme
);

4709 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4711 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_2
(
Çme
);

4713 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4715 cÚ¡ 
p_»g
 *p_»g = 
	`g‘_p_»g
(&
gc
);

4716 cÚ¡ 
·Ãl_»g
 *·Ãl_»g = 
	`g‘_·Ãl_»g
(&
gc
);

4717 cÚ¡ *
guid
 = 
	`Çme_to_guid
(
Çme
, 
p_»g
, 
·Ãl_»g
);

4718 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_1
(
guid
);

4719 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4721 
šdex
 = 
	`g‘_ad­‹r_šdex_m‘hod_2
(
guid
);

4724 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

4726 
	`msg
(
M_INFO
, "NOTE: could‚Ù g‘‡d­‹¸šdex fÜ‚ame/GUID '%s'", 
Çme
);

4728 
	`gc_ä“
(&
gc
);

4729  
šdex
;

4730 
	}
}

4736 
	$fÜm©__addr_¡ršg
(cÚ¡ 
IP_ADDR_STRING
 *

, 
gc_¬’a
 *
gc
)

4738 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

4739 

)

4741 
	`buf_´štf
(&
out
, "%s", 

->
IpAdd»ss
.
SŒšg
);

4742 ià(
	`¡¾’
(

->
IpMask
.
SŒšg
))

4744 
	`buf_´štf
(&
out
, "/");

4745 
	`buf_´štf
(&
out
, "%s", 

->
IpMask
.
SŒšg
);

4747 
	`buf_´štf
(&
out
, " ");

4748 

 = ip->
Next
;

4750  
	`BSTR
(&
out
);

4751 
	}
}

4757 
	$show_ad­‹r
(
msgËv
, cÚ¡ 
IP_ADAPTER_INFO
 *
a
, 
gc_¬’a
 *
gc
)

4759 
	`msg
(
msgËv
, "%s", 
a
->
DesütiÚ
);

4760 
	`msg
(
msgËv
, " Index = %d", ()
a
->
Index
);

4761 
	`msg
(
msgËv
, " GUID = %s", 
a
->
Ad­‹rName
);

4762 
	`msg
(
msgËv
, " IP = %s", 
	`fÜm©__addr_¡ršg
(&
a
->
IpAdd»ssLi¡
, 
gc
));

4763 
	`msg
(
msgËv
, " MAC = %s", 
	`fÜm©_hex_ex
(
a
->
Add»ss
,‡->
Add»ssL’gth
, 0, 1, ":", 
gc
));

4764 
	`msg
(
msgËv
, " GATEWAY = %s", 
	`fÜm©__addr_¡ršg
(&
a
->
G©ewayLi¡
, 
gc
));

4765 ià(
a
->
DhıEÇbËd
)

4767 
	`msg
(
msgËv
, " DHCP SERV = %s", 
	`fÜm©__addr_¡ršg
(&
a
->
DhıS”v”
, 
gc
));

4768 
	`msg
(
msgËv
, " DHCP LEASE OBTAINED = %s", 
	`time_¡ršg
(
a
->
L—£Obšed
, 0, 
çl£
, 
gc
));

4769 
	`msg
(
msgËv
, " DHCP LEASE EXPIRES = %s", 
	`time_¡ršg
(
a
->
L—£Expœes
, 0, 
çl£
, 
gc
));

4771 ià(
a
->
HaveWšs
)

4773 
	`msg
(
msgËv
, " PRI WINS = %s", 
	`fÜm©__addr_¡ršg
(&
a
->
Prim¬yWšsS”v”
, 
gc
));

4774 
	`msg
(
msgËv
, " SEC WINS = %s", 
	`fÜm©__addr_¡ršg
(&
a
->
SecÚd¬yWšsS”v”
, 
gc
));

4778 cÚ¡ 
IP_PER_ADAPTER_INFO
 *
·i
 = 
	`g‘_³r_ad­‹r_šfo
(
a
->
Index
, 
gc
);

4779 ià(
·i
)

4781 
	`msg
(
msgËv
, " DNS SERV = %s", 
	`fÜm©__addr_¡ršg
(&
·i
->
DnsS”v”Li¡
, 
gc
));

4784 
	}
}

4790 
	$show_ad­‹rs
(
msgËv
)

4792 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4793 cÚ¡ 
IP_ADAPTER_INFO
 *
ai
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

4795 
	`msg
(
msgËv
, "SYSTEM ADAPTER LIST");

4796 ià(
ai
)

4798 cÚ¡ 
IP_ADAPTER_INFO
 *
a
;

4801 
a
 = 
ai
;‡ !ğ
NULL
;‡ =‡->
Next
)

4803 
	`show_ad­‹r
(
msgËv
, 
a
, &
gc
);

4806 
	`gc_ä“
(&
gc
);

4807 
	}
}

4817 
	$p_®low_nÚadmš_acûss_hªdË
(cÚ¡ *
deviû_·th
, 
HANDLE
 
hªd
)

4819 
£cur™y_©Œibu‹s
 
§
;

4820 
BOOL
 
¡©us
;

4822 ià(!
	`š™_£cur™y_©Œibu‹s_®low_®l
(&
§
))

4824 
	`msg
(
M_ERR
, "Error: init SA failed");

4827 
¡©us
 = 
	`S‘K”ÃlObjeùSecur™y
(
hªd
, 
DACL_SECURITY_INFORMATION
, &
§
.
sd
);

4828 ià(!
¡©us
)

4830 
	`msg
(
M_ERRNO
, "E¼Ü: S‘K”ÃlObjeùSecur™y faed oÀ%s", 
deviû_·th
);

4834 
	`msg
(
M_INFO
|
M_NOPREFIX
, "TAP-Wšdow deviû: % [NÚ-admš‡cûs ®lowed]", 
deviû_·th
);

4836 
	}
}

4839 
	$p_®low_nÚadmš_acûss
(cÚ¡ *
dev_node
)

4841 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4842 cÚ¡ 
p_»g
 *p_»g = 
	`g‘_p_»g
(&
gc
);

4843 cÚ¡ 
·Ãl_»g
 *·Ãl_»g = 
	`g‘_·Ãl_»g
(&
gc
);

4844 cÚ¡ *
deviû_guid
 = 
NULL
;

4845 
HANDLE
 
hªd
;

4846 
aùu®_bufãr
[256];

4847 
deviû_·th
[256];

4849 
	`©_Ëa¡_Úe_p_wš
(
p_»g
);

4851 ià(
dev_node
)

4854 
deviû_guid
 = 
	`g‘_deviû_guid
(
dev_node
, 
aùu®_bufãr
, ×ùu®_bufãr), 
p_»g
, 
·Ãl_»g
, &
gc
);

4856 ià(!
deviû_guid
)

4858 
	`msg
(
M_FATAL
, "TAP-Wšdow ad­‹¸'%s'‚Ù found", 
dev_node
);

4862 
	`İ’v²_¢´štf
(
deviû_·th
, (device_path), "%s%s%s",

4863 
USERMODEDEVICEDIR
,

4864 
deviû_guid
,

4865 
TAP_WIN_SUFFIX
);

4867 
hªd
 = 
	`C»©eFe
(

4868 
deviû_·th
,

4869 
MAXIMUM_ALLOWED
,

4872 
OPEN_EXISTING
,

4873 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4877 ià(
hªd
 =ğ
INVALID_HANDLE_VALUE
)

4879 
	`msg
(
M_ERR
, "C»©eFçed oÀTAP deviû: %s", 
deviû_·th
);

4882 
	`p_®low_nÚadmš_acûss_hªdË
(
deviû_·th
, 
hªd
);

4883 
	`Clo£HªdË
(
hªd
);

4887 
deviû_numb”
 = 0;

4890 
Œue
)

4892 
deviû_guid
 = 
	`g‘_un¥ecif›d_deviû_guid
(
deviû_numb”
,

4893 
aùu®_bufãr
,

4894 (
aùu®_bufãr
),

4895 
p_»g
,

4896 
·Ãl_»g
,

4897 &
gc
);

4899 ià(!
deviû_guid
)

4905 
	`İ’v²_¢´štf
(
deviû_·th
, (device_path), "%s%s%s",

4906 
USERMODEDEVICEDIR
,

4907 
deviû_guid
,

4908 
TAP_WIN_SUFFIX
);

4910 
hªd
 = 
	`C»©eFe
(

4911 
deviû_·th
,

4912 
MAXIMUM_ALLOWED
,

4915 
OPEN_EXISTING
,

4916 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

4920 ià(
hªd
 =ğ
INVALID_HANDLE_VALUE
)

4922 
	`msg
(
M_WARN
, "C»©eFçed oÀTAP deviû: %s", 
deviû_·th
);

4926 
	`p_®low_nÚadmš_acûss_hªdË
(
deviû_·th
, 
hªd
);

4927 
	`Clo£HªdË
(
hªd
);

4930 
deviû_numb”
++;

4933 
	`gc_ä“
(&
gc
);

4934 
	}
}

4939 
boŞ


4940 
	$dhı_»Ëa£_by_ad­‹r_šdex
(cÚ¡ 
DWORD
 
ad­‹r_šdex
)

4942 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4943 
boŞ
 
»t
 = 
çl£
;

4944 cÚ¡ 
IP_ADAPTER_INDEX_MAP
 *
š‹r
 = 
	`g‘_š‹rçû_šfo
(
ad­‹r_šdex
, &
gc
);

4946 ià(
š‹r
)

4948 
DWORD
 
¡©us
 = 
	`IpR–—£Add»ss
((
IP_ADAPTER_INDEX_MAP
 *)
š‹r
);

4949 ià(
¡©us
 =ğ
NO_ERROR
)

4951 
	`msg
(
D_TUNTAP_INFO
, "TAP: DHCP‡ddress„eleased");

4952 
»t
 = 
Œue
;

4956 
	`msg
(
M_WARN
, "NOTE: Release of DHCP-assigned IP‡ddress†ease on TAP-Windows‡dapter failed: %s (code=%u)",

4957 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

4958 ()
¡©us
);

4962 
	`gc_ä“
(&
gc
);

4963  
»t
;

4964 
	}
}

4966 
boŞ


4967 
	$dhı_»Ëa£
(cÚ¡ 
tuÁ­
 *
‰
)

4969 ià(
‰
 &&t->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_DHCP_MASQ
 &&t->
ad­‹r_šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

4971  
	`dhı_»Ëa£_by_ad­‹r_šdex
(
‰
->
ad­‹r_šdex
);

4975  
çl£
;

4977 
	}
}

4979 
boŞ


4980 
	$dhı_»Ãw_by_ad­‹r_šdex
(cÚ¡ 
DWORD
 
ad­‹r_šdex
)

4982 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

4983 
boŞ
 
»t
 = 
çl£
;

4984 cÚ¡ 
IP_ADAPTER_INDEX_MAP
 *
š‹r
 = 
	`g‘_š‹rçû_šfo
(
ad­‹r_šdex
, &
gc
);

4986 ià(
š‹r
)

4988 
DWORD
 
¡©us
 = 
	`IpR’ewAdd»ss
((
IP_ADAPTER_INDEX_MAP
 *)
š‹r
);

4989 ià(
¡©us
 =ğ
NO_ERROR
)

4991 
	`msg
(
D_TUNTAP_INFO
, "TAP: DHCP‡ddress„enewal succeeded");

4992 
»t
 = 
Œue
;

4996 
	`msg
(
M_WARN
, "WARNING: Failedo„enew DHCP IP‡ddress†ease on TAP-Windows‡dapter: %s (code=%u)",

4997 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

4998 ()
¡©us
);

5001 
	`gc_ä“
(&
gc
);

5002  
»t
;

5003 
	}
}

5005 
boŞ


5006 
	$dhı_»Ãw
(cÚ¡ 
tuÁ­
 *
‰
)

5008 ià(
‰
 &&t->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_DHCP_MASQ
 &&t->
ad­‹r_šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

5010  
	`dhı_»Ãw_by_ad­‹r_šdex
(
‰
->
ad­‹r_šdex
);

5014  
çl£
;

5016 
	}
}

5023 
	$Ãtsh_commªd
(cÚ¡ 
¬gv
 *
a
, 
n
, 
msgËv–
)

5025 
i
;

5026 
i
 = 0; i < 
n
; ++i)

5028 
boŞ
 
¡©us
;

5029 
	`mªagem’t_¦“p
(1);

5030 
	`Ãtcmd_£m­hÜe_lock
();

5031 
	`¬gv_msg_´efix
(
M_INFO
, 
a
, "NETSH");

5032 
¡©us
 = 
	`İ’v²_execve_check
(
a
, 
NULL
, 0, "ERROR:‚etsh command failed");

5033 
	`Ãtcmd_£m­hÜe_»Ëa£
();

5034 ià(
¡©us
)

5038 
	`mªagem’t_¦“p
(4);

5040 
	`msg
(
msgËv–
, "NETSH: command failed");

5041 
	}
}

5044 
	$cÚfig_»gi¡”_dns
(cÚ¡ 
’v_£t
 *
es
)

5046 
¬gv
‡rgv = 
	`¬gv_Ãw
();

5047 
boŞ
 
¡©us
;

5048 cÚ¡ 
”r
[] = "ERROR: Windows ipconfig command failed";

5050 
	`msg
(
D_TUNTAP_INFO
, "Start ipconfig commands for„egister-dns...");

5051 
	`Ãtcmd_£m­hÜe_lock
();

5053 
	`¬gv_´štf
(&
¬gv
, "%s%sc /flushdns",

5054 
	`g‘_wš_sys_·th
(),

5055 
WIN_IPCONFIG_PATH_SUFFIX
);

5056 
	`¬gv_msg
(
D_TUNTAP_INFO
, &
¬gv
);

5057 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, 
”r
);

5058 
	`¬gv_»£t
(&
¬gv
);

5060 
	`¬gv_´štf
(&
¬gv
, "%s%sc /registerdns",

5061 
	`g‘_wš_sys_·th
(),

5062 
WIN_IPCONFIG_PATH_SUFFIX
);

5063 
	`¬gv_msg
(
D_TUNTAP_INFO
, &
¬gv
);

5064 
¡©us
 = 
	`İ’v²_execve_check
(&
¬gv
, 
es
, 0, 
”r
);

5065 
	`¬gv_»£t
(&
¬gv
);

5067 
	`Ãtcmd_£m­hÜe_»Ëa£
();

5068 
	`msg
(
D_TUNTAP_INFO
, "End ipconfig commands for„egister-dns...");

5069 
	}
}

5072 
	$_addr_¡ršg_to_¬¿y
(
š_addr_t
 *
de¡
, *
de¡_Ën
, cÚ¡ 
IP_ADDR_STRING
 *
¤c
)

5074 
i
 = 0;

5075 
¤c
)

5077 cÚ¡ 
g‘addr_æags
 = 
GETADDR_HOST_ORDER
;

5078 cÚ¡ *
_¡r
 = 
¤c
->
IpAdd»ss
.
SŒšg
;

5079 
š_addr_t
 

 = 0;

5080 
boŞ
 
sucûed
 = 
çl£
;

5082 ià(
i
 >ğ*
de¡_Ën
)

5086 ià(!
_¡r
 || !
	`¡¾’
(ip_str))

5091 

 = 
	`g‘addr
(
g‘addr_æags
, 
_¡r
, 0, &
sucûed
, 
NULL
);

5092 ià(!
sucûed
)

5096 
de¡
[
i
++] = 

;

5098 
¤c
 = src->
Next
;

5100 *
de¡_Ën
 = 
i
;

5104 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5105 
	`msg
(
M_INFO
, "_addr_¡ršg_to_¬¿y [%d]", *
de¡_Ën
);

5106 
i
 = 0; i < *
de¡_Ën
; ++i)

5108 
	`msg
(
M_INFO
, "%s", 
	`´št_š_addr_t
(
de¡
[
i
], 0, &
gc
));

5110 
	`gc_ä“
(&
gc
);

5113 
	}
}

5115 
boŞ


5116 
	$_addr_Úe_to_Úe
(cÚ¡ 
š_addr_t
 *
a1
, cÚ¡ 
a1Ën
, cÚ¡ 
IP_ADDR_STRING
 *
Ÿs
)

5118 
š_addr_t
 
a2
[8];

5119 
a2Ën
 = 
	`SIZE
(
a2
);

5120 
i
;

5122 
	`_addr_¡ršg_to_¬¿y
(
a2
, &
a2Ën
, 
Ÿs
);

5124 ià(
a1Ën
 !ğ
a2Ën
)

5126  
çl£
;

5129 
i
 = 0; i < 
a1Ën
; ++i)

5131 ià(
a1
[
i
] !ğ
a2
[i])

5133  
çl£
;

5136  
Œue
;

5137 
	}
}

5139 
boŞ


5140 
	$_addr_memb”_of
(cÚ¡ 
š_addr_t
 
addr
, cÚ¡ 
IP_ADDR_STRING
 *
Ÿs
)

5142 
š_addr_t
 
¯
[8];

5143 
Ën
 = 
	`SIZE
(
¯
);

5144 
i
;

5146 
	`_addr_¡ršg_to_¬¿y
(
¯
, &
Ën
, 
Ÿs
);

5147 
i
 = 0; i < 
Ën
; ++i)

5149 ià(
addr
 =ğ
¯
[
i
])

5151  
Œue
;

5154  
çl£
;

5155 
	}
}

5164 
	$Ãtsh_£t_dns6_£rv”s
(cÚ¡ 
š6_addr
 *
addr_li¡
,

5165 cÚ¡ 
addr_Ën
,

5166 cÚ¡ *
æex_Çme
)

5168 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5169 
¬gv
‡rgv = 
	`¬gv_Ãw
();

5171 
i
 = 0; i < 
addr_Ën
; ++i)

5173 cÚ¡ *
fmt
 = (
i
 == 0) ?

5176 
	`¬gv_´štf
(&
¬gv
, 
fmt
, 
	`g‘_wš_sys_·th
(),

5177 
NETSH_PATH_SUFFIX
, 
æex_Çme
,

5178 
	`´št_š6_addr
(
addr_li¡
[
i
], 0, &
gc
));

5181 ià(
	`wš32_v”siÚ_šfo
(è>ğ
WIN_7
)

5183 
	`¬gv_´štf_ÿt
(&
¬gv
, "%s", "validate=no");

5187 
	`Ãtsh_commªd
(&
¬gv
, 1, (
i
==0è? 
M_FATAL
 : 
M_NONFATAL
);

5190 
	`¬gv_»£t
(&
¬gv
);

5191 
	`gc_ä“
(&
gc
);

5192 
	}
}

5195 
	$Ãtsh_ifcÚfig_İtiÚs
(cÚ¡ *
ty³
,

5196 cÚ¡ 
š_addr_t
 *
addr_li¡
,

5197 cÚ¡ 
addr_Ën
,

5198 cÚ¡ 
IP_ADDR_STRING
 *
cu¼’t
,

5199 cÚ¡ *
æex_Çme
,

5200 cÚ¡ 
boŞ
 
‹¡_fœ¡
)

5202 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5203 
¬gv
‡rgv = 
	`¬gv_Ãw
();

5204 
boŞ
 
d–‘e_fœ¡
 = 
çl£
;

5207 ià(
‹¡_fœ¡
)

5209 ià(!
	`_addr_Úe_to_Úe
(
addr_li¡
, 
addr_Ën
, 
cu¼’t
))

5211 
d–‘e_fœ¡
 = 
Œue
;

5216 
d–‘e_fœ¡
 = 
Œue
;

5220 ià(
d–‘e_fœ¡
)

5222 
	`¬gv_´štf
(&
¬gv
, "%s%sc interface ip delete %s %s‡ll",

5223 
	`g‘_wš_sys_·th
(),

5224 
NETSH_PATH_SUFFIX
,

5225 
ty³
,

5226 
æex_Çme
);

5227 
	`Ãtsh_commªd
(&
¬gv
, 2, 
M_FATAL
);

5232 
couÁ
 = 0;

5233 
i
;

5234 
i
 = 0; i < 
addr_Ën
; ++i)

5236 ià(
d–‘e_fœ¡
 || !
‹¡_fœ¡
 || !
	`_addr_memb”_of
(
addr_li¡
[
i
], 
cu¼’t
))

5238 cÚ¡ *
fmt
 = 
couÁ
 ?

5242 
	`¬gv_´štf
(&
¬gv
, 
fmt
,

5243 
	`g‘_wš_sys_·th
(),

5244 
NETSH_PATH_SUFFIX
,

5245 
ty³
,

5246 
æex_Çme
,

5247 
	`´št_š_addr_t
(
addr_li¡
[
i
], 0, &
gc
));

5248 
	`Ãtsh_commªd
(&
¬gv
, 2, 
M_FATAL
);

5250 ++
couÁ
;

5254 
	`msg
(
M_INFO
, "NETSH: \"%s\" %s %s [already set]",

5255 
æex_Çme
,

5256 
ty³
,

5257 
	`´št_š_addr_t
(
addr_li¡
[
i
], 0, &
gc
));

5262 
	`¬gv_»£t
(&
¬gv
);

5263 
	`gc_ä“
(&
gc
);

5264 
	}
}

5267 
	$š™__addr_¡ršg2
(
IP_ADDR_STRING
 *
de¡
, cÚ¡ IP_ADDR_STRING *
¤c1
, cÚ¡ IP_ADDR_STRING *
¤c2
)

5269 
	`CLEAR
(
de¡
[0]);

5270 
	`CLEAR
(
de¡
[1]);

5271 ià(
¤c1
)

5273 
de¡
[0] = *
¤c1
;

5274 
de¡
[0].
Next
 = 
NULL
;

5276 ià(
¤c2
)

5278 
de¡
[1] = *
¤c2
;

5279 
de¡
[0].
Next
 = &dest[1];

5280 
de¡
[1].
Next
 = 
NULL
;

5282 
	}
}

5285 
	$Ãtsh_ifcÚfig
(cÚ¡ 
tuÁ­_İtiÚs
 *
to
,

5286 cÚ¡ *
æex_Çme
,

5287 cÚ¡ 
š_addr_t
 

,

5288 cÚ¡ 
š_addr_t
 
Ãtmask
,

5289 cÚ¡ 
æags
)

5291 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5292 
¬gv
‡rgv = 
	`¬gv_Ãw
();

5293 cÚ¡ 
IP_ADAPTER_INFO
 *
ai
 = 
NULL
;

5294 cÚ¡ 
IP_PER_ADAPTER_INFO
 *
·i
 = 
NULL
;

5296 ià(
æags
 & 
NI_TEST_FIRST
)

5298 cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
 = 
	`g‘_ad­‹r_šfo_li¡
(&
gc
);

5299 cÚ¡ 
šdex
 = 
	`g‘_ad­‹r_šdex_æexibË
(
æex_Çme
);

5300 
ai
 = 
	`g‘_ad­‹r
(
li¡
, 
šdex
);

5301 
·i
 = 
	`g‘_³r_ad­‹r_šfo
(
šdex
, &
gc
);

5304 ià(
æags
 & 
NI_IP_NETMASK
)

5306 ià(
	`‹¡_ad­‹r__Ãtmask
(
ai
, 

, 
Ãtmask
))

5308 
	`msg
(
M_INFO
, "NETSH: \"%s\" %s/%s [already set]",

5309 
æex_Çme
,

5310 
	`´št_š_addr_t
(

, 0, &
gc
),

5311 
	`´št_š_addr_t
(
Ãtmask
, 0, &
gc
));

5316 
	`¬gv_´štf
(&
¬gv
, "%s%sc interface ip set‡ddress %s static %s %s",

5317 
	`g‘_wš_sys_·th
(),

5318 
NETSH_PATH_SUFFIX
,

5319 
æex_Çme
,

5320 
	`´št_š_addr_t
(

, 0, &
gc
),

5321 
	`´št_š_addr_t
(
Ãtmask
, 0, &
gc
));

5323 
	`Ãtsh_commªd
(&
¬gv
, 4, 
M_FATAL
);

5328 ià(
æags
 & 
NI_OPTIONS
)

5330 
IP_ADDR_STRING
 
wšs
[2];

5331 
	`CLEAR
(
wšs
[0]);

5332 
	`CLEAR
(
wšs
[1]);

5334 
	`Ãtsh_ifcÚfig_İtiÚs
("dns",

5335 
to
->
dns
,

5336 
to
->
dns_Ën
,

5337 
·i
 ? &·i->
DnsS”v”Li¡
 : 
NULL
,

5338 
æex_Çme
,

5339 
	`BOOL_CAST
(
æags
 & 
NI_TEST_FIRST
));

5340 ià(
ai
 &&‡i->
HaveWšs
)

5342 
	`š™__addr_¡ršg2
(
wšs
, &
ai
->
Prim¬yWšsS”v”
, &ai->
SecÚd¬yWšsS”v”
);

5345 
	`Ãtsh_ifcÚfig_İtiÚs
("wins",

5346 
to
->
wšs
,

5347 
to
->
wšs_Ën
,

5348 
ai
 ? 
wšs
 : 
NULL
,

5349 
æex_Çme
,

5350 
	`BOOL_CAST
(
æags
 & 
NI_TEST_FIRST
));

5353 
	`¬gv_»£t
(&
¬gv
);

5354 
	`gc_ä“
(&
gc
);

5355 
	}
}

5358 
	$Ãtsh_’abË_dhı
(cÚ¡ 
tuÁ­_İtiÚs
 *
to
,

5359 cÚ¡ *
aùu®_Çme
)

5361 
¬gv
‡rgv = 
	`¬gv_Ãw
();

5364 
	`¬gv_´štf
(&
¬gv
,

5366 
	`g‘_wš_sys_·th
(),

5367 
NETSH_PATH_SUFFIX
,

5368 
aùu®_Çme
);

5370 
	`Ãtsh_commªd
(&
¬gv
, 4, 
M_FATAL
);

5372 
	`¬gv_»£t
(&
¬gv
);

5373 
	}
}

5376 
boŞ


5377 
	$£rviû_’abË_dhı
(cÚ¡ 
tuÁ­
 *
‰
)

5379 
DWORD
 
Ën
;

5380 
boŞ
 
»t
 = 
çl£
;

5381 
ack_mes§ge_t
 
ack
;

5382 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5383 
HANDLE
 
pe
 = 
‰
->
İtiÚs
.
msg_chªÃl
;

5385 
’abË_dhı_mes§ge_t
 
dhı
 = {

5386 .
h—d”
 = {

5387 
msg_’abË_dhı
,

5388 (
’abË_dhı_mes§ge_t
),

5391 .
içû
 = { .
šdex
 = 
‰
->
ad­‹r_šdex
, .
Çme
 = "" }

5394 ià(!
	`Wr™eFe
(
pe
, &
dhı
, (dhı), &
Ën
, 
NULL
)

5395 || !
	`R—dFe
(
pe
, &
ack
, ×ck), &
Ën
, 
NULL
))

5397 
	`msg
(
M_WARN
, "Enable_dhcp: could‚otalko service: %s [%lu]",

5398 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

5399 
out
;

5402 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

5404 
	`msg
(
M_NONFATAL
, "TUN:ƒnabling dhcp using service failed: %s [status=%u if_index=%d]",

5405 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),‡ck.”rÜ_numb”, 
dhı
.
içû
.
šdex
);

5409 
	`msg
(
M_INFO
, "DHCPƒÇbËd oÀš‹rçû %d usšg s”viû", 
dhı
.
içû
.
šdex
);

5410 
»t
 = 
Œue
;

5413 
out
:

5414 
	`gc_ä“
(&
gc
);

5415  
»t
;

5416 
	}
}

5422 
	$Ãtsh_g‘_id
(cÚ¡ *
dev_node
, 
gc_¬’a
 *
gc
)

5424 cÚ¡ 
p_»g
 *p_»g = 
	`g‘_p_»g
(
gc
);

5425 cÚ¡ 
·Ãl_»g
 *·Ãl_»g = 
	`g‘_·Ãl_»g
(
gc
);

5426 
bufãr
 
aùu®
 = 
	`®loc_buf_gc
(256, 
gc
);

5427 cÚ¡ *
guid
;

5429 
	`©_Ëa¡_Úe_p_wš
(
p_»g
);

5431 ià(
dev_node
)

5433 
guid
 = 
	`g‘_deviû_guid
(
dev_node
, 
	`BPTR
(&
aùu®
), 
	`BCAP
(&aùu®), 
p_»g
, 
·Ãl_»g
, 
gc
);

5437 
guid
 = 
	`g‘_un¥ecif›d_deviû_guid
(0, 
	`BPTR
(&
aùu®
), 
	`BCAP
(&aùu®), 
p_»g
, 
·Ãl_»g
, 
gc
);

5439 ià(
	`g‘_un¥ecif›d_deviû_guid
(1, 
NULL
, 0, 
p_»g
, 
·Ãl_»g
, 
gc
))

5441 
guid
 = 
NULL
;

5445 ià(!
guid
)

5449 ià(
	`¡rcmp
(
	`BPTR
(&
aùu®
), "NULL"))

5451  
	`BPTR
(&
aùu®
);

5455  
guid
;

5457 
	}
}

5463 
	$tun_¡ªdby_š™
(
tuÁ­
 *
‰
)

5465 
‰
->
¡ªdby_™”
 = 0;

5466 
	}
}

5468 
boŞ


5469 
	$tun_¡ªdby
(
tuÁ­
 *
‰
)

5471 
boŞ
 
»t
 = 
Œue
;

5472 ++
‰
->
¡ªdby_™”
;

5473 ià(
‰
->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_ADAPTIVE
)

5475 ià(
‰
->
¡ªdby_™”
 =ğ
IPW32_SET_ADAPTIVE_TRY_NETSH
)

5477 
	`msg
(
M_INFO
, "NOTE:‚owrying‚etsh (this mayake someime)");

5478 
	`Ãtsh_ifcÚfig
(&
‰
->
İtiÚs
,

5479 
‰
->
aùu®_Çme
,

5480 
‰
->
loÿl
,

5481 
‰
->
ad­‹r_Ãtmask
,

5482 
NI_TEST_FIRST
|
NI_IP_NETMASK
|
NI_OPTIONS
);

5484 ià(
‰
->
¡ªdby_™”
 >ğ
IPW32_SET_ADAPTIVE_TRY_NETSH
*2)

5486 
»t
 = 
çl£
;

5489  
»t
;

5490 
	}
}

5498 
	$wr™e_dhı_u8
(
bufãr
 *
buf
, cÚ¡ 
ty³
, cÚ¡ 
d©a
, 
boŞ
 *
”rÜ
)

5500 ià(!
	`buf_§ã
(
buf
, 3))

5502 *
”rÜ
 = 
Œue
;

5503 
	`msg
(
M_WARN
, "write_dhcp_u8: buffer overflow building DHCP options");

5506 
	`buf_wr™e_u8
(
buf
, 
ty³
);

5507 
	`buf_wr™e_u8
(
buf
, 1);

5508 
	`buf_wr™e_u8
(
buf
, 
d©a
);

5509 
	}
}

5512 
	$wr™e_dhı_u32_¬¿y
(
bufãr
 *
buf
, cÚ¡ 
ty³
, cÚ¡ 
ušt32_t
 *
d©a
, cÚ¡ 
Ën
, 
boŞ
 *
”rÜ
)

5514 ià(
Ën
 > 0)

5516 
i
;

5517 cÚ¡ 
size
 = 
Ën
 * (
ušt32_t
);

5519 ià(!
	`buf_§ã
(
buf
, 2 + 
size
))

5521 *
”rÜ
 = 
Œue
;

5522 
	`msg
(
M_WARN
, "write_dhcp_u32_array: buffer overflow building DHCP options");

5525 ià(
size
 < 1 || size > 255)

5527 *
”rÜ
 = 
Œue
;

5528 
	`msg
(
M_WARN
, "wr™e_dhı_u32_¬¿y: siz(%dèmu¡ b> 0‡nd <ğ255", 
size
);

5531 
	`buf_wr™e_u8
(
buf
, 
ty³
);

5532 
	`buf_wr™e_u8
(
buf
, 
size
);

5533 
i
 = 0; i < 
Ën
; ++i)

5535 
	`buf_wr™e_u32
(
buf
, 
d©a
[
i
]);

5538 
	}
}

5541 
	$wr™e_dhı_¡r
(
bufãr
 *
buf
, cÚ¡ 
ty³
, cÚ¡ *
¡r
, 
boŞ
 *
”rÜ
)

5543 cÚ¡ 
Ën
 = 
	`¡¾’
(
¡r
);

5544 ià(!
	`buf_§ã
(
buf
, 2 + 
Ën
))

5546 *
”rÜ
 = 
Œue
;

5547 
	`msg
(
M_WARN
, "write_dhcp_str: buffer overflow building DHCP options");

5550 ià(
Ën
 < 1 ||†en > 255)

5552 *
”rÜ
 = 
Œue
;

5553 
	`msg
(
M_WARN
, "wr™e_dhı_¡r: sŒšg '%s' mu¡ b> 0 by‹ ªd <ğ255 by‹s", 
¡r
);

5556 
	`buf_wr™e_u8
(
buf
, 
ty³
);

5557 
	`buf_wr™e_u8
(
buf
, 
Ën
);

5558 
	`buf_wr™e
(
buf
, 
¡r
, 
Ën
);

5559 
	}
}

5561 
boŞ


5562 
	$bud_dhı_İtiÚs_¡ršg
(
bufãr
 *
buf
, cÚ¡ 
tuÁ­_İtiÚs
 *
o
)

5564 
boŞ
 
”rÜ
 = 
çl£
;

5565 ià(
o
->
domaš
)

5567 
	`wr™e_dhı_¡r
(
buf
, 15, 
o
->
domaš
, &
”rÜ
);

5570 ià(
o
->
Ãtbios_scİe
)

5572 
	`wr™e_dhı_¡r
(
buf
, 47, 
o
->
Ãtbios_scİe
, &
”rÜ
);

5575 ià(
o
->
Ãtbios_node_ty³
)

5577 
	`wr™e_dhı_u8
(
buf
, 46, 
o
->
Ãtbios_node_ty³
, &
”rÜ
);

5580 
	`wr™e_dhı_u32_¬¿y
(
buf
, 6, (
ušt32_t
 *)
o
->
dns
, o->
dns_Ën
, &
”rÜ
);

5581 
	`wr™e_dhı_u32_¬¿y
(
buf
, 44, (
ušt32_t
 *)
o
->
wšs
, o->
wšs_Ën
, &
”rÜ
);

5582 
	`wr™e_dhı_u32_¬¿y
(
buf
, 42, (
ušt32_t
 *)
o
->
Áp
, o->
Áp_Ën
, &
”rÜ
);

5583 
	`wr™e_dhı_u32_¬¿y
(
buf
, 45, (
ušt32_t
 *)
o
->
nbdd
, o->
nbdd_Ën
, &
”rÜ
);

5588 ià(
o
->
di§bË_nbt
)

5590 ià(!
	`buf_§ã
(
buf
, 8))

5592 
	`msg
(
M_WARN
, "build_dhcp_options_string: buffer overflow building DHCP options");

5593  
çl£
;

5595 
	`buf_wr™e_u8
(
buf
, 43);

5596 
	`buf_wr™e_u8
(
buf
, 6);

5597 
	`buf_wr™e_u8
(
buf
, 0x001);

5598 
	`buf_wr™e_u8
(
buf
, 4);

5599 
	`buf_wr™e_u32
(
buf
, 0x002);

5601  !
”rÜ
;

5602 
	}
}

5605 
	$fÜk_dhı_aùiÚ
(
tuÁ­
 *
‰
)

5607 ià(
‰
->
İtiÚs
.
dhı_´e_»Ëa£
 ||t->İtiÚs.
dhı_»Ãw
)

5609 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5610 
bufãr
 
cmd
 = 
	`®loc_buf_gc
(256, &
gc
);

5611 cÚ¡ 
v”b
 = 3;

5612 cÚ¡ 
´e_¦“p
 = 1;

5614 
	`buf_´štf
(&
cmd
, "İ’v² --v”b %d --p-¦“°%d", 
v”b
, 
´e_¦“p
);

5615 ià(
‰
->
İtiÚs
.
dhı_´e_»Ëa£
)

5617 
	`buf_´štf
(&
cmd
, " --dhcp-pre-release");

5619 ià(
‰
->
İtiÚs
.
dhı_»Ãw
)

5621 
	`buf_´štf
(&
cmd
, " --dhcp-renew");

5623 
	`buf_´štf
(&
cmd
, " --dhı-š‹º® %u", ()
‰
->
ad­‹r_šdex
);

5625 
	`fÜk_to_£lf
(
	`BSTR
(&
cmd
));

5626 
	`gc_ä“
(&
gc
);

5628 
	}
}

5631 
	$»gi¡”_dns_£rviû
(cÚ¡ 
tuÁ­
 *
‰
)

5633 
DWORD
 
Ën
;

5634 
HANDLE
 
msg_chªÃl
 = 
‰
->
İtiÚs
.msg_channel;

5635 
ack_mes§ge_t
 
ack
;

5636 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5638 
mes§ge_h—d”_t
 
rdns
 = { 
msg_»gi¡”_dns
, (message_header_t), 0 };

5640 ià(!
	`Wr™eFe
(
msg_chªÃl
, &
rdns
, Ôdns), &
Ën
, 
NULL
)

5641 || !
	`R—dFe
(
msg_chªÃl
, &
ack
, ×ck), &
Ën
, 
NULL
))

5643 
	`msg
(
M_WARN
, "Register_dns: could‚otalko service: %s [status=0x%lx]",

5644 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

5647 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

5649 
	`msg
(
M_WARN
, "Register_dns failed using service: %s [status=0x%x]",

5650 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),‡ck.error_number);

5655 
	`msg
(
M_INFO
, "Register_dns„equest sentohe service");

5658 
	`gc_ä“
(&
gc
);

5659 
	}
}

5662 
	$fÜk_»gi¡”_dns_aùiÚ
(
tuÁ­
 *
‰
)

5664 ià(
‰
 &&t->
İtiÚs
.
»gi¡”_dns
 &&t->İtiÚs.
msg_chªÃl
)

5666 
	`»gi¡”_dns_£rviû
(
‰
);

5668 ià(
‰
 &&t->
İtiÚs
.
»gi¡”_dns
)

5670 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5671 
bufãr
 
cmd
 = 
	`®loc_buf_gc
(256, &
gc
);

5672 cÚ¡ 
v”b
 = 3;

5674 
	`buf_´štf
(&
cmd
, "İ’v² --v”b %d --»gi¡”-dn --rdns-š‹º®", 
v”b
);

5675 
	`fÜk_to_£lf
(
	`BSTR
(&
cmd
));

5676 
	`gc_ä“
(&
gc
);

5678 
	}
}

5680 
ušt32_t


5681 
	$dhı_masq_addr
(cÚ¡ 
š_addr_t
 
loÿl
, cÚ¡ in_addr_ˆ
Ãtmask
, cÚ¡ 
off£t
)

5683 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5684 
š_addr_t
 
d§
;

5686 ià(
off£t
 < 0)

5688 
d§
 = (
loÿl
 | (~
Ãtmask
)è+ 
off£t
;

5692 
d§
 = (
loÿl
 & 
Ãtmask
è+ 
off£t
;

5695 ià(
d§
 =ğ
loÿl
)

5697 
	`msg
(
M_FATAL
, "ERROR: Th”i ¨şash b‘w“Àth--ifcÚfig†oÿÈadd»s ªdhš‹º® DHCP s”v”‡dd»s -- bÙh‡» s‘Ø% --…Ëa£ u£h---wš32 dyÇmiøİtiÚØchoo£‡ difã»Á f»add»s äomh--ifcÚfig subÃˆfÜhš‹º® DHCP s”v”", 
	`´št_š_addr_t
(
d§
, 0, &
gc
));

5700 ià((
loÿl
 & 
Ãtmask
è!ğ(
d§
 &‚etmask))

5702 
	`msg
(
M_FATAL
, "ERROR: --ip-win32 dynamic [offset] : offset is outside of --ifconfig subnet");

5705 
	`gc_ä“
(&
gc
);

5706  
	`htÚl
(
d§
);

5707 
	}
}

5710 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

5712 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

5713 
deviû_·th
[256];

5714 cÚ¡ *
deviû_guid
 = 
NULL
;

5715 
DWORD
 
Ën
;

5716 
boŞ
 
dhı_masq
 = 
çl£
;

5717 
boŞ
 
dhı_masq_po¡
 = 
çl£
;

5721 
	`msg
Ğ
M_INFO
, "open_tun");

5723 ià(
‰
->
ty³
 =ğ
DEV_TYPE_NULL
)

5725 
	`İ’_nuÎ
(
‰
);

5726 
	`gc_ä“
(&
gc
);

5729 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
 ||t->ty³ =ğ
DEV_TYPE_TUN
)

5734 
	`msg
(
M_FATAL
|
M_NOPREFIX
, "UnknowÀvœtu® deviûy³: '%s'", 
dev
);

5741 cÚ¡ 
p_»g
 *p_»g = 
	`g‘_p_»g
(&
gc
);

5742 cÚ¡ 
·Ãl_»g
 *·Ãl_»g = 
	`g‘_·Ãl_»g
(&
gc
);

5743 
aùu®_bufãr
[256];

5745 
	`©_Ëa¡_Úe_p_wš
(
p_»g
);

5747 ià(
dev_node
)

5750 
deviû_guid
 = 
	`g‘_deviû_guid
(
dev_node
, 
aùu®_bufãr
, ×ùu®_bufãr), 
p_»g
, 
·Ãl_»g
, &
gc
);

5752 ià(!
deviû_guid
)

5754 
	`msg
(
M_FATAL
, "TAP-Wšdow ad­‹¸'%s'‚Ù found", 
dev_node
);

5758 
	`İ’v²_¢´štf
(
deviû_·th
, (device_path), "%s%s%s",

5759 
USERMODEDEVICEDIR
,

5760 
deviû_guid
,

5761 
TAP_WIN_SUFFIX
);

5763 
‰
->
hªd
 = 
	`C»©eFe
(

5764 
deviû_·th
,

5765 
GENERIC_READ
 | 
GENERIC_WRITE
,

5768 
OPEN_EXISTING
,

5769 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

5773 ià(
‰
->
hªd
 =ğ
INVALID_HANDLE_VALUE
)

5775 
	`msg
(
M_ERR
, "C»©eFçed oÀTAP deviû: %s", 
deviû_·th
);

5780 
deviû_numb”
 = 0;

5783 
Œue
)

5785 
deviû_guid
 = 
	`g‘_un¥ecif›d_deviû_guid
(
deviû_numb”
,

5786 
aùu®_bufãr
,

5787 (
aùu®_bufãr
),

5788 
p_»g
,

5789 
·Ãl_»g
,

5790 &
gc
);

5792 ià(!
deviû_guid
)

5794 
	`msg
(
M_FATAL
, "All TAP-Windows‡dapters onhis system‡re currently in use.");

5798 
	`İ’v²_¢´štf
(
deviû_·th
, (device_path), "%s%s%s",

5799 
USERMODEDEVICEDIR
,

5800 
deviû_guid
,

5801 
TAP_WIN_SUFFIX
);

5803 
‰
->
hªd
 = 
	`C»©eFe
(

5804 
deviû_·th
,

5805 
GENERIC_READ
 | 
GENERIC_WRITE
,

5808 
OPEN_EXISTING
,

5809 
FILE_ATTRIBUTE_SYSTEM
 | 
FILE_FLAG_OVERLAPPED
,

5813 ià(
‰
->
hªd
 =ğ
INVALID_HANDLE_VALUE
)

5815 
	`msg
(
D_TUNTAP_INFO
, "C»©eFçed oÀTAP deviû: %s", 
deviû_·th
);

5822 
deviû_numb”
++;

5828 
‰
->
aùu®_Çme
 = 
	`¡ršg_®loc
(
aùu®_bufãr
, 
NULL
);

5831 
	`msg
(
M_INFO
, "TAP-WIN32 deviû [%s] o³Ãd: %s", 
‰
->
aùu®_Çme
, 
deviû_·th
);

5832 
‰
->
ad­‹r_šdex
 = 
	`g‘_ad­‹r_šdex
(
deviû_guid
);

5836 
ULONG
 
šfo
[3];

5837 
	`CLEAR
(
šfo
);

5838 ià(
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_GET_VERSION
,

5839 &
šfo
, (info),

5840 &
šfo
, (šfo), &
Ën
, 
NULL
))

5842 
	`msg
(
D_TUNTAP_INFO
, "TAP-Windows Driver Version %d.%d %s",

5843 (è
šfo
[0],

5844 (è
šfo
[1],

5845 (
šfo
[2] ? "(DEBUG)" : ""));

5848 ià(!(
šfo
[0] =ğ
TAP_WIN_MIN_MAJOR
 && info[1] >ğ
TAP_WIN_MIN_MINOR
))

5850 
	`msg
(
M_FATAL
, "ERROR: Thi v”siÚ oà" 
PACKAGE_NAME
 "„equires‡ TAP-Windows driverhat is‡t†east version %d.%d -- If you„ecently upgraded your " PACKAGE_NAME " distribution,‡„eboot is…robably„equired‡this…ointo get Windowso seehe‚ew driver.",

5851 
TAP_WIN_MIN_MAJOR
,

5852 
TAP_WIN_MIN_MINOR
);

5858 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN


5859 && 
šfo
[0] == 9 && info[1] < 8)

5861 
	`msg
Ğ
M_INFO
, "WARNING: T­-Wš32 driv” v”siÚ %d.%d dÛ nÙ suµÜˆIPv6 iÀTUN mode. IPv6 wÈnÙ wÜk. Upg¿dyou¸T­-Wš32 driv”.", (è
šfo
[0], () info[1] );

5866 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN


5867 && 
šfo
[0] == 9 && info[1] == 8)

5869 
	`msg
Ğ
M_FATAL
, "ERROR: T­-Wš32 driv” v”siÚ %d.%d i buggy„eg¬dšg sm®ÈIPv4…ack‘ š TUN mode. Upg¿dyou¸T­-Wš32 driv”.", (è
šfo
[0], () info[1] );

5875 
ULONG
 
mtu
;

5876 ià(
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_GET_MTU
,

5877 &
mtu
, (mtu),

5878 &
mtu
, (mtu), &
Ën
, 
NULL
))

5880 
‰
->
po¡_İ’_mtu
 = (è
mtu
;

5881 
	`msg
(
D_MTU_INFO
, "TAP-Wšdow MTU=%d", (è
mtu
);

5889 ià(
‰
->
did_ifcÚfig_£tup
)

5891 ià(
‰
->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_DHCP_MASQ
)

5896 ià(
	`dhı_¡©us
(
‰
->
ad­‹r_šdex
è=ğ
DHCP_STATUS_DISABLED
)

5899 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

5901 
	`£rviû_’abË_dhı
(
‰
);

5905 
	`Ãtsh_’abË_dhı
(&
‰
->
İtiÚs
,t->
aùu®_Çme
);

5908 
dhı_masq
 = 
Œue
;

5909 
dhı_masq_po¡
 = 
Œue
;

5911 ià(
‰
->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_ADAPTIVE
)

5916 ià(
	`dhı_¡©us
(
‰
->
ad­‹r_šdex
è!ğ
DHCP_STATUS_ENABLED
)

5918 
	`Ãtsh_ifcÚfig
(&
‰
->
İtiÚs
,

5919 
‰
->
aùu®_Çme
,

5920 
‰
->
loÿl
,

5921 
‰
->
ad­‹r_Ãtmask
,

5922 
NI_TEST_FIRST
|
NI_IP_NETMASK
|
NI_OPTIONS
);

5926 
dhı_masq
 = 
Œue
;

5933 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

5935 ià(!
‰
->
did_ifcÚfig_£tup
)

5937 
	`msg
(
M_FATAL
, "ERROR: --devun‡lso„equires --ifconfig");

5940 ià(
‰
->
tİŞogy
 =ğ
TOP_SUBNET
)

5942 
š_addr_t
 
•
[3];

5943 
BOOL
 
¡©us
;

5945 
•
[0] = 
	`htÚl
(
‰
->
loÿl
);

5946 
•
[1] = 
	`htÚl
(
‰
->
loÿl
 &t->
»mÙe_Ãtmask
);

5947 
•
[2] = 
	`htÚl
(
‰
->
»mÙe_Ãtmask
);

5949 
¡©us
 = 
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_CONFIG_TUN
,

5950 
•
, (ep),

5951 
•
, Óp), &
Ën
, 
NULL
);

5953 
	`msg
(
¡©us
 ? 
M_INFO
 : 
M_FATAL
, "Set TAP-Windows TUN subnet mode‚etwork/local/netmask = %s/%s/%s [%s]",

5954 
	`´št_š_addr_t
(
•
[1], 
IA_NET_ORDER
, &
gc
),

5955 
	`´št_š_addr_t
(
•
[0], 
IA_NET_ORDER
, &
gc
),

5956 
	`´št_š_addr_t
(
•
[2], 
IA_NET_ORDER
, &
gc
),

5957 
¡©us
 ? "SUCCEEDED" : "FAILED");

5963 
š_addr_t
 
•
[2];

5964 
•
[0] = 
	`htÚl
(
‰
->
loÿl
);

5965 
•
[1] = 
	`htÚl
(
‰
->
»mÙe_Ãtmask
);

5967 ià(!
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_CONFIG_POINT_TO_POINT
,

5968 
•
, (ep),

5969 
•
, Óp), &
Ën
, 
NULL
))

5971 
	`msg
(
M_FATAL
, "ERROR: The TAP-Windows driver„ejected‡ DeviceIoControl callo set Point-to-Point mode, which is„equired for --devun");

5978 ià(
dhı_masq
)

5980 
ušt32_t
 
•
[4];

5983 
•
[0] = 
	`htÚl
(
‰
->
loÿl
);

5984 
•
[1] = 
	`htÚl
(
‰
->
ad­‹r_Ãtmask
);

5987 ià(
‰
->
ty³
 =ğ
DEV_TYPE_TUN
)

5989 ià(
‰
->
tİŞogy
 =ğ
TOP_SUBNET
)

5991 ià(
‰
->
İtiÚs
.
dhı_masq_cu¡om_off£t
)

5993 
•
[2] = 
	`dhı_masq_addr
(
‰
->
loÿl
,t->
»mÙe_Ãtmask
,t->
İtiÚs
.
dhı_masq_off£t
);

5997 
•
[2] = 
	`dhı_masq_addr
(
‰
->
loÿl
,t->
»mÙe_Ãtmask
, -1);

6002 
•
[2] = 
	`htÚl
(
‰
->
»mÙe_Ãtmask
);

6007 
	`ASSERT
(
‰
->
ty³
 =ğ
DEV_TYPE_TAP
);

6008 
•
[2] = 
	`dhı_masq_addr
(
‰
->
loÿl
,t->
ad­‹r_Ãtmask
,t->
İtiÚs
.
dhı_masq_cu¡om_off£t
 ?t->İtiÚs.
dhı_masq_off£t
 : 0);

6012 
•
[3] = (
ušt32_t
è
‰
->
İtiÚs
.
dhı_Ëa£_time
;

6014 
	`ASSERT
(
•
[3] > 0);

6016 #iâdeà
SIMULATE_DHCP_FAILED


6017 ià(!
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_CONFIG_DHCP_MASQ
,

6018 
•
, (ep),

6019 
•
, Óp), &
Ën
, 
NULL
))

6021 
	`msg
(
M_FATAL
, "ERROR: The TAP-Windows driver„ejected‡ DeviceIoControl callo set TAP_WIN_IOCTL_CONFIG_DHCP_MASQ mode");

6024 
	`msg
(
M_INFO
, "Notified TAP-Windows drivero set‡ DHCP IP/netmask of %s/%s on interface %s [DHCP-serv: %s,†ease-time: %d]",

6025 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
),

6026 
	`´št_š_addr_t
(
‰
->
ad­‹r_Ãtmask
, 0, &
gc
),

6027 
deviû_guid
,

6028 
	`´št_š_addr_t
(
•
[2], 
IA_NET_ORDER
, &
gc
),

6029 
•
[3]

6033 ià(
‰
->
İtiÚs
.
dhı_İtiÚs
)

6035 
bufãr
 
buf
 = 
	`®loc_buf
(256);

6036 ià(
	`bud_dhı_İtiÚs_¡ršg
(&
buf
, &
‰
->
İtiÚs
))

6038 
	`msg
(
D_DHCP_OPT
, "DHCP o±iÚ sŒšg: %s", 
	`fÜm©_hex
(
	`BPTR
(&
buf
), 
	`BLEN
(&buf), 0, &
gc
));

6039 ià(!
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_CONFIG_DHCP_SET_OPT
,

6040 
	`BPTR
(&
buf
), 
	`BLEN
(&buf),

6041 
	`BPTR
(&
buf
), 
	`BLEN
(&buf), &
Ën
, 
NULL
))

6043 
	`msg
(
M_FATAL
, "ERROR: The TAP-Windows driver„ejected‡ TAP_WIN_IOCTL_CONFIG_DHCP_SET_OPT DeviceIoControl call");

6048 
	`msg
(
M_WARN
, "DHCP option string‚ot set dueoƒrror");

6050 
	`ä“_buf
(&
buf
);

6057 
ULONG
 
¡©us
 = 
TRUE
;

6058 ià(!
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_SET_MEDIA_STATUS
,

6059 &
¡©us
, (status),

6060 &
¡©us
, (¡©us), &
Ën
, 
NULL
))

6062 
	`msg
(
M_WARN
, "WARNING: The TAP-Windows driver„ejected‡ TAP_WIN_IOCTL_SET_MEDIA_STATUS DeviceIoControl call.");

6068 
s
 = 
‰
->
İtiÚs
.
p_¦“p
;

6069 ià(
s
 > 0)

6071 
	`msg
(
M_INFO
, "SË•šg fÜ %d secÚds...", 
s
);

6072 
	`mªagem’t_¦“p
(
s
);

6078 cÚ¡ 
DWORD
 
šdex
 = 
‰
->
ad­‹r_šdex
;

6081 ià(
šdex
 !ğ
TUN_ADAPTER_INDEX_INVALID
)

6083 
DWORD
 
¡©us
 = -1;

6085 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

6087 
ack_mes§ge_t
 
ack
;

6088 
æush_ÃighbÜs_mes§ge_t
 
msg
 = {

6089 .
h—d”
 = {

6090 
msg_æush_ÃighbÜs
,

6091 (
æush_ÃighbÜs_mes§ge_t
),

6094 .
çmy
 = 
AF_INET
,

6095 .
içû
 = { .
šdex
 = index, .
Çme
 = "" }

6098 ià(!
	`Wr™eFe
(
‰
->
İtiÚs
.
msg_chªÃl
, &
msg
, (msg), &
Ën
, 
NULL
)

6099 || !
	`R—dFe
(
‰
->
İtiÚs
.
msg_chªÃl
, &
ack
, ×ck), &
Ën
, 
NULL
))

6101 
	`msg
(
M_WARN
, "TUN: could‚otalko service: %s [%lu]",

6102 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

6105 
¡©us
 = 
ack
.
”rÜ_numb”
;

6109 
¡©us
 = 
	`FlushIpN‘TabË
(
šdex
);

6112 ià(
¡©us
 =ğ
NO_ERROR
)

6114 
	`msg
(
M_INFO
, "Successful ARP Flush on interface [%u] %s",

6115 ()
šdex
,

6116 
deviû_guid
);

6118 ià(
¡©us
 != -1)

6120 
	`msg
(
D_TUNTAP_INFO
, "NOTE: FlushIpNetTable failed on interface [%u] %s (status=%u) : %s",

6121 ()
šdex
,

6122 
deviû_guid
,

6123 ()
¡©us
,

6124 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

6133 ià(
dhı_masq_po¡
)

6136 ià(
	`dhı_¡©us
(
šdex
è=ğ
DHCP_STATUS_DISABLED
)

6138 
	`msg
(
M_WARN
, "WARNING: You have selected '--ip-win32 dynamic', which will‚ot work unlesshe TAP-Windows TCP/IP…roperties‡re seto 'Obtain‡n IP‡ddress‡utomatically'");

6142 ià(
‰
->
İtiÚs
.
dhı_´e_»Ëa£
)

6144 
	`dhı_»Ëa£
(
‰
);

6146 ià(
‰
->
İtiÚs
.
dhı_»Ãw
)

6148 
	`dhı_»Ãw
(
‰
);

6153 
	`fÜk_dhı_aùiÚ
(
‰
);

6156 ià(
‰
->
did_ifcÚfig_£tup
 &&t->
İtiÚs
.
_wš32_ty³
 =ğ
IPW32_SET_IPAPI
)

6158 
DWORD
 
¡©us
;

6159 cÚ¡ *
”rÜ_suffix
 = "I‡m havingrouble usinghe Windows 'IP helper API'o‡utomatically sethe IP‡ddress -- consider using other --ip-win32 methods (not 'ipapi')";

6162 ià(
šdex
 =ğ
TUN_ADAPTER_INDEX_INVALID
)

6164 
	`msg
(
M_FATAL
, "ERROR: unableo get‡dapter index for interface %s -- %s",

6165 
deviû_guid
,

6166 
”rÜ_suffix
);

6170 ià(
	`dhı_¡©us
(
šdex
è=ğ
DHCP_STATUS_DISABLED
)

6172 
	`msg
(
M_WARN
, "NOTE: You have selected (explicitly or by default) '--ip-win32 ipapi', which has‡ better chance of working correctly ifhe TAP-Windows TCP/IP…roperties‡re seto 'Obtain‡n IP‡ddress‡utomatically'");

6177 
	`d–‘e_‹mp_add»s£s
(
šdex
);

6180 ià((
¡©us
 = 
	`AddIPAdd»ss
(
	`htÚl
(
‰
->
loÿl
),

6181 
	`htÚl
(
‰
->
ad­‹r_Ãtmask
),

6182 
šdex
,

6183 &
‰
->
­i_cÚ‹xt
,

6184 &
‰
->
­i_š¡ªû
)è=ğ
NO_ERROR
)

6186 
	`msg
(
M_INFO
, "Succeeded in‡dding‡emporary IP/netmask of %s/%so interface %s usinghe Win32 IP Helper API",

6187 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
),

6188 
	`´št_š_addr_t
(
‰
->
ad­‹r_Ãtmask
, 0, &
gc
),

6189 
deviû_guid


6194 
	`msg
(
M_FATAL
, "ERROR: AddIPAddress %s/%s failed on interface %s, index=%d, status=%u (windowsƒrror: '%s') -- %s",

6195 
	`´št_š_addr_t
(
‰
->
loÿl
, 0, &
gc
),

6196 
	`´št_š_addr_t
(
‰
->
ad­‹r_Ãtmask
, 0, &
gc
),

6197 
deviû_guid
,

6198 ()
šdex
,

6199 ()
¡©us
,

6200 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
),

6201 
”rÜ_suffix
);

6203 
‰
->
­i_cÚ‹xt_defšed
 = 
Œue
;

6207 
	`gc_ä“
(&
gc
);

6208 
	}
}

6211 
	$p_wš_g‘šfo
(cÚ¡ 
tuÁ­
 *
‰
, 
gc_¬’a
 *
gc
)

6213 ià(
‰
 &&t->
hªd
 !ğ
NULL
)

6215 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

6216 
DWORD
 
Ën
;

6217 ià(
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_GET_INFO
,

6218 
	`BSTR
(&
out
), 
	`BCAP
(&out),

6219 
	`BSTR
(&
out
), 
	`BCAP
(&out),

6220 &
Ën
, 
NULL
))

6222  
	`BSTR
(&
out
);

6225  
NULL
;

6226 
	}
}

6229 
	$tun_show_debug
(
tuÁ­
 *
‰
)

6231 ià(
‰
 &&t->
hªd
 !ğ
NULL
)

6233 
bufãr
 
out
 = 
	`®loc_buf
(1024);

6234 
DWORD
 
Ën
;

6235 
	`DeviûIoCÚŒŞ
(
‰
->
hªd
, 
TAP_WIN_IOCTL_GET_LOG_LINE
,

6236 
	`BSTR
(&
out
), 
	`BCAP
(&out),

6237 
	`BSTR
(&
out
), 
	`BCAP
(&out),

6238 &
Ën
, 
NULL
))

6240 
	`msg
(
D_TAP_WIN_DEBUG
, "TAP-Wšdows: %s", 
	`BSTR
(&
out
));

6242 
	`ä“_buf
(&
out
);

6244 
	}
}

6247 
	$şo£_tun
(
tuÁ­
 *
‰
)

6249 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

6251 ià(
‰
)

6253 ià(
‰
->
did_ifcÚfig_v6_£tup
)

6256 
	`d–‘e_rou‹_cÚÃùed_v6_Ãt
(
‰
, 
NULL
);

6258 ià(
‰
->
İtiÚs
.
msg_chªÃl
)

6260 
	`do_add»ss_£rviû
(
çl£
, 
AF_INET6
, 
‰
);

6261 ià(
‰
->
İtiÚs
.
dns6_Ën
 > 0)

6263 
	`do_dns6_£rviû
(
çl£
, 
‰
);

6268 cÚ¡ *
ifcÚfig_v6_loÿl
;

6269 
¬gv
‡rgv = 
	`¬gv_Ãw
();

6276 
ifcÚfig_v6_loÿl
 = 
	`´št_š6_addr
(
‰
->
loÿl_v6
, 0, &
gc
);

6277 
	`¬gv_´štf
(&
¬gv
,

6279 
	`g‘_wš_sys_·th
(),

6280 
NETSH_PATH_SUFFIX
,

6281 
‰
->
aùu®_Çme
,

6282 
ifcÚfig_v6_loÿl
);

6284 
	`Ãtsh_commªd
(&
¬gv
, 1, 
M_WARN
);

6287 ià(
‰
->
İtiÚs
.
dns6_Ën
 > 0)

6289 
	`¬gv_´štf
(&
¬gv
,

6291 
	`g‘_wš_sys_·th
(),

6292 
NETSH_PATH_SUFFIX
,

6293 
‰
->
aùu®_Çme
);

6294 
	`Ãtsh_commªd
(&
¬gv
, 1, 
M_WARN
);

6296 
	`¬gv_»£t
(&
¬gv
);

6300 ià(
‰
->
­i_cÚ‹xt_defšed
)

6302 
DWORD
 
¡©us
;

6303 ià((
¡©us
 = 
	`D–‘eIPAdd»ss
(
‰
->
­i_cÚ‹xt
)è!ğ
NO_ERROR
)

6305 
	`msg
(
M_WARN
, "Warning: DeleteIPAddress[%u] failed on TAP-Windows‡dapter, status=%u : %s",

6306 ()
‰
->
­i_cÚ‹xt
,

6307 ()
¡©us
,

6308 
	`¡»¼Ü_wš32
(
¡©us
, &
gc
));

6313 
	`dhı_»Ëa£
(
‰
);

6315 ià(
‰
->
hªd
 !ğ
NULL
)

6317 
	`dmsg
(
D_WIN32_IO_LOW
, "Attempting CancelIO on TAP-Windows‡dapter");

6318 ià(!
	`CªûlIo
(
‰
->
hªd
))

6320 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: CancelIO failed on TAP-Windows‡dapter");

6324 
	`dmsg
(
D_WIN32_IO_LOW
, "Attempting close of overlapped„eadƒvent on TAP-Windows‡dapter");

6325 
	`ov”Ïµed_io_şo£
(&
‰
->
»ads
);

6327 
	`dmsg
(
D_WIN32_IO_LOW
, "Attempting close of overlapped writeƒvent on TAP-Windows‡dapter");

6328 
	`ov”Ïµed_io_şo£
(&
‰
->
wr™es
);

6330 ià(
‰
->
hªd
 !ğ
NULL
)

6332 
	`dmsg
(
D_WIN32_IO_LOW
, "Attempting CloseHandle on TAP-Windows‡dapter");

6333 ià(!
	`Clo£HªdË
(
‰
->
hªd
))

6335 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle failed on TAP-Windows‡dapter");

6339 ià(
‰
->
aùu®_Çme
)

6341 
	`ä“
(
‰
->
aùu®_Çme
);

6344 
	`ş—r_tuÁ­
(
‰
);

6345 
	`ä“
(
‰
);

6347 
	`gc_ä“
(&
gc
);

6348 
	}
}

6354 
	s£t_Çmes
 {

6355 cÚ¡ *
	mshÜt_fÜm
;

6359 cÚ¡ 
£t_Çmes
 
	g£t_Çmes
[] = {

6368 
	$ascii2£t
(cÚ¡ *
Çme
)

6370 
i
;

6371 
	`ASSERT
(
IPW32_SET_N
 =ğ
	`SIZE
(
£t_Çmes
));

6372 
i
 = 0; i < 
IPW32_SET_N
; ++i)

6374 ià(!
	`¡rcmp
(
Çme
, 
£t_Çmes
[
i
].
shÜt_fÜm
))

6376  
i
;

6380 
	}
}

6383 
	$£t2ascii
(
šdex
)

6385 
	`ASSERT
(
IPW32_SET_N
 =ğ
	`SIZE
(
£t_Çmes
));

6386 ià(
šdex
 < 0 || index >ğ
IPW32_SET_N
)

6392  
£t_Çmes
[
šdex
].
shÜt_fÜm
;

6394 
	}
}

6397 
	$£t2ascii_®l
(
gc_¬’a
 *
gc
)

6399 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

6400 
i
;

6402 
	`ASSERT
(
IPW32_SET_N
 =ğ
	`SIZE
(
£t_Çmes
));

6403 
i
 = 0; i < 
IPW32_SET_N
; ++i)

6405 ià(
i
)

6407 
	`buf_´štf
(&
out
, " ");

6409 
	`buf_´štf
(&
out
, "[%s]", 
	`£t2ascii
(
i
));

6411  
	`BSTR
(&
out
);

6412 
	}
}

6417 
	$İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
, 
tuÁ­
 *
‰
)

6419 
	`İ’_tun_g’”ic
(
dev
, 
dev_ty³
, 
dev_node
, 
Œue
, 
‰
);

6420 
	}
}

6423 
	$şo£_tun
(
tuÁ­
 *
‰
)

6425 ià(
‰
)

6427 
	`şo£_tun_g’”ic
(
‰
);

6428 
	`ä“
(
‰
);

6430 
	}
}

6433 
	$wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

6435  
	`wr™e
(
‰
->
fd
, 
buf
, 
Ën
);

6436 
	}
}

6439 
	$»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
)

6441  
	`»ad
(
‰
->
fd
, 
buf
, 
Ën
);

6442 
	}
}

	@tun.h

24 #iâdeà
TUN_H


25 
	#TUN_H


	)

27 #ifdeà
_WIN32


28 
	~<wšioùl.h
>

29 
	~<p-wšdows.h
>

32 
	~"bufãr.h
"

33 
	~"”rÜ.h
"

34 
	~"mtu.h
"

35 
	~"wš32.h
"

36 
	~"ev’t.h
"

37 
	~"´Ùo.h
"

38 
	~"misc.h
"

40 #ià
defšed
(
_WIN32
è|| defšed(
TARGET_ANDROID
)

42 
	#TUN_ADAPTER_INDEX_INVALID
 ((
DWORD
)-1)

	)

45 
	#IPW32_SET_ADAPTIVE_DELAY_WINDOW
 300

	)

46 
	#IPW32_SET_ADAPTIVE_TRY_NETSH
 20

	)

48 
	stuÁ­_İtiÚs
 {

50 
boŞ
 
	m_wš32_defšed
;

52 
	#IPW32_SET_MANUAL
 0

	)

53 
	#IPW32_SET_NETSH
 1

	)

54 
	#IPW32_SET_IPAPI
 2

	)

55 
	#IPW32_SET_DHCP_MASQ
 3

	)

56 
	#IPW32_SET_ADAPTIVE
 4

	)

57 
	#IPW32_SET_N
 5

	)

58 
	m_wš32_ty³
;

60 #ifdeà
_WIN32


61 
HANDLE
 
	mmsg_chªÃl
;

65 
boŞ
 
	mdhı_masq_cu¡om_off£t
;

66 
	mdhı_masq_off£t
;

67 
	mdhı_Ëa£_time
;

70 
	mp_¦“p
;

74 
boŞ
 
	mdhı_İtiÚs
;

76 cÚ¡ *
	mdomaš
;

78 cÚ¡ *
	mÃtbios_scİe
;

80 
	mÃtbios_node_ty³
;

82 
	#N_DHCP_ADDR
 4

	)

86 
š_addr_t
 
	mdns
[
N_DHCP_ADDR
];

87 
	mdns_Ën
;

90 
š_addr_t
 
	mwšs
[
N_DHCP_ADDR
];

91 
	mwšs_Ën
;

94 
š_addr_t
 
	mÁp
[
N_DHCP_ADDR
];

95 
	mÁp_Ën
;

98 
š_addr_t
 
	mnbdd
[
N_DHCP_ADDR
];

99 
	mnbdd_Ën
;

102 
boŞ
 
	mdi§bË_nbt
;

104 
boŞ
 
	mdhı_»Ãw
;

105 
boŞ
 
	mdhı_´e_»Ëa£
;

107 
boŞ
 
	m»gi¡”_dns
;

109 
š6_addr
 
	mdns6
[
N_DHCP_ADDR
];

110 
	mdns6_Ën
;

113 #–ià
TARGET_LINUX


115 
	stuÁ­_İtiÚs
 {

116 
	mtxqueu–’
;

121 
	stuÁ­_İtiÚs
 {

122 
	mdummy
;

131 
	stuÁ­


133 
	#TUNNEL_TYPE
(
‰
è(Ñtè? (Ñt)->
ty³
è: 
DEV_TYPE_UNDEF
)

	)

134 
	mty³
;

136 
	#TUNNEL_TOPOLOGY
(
‰
è(Ñtè? (Ñt)->
tİŞogy
è: 
TOP_UNDEF
)

	)

137 
	mtİŞogy
;

139 
boŞ
 
	mdid_ifcÚfig_£tup
;

140 
boŞ
 
	mdid_ifcÚfig_v6_£tup
;

141 
boŞ
 
	mdid_ifcÚfig
;

143 
boŞ
 
	m³rsi¡’t_if
;

145 
tuÁ­_İtiÚs
 
	mİtiÚs
;

147 *
	maùu®_Çme
;

150 
	mtxqueu–’
;

153 
š_addr_t
 
	mloÿl
;

154 
š_addr_t
 
	m»mÙe_Ãtmask
;

155 
š_addr_t
 
	mbrßdÿ¡
;

157 
š6_addr
 
	mloÿl_v6
;

158 
š6_addr
 
	m»mÙe_v6
;

159 
	mÃtb™s_v6
;

161 #ifdeà
_WIN32


162 
HANDLE
 
	mhªd
;

163 
ov”Ïµed_io
 
	m»ads
;

164 
ov”Ïµed_io
 
	mwr™es
;

165 
rw_hªdË
 
	mrw_hªdË
;

169 
boŞ
 
	m­i_cÚ‹xt_defšed
;

170 
ULONG
 
	m­i_cÚ‹xt
;

171 
ULONG
 
	m­i_š¡ªû
;

172 
š_addr_t
 
	mad­‹r_Ãtmask
;

176 
DWORD
 
	mad­‹r_šdex
;

178 
	m¡ªdby_™”
;

180 
	mfd
;

183 #ifdeà
TARGET_SOLARIS


184 
	m_fd
;

187 #ifdeà
HAVE_NET_IF_UTUN_H


188 
boŞ
 
	mis_utun
;

191 
	mrwæags_debug
;

195 
	mpo¡_İ’_mtu
;

198 
šlše
 
boŞ


199 
	$tuÁ­_defšed
(cÚ¡ 
tuÁ­
 *
‰
)

201 #ifdeà
_WIN32


202  
‰
 &&t->
hªd
 !ğ
NULL
;

204  
‰
 &&t->
fd
 >= 0;

206 
	}
}

212 
İ’_tun
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
,

213 
tuÁ­
 *
‰
);

215 
şo£_tun
(
tuÁ­
 *
‰
);

217 
wr™e_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
);

219 
»ad_tun
(
tuÁ­
 *
‰
, 
ušt8_t
 *
buf
, 
Ën
);

221 
tuncfg
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
dev_node
,

222 
³rsi¡_mode
, cÚ¡ *
u£ºame
,

223 cÚ¡ *
grou²ame
, cÚ¡ 
tuÁ­_İtiÚs
 *
İtiÚs
);

225 cÚ¡ *
guess_tuÁ­_dev
(cÚ¡ *
dev
,

226 cÚ¡ *
dev_ty³
,

227 cÚ¡ *
dev_node
,

228 
gc_¬’a
 *
gc
);

230 
tuÁ­
 *
š™_tun
(cÚ¡ *
dev
,

231 cÚ¡ *
dev_ty³
,

232 
tİŞogy
,

233 cÚ¡ *
ifcÚfig_loÿl_·rm
,

234 cÚ¡ *
ifcÚfig_»mÙe_Ãtmask_·rm
,

235 cÚ¡ *
ifcÚfig_v6_loÿl_·rm
,

236 
ifcÚfig_v6_Ãtb™s_·rm
,

237 cÚ¡ *
ifcÚfig_v6_»mÙe_·rm
,

238 
addršfo
 *
loÿl_public
,

239 
addršfo
 *
»mÙe_public
,

240 cÚ¡ 
boŞ
 
¡riù_w¬n
,

241 
’v_£t
 *
es
);

243 
š™_tun_po¡
(
tuÁ­
 *
‰
,

244 cÚ¡ 
äame
 *frame,

245 cÚ¡ 
tuÁ­_İtiÚs
 *
İtiÚs
);

247 
do_ifcÚfig_£‹nv
(cÚ¡ 
tuÁ­
 *
‰
,

248 
’v_£t
 *
es
);

250 
do_ifcÚfig
(
tuÁ­
 *
‰
,

251 cÚ¡ *
aùu®
,

252 
tun_mtu
,

253 cÚ¡ 
’v_£t
 *
es
);

255 
boŞ
 
is_dev_ty³
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
, cÚ¡ *
m©ch_ty³
);

257 
dev_ty³_’um
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
);

259 cÚ¡ *
dev_ty³_¡ršg
(cÚ¡ *
dev
, cÚ¡ *
dev_ty³
);

261 cÚ¡ *
ifcÚfig_İtiÚs_¡ršg
(cÚ¡ 
tuÁ­
 *
‰
, 
boŞ
 
»mÙe
, boŞ 
di§bË
, 
gc_¬’a
 *
gc
);

263 
boŞ
 
is_tun_p2p
(cÚ¡ 
tuÁ­
 *
‰
);

265 
check_subÃt_cÚæiù
(cÚ¡ 
š_addr_t
 

,

266 cÚ¡ 
š_addr_t
 
Ãtmask
,

267 cÚ¡ *
´efix
);

269 
w¬n_Ú_u£_of_commÚ_subÃts
();

275 
šlše
 

276 
	$tun_adju¡_äame_·¿m‘”s
(
äame
 *äame, 
size
)

278 
	`äame_add_to_exŒa_tun
(
äame
, 
size
);

279 
	}
}

286 
	#IFCONFIG_BEFORE_TUN_OPEN
 0

	)

287 
	#IFCONFIG_AFTER_TUN_OPEN
 1

	)

289 
	#IFCONFIG_DEFAULT
 
IFCONFIG_AFTER_TUN_OPEN


	)

291 
šlše
 

292 
	$ifcÚfig_Üd”
()

294 #ià
	`defšed
(
TARGET_LINUX
)

295  
IFCONFIG_AFTER_TUN_OPEN
;

296 #–ià
	`defšed
(
TARGET_SOLARIS
)

297  
IFCONFIG_AFTER_TUN_OPEN
;

298 #–ià
	`defšed
(
TARGET_OPENBSD
)

299  
IFCONFIG_AFTER_TUN_OPEN
;

300 #–ià
	`defšed
(
TARGET_DARWIN
)

301  
IFCONFIG_AFTER_TUN_OPEN
;

302 #–ià
	`defšed
(
TARGET_NETBSD
)

303  
IFCONFIG_AFTER_TUN_OPEN
;

304 #–ià
	`defšed
(
_WIN32
)

305  
IFCONFIG_AFTER_TUN_OPEN
;

306 #–ià
	`defšed
(
TARGET_ANDROID
)

307  
IFCONFIG_BEFORE_TUN_OPEN
;

309  
IFCONFIG_DEFAULT
;

311 
	}
}

313 
	#ROUTE_BEFORE_TUN
 0

	)

314 
	#ROUTE_AFTER_TUN
 1

	)

315 
	#ROUTE_ORDER_DEFAULT
 
ROUTE_AFTER_TUN


	)

317 
šlše
 

318 
	$rou‹_Üd”
()

320 #ià
	`defšed
(
TARGET_ANDROID
)

321  
ROUTE_BEFORE_TUN
;

323  
ROUTE_ORDER_DEFAULT
;

325 
	}
}

328 #ifdeà
_WIN32


330 
	#TUN_PASS_BUFFER


	)

332 
	sp_»g


334 cÚ¡ *
	mguid
;

335 
p_»g
 *
	mÃxt
;

338 
	s·Ãl_»g


340 cÚ¡ *
	mÇme
;

341 cÚ¡ *
	mguid
;

342 
·Ãl_»g
 *
	mÃxt
;

345 
ascii2£t
(cÚ¡ *
Çme
);

347 cÚ¡ *
£t2ascii
(
šdex
);

349 cÚ¡ *
£t2ascii_®l
(
gc_¬’a
 *
gc
);

351 
v”ify_255_255_255_252
(
š_addr_t
 
loÿl
, in_addr_ˆ
»mÙe
);

353 cÚ¡ 
IP_ADAPTER_INFO
 *
g‘_ad­‹r_šfo_li¡
(
gc_¬’a
 *
gc
);

355 cÚ¡ 
IP_ADAPTER_INFO
 *
g‘_tun_ad­‹r
(cÚ¡ 
tuÁ­
 *
‰
, cÚ¡ IP_ADAPTER_INFO *
li¡
);

357 cÚ¡ 
IP_ADAPTER_INFO
 *
g‘_ad­‹r_šfo
(
DWORD
 
šdex
, 
gc_¬’a
 *
gc
);

359 cÚ¡ 
IP_PER_ADAPTER_INFO
 *
g‘_³r_ad­‹r_šfo
(cÚ¡ 
DWORD
 
šdex
, 
gc_¬’a
 *
gc
);

361 cÚ¡ 
IP_ADAPTER_INFO
 *
g‘_ad­‹r
(cÚ¡ IP_ADAPTER_INFO *
ai
, 
DWORD
 
šdex
);

363 
boŞ
 
is_ad­‹r_up
(cÚ¡ 
tuÁ­
 *
‰
, cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
);

365 
boŞ
 
is__š_ad­‹r_subÃt
(cÚ¡ 
IP_ADAPTER_INFO
 *
ai
, cÚ¡ 
š_addr_t
 

, in_addr_ˆ*
highe¡_Ãtmask
);

367 
DWORD
 
ad­‹r_šdex_of_
(cÚ¡ 
IP_ADAPTER_INFO
 *
li¡
,

368 cÚ¡ 
š_addr_t
 

,

369 *
couÁ
,

370 
š_addr_t
 *
Ãtmask
);

372 
show_p_wš_ad­‹rs
(
msgËv
, 
w¬Æev
);

374 
show_ad­‹rs
(
msgËv
);

376 
p_®low_nÚadmš_acûss
(cÚ¡ *
dev_node
);

378 
show_v®id_wš32_tun_subÃts
();

380 cÚ¡ *
p_wš_g‘šfo
(cÚ¡ 
tuÁ­
 *
‰
, 
gc_¬’a
 *
gc
);

382 
tun_show_debug
(
tuÁ­
 *
‰
);

384 
boŞ
 
dhı_»Ëa£_by_ad­‹r_šdex
(cÚ¡ 
DWORD
 
ad­‹r_šdex
);

386 
boŞ
 
dhı_»Ãw_by_ad­‹r_šdex
(cÚ¡ 
DWORD
 
ad­‹r_šdex
);

388 
fÜk_»gi¡”_dns_aùiÚ
(
tuÁ­
 *
‰
);

390 
cÚfig_»gi¡”_dns
(cÚ¡ 
’v_£t
 *
es
);

392 
tun_¡ªdby_š™
(
tuÁ­
 *
‰
);

394 
boŞ
 
tun_¡ªdby
(
tuÁ­
 *
‰
);

396 
tun_»ad_queue
(
tuÁ­
 *
‰
, 
maxsize
);

398 
tun_wr™e_queue
(
tuÁ­
 *
‰
, 
bufãr
 *
buf
);

400 
tun_fš®ize
(
HANDLE
 
h
, 
ov”Ïµed_io
 *
io
, 
bufãr
 *
buf
);

402 
šlše
 
boŞ


403 
	$tuÁ­_¡İ
(
¡©us
)

409 ià(
¡©us
 < 0)

411  
	`İ’v²_”ºo
(è=ğ
ERROR_FILE_NOT_FOUND
;

413  
çl£
;

414 
	}
}

416 
šlše
 
boŞ


417 
	$tuÁ­_abÜt
(
¡©us
)

422 ià(
¡©us
 < 0)

424  
	`İ’v²_”ºo
(è=ğ
ERROR_OPERATION_ABORTED
;

426  
çl£
;

427 
	}
}

429 
šlše
 

430 
	$tun_wr™e_wš32
(
tuÁ­
 *
‰
, 
bufãr
 *
buf
)

432 
”r
 = 0;

433 
¡©us
 = 0;

434 ià(
	`ov”Ïµed_io_aùive
(&
‰
->
wr™es
))

436 
¡©us
 = 
	`tun_fš®ize
(
‰
->
hªd
, &‰->
wr™es
, 
NULL
);

437 ià(
¡©us
 < 0)

439 
”r
 = 
	`G‘La¡E¼Ü
();

442 
	`tun_wr™e_queue
(
‰
, 
buf
);

443 ià(
¡©us
 < 0)

445 
	`S‘La¡E¼Ü
(
”r
);

446  
¡©us
;

450  
	`BLEN
(
buf
);

452 
	}
}

454 
šlše
 

455 
	$»ad_tun_bufã»d
(
tuÁ­
 *
‰
, 
bufãr
 *
buf
, 
maxsize
)

457  
	`tun_fš®ize
(
‰
->
hªd
, &‰->
»ads
, 
buf
);

458 
	}
}

460 
šlše
 

461 
	$wr™e_tun_bufã»d
(
tuÁ­
 *
‰
, 
bufãr
 *
buf
)

463  
	`tun_wr™e_wš32
(
‰
, 
buf
);

464 
	}
}

468 
šlše
 
boŞ


469 
	$tuÁ­_¡İ
(
¡©us
)

471  
çl£
;

472 
	}
}

474 
šlše
 
boŞ


475 
	$tuÁ­_abÜt
(
¡©us
)

477  
çl£
;

478 
	}
}

480 
šlše
 

481 
	$tun_¡ªdby_š™
(
tuÁ­
 *
‰
)

483 
	}
}

485 
šlše
 
boŞ


486 
	$tun_¡ªdby
(
tuÁ­
 *
‰
)

488  
Œue
;

489 
	}
}

497 
šlše
 
ev’t_t


498 
	$tun_ev’t_hªdË
(cÚ¡ 
tuÁ­
 *
‰
)

500 #ifdeà
_WIN32


501  &
‰
->
rw_hªdË
;

503  
‰
->
fd
;

505 
	}
}

507 
šlše
 

508 
	$tun_£t
(
tuÁ­
 *
‰
,

509 
ev’t_£t
 *
es
,

510 
rwæags
,

511 *
¬g
,

512 *
³rsi¡’t
)

514 ià(
	`tuÁ­_defšed
(
‰
))

517 ià(!
³rsi¡’t
 || *³rsi¡’ˆ!ğ
rwæags
)

519 
	`ev’t_ùl
(
es
, 
	`tun_ev’t_hªdË
(
‰
), 
rwæags
, 
¬g
);

520 ià(
³rsi¡’t
)

522 *
³rsi¡’t
 = 
rwæags
;

525 #ifdeà
_WIN32


526 ià(
rwæags
 & 
EVENT_READ
)

528 
	`tun_»ad_queue
(
‰
, 0);

531 
‰
->
rwæags_debug
 = 
rwæags
;

533  
rwæags
;

534 
	}
}

536 cÚ¡ *
tun_¡©
(cÚ¡ 
tuÁ­
 *
‰
, 
rwæags
, 
gc_¬’a
 *
gc
);

	@win32.c

29 #ifdeà
HAVE_CONFIG_H


30 
	~"cÚfig.h
"

31 #–ià
defšed
(
_MSC_VER
)

32 
	~"cÚfig-msvc.h
"

35 
	~"sysh—d.h
"

37 #ifdeà
_WIN32


39 
	~"bufãr.h
"

40 
	~"”rÜ.h
"

41 
	~"mtu.h
"

42 
	~"sig.h
"

43 
	~"wš32.h
"

44 
	~"misc.h
"

45 
	~"İ’v²-msg.h
"

47 
	~"memdbg.h
"

49 #ifdeà
HAVE_VERSIONHELPERS_H


50 
	~<v”siÚh–³rs.h
>

52 
	~"com·t-v”siÚh–³rs.h
"

55 
	~"block_dns.h
"

60 
HANDLE
 
	gm_hEngšeHªdË
 = 
NULL
;

65 
	gp_m‘ric_v4
 = -1;

66 
	gp_m‘ric_v6
 = -1;

71 
WSAD©a
 
	gw§_¡©e
;

76 
boŞ
 
	g·u£_ex™_’abËd
 = 
çl£
;

84 
wš32_sigÇl
 
	gwš32_sigÇl
;

90 
wšdow_t™Ë
 
	gwšdow_t™Ë
;

97 
£m­hÜe
 
	gÃtcmd_£m­hÜe
;

102 *
	gwš_sys_·th
 = 
NULL
;

105 
	$š™_wš32
()

107 ià(
	`WSAS¹up
(0x0101, &
w§_¡©e
))

109 
	`msg
(
M_ERR
, "WSAStartup failed");

111 
	`wšdow_t™Ë_ş—r
(&
wšdow_t™Ë
);

112 
	`wš32_sigÇl_ş—r
(&
wš32_sigÇl
);

113 
	}
}

116 
	$unš™_wš32
()

118 
	`Ãtcmd_£m­hÜe_şo£
();

119 ià(
·u£_ex™_’abËd
)

121 ià(
wš32_sigÇl
.
mode
 =ğ
WSO_MODE_UNDEF
)

123 
wš32_sigÇl
 
w
;

124 
	`wš32_sigÇl_İ’
(&
w
, 
WSO_FORCE_CONSOLE
, 
NULL
, 
çl£
);

125 
	`wš32_·u£
(&
w
);

126 
	`wš32_sigÇl_şo£
(&
w
);

130 
	`wš32_·u£
(&
wš32_sigÇl
);

133 
	`wšdow_t™Ë_»¡Üe
(&
wšdow_t™Ë
);

134 
	`wš32_sigÇl_şo£
(&
wš32_sigÇl
);

135 
	`WSACËªup
();

136 
	`ä“
(
wš_sys_·th
);

137 
	}
}

140 
	$£t_·u£_ex™_wš32
()

142 
·u£_ex™_’abËd
 = 
Œue
;

143 
	}
}

145 
boŞ


146 
	$š™_£cur™y_©Œibu‹s_®low_®l
(
£cur™y_©Œibu‹s
 *
obj
)

148 
	`CLEAR
(*
obj
);

150 
obj
->
§
.
nL’gth
 = (
SECURITY_ATTRIBUTES
);

151 
obj
->
§
.
ÍSecur™yDesütÜ
 = &obj->
sd
;

152 
obj
->
§
.
bInh”™HªdË
 = 
FALSE
;

153 ià(!
	`In™ŸlizeSecur™yDesütÜ
(&
obj
->
sd
, 
SECURITY_DESCRIPTOR_REVISION
))

155  
çl£
;

157 ià(!
	`S‘Secur™yDesütÜDaş
(&
obj
->
sd
, 
TRUE
, 
NULL
, 
FALSE
))

159  
çl£
;

161  
Œue
;

162 
	}
}

165 
	$ov”Ïµed_io_š™
(
ov”Ïµed_io
 *
o
,

166 cÚ¡ 
äame
 *frame,

167 
BOOL
 
ev’t_¡©e
,

168 
boŞ
 
tuÁ­_bufãr
)

170 
	`CLEAR
(*
o
);

173 
o
->
ov”Ïµed
.
hEv’t
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
ev’t_¡©e
, NULL);

174 ià(
o
->
ov”Ïµed
.
hEv’t
 =ğ
NULL
)

176 
	`msg
(
M_ERR
, "Error: overlapped_io_init: CreateEvent failed");

180 
	`®loc_buf_sock_tun
(&
o
->
buf_š™
, 
äame
, 
tuÁ­_bufãr
, 0);

181 
	}
}

184 
	$ov”Ïµed_io_şo£
(
ov”Ïµed_io
 *
o
)

186 ià(
o
->
ov”Ïµed
.
hEv’t
)

188 ià(!
	`Clo£HªdË
(
o
->
ov”Ïµed
.
hEv’t
))

190 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle failed on overlapped I/Oƒvent object");

193 
	`ä“_buf
(&
o
->
buf_š™
);

194 
	}
}

197 
	$ov”Ïµed_io_¡©e_ascii
(cÚ¡ 
ov”Ïµed_io
 *
o
)

199 
o
->
io¡©e
)

201 
IOSTATE_INITIAL
:

204 
IOSTATE_QUEUED
:

207 
IOSTATE_IMMEDIATE_RETURN
:

211 
	}
}

218 
	$š™_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
ÃtwÜk_ev’ts
, 
sock‘_desütÜ_t
 
sd
, 
æags
)

223 ià(!(
æags
 & 
NE32_PERSIST_EVENT
è|| !
ev’t
->
wr™e
)

225 ià(
æags
 & 
NE32_WRITE_EVENT
)

227 
ev’t
->
wr™e
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
FALSE
, NULL);

228 ià(
ev’t
->
wr™e
 =ğ
NULL
)

230 
	`msg
(
M_ERR
, "Error: init_net_event_win32: CreateEvent (write) failed");

235 
ev’t
->
wr™e
 = 
NULL
;

240 ià(!(
æags
 & 
NE32_PERSIST_EVENT
è|| !
ev’t
->
»ad
)

242 
ev’t
->
»ad
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
FALSE
, NULL);

243 ià(
ev’t
->
»ad
 =ğ
NULL
)

245 
	`msg
(
M_ERR
, "Error: init_net_event_win32: CreateEvent (read) failed");

250 ià(
	`WSAEv’tS–eù
(
sd
, 
ev’t
->
»ad
, 
ÃtwÜk_ev’ts
) != 0)

252 
	`msg
(
M_FATAL
 | 
M_ERRNO
, "Error: init_net_event_win32: WSAEventSelect call failed");

254 
	}
}

257 
	$»£t_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
sock‘_desütÜ_t
 
sd
)

259 
WSANETWORKEVENTS
 
wÃ
;

260 ià(
	`WSAEnumN‘wÜkEv’ts
(
sd
, 
ev’t
->
»ad
, &
wÃ
) != 0)

262 
	`msg
(
M_FATAL
 | 
M_ERRNO
, "Error:„eset_net_event_win32: WSAEnumNetworkEvents call failed");

267  
wÃ
.
lN‘wÜkEv’ts
;

269 
	}
}

272 
	$şo£_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
sock‘_desütÜ_t
 
sd
, 
æags
)

274 ià(
ev’t
->
»ad
)

276 ià(
	`sock‘_defšed
(
sd
))

278 ià(
	`WSAEv’tS–eù
(
sd
, 
ev’t
->
»ad
, 0) != 0)

280 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: close_net_event_win32: WSAEventSelect call failed");

283 ià(!
	`Re£tEv’t
(
ev’t
->
»ad
))

285 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: ResetEvent (read) failed in close_net_event_win32");

287 ià(!(
æags
 & 
NE32_PERSIST_EVENT
))

289 ià(!
	`Clo£HªdË
(
ev’t
->
»ad
))

291 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle (read) failed in close_net_event_win32");

293 
ev’t
->
»ad
 = 
NULL
;

297 ià(
ev’t
->
wr™e
)

299 ià(!
	`Re£tEv’t
(
ev’t
->
wr™e
))

301 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: ResetEvent (write) failed in close_net_event_win32");

303 ià(!(
æags
 & 
NE32_PERSIST_EVENT
))

305 ià(!
	`Clo£HªdË
(
ev’t
->
wr™e
))

307 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: CloseHandle (write) failed in close_net_event_win32");

309 
ev’t
->
wr™e
 = 
NULL
;

312 
	}
}

319 
	$Ãt_ev’t_wš32_š™
(
Ãt_ev’t_wš32
 *
Ã
)

321 
	`CLEAR
(*
Ã
);

322 
Ã
->
sd
 = 
SOCKET_UNDEFINED
;

323 
	}
}

326 
	$Ãt_ev’t_wš32_¡¬t
(
Ãt_ev’t_wš32
 *
Ã
, 
ÃtwÜk_ev’ts
, 
sock‘_desütÜ_t
 
sd
)

328 
	`ASSERT
(!
	`sock‘_defšed
(
Ã
->
sd
));

329 
Ã
->
sd
 = sd;

330 
Ã
->
ev’t_mask
 = 0;

331 
	`š™_Ãt_ev’t_wš32
(&
Ã
->
hªdË
, 
ÃtwÜk_ev’ts
, 
sd
, 
NE32_PERSIST_EVENT
|
NE32_WRITE_EVENT
);

332 
	}
}

335 
	$Ãt_ev’t_wš32_»£t_wr™e
(
Ãt_ev’t_wš32
 *
Ã
)

337 
BOOL
 
¡©us
;

338 ià(
Ã
->
ev’t_mask
 & 
FD_WRITE
)

340 
¡©us
 = 
	`S‘Ev’t
(
Ã
->
hªdË
.
wr™e
);

344 
¡©us
 = 
	`Re£tEv’t
(
Ã
->
hªdË
.
wr™e
);

346 ià(!
¡©us
)

348 
	`msg
(
M_WARN
 | 
M_ERRNO
, "Warning: SetEvent/ResetEvent failed in‚et_event_win32_reset_write");

350 
	}
}

353 
	$Ãt_ev’t_wš32_»£t
(
Ãt_ev’t_wš32
 *
Ã
)

355 
Ã
->
ev’t_mask
 |ğ
	`»£t_Ãt_ev’t_wš32
(&Ã->
hªdË
,‚e->
sd
);

356 
	}
}

359 
	$Ãt_ev’t_wš32_¡İ
(
Ãt_ev’t_wš32
 *
Ã
)

361 ià(
	`Ãt_ev’t_wš32_defšed
(
Ã
))

363 
	`şo£_Ãt_ev’t_wš32
(&
Ã
->
hªdË
,‚e->
sd
, 
NE32_PERSIST_EVENT
);

365 
Ã
->
sd
 = 
SOCKET_UNDEFINED
;

366 
Ã
->
ev’t_mask
 = 0;

367 
	}
}

370 
	$Ãt_ev’t_wš32_şo£
(
Ãt_ev’t_wš32
 *
Ã
)

372 ià(
	`Ãt_ev’t_wš32_defšed
(
Ã
))

374 
	`şo£_Ãt_ev’t_wš32
(&
Ã
->
hªdË
,‚e->
sd
, 0);

376 
	`Ãt_ev’t_wš32_š™
(
Ã
);

377 
	}
}

388 
	$wš_Œigg”_ev’t
(
wš32_sigÇl
 *
ws
)

390 ià(
ws
->
mode
 =ğ
WSO_MODE_SERVICE
 && 
	`HANDLE_DEFINED
(ws->
š
.
»ad
))

392 
	`S‘Ev’t
(
ws
->
š
.
»ad
);

396 
DWORD
 
tmp
;

397 
INPUT_RECORD
 
œ
;

398 
HANDLE
 
¡dš_hªdË
 = 
	`G‘StdHªdË
(
STD_INPUT_HANDLE
);

400 
	`CLEAR
(
œ
);

401 
œ
.
Ev’tTy³
 = 
KEY_EVENT
;

402 
œ
.
Ev’t
.
KeyEv’t
.
bKeyDown
 = 
Œue
;

403 ià(!
¡dš_hªdË
 || !
	`Wr™eCÚsŞeIÅut
(¡dš_hªdË, &
œ
, 1, &
tmp
))

405 
	`msg
(
M_WARN
|
M_ERRNO
, "WARN: win_trigger_event: WriteConsoleInput");

408 
	}
}

413 
boŞ
 
WINAPI


414 
	$wš_ù¾_hªdËr
(
DWORD
 
signum
)

416 
	`msg
(
D_LOW
, "wš_ù¾_hªdËr: sigÇÈ»ûived (code=%lu)", (è
signum
);

418 ià(
sigšfo_¡©ic
.
sigÇl_»ûived
 =ğ
SIGTERM
)

420  
Œue
;

423 
signum
)

425 
CTRL_C_EVENT
:

426 
CTRL_BREAK_EVENT
:

427 
	`throw_sigÇl
(
SIGTERM
);

429 
	`wš_Œigg”_ev’t
(&
wš32_sigÇl
);

430  
Œue
;

434 
	`msg
(
D_LOW
, "wš_ù¾_hªdËr: sigÇÈ(code=%luènÙ hªdËd", (è
signum
);

438  
çl£
;

439 
	}
}

442 
	$wš32_sigÇl_ş—r
(
wš32_sigÇl
 *
ws
)

444 
	`CLEAR
(*
ws
);

445 
	}
}

448 
	$wš32_sigÇl_İ’
(
wš32_sigÇl
 *
ws
,

449 
fÜû
,

450 cÚ¡ *
ex™_ev’t_Çme
,

451 
boŞ
 
ex™_ev’t_š™Ÿl_¡©e
)

453 
	`CLEAR
(*
ws
);

455 
ws
->
mode
 = 
WSO_MODE_UNDEF
;

456 
ws
->
š
.
»ad
 = 
INVALID_HANDLE_VALUE
;

457 
ws
->
š
.
wr™e
 = 
INVALID_HANDLE_VALUE
;

458 
ws
->
cÚsŞe_mode_§ve
 = 0;

459 
ws
->
cÚsŞe_mode_§ve_defšed
 = 
çl£
;

461 ià(
fÜû
 =ğ
WSO_NOFORCE
 || fÜû =ğ
WSO_FORCE_CONSOLE
)

466 
ws
->
š
.
»ad
 = 
	`G‘StdHªdË
(
STD_INPUT_HANDLE
);

467 ià(
ws
->
š
.
»ad
 !ğ
INVALID_HANDLE_VALUE
)

469 ià(
	`G‘CÚsŞeMode
(
ws
->
š
.
»ad
, &ws->
cÚsŞe_mode_§ve
))

472 cÚ¡ 
DWORD
 
Ãw_cÚsŞe_mode
 = 
ws
->
cÚsŞe_mode_§ve


473 & ~(
ENABLE_WINDOW_INPUT


474 | 
ENABLE_PROCESSED_INPUT


475 | 
ENABLE_LINE_INPUT


476 | 
ENABLE_ECHO_INPUT


477 | 
ENABLE_MOUSE_INPUT
);

479 ià(
Ãw_cÚsŞe_mode
 !ğ
ws
->
cÚsŞe_mode_§ve
)

481 ià(!
	`S‘CÚsŞeMode
(
ws
->
š
.
»ad
, 
Ãw_cÚsŞe_mode
))

483 
	`msg
(
M_ERR
, "Error: win32_signal_open: SetConsoleMode failed");

485 
ws
->
cÚsŞe_mode_§ve_defšed
 = 
Œue
;

487 
ws
->
mode
 = 
WSO_MODE_CONSOLE
;

491 
ws
->
š
.
»ad
 = 
INVALID_HANDLE_VALUE
;

500 ià((
fÜû
 =ğ
WSO_NOFORCE
 || fÜû =ğ
WSO_FORCE_SERVICE
)

501 && !
	`HANDLE_DEFINED
(
ws
->
š
.
»ad
è&& 
ex™_ev’t_Çme
)

503 
£cur™y_©Œibu‹s
 
§
;

505 ià(!
	`š™_£cur™y_©Œibu‹s_®low_®l
(&
§
))

507 
	`msg
(
M_ERR
, "Error: win32_signal_open: init SA failed");

510 
ws
->
š
.
»ad
 = 
	`C»©eEv’t
(&
§
.sa,

511 
TRUE
,

512 
ex™_ev’t_š™Ÿl_¡©e
 ? 
TRUE
 : 
FALSE
,

513 
ex™_ev’t_Çme
);

514 ià(
ws
->
š
.
»ad
 =ğ
NULL
)

516 
	`msg
(
M_WARN
|
M_ERRNO
, "NOTE: C»©eEv’ˆ'%s' faed", 
ex™_ev’t_Çme
);

520 ià(
	`Wa™FÜSšgËObjeù
(
ws
->
š
.
»ad
, 0è!ğ
WAIT_TIMEOUT
)

522 
	`msg
(
M_FATAL
, "ERROR: Ex™ Ev’ˆ('%s'èi sigÇËd", 
ex™_ev’t_Çme
);

526 
ws
->
mode
 = 
WSO_MODE_SERVICE
;

531 ià(!
	`S‘CÚsŞeCŒlHªdËr
((
PHANDLER_ROUTINE
è
wš_ù¾_hªdËr
, 
Œue
))

533 
	`msg
(
M_WARN
|
M_ERRNO
, "WARN: SetConsoleCtrlHandler failed");

535 
	}
}

537 
boŞ


538 
	$keybßrd_šput_avaabË
(
wš32_sigÇl
 *
ws
)

540 
	`ASSERT
(
ws
->
mode
 =ğ
WSO_MODE_CONSOLE
);

541 ià(
	`HANDLE_DEFINED
(
ws
->
š
.
»ad
))

543 
DWORD
 
n
;

544 ià(
	`G‘Numb”OfCÚsŞeIÅutEv’ts
(
ws
->
š
.
»ad
, &
n
))

546  
n
 > 0;

549  
çl£
;

550 
	}
}

553 
	$keybßrd_œ_to_key
(
INPUT_RECORD
 *
œ
)

555 ià(
œ
->
Ev’t
.
KeyEv’t
.
uCh¬
.
AsciiCh¬
 == 0)

557  
œ
->
Ev’t
.
KeyEv’t
.
wVœtu®SÿnCode
;

560 ià((
œ
->
Ev’t
.
KeyEv’t
.
dwCÚŒŞKeyS‹


561 & (
LEFT_ALT_PRESSED
 | 
RIGHT_ALT_PRESSED
))

562 && (
œ
->
Ev’t
.
KeyEv’t
.
wVœtu®KeyCode
 != 18))

564  
œ
->
Ev’t
.
KeyEv’t
.
wVœtu®SÿnCode
 * 256;

567  
œ
->
Ev’t
.
KeyEv’t
.
uCh¬
.
AsciiCh¬
;

568 
	}
}

571 
	$wš32_keybßrd_g‘
(
wš32_sigÇl
 *
ws
)

573 
	`ASSERT
(
ws
->
mode
 =ğ
WSO_MODE_CONSOLE
);

574 ià(
	`HANDLE_DEFINED
(
ws
->
š
.
»ad
))

576 
INPUT_RECORD
 
œ
;

579 
DWORD
 
n
;

580 ià(!
	`keybßrd_šput_avaabË
(
ws
))

584 ià(!
	`R—dCÚsŞeIÅut
(
ws
->
š
.
»ad
, &
œ
, 1, &
n
))

588 } 
œ
.
Ev’tTy³
 !ğ
KEY_EVENT
 || ir.
Ev’t
.
KeyEv’t
.
bKeyDown
 !ğ
TRUE
);

590  
	`keybßrd_œ_to_key
(&
œ
);

596 
	}
}

599 
	$wš32_sigÇl_şo£
(
wš32_sigÇl
 *
ws
)

601 ià(
ws
->
mode
 =ğ
WSO_MODE_SERVICE
 && 
	`HANDLE_DEFINED
(ws->
š
.
»ad
))

603 
	`Clo£HªdË
(
ws
->
š
.
»ad
);

605 ià(
ws
->
cÚsŞe_mode_§ve_defšed
)

607 ià(!
	`S‘CÚsŞeMode
(
ws
->
š
.
»ad
, ws->
cÚsŞe_mode_§ve
))

609 
	`msg
(
M_ERR
, "Error: win32_signal_close: SetConsoleMode failed");

612 
	`CLEAR
(*
ws
);

613 
	}
}

618 
boŞ


619 
	$wš32_£rviû_š‹¼u±
(
wš32_sigÇl
 *
ws
)

621 ià(
ws
->
mode
 =ğ
WSO_MODE_SERVICE
)

623 ià(
	`HANDLE_DEFINED
(
ws
->
š
.
»ad
)

624 && 
	`Wa™FÜSšgËObjeù
(
ws
->
š
.
»ad
, 0è=ğ
WAIT_OBJECT_0
)

626  
Œue
;

629  
çl£
;

630 
	}
}

633 
	$wš32_sigÇl_g‘
(
wš32_sigÇl
 *
ws
)

635 
»t
 = 0;

636 ià(
sigšfo_¡©ic
.
sigÇl_»ûived
)

638 
»t
 = 
sigšfo_¡©ic
.
sigÇl_»ûived
;

642 ià(
ws
->
mode
 =ğ
WSO_MODE_SERVICE
)

644 ià(
	`wš32_£rviû_š‹¼u±
(
ws
))

646 
»t
 = 
SIGTERM
;

649 ià(
ws
->
mode
 =ğ
WSO_MODE_CONSOLE
)

651 
	`wš32_keybßrd_g‘
(
ws
))

654 
»t
 = 
SIGUSR1
;

658 
»t
 = 
SIGUSR2
;

662 
»t
 = 
SIGHUP
;

666 
»t
 = 
SIGTERM
;

670 
»t
 = 
SIGTERM
;

674 ià(
»t
)

676 
sigšfo_¡©ic
.
sigÇl_»ûived
 = 
»t
;

677 
sigšfo_¡©ic
.
sourû
 = 
SIG_SOURCE_HARD
;

680  
»t
;

681 
	}
}

684 
	$wš32_·u£
(
wš32_sigÇl
 *
ws
)

686 ià(
ws
->
mode
 =ğ
WSO_MODE_CONSOLE
 && 
	`HANDLE_DEFINED
(ws->
š
.
»ad
))

688 
¡©us
;

689 
	`msg
(
M_INFO
|
M_NOPREFIX
, "Press‡ny keyo continue...");

692 
¡©us
 = 
	`Wa™FÜSšgËObjeù
(
ws
->
š
.
»ad
, 
INFINITE
);

693 } !
	`wš32_keybßrd_g‘
(
ws
));

695 
	}
}

700 
	$wšdow_t™Ë_ş—r
(
wšdow_t™Ë
 *
wt
)

702 
	`CLEAR
(*
wt
);

703 
	}
}

706 
	$wšdow_t™Ë_§ve
(
wšdow_t™Ë
 *
wt
)

708 ià(!
wt
->
§ved
)

710 ià(!
	`G‘CÚsŞeT™Ë
(
wt
->
Şd_wšdow_t™Ë
, (wt->old_window_title)))

712 
wt
->
Şd_wšdow_t™Ë
[0] = 0;

713 
wt
->
§ved
 = 
çl£
;

717 
wt
->
§ved
 = 
Œue
;

720 
	}
}

723 
	$wšdow_t™Ë_»¡Üe
(cÚ¡ 
wšdow_t™Ë
 *
wt
)

725 ià(
wt
->
§ved
)

727 
	`S‘CÚsŞeT™Ë
(
wt
->
Şd_wšdow_t™Ë
);

729 
	}
}

732 
	$wšdow_t™Ë_g’”©e
(cÚ¡ *
t™Ë
)

734 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

735 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, &
gc
);

736 ià(!
t™Ë
)

738 
t™Ë
 = "";

740 
	`buf_´štf
(&
out
, "[%s] " 
PACKAGE_NAME
 " " 
PACKAGE_VERSION
 " F4:EXIT F1:USR1 F2:USR2 F3:HUP", 
t™Ë
);

741 
	`S‘CÚsŞeT™Ë
(
	`BSTR
(&
out
));

742 
	`gc_ä“
(&
gc
);

743 
	}
}

748 
	$£m­hÜe_ş—r
(
£m­hÜe
 *
s
)

750 
	`CLEAR
(*
s
);

751 
	}
}

754 
	$£m­hÜe_İ’
(
£m­hÜe
 *
s
, cÚ¡ *
Çme
)

756 
£cur™y_©Œibu‹s
 
§
;

758 
s
->
locked
 = 
çl£
;

759 
s
->
Çme
 =‚ame;

760 
s
->
hªd
 = 
NULL
;

762 ià(
	`š™_£cur™y_©Œibu‹s_®low_®l
(&
§
))

764 
s
->
hªd
 = 
	`C»©eSem­hÜe
(&
§
.§, 1, 1, 
Çme
);

767 ià(
s
->
hªd
 =ğ
NULL
)

769 
	`msg
(
M_WARN
|
M_ERRNO
, "WARNING: CªnÙ c»©Wš32 sem­hÜ'%s'", 
Çme
);

773 
	`dmsg
(
D_SEMAPHORE
, "C»©ed Wš32 sem­hÜ'%s'", 
s
->
Çme
);

775 
	}
}

777 
boŞ


778 
	$£m­hÜe_lock
(
£m­hÜe
 *
s
, 
timeout_mli£cÚds
)

780 
boŞ
 
»t
 = 
Œue
;

782 ià(
s
->
hªd
)

784 
DWORD
 
¡©us
;

785 
	`ASSERT
(!
s
->
locked
);

787 
	`dmsg
(
D_SEMAPHORE_LOW
, "Attemptingo†ock Win32 semaphore '%s'…rioro‚et shell command (timeout = %d sec)",

788 
s
->
Çme
,

789 
timeout_mli£cÚds
 / 1000);

790 
¡©us
 = 
	`Wa™FÜSšgËObjeù
(
s
->
hªd
, 
timeout_mli£cÚds
);

791 ià(
¡©us
 =ğ
WAIT_FAILED
)

793 
	`msg
(
M_ERR
, "Wa™ faed oÀWš32 sem­hÜ'%s'", 
s
->
Çme
);

795 
»t
 = (
¡©us
 =ğ
WAIT_TIMEOUT
è? 
çl£
 : 
Œue
;

796 ià(
»t
)

798 
	`dmsg
(
D_SEMAPHORE
, "Locked Wš32 sem­hÜ'%s'", 
s
->
Çme
);

799 
s
->
locked
 = 
Œue
;

803 
	`dmsg
(
D_SEMAPHORE
, "Wait on Win32 semaphore '%s'imed out‡fter %d milliseconds",

804 
s
->
Çme
,

805 
timeout_mli£cÚds
);

808  
»t
;

809 
	}
}

812 
	$£m­hÜe_»Ëa£
(
£m­hÜe
 *
s
)

814 ià(
s
->
hªd
)

816 
	`ASSERT
(
s
->
locked
);

817 
	`dmsg
(
D_SEMAPHORE
, "R–—sšg Wš32 sem­hÜ'%s'", 
s
->
Çme
);

818 ià(!
	`R–—£Sem­hÜe
(
s
->
hªd
, 1, 
NULL
))

820 
	`msg
(
M_WARN
 | 
M_ERRNO
, "ReleaseSemaphore failed on Win32 semaphore '%s'",

821 
s
->
Çme
);

823 
s
->
locked
 = 
çl£
;

825 
	}
}

828 
	$£m­hÜe_şo£
(
£m­hÜe
 *
s
)

830 ià(
s
->
hªd
)

832 ià(
s
->
locked
)

834 
	`£m­hÜe_»Ëa£
(
s
);

836 
	`dmsg
(
D_SEMAPHORE
, "Closšg Wš32 sem­hÜ'%s'", 
s
->
Çme
);

837 
	`Clo£HªdË
(
s
->
hªd
);

838 
s
->
hªd
 = 
NULL
;

840 
	}
}

848 
	$Ãtcmd_£m­hÜe_š™
()

850 
	`£m­hÜe_İ’
(&
Ãtcmd_£m­hÜe
, 
PACKAGE
 "_netcmd");

851 
	}
}

854 
	$Ãtcmd_£m­hÜe_şo£
()

856 
	`£m­hÜe_şo£
(&
Ãtcmd_£m­hÜe
);

857 
	}
}

860 
	$Ãtcmd_£m­hÜe_lock
()

862 cÚ¡ 
timeout_£cÚds
 = 600;

864 ià(!
Ãtcmd_£m­hÜe
.
hªd
)

866 
	`Ãtcmd_£m­hÜe_š™
();

869 ià(!
	`£m­hÜe_lock
(&
Ãtcmd_£m­hÜe
, 
timeout_£cÚds
 * 1000))

871 
	`msg
(
M_FATAL
, "Cannot†ock‚et command semaphore");

873 
	}
}

876 
	$Ãtcmd_£m­hÜe_»Ëa£
()

878 
	`£m­hÜe_»Ëa£
(&
Ãtcmd_£m­hÜe
);

880 
	`£m­hÜe_şo£
(&
Ãtcmd_£m­hÜe
);

881 
	}
}

894 
boŞ


895 
	$cmp_´efix
(cÚ¡ *
¡r
, cÚ¡ 
boŞ
 
n
, cÚ¡ *
´e
)

897 
size_t
 
i
 = 0;

899 ià(!
¡r
)

901  
çl£
;

904 
Œue
)

906 cÚ¡ 
c1
 = 
´e
[
i
];

907 
c2
 = 
¡r
[
i
];

908 ++
i
;

909 ià(
c1
 == '\0')

911 ià(
n
)

913 ià(
	`isdig™
(
c2
))

915 
c2
 = 
¡r
[
i
];

919  
çl£
;

922  
c2
 == '\0' || c2 == '.';

924 ià(
c2
 == '\0')

926  
çl£
;

928 ià(
c1
 !ğ
	`tŞow”
(
c2
))

930  
çl£
;

933 
	}
}

935 
boŞ


936 
	$wš_§ã_f’ame
(cÚ¡ *
â
)

938 ià(
	`cmp_´efix
(
â
, 
çl£
, "con"))

940  
çl£
;

942 ià(
	`cmp_´efix
(
â
, 
çl£
, "prn"))

944  
çl£
;

946 ià(
	`cmp_´efix
(
â
, 
çl£
, "aux"))

948  
çl£
;

950 ià(
	`cmp_´efix
(
â
, 
çl£
, "nul"))

952  
çl£
;

954 ià(
	`cmp_´efix
(
â
, 
Œue
, "com"))

956  
çl£
;

958 ià(
	`cmp_´efix
(
â
, 
Œue
, "lpt"))

960  
çl£
;

962 ià(
	`cmp_´efix
(
â
, 
çl£
, "clock$"))

964  
çl£
;

966  
Œue
;

967 
	}
}

974 
	$’v_block
(cÚ¡ 
’v_£t
 *
es
)

976 
fÜû_·th
[256];

977 *
sy¤oÙ
 = 
	`g‘_wš_sys_·th
();

979 ià(!
	`İ’v²_¢´štf
(
fÜû_·th
, (force_path), "PATH=%s\\System32;%s;%s\\System32\\Wbem",

980 
sy¤oÙ
, sysroot, sysroot))

982 
	`msg
(
M_WARN
, "’v_block: deçuÉ…©hrunÿ‹dØ%s", 
fÜû_·th
);

985 ià(
es
)

987 
’v_™em
 *
e
;

988 *
»t
;

989 *
p
;

990 
size_t
 
nch¬s
 = 1;

991 
boŞ
 
·th_£’
 = 
çl£
;

993 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

995 
nch¬s
 +ğ
	`¡¾’
(
e
->
¡ršg
) + 1;

998 
nch¬s
 +ğ
	`¡¾’
(
fÜû_·th
)+1;

1000 
»t
 = (*è
	`m®loc
(
nch¬s
);

1001 
	`check_m®loc_»tuº
(
»t
);

1003 
p
 = 
»t
;

1004 
e
 = 
es
->
li¡
;ƒ !ğ
NULL
;ƒ =ƒ->
Ãxt
)

1006 ià(
	`’v_®lowed
(
e
->
¡ršg
))

1008 
	`¡rıy
(
p
, 
e
->
¡ršg
);

1009 
p
 +ğ
	`¡¾’
(
e
->
¡ršg
) + 1;

1011 ià(
	`¡ºcmp
(
e
->
¡ršg
, "PATH=", 5 ) == 0)

1013 
·th_£’
 = 
Œue
;

1018 ià(!
·th_£’
)

1020 
	`msg
Ğ
M_INFO
, "’v_block:‡dd %s", 
fÜû_·th
 );

1021 
	`¡rıy
Ğ
p
, 
fÜû_·th
 );

1022 
p
 +ğ
	`¡¾’
(
fÜû_·th
) + 1;

1025 *
p
 = '\0';

1026  
»t
;

1030  
NULL
;

1032 
	}
}

1034 
WCHAR
 *

1035 
	$wide_cmd_lše
(cÚ¡ 
¬gv
 *
a
, 
gc_¬’a
 *
gc
)

1037 
size_t
 
nch¬s
 = 1;

1038 
size_t
 
maxËn
 = 0;

1039 
size_t
 
i
;

1040 
bufãr
 
buf
;

1041 *
wÜk
 = 
NULL
;

1043 ià(!
a
)

1045  
NULL
;

1048 
i
 = 0; i < 
a
->
¬gc
; ++i)

1050 cÚ¡ *
¬g
 = 
a
->
¬gv
[
i
];

1051 cÚ¡ 
size_t
 
Ën
 = 
	`¡¾’
(
¬g
);

1052 
nch¬s
 +ğ
Ën
 + 3;

1053 ià(
Ën
 > 
maxËn
)

1055 
maxËn
 = 
Ën
;

1059 
wÜk
 = 
	`gc_m®loc
(
maxËn
 + 1, 
çl£
, 
gc
);

1060 
	`check_m®loc_»tuº
(
wÜk
);

1061 
buf
 = 
	`®loc_buf_gc
(
nch¬s
, 
gc
);

1063 
i
 = 0; i < 
a
->
¬gc
; ++i)

1065 cÚ¡ *
¬g
 = 
a
->
¬gv
[
i
];

1066 
	`¡rıy
(
wÜk
, 
¬g
);

1067 
	`¡ršg_mod
(
wÜk
, 
CC_PRINT
, 
CC_DOUBLE_QUOTE
|
CC_CRLF
, '_');

1068 ià(
i
)

1070 
	`buf_´štf
(&
buf
, " ");

1072 ià(
	`¡ršg_şass
(
wÜk
, 
CC_ANY
, 
CC_SPACE
))

1074 
	`buf_´štf
(&
buf
, "%s", 
wÜk
);

1078 
	`buf_´štf
(&
buf
, "\"%s\"", 
wÜk
);

1082  
	`wide_¡ršg
(
	`BSTR
(&
buf
), 
gc
);

1083 
	}
}

1089 
	$İ’v²_execve
(cÚ¡ 
¬gv
 *
a
, cÚ¡ 
’v_£t
 *
es
, cÚ¡ 
æags
)

1091 
»t
 = 
OPENVPN_EXECVE_ERROR
;

1092 
boŞ
 
exec_w¬n
 = 
çl£
;

1094 ià(
a
 &&‡->
¬gv
[0])

1096 ià(
	`İ’v²_execve_®lowed
(
æags
))

1098 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1099 
STARTUPINFOW
 
¡¬t_šfo
;

1100 
PROCESS_INFORMATION
 
´oc_šfo
;

1102 *
’v
 = 
	`’v_block
(
es
);

1103 
WCHAR
 *
ş
 = 
	`wide_cmd_lše
(
a
, &
gc
);

1104 
WCHAR
 *
cmd
 = 
	`wide_¡ršg
(
a
->
¬gv
[0], &
gc
);

1107 
DWORD
 
´oc_æags
 = 
CREATE_NO_WINDOW
;

1109 
	`CLEAR
(
¡¬t_šfo
);

1110 
	`CLEAR
(
´oc_šfo
);

1113 
	`G‘S¹upInfoW
(&
¡¬t_šfo
);

1114 
¡¬t_šfo
.
cb
 = (start_info);

1115 
¡¬t_šfo
.
dwFÏgs
 = 
STARTF_USESHOWWINDOW
;

1116 
¡¬t_šfo
.
wShowWšdow
 = 
SW_HIDE
;

1118 ià(
	`C»©eProûssW
(
cmd
, 
ş
, 
NULL
, NULL, 
FALSE
, 
´oc_æags
, 
’v
, NULL, &
¡¬t_šfo
, &
´oc_šfo
))

1120 
DWORD
 
ex™_¡©us
 = 0;

1121 
	`Clo£HªdË
(
´oc_šfo
.
hTh»ad
);

1122 
	`Wa™FÜSšgËObjeù
(
´oc_šfo
.
hProûss
, 
INFINITE
);

1123 ià(
	`G‘Ex™CodeProûss
(
´oc_šfo
.
hProûss
, &
ex™_¡©us
))

1125 
»t
 = ()
ex™_¡©us
;

1129 
	`msg
(
M_WARN
|
M_ERRNO
, "İ’v²_execve: G‘Ex™CodeProûs %S faed", 
cmd
);

1131 
	`Clo£HªdË
(
´oc_šfo
.
hProûss
);

1135 
	`msg
(
M_WARN
|
M_ERRNO
, "İ’v²_execve: C»©eProûs %S faed", 
cmd
);

1137 
	`ä“
(
’v
);

1138 
	`gc_ä“
(&
gc
);

1142 
»t
 = 
OPENVPN_EXECVE_NOT_ALLOWED
;

1143 ià(!
exec_w¬n
 && (
süt_£cur™y
 < 
SSEC_SCRIPTS
))

1145 
	`msg
(
M_WARN
, 
SCRIPT_SECURITY_WARNING
);

1146 
exec_w¬n
 = 
Œue
;

1152 
	`msg
(
M_WARN
, "openvpn_execve: called withƒmpty‡rgv");

1154  
»t
;

1155 
	}
}

1157 
WCHAR
 *

1158 
	$wide_¡ršg
(cÚ¡ *
utf8
, 
gc_¬’a
 *
gc
)

1160 
n
 = 
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
utf8
, -1, 
NULL
, 0);

1161 
WCHAR
 *
ucs16
 = 
	`gc_m®loc
(
n
 * (WCHAR), 
çl£
, 
gc
);

1162 
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
utf8
, -1, 
ucs16
, 
n
);

1163  
ucs16
;

1164 
	}
}

1170 
	$fÜk_to_£lf
(cÚ¡ *
cmdlše
)

1172 
STARTUPINFO
 
¡¬t_šfo
;

1173 
PROCESS_INFORMATION
 
´oc_šfo
;

1174 
£lf_exe
[256];

1175 *
ş
 = 
	`¡ršg_®loc
(
cmdlše
, 
NULL
);

1176 
DWORD
 
¡©us
;

1178 
	`CLEAR
(
¡¬t_šfo
);

1179 
	`CLEAR
(
´oc_šfo
);

1180 
	`CLEAR
(
£lf_exe
);

1182 
¡©us
 = 
	`G‘ModuËFeName
(
NULL
, 
£lf_exe
, (self_exe));

1183 ià(
¡©us
 =ğ0 || stu =ğ(
£lf_exe
))

1185 
	`msg
(
M_WARN
|
M_ERRNO
, "fork_to_self: CreateProcess failed: cannot get module‚ame via GetModuleFileName");

1186 
dÚe
;

1190 
	`G‘S¹upInfo
(&
¡¬t_šfo
);

1191 
¡¬t_šfo
.
cb
 = (start_info);

1192 
¡¬t_šfo
.
dwFÏgs
 = 
STARTF_USESHOWWINDOW
;

1193 
¡¬t_šfo
.
wShowWšdow
 = 
SW_HIDE
;

1195 ià(
	`C»©eProûss
(
£lf_exe
, 
ş
, 
NULL
, NULL, 
FALSE
, 0, NULL, NULL, &
¡¬t_šfo
, &
´oc_šfo
))

1197 
	`Clo£HªdË
(
´oc_šfo
.
hTh»ad
);

1198 
	`Clo£HªdË
(
´oc_šfo
.
hProûss
);

1202 
	`msg
(
M_WARN
|
M_ERRNO
, "fÜk_to_£lf: C»©eProûs çed: %s", 
cmdlše
);

1205 
dÚe
:

1206 
	`ä“
(
ş
);

1207 
	}
}

1210 
	$g‘_wš_sys_·th
()

1212 
	`ASSERT
(
wš_sys_·th
);

1213  
wš_sys_·th
;

1214 
	}
}

1217 
	$£t_wš_sys_·th
(cÚ¡ *
Ãw·th
, 
’v_£t
 *
es
)

1219 
	`ä“
(
wš_sys_·th
);

1220 
wš_sys_·th
 = 
	`¡ršg_®loc
(
Ãw·th
, 
NULL
);

1221 
	`£‹nv_¡r
(
es
, 
SYS_PATH_ENV_VAR_NAME
, 
wš_sys_·th
);

1222 
	}
}

1225 
	$£t_wš_sys_·th_vŸ_’v
(
’v_£t
 *
es
)

1227 
buf
[256];

1228 
DWORD
 
¡©us
 = 
	`G‘EnvœÚm’tV¬ŸbË
(
SYS_PATH_ENV_VAR_NAME
, 
buf
, (buf));

1229 ià(!
¡©us
)

1231 
	`msg
(
M_ERR
, "CªnÙ fšdƒnvœÚm’Èv¬ŸbË %s", 
SYS_PATH_ENV_VAR_NAME
);

1233 ià(
¡©us
 > (
buf
) - 1)

1235 
	`msg
(
M_FATAL
, "SŒšg ov”æow‡‰em±šgØ»adƒnvœÚm’Èv¬ŸbË %s", 
SYS_PATH_ENV_VAR_NAME
);

1237 
	`£t_wš_sys_·th
(
buf
, 
es
);

1238 
	}
}

1242 
	$wš_g‘_‹mpdœ
()

1244 
tmpdœ
[
MAX_PATH
];

1245 
WCHAR
 
wtmpdœ
[
MAX_PATH
];

1247 ià(!
	`G‘TempP©hW
(
	`_couÁof
(
wtmpdœ
), wtmpdir))

1252 
	`msg
(
M_WARN
, "Could‚ot find‡ suitableemporary directory."

1254  
NULL
;

1257 ià(
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
wtmpdœ
, -1, 
NULL
, 0, NULL, NULLè> (
tmpdœ
))

1259 
	`msg
(
M_WARN
, "Could‚ot getemporary directory. Path isoo†ong."

1261  
NULL
;

1264 
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0, 
wtmpdœ
, -1, 
tmpdœ
, Ñmpdœ), 
NULL
, NULL);

1265  
tmpdœ
;

1266 
	}
}

1268 
boŞ


1269 
	$wš_block_dns_£rviû
(
boŞ
 
add
, 
šdex
, cÚ¡ 
HANDLE
 
pe
)

1271 
DWORD
 
Ën
;

1272 
boŞ
 
»t
 = 
çl£
;

1273 
ack_mes§ge_t
 
ack
;

1274 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1276 
block_dns_mes§ge_t
 
d©a
 = {

1277 .
h—d”
 = {

1278 (
add
 ? 
msg_add_block_dns
 : 
msg_d–_block_dns
),

1279 (
block_dns_mes§ge_t
),

1282 .
içû
 = { .
šdex
 = index, .
Çme
 = "" }

1285 ià(!
	`Wr™eFe
(
pe
, &
d©a
, (d©a), &
Ën
, 
NULL
)

1286 || !
	`R—dFe
(
pe
, &
ack
, ×ck), &
Ën
, 
NULL
))

1288 
	`msg
(
M_WARN
, "Block_DNS: could‚otalko service: %s [%lu]",

1289 
	`¡»¼Ü_wš32
(
	`G‘La¡E¼Ü
(), &
gc
), GetLastError());

1290 
out
;

1293 ià(
ack
.
”rÜ_numb”
 !ğ
NO_ERROR
)

1295 
	`msg
(
M_WARN
, "Block_DNS: %s block dns filters using service failed: %s [status=0x%x if_index=%d]",

1296 (
add
 ? "addšg" : "d–‘šg"), 
	`¡»¼Ü_wš32
(
ack
.
”rÜ_numb”
, &
gc
),

1297 
ack
.
”rÜ_numb”
, 
d©a
.
içû
.
šdex
);

1298 
out
;

1301 
»t
 = 
Œue
;

1302 
	`msg
(
M_INFO
, "% outsiddn usšg s”viû sucûeded.", (
add
 ? "Blocking" : "Unblocking"));

1303 
out
:

1304 
	`gc_ä“
(&
gc
);

1305  
»t
;

1306 
	}
}

1309 
	$block_dns_msg_hªdËr
(
DWORD
 
”r
, cÚ¡ *
msg
)

1311 
gc_¬’a
 
gc
 = 
	`gc_Ãw
();

1313 ià(
”r
 == 0)

1315 
	`msg
(
M_INFO
, "%s", 
msg
);

1319 
	`msg
(
M_WARN
, "Error in‡dd_block_dns_filters(): %s : %s [status=0x%lx]",

1320 
msg
, 
	`¡»¼Ü_wš32
(
”r
, &
gc
),ƒrr);

1323 
	`gc_ä“
(&
gc
);

1324 
	}
}

1326 
boŞ


1327 
	$wš_wå_block_dns
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
HANDLE
 
msg_chªÃl
)

1329 
WCHAR
 
İ’v²·th
[
MAX_PATH
];

1330 
boŞ
 
»t
 = 
çl£
;

1331 
DWORD
 
¡©us
;

1333 ià(
msg_chªÃl
)

1335 
	`dmsg
(
D_LOW
, "Using serviceo‡dd block dns filters");

1336 
»t
 = 
	`wš_block_dns_£rviû
(
Œue
, 
šdex
, 
msg_chªÃl
);

1337 
out
;

1340 
¡©us
 = 
	`G‘ModuËFeNameW
(
NULL
, 
İ’v²·th
, 
	`_couÁof
(openvpnpath));

1341 ià(
¡©us
 =ğ0 || stu =ğ
	`_couÁof
(
İ’v²·th
))

1343 
	`msg
(
M_WARN
|
M_ERRNO
, "block_dns: cannot getƒxecutable…ath");

1344 
out
;

1347 
¡©us
 = 
	`add_block_dns_f‹rs
(&
m_hEngšeHªdË
, 
šdex
, 
İ’v²·th
,

1348 
block_dns_msg_hªdËr
);

1349 ià(
¡©us
 == 0)

1351 
is_auto
 = 0;

1352 
p_m‘ric_v4
 = 
	`g‘_š‹rçû_m‘ric
(
šdex
, 
AF_INET
, &
is_auto
);

1353 ià(
is_auto
)

1355 
p_m‘ric_v4
 = 0;

1357 
p_m‘ric_v6
 = 
	`g‘_š‹rçû_m‘ric
(
šdex
, 
AF_INET6
, &
is_auto
);

1358 ià(
is_auto
)

1360 
p_m‘ric_v6
 = 0;

1362 
¡©us
 = 
	`£t_š‹rçû_m‘ric
(
šdex
, 
AF_INET
, 
BLOCK_DNS_IFACE_METRIC
);

1363 ià(!
¡©us
)

1365 
	`£t_š‹rçû_m‘ric
(
šdex
, 
AF_INET6
, 
BLOCK_DNS_IFACE_METRIC
);

1369 
»t
 = (
¡©us
 == 0);

1371 
out
:

1373  
»t
;

1374 
	}
}

1376 
boŞ


1377 
	$wš_wå_unš™
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
HANDLE
 
msg_chªÃl
)

1379 
	`dmsg
(
D_LOW
, "Uninitializing WFP");

1381 ià(
msg_chªÃl
)

1383 
	`msg
(
D_LOW
, "Using serviceo delete block dns filters");

1384 
	`wš_block_dns_£rviû
(
çl£
, 
šdex
, 
msg_chªÃl
);

1388 
	`d–‘e_block_dns_f‹rs
(
m_hEngšeHªdË
);

1389 
m_hEngšeHªdË
 = 
NULL
;

1390 ià(
p_m‘ric_v4
 >= 0)

1392 
	`£t_š‹rçû_m‘ric
(
šdex
, 
AF_INET
, 
p_m‘ric_v4
);

1394 ià(
p_m‘ric_v6
 >= 0)

1396 
	`£t_š‹rçû_m‘ric
(
šdex
, 
AF_INET6
, 
p_m‘ric_v6
);

1400  
Œue
;

1401 
	}
}

1404 
	$wš32_v”siÚ_šfo
()

1406 ià(!
	`IsWšdowsXPOrG»©”
())

1408 
	`msg
(
M_FATAL
, "Error: Windows version must be XP or greater.");

1411 ià(!
	`IsWšdowsVi¡aOrG»©”
())

1413  
WIN_XP
;

1416 ià(!
	`IsWšdows7OrG»©”
())

1418  
WIN_VISTA
;

1421 ià(!
	`IsWšdows8OrG»©”
())

1423  
WIN_7
;

1427  
WIN_8
;

1429 
	}
}

1431 
boŞ


1432 
	$wš32_is_64b™
()

1434 #ià
	`defšed
(
_WIN64
)

1435  
Œue
;

1436 #–ià
	`defšed
(
_WIN32
)

1438 
BOOL
 
f64
 = 
FALSE
;

1439  
	`IsWow64Proûss
(
	`G‘Cu¼’tProûss
(), &
f64
) && f64;

1441  
çl£
;

1443 
	}
}

1446 
	$wš32_v”siÚ_¡ršg
(
gc_¬’a
 *
gc
, 
boŞ
 
add_Çme
)

1448 
v”siÚ
 = 
	`wš32_v”siÚ_šfo
();

1449 
bufãr
 
out
 = 
	`®loc_buf_gc
(256, 
gc
);

1451 
v”siÚ
)

1453 
WIN_XP
:

1454 
	`buf_´štf
(&
out
, "5.1%s", 
add_Çme
 ? " (Windows XP)" : "");

1457 
WIN_VISTA
:

1458 
	`buf_´štf
(&
out
, "6.0%s", 
add_Çme
 ? " (Windows Vista)" : "");

1461 
WIN_7
:

1462 
	`buf_´štf
(&
out
, "6.1%s", 
add_Çme
 ? " (Windows 7)" : "");

1465 
WIN_8
:

1466 
	`buf_´štf
(&
out
, "6.2%s", 
add_Çme
 ? " (Windows 8 or greater)" : "");

1470 
	`msg
(
M_NONFATAL
, "UnknowÀWšdow v”siÚ: %d", 
v”siÚ
);

1471 
	`buf_´štf
(&
out
, "0.0%s", 
add_Çme
 ? " (unknown)" : "");

1475 
	`buf_´štf
(&
out
, 
	`wš32_is_64b™
() ? " 64bit" : " 32bit");

1477  (cÚ¡ *)
out
.
d©a
;

1478 
	}
}

	@win32.h

24 #ifdeà
_WIN32


25 #iâdeà
OPENVPN_WIN32_H


26 
	#OPENVPN_WIN32_H


	)

28 
	~"mtu.h
"

31 
	#SYS_PATH_ENV_VAR_NAME
 "Sy¡emRoÙ"

	)

32 
	#NETSH_PATH_SUFFIX
 "\\sy¡em32\\Ãtsh.exe"

	)

33 
	#WIN_ROUTE_PATH_SUFFIX
 "\\sy¡em32\\rou‹.exe"

	)

34 
	#WIN_IPCONFIG_PATH_SUFFIX
 "\\sy¡em32\\cÚfig.exe"

	)

35 
	#WIN_NET_PATH_SUFFIX
 "\\sy¡em32\\Ãt.exe"

	)

43 #iâdeà
IN6_ARE_ADDR_EQUAL


44 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

45 (
	`memcmp
((cÚ¡ *)(
a
), (cÚ¡ *)(
b
), (
š6_addr
)è=ğ0)

	)

48 
š™_wš32
();

50 
unš™_wš32
();

52 
£t_·u£_ex™_wš32
();

54 
	s£cur™y_©Œibu‹s


56 
SECURITY_ATTRIBUTES
 
	m§
;

57 
SECURITY_DESCRIPTOR
 
	msd
;

60 
	#HANDLE_DEFINED
(
h
è((hè!ğ
NULL
 && (hè!ğ
INVALID_HANDLE_VALUE
)

	)

65 
	swšdow_t™Ë


67 
boŞ
 
	m§ved
;

68 
	mŞd_wšdow_t™Ë
 [256];

71 
	srw_hªdË
 {

72 
HANDLE
 
	m»ad
;

73 
HANDLE
 
	mwr™e
;

80 
	#NE32_PERSIST_EVENT
 (1<<0)

	)

81 
	#NE32_WRITE_EVENT
 (1<<1)

	)

83 
šlše
 
boŞ


84 
	$defšed_Ãt_ev’t_wš32
(cÚ¡ 
rw_hªdË
 *
ev’t
)

86  
ev’t
->
»ad
 !ğ
NULL
;

87 
	}
}

89 
š™_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
ÃtwÜk_ev’ts
, 
sock‘_desütÜ_t
 
sd
, 
æags
);

91 
»£t_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
sock‘_desütÜ_t
 
sd
);

93 
şo£_Ãt_ev’t_wš32
(
rw_hªdË
 *
ev’t
, 
sock‘_desütÜ_t
 
sd
, 
æags
);

99 
	sÃt_ev’t_wš32


101 
rw_hªdË
 
	mhªdË
;

102 
sock‘_desütÜ_t
 
	msd
;

103 
	mev’t_mask
;

106 
Ãt_ev’t_wš32_š™
(
Ãt_ev’t_wš32
 *
Ã
);

108 
Ãt_ev’t_wš32_¡¬t
(
Ãt_ev’t_wš32
 *
Ã
, 
ÃtwÜk_ev’ts
, 
sock‘_desütÜ_t
 
sd
);

110 
Ãt_ev’t_wš32_»£t
(
Ãt_ev’t_wš32
 *
Ã
);

112 
Ãt_ev’t_wš32_»£t_wr™e
(
Ãt_ev’t_wš32
 *
Ã
);

114 
Ãt_ev’t_wš32_¡İ
(
Ãt_ev’t_wš32
 *
Ã
);

116 
Ãt_ev’t_wš32_şo£
(
Ãt_ev’t_wš32
 *
Ã
);

118 
šlše
 
boŞ


119 
	$Ãt_ev’t_wš32_defšed
(cÚ¡ 
Ãt_ev’t_wš32
 *
Ã
)

121  
	`defšed_Ãt_ev’t_wš32
(&
Ã
->
hªdË
);

122 
	}
}

124 
šlše
 
rw_hªdË
 *

125 
	$Ãt_ev’t_wš32_g‘_ev’t
(
Ãt_ev’t_wš32
 *
Ã
)

127  &
Ã
->
hªdË
;

128 
	}
}

130 
šlše
 

131 
	$Ãt_ev’t_wš32_g‘_ev’t_mask
(cÚ¡ 
Ãt_ev’t_wš32
 *
Ã
)

133  
Ã
->
ev’t_mask
;

134 
	}
}

136 
šlše
 

137 
	$Ãt_ev’t_wš32_ş—r_£Ëùed_ev’ts
(
Ãt_ev’t_wš32
 *
Ã
, 
£Ëùed_ev’ts
)

139 
Ã
->
ev’t_mask
 &ğ~
£Ëùed_ev’ts
;

140 
	}
}

145 
	swš32_sigÇl
 {

146 
	#WSO_MODE_UNDEF
 0

	)

147 
	#WSO_MODE_SERVICE
 1

	)

148 
	#WSO_MODE_CONSOLE
 2

	)

149 
	mmode
;

150 
rw_hªdË
 
	mš
;

151 
DWORD
 
	mcÚsŞe_mode_§ve
;

152 
boŞ
 
	mcÚsŞe_mode_§ve_defšed
;

155 
wš32_sigÇl
 win32_signal;

156 
wšdow_t™Ë
 window_title;

158 
wš32_sigÇl_ş—r
(
wš32_sigÇl
 *
ws
);

161 
	#WSO_NOFORCE
 0

	)

162 
	#WSO_FORCE_SERVICE
 1

	)

163 
	#WSO_FORCE_CONSOLE
 2

	)

165 
wš32_sigÇl_İ’
(
wš32_sigÇl
 *
ws
,

166 
fÜû
,

167 cÚ¡ *
ex™_ev’t_Çme
,

168 
boŞ
 
ex™_ev’t_š™Ÿl_¡©e
);

170 
wš32_sigÇl_şo£
(
wš32_sigÇl
 *
ws
);

172 
wš32_sigÇl_g‘
(
wš32_sigÇl
 *
ws
);

174 
wš32_·u£
(
wš32_sigÇl
 *
ws
);

176 
boŞ
 
wš32_£rviû_š‹¼u±
(
wš32_sigÇl
 *
ws
);

182 
wšdow_t™Ë_ş—r
(
wšdow_t™Ë
 *
wt
);

184 
wšdow_t™Ë_§ve
(
wšdow_t™Ë
 *
wt
);

186 
wšdow_t™Ë_»¡Üe
(cÚ¡ 
wšdow_t™Ë
 *
wt
);

188 
wšdow_t™Ë_g’”©e
(cÚ¡ *
t™Ë
);

194 
	sov”Ïµed_io
 {

195 
	#IOSTATE_INITIAL
 0

	)

196 
	#IOSTATE_QUEUED
 1

	)

197 
	#IOSTATE_IMMEDIATE_RETURN
 2

	)

198 
	mio¡©e
;

199 
OVERLAPPED
 
	mov”Ïµed
;

200 
DWORD
 
	msize
;

201 
DWORD
 
	mæags
;

202 
	m¡©us
;

203 
boŞ
 
	maddr_defšed
;

205 
sockaddr_š
 
	maddr
;

206 
sockaddr_š6
 
	maddr6
;

208 
	madd¾’
;

209 
bufãr
 
	mbuf_š™
;

210 
bufãr
 
	mbuf
;

213 
ov”Ïµed_io_š™
(
ov”Ïµed_io
 *
o
,

214 cÚ¡ 
äame
 *frame,

215 
BOOL
 
ev’t_¡©e
,

216 
boŞ
 
tuÁ­_bufãr
);

218 
ov”Ïµed_io_şo£
(
ov”Ïµed_io
 *
o
);

220 
šlše
 
boŞ


221 
	$ov”Ïµed_io_aùive
(
ov”Ïµed_io
 *
o
)

223  
o
->
io¡©e
 =ğ
IOSTATE_QUEUED
 || o->io¡©=ğ
IOSTATE_IMMEDIATE_RETURN
;

224 
	}
}

226 *
ov”Ïµed_io_¡©e_ascii
(cÚ¡ 
ov”Ïµed_io
 *
o
);

234 
	s£m­hÜe


236 cÚ¡ *
	mÇme
;

237 
boŞ
 
	mlocked
;

238 
HANDLE
 
	mhªd
;

241 
£m­hÜe_ş—r
(
£m­hÜe
 *
s
);

243 
£m­hÜe_İ’
(
£m­hÜe
 *
s
, cÚ¡ *
Çme
);

245 
boŞ
 
£m­hÜe_lock
(
£m­hÜe
 *
s
, 
timeout_mli£cÚds
);

247 
£m­hÜe_»Ëa£
(
£m­hÜe
 *
s
);

249 
£m­hÜe_şo£
(
£m­hÜe
 *
s
);

259 
£m­hÜe
 
Ãtcmd_£m­hÜe
;

260 
Ãtcmd_£m­hÜe_š™
();

262 
Ãtcmd_£m­hÜe_şo£
();

264 
Ãtcmd_£m­hÜe_lock
();

266 
Ãtcmd_£m­hÜe_»Ëa£
();

269 
boŞ
 
š™_£cur™y_©Œibu‹s_®low_®l
(
£cur™y_©Œibu‹s
 *
obj
);

272 
boŞ
 
wš_§ã_f’ame
(cÚ¡ *
â
);

275 
	g’v_£t
;

278 
£t_wš_sys_·th
(cÚ¡ *
Ãw·th
, 
’v_£t
 *
es
);

280 
£t_wš_sys_·th_vŸ_’v
(
’v_£t
 *
es
);

282 *
g‘_wš_sys_·th
();

285 
fÜk_to_£lf
(cÚ¡ *
cmdlše
);

288 cÚ¡ *
wš_g‘_‹mpdœ
();

291 
WCHAR
 *
wide_¡ršg
(cÚ¡ *
utf8
, 
gc_¬’a
 *
gc
);

293 
boŞ
 
wš_wå_block_dns
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
HANDLE
 
msg_chªÃl
);

295 
boŞ
 
wš_wå_unš™
(cÚ¡ 
NET_IFINDEX
 
šdex
, cÚ¡ 
HANDLE
 
msg_chªÃl
);

297 
	#WIN_XP
 0

	)

298 
	#WIN_VISTA
 1

	)

299 
	#WIN_7
 2

	)

300 
	#WIN_8
 3

	)

302 
wš32_v”siÚ_šfo
();

308 cÚ¡ *
wš32_v”siÚ_¡ršg
(
gc_¬’a
 *
gc
, 
boŞ
 
add_Çme
);

	@
1
.
0
165
1644
argv.c
argv.h
base64.c
base64.h
basic.h
block_dns.c
block_dns.h
buffer.c
buffer.h
circ_list.h
clinat.c
clinat.h
common.h
comp-lz4.c
comp-lz4.h
comp.c
comp.h
compstub.c
console.c
console.h
console_builtin.c
console_systemd.c
crypto.c
crypto.h
crypto_backend.h
crypto_mbedtls.c
crypto_mbedtls.h
crypto_openssl.c
crypto_openssl.h
cryptoapi.c
cryptoapi.h
dhcp.c
dhcp.h
errlevel.h
error.c
error.h
event.c
event.h
fdmisc.c
fdmisc.h
forward-inline.h
forward.c
forward.h
fragment.c
fragment.h
gremlin.c
gremlin.h
helper.c
helper.h
httpdigest.c
httpdigest.h
init.c
init.h
integer.h
interval.c
interval.h
list.c
list.h
lladdr.c
lladdr.h
lzo.c
lzo.h
manage.c
manage.h
mbuf.c
mbuf.h
memdbg.h
misc.c
misc.h
mroute.c
mroute.h
mss.c
mss.h
mstats.c
mstats.h
mtcp.c
mtcp.h
mtu.c
mtu.h
mudp.c
mudp.h
multi.c
multi.h
ntlm.c
ntlm.h
occ-inline.h
occ.c
occ.h
openssl_compat.h
openvpn.c
openvpn.h
options.c
options.h
otime.c
otime.h
packet_id.c
packet_id.h
perf.c
perf.h
pf-inline.h
pf.c
pf.h
ping-inline.h
ping.c
ping.h
pkcs11.c
pkcs11.h
pkcs11_backend.h
pkcs11_mbedtls.c
pkcs11_openssl.c
platform.c
platform.h
plugin.c
plugin.h
pool.c
pool.h
proto.c
proto.h
proxy.c
proxy.h
ps.c
ps.h
push.c
push.h
pushlist.h
reliable.c
reliable.h
route.c
route.h
schedule.c
schedule.h
session_id.c
session_id.h
shaper.c
shaper.h
sig.c
sig.h
socket.c
socket.h
socks.c
socks.h
ssl.c
ssl.h
ssl_backend.h
ssl_common.h
ssl_mbedtls.c
ssl_mbedtls.h
ssl_openssl.c
ssl_openssl.h
ssl_verify.c
ssl_verify.h
ssl_verify_backend.h
ssl_verify_mbedtls.c
ssl_verify_mbedtls.h
ssl_verify_openssl.c
ssl_verify_openssl.h
status.c
status.h
syshead.h
tls_crypt.c
tls_crypt.h
tun.c
tun.h
win32.c
win32.h
